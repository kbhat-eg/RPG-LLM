# Documentation: RR108R (Resultatrapport, vedlikehold fra-til begrep)

## Overview

**RR108R** is a maintenance program for managing "from-to" ranges (begrep) in a result report (resultatrapport) within the ASOKON system. The main function is to allow users to maintain, validate, and display ranges of accounts or departments (fra-konto, til-konto, fra-avdeling, til-avdeling) associated with a specific report line. The program is interactive, using subfiles for display and manipulation, and supports create, update, copy, delete, and view operations. It uses several database files and interacts with other modules for validation and data retrieval.

---

## Key Files and Data Structures

- **rrf8l2, rrf8lu, rrf8lr**: Logical files over the same physical file (`rrf8pfr`), used for reading, updating, and referencing "from-to" range records.
- **rrf5l1**: Logical file for line register, used for validating line numbers.
- **rr108d**: Display file (workstn), with subfile `b1sfl` for displaying and editing multiple "from-to" records per report line.

### Subfile/Screen Layouts

- **B1SFL**: Subfile for displaying multiple "from-to" records.
- **B2CTL/B2CMD**: Control and command screens for subfile navigation.
- **C1BLD/C1MSG**: Screen and message window for creating new "from-to" records.
- **C2BLD**: Screen for editing/viewing a "from-to" record.
- **D1WIN**: Window for confirmation and execution of delete.
- **K1WIN**: Window for copying records.

---

## Indicators and UI Conventions

Special indicators are used for UI and logic control (see code comments):

- **LR**: End program
- **10/11**: Rollup/Rolldown in subfile
- **12/13/14/15**: Subfile display, control, clear, end
- **21/22**: Home key and cursor positioning
- **30**: Protect fields when viewing
- **31-79**: Error/warning indicators
- **80-99**: Work indicators

---

## Main Program Flow

### Initialization (`*inzsr`)

- Receives parameters: report number, report text, line number, line text, line code, and selection value.
- Initializes keys for database access.
- Reads firm info from LDA.
- Sets up initial subfile display for the selected report and line.

### Main Loop

- Displays command screen (`b2cmd`), then subfile (`b1sfl` via `dsp_subfile`).
- Handles function keys for navigation (rollup, rolldown, home), create, update, copy, delete, and view operations.
- Each operation invokes the corresponding subroutine.

---

## Subroutines and Business Logic

### Subfile Handling

- **`dsp_subfile`**: Displays subfile or command screen depending on content.
- **`clr_subfile`**: Clears the subfile display and related state variables.
- **`crt_subfile`**: Loads "from-to" records from the database into the subfile, paginated.
- **`bck_subfile`**: Handles page-back navigation in the subfile.
- **`subfile`**: Processes user actions on subfile rows (edit, copy, delete, view), invoking the appropriate subroutines.

### Record Maintenance

- **`xc1bld`**: Handles the creation of a new "from-to" record. Prevents duplicates and invokes editing screen.
- **`xc1msg`**: Displays a message if a duplicate is detected during creation.
- **`xc2bld`**: Handles editing or viewing a "from-to" record. Includes complex validation logic for account and department fields, and calls external programs for account/department selection and validation.
- **`xd1win`**: Handles record deletion with confirmation window.
- **`xk1win`**: Handles copying of a record to a new key.

### Validation and Business Rules

- **Account and Department Validation**: Uses external programs (`RH500R`, `RA507R`, `RS740R`) to validate accounts and departments. Status codes returned by these programs control error handling and user feedback.
- **Range Checks**: Ensures "to" account/department is not less than "from".
- **Uniqueness**: Checks that a given account range is not already in use for another line (see `xkon01`).
- **Line Number Validation**: Ensures line numbers exist and are valid.

---

## External Program Calls

- **RH500R**: Account selection/validation
- **RA507R**: Department selection/validation
- **RS740R**: Chart of accounts/department validation

Parameters are passed for firm, account, department, and specification; status and descriptive text are returned.

---

## Domain-Specific Notes

- **Resultatrapport**: A financial report (income statement or similar), with each line representing a category or calculation.
- **Fra/Til Konto/Avdeling**: Specifies a range of accounts/departments included in the calculation for a report line.
- **Løpenummer (løp)**: Sequence number for multiple ranges per line.
- **Brukt**: Indicates if a range is already used elsewhere.

---

## Design and Implementation Notes

- **Subfile Paging**: Paging logic is manual, with explicit counters for current, first, and last records per page.
- **Key Management**: Multiple KLISTs for indexed access to different files and for different access patterns (read, update, chain).
- **Error Handling**: Heavy use of indicators for both field-level and global errors; user is guided to correct errors via screen indicators and messages.
- **Separation of Concerns**: Each user action (edit, copy, delete, view) is handled in a separate subroutine, following a modal dialog pattern.
- **Extensibility**: External validation programs allow for business logic to be updated without changing this program.

---

## Relationships to Other Modules

- **rrf8pfr/rrf5pfr**: Core data storage for report lines and "from-to" ranges.
- **RH500R, RA507R, RS740R**: Validation and lookup modules for accounts, departments, and chart of accounts.

---

## Notable Conventions

- **Norwegian Variable Names**: Most variables and comments are Norwegian; e.g., "linje" (line), "konto" (account), "avdeling" (department), "rapport" (report).
- **Field Naming**: Prefixes (e.g., b1, b2, c1, c2, d1, k1) indicate screen or data structure usage.
- **Indicator Usage**: Indicators are used for both logic control and UI feedback, following traditional RPG design.

---

## Summary Table: Key Operations

| Operation       | Subroutine   | Screen    | Description                                                                           |
|-----------------|-------------|-----------|---------------------------------------------------------------------------------------|
| Create          | `xc1bld`    | C1BLD     | Create new "from-to" record, with validation and duplicate check                      |
| Edit/View       | `xc2bld`    | C2BLD     | Edit or view existing record, with full validation and external lookups               |
| Delete          | `xd1win`    | D1WIN     | Confirm and perform delete                                                            |
| Copy            | `xk1win`    | K1WIN     | Copy an existing record to a new key, with duplicate check                            |
| Validation      | `xkon01`    | -         | Check if an account range is already used in another line                             |
| Subfile Paging  | `crt_subfile`, `bck_subfile` | B1SFL/B2CTL | Load, display, and page through subfile records                                       |

---

## Typical User Flow

1. **Enter program** with parameters for report and line.
2. **View subfile** of existing "from-to" ranges for the line.
3. **Create, edit, copy, delete, or view** a range:
    - **Create**: Enter new range, validate, save.
    - **Edit/View**: Select a range, validate as needed, update.
    - **Copy**: Select a range, specify new key, validate, save.
    - **Delete**: Select a range, confirm, delete.
4. **Navigate** between subfile pages as needed.
5. **Exit** program.

---

## Error and Edge Case Handling

- Duplicate keys are detected and blocked.
- Invalid accounts/departments are flagged and must be corrected.
- "To" values must not be less than "from" values.
- All validation is interactive, with immediate feedback via screen indicators.

---

## Integration and Extension

- The program is tightly integrated with other validation modules and expects their status codes and returned values.
- Extension for new validation rules or additional fields would typically be handled in the external programs, minimizing changes here.

---

## Maintenance Notes

- Some code is commented out or marked with version tags (e.g., `T5.00`), indicating prior fixes or changes.
- The program is written in traditional RPG/400 style (fixed-format), with heavy reliance on indicators and subroutines.
- Variable and field names are mostly Norwegian; familiarity with the business terms is beneficial for further development.

---

## Conclusion

**RR108R** is a robust, interactive RPG program for managing "from-to" ranges in financial reports, with strong validation and integration into the ASOKON system. Its design leverages subfiles for efficient UI, external validation for business logic, and clear separation of user actions for maintainability. Understanding its conventions and relationships is key for effective onboarding and further development.