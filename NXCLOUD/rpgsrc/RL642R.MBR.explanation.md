# Explanation of the RPG Source Code

---

## Overview

This RPG (Report Program Generator) program is designed to generate **account statements for suppliers** ("kontoutdrag - leverandører"). It processes supplier transaction records, calculates totals and balances, and prints structured reports. The older fixed-format (column-based) style is used, common in legacy IBM i (AS/400) systems.

The program supports both classic spool file output and (from version 6.10 onwards) automated PDF and XML export for further digital handling.

It works with several files (likely physical or logical files), maintains summary and detail totals, and supports various printing and sorting options.

---

## Structure and Main Sections

### 1. File Declarations

- Files `rlw1l1`, `rlevl1`, `rltrl1`, `aforl1`, and `ra01l1` are **input disk files** representing transaction, supplier master, transaction detail, form control, and coding files, respectively.
- `rl642p` is an **output printer file** used for report printing, with handling for page overflow (`oflind(*in30)`).
- For PDF output, files are opened with `usropn` (user-controlled open).

### 2. Data Declarations

#### Standalone Fields & Arrays

- Strings and packed decimals for calculations (`saldo`, `kjøp`, etc.).
- Arrays for user-defined text/messages and for holding selected supplier names.
- Many working fields for accumulating totals, temporary values, and output organization.
- Extended fields (prefixed with `pdf`) for handling PDF/XML output and meta tags.

#### Data Structures

- `wkwrec` overlays a record buffer for extracting subfields like firm number, supplier number, name, etc.

#### Copybook Inclusion

- `/COPY QCPYLESRC,RPARRKDS` brings in shared local definitions, likely including record formats.

### 3. Main Logic Flow

#### a. Initialization (`*inzsr` subroutine)

- Sets up keys for file searches.
- Reads controlling/formular data for the output and possibly company/branch info.
- Initializes the printer file.
- Handles output settings (currency, per-division, per-seller, etc.).
- Populates names for selected suppliers if provided.

#### b. Main Loop

1. **Start**: Read from transaction main file (`rlw1l1`).
2. **End of File**: If end, set LR indicator and jump to clean-up.
3. **Supplier Master**: Lookup supplier details.
4. **Supplier Transactions**: Call subroutine `les_kuntr` to process supplier transactions.
5. **Counters**: Maintain counts for suppliers, with/without balances.
6. **Totals and Reporting**: If the supplier has non-zero postings or balance, print summary totals (`t10s` record).
7. **Next Record**: Loop back to next transaction.

#### c. Subroutine `les_kuntr` (Read supplier transactions)

- Reads all transaction records for a supplier from detail file (`rltrl1`).
- Applies period/year filters (i.e., only relevant transactions).
- Accumulates balances before and within the selected period.
- Keeps the latest transaction date.
- Handles page heading and initial balance output.
- Checks document codes for purchases.
- Writes detailed lines for each transaction, formatting debit/credit positions and optionally including the supplier's invoice number.
- Handles page overflow.

#### d. After Main Loop (`slutt`)

- Prints totals headers if more than one supplier exists.
- Prints lines for all selected suppliers, if provided.

#### e. PDF/XML Output

- If selected, finds the generated spool file and calls external programs for PDF creation (`AP627R`) and preview (`AP621R`).

---

## Notable Features

- **Supports Both Value and Currency Amounts:** The user can choose to print in base currency or foreign currency.
- **Flexible Output:** Handles both classic spool and modern XML/PDF export.
- **Batch and Interactive Handling:** Can run in batch mode, or in interactive mode showing generated PDF in browser if requested.
- **Supplier Selection:** Can restrict the report to a specific list of suppliers.
- **Meta Tagging:** For use in XML generation, meta tags are supported for integration.
- **Company/Branch Controls:** Reads company/branch info and controls whether they’re shown on output.

---

## Key Subroutines

### `*inzsr` (Initialization)

- Opens files, reads control/form (possibly heading/footer info), sets print parameters.
- Initializes company/branch info for headings.

### `les_kuntr` (Read Supplier Transactions)

- Loops over transactions for one supplier, applies period filters, tallies balances and purchases.
- Handles heading, first page, details, and overflow.

### `spoolnbr` (Find Spool File)

- Calls IBM API to find the spool file generated by this run (for PDF/XML output).

### `xml_create` (Create XML)

- Prepares and calls external program to generate XML file for the report, passing meta tag and job info.

### `pdf_preview` (PDF Browser Preview)

- If requested, launches PDF viewer via an external program.

---

## Example Control Flow

1. Initialize.
2. For each transaction record:
    - Lookup supplier.
    - Read all transactions for supplier, print details.
    - Update totals and print summary.
3. After all suppliers:
    - Print report totals.
    - Handle selected supplier list (if used).
    - If PDF/XML was selected, call routines to process and preview output.
4. End program.

---

## Example Data Accumulation

- **w_gsal / w_gval:** Accumulates opening balances.
- **w_sald / w_salv:** Running balances.
- **w_kjøp / w_kjøv:** Purchases this period.
- **btsal / bkjøp:** Batch totals for reporting.

---

## Printing and Output

- Uses indicators (`*in##`) for controlling page headings, overflow, and alternate detail lines.
- Writes specific record formats (e.g., `h101`, `t10s`, `d101`) to the printer file, which are likely defined in the print file definition.

---

## Comments and Maintenance

- Change log at the top documents enhancements, bug fixes, and adaptations over time.
- Scandinavian characters are present; source appears to be written in Norwegian, but code logic is universally understandable.

---

## Conclusion

**This program is a comprehensive report generator for supplier account statements, supporting both classic and modern output (PDF, XML), highly parameterized, and robust in transaction processing and output management.** Its structure is typical for classic RPG, relying on batch processing, indicators, and stepwise accumulation of transaction data for output.

New developers onboarding to this code should focus on:

- Understanding the file layout and record keys.
- Print format record layouts for output.
- How indicators control output logic.
- External program calls for modern output features.
- The effect of the initialization subroutine for customizing output (company/division, etc.).