# RK633R â€“ Documentation

## Overview

**Program:** RK633R  
**System:** ASOKON  
**Description:** "Utskrift av mantall" (Printout of headcount)  
**Created:** 2017-03-04 by KOB

This program is a user-interactive RPG application for the ASOKON system, responsible for collecting parameters from a workstation user, preparing selection criteria, updating the local data area (LDA), and invoking downstream programs to generate a headcount report. The code is structured for interactive use, with support for both direct printing and batch job submission.

---

## Structure and Flow

### 1. File Declarations

```rpg
frk633d    cf   e             workstn
```
- **rk633d** is a display file used for interaction with the user.

---

### 2. Data Definitions

#### Standalone Fields

- `w_firm` (3,0): Holds the firm number (company code).
- `w_in03`, `w_tvbt`, `w_btch`: 1-character flags used for parameter passing and control.
- `w_fdat`, `w_tdat`: Dates, matching the format of `ldfdat` and `ldtdat`.
- `w_valg`: 1-character selection indicator.

#### Data Structures

- `ldprec` (64A): Parameter area, overlaid with:
    - `ldalme` (4,0): Year/period (almanac).
    - `ldpaar` (4,0): Another period field.
    - `ldfdat`, `ldtdat` (10D): From/to dates in ISO format.
    - `ldvari` (1,0): Variant/option.

- `lda` (User Data Structure): Represents the Local Data Area, with overlays:
    - `l_ruti` (10A): Routine name.
    - `l_chgv` (1A): Change/view flag.
    - `l_sfir` (3,0): Firm number.

---

### 3. Main Logic

#### Initialization (`*inzsr`)

- Associates the LDA structure with the system LDA.
- Blanks out `w_in03`.
- Resets `w_valg` to zero.
- Loads the firm number from the LDA (`l_sfir`) into `w_firm`.

#### Main Screen Interaction

1. **Display Input Screen:**  
   The user is presented with a screen (`b1bld`) to enter parameters.  
   The variable `b1vari` is initialized to 1 before the screen is shown.

2. **Function Key Handling:**  
   If the user presses the Cancel key (`*INKC`), the program jumps to the end (`xslutt`).

3. **Parameter Handling:**  
   - User-entered values for `b1alme` and `b1vari` are moved to `ldalme` and `ldvari` in the parameter data structure.

4. **Set for Information Retrieval:**  
   - `l_chgv` is set to '1' to indicate "view only" mode (no updates).

5. **Routine Selection:**  
   - If `ldvari` = 1, set `l_ruti` to 'RK634' (routine for standard headcount report).
   - Otherwise, set `l_ruti` to 'RK635' (alternate report routine).

6. **Update LDA:**  
   - The LDA is written to the system (`out *dtaara`), making it available to called programs.

---

### 4. Program Calls

#### Call to AP600R

```rpg
call 'AP600R'
parm l_ruti
parm l_chgv
parm w_tvbt
parm w_in03
parm w_btch
```
- **AP600R** is a downstream program, likely responsible for processing or validating the selection before printing.
- Parameters:
    - `l_ruti` (routine name)
    - `l_chgv` (mode flag)
    - `w_tvbt`, `w_in03`, `w_btch` (various control flags)

#### Batch Submission (F4)

- If the F4 key (`*INKD`) is pressed, `w_valg` is set to '1', indicating the job should be submitted to batch.

#### Call to RK633C

```rpg
call 'RK633C'
parm ldprec
parm w_valg
```
- **RK633C** is a subprogram that receives the parameter area and the batch/online indicator.

---

### 5. Program Termination

- The program sets LR (`*INLR`) to on and returns, ensuring proper cleanup.

---

## Domain-Specific and Design Notes

- **Local Data Area (LDA):**  
  The program uses the LDA to communicate parameters and control flags to other programs. This is a legacy pattern for sharing state between interactive and batch programs.

- **Routine Selection:**  
  The choice between `RK634` and `RK635` routines is based on the variant entered by the user. These routines likely correspond to different report formats or selection criteria.

- **Batch vs. Online Handling:**  
  The program supports both interactive and batch processing, controlled by the F4 key and the `w_valg` flag.

- **Parameter Overlaying:**  
  The use of overlays within `ldprec` allows for flexible parameter passing to downstream programs, a common pattern in this codebase.

- **Function Key Handling:**  
  The code only explicitly handles Cancel (`*INKC`) and F4 (`*INKD`). Other function keys are not processed here.

---

## External Relationships

- **Display File (`rk633d`):**  
  Used for parameter input.

- **Programs Called:**
    - `AP600R`: Prepares or validates parameters before report generation.
    - `RK633C`: Handles the actual report generation, either online or batch.

- **LDA:**  
  Used as a temporary storage and communication mechanism between this and other programs.

---

## Summary

**RK633R** is a parameter entry and control program for generating headcount reports in the ASOKON system. It collects user input, prepares selection criteria, updates the LDA, and coordinates with downstream programs for report generation, supporting both online and batch workflows. The code leverages common legacy patterns such as LDA usage, parameter overlays, and function key control, and is tightly coupled with other programs and display files in the reporting subsystem.