     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : JX481R
      * Beskrivelse . . : Finner alle varer med pris-gruppe. sjekker
      *                   om varen er status eller ikke.
      *                   Sletter de som funnet
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       170216 bof  Nytt program
6.30  *       050615 bof  Uvidet parm. til jv750r
6.3x  * 6.30  150915 bof  utvidet parm i forb. med prgr. på betingelse
6.32  * 6.30  040917 bof  Endret måte å finne hvilke prisgivere vi skal sjekk
8.01  *PRG2   150622 bof  Utvidet prisgruppe fra 1 til 2 posisjoner
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
     fjvdtl1    if   e           k disk    rename(jvdtpfr:jvdtl1r)
6.32 fra30l1    if   e           k disk    rename(ra30pfr:ra30l1r)
     fvvprlr    if   e           k disk    rename(vvprpfr:vvprl1r)
     fvvprlu    uf   e           k disk    rename(vvprpfr:vvprlur)
     flwexpf    uf a e           k disk    rename(lexcpfr:lwexpfr)
      *
      * Definering av Local data area
      *
     d                uds
     d l_firm                944    946  0
      *
      * Definering av variable i nøkler
      *
     d jlevl3_enum     s                   like(jlenum)
     d jvdtl1_dvar     s                   like(jvdvar)
     d vvprlu_vare     s                   like(vpvare)
6.20 d vvprlu_ldor     s                   like(vpldor)
5.70 d vvprlu_prgr     s                   like(vpprgr)
     d vvarlu_vare     s                   like(vvvare)
      *
      * Definering av variable
      *
     d b_oppr          s              1    inz(*off)
      *
6.38 d w_utgp          s              1  0
     d w_udat          s               d   datfmt(*iso)
     d w_mvap          s              6  2
     d w_mvat          s              5  4
     d w_mvaf          s             10  9
     d w_kode          s              1  0
8.01 d w_prgr          s                   like(vpprgr)
8.01 d w_prut          s                   like(vpprgr)
8.01 d w_pgbe          s                   like(vpprgr)
6.3x d w_ffak          s              8  6
6.3x d w_inp2          s              9  2
8.01 d w_pgfr          s                   like(vpprgr)
6.3y d w_oppd          s              1
      *
     d w_grpr          s              9  2
     d w_gdat          s               d   datfmt(*iso)
     d w_enhe          s              3
     d w_enh1          s              3
     d w_enh2          s              3
     d w_enh3          s              3
     d w_eni1          s              3
     d w_eni2          s              3
     d w_eni3          s              3
     d w_enp1          s              3
     d w_enp2          s              3
     d w_enp3          s              3
     d w_ofp1          s             12  6
     d w_ofp2          s             12  6
     d w_ofp3          s             12  6
     d w_ofv2          s             12  6
     d w_ofv3          s             12  6
     d w_ofi1          s             12  6
     d w_ofi2          s             12  6
     d w_ofi3          s             12  6
     d w_bldo          s              6  0
     d w_bogr          s              2  0
     d w_bhgr          s              2  0
     d w_bugr          s              3  0
     d w_bmod          s              8  0
     d w_bvar          s             15
     d w_bvty          s              1
     d w_blet          s              1  0
     d w_bbet          s             35
     d w_ntpr          s              8  2
     d w_ifak          s              8  6
     d w_pogr          s              2  0
     d w_phgr          s              2  0
     d w_pugr          s              3  0
     d w_pldo          s              6  0
     d w_pmod          s              8  0
     d w_pvar          s             15
     d w_ppko          s              1
     d w_pvty          s              1
     d w_plet          s              1  0
     d w_kfak          s              8  6
     d w_kbel          s              7  2
     d w_sfak          s              8  6
     d w_midl          s              1  0
     d w_inpr          s              9  2
     d w_kopr          s              9  2
     d w_s1pr          s              9  2
     d w_s1im          s              9  2
     d w_s2pr          s              9  2
     d w_s2im          s              9  2
     d w_s3pr          s              9  2
     d w_s3im          s              9  2
     d w_dekn          s              5  2
     d w_ste1          s             35
     d w_ste2          s             35
     d w_ste3          s             35
     d w_ste4          s             35
     d w_ste5          s             35
     d w_pkod          s              1
     d w_skod          s              1  0
     d w_lety          s              1  0
     d w_gprk          s              1  0
     d w_eldo          s                   like(vvldor)
6.11 d w_osts          s              1
     d w_lvar          s                   like(vvlvar)
     d w_xxxx          s                   like(vvldor)
      *
     d w_firm          s                   like(vvfirm)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
      * Leser hele vareregisteret
      *
     c     vvarl1_key    setll     vvarl1
     c     vvarl1_key    reade     vvarl1                                 90
     c                   dow       *in90 = *off
      *
6.32 c                   if        vvnobb <> 0
      * sjekker om varen har pris med prisgr.
     c
5.70  *
6.32 c     ra30l1_key    setll     ra30l1
6.32 c     ra30l1_key    reade     ra30l1
5.70 c                   dow       not %eof
6.32  *  finner prisgiver og evt. behandler videre
6.32 c                   exsr      finn_prisg
6.32  *
6.32 c     ra30l1_key    reade     ra30l1
     c                   enddo
6.32 c                   endif
      *
     c     vvarl1_key    reade     vvarl1                                 90
     c                   enddo
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
6.32  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.32  * Subrutine som finner alle prisgivere for varen på prisgr. C
6.32  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.32  *
6.32 c     finn_prisg    begsr
6.32  *
6.32  * Initierer SQL for søk
6.32  *
6.32 c                   eval      *in15 = *off
6.32  *
6.32  *
6.32 c/exec sql
6.32 c+                  declare prisg cursor for
6.32 c+                  select distinct(vpldor)
6.32 c+                  from   vvprpf
6.32 c+                  where  vpfirm = :w_firm and
6.32 c+                         vpvare = :vvvare and
6.32 c+                         vpprgr = :redkod and
6.32 c+                         vpldor <> 0
6.32 c+                  for read only
6.32 c/end-exec
6.32 c/exec sql
6.32 c+                  close prisg
6.32 c/end-exec
6.32 c/exec sql
6.32 c+                  open prisg
6.32 c/end-exec
6.32  *
6.32 c                   dow       *in15 = *off
6.32  *
6.32 c/exec sql
6.32 c+                  fetch next
6.32 c+                  from  prisg
6.32 c+                  into  :vpldor
6.32 c/end-exec
6.32  *
6.32 c                   if        sqlcod = 100 or sqlstt = '02000'
6.32 c                   eval      *in15 = *on
6.32 c                   leavesr
6.32 c                   endif
6.32  *
6.32  * Initierer flagg for oppdatering
6.32  *
6.32 c                   eval      b_oppr = *off
6.32  *
6.32 c                   exsr      behandling
6.32  *
6.32 c                   enddo
6.32  *
6.32
6.32 c                   endsr
6.32
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine som henter prisinformasjon pr. enhet
      * Oppretter vare i vare-query-fil pr. enhet pr. leveringstype
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     behandling    begsr
      *
     c                   eval      jvdtl1_dvar = vvvare
     c     jvdtl1_key    chain     jvdtl1
      *
     c                   exsr      hent_pris
      *
     c                   if        w_prut =  *blank and
     c                             w_pgbe =  *blank and
     c                             w_pgfr =  *blank
     c                   eval      exclin = *blank
     c                   eval      exclin = %trim(vvvare) + ';' +
6.32 c                                      %trim(redkod) + ';' +
     c                                      %trim(w_Enh1) + ';' +
     c                                      %trim(vvtek1) + ';' +
     c                                      %char(jlldor) + ';' +
     c                                      %trim(w_osts) + ';'
     c                   write     lwexpfr
      *
      * sletter
      *
     c                   eval      vvprlu_vare = vvvare
     c                   eval      vvprlu_ldor = vpldor
     c                   eval      vvprlu_prgr = redkod
     c     vvprlu_key    setll     vvprlu
     c     vvprlu_key    reade     vvprlu
     c                   dow       not %eof(vvprlu)
     c                   delete    vvprlur
     c     vvprlu_key    reade     vvprlu
     c                   enddo

     c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine som henter status kode for overf. fra VA til EVR
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     hent_pris     begsr
      ** henter lev. fra VA
6.32 c                   eval      jlevl3_enum = vpldor
     c     jlevl3_key    chain     jlevl3
6.32 c                   if        %found(jlevl3)
6.32  *
      * Henter salgspris fra fellesprogram
      *
     c                   eval      w_pkod = jvdpko
     c                   eval      w_skod = jvdsko
     c                   eval      w_lety = 0
     c                   eval      w_gprk = 0
     c                   eval      w_xxxx = 0
6.3y c**                 eval      w_oppd = '1'
6.3y c                   eval      w_oppd = *blank
     c                   eval      w_utgp = 1
      *
     c                   call      'JV750R'
     c                   parm                    w_firm
     c                   parm                    vvvare
6.32 c                   parm                    redkod
     c                   parm                    jlldor
     c                   parm                    w_pkod
     c                   parm                    w_skod
     c                   parm                    w_lety
     c                   parm                    w_gprk
6.38 c                   parm                    w_udat
6.38 c                   parm                    w_utgp
      *
     c                   parm                    w_osts
      *
     c                   parm                    w_xxxx
     c                   parm                    w_lvar
     c                   parm                    w_eldo
     c                   parm                    w_grpr
     c                   parm                    w_gdat
      *
     c                   parm                    w_enhe
     c                   parm                    w_enh1
     c                   parm                    w_enh2
     c                   parm                    w_enh3
     c                   parm                    w_eni1
     c                   parm                    w_eni2
     c                   parm                    w_eni3
     c                   parm                    w_enp1
     c                   parm                    w_enp2
     c                   parm                    w_enp3
     c                   parm                    w_ofp1
     c                   parm                    w_ofp2
     c                   parm                    w_ofp3
     c                   parm                    w_ofv2
     c                   parm                    w_ofv3
     c                   parm                    w_ofi1
     c                   parm                    w_ofi2
     c                   parm                    w_ofi3
      *
     c                   parm                    w_bldo
     c                   parm                    w_bogr
     c                   parm                    w_bhgr
     c                   parm                    w_bugr
     c                   parm                    w_bmod
     c                   parm                    w_bvar
     c                   parm                    w_bvty
     c                   parm                    w_blet
     c                   parm                    w_bbet
     c                   parm                    w_ntpr
     c                   parm                    w_ifak
      *
     c                   parm                    w_pogr
     c                   parm                    w_phgr
     c                   parm                    w_pugr
     c                   parm                    w_pldo
     c                   parm                    w_pmod
     c                   parm                    w_pvar
     c                   parm                    w_ppko
     c                   parm                    w_pvty
     c                   parm                    w_plet
     c                   parm                    w_kfak
     c                   parm                    w_kbel
     c                   parm                    w_sfak
      *
     c                   parm                    w_midl
     c                   parm                    w_inpr
     c                   parm                    w_kopr
     c                   parm                    w_s1pr
     c                   parm                    w_s1im
     c                   parm                    w_s2pr
     c                   parm                    w_s2im
     c                   parm                    w_s3pr
     c                   parm                    w_s3im
     c                   parm                    w_dekn
6.10 c                   parm                    w_prut
6.3x c                   parm                    w_ffak
6.3x c                   parm                    w_inp2
6.3x c                   parm                    w_pgbe
6.3x c                   parm                    w_pgfr
6.3y c                   parm                    w_oppd
      *
6.32 c                   endif
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Key for les på vareregister
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for les på prisgr.
      *
6.32 c     ra30l1_key    klist
     c                   kfld                    w_firm
6.32  *
      * Key for les på lev. VA
      *
     c     jlevl3_key    klist
     c                   kfld                    jlevl3_enum
      *
     c     jvdtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    jvdtl1_dvar
      *
      * Key for les på var-pris
      *
     c     vvprlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvprlu_vare
     c                   kfld                    vvprlu_ldor
     c                   kfld                    vvprlu_prgr
      *
      * Henter firma fra LDA
      *
     c                   eval      w_firm = l_firm
      *
      * Skriver heading
      *
     c                   eval      exclin = *blank
     c                   eval      exclin = 'Lister priser uten PG-kalkyle' +
     c                                                      ';' +
     c                                      '  '          + ';' +
     c                                      '  '          + ';' +
     c                                      '  '          + ';' +
     c                                      '  '          + ';' +
     c                                      '  '          + ';'
     c                   write     lwexpfr
      *
     c                   eval      exclin = *blank
     c                   eval      exclin = 'Varenr '     + ';' +
     c                                      'Prisgruppe'  + ';' +
     c                                      'Enhet '      + ';' +
     c                                      'Varetekst '  + ';' +
     c                                      'VA Leverandør'  + ';' +
     c                                      'Status '     + ';'
     c                   write     lwexpfr
      *
      * Henter mva-faktor
      *
     c                   time                    w_udat
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
     c                   parm                    w_udat
     c                   parm                    w_mvap
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
      *
     c                   endsr
