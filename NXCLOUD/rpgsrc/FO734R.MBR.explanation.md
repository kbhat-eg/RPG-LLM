# FO734R – Order Picking/Display and Purchase Order Generation

## Purpose and Business Context

**FO734R** is a central program in the order management and procurement workflow. It manages the selection ("picking") and display of order numbers for further processing, specifically for creating purchase orders (bestilling) and purchase order proposals (bestillingsforslag) based on sales orders. The program is highly configurable, supports multiple business rules, and integrates with a variety of master and transaction files.

The program facilitates:
- Picking order lines for procurement from sales orders.
- Automatically or interactively selecting suppliers for order lines.
- Generating purchase orders or purchase order proposals.
- Updating all related files (order headers/lines, picking registers, purchase order headers/lines).
- Handling complex business rules around supplier selection, order types, pricing, and logistics.

## High-Level Flow

1. **Initialization**: Loads parameters, company and order info, and configuration switches.
2. **Order Validation**: Ensures the order exists, is eligible for procurement, and is not already being processed.
3. **Supplier Determination**: Finds the next supplier with order lines needing procurement.
4. **Line Picking**: Allows the user to pick lines for procurement (either all, selected, or none).
5. **Procurement Generation**: Depending on configuration and user input, creates either a purchase order or a purchase order proposal.
6. **Updates and Finalization**: Updates all relevant registers/files and optionally triggers further actions (like printing or EDI).

## Key Files and Data Structures

- **Order Header/Line**: `fohel1`, `fodtl1`
- **Purchase Order Header/Line**: `lohel1`, `lodtlu`
- **Picking Register**: `fplll1`, `fplllur`
- **Supplier Master**: `rlevl1`
- **Customer Master**: `rkunl1`
- **Order Type Master**: `votyl1`
- **Logistics/Inventory**: `vvarl1`, `lldil1`
- **Configuration and Status Files**: Various, including parameter-driven logic switches.

## Design Patterns and Conventions

- **Versioned Comments**: Extensive use of version and change history in comments.
- **Conditional Logic via Parameters**: Many business rules are controlled by parameters and switches, often loaded via calls to `CO402R` (configuration program).
- **Subroutine-Oriented Structure**: Core logic is encapsulated in named subroutines (`begsr`/`endsr`), each handling a specific aspect of the workflow.
- **File/Key Naming**: File and key variable names are suffixed with `_key`, `_numm`, `_suff`, `_line` for clarity.
- **Switches for Feature Flags**: Feature enablement is controlled by variables like `u_701`, `u_fsor`, `b_bfor`, etc., set at initialization.

## Core Logic Explanation

### 1. **Initialization (`*inzsr`)**

- Loads parameters from calling program.
- Sets up company number, order number, suffix, and other context.
- Loads configuration switches via `CO402R` calls (e.g., for color coding, project handling, department logic, etc.).
- Prepares file keys for later use.

### 2. **Order Validation and Setup**

- Checks if the order exists in the header file.
- Validates order type eligibility via the order type master.
- If the order is already being processed (e.g., already in a purchase order), aborts with a message.
- For internal orders, checks for recursion to prevent re-entry into `LO500R` (purchase order program).

### 3. **Supplier Selection (`hntlev`)**

- Scans order lines to find the next supplier with lines needing procurement.
- Calls `VL721R` to determine the correct supplier for a line (can be overridden by item/supplier logic).
- Sets up context for the selected supplier.

### 4. **Line Picking (User Interaction)**

- Displays a screen (subfile) for the user to pick lines for procurement.
- Supports picking all lines, selected lines, or none.
- Handles automatic filling of quantities if requested.
- Validates supplier and order type selections.
- Supports inquiry (F4) into suppliers, order types, and delivery methods.

### 5. **Procurement Generation**

- Depending on business rules and user input, either:
    - Generates a purchase order (`xh1win`, `ohrest`, etc.).
    - Generates a purchase order proposal (`xm1win`, `bes_lin_for`, `bes_hode_for`).
- Handles all required calculations for totals, prices, taxes, and logistics.
- Writes header and line records to purchase order/proposal files.
- Updates picking registers and flags lines as processed.

### 6. **Updates and Finalization**

- Updates the original sales order and lines with references to the generated purchase order or proposal.
- Updates totals and statuses in purchase order headers (`oppdat_best`, `hent_total`).
- Optionally triggers further processes (printing, EDI, etc.).
- Handles all error and edge cases (e.g., deposit required but not paid, supplier blocked, etc.).

### 7. **Subfile and Screen Handling**

- Uses subfiles extensively for line selection and display.
- Provides routines for clearing, filling, and refreshing subfiles.
- Supports color coding and highlighting based on configuration and line/item properties.

## Notable Business/Domain-Specific Logic

- **Supplier/Order Type Overriding**: Supplier and order type can be dynamically overridden based on item, supplier, or logistics distribution settings.
- **Purchase Order Proposals**: Supports generating proposals instead of actual orders, with different data flow and validation.
- **Deposit Handling**: Checks for required deposits before allowing procurement to proceed.
- **Color Coding (Fargekode)**: Items/lines can be color coded in the UI based on sortiment or item type, driven by configuration.
- **Project and Department Handling**: Project numbers and departments can be defaulted from different sources (order, warehouse, etc.), controlled by config.
- **EDI/External Integration**: Writes to auxiliary registers for EDI processing, supports external warehouse address overrides via embedded SQL.
- **MVA (VAT) Logic**: VAT codes are set on line level, with logic for overrides from supplier or item master.

## Integration Points

- **CO402R**: Configuration parameter reader. Used to drive feature flags and business logic.
- **VL721R, VL710R, VP753R, LH714R**: Various programs for supplier/item logic, price calculation, and total calculation.
- **AA005R, AA006C**: Message display programs for error and status messaging.
- **MJ500R, FØ720R**: Logistics and address lookup programs.
- **SQL**: Embedded SQL for external warehouse address lookups.

## Error Handling and Edge Cases

- Extensive validation at each step (order existence, supplier status, deposit status, etc.).
- Defensive logic for edge cases (e.g., text lines, missing quantities, all lines already processed).
- User feedback for all blocking conditions, with clear messages.

## Versioning and Maintenance

- The program is heavily versioned, with clear comments for each change, including business rationale.
- Many routines and logic branches are conditional on version or configuration, supporting a flexible and evolving business process.
- Comments in Norwegian, but code and variable names are largely English or standard Norwegian business abbreviations.

## Key Patterns for New Developers

- **Understand the configuration-driven nature**: Many behaviors change based on `CO402R` parameters.
- **Follow the subroutine structure**: Each subroutine handles a specific business process step.
- **Pay attention to file and key variable naming**: Consistent naming conventions make it easier to follow file access logic.
- **Review error and edge case handling**: Most user-facing errors are handled via message routines and are well-commented.
- **Look for integration points**: Many routines call out to external programs for business logic, calculations, or lookups.

## Summary Table: Key Subroutines

| Subroutine      | Purpose                                                      |
|-----------------|-------------------------------------------------------------|
| `hntlev`        | Find next supplier with lines to procure                     |
| `hntlll`        | Gather lines for selected supplier                           |
| `xd1bld`        | Build and display subfile for line picking                   |
| `xh1win`        | Generate purchase order                                      |
| `xm1win`        | Generate purchase order proposal                             |
| `ohrest`        | Write purchase order header                                  |
| `olrest`        | Write purchase order lines                                   |
| `okrest`        | Write picking lines                                          |
| `opplag`        | Update warehouse/stock                                       |
| `sjekk_ant`     | Check if any quantity is entered for procurement             |
| `sjekk_bestf`   | Check if line is already in a purchase order proposal        |
| `sjekk_depo`    | Check deposit requirements                                   |
| `sbform`        | Fetch delivery method text                                   |
| `hntltx`        | Fetch warehouse address text                                 |
| `hent_logp`     | Fetch logistics point info                                   |
| `sjekk_ekst`    | Check for external warehouse address (SQL)                   |
| `hntfad`        | Fetch customer invoice address                               |
| `forny`         | Refresh subfile                                              |
| `dsp_subfile`   | Display subfile                                              |
| `clr_subfile`   | Clear subfile                                                |
| `crt_subfile`   | Fill subfile                                                 |
| `hentin`        | Auto-fill quantities                                         |
| `oppdat_best`   | Update purchase order totals                                 |
| `hent_total`    | Calculate purchase order totals                              |

---

## Final Notes

- This program is critical for integrating sales order fulfillment with procurement.
- It is designed to handle a wide array of business scenarios and edge cases.
- **Always check configuration and version comments** when troubleshooting or extending functionality.
- **Coordinate with other teams** when making changes, as this program interacts with many core modules and master data.

For further details on specific subroutines or business rules, refer to the in-line comments and version history within the source code.