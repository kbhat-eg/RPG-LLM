# FO980R – Order Print Program Documentation

## Overview

**Program Name:** FO980R  
**Description:** Prints purchase orders (“Utskrift av Bestilling”)  
**Domain:** Order processing and reporting  
**Primary Output:** Formatted order printouts (printer file: FO980P)

This program reads order data from various files, formats it according to business rules, and outputs a structured report. It handles order headers, line items, and associated text/comments, with logic to manage page overflow and formatting details based on business requirements.

---

## File Dependencies and Relationships

- **Order Files:**  
  - `FPSOL1` (Order transactions, renamed FPSOL1R)  
  - `FOHEL1` (Order headers, FOHEL1R)  
  - `FODTL1` (Order details/lines, FODTL1R)  
  - `FOTXL1` (Order text lines, FOTXL1R)
- **Reference Files:**  
  - `VOTYL1` (Order types, VOTYL1R)  
  - `VLTYL1` (Line types, VLTYL1R)  
  - `VVARL1` (Item master, VVARL1R)  
  - `rlevl1` (Supplier master, rlevl1r)  
  - `AFIRL1` (Company master, AFIRL1R)  
  - `AFORL1` (Routine/formula texts, AFORL1R)
- **Output File:**  
  - `FO980P` (Printer file for report output)

All input files are read with `K` (keyed) access where appropriate, reflecting normalized data and referential integrity.

---

## Data Structures and Key Business Fields

- **Company/Enterprise Number Structure:**  
  Used to format company numbers and VAT information on the report.

- **LDA (Local Data Area) Usage:**  
  Pulls in runtime parameters such as routine name (`DSRUTI`), line count (`DSALIN`), and company number (`DSFIRM`).

- **Key Lists:**  
  Defined for rapid keyed access to related records (order header, detail, text, supplier, company, etc.).

---

## Main Processing Flow

### 1. Initialization

- **Entry Point:**  
  The program cycles through records in `FPSOL1R`.
- **Order Record Type Dispatch:**  
  Based on the value of `FKSKOD`, the program branches to handle:
  - `'H'` – Order header (`TAG01`)
  - `'V'` – Order line item (`TAG02`)
  - `'K'` – Order text/comment line (`TAG03`)
- **Program Termination:**  
  Once processing is complete, control jumps to `XSLUTT`.

---

### 2. Order Header Processing (`TAG01`)

- **Header Fetch:**  
  Retrieves order header from `FOHEL1R` using keys (company, order number, suffix).
- **Date Handling:**  
  Dates are normalized (converted from internal to DMY format if present).
- **Supplier Info:**  
  If present, supplier details are retrieved from `rlevl1r`.
- **Delivery Address:**  
  If a delivery address is specified, it is used in place of the supplier address.
- **Customer Reference:**  
  If present, customer reference is included.
- **Report Heading:**  
  The formatted heading is written to the printer file via `A1HDR`.
- **Overflow Handling:**  
  Print line counter (`WLTELL`) is reset after writing the heading.

---

### 3. Order Line Processing (`TAG02`)

- **Line Detail Fetch:**  
  Retrieves order line from `FODTL1R`.
- **Line Type Lookup:**  
  Pulls descriptive info from `VLTYL1R`.
- **Order Type Filtering:**  
  Skips lines based on order type values (`VALO01`–`VALO04`).
- **Item Master Lookup:**  
  Retrieves item details from `VVARL1R`.  
  - **Special Case:** If the item is from LVR (`FDLVRE = 1`), sets decimals to 2 (per business rule).
- **Quantity Formatting:**  
  The program supports quantities with 0–3 decimals, assigning the value to the appropriate field (`D1ANT0`–`D1ANT3`).
- **Report Detail:**  
  Writes either item line (`D1DET`) or text line (`D2DET`) as appropriate.
- **Overflow/Page Breaks:**  
  If page overflow is detected (`*IN30`), writes a new heading.

---

### 4. Order Text/Comment Line Processing (`TAG03`)

- **Text Fetch:**  
  Retrieves text line from `FOTXL1R`.
- **Deferred Text Printing:**  
  If not accumulating (`VAOSAM = 0`) and line number is above 5000, skips printing (to be handled at report end).
- **Report Detail:**  
  Writes text line (`E1DET`).
- **Overflow/Page Breaks:**  
  Handles page overflow as in line processing.

---

### 5. Totals and Report Completion

- **Space Calculation:**  
  Before writing totals, the program checks if there is enough space on the page for the summary and, if not, starts a new page.
- **Totals Output:**  
  Writes the totals section (`T1TOT`).
- **Deferred Text Lines:**  
  If text lines were skipped earlier (line > 5000), they are printed after the totals.

---

## Subroutines

### XSTRSR – Startup Routine

- **Initializes cycle counter.**
- **Loads company name and VAT info if required (from `AFIRL1R`).**
- **Loads order type info (from `VOTYL1R`).**
- **Sets flags for special order types (e.g., negative orders).**

### *INZSR – Program Initialization

- **Defines variable equivalence for key fields.**
- **Initializes working variables and counters.**
- **Defines key structures for all file accesses.**
- **Loads routine name and associated texts from `AFORL1R`.**

---

## Business/Domain-Specific Logic

- **Order/Line Types:**  
  Filtering and formatting are heavily dependent on order and line type codes. Certain types are skipped or handled specially.
- **Decimals Handling:**  
  The number of decimals for quantities is dynamically determined, with a special override for items sourced from LVR.
- **Supplier and Delivery Address:**  
  Supplier info is the default, but can be overridden by a specified delivery address.
- **Text Line Deferral:**  
  Business rule: text lines with line numbers above 5000 are deferred until after the totals, unless accumulating.
- **Overflow Management:**  
  The program tracks the number of lines written and inserts headings as necessary on page breaks.

---

## Coding/Design Conventions

- **Tag-based Branching:**  
  Uses RPG’s `TAG` and `GOTO` for dispatching to processing blocks.
- **Key Lists:**  
  All file accesses are via pre-defined key lists, ensuring consistency and maintainability.
- **Indicator Usage:**  
  Classic RPG indicators (`*INxx`) are used for flow control and file status.
- **Extensive Comments:**  
  Comments are in Norwegian, reflecting the business context and intended audience.
- **Change History:**  
  Maintains a detailed change log at the top of the source for traceability.

---

## External Relationships

- **Data Integrity:**  
  The program expects all referenced files to be consistent and keyed correctly.
- **Output Format:**  
  Output is tightly coupled to the printer file layout, with specific formats for headings, details, text lines, and totals.
- **LDA Usage:**  
  Relies on LDA for runtime configuration, such as current company, routine, and print layout settings.

---

## Noteworthy Points for New Developers

- **Legacy Structure:**  
  The code is written in classic RPG (fixed-format), with heavy use of indicators and positional data structures.
- **Business Rules Embedded:**  
  Many business rules (e.g., decimal handling, address selection, text line deferral) are implemented directly in the processing logic, not abstracted into separate modules.
- **Extensibility:**  
  Adding new order or line types, or modifying print formats, requires updates both to the key structures and to the logic blocks handling each type.
- **Localization:**  
  Variable names and comments are in Norwegian; understanding the business domain is essential for maintenance and extension.

---

## Summary

FO980R is a core order printing program that consolidates order, item, supplier, and company data into a formatted print report. It is highly parameterized via key structures and LDA, and implements several domain-specific rules for formatting, overflow, and deferred printing of text lines. Mastery of this program requires familiarity with both the technical structure (classic RPG, indicator usage, key lists) and the underlying business processes (order handling, supplier management, Norwegian reporting standards).