# RPG Program Explanation: VI500R (PÅslag-hode, spørring)

This program is a traditional IBM i ILE RPG (likely RPGIV/free) application designed for work with subfiles on a display file. It's for a query/search screen for "påslag-hode" (markup headers), letting the user view, filter, and select records using subfiles.

## Structure Overview

- **Main Purpose:**  
  Display and allow navigation/search within a list of "påslag-hode" records using subfile functionality. User can navigate via page up/down, position to a specific key, select rows, and exit.

- **Primary Files:**
  - `vphel1` / `vphel2`: Physical files holding the "påslag-hode" data, accessed by different keys (one by code, one by description).
  - `vi500d`: Display file with subfile (SFL) functionality.

- **Display:**
  - Subfiles let you display portions of large datasets, supporting roll/rolldown, position-to, etc.

---

## Head Section (`H`/`F`/`D` Specs)

- `h option(*nodebugio) datedit(*dmy)`
  - Source listing options: No debug I/O, date edit as DMY (for editing date fields).

- **Files:**
  - `vphel1` and `vphel2`: DISK, keyed, externally described, renamed record formats.
  - `vi500d`: Device file (WORKSTN), with a subfile (`b1sfl`) and display feedback data structure.

- **Parameters and Variables:**
  - `p_firm`, `p_pasl`, `p_besk`: Input parameters (firm code, markup code, description).
  - `dspfbk` DS: Display feedback, e.g., cursor row/column.
  - Many working variables for subfile management: current/first/last subfile row, page size, etc.

- **Constants:**
  - `c_sfil`: Subfile page size (8).

---

## Indicator Usage

Indicators (classic RPG) control display and program logic:

- E.g., `*in10` = Roll, `*in11` = Rolldown, `*in12`/`*in13`/`*in14`/`*in15`: Various subfile and control flags.
- Custom indicators for error messages (31-79), work indicators (80-99).

---

## Key Collections and Display Structures

- `vphel1_key`, `vphel2_key`: Key lists for `setll`/`chain` to position the files.
- Subfile control and data (b1sfl, b2ctl, b2cmd): Used for display and interaction.

---

## Main Loop Overview

### Entry & Initial Setup

- Program receives firm code, markup code, description as parameters.
- Sets up file position based on `p_firm`.
- Initializes indicator 22 (cursor placement), and positions vphel1 to blank markup.
- Calls subroutine to build the first page of the subfile.

### Main Display Loop (`b2taga`/`b2tagb`):

- Label (`tag`) structure to create a main program loop, typical in RPGIII/IV.
- **Display Cycle:**
  1. Write command screen (`b2cmd`), or, after that, show subfile (via `exsr dsp_subfile`).
  2. Process user function keys:
     - F3/F12 (`*inkc`/`*inkl`): Exit.
     - F5 (`*inke`): Refresh (forny).
     - Roll Up/Down (`*in10`/`*in11`): Page next/back.
     - Home (`*in21`): Position cursor.
  3. If user entered position-to fields (`b2pasl` or `b2besk`), call position-to logic.
  4. Otherwise, process subfile for selection.

- **Program Exit:**  
  If user chooses exit or selects a row for output, set `*inlr`=on and return.

---

## Important Subroutines

### `forny` (Refresh Subfile)

- If a row is currently displayed, chain to that row.
- Sets file position by description or code, according to `w_seqe`.
- Clears subfile and rebuilds it.

### `posisjoner` (Position-to Subfile)

- If `b2pasl` entered, set key to code and position.
- If `b2besk` entered, set key to description and position.
- Clear and rebuild subfile accordingly.
- Blank out the position-to fields after action.

### `subfile` (Process Subfile Selection)

- Cycle through records in the subfile.
- If a row is selected (`b1valg = 1`), set output parameters `p_pasl` and `p_besk`, set selection indicator (`b_valg_ok`), and exit.

### `clr_subfile` (Clear Subfile)

- Set subfile clear indicator, write control record, reset working subfile variables.

### `crt_subfile` (Create/Fill Subfile Page)

- Set target to next page of subfile.
- Loop to read records from master file and write to the subfile until the page is full or EOF.
- Support both key-by-code and key-by-description.

### `bck_subfile` (Roll Back Page)

- Handles page-up/roll-back logic in the subfile.
- Reads backwards (using `readp`) to fill the previous page.

### `dsp_subfile` (Display Subfile)

- Handles display logic with control and subfile records.
- Updates feedback info (cursor position, etc).

### `*inzsr` (Initialization)

- Called at program start.
- Gets parameters, initializes keys, fetches firm code, positions database, creates initial subfile.

---

## General Notes on RPG Style

- **Subfile processing**: Classic green-screen data browsing, with features for roll, positional keying, and row selection.
- **Indicators**: Central in controlling both I/O and logic flow.
- **Labels & GOTO**: This is an older idiom, replaced by more structured code in modern RPG.
- **Subroutines (`begsr`/`endsr`)**: Used for code modularity.

---

## Program Flow Summary

1. **Initializes**: Reads input parameters, positions at start-of-data.
2. **Main Loop**: Shows display, waits for user action, handles:
   - Page up/down
   - Position to code/description
   - Row selection for output
   - Program exit
3. **Subfile Management**:
   - Fills, clears, and maintains user position in data via subfile logic.
4. **Output**:
   - On row selection, returns selected values via parameters.

---

## Swedish/Norwegian Naming

- Several comments and field names are in Norwegian (e.g., "Beskrivelse" = Description), which is common for applications developed for Nordic markets.

---

## Onboarding Tips

- **Understand subfile basics**: This is key to following the processing logic.
- **Indicator map**: Keep track of what each indicator controls (display, error, logic).
- **File keys**: Study how data is positioned in files by code vs. description (`w_seqe` variable switches between modes).
- **Refactoring**: Consider replacing GOTOs/labels with structured logic if porting/modernizing.
- **Display file maps**: Get familiar with the display file (`vi500d`) layout for understanding which fields drive which behaviors.

---

## Summary

This is a robust, classic-style RPG subfile inquiry/selection program. It’s primarily about displaying a list of records with roll, filter, and select capabilities using subfile display techniques, and handing off selected values for use elsewhere in the system.