# Documentation for Program VV780R

## Overview

**Program Name:** VV780R  
**System:** ASOFAK  
**Purpose:**  
This program facilitates the copying of product (item) data from one file group to another, based on a set of user-supplied parameters. It serves as an interactive front-end, collecting criteria and invoking a transfer program (`VV780C`) to perform the actual copy operation.

The program supports advanced selection criteria, including supplier, item groups (overgroup, main group, subgroup), explicit item numbers, and date-based selections. It also provides inquiry support for these fields, and validates all input before triggering the copy.

---

## Key Features

- **Interactive Screen:** Uses display file `VV780D` for user interaction.
- **Flexible Selection:** Supports filtering by supplier, item groups, item numbers, and creation date.
- **Inquiry Support:** Lookup subroutines for suppliers, groups, and items.
- **Validation:** Comprehensive input validation with feedback.
- **Parameter Structure:** Gathers all criteria into a single data structure (`d_list`) for downstream processing.
- **Delegation:** Calls external program `VV780C` for the actual copy operation.
- **Modular Design:** Subroutines for inquiry (`spørring`), input validation (`sjekk_input`), and initialization.

---

## File Definitions

- **Physical Files:**  
  - `rlevl1` (Supplier master, renamed from `rlevpfr`)
  - `vogrl1` (Item overgroup, renamed from `vogrpfr`)
  - `vhgrl1` (Item main group, renamed from `vhgrpfr`)
  - `vugrl1` (Item subgroup, renamed from `vugrpfr`)
  - `vvarl1` (Item master, renamed from `vvarpfr`)
- **Display File:**  
  - `vv780d` (Workstation device for user interface)

---

## Data Structures

### Local Data Area (LDA) Fields

- `l_fgrp` (File group)
- `l_firm` (Company number)
- `l_fnav` (Company name)

### Parameter List (`d_list`)

A 260-byte structure containing all selection parameters for the copy operation. Fields include:

- `d_fgrp`, `d_firm` (File group and company)
- `d_ldor` (Supplier)
- `d_ogrp`, `d_hgrp`, `d_ugrp` (Item groups)
- `d_var0`-`d_var9` (Up to 10 item numbers)
- `d_odat` (Creation date, ISO format)
- `d_vtyp` (Item type override)
- `d_fgt0`-`d_fgt9`, `d_fit0`-`d_fit9` (Additional group/item fields for extended selection)
- `d_file` (File type, used for CSV import)
- `d_dumm` (Dummy field, used to prevent data structure "pollution" in memory; always set to `'*'`)

### Working Variables

- Key fields for each master file, used for validation and inquiry.
- `b_feil` (Error flag)
- `w_firm`, `w_tek1` (Working fields for company and item description)

---

## Main Program Flow

### 1. Initialization (`*inzsr`)

- Sets up key lists for file lookups.
- Retrieves the company number from LDA.

### 2. Main Loop

- Displays the main screen (`b1bld`).
- Handles function keys:
  - Cancel/Exit (`*INKC`, `*INKL`): Exits program.
  - Inquiry (`*INKD`): Calls inquiry subroutine (`spørring`).
- Validates user input (`sjekk_input`). If errors, redisplays the screen.
- On valid input:
  - Transfers screen fields to the parameter structure (`d_list`).
  - Calls the transfer program `VV780C`, passing `d_list`.
  - Displays a submission confirmation screen (`b1sbm`).
  - Resets input fields for new input.

### 3. Exit

- Sets LR indicator and returns control.

---

## Subroutines

### Inquiry (`spørring`)

Handles field-level lookups for:

- Supplier (`RL500R`)
- Overgroup (`VG510R`)
- Main group (`VG511R`)
- Subgroup (`VG512R`)
- Item numbers (`VV500R` for each of `b1var0`-`b1var9`)

Each lookup passes the relevant field(s) and updates display fields with descriptive text.

### Input Validation (`sjekk_input`)

- Ensures at least one of supplier, item number, or date is provided.
- Validates each field by chaining to the corresponding master file.
- For item numbers, validates all up to 10 entries.
- Checks date format if provided.
- Validates item type field (`b1vtyp`), allowing only blank, 'L', or 'S'.
- Sets error indicators for the display file as needed.

---

## Business/Domain-Specific Logic

- **File Group/Company:** Supports multi-company, multi-file group environments.
- **Item Group Hierarchy:** Supports selection by overgroup, main group, and subgroup, reflecting the product hierarchy.
- **Supplier/Item Selection:** Allows selection by supplier or up to 10 explicit item numbers.
- **Date Selection:** Optionally restricts by creation date.
- **Inquiry Integration:** Tightly coupled to master data inquiry programs, providing user assistance.
- **Parameter Packing:** All selection criteria are packed into a single structure for downstream processing.
- **CSV Import (since v6.31):** Field `d_file` is used to indicate CSV-based item selection, supporting bulk operations.

---

## Design Patterns and Conventions

- **Data Structure Overlay:** Heavy use of overlays in the parameter structure to allow flexible packing/unpacking.
- **Error Handling:** Uses indicators for field-level error feedback on the display file.
- **Separation of Concerns:** UI, validation, and business logic are clearly separated into subroutines.
- **Extensibility:** Parameter structure and mainline logic are designed to accommodate new selection criteria with minimal disruption.
- **Dummy Field:** `d_dumm` is a defensive measure to prevent data structure memory leakage or "pollution"—a common RPG idiom in older codebases.

---

## External Dependencies

- **Transfer Program:** `VV780C` — Receives the packed parameter list and performs the actual copy operation.
- **Inquiry Programs:** `RL500R`, `VG510R`, `VG511R`, `VG512R`, `VV500R` — Used for field lookups and descriptive feedback.
- **Master Files:** Supplier, item group, and item master files for validation and lookup.

---

## Notable Historical Changes

- **Parameter Expansion:** Over time, the parameter structure has been extended to support more criteria (e.g., price code retention, auto-creation of assortments, supplier info copying, etc.).
- **Date Selection and Company-in-Filegroup:** Added to support more granular selection.
- **Type Override and CSV Import:** Later enhancements for new business needs and bulk operations.
- **GUI Adaptations:** Adjustments for compatibility with new GUI front-ends.

---

## Summary

This program is a robust, user-focused front-end for copying product data between file groups, supporting a wide range of selection and validation criteria, and tightly integrated with master data and inquiry subsystems. It is designed for maintainability and extensibility, reflecting the evolving needs of the business.