# RPG Source Code Explanation: Start of the ASOFAK Program

This RPG program, named **FO605R**, is designed to initiate the printing process of order papers ("ordrepapirer") in an IBM i environment. It contains various configurations, data definitions, and control flows to handle user input, validate data, and coordinate with other programs for printing and updating records.

---

## 1. Metadata and Documentation
- **Title and Description:** The program is titled "ASOFAK: Start utkjøring av ordrepapirer" which translates to "ASOFAK: Start printing of order papers".
- **Author and Revision Info:** It was created on July 24, 2023, by user "bsa", with a note indicating it is a new program.
- **Comments:** Extensive comments describe the purpose, changes, and structure for clarity.

---

## 2. File and Data Structure Renaming
- Several input files (disk files) are renamed for internal ease:
  - `votypfr` → `votyl1r`
  - `fstspfr` → `fstspfr` (not renamed)
  - `raa1pfr` → `raa1l1r`
  - `fpm1pfr` → `fpm1lur`

These are likely data files/tables for order types, status, member info, etc.

---

## 3. Data Definitions (`D` specifications)
### User and System Identifiers
- **LDA (Local Data Area):** Variables such as `l_wsid`, `l_user`, `l_sfir`, `l_fnav` store session/user info.

### Data Structures
- **Member Info (`d_memb`):** Holds member code, firm number, and number, with `overlay`.
- **Period (`d_peri`):** Holds a period with month and year components.
  
### Parameters (`D` variables)
- Parameters like `p_dirk`, `p_firm`, `p_numm`, etc., are used for passing values into the program (e.g., directory flag, firm number, order number, etc.).
  
### Internal Variables (`D` variables)
- Variables such as `w_firm`, `w_valg`, `w_numm`, etc., are used for program logic and temporary storage.
- Date variables (`w_dato`, etc.) formatted as ISO (YYYY-MM-DD).

---

## 4. Core Logic
### Direct Print Handling
- Checks if an order number (`p_numm`) is provided:
  - If yes, the program jumps to label `f2taga` to process printing directly.
  - Otherwise, it proceeds to handle printing options.

### Choice Handling (F1 Menu)
- Labels `f1taga` and related logic handle user choice for print options:
  - Defaults to "all" if no specific type selected.
  - Options include: "Offer", "Order Confirmation", "Packing Slip", "Invoice", "Credit Note".
  - User input can override these defaults or select from predefined types.

### Processing Periods and Invoice Dates (F2)
- Label `f2taga` manages the selection of periods and invoice dates:
  - Reads invoice type info from the register.
  - Validates if the invoice type is a specific code ('99' for invoice/credit note).
  - Resets or fetches period and date info.
  - Checks if the invoice date is valid and within the specified period.
  - Checks for anomalies such as year differences or period overlaps.
- Also interacts with other programs (`FA730R`) to confirm if billing or accounting entries are in progress and updates a job register accordingly.

---

## 5. Initiating Print Parameters (`start`)
- Sets up parameters for the print job:
  - Calls subroutine `param` to populate print parameters based on the current selections.
  - If a specific order number (`p_numm`) is provided, skips certain steps.
  - For offers, runs the parameter subroutine multiple times for different list numbers.
  - For order papers, runs once.
  - For invoices or credit notes, skips printing of order papers.

### Calling the Print Program
- Proceeds to label `neste` which calls external program `'FO612C'` to run the actual print.

---

## 6. Finalization and Record Updates
- Sets the program's end indicator `*inlr = *on` to release resources.
- Calls `FA920R` to fetch the last used member number.
- Checks if the retrieved member is already used; if so, resets the number and retries the fetch. Then, calls `'FO604C'` to mark the member as used.

---

## 7. Subroutines and External Program Calls
- **`param`:** Prepares print parameters and updates the order pick register (`fpm1lur`) with current info.
- **`*inzsr`:** Initialization routine that resets variables, fetches registration data, and prepares environment for processing.
- **`FA730R`, `FA720R`, `FO604C`:** External programs used for billing checks, job registration, and member record updates.

---

## 8. Summary
This RPG program is a control module for initiating printing of order documents based on user input or direct order number, verifying periods, invoice dates, and registration statuses. It coordinates with other system programs to ensure consistency and updates relevant registers to track the printing process.

---

## 9. Additional Notes
- The code heavily relies on external programs and files for data retrieval and updates.
- User interaction is simulated via parameter settings and menu labels (`f1taga`, `f2taga`).
- Error handling involves checking date validity and registration status, with jumps to cleanup or re-entry points.
- Proper resource cleanup is performed at the end (`*inlr = *on`).

---

This overview should help new developers understand the structure, flow, and purpose of this RPG program for order paper printing.