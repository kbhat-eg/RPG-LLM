# Program FO743R â€” Automatic Generation of Purchase Orders from Sales Orders

## Overview

This program (FO743R) is responsible for automatically generating purchase orders for items found on sales orders, specifically checking whether any items on open sales orders need to be reordered (purchased). It is designed to be invoked by another program and operates on specific files in the order and item master domains.

## Business Logic

- **Purpose**: For each line item on a given sales order, determine if the item must be purchased (e.g., is a special order or not stocked).
- **Assumptions**:
  - The item is a "skaffevare" (procurement item, typically not stocked).
  - The item data is maintained in the item master.
  - The order is for direct delivery.
- **Outcome**: Sets the flag `p_best` to '1' if any line on the order requires a purchase order to be generated; otherwise, it remains '0'.

## File Usage

- **fodtl1**: Order line file (Ordre-linje-register), renamed as `fodtl1r`.
- **vvarl1**: Item master file (Vare-register), renamed as `vvarl1r`.
- **vvlel1**: Supplementary item info (Trelast sortiment), renamed as `vvlel1r`. (Added in version 6.30 for extended item attributes.)

## Parameters

- **Input/Output Parameters** (passed via *ENTRY PLIST):
    - `p_firm` (3,0): Company identifier.
    - `p_numm`: Order number.
    - `p_suff`: Order suffix.
    - `p_best` (1): Output flag, set to '1' if any order line triggers a purchase.
- **Internal Variables**:
    - `p_vtyp`: Item type (from item master, e.g., 'S' for assortment).
    - `w_utda`, `w_ldor`: Date fields used as parameters for price group lookup.
    - `w_lv_nobb`, `w_lv_modn`, `w_lv_lldo`, `w_lv_llva`: Extended item attributes for lumber assortment (since v6.30).

## Main Processing Flow

1. **Initialization**: 
    - The *INZSR subroutine sets up the file keys for both order lines and item master.
    - Parameters are received from the calling program.

2. **Order Line Processing**:
    - The program iterates through all lines (`fodtl1`) for the specified order (`p_firm`, `p_numm`, `p_suff`).
    - **Text Lines Skipped**: If `fdvare` (item number) is blank, the line is skipped (not a material line).
    - **Item Information Retrieval**: For each line, the corresponding item record is retrieved from `vvarl1`.
    - **Purchase Requirement Check**:
        - If `fdbenr` (purchase number) is zero (not already ordered), further checks are performed:
            - Calls program `VL710R` to retrieve price group and item type information.
            - If item type (`p_vtyp`) is 'S' (assortment), or if the order line is a direct delivery (`fdlety = 1`) or a supplier delivery (`fdlvre = 1`), then this line requires a purchase order.
            - Sets `p_best` to '1' and exits immediately (no need to check further lines).
    - Continues until all order lines are processed or a purchase requirement is found.

3. **Exit**:
    - The program sets LR indicator and returns to the calling program.

## External Program Calls

- **VL710R**: This is a key component that determines the price group and item type for the item in question. It is called with several parameters, including company, item number, warehouse, and several extended attributes (for lumber assortment from v6.30 onwards). The result, especially `p_vtyp`, is used to make the final decision about ordering.

## Key Design/Domain Considerations

- **Immediate Exit on First Match**: As soon as an order line is found that requires a purchase, the program sets the output flag and exits. This is efficient and reflects the business requirement: any single purchase-eligible line is sufficient to trigger the process.
- **Support for Extended Item Attributes**: From v6.30, additional fields related to lumber assortment are included in the call to `VL710R`. This supports more complex item determination logic.
- **Backward Compatibility**: The code is annotated with version and change history, making it easier to track enhancements, especially those related to item master extensions and price group logic.
- **Separation of Concerns**: The program delegates price group and item type logic to `VL710R`, keeping this program focused on orchestration and decision-making.

## File Key Definitions

- **Order Line Key** (`fodtl1_key`): Composed of company, order number, and suffix.
- **Item Master Key** (`vvarl1_key`): Composed of company and item number.

## Notable Conventions

- **Change Log and Comments**: The top of the source includes a detailed change log, with references to specific business or technical enhancements.
- **Norwegian Variable Names**: Many variable and comment names are in Norwegian, reflecting the business context (e.g., `bestillinger` = orders, `varer` = items, `ordre` = order).
- **Use of *INZSR**: All initialization (including key list definitions and parameter list setup) is done in the initialization subroutine for clarity and maintainability.

## Interactions

- **Upstream**: Invoked by a controlling program, passing order context and receiving the purchase flag.
- **Downstream**: Calls `VL710R` for item/price group logic; reads from order line and item master files.

## Summary Table

| File/Program | Purpose                          | Key Fields                    |
|--------------|----------------------------------|-------------------------------|
| fodtl1       | Sales order lines                | p_firm, p_numm, p_suff        |
| vvarl1       | Item master                      | p_firm, fdvare                |
| vvlel1       | Lumber assortment (if used)      | p_firm, fdvare (extended)     |
| VL710R       | Price group, item type retrieval | See call parameters           |

---

## Key Points for New Developers

- The main task is to flag orders that require purchasing actions based on their line items.
- All business logic for price group and item type is centralized in VL710R.
- The output (`p_best`) is a simple flag: '1' if purchase is required, '0' otherwise.
- The codebase is heavily annotated for traceability and future enhancements.

If you need to extend this program, pay special attention to the interactions with VL710R and the handling of new item attributes, especially those related to assortment (lumber, etc.). Always update the change log at the top of the source with any significant modifications.