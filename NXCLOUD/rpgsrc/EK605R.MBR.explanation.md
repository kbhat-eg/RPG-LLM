# Program Overview

This RPG (Report Program Generator) source code is for an IBM i (AS/400) system. The program is called `EK605R`, and its main purpose is to process customer bonus information and print customer letters, either summarized or detailed. The code is written in traditional (fixed-format) RPG IV (ILE RPG). It interacts with several physical files, prints reports, and processes business logic around customer bonus calculations.

## High-Level Structure

- **Header Section**: Contains compiler options and history of changes (with codes like 6.10, 6.20, etc.).
- **File Declarations**: Declares the files used for input and output.
- **Data Definitions**: Declares parameters, key fields, and work variables.
- **Main Logic**: Contains the main program cycle, which calls subroutines for processing.
- **Subroutines**: For handling customers, bonus calculations, text fetching, pagination, and initialization.

---

## Key Parts Explained

### 1. **Header Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- Sets compilation options: no debug IO, date edit format is day-month-year.

---

### 2. **File Declarations**

```rpg
fekbti1    if   e           k disk    rename(ekbtst:ekbti1r)
fekboic    if   e           k disk    rename(ekbost:ekboicr)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
fvbotl1    if   e           k disk    rename(vbotpfr:vbotl1r)
fek605p    o    e             printer oflind(*in30)
```
- Input files: `ekbti1`, `ekboic`, `rkunl1`, `vbotl1` (all renamed for internal use).
- Output file: `ek605p` (printer file), with overflow indicator `*in30`.

---

### 3. **Data Definitions**

- **Parameters**: Passed to the program (e.g., `p_paar` for year, `p_boty` for bonus type, `p_alt1` for alternative/detailed flag, `p_kund` for customer number).
- **Flags**: e.g., `b_bonu`, `b_kund` – on/off indicators.
- **Key fields**: For building file access keys.
- **Work variables**: For current firm, bonus totals, customer info, etc.

---

### 4. **Initialization Subroutine (`*inzsr`)**

- Receives program parameters via a parameter list (`plist`).
- Builds key lists for file operations.
- Loads firm code from a user space.

---

### 5. **Main Processing Flow**

```rpg
c                   eval      b_bonu = *off
c                   eval      a1aarr = p_paar
c                   eval      t1subg = 0
c                   eval      t1subn = 0
c                   exsr      kal_kund
c                   eval      *inlr = *on
c                   return
```
- Resets bonus flag.
- Sets heading variables.
- Clears accumulators for bonus and base amounts.
- Calls the main subroutine to process customers (`kal_kund`).
- Ends program.

---

### 6. **Main Subroutine: Customer Bonus Calculation (`kal_kund`)**

- Clears/copies work variables.
- Calls `finn_ktext` (finds and loads customer text info).
- Produces heading and detail lines depending on parameters.
- Reads base bonus records (`ekbti1`).
- Filters by bonus type if specified.
- Calls `finn_btext` for bonus type text.
- Accumulates totals for the customer and bonus.
- Writes detail lines (`d1det`).
- Handles page overflow via `xovrfl`.
- If detailed, reads and prints sublevel data via `kal_bgrl`.
- Writes total line (`t1tot`) if there was any bonus data.

---

### 7. **Detailed Bonus Subroutine (`kal_bgrl`)**

- Reads detailed bonus records (`ekboic`) for the customer and bonus type.
- Extracts and checks date ranges (6.21 enhancement for date interval check).
- Writes detailed lines (`d2det`) if the year in record matches the parameter.
- Handles page overflow.

---

### 8. **Supporting Subroutines**

#### - **finn_ktext**
  - Reads and loads customer name and address from `rkunl1`.
  - Sets `b_kund` flag for printing heading.

#### - **finn_btext**
  - Fetches description for the bonus type from `vbotl1`.

#### - **xovrfl**
  - Handles page overflow: writes appropriate headings when a new page is started.

---

## Key Indicators and Usages

- **Overflow (`*in30`)**: Triggers a new page in report output.
- **Subroutines (`begsr`, `endsr`)**: All major logic is modularized for clarity and reuse.
- **Record Navigation (`setll`, `reade`)**: Sequentially reads records with keys.
- **Conditional logic**: Filters records on bonus type, date ranges, optional details, etc.
- **Chaining (`chain`)**: Direct fetches by key (used for master-detail relationships).
- **Goto/Tags**: Occasionally used to jump within a subroutine—common in older RPG code.

---

## Comments and Documentation

- The code is heavily documented with change logs and comments (in Norwegian) explaining enhancements.
- All business logic (e.g., when to include details, how to interpret bonus records) is clearly commented.
- Variable names are mostly abbreviations of Norwegian business terms (e.g., kunde = customer, bonus, grunnlag = base/ground).

---

## Summary

- **Purpose**: Generate customer bonus reports, with optional detail lines, for a given year, customer, and/or bonus type.
- **Inputs**: Customer number, year, detail flag, bonus type.
- **Outputs**: Printed summary and/or detail reports (printer file).
- **Files Accessed**: Customer master, bonus master, bonus type text, detailed bonus breakdowns.

This code provides a good example of a classic batch RPG reporting program with file-based master/detail processing, parameter-driven logic, and advanced print formatting.