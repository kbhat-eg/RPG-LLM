# Overview  
This IBM ILE RPG program (JX500R) displays a subfile of supplier‐price records for a given item (`vare`).  It lets the user:  
- “Page” up/down through suppliers’ prices  
- Select one price (F12=Exit)  
- Optionally filter on “prioritized suppliers” (F23 in newer builds)  

# 1. Files & Data Structures  
- **Physical files**  
  - `JXPRL1` (renamed `JVPRL1R`): item‐price records  
  - `JXLEL1` (renamed `JLEVL1R`): supplier master for names  
  - `JXLELR` (renamed `JVLELRR`): supplier‐item history (to detect expired suppliers)  
  - `JXVARL1` (renamed `JVARL1R`): item master (for item text)  
- **Workstation file**  
  - `FJX500D` SDA display maps:  
    - B2CTL (control record)  
    - B1SFL (subfile record)  
    - B2CMD (blank “function‐key” screen)  

- **Parameter DS** (V7.02+):  
  ```  
  D inParm       DS  80  
    hirec           80  
      hilage         2 0 overlay(hirec)  
      hivare        15 0 overlay(hirec:3)  

  D outParm      DS  80  
    horec           80  
      hopr1l         6 0 overlay(horec)  
      hopr2l         6 0 overlay(horec:7)  
      hopr3l         6 0 overlay(horec:13)  
  ```  
  Used to pass prioritized‐supplier list into the program via a call to `CO402R`.

# 2. Control Variables  
- **Subfile paging**  
  - `w_fcrn`: first record‐number on current page  
  - `w_spge`: page size (constant = 8 lines)  
  - `w_srrn`: relative record‐number within subfile  
  - `w_sfrn`, `w_ssrn`: first/last record‐number on last page  
- **Cursor & selection**  
  - F‐key indicators:  
    - `*IN10` = page‐forward  
    - `*IN11` = page‐back  
    - `*IN21` = Home (toggles cursor visibility)  
    - `*IN40` = “prioritized” filter toggle (newer releases)  
  - `b_valg_ok` = *ON when user has picked a line  
- **Current item & supplier**  
  - `w_vare` = item number from parameter  
  - `jvprl1_ldor` = supplier key for file reads  

# 3. Main Logic Flow  

1. **Initialization** (`*INZSR`)  
   - Read incoming parameters: item, supplier, last‐known price & (optionally) date.  
   - Call `CO402R` to retrieve prioritized‐supplier flags into the inParm/outParm DS.  
   - Position file `JVPRL1R` on `w_vare` & highest/starting `ldor`.  
   - Call `crt_subfile` to build the first page.  

2. **Display Loop**  
   ```
   b2taga:
     WRITE B2CMD         ← Show blank F‐key help
   b2tagb:
     EXSR dsp_subfile    ← Display subfile & read user input
     SELECT
       *InKC or *InKL → Exit (goto avslutt)
       *InKE          → EXSR forny (refresh) then loop
       *InKG (F23)    → if prioritized‐mode available: EXSR vis_prio + forny
       *In10          → EXSR crt_subfile (page down)
       *In11          → EXSR bck_subfile (page up)
       *In21          → HOME: toggle cursor (*IN22 = *ON)  
     IF b2ldor<>0 THEN → If user entered a supplier in control record  
       EXSR posisjoner → reposition & rebuild subfile  
     ELSE  
       EXSR subfile    → process line‐selection  
       IF b_valg_ok=*ON → Exit  
     ENDIF  
     GOTO b2taga  
   avslutt:
     *INLR = *ON; RETURN
   ```

# 4. Subroutines  

## 4.1 forny  
Refresh subfile starting at last displayed record.  
- Chains on `b1sfl` to get its `b1ldor`  
- `SETLL` to that supplier in `JVPRL1R`  
- Calls `clr_subfile` & `crt_subfile`

## 4.2 posisjoner  
Position file based on user‐entered supplier in the control record B2CTL (`b2ldor`):  
- `SETLL` to that supplier key in `JVPRL1R`  
- Clears & rebuilds the subfile  
- Resets `b2ldor`

## 4.3 subfile  
Loops through the currently displayed page (`READC` on B1SFL up to `w_ssrn`), checks if the user marked any line (`b1valg=1`), and if so moves that supplier & price into output parms and sets `b_valg_ok`.

## 4.4 clr_subfile  
- Sets `*IN14=*ON` then WRITEs B2CTL (this hides the detail‐lines & clears them in DDS)  
- Resets `w_srrn, w_sfrn, w_ssrn, w_spge`

## 4.5 crt_subfile  
Fills the subfile from the current file position:  
1. Increment page end marker: `w_spge += 8`  
2. `DOU w_srrn = w_spge`  
3. Read next record from `JVPRL1R`  
   - **Stop** when item changes or EOF  
   - **(Opt)** If prioritized‐mode ON, skip non‐prioritized suppliers  
   - **(Opt)** If supplier expired or price‐date expired, skip  
4. For each valid record:  
   - `w_srrn += 1`  
   - Set subfile fields: `b1ldor, b1lnav` (chain to supplier master), `b1pris, b1crdo, b1gdat`  
   - Mark local vs remote creation (`b1rkod = 'L'`)  
   - WRITE B1SFL  
5. After loop set `w_ssrn = w_srrn`, `w_virn = w_sfrn+1`

## 4.6 bck_subfile  
Pages backward by setting file pointer to just above the first line of the current page (`SETGT` + `READP`) and then calls `clr_subfile` + `crt_subfile`.

## 4.7 dsp_subfile  
- Turns on `*IN12` if there is at least one record to display  
- `EXFMT B2CTL` to show subfile and get function‐key input  
- Captures `d_fcrn` (first‐record‐number) into `w_fcrn`

## 4.8 vis_prio (V7.02+)  
Toggles the “prioritized supplier” filter (indicator *IN40) and resets the subfile so `crt_subfile` will skip non‐priorities.

# 5. Key Points & Extensions  
- **Prioritized suppliers** (new in 7.02): fetched by calling external program `CO402R` into the inParm/outParm DS, then used to skip records in `crt_subfile`.  
- **Expired suppliers/prices** (V6.32–6.33): chain to `JVLELRR` and compare date fields to skip if expired.  
- **Trelast logic** (V6.33): detect special “undervare” & fetch alternate NOBB‐number via SQL into a display field.  
- **Wide‐screen support** (V7.01) and enhanced DDS map only affects the B2CTL/B1SFL definitions.  

This modular subfile approach provides fast paging, line‐selection, and dynamic filtering without re‐reading all records on each keystroke.