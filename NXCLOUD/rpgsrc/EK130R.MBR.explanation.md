# RPG Source Code Explanation  
## Overview  
This ILE RPG program, titled `ASOFAK: Vedlikehold av avrundingsregler`, is for maintaining rounding rules (avrundingsregler) in a business system. The program (`EK130R`) manages parameters related to the crediting of bonuses (Parametre for kreditering av bonus). It interacts with several files and the workstation (a display) to allow the user to query and update bonus-related parameter records.

---

## File Declarations

- **File Definitions (`F-Specs`):**
  - `vvarl1`, `votyl1`, `vbotl1`: Input files for item, order type, and bonus type lookups, respectively.
  - `ebkrlu`, `ebkrl1`: Files for updating and reading bonus parameter records.
  - `ek130d`: Workstation file for display interaction.

---

## Data Declarations

- **LDA (Local Data Area):** User, firm number, and other session-specific data are pulled from the LDA.
- **Key Variables:** Temporary variables to store values for record lookups.
- **Working Variables:** e.g., `w_firm` holds the current firm number.

---

## Mainline Logic

### 1. **Initialization (`*inzsr`)**
- Sets up key lists (`KLIST`) for various files based on the firm and relevant fields.
- Firm number (`w_firm`) is loaded from LDA.

### 2. **Main Input Loop**
- **a. Retrieve Last Run Data:**  
  - Clears screen fields (`a1kbtx`, etc.).
  - Attempts to CHAIN (lookup) the last parameter record (`ebkrl1`).  
  - If found, populates corresponding display/input fields; if not, sets them to default.

- **b. Display Panel (`exfmt a1bld`):**  
  - Shows the entry screen and waits for user action.

- **c. User Function Keys:**  
  - **F3 (=Avslutt):** Exit the program (goto `xslutt`).
  - **F4 (=Spørring):** Trigger the inquiry subroutine (`spørring`) and redisplay the screen.

- **d. Error Flag Reset:**  
  - Resets various indicator fields (`*in31` to `*in35`), which are used to indicate errors.

### 3. **Field Validations**  
  The program checks in sequence for each key parameter:
  - **Bonus Type (`a1kbot`):**  
    - Must not be blank; must exist in bonus type file.
    - If invalid, sets error indicator and repeats the screen.
  - **Order Type (`a1koty`):**
    - Must not be blank; must exist in order type file.
    - If invalid, sets error indicator and repeats the screen.
  - **Item Number (`a1kvar`):**
    - Must not be blank; must exist in the item master.
    - If invalid, sets error indicator and repeats the screen.
  - **Period (`a1kpfr`):**
    - Must not be zero.
    - If invalid, sets error indicator and repeats the screen.
  - **Period Interval (`a1kpti`):**
    - Must not be zero and period from must not be greater than period interval.
    - If invalid, sets error indicator and repeats the screen.

### 4. **Update or Create Parameter Record**
- **CHAIN**s to the parameter file (`ebkrlur`) to check if the record exists.
- Updates fields with user input, timestamps, and user info.
- **If found:** Updates the record.
- **If not found:** Writes (inserts) a new record.

### 5. **Program End (`xslutt`)**
- Sets last record indicator (`*inlr`) to on and returns (ends the program).

---

## Subroutines

### 1. **Inquiry (`spørring`)**
Used when the user presses F4 for lookup help on fields. Based on the field being queried (`w_afld`), the program:
- Calls a specific inquiry program (`VA565R`, `VA550R`, or `VV500R`) for bonus type, order type, or item number.
- Passes relevant keys and receives values for display.
- Leaves the subroutine immediately after the call (no fall-through).

### 2. **Initialization (`*inzsr`)**
As detailed earlier, sets up key lists for use in CHAIN and WRITE operations and loads the firm number from LDA.

---

## Error and Field Indicators

- `*in31` ... `*in35`: Error indicators for field validation; used for screen feedback.
- `*inkc`, `*inkl`: Function key indicators for F3 (exit).
- `*inkd`: Function key indicator for F4 (lookup/help).

---

## File Key Lists

- For each file, a `KLIST` is defined to group key fields, mostly using `w_firm` and the relevant code for that file (bonus type, order type, or item number).

---

## Summary

This RPG program lets users maintain and validate bonus rounding parameter records, ensuring all keys are valid and up-to-date. It provides inquiry (lookup help), error feedback to the interactive panel, and creates or updates records based on what the user enters and what already exists in the database. The code is structured with clear separation between data validation, file access, display management, and special function handling.