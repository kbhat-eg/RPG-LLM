# RPG Program Explanation: FW722R  
*(ASOFAK - Vendor Item Master creation, Sørbø)*

---

## Overview

This RPG/400 (fixed-form) program is designed for the ASOFAK system to generate a vendor item master record (leverandør vareregister) for a vendor (leverandør), specifically for Sørbø.

- **Input**: A file containing item data (flvwpf)
- **Output**: A vendor item master file (flvapf)
- **Supplemental File**: fenk1 (item unit conversion)
- **Parameters**: Firm number (`p_firm`), Vendor number (`p_ldor`)

---

## File Declarations

```rpg
fflvwpf    if   e           k disk    // Input file: vendor-item data
ffenkl1    if   e           k disk    rename(fenkpfr:fenkl1r)  // Item unit conversion lookup
fflvapf    o  a e             disk    // Output file: vendor item master
```

---

## Data Structures

### Local Data Area

```rpg
d                uds
d l_user                911    920
```
- Retrieves the user profile/jobs from the user data area.

### Input Record Data Structure

A single field `d_inpu` overlays the input record, and subfields "overlay" segments of it for easier access.

| Subfield   | Length   | Overlay Position    | Purpose            |
|------------|----------|---------------------|--------------------|
| d_ekod     | 1        | 1                   | Change code        |
| d_vare     | 15       | 2                   | Item number        |
| d_tek1     | 35       | 17                  | Item text/desc     |
| d_eann     | 13       | 52                  | EAN number         |
| d_ldor     | 6        | 65                  | Vendor no.         |
| d_dato     | 6        | 71                  | Change date        |
| d_enh1     | 4        | 77                  | Unit               |
| d_sapr     | 9,2      | 81                  | Sales price        |
| d_ipny     | 9,2      | 90                  | Purchase price     |
| d_enh2     | 4        | 99                  | Unit 2             |
| d_gpny     | 9,2      | 103                 | Sales price 2      |
| d_bmen     | 11       | 112                 | Order quantity     |

---

## Key/Working Variables

```rpg
d p_firm          s              3  0   // Firm parameter
d p_ldor          s              6  0   // Vendor parameter
d fenkl1_enhf     s                   like(feenhf)  // Unit key for conversion
d w_firm          s              3  0   // Internal firm variable
```

---

## Program Flow

### 1. **Initialization**

- The `*inzsr` subroutine (called at program start) retrieves passed parameters (firm, vendor) and stores them.
- Prepares a key list for the item-unit conversion lookup.

### 2. **Main Logic**

#### Read/Loop through Input File

```rpg
c                   read      flvwpf                                 90
c                   dow       *in90 = *off
    ...
c                   read      flvwpf                                 90
c                   enddo
```

- Reads each record from the input file (`flvwpf`).
- Loops until EOF (indicator 90 on).

#### Process Each Record

- Overlays the input record buffer into the defined data structure.
- Maps/Assigns data from input to output fields, with some conversions/defaults.
- Some fields (`fwtek2`, `fwbmen`, etc) are set with static values or blank.

#### Unit Conversion Lookup

- If the unit exists in the fenk1 file (via key), replace the output unit from the lookup.

#### Date and Numeric Conversions

- Converts and assigns change date (`d_dato`) if present.
- Handles order quantity if present.

#### Tracking/Audit Info (added in version 6.10)

- Adds timestamps and user info to the output record for auditability.

#### Write Output

- Writes the transformed record to the vendor item master file (`flvapf`).

### 3. **Finalization**

- Sets LR (*inlr) to on, ends program.

---

## Subroutines

### `*inzsr` (Initialization Subroutine)

- Handles parameter retrieval.
- Sets up key list for item unit conversion.
- Initializes internal variables.

---

## Comments/Headers

- The program is well-commented (in Norwegian), includes title, description, references, and change log.

---

## Takeaways for Developers

- **This program is a batch data transformation:** reads records from one file, transforms and possibly enriches them (e.g., unit conversion, audit fields), and writes to another file.
- **Data overlays are used heavily:** Makes extracting pieces of flat records easier.
- **Modular parameterization:** Program is designed to be reused for different firms/vendors by passing parameters.
- **Handles some data validation/conversion:** e.g., checks for blank/numeric dates and quantities.
- **Tracking/Audit logic** added in later versions.

---

### If onboarding to this program:

- Focus on understanding the data structures and file layouts, as these define the mapping/transformation.
- The input and output files’ DDS/field layouts are essential for further development or troubleshooting.
- Watch for Norwegian field names and comments; translate as needed.
- If extending, consider modernizing to RPG IV/free format for maintainability.