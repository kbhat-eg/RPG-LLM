# VG560R Program Documentation

## Overview

**VG560R** is an interactive RPG program used in the ASOFAK system for managing assortments (sortiment) at the "undergruppe" (subgroup) level. The program allows users to browse, position, and add assortment lines (varesortiment) within a hierarchical group structure (overgruppe, hovedgruppe, undergruppe). The main interface is a subfile-based display, supporting paging, positioning, and item creation.

### Key Business Concepts

- **Overgruppe/Hovedgruppe/Undergruppe**: Hierarchical product groupings (supergroup/main group/subgroup).
- **Sortiment**: Assortment; a collection of products/items grouped for a specific purpose.
- **Varesortiment-linje**: Line in the assortment, representing a specific subgroup.
- **Lager**: Warehouse/location (added in version 6.20).

---

## File Usage and Relationships

The program interacts with multiple physical and logical files, each representing different business entities:

- **vugrpfr**: Product group master (logical files vugrl1, vugrl2, vugrl3, vugrl4 for different group levels or queries).
- **vvarpfr**: Assortment master (vvarla).
- **vsdtpfr**: Assortment detail (vsdtl1 for existence check, vsdtlur for insert).
- **rlevpfr**: Supplier master (rlevl1).
- **vg560d**: Display file with subfiles (B1SFL, B2CTL, B2CMD).

These files are accessed via keyed access and are often used in conjunction with each other to validate and create assortment lines.

---

## Screen and Indicator Conventions

- **Subfile (B1SFL)**: Main list of subgroups available for addition to the assortment.
- **B2CTL**: Subfile control record.
- **B2CMD**: Command key screen.

**Indicators** are used extensively for screen control, error handling, and subfile management:

- *LR*: End program
- *IN10/11*: Paging (Roll/Rolldown)
- *IN12/13/14/15*: Subfile display and management
- *IN21/22*: Cursor positioning
- *IN30*: Field protection
- 31-79: Error and warning indicators
- 80-99: Work indicators

---

## Program Flow and Structure

### Initialization (`*inzsr`)

- Receives parameters: company (firm), assortment, warehouse, supplier.
- Initializes keys for various group levels and for assortment details.
- Retrieves supplier name for display.
- Positions group files at the start (zero keys).
- Calls `crt_subfile` to populate the initial subfile page.

### Main Loop

1. **b2taga**: Displays command key screen (`B2CMD`).
2. **b2tagb**: Handles subfile display and user input.
   - Calls `dsp_subfile` to display the subfile.
   - Processes function keys:
     - *F3/F12*: Exit
     - *F5*: Refresh subfile (`forny`)
     - *Roll Up/Down*: Page navigation (`crt_subfile`, `bck_subfile`)
     - *Home*: Cursor positioning
   - If positioning fields are entered, calls `posisjoner`.
   - Calls `subfile` to process subfile entries (additions, module calls).

3. **avslutt**: Sets *INLR to end the program.

---

## Subroutines and Their Roles

### Subfile Management

- **forny**: Refreshes the subfile based on the current position.
- **posisjoner**: Positions the subfile to a specific group or description based on input fields.
- **subfile**: Processes subfile records, handling user actions such as adding to the assortment or calling modules.
- **clr_subfile**: Clears the subfile display.
- **crt_subfile**: Populates the subfile with the next page of records from the group files.
- **bck_subfile**: Pages the subfile backward.
- **dsp_subfile**: Handles the display logic for the subfile and related screens.

### Assortment Line Creation

- **opprett**: Adds a new line to the assortment if it does not already exist, setting creation and update timestamps and user info.

---

## Key Design Decisions and Patterns

- **Subfile Paging**: The program uses a fixed page size (`c_sfil`=10) and maintains counters (`w_srrn`, `w_spge`, etc.) to handle paging and navigation.
- **Multi-level Group Navigation**: The code supports positioning and navigation at multiple group levels (overgruppe, hovedgruppe, undergruppe, description) using separate logical files and key lists.
- **Data Integrity**: Before creating an assortment line, the program checks for existence to prevent duplicates.
- **Screen Feedback**: Uses the display feedback data structure (`dspfbk`) to track cursor position and user actions.
- **Parameter Passing**: Calls to related modules (e.g., `VV560R`) pass all relevant context (firm, assortment, warehouse, supplier, group keys).

---

## Notable Business Logic

- **Assortment Inclusion**: Users can add a subgroup to an assortment by selecting it in the subfile (`b1valg = 1`). The program validates existence and writes a new record to the assortment detail file.
- **Module Integration**: Selecting `b1valg = 7` calls another program (`VV560R`) for further processing, passing all necessary context.
- **Supplier Lookup**: On initialization, the supplier name is fetched for display using the supplier number.

---

## Data Structure and Variable Highlights

- **Key Fields**: Variables like `vugrl1_uogr`, `vugrl1_uhgr`, etc., are used as keys for navigating group files.
- **Subfile Variables**: `w_fcrn`, `w_srrn`, `w_ssrn`, etc., manage subfile record numbers and page navigation.
- **Parameter Variables**: `p_firm`, `p_vsor`, `p_ldor`, `p_lage` hold incoming parameter values for company, assortment, supplier, and warehouse.

---

## Interactions with Other Modules

- **VV560R**: Invoked from within the subfile to handle additional module logic related to the selected group.
- **Logical Files**: The program relies heavily on logical file structure for efficient keyed access and flexible navigation.

---

## Version History and Maintenance

- **6.10**: Added tracking information (timestamps, user IDs) on assortment line creation.
- **6.20**: Extended to include warehouse (`lage`) in assortment logic.

---

## Summary Table: Key Subroutines

| Subroutine     | Purpose                                                         |
|----------------|-----------------------------------------------------------------|
| forny          | Refreshes subfile at current position                           |
| posisjoner     | Positions subfile based on user-specified group keys/descriptions|
| subfile        | Handles user actions in subfile (add, module call)              |
| clr_subfile    | Clears the subfile display                                      |
| crt_subfile    | Populates next page of subfile                                  |
| bck_subfile    | Pages subfile backward                                          |
| dsp_subfile    | Manages subfile display and feedback                            |
| opprett        | Creates a new assortment line if not already present            |

---

## Important Conventions

- **Indicator Usage**: Strict separation of indicators for screen control, error messaging, and work tracking.
- **Key Lists**: All file access is via explicitly defined key lists for clarity and consistency.
- **Subfile Control**: Handles all aspects of subfile management in discrete, well-named subroutines.
- **Parameter Passing**: All business context is passed explicitly between programs and subroutines.

---

## Integration Points

- **Display File (vg560d)**: All user interaction is via the display file, which must be kept in sync with the program logic.
- **Assortment and Group Files**: The program expects specific logical file structures and key sequences; changes to file definitions may require program adjustments.

---

## Conclusion

VG560R is a robust, modular program for managing assortment groupings at a detailed level, supporting efficient navigation, validation, and user-driven creation of assortment lines. Its design emphasizes clarity in file/key management, subfile control, and business rule enforcement, making it maintainable and extensible within the ASOFAK system.