# RPG Program Explanation: RL632R – Print of Aged Balance List (Vendors)

## 1. **Overview**
This RPG program (`RL632R`) generates a printout of a vendor aged balance list ("aldersfordelt saldoliste - leverandører"). The report details vendor balances distributed by aging buckets, with options for sub-totals by department or category, and extra features for contact/phone info.  
It supports advanced output (PDF generation, XML creation for further processing), and has significant customization options via parameters and data structures.

---

## 2. **File Declarations**
```rpg
frlw1l1    if   e           k disk    rename(rlw1pfr:rlw1l1r)
fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)

frl632p    o    e             printer oflind(*in30)
pdf  f                                     usropn
```
- **rlw1l1, afirl1, raa3l1:** Input files (vendor, company, etc.), renamed record formats.
- **rl632p:** Output printer file, with programmatic open (`usropn`) and overflow indicator (`*in30`).

---

## 3. **Key Data Structures & Variables**
### a. **Main Working Data Structure**
```rpg
d                 ds
d wkwrec                  2    192
d  wkfirm                        3  0 overlay(wkwrec)
d  wkkund                        6  0 overlay(wkwrec:4)
...
d  wksald                       11  2 overlay(wkwrec:81)
...
d  wkinka                       11  2 overlay(wkwrec:158)
d  wkkjop                       11  2 overlay(wkwrec:169)
d  wkotid                        6  0 overlay(wkwrec:180)
```
- **wkwrec**: Buffer for a full vendor record, with fields for company, customer, name, phone, balance (`wksald`), purchase values, etc.,
  overlaid for convenient field access.

### b. **Summation Variables**
- **bbelX, tbelX, bel[1..6]:** Buckets for aged balance (1–6), for group (break) and grand totals.
- **bkjop, tkjop:** Purchase amounts (year-to-date).
- **bkrtid, tkrtid:** Average credit time for subgroup and total.
- **msal, nsal, usal:** Counters for positive, negative, and zero balances.
- **kksant, tksant:** Vendor counters.

### c. **Parameter and Print Option Variables**
- **pavds, pkats, pkper, ptlf, psald, pkjop, psort:** Control report options (sum per department/category, contact, phone, balance-only, etc.), impacts layout and content.
- **Various text variables** for on-report descriptions.

### d. **PDF/XML Integration Variables (suffix `pdf`):**
- Used for advanced spool handling, output file referencing, job info, and XML meta-tagging (meta info like `p_taggX` and descriptions for digital archiving).

---

## 4. **Main Logic Overview**

### a. **Initialization (`*INZSR`)**
- Opens the printer file.
- Reads company information (chains to `afirl1`, `raa3l1` by key).
- Sets up default field values, resolves text for print options, and writes initial headers.
  
### b. **Main Processing Loop**
```rpg
nyles tag
   read rlw1l1 99
   if *in99 = *on
      *inlr = *on
      goto slutt
   endif
...
goto nyles
```
- **Iterates over vendor records (rlw1l1):**
  - Each record is read into the working buffer (`wkwrec`).
  - Vendor is categorized based on balance (`wksald`): positive (`msal`), zero (`usal`), negative (`nsal`).

- **Break/BruDD handling:**
  - If the vendor group (like department/category) changes, triggers the `brudd` subroutine for subtotaling and page-break logic.

- **Updates aged balance buckets, totals, counts, and writes details.**
  - Each vendor line is written (`write d101`).
  - Optionally prints contact details based on parameters.

### c. **End-of-File Processing (`slutt tag` and after loop)**
- Finalizes any remaining group breaks and grand totals.
- Calculates averages (credit time) and writes final summary lines (`h101`, `t101`, `t102`).

- **PDF/XML Output (if selected):**
  - Locates the current spool file (`spoolnbr` subroutine).
  - Calls external programs to generate XML/PDF and possibly open PDF in a browser.

---

## 5. **Subroutines**

### a. **brudd – Break Handling**
Handles subgroup totals (by department, category, etc.):
- Calls external programs for text descriptions (e.g., `RS707R`, `RS714R`).
- Writes subtotal lines, new page headers.
- Resets group accumulator fields.

### b. **nyside – New Page Handling**
- If printer file overflow indicator (`*IN30`) set, writes page headers and resets the indicator.

### c. **spoolnbr/pdf/xml_create/pdf_preview**
- For PDF output: finds the spool file, prepares XML and metadata, calls external programs to process output, and launches the viewer if needed.

---

## 6. **Parameter Handling / Customization**

The program uses various parameters (either from user input or program call) to control output:
- **brsum**: Trigger subgroup subtotal logic.
- **pkper, ptlf**: Contact person / phone output.
- **psald**: Show only vendors with balance.
- **pavds, pkats**: Department/category subtotals.
- **psort**: Sort order (number or alphabetic).
- **pkjop**: Include vendors with purchases this year.

Text labels are set up in the initialization routine based on these parameters, affecting both layout and which data is output.

---

## 7. **Update/Change Log (at top as comments)**
The top block documents major changes, versions, and enhancements (for maintenance and traceability).

---

## 8. **Key Points for Onboarding**
- **File structure**: Know the formats and fields in vendor/company master files.
- **Subroutine-driven**: "brudd" for breaks, "nyside" for page handling, modularized for PDF/XML.
- **Extensive use of overlays**: Data structures overlay a record buffer for dynamic access to fields.
- **Parameter-driven**: Output is highly customizable.
- **Modern features**: PDF integration, XML metadata, modularity for printing/archiving.

---

## 9. **Summary**

This program is a robust, customizable reporting tool for vendor balance aging, supporting both traditional print and advanced digital output (PDF/XML), with flexible grouping/subtotaling options and strong integration with external processing modules.  
Understanding it requires familiarity with old-style RPG, overlayed data structures, and external program calls, but it is well modularized and documented.

---

**Tip for new developers:**  
- Start by tracing the main loop for record reading and subgroup handling.
- Check parameter variable initialization in `*INZSR`.
- Review the `brudd` subroutine for how breaks and subtotals are managed.
- Understand integration points for digital output (PDF/XML).  
- The program is highly parameter-driven—much of its logic depends on configuration at runtime!