# RPG Program Explanation: ASSHOP – Changing Customer Number

This RPG (Report Program Generator) source code is for a program called `BO790R`, which is part of the `ASSHOP` system. The functionality of this program is to change (replace) a customer number in different files/tables within the system. The code handles both invoice customers and product customers, as well as updating status records. Below is a breakdown and explanation of the code for onboarding developers.

---

## File Declarations

```rpg
fbohele    uf   e           k disk    rename(bohepfr:boheler)
fbohelf    uf   e           k disk    rename(bohepfr:bohelfr)
fbstslu    uf   e           k disk    rename(bstspfr:bstslur)
```
These lines declare three physical files to be used in the program:
- **bohele**: Invoice customer header file (renamed as boheler in the program)
- **bohelf**: Product customer header file (renamed as bohelfr)
- **bstslu**: Status file (renamed as bstslur)

---

## Parameter Definitions

```rpg
d p_firm          s                   like(bofirm)
d p_gkun          s                   like(bokund)
d p_kund          s                   like(bokund)
```
Parameters:
- `p_firm`: Firm/company identifier
- `p_gkun`: Old customer number to be changed
- `p_kund`: New customer number to be set

---

## Local Data Area (LDA)

```rpg
6.10 d                uds
6.10 d l_user                911    920
```
- Uses the user portion (`l_user`) of the LDA (positions 911–920) to track who performed the update.

---

## Key Variables

```rpg
d bohele_kund     s                   like(bokund)
d bohelf_kund     s                   like(bokund)
```
- Variables used in keyed access for invoice and product customer files.

---

## Working Variables

```rpg
d w_firm          s                   like(bofirm)
d w_gkun          s                   like(bokund)
```
- Working copies for firm and old customer number.

---

## Main Program Logic

### 1. Load Parameters

```rpg
c                   eval      w_firm = p_firm
c                   eval      w_gkun = p_gkun
```
- Initialize working variables from parameters.

---

### 2. Update Invoice Customer Header (`bohele`)

```rpg
c                   eval      bohele_kund = p_gkun
c     bohele_key    setll     bohele
c     bohele_key    reade     bohele                                 90
c                   dow       *in90 = *off
c                   eval      bokund = p_kund
6.10 c                   time                    boedat
6.10 c                   time                    boetim
6.10 c                   eval      boeusr = l_user
c                   update    boheler
c     bohele_key    reade     bohele                                 90
c                   enddo
```
- For all records in `bohele` (invoice customer header) where firm = `w_firm` and customer = old customer number:
    - Set the customer number (`bokund`) to the new value.
    - Set date (`boedat`), time (`boetim`), and user (`boeusr`) audit fields.
    - Update the record.

---

### 3. Update Product Customer Header (`bohelf`)

```rpg
c                   eval      bohelf_kund = p_gkun
c     bohelf_key    setll     bohelf
c     bohelf_key    reade     bohelf                                 90
c                   dow       *in90 = *off
c                   eval      bolkun = p_kund
6.10 c                   time                    boedat
6.10 c                   time                    boetim
6.10 c                   eval      boeusr = l_user
c                   update    bohelfr
c     bohelf_key    reade     bohelf                                 90
c                   enddo
```
- For all records in `bohelf` (product customer header) where firm = `w_firm` and customer = old customer number:
    - Update the customer number.
    - Audit the record with current date, time, and user.
    - Save the record.

---

### 4. Update Status (`bstslu`)

```rpg
c     key01         chain     bstslur                            90
c                   if        *in90 = *off
c                   if        baakun = p_gkun
c                   eval      baakun = p_kund
c                   endif
6.10 c                   time                    baaeda
6.10 c                   time                    baaeti
6.10 c                   eval      baaeus = l_user
c                   update    bstslur
c                   endif
```
- Using a key (key01, typically defined in initialization), locate the appropriate status record.
- If found and the customer number matches the old customer number, update it to the new one.
- Update audit fields.
- Save the record.

---

### 5. End Program

```rpg
c***                eval      *inlr = *on
c                   return
```
- Terminates the program and (if line was uncommented) would set the Last Record Indicator to release resources.

---

## Initialization Subroutine (`*inzsr`)

- Handles parameter list and composite keys set-up for file access:

```rpg
c     *entry        plist
c                   parm                    p_firm
c                   parm                    p_gkun
c                   parm                    p_kund

c     key01         klist
c                   kfld                    w_firm

c     bohele_key    klist
c                   kfld                    w_firm
c                   kfld                    bohele_kund

c     bohelf_key    klist
c                   kfld                    w_firm
c                   kfld                    bohelf_kund
```
- Sets up the parameter list and key lists for file access.

---

## Summary of the Workflow

1. The program is called with a firm, old customer number, and new customer number.
2. It updates all relevant records in the invoice and product customer header files, changing the customer number and recording audit information.
3. It updates the customer number in the status file if required, again recording audit info.
4. The process ensures that all occurrences of the old customer number are replaced with the new one across the key tables/files.
5. The use of audit fields ensures traceability for these changes.

---

### Code Comments and Audit

- Comments/documentation at the top provide release history and descriptions.
- Version 6.10 adds auditing for user, date, and time on updates.

---

## Important Variables

- **p_firm**: Company identifier (passed in)
- **p_gkun**: Old customer number (passed in)
- **p_kund**: New customer number (passed in)
- **l_user**: From LDA, used for auditing "who" made the change.

---

## Usage Scenario

Call this program when a customer's number needs to be changed across the system for a given firm/company. The program will update all necessary records and preserve a reliable audit trail.

---

### Additional Notes

- Proper error handling is minimal; the logic depends on indicators (`*IN90`) for status, so ensure the input parameters are valid.
- Resource release (`*INLR = *ON`) is commented out—verify calling context to decide if this should be activated.

---

This program is a classic example of batch master data update in IBM i (AS/400) environments.