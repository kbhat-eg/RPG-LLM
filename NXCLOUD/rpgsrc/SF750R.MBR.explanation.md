# RPG Code Explanation

## Overview

This RPG program, named **SF750R**, is part of the ASOFAK system and is designed to update sales statistics for an item when the reporting unit (statistical unit) changes. The main purpose is to recalculate and update statistical quantity fields (`sfanta`) based on a new reporting unit and its proper conversion factor.

---

## File Specifications

```rpg
fsstal2    if   e           k disk    rename(sstapfr:sstal2r)
fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
fsstal1    uf   e           k disk    rename(sstapfr:sstal1r)
```

- **sstal2**: Input file, keyed, external data, renamed from physical file `sstapfr`. Contains item statistics.
- **vvenl1**: Input file, keyed, external data, renamed from `vvenpfr`. Contains item/unit conversion factors.
- **sstal1**: Update file, keyed, external data, renamed from `sstapfr`. Used to update statistics records.

---

## Parameters

```rpg
d p_firm          s                   like(sffirm)
d p_vare          s                   like(sfvare)
d p_enhe          s                   like(sfenhe)
```
- **p_firm**: Company parameter from caller.
- **p_vare**: Item number.
- **p_enhe**: The new statistical reporting unit.

---

## Key and Work Variables

These variables are used to build composite keys for chained/retrieve operations and store fields for processing:

- **sstal2_vare, vvenl1_vare, vvenl1_enhe**: For keying into statistics and conversion files.
- **sstal1_paar, sstal1_binr, sstal1_line, sstal1_bida**: Key fields for updating records.
- **w_firm, w_omrs**: Work areas for company and conversion factor.

---

## Program Logic

### 1. Initialization: *INZSR

- Pulls program parameters into local variables `p_firm`, `p_vare`, and `p_enhe`.
- Sets up composite keys (KLIST) for accessing files.
- Assigns `w_firm` from `p_firm` (company code).

### 2. Main Program

#### a. Get the Conversion Factor for New Statistical Unit

```rpg
eval      vvenl1_vare = p_vare
eval      vvenl1_enhe = p_enhe
vvenl1_key chain     vvenl1   90
if        *in90 = *on or veomre = 0
  goto    avslutt
endif
eval      w_omrs = veomre
```
- Sets up item- and unit-specific key and retrieves the conversion factor (`veomre`) from `vvenl1`.
- If not found or zero, aborts processing.

#### b. Process All Statistics Records for the Item

1. **Initialize Key/Set Position:**

```rpg
eval      sstal2_vare = p_vare
sstal2_key setll     sstal2
sstal2_key reade     sstal2   90
dow       *in90 = *off
```
- Loops over all statistics records for the specified item.

2. **For Each Record, Check if Unit Differs**

```rpg
if        sfenhe <> p_enhe
```
- If the statistics record's unit is not the new reporting unit, continue.

3. **Get Conversion Factor for the Record's Unit**

```rpg
eval      vvenl1_enhe = sfenho
vvenl1_key chain     vvenl1   91
if        *in91 = *off and veomre <> 0
```
- Retrieves the conversion factor from `vvenl1` for the current unit (`sfenho`).

4. **Update the Record's Statistical Quantity**

```rpg
eval      sstal1_paar = sfpaar
eval      sstal1_binr = sfbinr
eval      sstal1_line = sfline
eval      sstal1_bida = sfbida
sstal1_key chain     sstal1r  91
if        *in91 = *off
  eval      sfenhe = p_enhe
  eval(h)   sfanta = sfanto * veomre / w_omrs
  update    sstal1r
endif
```
- Calculates the new quantity based on the conversion factor:
    - `sfanta = sfanto * veomre / w_omrs`
      - **sfanto**: Old quantity in old unit.
      - **veomre**: Conversion for old unit.
      - **w_omrs**: Conversion for new unit.
- Updates the statistics record (`sstal1r`) with the new unit and recalculated quantity.

5. **Read the Next Record**

```rpg
sstal2_key reade     sstal2   90
enddo
```
- Continues until there are no more records.

---

### 3. Program Exit

```rpg
avslutt tag
eval      *inlr = *on
return
```
- Sets the LR (Last Record) indicator, ending the program.

---

## Summary of Program Flow

1. **Initialize program and parameters.**
2. **Look up conversion factor for the new reporting unit.**
3. **For the specified item:**
   - For every statistics record:
     - If unit is different from the new reporting unit:
       - Look up conversion factor between units.
       - Recalculate the quantity (`sfanta`).
       - Update the record with new unit and quantity.
4. **Exit program.**

---

## Business Purpose

- This program is used when the statistical unit of measurement for an item changes (for example, from "Each" to "Box").
- It recalculates historic sales statistics so they remain valid and comparable under the new unit of measure.

---

## Special Notes

- If the item/unit conversion cannot be found for the new or existing unit, the program skips updating and exits.
- All input/output is via externally described files, so the actual field names (like `sfanta`, `sfenhe`, `veomre`) are defined in the database.

---

**In summary:**  
This is a data correction utility program that automatically adjusts historical item sales statistics after a change in the measurement unit, preserving data integrity in statistical reports.