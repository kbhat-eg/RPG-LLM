# FO647R – Print Job List Summary

## Purpose

This program, `FO647R`, generates a summary printout of job lists (kjøre-liste) for orders in the ASOFAK system. The report includes grouped and subtotaled information by customer and delivery route, with detailed lines showing order items, their quantities, volume, and weight. It is intended for operational/logistics use, supporting warehouse or delivery planning.

## High-Level Structure

- **Input**: Reads from several physical files (order headers, order details, item, customer, etc.), using renamed record formats for clarity and domain alignment.
- **Output**: Writes to a printer file (`fo647p`), using multiple output formats for headings, details, and totals.
- **Control**: Processes records in "job list" order, handling group breaks for customer and delivery route, and accumulating subtotals for each.
- **Parameters**: Receives a packed parameter string from the calling program, containing selection and context information.

## Key Business Logic

### 1. File Definitions and Data Relationships

- **Order-Related Files**:  
  - `fpsol1` (job list input, main driver)  
  - `fohel1` (order header)  
  - `fodtl1` (order details/lines)  
- **Reference Files**:  
  - `vvarl1` (item master)  
  - `vvenl1` (item unit master, for volume/weight)  
  - `rkunl1` (customer master)  
  - `afir/afor` (company/firm info, routines)  
  - `votyl1` (order type)  
  - `vltyl1` (line type)  
  - `fstsl1` (status)  
- **Output File**:  
  - `fo647p` (printer output, multiple formats)

### 2. Parameter Handling

- **Parameter Block** (`ldprec`):  
  - Contains order type, date ranges, department, job/route numbers, and a variant indicator.
  - Overlays used for field extraction.
- **User/Environment Info**:  
  - Extracted from the LDA (Local Data Area) for audit and printout context.

### 3. Sorting and Grouping

- **Sorting Key** (`w_sort`):  
  - Composite of job/route, customer, name/address, order number, and suffix.
  - Used to detect control breaks for customer and route.
- **Break Handling**:  
  - On customer or route change, triggers subtotal printing and resets accumulators.

### 4. Main Processing Loop

- **Record Type Dispatch**:  
  - Reads `fpsol1r` and dispatches logic based on `fkskod`:
    - `'H'`: Order header (calls `tag01`)
    - `'V'`: Item line (calls `tag02`)
    - `'K'`: Comment/text line (calls `tag03`)
- **Order Header Handling** (`tag01`):  
  - Updates sorting/group break variables.
  - Fetches order and customer data.
  - Looks up route text via external program `RS725R`.
  - Writes report headings.
- **Item Line Handling** (`tag02`):  
  - Fetches order line, item, and unit data.
  - Determines decimal precision for quantity.
  - Looks up and calculates volume/weight per item line.
  - Accumulates subtotals for customer and route.
  - Writes detail lines.
- **Text Line Handling** (`tag03`):  
  - Skipped for this report (no output).

### 5. Subtotal and Page Overflow Logic

- **Customer Break** (`brd_kund`):  
  - Checks if enough space remains to print subtotal; writes new heading if needed.
  - Writes customer subtotal and resets accumulators.
- **Route Break** (`brd_rute`):  
  - Writes route subtotal and resets.
- **Overflow** (`xovrfl`):  
  - Handles page overflow by writing new headings and resetting line counters.

### 6. Initialization (`*inzsr`)

- Sets initial values for control variables and accumulators.
- Builds file keys for later use.
- Loads company, customer, and order type info.

## Notable Design Decisions & Conventions

- **Renamed Record Formats**: All files are renamed for clarity and to avoid naming conflicts, reflecting business domain (e.g., `fpsopfr:fpsol1r`).
- **Composite Sorting Key**: Uses a fixed-length structure with overlays for sorting/grouping, ensuring efficient break detection.
- **Extensive Use of Overlay and Like**: Data structures use overlays for parameter parsing and `LIKE` for strong typing, aiding maintainability.
- **External Routine Calls**: For route text, the program calls `RS725R`, indicating modularization of business logic.
- **Flexible Decimal Handling**: Dynamically determines the number of decimals for quantity fields per item, reflecting variable unit precision in the domain.
- **Commented Change Log**: The header includes a detailed change log, with versioning and developer initials, for auditability.

## Interactions with Other Modules

- **`RS725R`**: Called to retrieve route text descriptions.
- **Data Area (LDA)**: Reads user, workstation, and routine info for report context.
- **Multiple Master Files**: Relies on up-to-date item, customer, and company master data for accurate reporting.

## Output Formats

- **A1HDR/A1HDR1**: Main and sub-headings for the report.
- **D1DET**: Detail lines for each item.
- **T1TOT/T2TOT**: Subtotals for customer and route.

## Error Handling

- **Key Not Found**: Use of `%found` and status codes for file operations; missing data results in blank/zero output but does not halt processing.
- **Page Overflow**: Proactively checks line counts and writes new headings as needed.

## Domain-Specific Notes

- **Order, Customer, and Route**: The report is structured for operational use, grouping items by delivery route and customer, reflecting logistics workflows.
- **Volume/Weight Calculation**: Item master data and item-unit cross-reference are used to provide accurate logistics metrics for each order line.
- **Dynamic Field Widths**: Adjustments have been made over time (see change log) to accommodate longer names and expanded price group fields.

---

## Summary Table

| Section             | Purpose                                                              |
|---------------------|----------------------------------------------------------------------|
| File Definitions    | Connects to order, item, customer, and company master data           |
| Parameter Handling  | Receives packed selection criteria and extracts environment/context   |
| Sorting/Grouping    | Detects customer and route breaks for subtotaling                    |
| Main Loop           | Processes records by type: header, item, or text                     |
| Subtotal Logic      | Prints subtotals and handles pagination                              |
| Initialization      | Sets up keys, loads reference data, and initializes accumulators      |
| Output Formats      | Uses multiple printer file formats for headings, details, and totals  |
| Error Handling      | Graceful handling of missing data and page overflow                  |

---

## Onboarding Notes

- **When modifying**: Always update the change log in the header.
- **Adding fields to output**: Adjust the corresponding printer file format and ensure accumulators are updated as needed.
- **New break logic**: Extend the composite sort key and break detection logic.
- **External dependencies**: Coordinate with maintainers of `RS725R` and master data files for any structural changes.

---

For further details or business rules clarification, consult the functional specification for job list reporting or contact the logistics application owner.