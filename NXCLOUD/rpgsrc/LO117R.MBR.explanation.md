```markdown
## Program Overview

This RPG program, named **LO117R**, is part of the **ASLAGR** system. Its function is to select records for printing incoming (purchase) invoices ("Seleksjon for utskrift av inngående faktura"). The code primarily processes entries from a database file and batches them for output, invoking a print program as needed.

---

## Main Sections and Their Purpose

### 1. File Declarations

```rpg
FSIHEL2    IF   E           K DISK
F                                     RENAME(SIHEPFR:SIHEL2R)
```
- Opens the `SIHEL2` database file using the record format `SIHEPFR`, renamed in the program as `SIHEL2R`.
- The file is keyed (`K`) and will be processed for input (`I`).

---

### 2. Data Structures

#### Parameter Structures

- Two data structures (DS) are defined:
    - **DSPARM:** For incoming parameters (from the caller).
    - **DXPARM:** Parameters for the print program (to be passed out).
- Each DS includes fields for various keys and program names.

Example:

```rpg
D  DSPARM                 1     28
D  DSAARR                 1      4  0   // Year
D  DSOTYP                 5      6      // Order type
D  DSBATC                 7     12  0   // Batch
D  DSPROG                19     28      // Program name
```

#### Local Data Area

```rpg
D                UDS
D  DSSFIR               944    946  0    // Company number from user space
```

---

### 3. Main Logic

#### Initialization (`*INZSR` subroutine)
- Zeroes out working fields (`WPFFNR`, `WPTFNR`, `TELLER`, etc.).
- Sets up key fields to reference each other for usage in keyed operations.
- Loads parameters from the calling program and sets up key values for file access and output parameters.

#### Main Loop

The core processing logic works as follows:

1. **Initialize key fields to zero:**
   ```rpg
   C                   MOVE      *ZERO         SHEBIN
   C                   MOVE      *ZERO         SHENUM
   C                   MOVE      *ZERO         SHESUF
   ```
   These fields are likely part of the file key.

2. **Set file pointer with SETLL:**
   ```rpg
   C     SHEKEY        SETLL     SIHEL2R
   ```
   Positions the file pointer at the correct place in `SIHEL2R` according to the key fields.

3. **Main record processing loop (TAG01):**
   - Reads records in a loop, processing only those that match the specified criteria (company, year, batch).
   - Maintains a counter (`TELLER`) to check sequence and batch records for printing.

4. **Batch Logic:**
   - If the next record is not in sequential order (gap detected), it calls the print subroutine (`SKRIV`) with the current batch information.

5. **End of File and Wrap-up:**
   - After the loop, the final batch (if any) is also sent for printing.

#### Print Subroutine (`SKRIV`)
- Prepares outgoing parameters (`DXFFNR`, `DXTFNR`) for the print program.
- Calls the print program via `CALL` using `DSPROG` as the program name and passes the parameters.

---

### 4. Key Lists and Parameter Handling

- Uses `KLIST` to define composite keys for the file.
- At entry (`*ENTRY` PLIST), unpacks and assigns incoming parameters for use within the program and output.

---

## High-Level Workflow

1. **Initialization:**
   - Set up keys and parameters from input.
   - Clear working fields.

2. **File Processing:**
   - Loop through records in `SIHEL2R`.
   - Group records by sequential document numbers (`SHBINR` vs `TELLER`).
   - When a gap is found, send the current group for printing via subroutine.

3. **Printing:**
   - Printing is performed by an external program, called with appropriate parameters for document ranges.

4. **Completion:**
   - After all records, print any remaining batch.
   - Set LR (last record indicator) and return.

---

## Key Concepts Illustrated

- **Batch Processing:** The program groups sequential invoice records and only triggers printing when a break in sequence is detected.
- **Parameter Passing:** Both receiving parameters from a previous program and sending data for further processing (to a print program).
- **Keyed File Processing:** Uses RPG's keying facilities to efficiently process only relevant records.
- **Subroutines:** For modularizing printing and initialization logic.

---

## Norwegian Terms

- **Inngående faktura:** Incoming invoice.
- **Seleksjon:** Selection.
- **Skrive/skrive ut:** Print / writing out.
- **Bilag:** Document/voucher (i.e., an invoice or accounting document).
- **Nummerutvidelse:** Number extension (enlarging number fields).
- **Firma:** Company.
- **År:** Year.
- **Batch:** Batch.

---

## Typical RPG IV Pattern Elements

- **C-specs:** Used for calculations and logic flow.
- **D-specs:** For data structure definitions.
- **F-specs:** For file definitions.
- **Subroutines:** Marked by `BEGSR/ENDSR`.
- **KLIST/KFLD:** Define multi-field keys to perform indexed access to files.

---

## Summary

This program is a classic IBM RPG batch utility for selecting, grouping, and dispatching records (incoming invoices) from a database for further processing or printing, keyed on company, year, batch, and document number. It is well-structured with clear separations for initialization, main processing, and subroutines for modularity.
```