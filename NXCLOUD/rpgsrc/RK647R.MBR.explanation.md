# Program RK647R – Customer Receivables Printout – Parameter Entry

## Purpose and Business Context

This program (`RK647R`) is responsible for collecting and validating selection parameters for generating a customer receivables report. The selection criteria are entered via a workstation display (screen), validated for correctness and business rules, and then written to a parameter structure for use by the actual reporting process.

This is a parameter entry program only; it does not generate the report itself. It is typically invoked as the first step in a report workflow, ensuring that only valid and meaningful parameter sets are passed to downstream reporting logic.

The codebase and naming conventions are Norwegian, reflecting the business context (likely accounting/finance) and user base.

---

## High-Level Structure

- **File Declarations:** 
  - `ausrl1` and `rkunl1` are customer/user master files accessed for validation.
  - `rk647d` is the display file for parameter entry.
- **Data Definitions:** 
  - Local variables for working storage, parameter passing, and temporary values.
- **Parameter Structure:**
  - `/COPY QCPYLESRC,RPARRKDS` brings in the shared parameter data structure used across reporting modules.
- **Main Logic:**
  - Initialization (`*inzsr`) sets up defaults and user context.
  - Main loop displays the parameter screen (`exfmt a2bld`), handles user actions (exit/query), and performs extensive validation.
  - On successful validation, writes parameters to the shared structure and exits.
- **Subroutines:**
  - `spr_rut` handles field-specific lookup dialogs (e.g., department, customer category, salesperson, customer).
  - Initialization subroutine sets up user/firm context and parameter defaults.

---

## Key Business and Domain Logic

### Indicator Usage

- Indicators are heavily used for field protection, error signaling, and navigation.
- Indicators 31–59 are reserved for error/warning messages and screen indicators.
- Indicators 60–69 are for file I/O.
- Indicators 70–99 are for working and subroutine logic.

### Parameter Validation

The program validates a comprehensive set of selection parameters:

- **Date/Period/Year:**
  - Ensures the run date (`a2pkda`) is valid; defaults to current date if blank.
  - Checks that "from" and "to" years/periods are present and logically ordered.
- **Ranges:**
  - Department, customer category, salesperson, and customer number ranges are all validated for logical order (from ≤ to).
- **Individual Customers:**
  - Supports up to 10 individually specified customer numbers.
  - Each is validated to exist in the customer master (`rkunl1`).
  - If an individual customer is invalid, sets corresponding error indicators and returns to the screen.
- **Selection Options:**
  - Parameters for grouping/sorting (by category, department, salesperson) are mutually exclusive; only one can be selected.
  - Sorting order (alphabetical/numeric) is validated for allowed values.
- **User Restrictions:**
  - If the user is restricted to a department (`abbavd = 'J'`), the department range is auto-filled and protected.

### Parameter Writing

- On successful validation, all parameters are moved to the shared structure (from `a2p*` fields to `p*` fields), which will be used by the report generation program.

---

## Interactions with Other Modules and Data

- **File Access:**
  - `ausrl1`: User master for user-specific restrictions (e.g., department).
  - `rkunl1`: Customer master for validating individual customer numbers.
- **Parameter Copybook:**
  - `/COPY QCPYLESRC,RPARRKDS`: Brings in the parameter data structure used across reporting programs.
- **External Program Calls (Field Lookups):**
  - `RA507R`: Department lookup.
  - `RA511R`: Customer category lookup.
  - `RA509R`: Salesperson lookup.
  - `RK500R`: Customer lookup.
  - These are called in the `spr_rut` subroutine based on which field the user is requesting help for.

---

## Notable Design Decisions and Conventions

- **Screen-Driven Workflow:** 
  - The program is tightly coupled to the display file (`rk647d`) and uses EXFMT to drive the user interaction loop.
- **Heavy Use of Indicators:** 
  - Consistent with legacy RPG, indicators control almost all aspects of field protection, messaging, and navigation.
- **Parameter Range and List Handling:** 
  - Both range-based and explicit list-based customer selection are supported.
- **Error Handling:** 
  - Validation failures set specific indicators to trigger user feedback on the display.
- **Field Defaults:** 
  - Initialization logic sets sensible defaults for periods, years, and ranges based on current date and user context.
- **Localization:** 
  - All field names, comments, and messages are in Norwegian, matching the user base and business domain.
- **Extensibility:** 
  - The parameter structure is imported via `/COPY`, ensuring consistency across modules.

---

## Relationships to Other Modules

- This program is expected to be called before the actual reporting program, passing validated parameters via the shared data structure (`RPARRKDS`).
- It relies on several other programs (`RA507R`, `RA511R`, `RA509R`, `RK500R`) for field-specific lookup dialogs, which should be available in the same application environment.

---

## Summary of User Flow

1. **Initialization:** Sets up defaults and user context.
2. **Parameter Entry:** User fills in selection criteria on the screen.
3. **Validation:** Each parameter is validated for business rules and logical consistency.
4. **Error Handling:** On validation failure, error indicators are set and the user is prompted to correct input.
5. **Successful Completion:** Validated parameters are written to the shared structure, and the program ends, passing control to the next step in the reporting workflow.

---

## Key Points for New Developers

- **Understand the indicator map** and how it drives both error handling and screen field protection.
- **Familiarize yourself with the parameter structure** (`RPARRKDS`), as it is central to inter-program communication.
- **Note the field naming conventions** (e.g., `a2p*` for screen/working fields, `p*` for parameter structure fields).
- **Be aware of the external dependencies** (lookup programs and master files) and ensure they are available and correctly defined in your environment.
- **Modifications should respect the field validation and error signaling patterns** established in this codebase to maintain user experience consistency.

---

## References

- **Display File:** `RK647D` – defines the parameter entry screen.
- **Parameter Copybook:** `QCPYLESRC,RPARRKDS` – shared parameter structure.
- **Master Files:** `AUSRL1`, `RKUNL1` – user and customer masters.
- **Field Lookup Programs:** `RA507R`, `RA511R`, `RA509R`, `RK500R`.

---

## Revision History (from code comments)

- **V5.20 (10.05.04):** Fixed error when selecting individual customers.
- **V6.10 (04.11.60):** Changed default for period/year to blank or current.
- **R6.20 (09.09.11):** Recompiled due to changes in parameter structure.
- **7.xx (06.05.16):** Changes related to new GUI (applies only to DDS).

---

This documentation should provide experienced RPG developers with a clear understanding of the program’s role, structure, and integration points within the broader customer receivables reporting system.