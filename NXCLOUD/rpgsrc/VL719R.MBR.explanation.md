# RPG Program Explanation: VL719R

## Overview

This program calculates and retrieves product information from warehouse records, including product type, dispatch date, supplier number, and available stock (beholdning). It accounts for orders in progress and performs unit conversions when necessary to ensure quantities are correctly represented in the requested units.

- **Input Parameters:** company (firma), product (vare), warehouse (lager), unit (enhet)
- **Output Parameters:** product type (varetype), dispatch date (utg.dato), supplier no. (lev.nr), available stock (beholdning)
- **Key Operations:** 
  - Reads master and warehouse files
  - Adjusts warehouse quantity for outstanding orders
  - Handles unit conversion between warehouse and sales units
  - Ignores orders for direct delivery, or that do not impact warehouse stock
- **Customization/History:** Inline comments describe multiple corrections, including handling unit conversion, ignoring certain orders, correcting stock calculations (see the comments with `8.01`â€“`8.06` markers).

---

## File Declarations

Each `F` specification declares a database file to be accessed (disk), with external format and key access, and assigns a record format name with `rename`.

Examples:
```rpg
fvlagl1    if   e           k disk    rename(vlagpfr:vlagl1r)
```
- `vlagl1` = Warehouse stock table
- `vvarl1` = Product master
- `fodtlx` = Order line file
- etc.

---

## Data and Parameters

- Variables defined for key fields for each file.
- Parameters for the program: `p_firm`, `p_vare`, etc.
- Working storage: variables for temporary calculations, especially for unit conversions.

---

## Main Logic (from Hovedprogram)

1. **Initialization**
    - Zero out output variables: `p_behl`, `w_oord`, and clear `p_vtyp`, `p_udat`, `p_ldor`.
    
2. **If warehouse access is allowed (faalag = 1):**
    - Read product master, gather unit of measure details.
    - Read warehouse record (`vlagl1`) for item and warehouse.
        - If not present (**8.06**), skip calculation (Jira issue NXS-20647).
    - If warehouse record found:
        - Set `p_vtyp`, `p_udat`, `p_ldor` from warehouse record if present.
        - For product types other than 'D', 'T', 'S':
            - Initialize count of outstanding orders (`w_oord = 0`).
            - Iterate through order lines for item/warehouse:
                - **Skip lines for direct delivery** (`fdlety=0`).
                - If not tied to a purchase order (`lodtl1` not found):
                    - Find order type (`fohel1`, `votyl1`), include only accumulator type (if `vaoakk=1` and `vaolag=1`).
                    - **If units differ:** call subroutine `omr_ordre` for conversion factor and adjust outstanding quantity.
                    - Add ordered quantity to outstanding order accumulator.
            - Set available stock = stock in warehouse - outstanding orders.
        - Lookup product record (`vvarl1`) to fill missing fields as needed.
        - **If units differ:** adjust available stock to requested units with conversion.

3. **If warehouse access not allowed:**
    - Fill output fields (`p_vtyp`, `p_udat`, `p_ldor`) from master record only, if missing.

4. **End and cleanup (`avslutt` tag):**
    - Set LR (last record) if indicated for RPG cycle end.
    - Return.

---

## Subroutines

### hent_enhe (Find and set unit conversions)

- Looks up in `vvenl1`:
    - Warehouse unit (`w_enhl`, `w_omrl`)
    - Requested/display unit (`w_enhe`, `w_omre`)
- These are then used for quantity conversions.

### omr_ordre (Order line unit conversion) [8.02]

- Loops in `vvenl1` to match order unit to internal unit, retrieves conversion factor (`w_omro`).
- Used when outstanding order quantity is not in warehouse's unit.

---

## Entry Routine (*inzsr)

- Parameter list setup (`plist`, `parm`)
- Defines all required KLISTs (key lists) for file access.
- Initializes working storage for keys and file fields.

---

## Key Logic Highlights

### Outstanding Orders Calculation

- Only considers certain order types and not lines for direct delivery.
- If units differ, uses conversion factors to standardize outstanding quantities.

### Unit Conversion Logic

- Maintains conversion factors for both warehouse and requested units.
- Conversion operations ensure all stock and outstanding orders are compared on a common unit basis before returning the final available quantity.

---

## Error/Skip Handling

- If no warehouse record (`vlagl1`) is found, the routine skips calculation and exits cleanly (as per issue 8.06).

---

## Changes and Comments Reference

- Each change is tagged (e.g., `8.01`, `8.02`). See comments for details, typically fixes or new requirements.
- Comments are in Norwegian (as is much of the variable naming), but the logic is clear and documented for historical tracking.

---

## In Practice: Flow Example

1. **Caller requests product info (firma, vare, lager, enhet...)**
2. **Program:**
    - Initializes output.
    - Looks up records (warehouse, product).
    - Tallies on-hand stock, subtracts valid outstanding orders.
    - Converts units as needed.
    - Returns stock and info fields.

---

## Summary Table

| Task                       | File(s)      | Key Variables      | Notes                                              |
|----------------------------|--------------|--------------------|----------------------------------------------------|
| Fetch stock info           | vlagl1, vvarl1 | p_firm, p_vare, p_lage | Stock, type, dispatch date, supplier              |
| Find outstanding orders    | fodtlx, fohel1, votyl1 | p_lage, p_vare | Filters by order type, excludes direct delivery    |
| Perform unit conversions   | vvenl1         | p_vare, p_enhe     | Both for stock and for outstanding orders          |
| Output info                | parameters    | p_vtyp, p_udat, p_ldor, p_behl | Returns to caller                         |

---

## Conclusion

This program is a robust warehouse/product info retriever that calculates available stock, adjusting for orders and unit differences. It has evolved to handle many business logic nuances and is well-annotated for further maintenance and onboarding.