# Explanation of RPG Program (ASOFAK: Retrieve Phone/Mobile/Fax Info)

This program is written in ILE RPG (Report Program Generator) and is designed to retrieve telephone, fax, and mobile numbers for a customer or customer project from database files. Below is a detailed explanation of its content and flow.

---

## Purpose

- **Program Name:** FÃ˜710R
- **System:** ASOFAK
- **Description:** "Fellesprogram henter tlf/mob/fax"  
  ("Common program retrieves phone/mobile/fax")
- **Function:** Retrieves contact information (telephone, fax, mobile) for a customer (`kunde`) or a customer project (`kundeprosjekt`), if project info is provided.

---

## Files & Data Definitions

### File Declarations

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
```
- **rkunl1r** (from `rkunpfr`): Customer master file.
- **fkprl1r** (from `fkprpfr`): Customer project file.

### Parameter Variables

```rpg
d p_firm          s                   like(rkfirm)
d p_kund          s                   like(rkkund)
d p_kpro          s                   like(flkpro)
d p_tlfn          s             20
d p_tlfx          s             20
d p_mobn          s             20
```
- `p_firm`: Firm number (company ID).
- `p_kund`: Customer number.
- `p_kpro`: Project number.
- `p_tlfn`: Telephone number result (output).
- `p_tlfx`: Fax number result (output).
- `p_mobn`: Mobile number result (output).

### Key Variables

- Used for keying into the files:
```rpg
d w_firm          s                   like(rkfirm)
d rkunl1_kund     s                   like(rkkund)
d fkprl1_kund     s                   like(flkund)
d fkprl1_kpro     s                   like(flkpro)
```

---

## Main Logic

### 1. **Initialization**

- Sets the output parameters to blank:
  ```rpg
  eval p_tlfn = *blank
  eval p_tlfx = *blank
  eval p_mobn = *blank
  ```

### 2. **Fetch from Customer Master (rkunl1r)**

- Sets up key with supplied customer number:
  ```rpg
  eval rkunl1_kund = p_kund
  rkunl1_key chain rkunl1r
  if %found
      if rktlfn <> *blank
          eval p_tlfn = 'Tlf: ' + rktlfn
      endif
      if rktlfx <> *blank
          eval p_tlfx = 'Fax: ' + rktlfx
      endif
      if rkmobn <> *blank
          eval p_mobn = 'Mob: ' + rkmobn
      endif
  endif
  ```
- If a customer record is found, copy over telephone, fax, and mobile info into output parameters (prefixing with labels 'Tlf: ', 'Fax: ', 'Mob: ').

### 3. **Optional Override by Customer Project (fkprl1r)**

- If a project number is provided (not 0), tries to get info from the project file:
  ```rpg
  if p_kpro = 0
      goto xforbi
  endif

  eval fkprl1_kund = p_kund
  eval fkprl1_kpro = p_kpro
  fkprl1_key chain fkprl1r
  if %found
      if fltlfa <> *blank
          eval p_tlfn = 'Arb: ' + fltlfa
      endif
      if fltlfp <> *blank
          eval p_tlfx = 'Prv: ' + fltlfp
      endif
      if fltlfm <> *blank
          eval p_mobn = 'Mob: ' + fltlfm
      endif
  endif
  ```
- If project info is found, *overwrites* the corresponding output fields with project-specific data (using labels 'Arb: ', 'Prv: ', 'Mob: ').

### 4. **Exit Program**

- The tag `xforbi` is used for control flow (like a label in older languages).
- Program marks itself for end (`*inlr = *on`) and then returns.

---

## Subroutines

### *INZSR (Initialization Subroutine)

```rpg
*inzsr begsr
    // Build file keys for customer and project files
    rkunl1_key    klist
        kfld w_firm
        kfld rkunl1_kund

    fkprl1_key    klist
        kfld w_firm
        kfld fkprl1_kund
        kfld fkprl1_kpro

    // Set up entry parameter list
    *entry plist
        parm p_firm
        parm p_kund
        parm p_kpro
        parm p_tlfn
        parm p_tlfx
        parm p_mobn

    // Store firm number for keys
    eval w_firm = p_firm
endsr
```
- Parameters received from caller.
- Sets up the file keys.
- Copies the company number into key variable.

---

## Additional Notes

- **Labels:** The prefixes 'Tlf: ', 'Fax: ', 'Mob: ', etc., are in Norwegian, meaning 'Phone:', 'Fax:', 'Mobile:', etc.
- **Field Naming:** Fields like `rktlfn`, `rktlfx`, `rkmobn` (from customer file) and `fltlfa`, `fltlfp`, `fltlfm` (from project file) are assumed to contain phone, fax, and mobile numbers, respectively.
- **Priority:** Customer project info (if available and not blank) overwrites basic customer info.
- **Legacy Style:** Uses tags (e.g., `xforbi`, `avslutt`) and GOTO for flow control, which is common in older RPG code.

---

## **Summary**

1. **Initialize** output fields to blank.
2. **Try Customer info:** Set output fields from the customer file.
3. **If project provided:** Overwrite output with info from the project file, if present.
4. **Return** to caller with contact info in parameters.

---

## **Usage Scenario**

This program is likely used as a utility (called as a subprogram) to fetch and return up-to-date contact info for display, printing, or further processing in other applications, adapting to whether only a customer or a specific customer project is in scope.