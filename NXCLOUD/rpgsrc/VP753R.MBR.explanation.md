# Overview

This RPG source code appears to be part of a program designed to retrieve purchase and cost prices for a specific item (vare) within a given company (firma) and date. The program fetches prices from a register, considering various parameters like unit (enhet), delivery type (lev.type), and potentially price groups (prisgruppe). It also contains subroutines for price retrieval and program initialization.

---

# Key Components and Concepts

- **Comments and Metadata:**  
  The initial comments describe the program purpose, system information, input/output data, version history, and changes. This helps developers understand the evolution and business context.

- **Definitions:**

  - **File and Data Structure Declarations:**  
    Files like `fvvprl1`, `fvvarl1`, and `fvtill9` are declared with `if e` (indicating external files). These are used for database lookups.

  - **Parameters (`p_*`):**  
    Input parameters like franchise (`p_firm`), item (`p_vare`), date (`p_dato`), unit (`p_enhe`), etc., are defined to pass data into the program.

  - **Internal Variables:**  
    Variables such as `vvarl1_vare`, `vvprl1_vare`, and others are used internally for data manipulation.

  - **Flags:**  
    `b_pris` and `b_inlr` are flags indicating whether a price has been found or not during lookup.

- **Main Program Logic:**

  1. **Fetching Warehouse and Supplier Info:**
     - Calls an external program `'VL721R'` with parameters to retrieve supplier (`leverand√∏r`) and warehouse (`lager`) info for the item.
     - Uses `chain` and `exsr` (external subroutine call) for lookups.

  2. **Price Retrieval Logic:**
     - Calls the subroutine `'hent_pris'` to fetch prices from different registers based on specific criteria.
     - The logic attempts to find prices based on delivery type and price group, with fallback mechanisms:
       - First, searches for a specific delivery type.
       - If not found, searches for a default or "zero" delivery type.
       - If still not found, searches by price group or blank.
       - If no match, defaults the purchase price (`p_inpr`) to the cost price (`p_kopr`).

  3. **Fallback and Defaulting:**
     - Ensures that if no purchase price is found, it defaults to the cost price.
     - Finalizes by setting output parameters accordingly.

- **Subroutine `'hent_pris'`:**

  - Handles the detailed logic for price lookups.
  - Checks if a campaign (`p_kamp`) is active and filters prices accordingly.
  - Uses key setting (`setll`) and reade operations (`reade`) for database traversal.
  - Implements multiple fallback levels to search for prices based on:
    - Delivery type-specific records.
    - Default delivery type (zero).
    - Price group.
    - Blank entries.
  - Sets flags (`b_pris`) to indicate if a price was successfully found.

- **Subroutine `'*inzsr'`:**  
  Handles program initialization:
  - Assigns values from parameters to internal variables (like date and company).
  - Sets initial output values for price pointers.

---

# Additional Notes

- The code uses structured subroutines (`begsr`/`endsr`) for modularity.
- The lookup process is designed to be robust, trying multiple fallback options.
- Uses `time` instruction to set the current time if input date is zero.
- Key management (`klist`/`kfld`) is used for efficient database searches.
- The logic respects delivery types and date validity for accurate pricing.

---

# Summary

This program is a comprehensive utility for fetching item prices based on complex criteria, with built-in fallback logic to ensure a price is always returned when possible. It interfaces with multiple database files, handles date-based validity, and respects special conditions like campaigns and price groups.

