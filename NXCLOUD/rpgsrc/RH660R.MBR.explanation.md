# RPG Program Overview

This ILE RPG/400 program, named `RH660R`, is a parameter-handling module for a main ledger ("Hovedbok") VAT settlement process. Its primary function is to gather, validate, and store various control and processing parameters, often presented through a workstation (screen) interface. It uses data areas, user files, and leverages indicators for controlling user interaction.

The code is heavily commented (sometimes in Norwegian), which provides important context for each section. Here is a breakdown of important parts and their roles.

---

## Header & Options

```rpg
h datedit(*dmy) option(*nodebugio)
```
- `datedit(*dmy)`: Set default date format to Day-Month-Year.
- `option(*nodebugio)`: Prevents debug I/O.

---

## File Declarations

```rpg
fausrl1    if   e           k disk
frh660d    cf   e             workstn
```
- `ausrl1`: User file, keyed, input (likely used for user parameter retrieval).
- `rh660d`: Workstation file, used for interactive data entry/screens.

---

## Data Definitions

The program uses a mixture of variables for passing parameters, temporary work fields, and storage structures.

### Parameter Structure (Some fields)

```rpg
d rhpkda                300    305  0
d rhprær                         4  0
d rhpper                         2  0
d rhpmva                         1  0
d rhpmv0                         1
d rhptst                         1
d rhpost                         1
d rhpsps                         1
```
- `rhpkda`: Likely processing date.
- `rhprær`: Accounting year ("regnskapsår").
- `rhpper`: Period.
- `rhpmva`/`rhpmv0`: VAT-specific flags.
- `rhptst`, `rhpost`, `rhpsps`: Processing/test/other options (single character).

### User/Company Fields

```rpg
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
Areas of a parameter block for user ID, firm number, firm name.

### Working Fields

```rpg
d wpakod          s              2  0
d wpdat1          s              6  0
d p_in03          s              1
d wpokok          s              1
d wwaar           s              2  0
d w_firm          s              3  0
d w_user          s                   like(l_user)
d w_navn          s                   like(l_fnav)
```
Working fields for dates, user, firm data, etc.

### Message and Warning Handling

```rpg
T5.30d var             s             40    dim(2) ctdata perrcd(1)  Varsel m/svarkrav
T5.30d wsavli          s              2  0
T5.30d wsavpo          s              3  0
```
- `var`: Array of warning texts (e.g., displayed on confirmation prompt).
- `wsavli`, `wsavpo`: Possibly position for message windows.

---

## Main Logic and Screen Handling

### Program Start and Parameter Input

- Uses display file format `A2BLD` to prompt operator for parameters.
- Handles exit function key (`F3` via indicator *INKC), sets exit flag, and returns if chosen.

### Parameter Validation and Defaults

- If the date (`a2pkda`) is missing, it is defaulted to today’s system date (`udate`).
- Validates date entry using built-in date check (`test(d)`).
- If date invalid (`*IN33`), redisplays the entry screen.

### Company Description Retrieval (SAFT integration)

In version 8.00:
- If not a test run, loads company description from a data area (`saft_mva`), up to 30 chars.
- If description missing, sets error indicator and redisplays the screen.
- If present, updates the data area with any new value typed in the screen.

### Year Validation Logic

- If entered accounting year (`a2prær`) is greater than current year (`*YEAR`), shows warning window based on `var` message array.
- Prompts user to confirm or reject (through subroutine `xm1win`). If rejected, screen is redisplayed.

### Parameter Storage

After validation:
- Parameter values from the entry screen are moved to working and LDA fields for use by subsequent job steps or programs.

### End of Program

```rpg
c xslutt tag
c eval *inlr = *on
c return
```
- Sets LR (last record) to flag job completion and returns.

---

## Subroutines

### `xm1win`: Message/Warning Window

- Displays warning messages and prompts for Yes/No.
- Resets to 'N' (No) if user presses exit.

### `*inzsr`: Program Initialization

- Sets up initial values for working fields and parameter screen.
- Populates default accounting period and year based on current system month:
    - Jan/Feb: previous year, period 12, mva period 6 (final VAT).
    - Mar/Apr: current year, period 2, mva period 1.
    - May/Jun: current year, period 4, mva period 2, etc.
- Sets 'test run' to 'J' (Yes) as a default.

---

## Indicators

Well-documented code shows use of indicator ranges:
- 30: Protect display fields.
- 31-59: Warning/error indicators.
- 60-69: File I/O.
- 70-89: Work indicators.
- 90-99: Subroutine control.

---

## Data Area Usage

- Uses data area (`saft_mva`) to store/retrieve descriptions for VAT reporting (SAF-T integration).

---

## User File Access

- Chains user records using the supplied user key, likely to check access or fetch defaults.

---

## Miscellaneous

- Handles parameter passing using `plist`/`parm`.
- Comments are verbose and serve as documentation and revision history.
- Uses Norwegian for descriptions and comments (e.g., "Beskrivelse" = Description).

---

## Summary

- **Purpose:** Collect and validate parameters for VAT settlement, with user interaction and safety checks.
- **Inputs:** User, firm, dates, flags; all validated.
- **Storage:** Parameters moved to LDA or designated fields for downstream processes.
- **Interaction:** Uses display files for input, confirms unusual values, and uses data areas for persistent parameter descriptions.
- **Robustness:** Built-in validation for dates, years, and confirmations ensures data integrity.
- **Integration:** Prepares data for SAF-T (standardized tax reporting), as seen in data area handling.

---

**In short:** This RPG program controls the first step (parameter entry and validation) of a VAT reconciliation process for the Norwegian accounting environment, ensuring correct values and safe hand-off to batch or follow-up jobs.