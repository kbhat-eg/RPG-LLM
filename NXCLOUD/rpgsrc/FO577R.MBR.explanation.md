# FO577R RPG Program Documentation

## Overview

**Program Name:** FO577R  
**Description:**  
Displays S-items (“S-varer”) if inventory/warehouse has changed.  
The program is a display file program that utilizes a subfile to show relevant S-items for a given order and warehouse. It allows selection of an item, and sets a return code if a "skafvare" (procurement item) is found.

**Key Business Logic:**  
- Handles order lines, filtering for S-items by warehouse.
- Presents these items in a subfile for user selection.
- Integrates with several master files (order lines, inventory, item status).
- Supports return codes to indicate if a procurement item is found.

---

## File Definitions

| File      | Usage    | Description                                    | Notes |
|-----------|----------|------------------------------------------------|-------|
| fodtl1    | Input    | Order line file (renamed fodtl1r)              | Keyed access |
| vlagl1    | Input    | Inventory/location file (renamed vlagl1r)      | Keyed access |
| fstsl1    | Input    | Item status file (renamed fstsl1r)             | Keyed access, used for status lookup |
| FO577d    | Display  | Workstation file with subfile (b1sfl)          | infds used for feedback |

---

## Parameters

- `p_firm` – Company code
- `p_numm` – Order number
- `p_suff` – Order suffix
- `p_lage` – Warehouse code
- `p_retk` – Return code (set to '1' if procurement item found)

These are passed in via the program parameter list.

---

## Key Variables

- `w_srrn`, `w_ssrn`, `w_sfrn`, `w_spge`: Subfile record and page counters.
- `b_valg_ok`: Indicates if a selection has been made.
- `w_firm`: Working copy of firm code.
- `vlagl1_vare`, `vlagl1_lage`: Used for inventory lookups.
- `dspfbk`: Display feedback data structure (for cursor positioning).

---

## Indicators

Standard company conventions are used for indicators:
- LR: End program
- 10: Roll
- 11: Rolldown
- 12: Subfile display
- 13: Subfile display control
- 14: Subfile clear
- 15: Subfile end
- 21: Home key
- 22: Cursor placement
- 30: Field protect
- 31-79: Error/warning indicators
- 80-99: Work indicators

---

## Program Flow

### Initialization (`*inzsr`)

- Loads parameters.
- Initializes screen and working variables.
- Looks up item status (fstsl1).
- Positions order line file (`fodtl1`) and builds the initial subfile.

### Main Display Loop

1. **Show Command Screen:**  
   - Writes `b2cmd` record.

2. **Data Screen:**  
   - If no records in subfile, exits.
   - Calls `dsp_subfile` to display the subfile.

3. **Function Key Handling:**  
   - Handles exit keys (F3, F12), refresh (F5), page up (F10), home key (F21).
   - Refresh and page up re-create the subfile as needed.

4. **Subfile Processing:**  
   - Calls `subfile` subroutine to process user selection in the subfile.
   - If a selection is made (`b_valg_ok`), exits.

5. **Loop:**  
   - Returns to the main display until exit condition is met.

### Subfile Management

- **`clr_subfile`:** Clears the subfile and resets counters.
- **`crt_subfile`:** Reads order lines, filters for S-items in the specified warehouse, writes them to the subfile, and sets return code if a procurement item is found.
- **`dsp_subfile`:** Formats and displays the subfile control screen.
- **`subfile`:** Processes user input within the subfile; sets selection and updates variables.

### S-Item Filtering Logic

- For each order line, the program checks the inventory record (`vlagl1`) for that item and warehouse.
- Only items of type 'S' (S-var) are shown.
- If `faalbe > 1`, a special indicator is set (used for display purposes).
- If a procurement item is found, `p_retk` is set to '1' (for return to the caller).

---

## Display File Structure

- **Subfile Record (b1sfl):** Displays S-items for selection.
- **Control Record (b2ctl):** Manages subfile paging and user commands.
- **Command Screen (b2cmd):** Used for function key handling and messages.

---

## Integration Points

- **Order Lines (fodtl1):** Main data source for items to display.
- **Inventory (vlagl1):** Used to filter to S-items by warehouse.
- **Status (fstsl1):** Used for additional lookups related to item status.

---

## Notable Design Choices

- **Subfile Paging:**  
  The subfile is paged in increments (`c_sfil = 8`), with logic to track first/last record on each page.
- **Return Code Mechanism:**  
  The program sets a return code (`p_retk`) if a procurement item is found, enabling calling programs to react accordingly.
- **Indicator Usage:**  
  Heavy use of indicators for display file control, following established company conventions.
- **Parameter Passing:**  
  All business context is passed in via program parameters, supporting modular and reusable design.

---

## Business/Domain-Specific Notes

- **S-varer:**  
  "S-varer" refers to a specific item type (likely "skafvare" or procurement item). Only these items are relevant for display and selection.
- **faalbe:**  
  This field is checked for values greater than 1, which may indicate special handling or display needs.
- **Subfile Selection:**  
  User can select an item from the subfile; the selected item's values are returned to the caller via parameters.

---

## Extensibility

- **Order Number Expansion:**  
  The program has been updated to handle expanded order numbers (`fdnumm`).
- **Price Group Expansion:**  
  The price group field has been expanded from 1 to 2 positions in recent revisions.
- **Status File Integration:**  
  Status information is now retrieved from `fstsl1` for additional context.

---

## Summary

FO577R is a focused utility for displaying and selecting S-items for a given order and warehouse, with robust subfile handling and integration with key master files. It adheres to company standards for indicator usage and display file management, and is designed for modular integration with other applications via its parameter interface and return code mechanism.