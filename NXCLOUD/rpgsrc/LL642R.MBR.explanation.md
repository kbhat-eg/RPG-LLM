Program Overview:  
- Name: LL642R  
- Purpose: Extract inventory records (“Utplukk til hyllevarmere”) from storage register based on selection criteria, calculate values and output to a work file.  
- Entry parms: A 128-byte parameter block with ranges for item numbers, locations, product groups, supplier, handler, price group horizon, etc.  

File Declarations:  
- Input files (disk): VLAGL1, VVARL1, VOGRL1, VHGRL1, VUGRL1 (inventory, item master, over-/main-/sub-groups).  
- Output file (disk): LWA1LU (work file).  
- All input files are keyed on company, item, then location or group codes.  

Data Structures & Variables:  
- p_prec (128 bytes): Overlaid by individual selection fields (p_fvar…p_thgr, p_levn, p_sakb, p_vari, p_type, p_hori).  
- p_parm (128 bytes): For subroutine LA965R to accumulate movements (date range, sums).  
- p_mkey (65 bytes): Constructed sort key (item + location) for writing work file in desired order.  
- Group DS f_vgrp, t_vgrp, v_vgrp: Low/high/test values of OGRP-HGRP-UGRP codes.  
- Date DS x_dato_8f/t for computing first/last day of prior year.  
- Working vars w_vare, w_dato, w_prgr, w_lage, etc. hold current record’s item, dates, prices and location.  

Initialization Subroutine (*INZSR):  
- Builds key lists for chained reads of each input file.  
- Receives entry parm w_parm, moves into p_prec, extracts selection values.  
- Saves company number into w_firm.  
- Sets up group low/high from p_fogr,p_thgr,p_fugr,p_tugr.  
- Positions VLAGL1 to first record at p_fvar/p_flag with SETLL.  
- Calculates reference dates (current minus 12 months, full prior year) into w_dato_12, w_dato_ff/w_dato_ft for accumulations.  

Main Processing Loop (LES_LAGER tag):  
1. READ VLAGL1. If end-of-file, goto END_PGM to set *INLR on and exit.  
2. Copy item from VLAGL1 into w_vare.  
3. Filter checks (each failing record loops back to LES_LAGER):  
   - Wrong company?  
   - Item number outside p_fvar–p_tvar?  
   - Location outside p_flag–p_tlag?  
   - Item master record missing (chain VVARL1)?  
   - Item’s group codes outside f_vgrp–t_vgrp?  
   - Subgroup not stock-controlled (chain VUGRL1 and vgulag=1)?  
   - Main group not stock-controlled (chain VHGRL1 and vghlag=1)?  
   - Overgroup not stock-controlled (chain VOGRL1 and vgolag=1)?  
   - Supplier mismatch if p_levn<>0.  
   - Handler mismatch if p_sakb≠ spaces and not matching vgopra/vghpra/vgupra.  
   - Record not of type ‘L’ (stocked item).  

4. Build sort key p_mkey: if p_vari=1 then key = item + location; else blank.  
5. Price retrieval:  
   - Prepare call to external program VP730R with parms (firm, item, price group, unit type=0, w_dato, w_enhe, and w_lage).  
   - Outputs: w_sapr (sales price), w_gmpr (margin price), w_kopr (cost price), w_inpr (incoming cost).  
   - Assign mlenhl, mlspri, mlkpri, mlipri from returned parms.  

6. Calculate inventory values:  
   - If p_hori=0 (current year): multiply current balances (vlsalg, vlbehl, etc.) by prices.  
   - If p_hori=1 (last 12 months): call AKKU_12MND to fill p_beve…p_inng, then compute cost/turnovers on those sums.  
   - If p_hori=2 (full prior year): call AKKU_FJOR similarly.  

7. Populate work file record LWA1LU:  
   - Transfer fields: mlfirm, mlvare, mllage, mlplas, mlb101, mlkpny, mlmini, mlmaks, mlltid, mlbpun, mlbmen, mlsikl, mltrda, mlopda, mlsdat, mlogrp, mlhgrp, mlugrp.  
   - Write LWA1LU.  

8. Loop back to LES_LAGER.  

Exit (END_PGM tag):  
- Set *INLR = *ON to close files and end program.  

Subroutines:  
- HENT_PRISGR (p_avde → w_prgr): Calls VL712R to obtain price group (expanded to two positions in v8.01).  
- AKKU_12MND: Prepares p_parm with vllage, vlvare, date range (w_dato_12→w_dato_dd), zeroes p_beve…p_behl, calls LA965R to accumulate last 12-month movements, retrieves sums back.  
- AKKU_FJOR: Similar to AKKU_12MND but uses date range for prior year (w_dato_ff→w_dato_ft).