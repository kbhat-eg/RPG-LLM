# High-level Description

This RPG source code is for a program with the title **ASLAGR: Oppdatering av lager-register utfra bestilling** (Update of warehouse register from order), program name **LA923RNAT**. Its main purpose is to update the warehouse register based on orders, for a specific item and warehouse combination.

## File Definitions

The program works with several physical files:

- **vlaglu**: Warehouse register (using record format `vlaglur`)
- **lohel1**: Order header register (format `lohel1r`)
- **lodtlx**: Order detail/line register (format `lodtlxr`)
- **votyl1**: Order type register (format `votyl1r`)
- **vltyl1**: Line type register (format `vltyl1r`)
- **vvarl1**: Item register (format `vvarl1r`)
- **vvenl1**: Item unit register (format `vvenl1r`)

All files except `vlaglu` are opened for input. `vlaglu` is opened for update.

## Data Definitions

### Parameters

Three parameters are passed into the program:

- **p_firm**: Company number
- **p_vare**: Item number
- **p_lage**: Warehouse number

### Working Variables

Several working variables are defined, including but not limited to:

- **w_firm**: Company number for working storage
- **w_anta**: Quantity
- **w_bbes**: Calculated new reserved quantity
- **w_updt**: Flag for update (1=update needed)
- **w_omrl/w_omrs**: Conversion factors for units (used for quantity conversion)

## Key Lists

Key lists are defined for use with chained file access, e.g., to locate records in multi-keyed files.

## Main Program Logic

### Initialization (`*inzsr`)

- Populates key lists for file access and assigns the firm number (`w_firm = p_firm`).

---

### Mainline

1. **Set Up Keys**
   - Sets up keys to locate the record in the warehouse register (`vlaglu`).

2. **Read Warehouse Register**
   - Chains the provided item/warehouse combination using the key.

3. **If Warehouse Register Record Exists:**
   - (If available) Reads the item record from `vvarl1`.
   - Calls subroutine `sjek_ordr` to check/calculate orders for the item/warehouse.
   - If the calculated reserved quantity (`w_bbes`) matches the existing (`vlbbes`), no update is needed (`w_updt = 0`).
   - If update needed (`w_updt = 1`):
      - Updates the reserved quantity, date, time, and user in `vlaglu`; writes changes.
   - Otherwise, unlocks the record.

4. **End Program**
   - Turns on last record indicator (`*inlr`) and returns.

---

### Subroutine `sjek_ordr` (Check Order Lines)

- Initializes update flag (`w_updt = 1`) and calculated quantity (`w_bbes = 0`).
- Reads through all order lines for the item/warehouse (using file `lodtlx`).
- For each line:
    - Checks if item is not blank and line type is not 1.
    - Fetches order header (`lohel1`), order type (`votyl1`), and line type (`vltyl1`).
    - If order type's handling code is 1:
        - Gets ordered quantity (`ldanta`).
        - Calls `sjek_omr` for potential unit conversion.
        - If order type/line type negative, quantity is negated.
        - Accumulates (`w_bbes = w_bbes + w_anta`).

---

### Subroutine `sjek_omr` (Check/Convert Units)

- Checks if the order unit equals warehouse unit. If yes, skips conversion.
- Otherwise, finds conversion factors in item unit file (`vvenl1`) for both order unit and warehouse unit.
- Sets `w_omrs` (order unit conversion) and `w_omrl` (warehouse unit conversion). Defaults to 1 if zero.
- Calculates new quantity: `w_anta = ldanta * w_omrs / w_omrl`.

---

## Notable Details

- The program is designed to only update the `vlaglu` if the calculated reserved quantity differs from what is currently stored.
- Handles negative order types and line types by reversing the sign of the quantity.
- Has special handling for unit conversions between the ordered unit and the warehouse's standard unit.
- Uses traditional RPG/400 syntax with fixed format.

---

## Comments and Versioning

- Comments include purpose and references to related programs (e.g., based on LA920RNAT).
- Section "6.26" and "6.27" refer to program modifications or version increments where new logic (such as unit conversion) was added.

---

## Summary

**This program ensures the warehouse register's reserved quantity for a given item/warehouse matches the accumulated reserved quantity from active orders, accounting for differences in order types, line types, and item units.** 

It is primarily a batch update/validation utility that recalculates and, if out of sync, updates the reserved quantity field in the warehouse register for an item and warehouse, based on the current status of order lines in the system.