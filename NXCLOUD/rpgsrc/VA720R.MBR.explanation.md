# Explanation of RPG Program VA720R

This is an ILE RPG/400 program for IBM i (AS/400) systems. Its main purpose is to retrieve and return accounting reference (kontohenvisning) data for a combination of item (vare), groupings (undergruppe, hovedgruppe, overgruppe), and status, supporting parameterized lookups and returning the result as a data structure parameter.

---

## 1. **Header & Metadata**

- The `h` spec sets RPG options: 
  - `option(*nodebugio)`: disables debugger I/O tracing.
  - `datedit(*dmy)`: sets date format.
- The comment block describes the program, its system, name, function (description in Norwegian: "Henter Konto - Avd - Spes" = "Retrieve Account - Dept - Spec"), revision history, and maintenance log.

---

## 2. **File Declarations**

Six logical files, each renamed for local use:

| Logical File  | Physical File | Rename Record  | Usage                               |
|---------------|--------------|----------------|-------------------------------------|
| fstsl1        | fstspfr      | fstsl1r        | Status register                     |
| vogrl1        | vogrpfr      | vogrl1r        | Over-group register                 |
| vhgrl1        | vhgrpfr      | vhgrl1r        | Main-group register                 |
| vugrl1        | vugrpfr      | vugrl1r        | Sub-group register                  |
| vvarl1        | vvarpfr      | vvarl1r        | Item (product) register             |
| vkhvl1        | vkhvpfr      | vkhvl1r        | Account reference register (output) |

All are `IF` (input, full procedural), externally described, keyed (`K`), and disk-based.

---

## 3. **Parameter & Variable Definitions**

### Entry Parameters

- **Input/Output Parameters**
  - `p_stat` (1 char): Status code returned to caller.
  - `p_ltyp` (1 digit): Delivery type.
  - `p_otyp` (2 chars): Order type.
  - `p_ogrp` (2 digits): Over-group.
  - `p_hgrp` (2 digits): Main-group.
  - `p_ugrp` (3 digits): Sub-group.
  - `p_vare` (15 chars): Item number.
  - `p_hele` (128 chars): Whole output structure (as a receiver).

### Working Variables

- `w_firm`: Company number, used as key.
- Other variables (`vogrl1_oogr`, `vhgrl1_hogr`, etc.) are used to build composite keys for chaining to the various logical files.

### Data Structure for Output

- `d_hele`: 128 bytes, mapped out as fields for up to 7 "account/department/special" combinations, accounting reference, and level (`d_nivo`).
- Each "KAV", "KKO", "KSP" triplet: probably Account, Department, Special.

### LDA (Local Data Area)

- `l_firm`: Company number is retrieved from the LDA and placed as first key field for subsequent lookups.

---

## 4. **Lookup Logic (Main Control Section)**

### High-level Lookup Sequence

**Purpose**: To find the most specific "kontohenvisning" (accounting reference) possible, given the combination of parameters.

**Lookup is performed in this order** (from most specific to least):

1. **Item (VARE) register**: If `p_vare` is given, try to find an account reference tied to the item.
2. **Undergruppe (Sub-group)**
3. **Hovedgruppe (Main-group)**
4. **Overgruppe (Super-group)**
5. **Status register**

For each, if an account reference is found, the program saves the reference and the "level" (`w_nivo`) and jumps to next stage (`xtag01`).

### Key Building

- Each logical file key is built using the company number and group/item codes as appropriate.

### Kontohenvisnings (Account Reference) Register Lookup

After finding an accounting reference code from one of the above, the program will:

- Try to find a matching row in the account reference register (`vkhvl1r`), using a sequence of keys including delivery type and order type.
- The matching follows a fallback priority, trying all combinations of actual/blank delivery and order type, both from the current level and from status (fallback).

#### Search Order in Account Reference Register

1. AccountRef + DeliveryType + OrderType
2. AccountRef + DeliveryType + blank OrderType
3. AccountRef + blank DeliveryType + OrderType
4. AccountRef + blank DeliveryType + blank OrderType
5. AccountRef(from Status) + DeliveryType + OrderType
6. AccountRef(from Status) + DeliveryType + blank OrderType
7. AccountRef(from Status) + blank DeliveryType + OrderType
8. AccountRef(from Status) + blank DeliveryType + blank OrderType

If none is found, `p_stat` is set to `'9'` and program ends.

---

## 5. **Result Construction**

When found, the account reference entry's fields are mapped into the output data structure (`d_hele`), and returned via the `p_hele` parameter.

---

## 6. **Initialization and Keys**

- The `*inzsr` subroutine initializes working fields and sets up composite keys for each logical file for easy lookup.

---

## 7. **Program Entry & Parameter Handling**

- The `*entry` PLIST maps parameters from caller into local variables.
- Company number is loaded from LDA to `w_firm` for keying.
- Data structure fields are zeroed before use.

---

## 8. **Program Termination**

- When the lookup sequence is complete (either a match found or all options exhausted), the program sets on LR (`seton lr`) and returns.

---

## 9. **Summary Flow**

1. **Initialize keys, zero variables.**
2. **Read parameters from the calling program.**
3. **Build keys using the company number and parameters.**
4. **Try to find the most detailed account reference:**
   - First by item, then under-group, then main-group, then over-group, then status.
   - For each, if a reference exists, use it.
5. **Lookup the details in the account reference register, using the specified fallback order of keys.**
6. **If found, populate the output structure and status.**
7. **If not found, set status to '9'.**
8. **Return the result to the caller.**

---

## 10. **Typical Usage Scenario**

A calling program (e.g., order entry or inventory) needs the correct account/special/department codes for accounting when processing an item. It calls VA720R, passing item and grouping parameters. VA720R attempts to resolve the correct codes by checking specific-to-general levels, and returns a structure with the combined codes, or a status code indicating failure.

---

## 11. **Important Notes**

- **Key logic and fallback order is crucial** for ensuring proper accounting for various product and group codes.
- **Parameters must be correctly populated** by the calling program.
- **Modifications**: Several changes (noted in revision log) have extended group definitions and the ability to account by delivery type.
- **All output is via passed parameter `p_hele`** (structure), and status code `p_stat`.

---

## 12. **Code Reading Tips**

- The program uses classic (fixed-format) RPG IV/C-spec syntax, not free-format.
- Norwegian labels and comments are prevalent.
- Each chain/lookup sets indicator 80 if the record was not found; this controls branching.
- Structure fields (KAV, KKO, KSP) should be mapped to actual business meanings in your documentation.

---

**This program is a classic example of a data-driven lookup system for business rules, designed to get the correct accounting references for any given sales item or grouping, with multiple fallback paths.**