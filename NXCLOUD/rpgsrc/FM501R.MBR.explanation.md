# RPG Program FM501R - Code Explanation

This program is a traditional ILE RPG (RPG IV) application designed for the AS/400 (IBM i) platform. It manages and inquires about card/account agreements ("kort/fakt.avtaler" in Norwegian), using subfiles for display and selection in a workstation environment (5250 screen).

The program is well-commented, with most comments in Norwegian. Below, you’ll find a structured walkthrough, from the overall architecture to details of the main routines and data structures.

---

## 1. High-Level Overview

- **Purpose:** Maintains/inquires about customer card/account agreements using subfiles, allowing the operator to select or browse entries tied to a customer.
- **Main features:** 
  - Display/query of credit/debit card agreements.
  - Subfile (paged list) navigation.
  - Selection validation (e.g., only showing cards with required authorization).
- **Interfaces:** Uses display file (`fm501d`) with subfile (`b1sfl`). Interacts with physical files (`rukrl1`, `rukrl5`, `rkunl1`).

---

## 2. File Declarations

```rpg
frukrl1    if   e           k disk    rename(rukrpfr:rukrl1r)
frukrl5    if   e           k disk    rename(rukrpfr:rukrl5r)
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffm501d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```

- **frukrl1, frukrl5, frkunl1:** Input files for card and customer data, using external descriptions.
- **ffm501d:** Display file (workstation), using a subfile (`b1sfl`), and an information data structure for display feedback.

---

## 3. Key Data Structures and Variables

### Parameters (for passing in values)
```rpg
d p_firm          s                   like(rukfir)
d p_kund          s                   like(rukkun)
d p_kpro          s                   like(rukpro)
d p_kftp          s                   like(ruktyp)
d p_ktsq          s                   like(ruktsq)
```

- Used to receive company, customer, product, and card type/sequence info at program entry.

### Subfile Control Variables
```rpg
d w_fcrn          s              4  0  // First record number on page
d w_stel          s              4  0  // Subfile counter
d w_spge          s              4  0  // Subfile page size
d w_srrn          s              4  0  // Relative record number in subfile
d w_sfrn          s                   like(w_srrn) // First record on last page
d w_ssrn          s                   like(w_srrn) // Last record on last page
```

- These control subfile paging and positioning, including current/first/last record numbers.

### Miscellaneous
```rpg
d w_seqe          s              1
d b_valg_ok       s              1    inz(*off)
d w_firm, w_kund, w_kpro, w_kort // Working copies of firm, customer, product, card number
d c_sfil          s              2  0 inz(8) // Constant: subfile page size
```

---

## 4. Keylists for File Access

Keylists (using `klist`/`kfld`) define composite keys for data positioning/searching:

- **rukrl1_key:** Used to position and read card agreements for a given customer.
- **rukrl5_key:** Used for searching for specific card types (e.g., BM Kort, Maxbo, Santander).
- **rkunl1_key:** For looking up customer data.

---

## 5. Main Program Logic

### Program Entry (`*inzsr` subroutine)
- Receives parameters and initializes working variables.
- Builds keys for current customer and product.
- Initializes subfile page (by calling `crt_subfile`).

---

### Main Loop

- Enters a display/command loop, showing either command buttons (`b2cmd`) or the subfile of agreements.

#### Function Key Handling
- **Page Up/Down:** Handled by `bck_subfile` and `crt_subfile`.
- **F6, F21, etc.:** Various maintenance or control actions.
- **Selection:** Subfile lines can be selected (`b1valg = 1`), and selection validity is checked.

---

### Subfile Management Subroutines

#### `forny`
- Refreshes subfile for the current customer and repositions the database.

#### `subfile`
- Handles user interaction with the subfile (toggle subfile page, process selections).
- Sets selection output variables if a valid line is chosen.

#### `clr_subfile`
- Clears and resets subfile counters and indicators.

#### `crt_subfile`
- Populates the subfile with card agreements for the current customer.
- Applies business rules (e.g., only list cards with correct authorization, special product filtering).

#### `bck_subfile`
- Moves back a page in the subfile.

#### `dsp_subfile`
- Controls display of the subfile; enables indicators for subfile display records.

#### `avt_type`
- Sets a human-readable text description for the card/agreement type, depending on code (e.g., VISA, MAXBO, BM Kort, Santander).

#### `sjk_kort`
- Checks for the existence of special card types (BM Kort, Maxbo, Santander) for this customer.
- If such a card is found and passes business/authorization check, it sets output parameters and selection flags.

---

## 6. Program End

- The program exits (with LR indicator on) after selection or function key exit.

---

## 7. Notes on Indicators

- Indicator use is old-style RPG but very common:
    - **LR**: Last record indicator, signals program end.
    - **IN10**, **IN11**: For page up/down.
    - **IN12-IN15, IN21/IN22**: Display/subfile control and cursor placement.
    - **IN30+**: Field protection and error signaling.

---

## 8. Versioning and Maintenance

Version and change history are included at the top in comments (lines starting with numbers like "6.10", "8.00", etc.). Each version details who made the change, when, and a summary.

---

## 9. Business Rules

- Only shows cards of types 3, 4, 5 (MAXBO, Santander, BM Kort) if they have the correct authorization (`rukobl = 1`).
- Cards without sufficient authorization are skipped.
- When selecting, only these types are considered valid for selection.

---

## 10. Typical Program Flow

1. **Startup:** Parameters received. Subfile filled for the current customer.
2. **Display:** Subfile shown, user can page up/down, select, or exit.
3. **Selection:** If a valid card/agreement is selected (and passes filtering), parameters are set for return.
4. **Special Card Handling:** If the user exits without selection, the system checks automatically for special cards (BM Kort, Maxbo, Santander) and, if found, returns their info.
5. **Exit:** Program ends, returning selection info via parameters.

---

## 11. Language and Terminology

- Many variable and comment names are Norwegian:
    - **kort:** card
    - **kunde:** customer
    - **avtale:** agreement
    - **felt:** field
    - **navn:** name
    - **obligatorisk:** obligatory/authorization

---

## 12. Summary Table of Main Variables

| Variable         | Purpose                                   |
|------------------|-------------------------------------------|
| p_firm           | Input: company code (parameter)           |
| p_kund           | Input: customer code (parameter)          |
| p_kpro           | Input: product code (parameter)           |
| w_firm, w_kund   | Working variables for current firm/cust.  |
| rukrl1, rukrl5   | Card agreement files (current/special)    |
| b1sfl (subfile)  | Subfile for display/selection             |
| b_valg_ok        | Flag: selection made/valid                |
| ruktyp           | Card/agreement type                       |
| rukobl           | Authorization flag                        |

---

## 13. Modernization Notes

- This is a classic, indicator-driven RPG program. Modern RPG IV (free-format) would improve readability and maintainability.
- Heavy use of subfiles for display, selection, and paging is very typical of IBM i green screen applications.

---

## 14. Onboarding Tips

- Review the data files used (`rukrl1`, `rukrl5`, `rkunl1`) for field definitions.
- Understand the Norwegian terminology or work with a native speaker for business rules.
- Test the program in a controlled environment to see subfile behaviors.
- Consider modernizing indicator logic to named variables if enhancing the program.

---

**In summary:**  
This RPG program allows a user to browse and select among a customer’s card/account agreements, with business logic to ensure only authorized/valid agreements are shown or returned. Subfiles are managed for fast and user-friendly screen navigation, with careful handling of special card types such as BM Kort, Maxbo, and Santander. The code is mature, well-documented, and follows traditional IBM i programming patterns.