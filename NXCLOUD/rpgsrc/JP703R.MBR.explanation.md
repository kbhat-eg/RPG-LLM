# Documentation for Program JP703R (ASVADM System)

## Overview

**Program:** JP703R (Copy of JP701R)  
**Purpose:**  
This program processes and updates commercial terms ("betingelser") and discount elements ("rabattelementer") from XML import files (NOBB Kontrakt), updating the internal database accordingly. It manages terms and discounts for suppliers, ensuring that obsolete or non-updated conditions/discounts are removed when supplier relationships change.

**Key Business Rules:**
- When a supplier relationship is broken, all "non-own" conditions and associated discount elements not updated for the "previous" supplier are deleted.
- When a supplier relationship is broken, all "non-own" discount elements for the supplier are deleted.
- Handles both standard and price group-specific processing.

**Domain Context:**
- The system is part of the ASVADM solution, dealing with purchasing/contract management, particularly for building materials (NOBB standard).
- File naming and field naming conventions reflect Norwegian business terms (e.g., "betingelse" = condition/term, "rabattelement" = discount element, "leverandør" = supplier).

---

## File Definitions and Data Flow

### Input Files (XML Import)
- **JBEIPF / JRAIPF**: Imported from XML; contain new/updated terms and discount elements.

### Master and Work Files
- **JVARL3, RA30L1**: Reference and lookup files for items and price groups.
- **JBETL1, JBETLA, JBETLU**: Main condition/term files (read, alternative, update).
- **JBEWL1, JBEWLA**: Backup files for conditions (used for change detection).
- **JRAELU, JRAWL1**: Discount element master and backup.
- **JWRKPF**: Work file for logging changes.

### Data Area
- **LDA**: Used to retrieve current user and firm.

---

## Main Processing Logic

### Initialization
- Retrieves current date and time for change tracking.
- Reads parameters: `p_firm` (firm/company), `p_ldor` (supplier id).

### Main Steps

1. **Read and Update Conditions ("betingelser")**
    - Iterates through imported conditions (`JBEIPF`), updating or creating records in main files.
    - Uses subroutine `oppdat_bet` for each record.

2. **Delete Obsolete Conditions/Discount Elements**
    - If not the first run, deletes any "non-own" conditions and discount elements for the previous supplier that were not updated in the current run.
    - Uses subroutine `slett_gamle`.

3. **Read and Update Discount Elements ("rabattelementer")**
    - Iterates through imported discount elements (`JRAIPF`), updating or creating records.
    - Uses subroutines `oppdat_rae` (standard) and `oppdat_rae_pg` (per price group).

4. **Program End**
    - Sets *INLR to *ON and returns.

---

## Subroutine Details

### `oppdat_bet` — Update/Create Condition

- Clears the update buffer.
- Chains against existing records using a composite key (firm, supplier, groupings, etc.).
- If record not found, attempts to find an alternative (`JBETLA`).
- Updates or creates the condition.
- Saves values to work variables for possible price group processing.
- For each price group (from `RA30L1`), may create/update additional conditions if required (see `sjekk_prgr_be`).

### `slett_gamle` — Delete Obsolete Conditions/Discount Elements

- Loops through all conditions for the supplier.
- If not updated in the current run (date/time mismatch), deletes the condition and all related discount elements.
- Only "non-own" (status = 0) records are deleted.

### `oppdat_rae` — Update/Create Discount Element

- On first run, deletes all "non-own" discount elements for the supplier.
- Checks if a corresponding condition exists before creating a discount element.
- Populates fields using both import data and program context.
- Writes the new discount element.

### `oppdat_rae_pg` — Update/Create Discount Element per Price Group

- For each price group (`RA30L1`), checks if a matching condition exists and creates a discount element accordingly.

### `upd_rae_key` — Delete Old Discount Elements for Price Group

- Deletes all "non-own" discount elements for a specific price group/line number combination.

### `sjekk_endr`, `sjekk_prgr`, `sjekk_prgr_be` — Change Detection

- Compare current and backup files to detect changes or previous existence of price groups.
- Used to determine if a record should be considered new or changed, and if it was previously activated.

### `skriv`, `skriv_head` — Logging

- Write change information to the work file (`JWRKPF`), including status ("new" or "changed").
- `skriv_head` writes a header row.

---

## Key Design Considerations

### 1. **Composite Keys**
   - All updates, deletions, and lookups are based on complex composite keys reflecting business entities (supplier, groupings, item, type, line, etc.).
   - Consistency of key construction is crucial for data integrity.

### 2. **"Non-own" Status**
   - The program only deletes or overwrites records with status = 0 ("ikke egne" = not own).
   - This protects manually maintained or system-critical records.

### 3. **Change Tracking**
   - Date and time fields are used to track which records were updated in the current run.
   - This enables safe deletion of obsolete records.

### 4. **Price Group Handling**
   - Special logic handles conditions and discount elements per price group.
   - Ensures that price group expansions (from 1 to 2 positions) are supported (see version notes in comments).

### 5. **Backup/Change Detection**
   - Backup files are used to compare current and previous states, enabling change logging and detection of prior activations.

### 6. **Separation of Concerns**
   - Subroutines are used for each significant action: updating conditions, updating discount elements, deletion, change detection, logging, and initialization.

---

## File/Module Interactions

- **XML Import Files (`JBEIPF`, `JRAIPF`)**: Source of new/updated data.
- **Master Files (`JBETL1`, `JRAELU`)**: Main tables for conditions and discount elements.
- **Backup Files (`JBEWL1`, `JRAWL1`)**: Used for change detection and safe updates.
- **Work File (`JWRKPF`)**: For logging changes, new records, and status.
- **Reference Files (`JVARL3`, `RA30L1`)**: For item and price group lookups.

---

## Naming and Versioning Conventions

- **Field and variable names** are Norwegian abbreviations of business concepts.
- **"x" suffixes** (e.g., `xpldor`, `xpogrp`) denote fields from the XML import (input).
- **"w_" prefixes** indicate work variables (intermediate storage).
- **"b_" prefixes** are boolean flags.
- **Version markers** (e.g., `6.3x`, `6.31`) in comments indicate historical changes or enhancements, especially for price group expansion.

---

## Error Handling and Edge Cases

- **No explicit error handling** for file I/O errors; assumes all files are available and accessible.
- **Records not found** during chain operations are handled by conditional logic (skip, leave subroutine, or create new).
- **Blank/zero values** are used to indicate missing or defaulted fields.

---

## Typical Flow Example

1. **Import XML files** for supplier conditions and discount elements.
2. **For each imported condition:**
   - Update or create the condition in master files.
   - If price group logic applies, handle additional records.
3. **Delete** any old "non-own" conditions and discount elements for the supplier that were not updated.
4. **For each imported discount element:**
   - Update or create the discount element, if corresponding condition exists.
   - For each price group, repeat as needed.
5. **Log** all changes and new records to the work file.

---

## Integration Points

- **External XML Import**: Data must be pre-processed into the expected import files.
- **Downstream Consumers**: Updated conditions and discount elements are used by other purchasing, pricing, or reporting modules.
- **Audit/Reporting**: Work file can be used for auditing or user feedback.

---

## Key Takeaways for New Developers

- **Understand the domain:** Supplier terms and discounts are central to the business.
- **Pay attention to key construction:** Consistency is vital.
- **Be aware of the "non-own" logic:** Only certain records are eligible for deletion.
- **Change tracking is time-based:** Be careful with date/time logic.
- **Backup files are integral:** Used for both safety and change detection.
- **Handle price groups carefully:** There is special logic for these scenarios.
- **Follow existing naming and structure conventions:** This aids maintainability and reduces risk.

---

## Reference: Key Business Terms

- **Betingelse**: Commercial term/condition
- **Rabattelement**: Discount element
- **Leverandør**: Supplier
- **Prisgruppe**: Price group
- **Vare**: Item/product
- **Gruppe**: Group (Ogrp = main, Hgrp = sub, Ugrp = sub-sub)
- **Modul**: Module (business area)
- **Linjenr**: Line number
- **Regel**: Rule
- **Verdi**: Value

---

## Contact

For further clarification on business rules or technical integration, contact the ASVADM application owner or the responsible business analyst.