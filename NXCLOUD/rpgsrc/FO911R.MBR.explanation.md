# Explanation of the RPG Source Code for FO911R: "Utskrift av Tilbud"

---

## Overview

This RPG/400 (ILE RPG, fixed-format) program is named **FO911R** and is designed for printing quotations ("tilbud") in a Norwegian ERP system. The program reads order data, customer data, product lines, and various associated files, then produces a formatted quotation printout. It contains enhancements for VAT handling, phone/fax/mobiles, email, and more.

The program uses many external files (DISK, PRINTER), arrays, data structures, and subroutines.

---

## Main Sections

### 1. **Header Specifications (`H`)**
- **H/TITLE**: Sets the program title.
- **option(*nodebugio)**: Disables debug for I/O operations.
- **decedit('0,') datedit(*dmy.)**: Controls numeric and date output format.

### 2. **Change History**
The comments below the header document changes to the program by version, developer, and date.

---

### 3. **File Declarations (`F`)**

- **DISK Files:** Many files are declared for order headers (FOHEL1), order lines (FODTL1), customers (RKUNL1), etc., with `RENAME` to local names.
- **PRINTER File:** FFO911P is for print output.
- **Other Files:** For fetching price codes, VAT types, delivery types, etc.

---

### 4. **Data Structure & Variable Declarations**

#### Arrays (for handling multiple VAT rates)
```rpg
d mko             s              1    dim(9)
d msa             s              5  2 dim(9)
d mgr             s             11  2 dim(9)
d mbe             s             11  2 dim(9)
d mog             s             11  2 dim(9)
d mor             s             11  2 dim(9)
```
- `mko`: VAT codes
- `msa`: VAT rates
- `mgr`, `mbe`, `mog`, `mor`: Totals per VAT code/category

#### LDA (Local Data Area) Fields (for print control, routines, etc.)
```rpg
D  l_prfi               750    750  0
D  l_ruti               800    809
D  l_outq               810    819
D  l_alin               856    858  0
D  l_firm               944    946  0
```

#### Program Parameters (for email, customer, etc.)
```rpg
d p_mail          s              1
d p_kund          s              6  0
d p_kpro          s              6  0
d p_numm          s              8  0
d p_selg          s              4  0
```

#### Miscellaneous working variables
Many, e.g., for address lines, telephone numbers, VAT calculation, etc.

---

### 5. **Input Specifications (`I`)**

Most of the input is through externally described files (defined in `F`).

---

### 6. **Control Cycle**

Execution starts with a cycle indicator (`01FCYCLE`). The main logic is organized around a cycle for each record.

---

### 7. **Main Logic with Tags**:

For each record (input line identified by `FKSKOD`):

- **'H'**: Order header – TAG01
- **'V'**: Order line (product) – TAG02
- **'K'**: Comment/text line – TAG03

Each "TAGxx" label contains logic for handling that type of line.

---

#### **TAG01: Order Header Handling**

- **Resets** variables for totals.
- **Fetches order header** from FOHEL1R using composite key.
- **Formats dates** for output.
- **Fetches customer data** and fills address fields from RKUNL1R.
- **Checks if this order is a "quotation customer", in which case it uses alternative customer/address fields.**
- **Looks up VAT codes** and other payment/handling info.
- **Fetches delivery address, if exists.**
- **Fetches reference fields (customer reference, delivery method, requisition, etc.)**
- **Fetches phone, fax, and mobile numbers** (using a subprogram).
- **Overrides mobile from order header if available.**
- **Fetches and fills company/department info** if configured, via subprogram FØ707R.
- **Handles printing of heading lines** (A1HDR, A2HDR, etc.) to document.

---

#### **TAG02: Order Line/Product Line Handling**

- Resets product line variables.
- Fetches detail line from FODTL1R.
- Fetches line type text from VLTYL1R.
- Skips lines of certain types (controls which order lines print).
- Fetches product info from VVARL1R.
- If product is from LVR file, sets decimals to 2 as standard.
- Handles output quantities with the correct number of decimals.
- Sets up product numbers, names, units, and price.
- Calculates **line discounts** (multiple discounts combined).
- Calculates **net and gross prices**, discounts, and accumulates totals.
- Handles VAT (calls subprograms and updates arrays).
- Adds line to transfer sum.
- Handles special flags for lines not included in order discount.
- Writes product line to print (D1DET).
- Handles overflow (XOVRFL subroutine).
- Handles secondary text lines for products (if present).

---

#### **TAG03: Text Line Handling**

- Fetches text line from FOTXL1R.
- If not collecting, skips lines above 5000.
- Moves text to print fields, writes to document (E1DET).
- Checks for overflow.

---

#### **T1TOT: End-of-order Handling (Totals)**

- Calculates net total, VAT, and discount totals.
- Writes the totals line (T1TOT).
- For multiple VAT rates, outputs separate lines (arrays).
- If uncollected text lines (normally not printed earlier), prints them now.
- Manages page overflow.

---

### 8. **Subroutines**

#### **SBBETB:**  
Fetches and sets payment terms text using subprogram 'FØ703R'.

#### **XOVRFL:**  
Handles print page overflow by outputting overflow lines and reprinting headings.

#### **XARRAY:**  
Handles array update for VAT codes and totals per VAT rate:
- If VAT code slot found, updates code/rate and aggregates amount.
- Handles the effect of order discounts per VAT band.

#### **XSTRSR:**  
Startup routine:
- Initializes variables.
- Looks up customer offer number.
- Checks for negative order type.
- Resets VAT-related arrays to zero.
- Prepares environment for each print.

#### **INZSR:**  
Initialization at program start:
- Reads input parameters.
- Defines field equivalence via `LIKE`.
- Resets variables and working storage.
- Prepares file keys (KLISTs) for file lookups.
- Fetches message/header text.
- Sets email flag, if relevant.

---

### 9. **File Keys (`KLIST`)**

Many keys are defined at the bottom, each for efficient file access to various lookups through composite keys (e.g., company + order number, line number, etc.)

---

## Notable Features & Comments

- **Multi-VAT Handling**: The program supports multiple simultaneous VAT rates per quotation.
- **Email Integration**: If the destination is an email queue, will output as email.
- **Dynamic Address/Reference Handling**: Handles both customer and delivery addresses, contact references, and supports multiple fields per heading.
- **Subprogram Use**: Fetches external data/texts and performs VAT lookups via calls to other RPG programs.
- **Language/Messages**: Much of the program's field and variable naming is in Norwegian.
- **Overflow & Paging**: Careful handling of print line overflow, with repeated headings if needed.
- **Discounts**: Supports both line and total order discounts (including compound discount logic).
- **Enhancements & Maintenance**: The program has been patched and extended over decades, shown by the detailed change log in comments.

---

## Getting Started as a Developer

- **Familiarize yourself with the file and field names** (much is in Norwegian; e.g., KUND = customer, VARE = item/product, STED = place/city).
- **Understand the print formats** (A1HDR, D1DET, T1TOT, etc.) and how the code fills their fields.
- **Study the subroutine structure**: Most logic is grouped in classic RPG subroutines (`BEGSR`/`ENDSR`).
- **The program is designed to be driven by input records**: Each input "type" is processed according to its tag.
- **VAT, discounts, and text handling** are the "hard" business logic parts.
- **Calls to external subprograms ('FØ703R', 'RS205R', 'FØ707R', etc.)** are used for fetching or calculating data not available in the main files.
- **Program parameters** are used mainly for integrating with email output.

---

## Key Points to Remember

- All business logic is built around reading order, customer, and product data and building a printable quotation document.
- Locale-specific details (Norwegian business, tax, and print formats) are deeply embedded.
- Many enhancements are conditional, based on LDA flags or parameter settings.
- Overflow management and print formatting are crucial for correct output.
- Documentation (through comments) is rich and describes both the technical and business intent.

---

## Useful Norwegian-English Translations

- **Tilbud**: Quotation/Offer
- **Kunde**: Customer
- **Vare**: Product/Item
- **Adresse**: Address
- **Telefon/Fax/Mobil**: Phone/Fax/Mobile
- **Rabatt**: Discount
- **Mva**: VAT (Value-Added Tax)
- **Levering**: Delivery
- **Rekvisisjon**: Requisition
- **Referanse**: Reference
- **Sum**: Total
- **Tekst**: Text
- **Ordre**: Order

---

## Final Notes

- You will need to refer to file definitions (DDS) and called subprograms for full details.
- Changes are version-tagged for traceability.
- The code is procedural and largely follows older RPG paradigms, but modular enough for step-by-step troubleshooting.

---

**If you need to onboard to this code, start by tracing execution for a sample order, examining how each section (header, line, comments) is handled and how the print file (FFO911P) is populated.**