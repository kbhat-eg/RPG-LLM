# High-Level Overview

This RPG program (`rp300R`) is an interactive maintenance program for project data. The code provides a green-screen interface (5250 terminal) for managing projects, sub-projects, and activities, as well as associated metadata such as project leader, department, and budgets. The main interface is a subfile, allowing the user to scroll, create, update, copy, and delete project records, and view financial summaries.

It is written in ILE RPG (mostly fixed-form with some free-form expressions), uses a number of physical and logical files, and follows common RPG idioms such as indicator variables and subroutines.

---

# Key Components and Data Flow

## File Declarations

### Physical and Logical Files

- Several files (`rpxll1`, `rpxllr`, `rpxllu`, `rp1plu`, `rp2ulu`, `rp3alu`, `rkunl1`, `ilonl1`, `ra07l1`, `ra09l1`, `rprrl1`, `rhtrlc`, `fusrl1`, `ausrl1`) are defined for reading and updating project, customer, department, and reporting data. These files are renamed upon open for RPG naming consistency.
- The main workstation display is defined as `rp300d`, using a subfile (`b1sfl`) for listing items with `w_srrn` as the subfile record number.

## Indicators

- *LR*: Last record - end of program.
- *in10*, *in11*, ...: Standard program function keys (RollUp, RollDown, etc.).
- *in21*, *in22*, *in30*, *in31*–*in79*: Soft indicators signaling screen states and error conditions.
- *in80*–*in99*: Work indicators.

## Data Structures and Variables

- Fields for local data area (user, firm, name).
- `dspfbk`: Display feedback data structure for cursor position.
- Per-file key work fields, used for chaining (random access) and updates.
- Working variables for pagination, subfile display, current page/record, and temporary fields.
- Financial summary work fields.

## Constants

- `lo` and `up`: Lower/upper-case transformation lookup.
- `c_sfil`: Constant defining subfile page size.

---

# Main Program Control

## Program Entry and Main Loop

- The program starts by initializing (`*inzsr`) local variables, keys, subfile layouts, and setting up the display.
- Control is centered on two tags: `b2taga` (full screen) and `b2tagb` (subfile), alternating between displaying various screens and processing user input.
- `write b2cmd` and `exsr dsp_subfile` are used to show command and subfile screens.

## Function Key Processing

- The main screen loop uses `select` to branch on function keys (e.g., *F3/F12: exit; F5: refresh subfile; F6: add new; F10: refresh; F21: position cursor, etc.).
- Action keys may call out to subroutines or external programs (e.g., project import, maintenance, etc.).

---

# Subfile Handling

## Subfile Population (crt_subfile, clr_subfile)

- Records for the subfile are read from `rpxll1` (main project file).
- For each record, work fields are populated, including description, dates, user, financials, and error states.
- Subfile records are written out and indicators/fields reset.

## Subfile Display (dsp_subfile)

- The program determines if the subfile has content and sets indicators to control screen display.
- The `b2ctl` control record is formatted/edited for the user.

## Subfile Interaction (subfile)

- Reads user actions from the subfile (selected record/action).
- Actions include edit, copy, delete, and view – each handled in turn.
- After each action, the appropriate subroutine is called, and the subfile is updated.

---

# Key Subroutines

## forny (Refresh)

- Repositions the database cursor to the relevant key.
- Clears and recreates the subfile listing.

## posisjoner (Positioning)

- Allows the user to jump to a specific project.
- Rebuilds the subfile starting from the selected project.

## xc1bld (Add New Record)

- Handles user entry of a new project/subproject/activity.
- Validates that the record does not already exist.
- If record exists, displays an error message (`xc1msg`).
- On successful validation, calls `xc2bld` for further editing.

## xc2bld (Edit/View Record)

- Handles the full edit/view logic for the selected level (project, subproject, activity).
- Displays appropriate screen headings and fields.
- Loads master data (department, project leader, customer info) via lookups.
- Validates all required input fields.
- If validation passes, updates or creates the corresponding records.
- Loops through phases: Project → Subproject → Activity as needed.

## xd1win (Delete Record)

- Reads the selected record.
- Confirms and then deletes if approved.

## xk1win (Copy Record)

- Loads the source record.
- Performs field validation and uniqueness check.
- Allows the user to edit before confirming the copy.

## reddato (Edit Date)

- Parses and validates date input in various formats (ddmmyy, yymmdd, dd.mm.yy, yyyy-mm-dd, etc.).
- Converts and stores the date in ISO format if valid.

## finn_sum (Compute Project Sums)

- For the selected project, calculates total financial inflows (income), outflows (costs), and displays summary in the subfile.
- Loops over various accounts/segments to aggregate data from the report and transaction files.

---

# Integration with Other Programs

- Calls to external programs for data lookups:
  - `'RP603R'`, `'RA509R'`, `'RA507R'`, `'RK500R'`: for project leader, seller, department, customer lookups.
  - `'RP510R'`: for project postings/inquiry.
  - `'RP700C'`: for importing projects from Excel.

---

# Error Handling and Messaging

- Uses subfiles and screen indicators to relay errors (e.g., validation failures, missing required fields, duplicate records).
- Extended validation to prevent inappropriate data entry based on business rules (e.g., cannot set budgets if subprojects/activities used).

---

# Comments and Documentation

- Extensive inline Norwegian comments and explanations.
- Specific documentation of indicator usage and field functions.
- Explanation of subfile navigation/pagination logic.

---

# Program Initialization (`*inzsr`)

- Defines key lists for all file access.
- Loads user/firma (company) info.
- Sets up subfile display and populates the initial list for the user's context.

---

# Summary Table

| Subroutine / Tag  | Functionality |
|-------------------|--------------|
| forny             | Refresh subfile from DB                   |
| posisjoner        | Jump/position to specific project          |
| subfile           | Process subfile input/actions              |
| xc1bld            | Add new record (launch C1 screen)          |
| xc2bld            | Edit/view record (C2 screen)               |
| xd1win            | Delete record (D1 window)                  |
| xk1win            | Copy record (K1 window)                    |
| reddato           | Parse/validate date input                  |
| finn_sum          | Compute financial summary                  |
| clr_subfile       | Clear subfile display                      |
| crt_subfile       | Repopulate subfile display                 |
| dsp_subfile       | Display/format subfile                     |
| *inzsr            | Program initialization                     |

---

# Key Business Objects

- **Projects** (`rp1plu`): High-level grouping, may have budgets, leaders, periods.
- **Subprojects** (`rp2ulu`): Subdivisions under projects.
- **Activities** (`rp3alu`): The most granular elements under subprojects.
- **Associated Data**: Department, project leader, customer, financial data.

---

# Takeaways for Onboarding

- **Navigation is via subfiles**, with standard RPG green-screen keys for paging, selecting, and actions.
- **CRUD operations are distributed over dedicated subroutines**. Adding, editing, copying, deleting records are each encapsulated for clarity.
- **Validation logic is built in at each step**. Users are prevented from entering invalid/missing data at every stage.
- **File access relies on key structures**. All access to primary files is by key-list (KLIST/KFLD), a traditional RPG pattern.
- **Financial summary computation is inline and custom**, aggregating data from multiple sources/files for display.
- **External programs are leveraged to look up related data**, keeping the code modular.

---

# Tips for Developers

- Understanding indicator usage (`*inxx`) is crucial for following program flow and UI logic.
- Pay attention to the key fields and data structures; changing file layouts may require updates across multiple parts.
- Subfiles are used for both display and user interaction; knowing how records are read, changed, or rolled through is essential.
- Validation and error handling are extensive; new business logic should follow these patterns.
- Norwegian comments are helpful but be ready to reference field/file layouts if unfamiliar with business terms.

---

# Conclusion

This program is a robust, traditional RPG application for project control, supporting detailed, interactive manipulation of project data via subfiles and green-screen forms, compliant with business validation and reporting requirements. Its structure is typical of legacy RPG with well-documented code, explicit field handling, and subroutine-based modularization.