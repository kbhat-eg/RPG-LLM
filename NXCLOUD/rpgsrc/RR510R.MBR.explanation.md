# RPG Program RR510R - Explanation

## General Purpose

This program (`RR510R`) is part of an accounting or reporting system—likely for financial results—supporting querying and reporting of balances (saldi) and related summary or detail information. It handles subfile (scrolling/paging) display, user interaction (key handling), and dynamic calculation of values for selected years, periods, and departments.

The code contains significant comments in Norwegian, and variable names are highly thematic to financial reporting (e.g., saldo, prosent, differanse, etc.).

---

## Key Structures and Components

### 1. **Header and Options**
- `h option(*nodebugio) datedit(*dmy)`
  - Disables debug I/O.
  - Default date format: day/month/year.

### 2. **File Definitions (`F-Specs`)**
- **rrf0l1, rrf9l1, rrf9l2, rrf9l3**: Logical files over disk data, each renamed to a unique record format for easier coding.
- **rr510d**: Display file for subfile I/O, using subfile `b1sfl` with record number `w_srrn`.

### 3. **Data Structures (`D-Specs`)**
- **Arrays**
  - `txt`: Array of 9 texts (likely headings or labels), filled from compile-time data (see bottom of source).
  - `isa`, `wrk`: Arrays of financial values, possibly by period/month.

- **Local Data Area (LDA)**: Used to retrieve session-specific data like user, firm, etc.
  - Variables like `l_user`, `l_firm`, etc. point to offsets in the LDA.

- **Key Variables**: Used for building keys for file access (`chain`, `setll`, `reade`, etc.).

- **Work Variables**: For subfile navigation, status, and calculations (e.g., `w_stel`, `w_spge`, `w_srrn`, etc.), as well as for financial calculations (`saml`, `diff`, `pros`, etc.).

- **Constants**: `c_sfil = 12` (subfile page size).

---

## Indicator Usage

- Traditional RPG indicators (`*INxx`) are used for subfile and UI logic:
  - `*INLR`: Last record indicator, ends program.
  - `*IN10`–`*IN15`: Subfile/page logic.
  - `*IN21`–`*IN22`: Home/cursor placement.
  - `*IN30`: Field protection.
  - `*IN31`–`*IN79`: Warnings/field highlights.
  - `*IN80`–`*IN99`: Work indicators.

---

## Main Program Logic (C-specs)

### **Basic Flow**

1. **Initialization (`*INZSR`)**
   - Loads keys, firm from LDA, initializes years/periods, and subfile page.
   - Sets up default report type, columns, and headings from `txt` array.
   - Loads main report text.
   - Initializes subfile via `crt_subfile`.

2. **Main Display Loop:**
   - Uses a subfile control record (`b2ctl`) for main menu/display.
   - Handles function keys for exit, refresh, paging, and filter changes (e.g., year/column/department).
   - Calls subroutines for subfile logic, paging, and filter processing.

3. **Subfile Processing:**
   - Reads and processes subfile records (`readc b1sfl`), handling detail/summary display based on `w_sude` and user selection.

4. **Display and Field Processing**
   - Handles the actual display and field protection for different modes (via `dsp_subfile`, `clr_subfile`, etc.).

5. **Calculation and Data Handling**
   - Summarizes, accumulates, and calculates balances, differences, and percentages for multiple columns (years, budgets, types, etc.).
   - Subroutines like `beregn_sum` and `brukt` handle the math.

---

### **Major Subroutines**

#### 1. **forny (renew)**
- Repositions and rebuilds the subfile when filter/criteria change (like year, period, etc.).

#### 2. **posisjoner (position)**
- Positions the subfile to a specific line or department for the next display (based on user navigation/filter).

#### 3. **subfile**
- Handles user interaction with the subfile window (reading and updating records, handling actions).

#### 4. **xc2bld/c2bld**
- Builds and displays a detail record window.
- Handles navigation (previous/next year, balance/movement switch) and updates on user actions.

#### 5. **crt_subfile**
- Fills the subfile with records according to the current positioning, filters, and display mode (summary or detailed).
- Handles calculation per record.

#### 6. **clr_subfile**
- Clears subfile indicators and working variables, preparing for a fresh build.

#### 7. **bck_subfile**
- Handles "paging back" in the subfile logic.

#### 8. **dsp_subfile**
- Displays the subfile control record, preparing for user input.

#### 9. **beregn_sum**
- Calculates sums for the current period and year-to-date ("hittil i år") for the account/line.

#### 10. **brukt**
- Calculates percentage difference for reporting.

#### 11. **nullstill**
- Resets/zeroes all accumulator fields used in display pages and calculations.

#### 12. **xkolon**
- Sets column headings and types for display, using the `txt` array for labels, and filling in the selected years.

---

## Data and Array Redefinition

Special sections repeatedly map file fields into arrays (e.g., `isa(1)`, `isa(2)`, etc.) for simplified math across periods in key subroutines. This pattern is repeated for all subfile record structures.

---

## Compile-Time Data

At the end, the `txt` array is loaded with Norwegian headings/labels:
```
Spørring på saldo           001
Sum alle avdelinger         002
Ledig ...                   003
Ledig ...                   004
Regnskap                    005
Budsjett                    006
Alt.buds                    007
Differanse                  008
Brukt/oppnådd               009
```
These map to menu or column headings in the display.

---

## Summary

- **Purpose:** Interactive reporting and query of financial balances, supporting summary and detailed views by year, period, department.
- **UI:** Subfile-driven display with navigation and filter options (via function keys).
- **Logic:** Reads appropriate records, computes results per user selection, maintains subfile paging/navigation, and handles all calculation for balances, differences, and percentages.
- **Data Handling:** Heavy use of arrays and subroutines to decouple file access from presentation/calculation.
- **Internationalization:** Uses Norwegian for comments, prompts, and headings.

---

## Onboarding Tips

- **Indicators:** Old-style RPG indicators are heavily used; be familiar with their meaning and uses.
- **Arrays for Periods:** Data is grouped per period in arrays for fast calculation.
- **Subfiles:** Understand how subfiles are used for paging and user interaction.
- **Key Management:** Key lists (`klist`) are used for database access; follow the key build-up logic in `*inzsr`.
- **Customization:** Column types (Regnskap, Budsjett, etc.) and years can be dynamically set by user actions.
- **Adding Features:** Add new types/headings by updating arrays and supporting logic as needed.

---

### **If You’re New to ILE RPG**
- Brush up on indicator usage and subfile display logic.
- Get used to chain/read/setll/readp functions for database processing.
- Understand how arrays map to file fields for ease of financial calculations.
- Note that much of the interaction is function-key driven rather than menu-based.

---

## Conclusion

This program provides a classic subfile-based interactive reporting/query solution in RPG, using structured logic and clear financial concepts. With proper understanding of the subfile mechanism and indicator-driven flow, you'll be able to maintain and extend this codebase.