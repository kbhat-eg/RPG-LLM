```markdown
# RPG Program RK513R - Customer Entry Inquiry

This RPG (Report Program Generator) program is designed for IBM i (AS/400) systems and implements a subfile-based, interactive display for customer voucher (bilag) inquiries. Below is a breakdown and explanation of the code and its functions to help developers understand and maintain it.

---

## Overview and Metadata

- **System**: ASOKON
- **Program**: RK513R
- **Description**: Customer entry inquiry (view and interact with accounting/voucher records for customers).
- **Change Log**: Many revisions have been made, indicating ongoing enhancements related to archive access, document type retrieval, display improvements, and logic for voucher references.

---

## Header (`H` spec)

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Disables debug I/O operations for performance.
- `datedit(*dmy)`: Sets date editing to Day/Month/Year format.

---

## File Declarations (`F` spec)

- **Physical and Logical files** are declared for reading/writing customer and voucher data:
    - `frktrlc`, `frkunl1`, `frktrl2`, `fraa1l1`: Input files, key access, renamed record formats.
    - `frk513d`: Display file with a subfile (`b1sfl`), and feedback data structure (`dspfbk`).

---

## Data Structures (`D` spec)

### Local Data Area

```rpg
d l_user      911    920
d l_firm      944    946  0
d l_fnav      951    980
```
- Fields mapped from the user space, e.g., user, firm (company number), and perhaps full user name.

### Display Feedback (Infds)

```rpg
d dspfbk      ds
d  d_fcrn    378    379I 0
```
- Used to track the current record number on the display.

### Key Variables

Variables used as keys for file operations (e.g., customer number, voucher number, date, period).

### Work and Display Variables

Variables managing subfile state, selection options, page/record numbers, etc.

### MultiArchive Parameters

Variables for passing company, document types, and other IDs to archive inquiry programs.

### Constants

- `c_sfil`: Subfile page size (number of records per page, set to 13).

---

## Indicator Usage

Classic RPG indicators (*IN fields) are used for program flow, screen control, and error handling. Example mappings:
- LR = End of program
- 10, 11 = Page Up/Page Down
- 12, 13, 14, 15 = Subfile display/clear/end flags
- 21, 22 = Home/cursor positioning
- 30 = Field protection
- 31-79 = Messages, UI indicators
- 80-99 = Work indicators

---

## Subfile and Display Management

### Main Control Flow

Tags (labels) like `b2taga`, `b2tagb` are used for loops and program sections. The main user interaction loop is structured as:

1. Display command screen (`b2cmd`).
2. Display subfile page (`dsp_subfile` subroutine).
3. Handle function keys with `select/when`:
    - *IN KC/L (F3/F12): Exit.
    - *IN KE (Enter): Refresh (`forny`).
    - *IN 10: Next page (`crt_subfile`).
    - *IN 11: Previous page (`bck_subfile`).
    - *IN 21: Move cursor home.
4. Process subfile entries (`subfile` subroutine).

### Subfile Subroutines

- **forny**: Refreshes the subfile. Chains to the current display record, repositions files, and clears & recreates the subfile content.
- **subfile**: Processes each subfile entry, managing toggling, page status, and handling function (View, Show archive) based on user selection.
- **clr_subfile**: Clears subfile display and resets subfile counters.
- **crt_subfile**: Fills subfile with records; reads main data file, populates display fields, increments counters.
- **bck_subfile**: Loads the previous page of the subfile.
- **dsp_subfile**: Handles actual display of the subfile and command screens.

---

## Archive and Document Handling

When the user selects to view attached archive documents (option 9):

- Calls program `AX700R` to verify archive access.
- Calls `AP632R` to obtain the document type based on the voucher code.
    - If found, constructs reference for archive.
    - If not, falls back to legacy logic to infer document type, such as 'FAKTURA' (invoice), 'INNGÅENDE FAKTURA' (vendor invoice), or 'DIVERSEBILAG' (miscellaneous).
- Calls `AP622C` (or optionally `AH720C` for other archive types) with constructed parameters to display the archive document.

---

## Detail Display (`xc2win` Subroutine)

Handles the detailed display for a selected entry in the subfile. Implements the following:
- Chains to the detail record in the customer postings file using a composite key.
- If found, moves detail fields into display variables.
- Optionally looks up and fills text descriptions for department and salesperson.
- Presents the detail screen with EXFMT.

---

## Program Initialization (`*inzsr`)

The *INZSR subroutine initializes the program:
- Defines parameter list (customer number, voucher number, date, period, year).
- Sets key lists for file position.
- Loads and displays initial customer and related voucher data.
- Populates initial subfile page.

---

## Additional Comments

- Code uses classic (fixed-format) RPG IV with subfiles and indicators.
- Comments and tags help trace logic for paging, selection handling, and external calls.
- Program structure is modular, using subroutines for common actions (display, navigation, data refresh).
- Data integrity is maintained by chaining and positioning files before subfile (re)building.

---

## In Short

**RK513R** enables users to page through, select, and view detailed information and attached archive documents relating to customer accounting vouchers in a familiar green-screen subfile interface, supporting both navigation and context-sensitive actions.

---

## Key Workflows

1. **Initialize**: Load customer and starting voucher for the company.
2. **Display Subfile**: Show vouchers related to the customer.
3. **Navigate**: Page up/down, refresh display, position to specific entries.
4. **Select Actions**: View voucher details or call out to archive/document systems.

---

## Onboarding Notes

- Understand classic RPG subfile handling.
- Familiarize yourself with indicator fields and corresponding display file records.
- Review called external programs (`AP622C`, `AX700R`, etc.) for archive/document integration logic.
- Pay attention to key lists for file positioning—these control data access granularity.
- The program is heavily commented for maintainability; leverage comments and change logs.
```
