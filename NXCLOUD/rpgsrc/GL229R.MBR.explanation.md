# RPG Program Explanation – GL229R

This RPG (Report Program Generator) source code is a traditional IBM i (AS/400, iSeries) ILE RPG program designed for historical data deletion and maintenance in a banking/finance context (related to giro/postgiro numbers). Below, the code and its logic are broken down for easier onboarding.

---

## 1. Program Heading and Documentation

The header provides essential program metadata:

- **System:** ASOKON
- **Program name:** GL229R
- **Description:** "Sletter historikk" – Deletes history.
- **Change log:** Details about enhancements and bug fixes.
- **Fields explained:** Date and signature columns, and notes regarding program-specific behaviors.

---

## 2. File Declarations

```rpg
fgavtl2    if   e           k disk
fgbtrl1    uf   e           k disk
```
- `GAVTL2` and `GBTRL1` are physical files (`disk`) accessed by the program.
- `if/uf`: Input Full/Update Full; `e`: externally described; `k`: keyed access.
- Used to read records (and possibly update/delete on GBTRL1).

---

## 3. Data Structures and Variables

### LDA (Local Data Area) Fields

```rpg
d lda            uds
d l_user                911    920
d l_filg                931    933
d l_firm                944    946  0
```
- **lda:** User data structure to interface with the LDA.
- Subfields for **user, file group (filg), and firm number (firm)**.

### Date Structure

```rpg
d                 ds
d dsdato                         8  0
d  dsdat�                        4  0 overlay(dsdato)
d  dsdatm                        2  0 overlay(dsdato:5)
d  dsdatd                        2  0 overlay(dsdato:7)
```
- `dsdato`: Full date (YYYYMMDD, 8 digits).
- `dsdat�`: Year (positions 1–4).
- `dsdatm`: Month (positions 5–6).
- `dsdatd`: Day (positions 7–8).
- Uses overlay for subfielding.

### Working Variables

```rpg
d wpgiro          s                   like(gfgiro)
d wpmnd           s              2  0
```
- `wpgiro`: Work variable for giro number.
- `wpmnd`: Work variable for month.

---

## 4. Main Processing Logic

### Mainline (Start)

```rpg
c     a000          tag
c     key02         setll     gbtrl1
c     key02         reade     gbtrl1                                 60
c                   dow       *in60 = *off
* [loop body]
c                   if        gfdato <= dsdato
c                   delete    gbtrpfr
c                   endif
c     key02         reade     gbtrl1                                 60
c                   enddo
```

#### What Happens Here:
- **Loop:** Iterates over `GBTRL1` file using a key list (`key02`).
- **Condition:** If the `gfdato` (record date) is **less than or equal to `dsdato`**, the record is **deleted**.
- **End of file:** Controlled by indicator `*in60`.

---

## 5. Initialization Subroutine (`*INZSR`)

```rpg
c     *inzsr        begsr
c     *dtaara       define    *lda          lda
* Date calculation logic ...
c                   endsr
```
- **Runs automatically at program start.**
- **Fetches LDA:** Loads user, file group, and firm information.

### Date Calculation

```rpg
c                   eval      dsdat� = 2000
c                   move      uyear         dsdat�
c                   eval      dsdatm = umonth
c                   eval      dsdatd = uday
*
c                   eval      wpmnd = umonth - 1
*
c                   if        wpmnd = 0
c                   eval      dsdat� = uyear - 1
c                   eval      dsdatm = 12
c                   goto      xut
c                   endif
* ... (similar for wpmnd = -1 or -2)
c                   eval      dsdatm = wpmnd
c     xut           tag
```

- **Purpose:** Sets `dsdato` to represent a date one month *before* the current date (from LDA).
- **Edge cases:** Adjusts for beginning-of-year (i.e., if it's January, subtracts a year and sets month to December, etc.).

### Key Lists

```rpg
c     key01         klist
c                   kfld                    l_filg
c                   kfld                    l_firm
c     key02         klist
c                   kfld                    wpgiro
```
- `key01`: For use with `GAVTL2` (file group/firm).
- `key02`: For use with `GBTRL1` (giro number).

---

## 6. Fetch Giro Number for Filtering

```rpg
c     key01         setll     gavtl2
c     key01         reade     gavtl2                                 60
c                   if        *in60 = *on
c                   move      *on           *in40
c                   eval      wpgiro = 0
c                   goto      xslutt
c                   endif
c                   if        gcbgir <> 0
c                   eval      wpgiro = gcbgir
c                   else
c                   eval      wpgiro = gcpgir
c                   endif
* SONEKONTONUMMER (zone account number) logic:
c                   eval      wpgiro = gcskto
```
- **Looks up giro number for the logged-in file group/firm.**
- If not found, sets indicator `*in40` (exit flag).
- Prioritizes bankgironr; else, fallback to postgironr.
- In the final version, always uses `gcskto` (zone account number) instead.

---

## 7. Program End

```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- **Graceful exit:** Closes files, returns.

---

## 8. Notes

- **Indicators (`*inN`):** Classic RPG flag mechanism—*in60 is EOF, *in40 is error/exit required.
- **Dates:** Hardcoded to year 2000 at one point (may be legacy concern).
- **Change History References:**
    - `30011`: Uses `SONEKONTONUMMER` instead of `BANKKONTONUMMER`.
    - `23017`: Fix for year calculation at turn of century.

---

## 9. Summary Flow

1. **Initialization:** Loads LDA, calculates date cutoff (current date minus one month).
2. **Key lookup:** Ensures valid file group/firm; determines proper giro number.
3. **Main loop:** Reads through return file `GBTRL1` and deletes records with date older than cutoff.
4. **Exit:** Closes program, cleans up.

---

## 10. Business Context

- **Purpose:** Cleans up historical transaction records older than one month for a specific giro/postgiro account, based on the user’s current context (file group/firm).
- **Usage:** Maintains lean transactional data on the system; aligns to banking/finance batch operations.

---

## 11. Onboarding Tips

- **Understand indicators:** e.g., *in60 EOF, *in40 error/abort.
- **Familiarize yourself with LDA:** Used for passing user/session context.
- **Review physical files’ layouts:** (`GAVTL2`, `GBTRL1`) for key fields and record formats.
- **Know business rules on giro/account number logic.**

---

This program is a solid example of legacy RPG batch processing for file maintenance in a finance/banking environment.