# MM100R – Matrix for Order Quantity / Safety Time

## Overview

**MM100R** is a central maintenance and inquiry program in the ASLOGI system for managing the matrix of order quantities and safety times for articles (items), suppliers, and groupings. It provides a subfile-based interactive interface for maintaining parameters at different levels of granularity (e.g., assortment, group, supplier, item, warehouse) and supports business processes such as forecasting, copying parameters, and deleting results.

The program is highly interactive, relying on subfile screens, and is tightly integrated with other modules for lookups and validations.

---

## Business Domain

- **Assortment Management:** The program manages parameters (e.g., safety time, order quantity) for items, assortments, groups, and warehouses.
- **Hierarchical Structure:** Supports navigation and maintenance at multiple levels: assortment, overgroup, main group, subgroup, supplier, item, warehouse.
- **Forecasting:** Integrates with forecasting routines for purchase planning.
- **Validation/Lookup:** Connects to master data (items, groups, suppliers, warehouses) for validation and descriptive text retrieval.

---

## High-Level Structure

- **Data Definitions:** Files, data structures, and variables are defined for all relevant entities.
- **Subfile Interface:** Uses multiple subfile screens for listing and editing matrix entries.
- **Command Loop:** Main program loop handles user input, navigation, and subfile operations.
- **Subroutines:** Extensive use of subroutines for modular handling of operations (create, update, delete, copy, forecast, inquiry, etc.).
- **External Module Calls:** Calls to other programs for lookups, validations, and batch processes.

---

## File Usage

- **MMATLx/MMATLR/MMATLU:** Various logical views of the matrix master file, supporting different key structures for flexible access.
- **VOGRL1/VHGRL1/VUGRL1/VVARL1/VSHEL1:** Master files for overgroup, main group, subgroup, item, and assortment, used for lookups and descriptive text.
- **MM100D:** Display file with subfiles and multiple record formats for the interactive UI.

---

## Major Variables and Data Structures

- **Key Variables:** Variables like `mmatl1_vsor`, `mmatl3_ogrp`, etc., are used for building composite keys for file access at different hierarchy levels.
- **Local Data Area (LDA):** Used for user and company context.
- **Subfile Control Variables:** Variables like `w_srrn`, `w_ssrn`, etc., manage the subfile's paging and record navigation.
- **Arrays:** `a_lage`, `a_ltyp` for handling up to 10 warehouse/warehouse-type parameters per matrix entry.
- **Overlay Data Structures:** Used for building parameter lists for external program calls.

---

## Main Functional Flow

### 1. Initialization (`*inzsr`)
- Sets up key lists for all file accesses.
- Reads company/user context from LDA.
- Initializes subfile with the first page of data.

### 2. Main Loop (`b2taga`)
- Displays command screen.
- Calls `dsp_subfile` to display the subfile.
- Handles function keys for navigation, create, copy, delete, forecast, and inquiry.
- Handles positioning based on search fields (assortment, group, supplier, item, warehouse).

### 3. Subfile Operations

#### a. Refresh (`forny`)
- Positions file based on current sequence.
- Clears and rebuilds the subfile for the current context.

#### b. Positioning (`posisjoner`)
- Sets file position based on which search field is filled.
- Supports positioning by assortment, group, subgroup, supplier, item, warehouse.
- Clears and rebuilds the subfile after positioning.

#### c. Subfile Processing (`subfile`)
- Loops through subfile records, handling row-level actions:
    - **Edit (valg=2):** Opens edit screen.
    - **Copy (valg=3):** Opens copy window.
    - **Delete (valg=4):** Opens delete window.
    - **View (valg=5):** Opens view-only screen.
    - **Forecast (valg=7):** Opens forecast window and calls forecast routines.
    - **Result Inquiry (valg=8):** Calls external program for result display.
    - **Delete Result (valg=9):** Calls external program to delete results.
    - **Purchase Statistics (valg=9):** Calls external programs to update statistics.

#### d. Create New Entry (`xc1bld`)
- Opens entry screen for new matrix parameter.
- Validates uniqueness of the combination.
- Calls maintenance subroutine (`xc2bld`) if valid.

#### e. Edit/View Entry (`xc2bld`)
- Loads existing data into the screen.
- Allows update of all relevant fields.
- Handles both update and insert operations, with audit fields.

#### f. Copy Entry (`xk1win`)
- Opens copy window.
- Validates that the target does not already exist.
- Calls maintenance routine to create the new record.

#### g. Delete Entry (`xd1win`)
- Opens delete confirmation window.
- Deletes the record from the matrix.

#### h. Forecasting (`xl1win`)
- Opens forecast window.
- Validates warehouse code.
- Calls external forecast program (`MM731C`).
- Updates matrix entry with forecast result date.

#### i. Delete Result (`xd2win`)
- Opens delete result window.
- Calls external program (`MM401R`) to delete results for the given parameter set.

#### j. Inquiry/Lookup (`spørring`)
- Handles lookups for all key fields by calling appropriate external programs (e.g., `VC500R`, `VG510R`, `VV500R`, etc.).
- Populates descriptive fields for user feedback.

#### k. Text Retrieval (`hent_txt`)
- Fetches descriptive texts for all key fields from respective master files.

---

## Notable Design and Conventions

- **Key List Usage:** Extensive use of `klist` for dynamic key construction, supporting flexible access patterns depending on the search context.
- **Subfile Paging:** Manual management of subfile record numbers and paging logic (`w_srrn`, `w_ssrn`, etc.), supporting both forward and backward navigation.
- **Overlay Data Structures:** Used for parameter passing to external routines, enhancing maintainability and reducing code duplication.
- **Indicator Management:** Consistent indicator usage for function keys, screen states, and error handling. Comments at the top document indicator assignments.
- **Audit Fields:** Automatic update of user/date/time fields on insert/update for traceability.
- **External Program Integration:** Modular validation and lookup, with clear separation of concerns (e.g., master data lookups, statistics updates, forecasting).

---

## External Program Interactions

- **VC500R:** Lookup for assortment.
- **VG510R, VG511R, VG512R:** Lookups for group, main group, subgroup.
- **VV500R:** Lookup for item.
- **RL500R, RS760R:** Lookup for supplier.
- **MM401R, MM503R, MM731C, MM733R, MM745R:** Result management, forecasting, and statistics updates.
- **MM801R, MM802R:** Warehouse and delivery type lookups.
- **RS710R, RA510R:** Warehouse code validation.

---

## Business Rules and Special Handling

- **Unique Matrix Entry:** Prevents creation of duplicate parameter sets (combination of assortment, group, supplier, item, etc.).
- **Parameter Inheritance:** Allows maintenance at various levels (e.g., by assortment, group, item), supporting inheritance and overrides.
- **Forecasting Integration:** Directly launches forecasting routines from the UI, updating matrix parameters with forecast results.
- **Concurrent Access:** Uses update chains and audit fields to ensure data consistency.

---

## Error Handling & User Feedback

- **Screen Indicators:** Used to flag errors (e.g., not found, already exists) and control field protection.
- **Message Screens:** Dedicated record formats for error/information messages.
- **Input Validation:** All key fields are validated via master data lookups before processing.

---

## Key Takeaways for New Developers

- **Understand the Hierarchy:** The matrix can be maintained at multiple levels; navigation and maintenance routines are context-sensitive.
- **External Lookups are Crucial:** Many fields are validated via calls to other programs; know where to look for master data logic.
- **Subfile Logic is Central:** Paging and navigation are manually managed; be careful when modifying subfile-related code.
- **Audit Trails:** All changes are logged with user/date/time for traceability.
- **Indicator Usage:** Be mindful of indicator assignments and their documentation at the top of the source.

---

## Conclusion

MM100R is a robust, central maintenance program for parameter management in the logistics domain, designed for flexibility, extensibility, and integration with a broad suite of supporting modules. Its design supports both detailed and aggregate parameter maintenance, with strong validation and interactive features. When extending or modifying this program, pay close attention to the subfile logic, key construction, and the interplay with external modules for lookups and processing.