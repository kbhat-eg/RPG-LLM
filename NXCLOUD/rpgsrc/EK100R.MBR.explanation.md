# EK100R – Customer Bonus Parameter Maintenance

## 1. Program Purpose  
- Provides a subfile listing of customers eligible for bonuses (categories 310/314).  
- Allows viewing, updating bonus parameters, copying bonus agreements, calculating individual or mass annual bonuses, and printing customer letters.

## 2. File Declarations  
- Customer files:  
  - `frkunlr`, `frkunl1`, `frkunl2` – keyed disk files for customer lookup by number or alphabetic name.  
- Bonus files:  
  - `fekboi1` / `ekboi1r` – original bonus header for read/update.  
  - `fekboiu` – update file for bonus headers.  
  - `fekbei1` / `ekbei1r` – original bonus element (detail) for read/update.  
  - `fekbeiu` – update file for bonus elements.  
  - `fekbtir` / `ekbtirr` and `fekbtiu` – transactions for handling multiple bonus groups.  
- Display file:  
  - `fek100d` – workstation file with subfile record (`B1SFL`) and control record (`B2CTL`).

## 3. Indicators Usage  
- LR = end program.  
- 10/11 = roll up/down in subfile.  
- 12–15 = subfile display/control flags (e.g., `*IN12` to `*IN15` for display or clear).  
- 21 = Home key. 22 = cursor positioning.  
- 30 = protect fields.  
- 31–79 = error/warning indicators.  
- 80–99 = work indicators (e.g., toggle “show only bonus-eligible”).

## 4. Data Structures & Variables  
- **Local Data (LDA)**: `l_dato`, `l_user`, `l_firm`, `l_fnav` – hold user, firm, text buffers from LDA.  
- **Info DS (`dspfbk`)**: captures display feedback in `d_fcrn` (first record number returned).  
- **Work fields** for subfile paging:  
  - `w_fcrn` = first record on current page  
  - `w_srrn` = relative record number  
  - `w_spge` = page size increment  
  - `w_sfrn` = first record number on last page  
  - `w_ssrn` = last record number on last page  
  - `w_virn` = record to position cursor  
- **Flags & parameters**:  
  - `b_forn`, `b_kuti`, `b_avtal` – booleans for refresh, single-customer time edit, agreement check.  
  - `w_date`, `w_time`, `w_udat` – current date/time.  
  - `w_peri`, `w_fper` – bonus calculation period start/end.  

## 5. Key Lists  
- Customer lookup by firm+customer number (`rkunlr_key`), by firm+customer number sequence (`rkunl1_key`), and by firm+alphabetic name (`rkunl2_key`).  
- Bonus header read/update keyed by firm+customer (`ekboi1_key`, `ekboiu_key`).  
- Bonus element read/update keyed by multiple fields (`ekbei1_key`, `ekbeiu_key`).  
- Transaction reads for multi‐group bonus (versions 6.13 / 6.30).

## 6. Main Processing Flow (Label `B2CTL`)  
1. **Initialize & display control record** (`B2CMD`).  
2. **Enter display loop** (`B2TAGB`):  
   - Call `dsp_subfile` to show subfile page.  
   - Wait for function key input (`*INKC`, `*IN50` etc.).  
3. **Function key handling**:  
   - F3/F12 (*INKC/*INKL): exit program.  
   - F5 (*IN50): refresh list (`forny`).  
   - F6 (*IN54): call maintenance program `EK120R`.  
   - F8 (*IN56): toggle single‐customer time edit, call `endre_tid`.  
   - F9 (*IN58): calculate all bonuses (`kalk_alle`).  
   - F10/F11 (*IN10/*IN11): roll subfile up/down (`crt_subfile`/`bck_subfile`).  
   - F21 (*IN21): set Home flag, redisplay.  
   - PF23 (*INKX): toggle “show only bonus‐eligible” (`*IN80`) and refresh.  
4. **Positioning by name/number**: if entry fields non‐blank, call `posisjoner`.  
5. **Process subfile selections**: call `subfile` to handle copy, calculate, time edit on individual rows.  
6. **Return to control record** or end.

## 7. Key Subroutines  

### 7.1 forny – Refresh Subfile  
- If `w_fcrn>0`, chain to that record to preserve position.  
- Depending on `w_seqe` (“K”=by number), set either customer‐number or alpha key.  
- Clear subfile (`clr_subfile`), then build fresh page (`crt_subfile`).

### 7.2 posisjoner – Position & Rebuild  
- If user keyed start‐alpha or customer number, set the appropriate key list and position file.  
- Clear and recreate subfile, then blank positioning fields.

### 7.3 subfile – Process Selections  
- Toggles display flag (`*IN22`) to avoid flicker.  
- Loop through all records on current page (`DO w_ssrn` + `READC`).  
- For each selected row (`b1valg`):  
  - **3** = copy bonus → `kopier_bonus`  
  - **6** = print customer letter → `sr_kbrev` (6.12)  
  - **7** = calculate single customer bonus → call `EK104R`  
  - **8** = edit bonus period → `endre_tid`  
  - **9** = calculate annual bonus → `kalk_bonus`  
- If any action occurred (`b_forn=*on`), call `forny` to update display.

### 7.4 clr_subfile – Clear Subfile  
- Turn on `*IN14`, write control record to clear subfile.  
- Reset row counters `w_srrn`, `w_sfrn`, `w_ssrn`, `w_spge`.

### 7.5 crt_subfile – Create Next Page  
- Increment page limit (`w_spge += c_sfil`), set `w_srrn = w_ssrn`.  
- Loop (`DOU w_srrn = w_spge`) reading next customer (by key).  
- For each customer:  
  - Skip if bonus not found (and filter on `*IN80=off`).  
  - Increment `w_srrn`, build subfile record fields (`b1alfa`, `b1navn`, `b1kund`, bonus values).  
  - Write record (`WRITE b1sfl`).  
- After loop, set new first/last record pointers, update `w_virn`.

### 7.6 bck_subfile – Back One Page  
- If end‐of-file flag, position just above current page.  
- Loop backwards (`READP`) down one page size, build new page using same logic as `crt_subfile`.

### 7.7 dsp_subfile – Display Subfile  
- If already loaded (`w_srrn<>0`), set `*IN12=*ON`.  
- Else write control record.  
- Format control record (`EXFMT B2CTL`), capture first displayed record number in `w_fcrn`.

### 7.8 kopier_bonus – Copy Bonus to Another Customer  
- Display copy window (`EXFMT K1WIN`), validate target customer.  
- Delete existing bonus and elements for target (safety).  
- Loop through source customer’s bonus headers/elements, duplicate each record with new customer number, user and timestamp.

### 7.9 kalk_bonus – Calculate Annual Bonus for One Customer  
- Display window (`EXFMT O1WIN`) to enter year/period.  
- Validate input, set default period if blank.  
- Call calculation service program `EK710C` with firm, customer, year, period.  
- Reset subfile bonus columns for that row.

### 7.10 endre_tid – Mass or Single Bonus‐Period Update  
- Display window (`EXFMT L1WIN`) for new start/end dates.  
- If single‐customer mode, restrict loop to that customer.  
- Loop bonus headers, then inner loop update each bonus element record’s `ekefda`/`eketda`.  
- Update header record’s `ekfdat`/`ektdat`.

### 7.11 kalk_alle – Calculate Annual Bonus for All  
- Simply `CALL 'EK715R'` to trigger mass calculation.

### 7.12 sr_kbrev – Print Customer Letter (6.12)  
- Display parameters window (`EXFMT P2WIN`) for year and letter type.  
- Validate that customer has agreement in transaction file `EKBTIR`.  
- Call letter generation program `EK605C` with customer, year, alternative flag.

## 8. Initialization (`*INZSR`)  
- Build all key lists for file access.  
- Read firm code and timestamp from LDA.  
- Initialize display flags: `*IN22=*ON` (first display), `*IN80=*OFF` (show only eligible).  
- Chain to `EKBOI1` to detect if any bonus exists; if none, set `*IN80=*ON` to show all.  
- Position on alpha = blank, then `crt_subfile` to load first page.  

---

This breakdown follows the original RPG logic step by step, clarifying file accesses, subfile paging, function‐key processing, and each maintenance or calculation operation.