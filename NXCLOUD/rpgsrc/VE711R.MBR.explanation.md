# VE711R – EAN Number Lookup by Item and Unit

## Purpose

This program, VE711R, is designed to retrieve the EAN (European Article Number, also known as GTIN) for a given item number (`varenr`) and unit (`enhet`) within a specified company (`firma`). The program uses data from the item master file and related tables to look up the correct EAN based on the input parameters. The program returns the EAN (if found) and a status code indicating success.

## Business Context

- **Domain**: Inventory/Product Master Data
- **Function**: Given a company, item, and unit, determine the correct EAN code, using the NOBB-supplier relationship as found in the `vvarpf` file.
- **Inputs**:
  - `firma` (company)
  - `varenr` (item number)
  - `enhet` (unit)
- **Outputs**:
  - `ean.nr` (EAN number, 0 if not found)
  - `status` (1 = found, blank = not found)

## Files and Data Sources

- **VVARLR** (renamed from VVARPFR): Item master file.
- **VVEPLR** (renamed from VVEPPFR): Item-unit relationship, includes GTIN.
- **VEANL2** (renamed from VEANPFR): EAN register, alternate source for EAN lookup.

## Key Business Logic and Flow

1. **Parameter Initialization**  
   The output parameters (`p_eann`, `p_stat`) are initialized to zero/blank.

2. **Item Existence Check**  
   The program first checks if the item exists in the item master (`vvarlr`). If not, the program ends immediately.

3. **EAN Lookup – Primary (VVEPLR)**  
   Attempts to find the EAN (GTIN) in the item-unit relationship file (`vveplr`):
   - Uses a composite key: company, item, unit, and last order date (`vvldor`).
   - If found, and the GTIN (`vepgti`) is not zero, this value is used as the EAN and status is set to '1'.

4. **EAN Lookup – Secondary (VEANL2)**  
   If no EAN was found in the primary lookup, the program tries the EAN register (`veanl2`):
   - Uses a key of company and item.
   - Additional checks: the unit must match, and the EAN (`vxeann`) must not be zero.
   - If found, this EAN is returned and status is set to '1'.

5. **Program Termination**  
   The program ends, returning the EAN and status.

## Design Decisions and Conventions

- **File Renaming**: All physical files are renamed to shorter logical names for clarity within the program.
- **Status Codes**: Status is set to '1' only if a valid, non-zero EAN is found; otherwise, it remains blank.
- **Zero EAN Handling**: Both lookups explicitly check that the EAN/GTIN is not zero, to avoid returning invalid codes.
- **Unit Matching**: The secondary lookup (VEANL2) includes a unit check (`p_enhe = vxenhe`) to ensure the EAN is for the correct unit.
- **Goto for Early Exit**: If the item does not exist, the program uses a `goto avslutt` for early termination, which is a legacy approach but common in older RPG codebases.

## Relationships and Integration

- **Upstream**: Expects to be called with valid company, item, and unit codes.
- **Downstream**: The returned EAN and status are typically used by other inventory or sales modules for barcode or product identification.
- **Data Integrity**: Relies on the integrity of the master and relationship files; missing or inconsistent data here will result in blank status.

## Maintenance Notes

- **Historical Changes**:
  - Adjusted checks on unit and zero EAN (see comments with version numbers 6.11, 6.12).
- **Localization**: Some comments and variable names are in Norwegian, reflecting the business domain.
- **Error Handling**: Minimal; only checks for presence and validity of data, no logging or exception handling.

## Subroutine and Parameter Structure

- **INZSR (Initialization Subroutine)**:
  - Defines the program's parameter list.
  - Sets up key lists for efficient file access.

## Summary Table

| Input Parameter | Description           |
|-----------------|----------------------|
| p_firm          | Company code         |
| p_vare          | Item number          |
| p_enhe          | Unit code            |

| Output Parameter | Description         |
|------------------|--------------------|
| p_eann           | EAN/GTIN number    |
| p_stat           | Status (1 = found) |

## Key Takeaways for New Developers

- The program is a focused utility for EAN lookup, with logic branching depending on the presence and validity of data in two main sources.
- Data consistency (especially non-zero EANs and unit matching) is critical for correct operation.
- The code follows legacy RPG conventions, including explicit file and key management, and minimal error handling—be aware when extending or refactoring.
- If you need to adjust the lookup logic (e.g., add new sources, change fallback order), ensure you maintain the integrity checks and update related documentation.