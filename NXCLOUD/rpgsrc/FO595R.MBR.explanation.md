# RPG Program FO595R: Explanation

## Overview

This RPG ILE (Integrated Language Environment) program, **FO595R**, is designed for IBM iSeries (AS/400) systems. Its primary function is to manage and browse order headers ("ordre-hode") in a transport/delivery planning context, with features around subfile browsing, order selection, and updates. It is part of a logistics/order management solution, with code and comments in Norwegian.

The program supports:
- Browsing orders using subfiles (paged lists)
- Positioning/filtering by delivery date, route, order number, customer
- Order status management (e.g., picking, picked, etc.)
- Integration towards other programs (e.g., for picking lists, order history, etc.)
- Integration with external flow control/transport systems

---

## File Definitions

- Multiple database files (`fohelr`, `fohel1`, `fohelb`, `foheln`, etc.) are declared for different logical views or sorts of the order header file.
- Display file (`fo595d`) is declared as a *workstn* (workstation), utilizing the subfile (SFL) named `b1sfl` and control records.

---

## Data Structures

- **LDA (Local Data Area):** Used for session/user-specific info (workstation id, user, company/firma, etc.).
- **Display Feedback Structure (`dspfbk`):** Tracks cursor position and display feedback.
- **Key Variables:** For each file access/sort, there are variables for the key fields (e.g., order number, suffix, delivery date, route).

---

## Constants and Variables

- Variables track current row, page size, relative record number, subfile status, etc.
- Work variables for screen display, flagging, and business operations (e.g., `b_oppt` for locked order).
- Subfile-related variables for row and page tracking.

---

## Main Logic Structure

### Program Flow

The program is *menu-driven* via the display file, based on a main interaction loop:

1. **Show Command Screen:** (`b2cmd`)
2. **Load/Display Subfile:** (`dsp_subfile`)
3. **Process Function Keys:** (F3/12-exit, F1/F4/F6/etc. for various actions)
4. **Position Subfile:** When filter fields are entered
5. **Process Subfile Actions:** (Order update, view details, print pick lists, etc.)
6. **Order Status Management:** (e.g., mark as picked, release picking, etc.)

### Subroutines

The code is heavily subroutine-driven, with named subroutines using `begsr/endsr` block structure.

Key subroutines:

- **forny:** Refreshes the subfile based on current positioning/filtering.
- **posisjoner:** Position and reload the subfile based on selected criteria (date, route, order number, customer).
- **subfile:** Handles subfile record selection, updates, validation, and integration with other features.
- **clr_subfile / crt_subfile:** Blank and recreate the SFL content.
- **bck_subfile:** Page back through the subfile.
- **chk_subfile:** Determines if a row should be included (status filters, etc.).
- **dsp_subfile:** Handles display of the SFL and command screen.
- **utskrift:** Handles pick list printing.
- **avbr_plukking / merk_plukking:** Manage picking status; set as picked, release, update logs, etc.
- **xc2win:** Handles update of delivery date/route for an order.
- **xsjekk_lag:** Checks if warehouse is present on any order lines.
- **spørring:** Field-level inquiries (F4/shift+F1) for lookup or search on fields like route or warehouse.
- **newlo_vask:** Cleans data for display compatibility with Newlook (removes dots at end, etc.).
- **sjekk_ordre:** Checks if order is locked/being edited.

---

## Subfile Management

Subfiles are central to the program, providing paged lists for browsing orders. The main display logic covers:

- Loading the subfile with records based on current sort/position/filter.
- Function-key handling for paging, positioning, and actions (edit, pick, history).
- Paging forward/backward is managed by `crt_subfile` and `bck_subfile`.
- Each record can have actions (edit, pick, print, view), with logic executed in `subfile`.

---

## Data Filtering/Positioning

The program supports filtering and positioning by:

- **Delivery date**
- **Route number**
- **Order number**
- **Customer name**

Based on the filter used, corresponding key variables are set, and the appropriate logical file or view is used for reading the database.

---

## Order Status Handling

Orders are shown/selected based on allowed statuses:

- Status codes 2–7 correspond to various picking and delivery states.
- The logic only shows orders ready for, or in, picking/packing/delivery.

When marking an order as picked or releasing a pick, the program updates log files and status fields.

---

## Integration with Other Programs

The program integrates with other RPG programs for:

- **Pick List Printing**
- **Order Details Viewing**
- **Order History**
- **Transport/Flow System Integration:** Via call to external program (`AP058R`) for orders with flow control enabled.
- **Field Lookup Programs** (e.g., for routes, warehouses, customers)

---

## Notable Enhancements

Over the years, the program received maintenance and new features, as reflected by code comments:

- New GUI adaptations
- Extension for wide screens
- Integration with external transport/flow control systems
- Improved mobile number handling
- Changes in subfile filtering and field defaults

---

## Special Features

- **Firm-specific Validation:** The program can adapt certain functions based on settings in a company validation table (see logic involving `avall1`).
- **LDA Usage:** User/session-specific information is leveraged to filter and personalize data access.

---

## Error/Control Handling

- **Indicators** (`*INxx`): Used for screen, function key, and error signaling (e.g., *IN31 for date errors).
- **Screen Protection:** Certain fields can be protected from input based on state.
- **Messages/Flags:** Shown for invalid status, field errors, or business rule violations.

---

## Comments and Documentation

Comments are extensive and describe both technical and business logic, mostly in Norwegian. These give context for:

- File and field usage
- Change history and why certain logic exists
- Explanation of key indicators and variables

---

## Summary Table: Key Areas

| Subroutine        | Purpose                                                |
|-------------------|--------------------------------------------------------|
| forny             | Refresh subfile after change                           |
| posisjoner        | Position/focus subfile based on search/filter          |
| subfile           | Process SFL actions and navigation                     |
| crt_subfile       | Load next subfile page                                 |
| bck_subfile       | Page subfile backwards                                 |
| chk_subfile       | Include/exclude row based on status/business rules     |
| spørring          | Field-level lookup/help                                |
| utskrift          | Print pick list for selected order                     |
| avbr_plukking     | Release order from picking, update status, logs        |
| merk_plukking     | Mark order as picked, update logs                      |
| sjekk_ordre       | Check if order is in use (locked)                      |
| xc2win            | Edit delivery date/route for order                     |
| xsjekk_lag        | Check warehouse presence on order lines                |
| newlo_vask        | Sanitize fields for screen display                     |

---

## How to Approach Development/Maintenance

- Understand file and key structures (logical files/views for sorting/positioning).
- Familiarize yourself with RPG indicators and subfile handling.
- Pay attention to subroutine usage and their flow, especially the main loop handling display and function key navigation.
- For new features/enhancements, follow the subroutine-driven pattern and ensure status and business rule checks are done using the current indicator and variable conventions.
- Business logic (order statuses, filtering, validation) is closely tied to Norwegian logistics processes.

---

**If you are new to RPG or this business area:**  
Consider starting by tracing a simple subfile browse scenario, stepping through the main loop (show command → display subfile → select action), then reviewing how keys work for positioning and how orders are filtered by status.

---

## Business Context

The program is meant for logistics/order team users who need to:

- Find orders ready for picking or delivery
- Quickly position and filter order lists
- View, edit, or update order info
- Integrate with external transport/logistics APIs

---

This explanation covers the main areas of the code and its business/technical logic. For specific function questions or deeper dives, explore the named subroutines and refer to the comments inline.