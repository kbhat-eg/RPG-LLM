# Documentation for Program FD106R

This program is responsible for creating and initializing order lines (“varelinje”) in the ASOFAK system. It is typically invoked when adding a new item to an order, handling both pricing logic and inventory updates. Below is an overview of the primary tasks, interactions, and important details in the program’s flow.

---

## Purpose and Main Flow

1. The program checks whether the item number (p_vare) and quantity (p_anta) are valid and non-zero. If these conditions fail, the program exits (label “avslutt”).
2. It verifies that the specified unit of measure (p_enhe) is defined for the item in the VVENL1 file. If not, the program exits.
3. It checks if the order line being created already exists (FODTL1). If so, it exits to avoid duplicates.
4. The program then retrieves item data (VVARL1) and calls several external modules to obtain additional information:
   - [VL710R] to gather item type (p_vtyp), updated date (w_udat), and other item-tracking details.
   - Optionally [FO751R] to see if there is a special offer price (tilbudspris), when certain conditions hold.
   - [VL712R] to load the appropriate price group (w_prgr).
5. The program populates an internal order-line structure (fodtlur) with the parameters received and the data retrieved from the above modules. Certain fields like cost price, sales price, discount, and other attributes are initialized at this stage.
6. Pricing calculations occur next:
   - [VP900R] is called (in subroutine hent_pris) to compute standard sales price and discount rates based on the item, customer, date, etc.
   - If the order type is “internal,” or certain parameters (p_kopr, p_sapr, p_rab1, p_rab2) have been passed in, the program uses those directly and marks the price code (fdkpri) as “F.” This prevents the system from overriding these prices later.
   - The program computes multiple layers of discount (fdrab1, fdrab2, fdbrr1, fdbrr2) on top of the sales price if present.
   - Cost price (fdkopr) is derived, often from the retrieved data or from the provided parameters.
7. After the calculations, the program writes the finalized line record (FODTL1) to the order.
8. It updates the inventory (subroutine oppdat_lager) if the item is flagged for stock management (faalag = 1) and the item type indicates a stock item (p_vtyp = ‘L’). This update:
   - Prepares a record (hlrec) containing quantity, cost price, reference to the order and line, etc.
   - Calls [VL001R] to finalize the inventory transaction.
9. Finally, the program marks p_kode to indicate that at least one line has been registered and returns.

---

## Notable External Calls

1. **VL710R**  
   Retrieves additional item metadata such as date, lodge type, and flags indicating item usage. This ensures the system has up-to-date information on the item, possibly including external references like the “nobb” number (Norwegian building materials registry number).

2. **FO751R**  
   Potentially called when checking for special offer prices (tilbudspris). It can set temporary price data (w_tilb, w_tra1, w_tra2) for the line.

3. **VL712R**  
   Retrieves the item’s “prisgruppe” (price group), storing it in w_prgr for further discount or cost calculations.

4. **VP900R** (in subroutine hent_pris)  
   A general pricing module that uses both the line and customer context to decide final sales price and discounts.

5. **VL001R** (in subroutine oppdat_lager)  
   Updates stock (lager) with the newly entered line’s quantity, cost price, and references back to the order.

6. **VP753R** (in subroutine hent_inpr)  
   Used when the order type is “internal” to retrieve a specific purchase price (w_inpr) that might differ from standard cost. This is recorded in fdinpr if no other cost price is set.

7. **VE713R** (in subroutine hent_GTIN)  
   Fetches GTIN (Global Trade Item Number) for the item and unit combination, storing the returned value in fdeann for integration with EDI or scanning systems.

---

## Key Fields and Patterns

- **FDxxx** fields (e.g., fdsapr, fdkopr, fdrab1, etc.) belong to the order-line record (FODTL1). They represent various prices and discounts used when writing the final line.  
- **VVxxx** fields (e.g., vvvare, vvtek1, vvtek2) usually come from the item master files (VVARL1, etc.), providing default item attributes such as description or classification.  
- **Subroutines** (begsr/endsr):  
  - hent_pris: Retrieves pricing data via VP900R.  
  - oppdat_lager: Adjusts the inventory if needed (calls VL001R).  
  - hent_inpr: Obtains the internal purchase price for internal orders (calls VP753R).  
  - hent_GTIN: Fetches the GTIN code (calls VE713R).  

The program leverages external modules heavily, preferring to leave various pricing logic, special offers, inventory transactions, and extended item-lifecycle details to other specialized programs. This modular structure is a common pattern in this codebase, enabling consistent handling of logic across different programs.

---

## Important Considerations

- If the item’s unit of measure is invalid or the line already exists, the program exits gracefully to prevent data inconsistencies.  
- The system can handle multiple discount levels, preventing manual overrides if the developer has specifically set p_sapr, p_kopr, p_rab1, and p_rab2. It locks the line price code to “F” (fixed) to ensure subsequent recalculations don’t overwrite the provided data.  
- The inventory update (VL001R) only occurs for items flagged as stock items (p_vtyp = ‘L’).  
- Calls to specialized external modules (like FO751R or FOHEL1R) may be conditionally enabled based on certain flags or states (e.g., faak05, b_kont).  

Overall, program FD106R centralizes the creation of a single, fully initialized order line. By delegating critical price, cost, and inventory operations to external programs, it ensures the newly added line remains consistent with the broader system’s pricing rules and stock control logic.