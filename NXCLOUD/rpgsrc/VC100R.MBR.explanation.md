## RPG Program VC100R – Explained

This is a traditional ILE RPG (RPG IV) program that maintains the "sortiment" (assortment/item assortment) header entries for a system. The program handles display and maintenance of assortment header records, using subfiles for display and providing typical maintenance functions: add, update, copy, and delete. Below are the main points and structures explained for developers.

---

### 1. **Program Description and History**

- **Header Comments**:
  - The program runs on system ASOFAK, program name VC100R.
  - Handles maintenance for "Varesortiment-hode" (assortment header).
  - The header also tracks version changes and contributors.
  - Describes indicator usage (status flags for program logic and screen handling).
  - Lists what indicators (LR, IN10–IN99) are used for.

---

### 2. **File Definitions**

- **Physical and Logical Files**:
  - `vshel1`, `vshel2`, `vshelr`, `vshelu` — different logical/physical views on the assortment header file.
  - `vsdtlr`, `vsdtlu` — for assortment line/entry maintenance.
  - Each file uses a `rename` to alias record formats to local names.

- **Workstation File**:
  - `vc100d` — Display file used for user interaction.
  - Subfile defined as `sfile(b1sfl:w_srrn)` — the B1 subfile, with a subfile record number variable.

---

### 3. **Data Structures and Variables**

- **Local Data Area (LDA) variables**:
  - Used for user info, company number, etc. (e.g., `l_user`, `l_firm`...).

- **Feedback Data Structure**:
  - `dspfbk` for screen feedback (e.g., cursor row).

- **Key Variables**:
  - Variables that hold key fields for file access (like `vshel1_vsor`, `vshel2_besk`, etc.).

- **Working Variables**:
  - For subfile record numbers, navigation, flags, etc.

- **Indicator variables**:
  - Flags for updating the screen, handling actions (e.g., `b_oppr`, `b_forn`, `b_anul`, etc.).

- **Constants**:
  - E.g., `c_sfil` (subfile page size), hardcoded to 14.

---

### 4. **Screen and Subfile Handling**

The program uses subfiles to display multiple records per screen, including:

- **Screen Layouts**:
  - B1SFL: Subfile records
  - B2CTL: Subfile control
  - B2CMD: Function key command screen
  - C1BLD, C2BLD, etc.: Data entry/maintenance panels
  - D1WIN, K1WIN: Popups for delete/copy

#### **Subfile Variables Explained**

- `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Track current/first/last subfile records on page and in entire subfile, etc.

---

### 5. **Main Program Flow and Subroutines**

The main loop is controlled via tags (labels) and uses subroutines (`exsr`) for display/logic.

#### **Entry and Core Loop**

- Program starts at `b2taga` and `b2tagb`.
- Writes command screen, then displays subfile.
- Handles function keys via SELECT statements:
  - e.g., F3/F12 (`*inkc`, `*inkl`) for exit.
  - F5 to refresh.
  - Other keys to add, copy, delete, etc.

#### **Key Subroutines**

- **forny**: Refreshes subfile based on current positioning (sortiment or description).
- **posisjoner**: Positions subfile list on given key values.
- **subfile**: Handles actions based on user selection in the subfile (update, copy, delete, show).
- **xc1bld, xc2bld**: Screen handlers for adding or maintaining entries.
- **clr_subfile, crt_subfile**: Clear and fill up the subfile.
- **bck_subfile**: Goes back one page in subfile.
- **dsp_subfile**: Displays the subfile.

#### **Specific Maintenance Subroutines**

- **xd1win**: Delete item (and associated lines).
- **xk1win**: Copy item.
- **xc1msg**: Display message if key already exists.

---

### 6. **CRUD Operations**

- **Add (xc1bld/xc2bld)**:
  - Gathers entry fields.
  - Checks whether entry exists.
  - If not, writes the new entry.

- **Update (xc2bld)**:
  - Reads existing entry.
  - Allows user to change and updates the record.

- **Delete (xd1win)**:
  - Confirms and deletes the main record and all its associated lines.

- **Copy (xk1win)**:
  - Copies an item header and all associated lines.

---

### 7. **Key Lists**

- **Key lists** (`klist`) define composite keys for file access (setll, chain, etc.) for different files/views, always including at least the company (w_firm) and either assortment number or description.

---

### 8. **Initialization**

- **\*inzsr**:
  - Keylists are defined.
  - Company number is pulled from LDA.
  - CO402R program is optionally called (added in version 7.01) to do additional initialization (e.g., set *IN40).
  - Subfile is initialized.

---

### 9. **Indicators**

- **Indicators (e.g., *IN14, *IN15, *IN22, etc.)**:
  - Control screen states, protect fields, mark errors, signal various modes, etc.
  - The code uses named indicators and has a comment block mapping their roles.

---

### 10. **Interaction with External Programs**

- Calls to other programs, e.g.:
  - `'RS710R'`: Looks up "lager" (warehouse) text/information.
  - `'VD600R'`, `'VD100R'`, `'VC701R'`: Perform other business logic (e.g., derive dates from week numbers).
  - `'CO402R'`: Custom logic for GUI or initializations.

---

### 11. **Date and Week Handling**

- Week numbers (c2fuke, c2tuke) can be entered. The program can convert these to actual dates (`finn_dato` subroutine).

---

### 12. **Data Validation and Error Handling**

- Field validations are performed (e.g., description cannot be blank, week numbers not >53).
- Error indicators are set to then be displayed on screen.

---

### 13. **Version and Localization Notes**

- Some code and comments (e.g., error messages, variable explanations) are in Norwegian.
- Some version-specific logic is commented or added (e.g., "prisfokusvarer," new assortment types).

---

## **Summary**

**This program is a traditional RPG/400 (ILE) maintenance program for handling assortment headers in a business application, using subfiles for navigation and display. It supports all maintenance functions (add, change, delete, copy, view), provides robust subfile page handling, and manages both header and associated lines. The program is modular, with clear labels and subroutines, and is well-commented for maintainers.**

Developers new to this code should familiarize themselves with:

- The use of subfiles in RPG for list display and update.
- Indicator-based logic for screen control and error handling.
- How key lists are used for positioned I/O.
- The typical RPG program structure (initialization, main logic loop using tags and selects, heavy use of subroutines).
- Interactions with external programs (lookups, utility functions, etc.).
- The business process, which centers around assortment (sortiment) header maintenance and its line items.

---

> **Tip:** To onboard quickly, try stepping through the main subfile logic (subfile, crt_subfile, clr_subfile, etc.), and review the display file DDS for screen field mappings.