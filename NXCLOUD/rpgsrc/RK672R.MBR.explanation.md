# RK672R – Documentation

## Overview

**Program:** RK672R  
**System:** ASOKON  
**Description:** Handles the selection and validation of parameters for printing reports related to "Utelatte kunder" (omitted customers). The program is primarily a parameter entry and validation front-end, which then calls the main printing routine (`RK672C`) with validated parameters.

This program is intended for interactive use, presenting a workstation display (`rk672d`) where users select print criteria. It enforces business rules for parameter validation and manages session-specific data (e.g., company, user, date). The code is written in traditional OPM RPG.

---

## Structure and Flow

### 1. Files

- **AUSRL1**: Indexed, keyed disk file. Used for user/session data (not directly referenced in logic here, but declared for potential use or LDA population).
- **RK672D**: Workstation file for user interaction (display and input).

### 2. Local Data Area (LDA) Usage

The program maps specific fields in the LDA for session management:
- `l_klad` (301): Indicates if a draft block should be written.
- `l_user` (911-920): User ID.
- `l_firm` (944-946): Company number.
- `l_fnav` (951-980): Company name.

### 3. Working Variables

- `s`: General-purpose single-byte variable.
- `w_firm`: Numeric, holds company number.
- `w_in03`: Flag for exit (from F3).
- `w_type`: Report type (I, P, or R).
- `w_edat`: Execution date (ISO format).

### 4. Program Flow

#### a. Initialization (`*INZSR`)

- Sets default print date (`a2pkda`) to current system date (`udate`).
- Sets default report type (`a2type`) to 'P'.
- Sets draft block flag (`a2klad`) to 'N'.
- Clears exit flag (`w_in03`).
- Loads company number from LDA (`l_firm`) into working variable (`w_firm`).

#### b. Main Logic

1. **Display Parameter Screen:**  
   Presents the `A2BLD` screen for parameter entry via `EXFMT A2BLD`.

2. **Reset Error Indicators:**  
   Turns off indicators 31 and 32, which are used for error signaling.

3. **Exit Handling:**  
   If the user presses F3 (`*INKC`), sets exit flag (`w_in03 = '1'`) and skips to program end.

4. **Date Validation:**  
   - If print date (`a2pkda`) is zero, sets it to the current system date.
   - Validates the date format (`TEST(D)`). If invalid, sets error indicator 31 and loops back for correction.

5. **Report Type Validation:**  
   - Only allows report types 'I', 'P', or 'R'.
   - If invalid, sets error indicator 32 and loops back for correction.

6. **Draft Block Handling (Kladdeblokk):**  
   - Stores the draft block selection (`a2klad`) into LDA (`l_klad`) for later use.

7. **Call Print Routine:**  
   - Calls external program `RK672C` with parameters: exit flag, report type, and execution date.

#### c. Program Termination

- Sets LR indicator (`*INLR`) to signal program end and returns.

---

## Business/Domain-Specific Logic

- **Kladdeblokk (Draft Block):**  
  The program supports an option to print a draft block, controlled by the `a2klad` parameter. This is a business-specific requirement introduced in version 5.30 (see change log).

- **Report Types:**  
  The program enforces that only three report types are valid:  
    - 'I' (likely "Individuell" / Individual)
    - 'P' (likely "Periodisk" / Periodic)
    - 'R' (likely "Rapport" / Report)  
  This is strictly validated before proceeding.

- **Exit Handling:**  
  F3 is consistently mapped to an immediate exit, with a flag passed to the print routine, likely to allow the downstream process to react appropriately.

- **Date Handling:**  
  The program always ensures a valid print/execution date is provided, defaulting to the current date if not specified.

---

## Indicators and UI Conventions

- **Function Key Mapping:**  
  - F1 (`KA`): Company selection (not directly handled in this program, but reserved).
  - F3 (`KC`): Exit.
- **Indicator Usage:**  
  - 31: Signals date error.
  - 32: Signals invalid report type.
  - 30: Used to protect fields on display.
  - 60–69: Reserved for file I/O indicators.
  - 70–99: Used for subroutines and working indicators.

---

## Interactions with Other Modules

- **RK672C:**  
  The core printing logic is not in this program, but in `RK672C`. This program is solely responsible for collecting and validating parameters, then delegating the actual processing.

- **LDA:**  
  Used for session continuity (user, company, draft block flag).

---

## Patterns and Design Decisions

- **Separation of Concerns:**  
  This program strictly handles parameter entry and validation, delegating all business processing to an external program.

- **Error Handling via Indicators:**  
  Error conditions are signaled back to the display using indicators (31, 32), following standard legacy RPG UI patterns.

- **LDA Usage:**  
  Key session values are passed via the LDA, a common technique in older RPG applications for maintaining context between programs.

- **Change Management:**  
  The header includes a structured change log, with versioning and references to specific enhancements (e.g., draft block support).

---

## Summary

RK672R is a parameter validation front-end for the "Utelatte kunder" reporting process. It enforces business rules for report type and date, supports optional draft block printing, and hands off validated input to the main print module. The program uses standard RPG conventions for indicator-based error handling and session management via the LDA. Any business logic or report generation is performed by the called program (`RK672C`). This separation allows for easier maintenance and clearer responsibility boundaries within the application suite.