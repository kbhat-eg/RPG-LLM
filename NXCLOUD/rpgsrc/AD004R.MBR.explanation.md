# RPG Program Explanation: AD002R (“Vedlikehold av Gruppe-tekster”)

This document explains the key structure, concepts, and flow of the RPG program `AD002R`, which is a subfile-driven maintenance program for access groups in an IBM i (AS/400) system.

---

## **Purpose and Overview**

- **Purpose**: Maintain (create/change/delete/view/copy) group texts for an access control system.
- **Functionality**: The program presents subfile lists and allows users to manipulate group texts by interacting with various screens using function keys (F-keys). It also incorporates security/authority checking for both users and function keys.

---

## **File and Data Structure**

### **Physical File Declarations**

The program uses multiple files, primarily logical files over the same physical file, with different record formats for various purposes:

- `iadtl1`, `iadtl2`, `iadtlr`, `iadtlu`: Logical files over `iadtpfr` for different keying needs.
- `iadrl1`: Logical file over `iadrpfr` (for routines?).
- `ausrl1`: For looking up user names.
- *Workstation file* `ad004d`, featuring subfile `b1sfl`.

### **Arrays and Data Areas**

- `a_meld`: Array to hold up to 3 messages (used for status/notification messages).
- *LDA (Local Data Area)*: Used to pass `l_user`, `l_firm`, and `l_fnav` (user, firm, and user’s name).

### **Key Variables & Subfile Descriptors**

- `w_srrn`, `w_spge`, `w_sfrn`, `w_ssrn`: Used for subfile record, page, and display management.
- `b1sfl`, `b2ctl`, etc.: Record formats for subfile rows and control.

---

## **Main Processing Flow**

### **Indicators**

Indicators (e.g., `*INLR`, `*INKF`, `*IN10`, etc.) are heavily used for screen control, validation, and program flow.

### **Entry & Parameter Handling**

- Entry parameters: `p_firm`, `p_ruti`, `p_text` are received to initialize the context.
- Keylists are defined for frequent database lookups and positioned reads.

### **Initialization (`*INZSR`)**

- Set up starting values, position files, and fill the subfile list with relevant group texts for the routine.
- Security check: Calls program `AD005R` to check whether the user is allowed access to this routine—which can terminate the program if denied.

---

## **Screen & User Interaction**

### **Main Event Loop (Tags: `b2taga`, `b2tagb`)**

- `write b2cmd`: Draws the command screen.
- `exsr dsp_subfile`: Shows the subfile if available.

#### **F-key Handling (Security & Actions)**

- Before allowing actions on function keys (e.g., F6), the program calls `AD005R` to check user authority.
- Depending on which key was pressed (shown by indicator variables), actions like add/edit/copy/delete/view/position are invoked by calling subroutines.

### **Subfile Operations**

- **Subfile Control**: Manages subfile visibility, refresh, and user input for group texts.
- **Add/Edit/View/Copy/Delete**: Managed via corresponding subroutines (`xc1bld`, `xc2bld`, `xk1win`, `xd1win`), which handle screens for each operation and underlying database changes.
- **Search/Position**: User can enter values to jump to a specific user or routine and re-populate the subfile accordingly.

---

## **Subroutines Overview**

### **Subfile Subroutines**

- **clr_subfile**: Clears the current subfile contents for refresh.
- **crt_subfile**: Fills the subfile with records matching the current filter/key.

#### **Display Subfile Logic (dsp_subfile)**
- Decides whether to display the command screen or directly continue with the subfile display (based on whether subfile has data).

### **Behavioral Subroutines**

- **forny**: Handles refresh/reposition of the subfile.
- **posisjoner**: Repositions the file pointer based on entered search criteria.
- **control**: Handles validation and branching based on control actions (e.g., user pressed "Add" or "Edit" next to a subfile row).
- **subfile**: Iterates over subfile entries, checking for edit/copy/delete/view requests and handling authority checks on user-initiated actions.

### **Screen and Field Validation**

- **xc1bld/xc2bld**: Drives the "add new"/"edit"/"view" record screens, including validation, lookups, and writing changes.
- **xc1msg**: Shows a message if the user tries to create a record that already exists.

### **Delete and Copy Handlers**

- **xd1win/xk1win**: Manage the dialog windows for delete and copy, including checks for input validity and underlying database operations.

### **Support Subroutines**

- **komma**: Adds a comma (`,`) between values when constructing field descriptions in the subfile.
- **spørring**: Handles inquiries by calling other programs for help or validation on various fields.

---

## **Security/Authority Checking**

For every significant user action (especially function keys), the program:

- Sets up security variables (`w_tilgko`, `w_rutine`, `w_adv`)
- Calls program `AD005R` which will set `w_status` to `'Sperret'` (blocked) if the user is not authorized
- The program blocks the action or exits if the user is denied.

---

## **Subfile Management Details**

- Subfile rows display user/group information, textual descriptions, and indicators of special flags.
- Subfile actions (edit/view/copy/delete) are performed by setting selection codes (`b1valg`), which trigger relevant subroutines.
- The subfile is cleared and rebuilt as needed in response to user actions to reflect current database state.

---

## **General Features**

- **Screen File Layout**: Several panel layouts for subfile lists, command keys, and pop-up windows for operations.
- **Field/Indicator Annotations**: Extensive comments (in Norwegian) describe the intended use of indicators, subfile fields, and data flows.
- **Error/Info Handling**: Screen-level validation; messages presented for required fields, duplicate records, and authority issues.

---

## **Typical User Experience**

1. **Enter the program** (possibly with filters pre-set).
2. **View subfile list** of group texts for a routine.
3. **Navigate** (search/position by user/routine).
4. **Select actions** on subfile rows—add, edit, view, copy, delete—triggering associated screens.
5. **Program checks user's authority** for each action before proceeding.
6. **Changes are written** back to the database and reflected in the subfile list.

---

## **Key Points for Onboarding Developers**

- **Subfiles are central**. Understand how subfiles and indicators work in RPG.
- **Security control via AD005R**. Always check for the “Sperret” (blocked) status after an action that requires authority.
- **Repeated use of file names with different record formats** to enable efficient keying and reading.
- **Indicator management** is crucial; much control logic relies on indicator states and conventions.
- **Screens and data movement**: Data is moved back and forth between display fields, buffer variables, and database fields.

---

## **Glossary**

- **Subfile**: A list or grid displayed on an IBM i screen where the user can select or act on multiple database records.
- **Indicator**: A one-byte variable used in RPG to control flow, display, and actions.
- **Tag**: A label for a position in the code, functioning like a goto label.
- **begsr/endsr**: Begin/End subroutine in RPG.
- **exfmt**: Write & read a display file record (i.e., show a screen and wait for user input).
- **chain**: Random read of a record via a key.

---

## **Resources for Further Learning**

- IBM documentation for RPG IV/ILE, especially on subfiles and display files.
- Search for “IBM i subfile programming” for tutorials on this critical UI pattern.
- Internal documentation/specifications for the access control process and security routines, particularly `AD005R`.

---

**In summary:**  
This program is a classic IBM i RPG interactive maintenance routine with subfiles, supporting advanced authority checks for both users and actions. It is structured around display files, indicator-controlled branching, and subroutines for all major actions. The logic may look complex due to the heavy use of indicators and screen flows, but the pattern is standard for seasoned RPG developers.

If you are new, focus on how subfiles are built/refreshed, how function keys map to actions, and how the security checks are injected into almost every critical path.