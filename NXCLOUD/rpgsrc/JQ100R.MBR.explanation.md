# RPG Program JQ100R – Code Explanation

## General Overview

This program, "JQ100R", is written in IBM ILE RPG (RPG IV) and is used for **producer file maintenance**. It is designed to interact with a user via display files, utilizing subfiles for user-friendly list displays, navigation, and CRUD (Create, Read, Update, Delete) operations on producer records.

The code is well-structured and highly commented, making use of traditional RPG indicators, data structures, and subroutines for modular logic.

---

## High-level Functionality

- **Subfile Navigation and Display:** The program heavily uses subfiles for record display and manipulation. Users can page through, add, modify, copy, or delete records.
- **Field-level and record-level validation with user feedback.**
- **Integration with display files (workstation files) and database physical files.**
- **Support for common function keys (roll up/down, home, cursor placement, etc.)**

---

## File Declarations

```rpg
fjprol1    if   e           k disk    rename(jpropfr:jprol1r)
fjprol2    if   e           k disk    rename(jpropfr:jprol2r)
fjprolr    if   e           k disk    rename(jpropfr:jprolrr)
fjprolu    uf a e           k disk    rename(jpropfr:jprolur)
fjq100d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- **fjprol1, fjprol2, fjprolr, fjprolu**: Logical and update-capable file handles for the producer master file (`jpropfr`), renamed for keyed and update operations.
- **fjq100d**: Display file, using a subfile (`b1sfl`) with relative record number variable `w_srrn` and an information data structure for feedback.

---

## Data Structures and Variables

### Local Data Area (LDA)
```rpg
d                uds
d l_user                911    920
d l_fnav                951    980
```
- **l_user:** User identifier from LDA.
- **l_fnav:** Possibly function navigation or file navigation info.

### Display Feedback DS
```rpg
d dspfbk          ds
d  d_fcrn               378    379I 0
```
- **d_fcrn:** First record number on the screen from display feedback.

### Key Variables for Files
```rpg
d jprol1_prod     s                   like(jqprod)
d jprol2_navn     s                   like(jqnavn)
d jprolr_prod     s                   like(jqprod)
d jprolu_prod     s                   like(jqprod)
```
- Used as keys for chains, setll, and file operations.

### Working Variables
```rpg
d w_fcrn          s              4  0
d w_stel          s              4  0
d w_spge          s              4  0
d w_srrn          s              4  0
d w_sfrn          s                   like(w_srrn)
d w_ssrn          s                   like(w_srrn)
d w_seqe          s              1
d b_oppr          s              1    inz(*off)
d b_forn          s              1    inz(*off)
d b_anul          s              1    inz(*off)
d b_feil          s              1    inz(*off)
d s_prod          s                   like(jqprod)
```
- **w_fcrn, w_srrn, w_sfrn, w_ssrn**: Subfile paging variables (current, first, and last record, page sizes).
- **b_oppr, b_forn, b_anul, b_feil**: Boolean flags for status in program flow (e.g., "operation", "renew", "cancel", "error").
- **w_seqe**: Determines sequence (e.g., search by producer or name).

### Constants
```rpg
d c_sfil          s              2  0 inz(14)
```
- **c_sfil:** Subfile page size (number of records per page).

---

## Program Flow - Main Logic (Main Loop Structure)

The RPG C-specs leverage **tags** and **subroutines (begsr/endsr)** to modularize logic. The main loop is:

1. **b2taga**: Write command line, go to displaying subfile, dispatch on function key.
2. **b2tagb**: Execute subfile display, then process function keys.
   - Ctrl (F3/F12): End program.
   - F5: Refresh/reload subfile.
   - F6: Create new (calls creation window).
   - F10, F11: Page up/down.
   - Home/cursor-related: Positioning.
   - Default: If search fields entered, position subfile; else, maintain subfile.
3. **avslutt**: Set LR (last record - end program).

---

## Subroutines

### forny (Renew Subfile)
- Repositions file pointer based on current page.
- Calls subroutines to clear and recreate the subfile.

### posisjoner (Positioning)
- Handles searches for "Name" or "Producer":
  - If a name is entered, search by name.
  - If a producer number is entered, search by producer.
- Blanks the search fields, clears and reconstructs the subfile from context.

### subfile (Subfile Logic)
- Reads and processes the subfile page.
- For each entry:
  - Handles update, copy, delete, and display operations.
  - Calls appropriate subroutines/windows.
- If a change occurred, calls forny to refresh.

### xc1bld (Create New Row Screen)
- Entry and validation for new producer.
- If already exists, displays info, or else opens maintenance window.
- After successful creation, resets state and checks for subfile refresh.

### xc1msg (Create Message Window)
- Displays message if user tries to create an already existing record.
- Lets user cancel or go back.

### xc2bld (Edit/View Window)
- Loads producer data for view/edit.
- Handles input validation (e.g., name can’t be blank).
- Updates or writes to physical file accordingly.
- Integrates subfile refresh or update as needed.

### xd1win (Delete Window)
- Presents the delete confirmation window.
- On confirmation, deletes the record.

### xk1win (Copy Window)
- Facilitates copying a record to a new key.
- Validates that new key doesn’t already exist.
- Uses maintenance screen to edit new key’s data.

### clr_subfile (Clear Subfile)
- Clears the subfile and related status variables.

### crt_subfile (Create Subfile)
- Reads next page’s worth of records from current position and writes to the subfile.

### bck_subfile (Back a Page in Subfile)
- Handles paging backward through the subfile.

### dsp_subfile (Display Subfile)
- Handles subfile display and writes page control records.

### *inzsr (Initialization Subroutine)
- Defines key lists for file access commands.
- Loads user data from LDA and positions file for initial display.
- Fills initial subfile page.

---

## Indicators (Special RPG Feature)

- **LR (Last Record)**: End of program.
- **Function Key Indicators:** 10,11,12, etc. for subfile and screen control.
- **31-99:** Used for various process and error states.
- See detailed indicator descriptions in the comments.

---

## Subfiles and Screens

- **B1SFL:** Subfile. Displays producer list.
- **B2CTL:** Subfile control record.
- **B2CMD:** Command function keys screen.
- **C1BLD/C2BLD:** Creation and maintenance screens.
- **D1WIN/K1WIN:** Delete and copy confirmation windows.

---

## Typical User Interactions

1. **Viewing Producers:** The user is shown a paginated subfile list.
2. **Searching:** User can search by name or producer number.
3. **Paging:** F10 (next), F11 (previous) to page through the list.
4. **Create/Edit/Delete/Copy:** By selecting a subfile row and relevant function key, detailed forms or confirmation screens are shown for manipulation.
5. **Validation:** Attempting illegal actions prompts informative messages.
6. **Maintenance:** All data changes are written to the physical files, and UI state is tracked for refreshing subfiles or re-displaying search results.

---

## Key Concepts for New Developers

- **RPG Program Execution:** Driven by display file reads/writes and indicator-driven logic.
- **Subfile Handling:** Core to list processing and user paging/navigation.
- **Separation of Concerns:** CRUD logic is in subroutines, display and interaction logic is in the main loop.
- **Keylist Usage:** Used for passing keys to file operations (SETLL, CHAIN, etc.).
- **Error/Status Handling:** Managed with special indicators and flags.

---

## Summary

This program is a classic RPG subfile-based maintenance tool, focused on managing producer records. It demonstrates core RPG design patterns: indicator-driven logic, subfile display and navigation, and modular subroutines for CRUD operations. Extensive commenting, constants, and data structure usage improve maintainability and readability.

For onboarding, focus first on understanding:
- Subfile handling and display logic.
- Flow of function key handling (main interactive loop).
- The structure and use of subroutines for various user operations.

This style remains common in traditional RPG applications on IBM i (AS/400) systems.