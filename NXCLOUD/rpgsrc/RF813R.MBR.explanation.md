# Explanation of RF813R RPG Program (ILE RPG)

## Overview

This RPG program exports card transactions to an external system ("NBBL"). It reads customer card data, processes related invoice and receipt records, and writes a summarized export file. The program is well-documented with a change log, and the business logic is tightly linked to Norwegian retail/loyalty concepts.

---

## High-level Structure

- **File Specifications (`F-spec`)**: Declares record-level access to card, invoice, and receipt files for input/output.
- **Data Definitions (`D-spec`)**: Defines data areas (LDA), variables, and data structures (DS) for keys, work variables, and output records.
- **Main Logic (`C-spec`)**: Iterates through the customer card master, processes matching transactions, computes sums, creates export records, and marks processed transactions.
- **Subroutines**: Read and aggregate data from either invoice history or receipt registers, depending on record content.
- **Initialization (`*inzsr`)**: Sets up parameters, keys, and work fields.

---

## Detailed Explanation

### 1. **File Declarations**

```rpg
fbokkl3    uf   e           k disk    rename(bokkpfr:bokkl3r)
fbcdtir    if   e           k disk    rename(bcdtst:bcdtirr)
fsodtlr    if   e           k disk    rename(sodtpfr:sodtlrr)
fkortitum  o  a e             disk    rename(kortitum:kortitumr)
```
- `bokkl3` / `bokkpfr`: Customer card master (input).
- `bcdtir` / `bcdtst`: Receipt details (input).
- `sodtlr` / `sodtpfr`: Historical invoice lines (input).
- `kortitum`: Output file with card transaction export records (output).

---

### 2. **Data Area and Variables**

- **LDA Fields** (`l_user`, `l_firm`, `l_fgr`): Firm, user, etc., loaded from the local data area.
- **Work Variables** (`w_tot_hsum`, `w_net_hsum`...): Sums for transaction totals, discounts, etc.
- **Data Structures**:
  - For parameter passing & overlays (e.g., `p_prec`, `d_unh`, `d_bong`).
  - Structured output for export records.

---

### 3. **Main Processing Loop**

#### a) **Initialization**

- Key lists for all files are set up in `*inzsr`.
- Program gets initial parameters from entry PLIST.

#### b) **Loop Over Customer Cards**

```rpg
c     bokkll_key    setll     bokkl3
c     bokkl3_key    reade     bokkl3
c                   dow       not %eof(bokkl3)
```
- Positions (`setll`) to customer card file and begins a loop across all customer cards.

#### c) **Reset Sums**

On each customer card:
```rpg
c                   eval      w_tot_hsum = 0
c                   eval      w_net_hsum = 0
c                   eval      w_trab_hsum = 0
c                   eval      w_nrab_hsum = 0
c                   eval      d_bong = *blanks
```

#### d) **Filtering**

Skips:
- If transaction date too late.
- If conditions on previous processing and "omkj√∏ring" (rerouting?) not met.

#### e) **Read Transaction Data**

- If invoice# exists: processes via subroutine `les_hfakt` (read historic invoices).
- Else, if receipt# exists: processes via subroutine `les_bong` (read receipt register).

#### f) **Compose and Write Export Record**

- If data was found (`b_rapp = *on`), build export record:
  - Handle negative amounts by converting value and adding a minus sign in string.
  - Format output: Card number, date, product, total/net/rabatt values (with separators).
  - Write to output (`kortitumr`). First record writes a header (`d_unh`).

- Mark transaction as processed (timestamp and update in card master).

#### g) **Advance Loop**

Reads next card and continues.

---

### 4. **Subroutines (`les_hfakt` and `les_bong`)**

#### a) **les_hfakt**

- Reads all invoice lines for the current card/invoice using `sodtlr`.
- Sums up values, applies business logic for calculating gross/net/discounted amounts.
- If card storage location is specified, only matches records for that location.

#### b) **les_bong**

- Reads all receipt records for this card using `bcdtir`.
- Sums up values for totals, net, discounts, etc.
- Applies similar location-matching logic if required.

---

### 5. **Initialization Subroutine (`*inzsr`)**

- Reads program parameters (card type, from/to dates, etc.).
- Sets up key fields for subsequent file access.
- Gets firm number from LDA.
- Initializes work fields.

---

## Key Business/Technical Points

- **Custom Export Format**: Output records are built field-by-field, separated by semicolons, matching a required file layout.
- **Selective Export**: Only unprocessed or rerouted transactions are exported.
- **Audit/Update**: Processed transactions are marked in the card master for audit trail.
- **Dynamic Keying**: Uses key lists (`klist`) to allow indexed access to various files.
- **Parameterization**: Uses passed-in buffers and structures, facilitating batch/automated use.
- **Norwegian Context**: Field names and comments (e.g., `Byggevarer`, `kortnummer`, etc.) suggest a specialization for Norwegian business systems.

---

## Summary

This program exports card transactions that have not been marked as previously processed, either based on invoice lines or receipt details related to each card. It computes and formats summary values for each transaction, writes them to an output file, and marks each exported transaction as processed. The code uses classic OPM/ILE RPG structures: file specs, data structures, and subroutines, along with detailed business logic for filtering, calculation, and export.

---

**This explanation should give a new developer a broad and contextual understanding of how the program is structured, how data flows, and what the main functional responsibilities are.**