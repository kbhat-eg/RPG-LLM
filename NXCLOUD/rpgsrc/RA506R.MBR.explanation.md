# Documentation: RA506R – Rabattkategori, spørring

## Overview

**Program:** RA506R  
**System:** ASOKON  
**Description:** Inquiry program for "Rabattkategori" (Discount Category).  
**Purpose:** Provides a subfile-based user interface for browsing and selecting discount categories. The program supports positioning, paging, and selection via a subfile, and works with both category codes and descriptions.

## Business Context

- **Rabattkategori**: Represents discount categories within the business domain.
- The program is a display file inquiry (spørring) that allows users to browse, search, and select discount categories.
- Supports both code-based and description-based navigation/positioning.
- Used as part of a larger GUI and DDS-based application suite.

## File Dependencies

- **Physical Files:**
  - `ra06pfr` (with renamed record formats: `ra06l1r`, `ra06l2r`): Holds discount category master data, accessed via two logical views:
    - `ra06l1`: Keyed by category code
    - `ra06l2`: Keyed by description
- **Display File:**
  - `ra506d`: Contains subfile (`b1sfl`) and control records.
    - Subfile: `b1sfl`
    - Control: `b2ctl`
    - Command screen: `b2cmd`

## Program Structure

### Indicators

- **LR**: End of program
- **10, 11**: Paging (Roll, Rolldown)
- **12, 13, 14, 15**: Subfile display and control (Display, Control, Clear, End)
- **21, 22**: Home-key, Cursor placement
- **30**: Protect fields on display
- **31-79**: Error/warning indicators
- **80-99**: Work indicators

### Key Variables

- **p_firm, p_fkod, p_ftxt**: Parameters for firm, category code, and description (passed in on entry).
- **ra06l1_fkod, ra06l2_ftxt**: Variables for current key values for positioning in logical files.
- **w_stel, w_spge, w_srrn, w_sfrn, w_ssrn**: Subfile paging and record tracking.
- **w_seqe**: Mode for search sequence ('B' for description-based, blank for code-based).
- **b_valg_ok**: Flag indicating a selection has been made.

### Data Structures

- **dspfbk**: Display feedback structure, used to track subfile positioning and cursor location.

### Subfiles and Screens

- **b1sfl**: Subfile record format for discount categories.
- **b2ctl**: Subfile control record.
- **b2cmd**: Command screen for function keys.

## Main Control Flow

1. **Initialization (`*inzsr`):**
   - Receives parameters (firm, code, description).
   - Initializes keys for positioning.
   - Sets initial firm value and positions database to the start.
   - Loads the first page of the subfile.

2. **Main Loop:**
   - Displays command screen (`b2cmd`).
   - Displays subfile (`dsp_subfile`).
   - Handles function keys:
     - **Exit (F3, F12)**: End program.
     - **Refresh (F5)**: Rebuild subfile from current position.
     - **Page Down (Roll, F10)**: Load next page in subfile.
     - **Page Up (F11)**: Page back in subfile.
     - **Home (F21)**: Place cursor at home position.
   - **Positioning:** If search fields (`b2fkod`, `b2ftxt`) are entered, positions subfile accordingly.
   - **Subfile Handling:** Reads subfile for selection. If a row is selected (`b1valg = 1`), sets output parameters and ends.

## Subroutines

### forny

- Refreshes the subfile display.
- Chains to the current record if necessary.
- Positions either by code or description, based on `w_seqe`.
- Clears and recreates the subfile.

### posisjoner

- Handles positioning based on user input in search fields.
- If a code is entered, positions by code; if a description is entered, positions by description.
- Clears and recreates the subfile after positioning.
- Clears search fields after use.

### subfile

- Reads through the subfile records for the visible page.
- Checks if a row is selected (`b1valg = 1`), and if so, sets output parameters and flags selection as complete.

### clr_subfile

- Clears subfile by writing the control record with `*in14` indicator.
- Resets subfile counters and page tracking variables.

### crt_subfile

- Populates the subfile with the next page of records.
- Reads from either code- or description-ordered logical file, based on `w_seqe`.
- Handles end-of-file and firm break logic.
- Sets subfile paging variables.

### bck_subfile

- Handles paging back (previous page) in the subfile.
- Reads records in reverse order from the appropriate logical file.
- Repositions and repopulates the subfile.

### dsp_subfile

- Handles the display of the subfile.
- Sets indicators for subfile display and control.
- Uses `exfmt` to display the control record and wait for user input.

## Special Design Considerations

- **Dual Indexing:** The program supports searching/positioning by both code and description, using two logical files (`ra06l1`, `ra06l2`). The variable `w_seqe` controls which access path is used.
- **Page Navigation:** Subfile paging is managed via counters (`w_srrn`, `w_ssrn`, etc.) and a fixed page size (`c_sfil`).
- **Selection Logic:** The program is designed to return the selected code and description to the calling program via parameters. The selection is made by setting a field (`b1valg`) in the subfile row.
- **Cursor and Display Management:** Uses display feedback data structure and indicators to manage cursor placement and field protection, supporting a responsive user interface.

## External Interactions

- **Called as a subroutine:** This program is typically called from another program, passing in firm, code, and description parameters, and returning the user’s selection.
- **Database:** Reads from discount category master files, using logical views for efficient positioning.
- **Display File:** Interacts with the display file (`ra506d`) for subfile and control screens.

## Conventions and Patterns

- **Indicator Usage:** Follows a documented convention for indicator assignment (see comments in source).
- **Subfile Paging:** Implements standard subfile paging using counters and clear/create subroutines.
- **Positioning Logic:** Uses `setll`, `chain`, and `read/readp` for precise positioning within logical files.
- **Extensibility:** The code is structured to allow easy modification for different access paths or additional search criteria.

---

**Note:**  
This program is a template for subfile-based inquiry and selection screens in the ASOKON system. The logic and structure are reusable for other master data lookups with similar requirements. The code is well-commented, with Norwegian variable names and business terminology, reflecting the domain and user base.