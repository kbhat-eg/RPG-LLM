## Overview

This program, RK981R, reorganizes special agreements (“spesialavtaler”) stored in the RKSALU file. It ensures that only valid customers (as determined by the RKUNLU file) retain their agreement entries while removing any obsolete or blank entries. It also includes logic for resetting and initializing the special agreement indicators in the customer file.

## Purpose and Flow

1. **Initialization Subroutine (`*inzsr`)**  
   - Calls the “nulkun” subroutine to clear all special agreement flags in the customer file (RKUNLU) before any reorganization.
   - Sets up the key list for customer lookups, combining firm and customer number.

2. **Main Loop**  
   - Reads through RKSALU (renamed internally as RKSALUR) in a loop.  
   - For each special agreement record:
     - If all agreement fields (RKSAT1, RKSAT2, RKSAT3) are blank, the record is deleted immediately.
     - Otherwise, the code checks if the corresponding customer exists in RKUNLU:
       - If the customer is found, “rkspav” is set to 1 (indicating a valid special agreement) and the record in RKUNLU is updated with the current timestamp, program name (RK981R), and user signature if those tracking fields are active.
       - If the customer is not found, the RKSALUR record is deleted because it references an invalid customer.

3. **Nullification Subroutine (`nulkun`)**  
   - Reads through every record in RKUNLU (renamed internally as RKUNLUR).  
   - Resets the “rkspav” field to zero, clearing any existing special agreement indicator.  
   - Updates each record similarly with timestamp, program name, and user signature fields (according to the current logic and tracking strategy).

## Notable Details

- **Version-Specific Tracking Fields (V6.10 / V6.11)**  
  The commented-out lines (e.g., “rkedat”, “rketim”) indicate older or alternative tracking fields. The current active tracking fields for time and user logs are “rk2dpt” (time) and “rkepgm” (program).  
- **Customer Validation**  
  The validation hinges on a successful “chain” operation to RKUNLU using a compound key (firm + customer number). This ensures that any special agreement is linked to a valid, existing customer.  
- **Blank Special Agreements**  
  The program removes agreement entries where all RKSAT fields are empty, preventing clutter in the RKSALU file.  
- **Structure and Conventions**  
  - The files are renamed (e.g., “rksapfr” → “rksalur”) for internal processing. This naming convention keeps references consistent across the codebase.  
  - Classic RPG cycle operations are replaced by manual control of record I/O, making the logic more explicit.  
- **Implicit Cleanup Before Processing**  
  Running the “nulkun” subroutine before the main operations ensures that any existing agreement indicators in the RKUNLU file are reset. This is a deliberate choice to avoid contradicting or overwriting older data; the program then selectively sets the new “rkspav” only for valid agreements it finds in RKSALU.

## External Relationships

- **RKUNLU File**  
  The “rkunlu” file, renamed to “rkunlur” for updates, holds the customer records. The “rkspav” field in this file indicates the presence of a special agreement.  
- **RKSALU File**  
  The “rksalu” file, renamed to “rksalur,” contains the special agreement entries. Each entry must match a valid firm and customer record in RKUNLU to remain in the system.  

By consolidating and cleaning up the references between these two files, RK981R helps maintain consistent and valid special agreement data for customers in the ASOKON system.