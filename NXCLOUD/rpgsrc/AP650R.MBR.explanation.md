# AP650R – Common Program for Call Stack Inspection

## Purpose

AP650R is a utility program designed to inspect the program call stack at runtime. Its main function is to determine whether a specific program (passed as a parameter) exists in the current call stack. This is typically used to validate calling context, enforce call hierarchies, or implement security or business rules dependent on the call path.

## Structure Overview

- **Header and Metadata**: The header provides a brief description, version history, and change log. Notably, a 2018 update addresses limitations with long call stacks.
- **Data Definitions**: Several data structures are defined for:
  - Local data area fields (user, firm, etc.)
  - Program status (SDS)
  - API call parameters and buffers
  - Call stack entry parsing
  - Input/output parameters
- **Main Logic**: Implemented in /free format, it invokes the `QWVRCSTK` API to retrieve the call stack and iterates through each entry to search for the specified program.
- **Subroutines and *INZSR**: Handles parameter initialization.

## Key Business/Domain Logic

- **Call Stack Inspection**: The program is used as a common utility (“fellesprogram”) to check if a given program is present in the current execution stack. This can be used for security, auditing, or business logic enforcement.
- **Parameterization**: The program receives two parameters:
  - `p_prog`: The program name to search for in the stack.
  - `p_stat`: A status flag, set to '1' if the program is found.

## Detailed Code Walkthrough

### Data Definitions

#### Local Data Area

```rpg
d                uds
d l_wsid                901    910
d l_user                        10
d l_filg                931    933
d l_firm                944    946  0
d l_fnav                951    980
```
- Not used in the main logic, but reserved for compatibility or potential extensions.

#### Program Status (SDS)

```rpg
d ProgStatus     sds
d  Parms            *PARMS
d  ProgName         *PROC
d  ErrMsgID              40     46
d  ErrMsg                91    169
d  JobName              244    253
d  Userid               254    263
d  JobNumber            264    269
```
- Standard SDS fields, available for logging or error handling if needed.

#### Call Stack API Interface

```rpg
d FindCaller      PR                  Extpgm('QWVRCSTK')
d                             3000a
d                               10I 0
d                                8a   CONST
d                               56a
d                                8a   CONST
d                               15a
```
- Prototype for the IBM API `QWVRCSTK`, which retrieves the call stack.
- The API requires several parameters, including:
  - Receiver variable (buffer for call stack data)
  - Length of receiver variable
  - Format name ('CSTK0100')
  - Qualified job name info
  - Format of job ID info ('JIDF0100')
  - Error code structure

#### Call Stack Data Structures

```rpg
d Var             DS          3000
d  BytAvl                       10I 0
d  BytRtn                       10I 0
d  Entries                      10I 0
d  Offset                       10I 0
d  EntryCount                   10I 0
```
- Buffer for call stack data returned by the API.
- Fields are mapped for parsing the returned structure.

#### Entry Structure

```rpg
d Entry           DS           256
d  EntryLen                     10I 0
d  ReqstLvl                     10I 0 Overlay(Entry:21)
d  PgmNam                       10a   Overlay(Entry:25)
d  PgmLib                       10a   Overlay(Entry:35)
```
- Used to parse each individual entry in the call stack.
- Offsets are based on IBM API documentation for CSTK0100 format.

#### Other Variables

- `VarLen`: Holds the size of the Var DS for the API call.
- `ApiErr`: Error code buffer for the API call.
- `Caller`, `WhoCalled`: For potential use in constructing call path information.
- `i`: Loop index.

### Main Processing Logic

#### API Call

```rpg
CallP FindCaller(Var:VarLen:'CSTK0100':JobIdInf:'JIDF0100':ApiErr);
```
- Calls `QWVRCSTK` to populate `Var` with call stack data.

#### Loop Through Call Stack

```rpg
For i = 1 to EntryCount;
   Entry = %subst(Var:Offset + 1);
   If PgmNam = p_prog;
      p_stat = '1';
   Endif;
   Offset = Offset + EntryLen;
Endfor;
```
- Iterates through each call stack entry.
- Extracts entry data from the buffer using the current offset.
- Compares the program name from the stack (`PgmNam`) with the input parameter `p_prog`.
- If a match is found, sets `p_stat` to '1'.
- Advances the offset by the entry length to process the next entry.

### Parameter Handling and Subroutine

```rpg
c     *entry        plist
c                   parm                    p_prog
c                   parm                    p_stat
```
- Standard entry parameter list.
- Parameters are defined in *INZSR to ensure correct mapping at program start.

### Program Termination

```rpg
c                   eval      *inlr = *on
c                   return
```
- Ensures proper program closure and resource release.

## Design Decisions and Conventions

- **API Usage**: Leverages IBM’s `QWVRCSTK` API for robust stack inspection instead of manual or less reliable methods.
- **Format and Buffer Sizing**: The buffer sizes (3000 bytes for the stack, 256 bytes for entry parsing) are chosen to accommodate typical call stack depths. There is a note in the change log about handling long stacks.
- **Overlay Usage**: Overlays are used to map specific fields in the API structures, following IBM documentation for CSTK0100.
- **Parameter-Driven**: The utility is generic and reusable, driven entirely by input parameters.

## Integration Points

- **Called by Other Programs**: This program is intended to be called by other business logic modules that need to check their call context.
- **No Direct Database or File I/O**: The program does not interact with databases or files; its sole purpose is stack inspection.
- **Error Handling**: Minimal; assumes the API call will succeed or that errors will be handled by the caller.

## Usage Example

A calling program would invoke AP650R, passing the program name to check and a status variable. After the call, it inspects the status variable to determine if the named program is in the call stack.

## Summary

AP650R is a reusable, parameter-driven utility for inspecting the call stack and determining if a specific program is present. It is built around the QWVRCSTK API, uses standard IBM API data structures, and is intended for use as a foundational building block in enforcing business or security rules based on call context. The code is robust against long call stacks and is designed for integration into larger RPG application suites.