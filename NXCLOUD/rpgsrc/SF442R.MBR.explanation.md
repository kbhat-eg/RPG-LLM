# RPG Program Explanation: SF442R - Selection of Statistical Transactions

This RPG (Report Program Generator) program is designed to select and process statistical transaction records from sales data, with various selection criteria. The program is written in ILE RPG (RPG IV) with fixed-format specifications.

---

## Structure Overview

- **Title and Comments:**  
  The initial lines (marked as `*`) provide a header with system, program name, description, and a changelog.
- **File Declarations (`F-specs`):**
- **Data Declarations (`D-specs`):**
- **Calculation Logic (`C-specs`):**

Each section is explained in detail below.

---

## 1. File Declarations

```rpg
Fsstapf    if   e             disk
Fskwwpf    o  a e           k disk
```

- **sstapf:** Input file (disk file) containing the sales statistics records to be processed.
- **skwwpf:** Output file, written with the selected and sorted records.

---

## 2. Data Declarations (Fields and Variables)

```rpg
D                uds
D pakode                300    301
D pakod1                300    300
6.nu D paofra           302    309  0
6.nu D paotil           310    317  0
6.nu D patype           318    325
6.nu D patyp1           318    319
6.nu D patyp2           320    321
6.nu D patyp3           312    323
6.nu D patyp4           324    325
6.nu D papaar           326    329  0
D lcuser                911    920
D lcfirm                944    946  0
D lcnavn                951    980
```

- **pakode, pakod1:** Selection code(s) used to determine selection logic (example: 'O' for order, 'F' for invoice).
- **paofra, paotil:** From and to ranges for order/invoice numbers.
- **patype, patyp1 - patyp4:** Four types for order type selection.
- **papaar:** Year selection.
- **lcuser, lcfirm, lcnavn:** User, firm, and name information used for processing.

_Note: The numbers (300, 301, etc.) are likely indicators of positional input (for data from a display/input buffer or data structure)._

---

## 3. Calculations and Main Logic

### Start of Main Program Loop

```rpg
C     xtrans        tag
```
Defines the starting point ("tag") for transaction processing.

### Reading Sales Statistics

```rpg
c                   read      sstapfr                                lr
```
Reads the next record from the input file (`sstapf`). If it's end-of-file, indicator `LR` is set.

#### End-Of-File Handling

```rpg
c                   if        *inlr = *on
c                   goto      endprg
c                   endif
```
If last record indicator (`*INLR`) is on (end of file), program flow jumps to `endprg` tag to finish.

---

### Selection Criteria

#### 1. Company Check

```rpg
if sffirm <> lcfirm
   goto xtrans
endif
```
Skips the record if the company (`sffirm`) does not match the selected company (`lcfirm`).

#### 2. Year Check

```rpg
if sfpaar <> papaar
   goto xtrans
endif
```
Skips record if the transaction year (`sfpaar`) does not match the selected year (`papaar`).

#### 3. Order Type Check

```rpg
if patype <> *blank
   if sfotyp <> patyp1
      if sfotyp <> patyp2
         if sfotyp <> patyp3
            if sfotyp <> patyp4
               goto xtrans
            endif
         endif
      endif
   endif
endif
```
- If a specific order type is being filtered (`patype` not blank), then the transaction's type (`sfotyp`) must match one of the four given types (`patyp1-4`). Otherwise, skip the record.

#### 4. Selection by Order or Invoice Number Range

Depending on the value of `pakod1`:
- If 'O' (Order):

   ```rpg
   if sfornr < paofra
      goto xtrans
   endif

   if sfornr > paotil
      eval *inlr  = *on
      goto endprg
   endif
   ```

- If 'F' (Invoice):

   ```rpg
   if sfbinr < paofra
      goto xtrans
   endif

   if sfbinr > paotil
      eval *inlr  = *on
      goto endprg
   endif
   ```

- **Logic:** The transaction's order/invoice number must be within the specified range (`paofra` to `paotil`). If below, skip it; if above, abort further processing as records are assumed sorted by this field.

---

### Output Processing

After passing all selection checks:

#### Assign Sorting Key

```rpg
if pakod1 = 'O'
   movel sfornr  swsrt1
endif

if pakod1 = 'F'
   movel sfbinr  swsrt1
endif
```
- Depending on the selection type (order or invoice), set the main sort key (`swsrt1`) for output.

#### Write to Output File

```rpg
write  skwwpfr
```
- Write the selected and processed record to the output file.

#### Process Next Record

```rpg
goto xtrans
```
- Loop to process the next record.

---

### Program End and Initialization

```rpg
C     endprg        tag
```
Marks the end of the program.

#### Initialization Subroutine (`*inzsr`)

```rpg
C     *inzsr        begsr
  eval      swsrt1 = *blank
  eval      swsrt2 = *blank
  eval      swsrt3 = *blank
C                   endsr
```
- Clears the sorting fields at program start.

---

## Summary

**What does this program do?**

- Reads records from a sales statistics file.
- Filters records based on company, year, order type, and number range (order or invoice).
- Assigns a sorting key according to the selected range type.
- Writes qualifying records to an output file for further processing or reporting.

**Who should read this?**

- RPG developers responsible for sales/statistics reporting, especially those working with similar selection/filtering logic.
- Developers maintaining or extending reporting functions in RPG IV (ILE RPG) environments.

---

**Tip:**  
The field names and much of the logic suggest that this program is part of a batch reporting process, possibly feeding into further analysis or reporting on sales statistics, filtered by specific criteria.