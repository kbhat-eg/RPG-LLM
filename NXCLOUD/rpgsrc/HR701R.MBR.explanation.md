# HR701R: Handheld Transactions – Creation of Purchase Proposals

## Overview

This program, **HR701R**, is a core module in the ASLAGR system responsible for transferring transactions from handheld terminals into the purchase proposal subsystem. It reads temporary transaction data, creates or updates purchase proposal headers and lines, and handles various business rules regarding pricing, units, supplier logic, and status codes. The program is heavily parameterized and switch-driven, supporting customer-specific requirements and evolving business logic through versioned enhancements.

---

## Key Business Process

1. **Input**: Transactions from handheld terminals (radio terminals), typically representing stock movements or requests for purchase.
2. **Processing**:
    - Reads transaction records.
    - For each, either creates or updates a purchase proposal header.
    - Adds or updates lines in the purchase proposal.
    - Applies business rules for pricing, units, supplier selection, and status codes.
3. **Output**: Records in the purchase proposal tables, ready for further processing (e.g., actual purchase order creation).

---

## Main Data Flow and Interactions

- **Input Files**:
    - `lwhbl1` / `lwhblu`: Handheld terminal transactions (header & update).
    - `vvarl1`, `vvenl1`, `vvenl4`, `vlagl1`: Item and warehouse master data.
    - `lstsl1`: Warehouse status codes.
    - `lodtlv`, `lohelr`: Purchase order details and headers.
    - `votylr`: Order types.
    - `rlevl1`: Supplier master data.
    - `lfhelu`, `lfdtlu`: Purchase proposal headers and lines.

- **External Programs**:
    - `VP700R`: Standard price retrieval.
    - `VP753R`: Purchase price retrieval (preferred over standard cost).
    - `AS100R`: Sequence number generator for new proposals.
    - `VL711R`: Price group determination.
    - `CO402R`: Switch/settings retrieval (for customer-specific logic).
    - `HR112R`: Splitting proposals by supplier if undetermined.
    - `LH714R`: Recalculation of proposal header totals.

- **SQL Usage**:
    - Used for fetching logistics assortment and order type data (notably for "internal orders").

---

## Program Structure

### 1. Initialization (`*inzsr`)

- Receives parameters: time, proposal number, status.
- Sets up key lists for all relevant files.
- Loads company number and timestamp.
- Determines price group (`VL711R`).
- Reads system switches via `CO402R` for:
    - Overriding status code 6 (`BESTF_STATUS6`).
    - Seller assignment logic (`HR701_806`).

### 2. Main Processing (`opprett` subroutine)

- Iterates through all relevant handheld transactions.
- For each, if this is the first line for a proposal, creates a new proposal header:
    - Populates from warehouse status, user, and supplier data.
    - Handles seller assignment based on switches and supplier data.
    - Handles origin code logic.
    - Determines order type (internal/external) via SQL if needed.
- For each transaction, creates a proposal line:
    - Fetches item and warehouse data.
    - Determines the correct unit and conversion factor (`finn_enhet`).
    - Calculates price using both standard and purchase price routines (`finn_pris`).
    - Assigns proposal line fields, including logistics assortment.
    - Determines the correct supplier (overridden if needed).
    - Applies status code logic (`sjekk_status`).
    - Writes the new line and deletes the processed transaction.
- After all lines, recalculates header totals (`LH714R`).
- If supplier was undetermined, calls `HR112R` to split proposals by supplier.

### 3. Subroutines

- **`finn_pris`**: Retrieves and calculates item price, preferring purchase price over cost price.
- **`finn_varelag`**: Fetches minimum and recommended stock levels from warehouse data.
- **`sjekk_status`**: Assigns status codes based on business rules (quantity, minimums, backorders, cross-docking).
- **`sjk_best`**: Checks for outstanding orders/backorders for the item.
- **`hent_bnumm`**: Gets the next available proposal number (`AS100R`).
- **`finn_enhet`**: Determines the correct sales/purchase unit and conversion factor for the item, adjusting quantity and weight as needed.
- **`finn_otyp`**: For internal orders, fetches the correct order type via SQL.

---

## Domain-Specific and Non-Obvious Logic

### Status Code Assignment

- Status codes (e.g., 4, 5, 6, 7) are assigned based on:
    - Whether ordered quantity matches recommended/minimum stock.
    - Whether quantity is a multiple of warehouse unit.
    - Presence of outstanding backorders.
    - Whether the item is flagged for cross-docking.
- Status code 6 can be overridden by a system switch (`BESTF_STATUS6`), allowing customer-specific behavior.

### Pricing

- The program prefers purchase price (from `VP753R`) over standard cost for value calculation, reflecting a business decision to use the most accurate cost basis.
- Price group is dynamically determined per item/transaction.

### Units and Conversion

- Handles up to three sales/purchase units per item, with conversion factors.
- For items with multiple units, the correct conversion is selected based on the transaction unit.
- Weight handling is enhanced for items measured in different units.

### Supplier Selection

- If the supplier is not specified in the transaction, the program can split the proposal by supplier using an external routine (`HR112R`).
- Seller assignment can be controlled by a system switch, reflecting customer-specific workflow.

### Customer-Specific Switches

- The program is designed to be highly configurable via external switches (retrieved by `CO402R`), allowing for:
    - Status code overrides.
    - Seller assignment logic.
    - Other customer-specific behaviors.

### SQL Integration

- SQL is used for certain data retrievals (logistics assortment, order type for internal orders), which is less common in traditional RPG programs but allows for more flexible and powerful data access.

---

## Patterns and Conventions

- **Versioned Comments**: Extensive use of versioned and dated comments to document changes, especially for customer-specific logic.
- **Switch-Driven Logic**: Many business rules are controlled by external switches, making the program highly adaptable.
- **Separation of Concerns**: Subroutines are used to encapsulate distinct business rules (pricing, status, units, etc.).
- **Key List Usage**: Standardized key lists for all file access, promoting consistency and maintainability.

---

## File and Module Relationships

- **Handheld Transaction Files** (`lwhbl1`, `lwhblu`): Source of input data, deleted as processed.
- **Purchase Proposal Files** (`lfhelu`, `lfdtlu`): Main output, holding headers and lines for proposals.
- **Item and Warehouse Master Files** (`vvarl1`, `vvenl1`, `vvenl4`, `vlagl1`): Used for fetching item/warehouse details, units, and conversion factors.
- **Supplier and Order Files** (`rlevl1`, `lohelr`, `lodtlv`, `votylr`): Used for supplier assignment, order type, and checking outstanding orders.
- **External Programs**: Used for price lookups, sequence numbers, recalculation, proposal splitting, and configuration switches.

---

## Indicators

- Indicator usage is well documented:
    - `LR`: End of program.
    - 10–16: Display/roll indicators (legacy, not used in this batch program).
    - 30–99: Various work, error, and file indicators.

---

## Summary

**HR701R** is a central, highly-configurable batch program for transforming handheld terminal transactions into purchase proposals. Its design reflects years of business evolution, customer-specific requirements, and a focus on accurate, flexible order preparation. Developers onboarding to this module should pay special attention to the switch-driven logic, the interplay between files and external routines, and the encapsulation of business rules in subroutines.

For any enhancements or debugging, understanding the system switches and their impact on business rules is critical, as is familiarity with the external programs and their expected inputs/outputs. The program is a good example of a mature RPG application with a clear focus on adaptability and maintainability.