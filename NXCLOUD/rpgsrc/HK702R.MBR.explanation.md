## Overview

This program (`HK702R`) is part of the ASLAGR system and is responsible for extracting customer information and producing a file (`PSI`) for use with a handheld terminal. The main business purpose is to generate a register for external scanning of the customer master file, likely for synchronization or lookup operations on portable devices.

## High-Level Flow

1. **Parameter Initialization:** The program receives as parameters a company identifier (`firm`) and up to five category codes (`kat1` to `kat5`).
2. **Category Check:** If no category is specified, the program exits immediately.
3. **Customer File Scan:** The program reads through all customer records in the `rkunl1` file, filtering by the specified categories.
4. **Record Processing:** For each customer matching the criteria, it formats a line and writes it to the output file (`hbkupf`), which acts as the scan register for the handheld terminal.

## Data Structures and Files

### Files

- **rkunl1**: Customer master file (input), renamed from `rkunpfr` to `rkunl1r`.
- **hbkupf**: Output file (external scan register), renamed from `hbkupfr` to `hbkupfr`.

### Data Structures

- **d_krec (DS, 37 bytes):** Overlayed to provide access to customer number (`d_kund`), name (`d_navn`), and a code (`d_kode`) within the same buffer. This is a legacy technique for formatting fixed-length records.
- **Parameter Variables:** `p_firm`, `p_kat1`-`p_kat5` are used for filtering.
- **Working Variables:** 
  - `w_firm`: Local copy of firm parameter.
  - `w_kata`: Category code from the current customer record.
  - `w_kund_alf`: Customer number (alphanumeric for output).
  - `w_kinf`: Buffer for the formatted output line.

### Key Lists

- **rkunl1_key:** Used to set the read position in the customer file, composed of company (`w_firm`) and customer number (`rkunl1_kund`).

## Main Logic Details

### 1. Program Initialization (`*inzsr`)

- **Parameter Mapping:** The program expects a parameter list with the firm and five category codes. These are mapped to local variables at startup.
- **Key List Preparation:** Prepares the key list for reading the customer file by firm and customer number.

### 2. Early Exit on No Category

- If all five category parameters are blank, the program skips processing and ends immediately. This prevents unnecessary file scans.

### 3. Customer File Processing Loop

- **Set Start Position:** The customer file is positioned at the beginning for the given firm.
- **Loop Through Customers:** Reads each customer record in turn.
  - **Category Check:** For each customer, checks if the customer's category (`rkkatg`) matches any of the supplied categories or the special value `'AL'`. This allows for an "all" selection or filtering.
  - **Processing:** If the customer is selected, the subroutine `behandling` is called.

### 4. Record Processing (`behandling` subroutine)

- **Clear Output Buffer:** Ensures a fresh record for each output.
- **Format Output:** Constructs a semicolon-separated string in `w_kinf`:
  - Prefix `KR;***;`
  - Customer number
  - Customer name (trimmed)
- **Write Output:** Assigns the formatted string to the output file field (`hkinfo`) and writes the record to `hbkupf`.

### 5. Program Termination

- Sets the last record indicator (`*inlr`) and returns, ensuring proper cleanup.

## Noteworthy Design Decisions and Conventions

- **Legacy Style:** The program uses fixed-format RPG IV (not free-form), overlayed data structures, and explicit indicators, reflecting an older codebase style.
- **Parameterization:** All filtering is driven by parameters, supporting flexible batch processing or integration into larger workflows.
- **Category Filtering:** The use of `'AL'` as a wildcard category is a business convention allowing for inclusion of all customers.
- **Output Formatting:** The output is specifically formatted for downstream systems (handheld terminal), using semicolon delimiters and a fixed prefix, which is likely a protocol requirement.
- **Separation of Concerns:** The main loop delegates output record creation to a subroutine, keeping the main logic readable and maintainable.

## Integration Points

- **Customer File (`rkunl1`):** The primary source of customer data.
- **Scan Register File (`hbkupf`):** The target file for export, which is presumably picked up by or transferred to the handheld terminal system.
- **Parameters:** The program is likely invoked as part of a batch process or from another application, passing in the firm and category codes as needed.

## Business Logic Summary

- The program supports selective export of customers based on up to five categories, or all customers if `'AL'` is specified.
- Each exported record contains the customer number and name, formatted for compatibility with external scanning devices.
- The process is designed for efficiency, skipping processing entirely if no categories are specified.

---

**In summary:**  
This program is a batch utility for extracting a filtered list of customers into a scan register file for handheld terminal use, supporting flexible category-based selection and conforming to legacy data and formatting conventions within the ASLAGR system.