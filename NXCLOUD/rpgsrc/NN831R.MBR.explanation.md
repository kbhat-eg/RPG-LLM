# RPG Program NN831R: "Nettbutikk, hent reskontroposter"
This program is designed to fetch customer ledger entries ("reskontroposter") for a web shop (nettbutikk) system. It works using IBM i data queues for input and output and processes requests to return ledger details for a specified customer and date.

---

## 1. **Header and File Declarations**
```rpg
h option(*nodebugio) datedit(*dmy)
frktrl2    if   e           k disk    rename(rktrpfr:rktrl2r)
```
- **H spec:** disables debugging for I/O operations, sets date edit word to DMY.
- **File Declaration:** `rktrl2` is an externally described file (likely customer ledger), renamed to `rktrl2r` in this program.

---

## 2. **Parameter and Variable Definitions**
### Parameters (Passed into the Program, ref `*entry` plist)
```rpg
d p_uniq      s   15
d p_dtqi      s   10
d p_dtqo      s   10
d p_bibl      s   10
d p_feil      s   1
d p_firm      s   3  0
d p_lage      s   2
...
```
- Parameters for data queue names, library, error flag, company code, warehouse code, etc.

### Working Variables
```rpg
d w_firm      s   like(rnfirm)
d w_anta      s   2  0
d w_tell      s   5  0
d w_retn      s   1
...
```
- Includes counters, direction flags, date fields, etc.

### Data Structures for Data Queues
#### Input DS — data from input queue:
```rpg
d                 ds
d d_inpu                        51
d  d_kund        6  0 overlay(d_inpu: 1)
d  d_dato        8    overlay(d_inpu: 7)
d  d_tbla         z   overlay(d_inpu:15)
d  d_dbla        8    overlay(d_inpu:41)
d  d_anta        3    overlay(d_inpu:49)
```
- **d_kund:** Customer no.
- **d_dato:** Date
- **d_tbla:** Date/time stamp (zoned decimal)
- **d_dbla:** Paging date
- **d_anta:** No. of records to fetch

#### Output DS — for total count and for each record:
```rpg
d                 ds
d d_out1                         6
d  d_rec1        1  0 overlay(d_out1: 1) inz(1)
d  d_tota        5  0 overlay(d_out1: 2)

d                 ds
d d_out2                        97
d  d_rec2        1  0 overlay(d_out2: 1) inz(2)
d  d_biln        8  0 overlay(d_out2: 2)
d  d_bdat        8    overlay(d_out2:10)
d  d_btxt       20    overlay(d_out2:18)
d  d_fdat        8    overlay(d_out2:38)
d  d_belo       13    overlay(d_out2:46)
d  d_rbel       13    overlay(d_out2:59)
d  d_tist         z   overlay(d_out2:72)
```
- First queue (`d_out1`) returns total count. Second queue (`d_out2`) returns each ledger record.

---

## 3. **Main Program Loop**
```rpg
c                   dou       d_inpu = *blank
    ...
c                   call      'QRCVDTAQ'
    ... (input parameters)
c                   if        d_inpu <> *blank
c                   exsr      behandling
c                   endif
c                   enddo
```
- Waits on the **input data queue** (`QRCVDTAQ`) for a request.
- If a request is present, calls main handler subroutine `behandling`.

---

## 4. **Main Handler: `behandling` Subroutine**
### a. **Sets Proper Date if Blank**
```rpg
c                   if        d_dato <> *blank
c                   move      d_dato        w_dato_8
c                   else
c                   time                    w_dato
c     *iso0         move      w_dato        w_data_8
c                   move      0101          w_data_8
c                   move      w_data_8      w_dato_8
c                   endif
c     *iso          move      w_dato_8      w_dato
```
- If no date is given, defaults to January 1st of the current year.

### b. **Determines Paging Date**
```rpg
c                   eval      w_dbla = *loval
c                   if        d_dbla <> *blank
c                   move      d_dbla        w_dato_8
c     *iso          move      w_dato_8      w_dbla
c                   endif
```
- Sets `w_dbla` (paging or "bla" date) if provided.

### c. **Counts Total Records to Return**
```rpg
c                   exsr      tell_total
```
- Calls subroutine to count number of matching records and sends that on the output data queue.

### d. **Determines Paging Direction and Size**
```rpg
c                   select
... various count/direction decision logic
c                   endsl
```
- Decides how many records to return and in which direction (forward/backwards) based on `d_anta`.

### e. **Fetches and Outputs Records**
```rpg
c                   exsr      hent_poster
```
- Calls subroutine to read records from file and send each to the output data queue.

---

## 5. **Subroutines**

### `hent_poster` ("Fetch Records")
- Positions to correct point in file (using keys: firm, customer, date, etc.).
- If paging date is supplied, uses that as start.
- Chooses SETLL or SETGT based on direction.
- Reads file in correct direction (READ/READP).
- For each record:
    - Formats output fields.
    - Sends to output data queue (`QSNDDTAQ`).
    - Increments the counter.
    - Continues until desired count or end-of-file.

### `tell_total` ("Count Total Matching Records")
- Positions at the start of the customer’s ledger entries.
- Loops through all records for the customer/company, incrementing a counter.
- At the end, sends the total count to output data queue.

### `*pssr` Error Handler
- Sets error flag and returns.

### `*inzsr` Initialization Routine
- Handles parameter list.
- Sets up key list for file access.
- Sets the firm/company code in a work variable.

---

## 6. **Data Queue Usage**
- **QRCVDTAQ** is called to receive input from a named data queue.
- **QSNDDTAQ** is called to send output (totals and individual records) to an output data queue.

---

## 7. **Business Logic Summary**
- Receives requests (customer, date, paging info) via data queue.
- Calculates total matching ledger entries.
- Sends total to output queue.
- Outputs requested "page" of ledger entries for the customer, based on direction and count, using paging logic.
- Handles positioning and date calculations to efficiently page through the ledger file.

---

## 8. **General Flow**
1. Wait for input request.
2. Check/set start date and paging variables.
3. Count total entries for the customer.
4. Determine paging direction and page size.
5. Fetch and output requested entries.
6. Repeat.

---

## 9. **Key Points for Onboarding**
- **Data Queues** are the interface for communication.
- **Paging** logic (direction and page size) is determined from the input.
- **File Access** uses composed key (company, customer, date, timestamp).
- **Subroutines** handle the main business steps: counting, paging, output formatting.
- **Error Handling** is simple — sets a flag and returns.
- **Parameter List** is extensive and flexible, allowing different configurations.

---

## 10. **Special Considerations**
- Date manipulation is mostly manual, beware of correct formats.
- Read direction (forward/back) is important for correct paging results.
- Overlaid data structures are used for parsing queue messages.
- Extensive use of legacy RPG syntax (fixed-format, subroutines).

---

**In summary:**  
This program is a classic IBM i batch handler for customer ledger paging via data queues, with logic for count, page, date defaulting, and error flagging. The fixed-format style is typical for older RPG, but the business logic is modular and easy to follow once the paging and queue mechanics are understood.