# Overview

This program (`AP613R`) is an ILE RPG (RPG IV) routine whose purpose is to scan an input string and transform it into an XML-safe string by replacing or encoding various characters, especially those that are not valid or safe in XML contexts (such as special symbols and extended ASCII/ISO characters). The program handles a variety of European letters and supports cleaning the string for safe insertion into XML documents. 

There is also evidence of special handling for Norwegian characters and custom business requirements.

## Key Concepts

- **Input/Output Parameters**: The program takes an input string and returns a processed output string.
- **XML Escaping**: Characters that are problematic in XML, such as `<`, `>`, `&`, etc., are escaped into their XML entities (`&lt;`, `&gt;`, `&amp;`, etc.).
- **Special Character Encoding**: Extended characters (including Scandinavian and Germanic letters) are converted to their respective numeric XML entities.
- **SQL Usage:** There is use of a SQL regular-expression-based cleaning step (conditional, may be only in recent versions or comments).

---

# High-Level Structure

1. **Header/Version Control**:  
   Detailed version and change log at the top, useful for maintenance and context.

2. **Data Definitions**:
   - Parameter definitions (`p_input`, `p_outpt`, `p_lr`)
   - Working variables for string manipulation

3. **Main Logic**:
   - Initialization of result variables.
   - Translation of certain problematic characters.
   - Calling the main conversion subroutine (`xml_konv`).
   - Final output assignment.

4. **Subroutine `xml_konv`**:
   - Performs character-by-character and substring manipulations to escape/encode according to XML standards and business rules.

5. **Initialization Subroutine**:
   - Assigns inbound parameters to local variables.

---

# Detailed Flow

## 1. Entry and Parameters

```rpg
d p_lr            s              1
d p_input         s            512
d p_outpt         s            512
```
- **p_input**: Input string to be cleaned.
- **p_outpt**: Output string after cleaning.
- **p_lr**: Indicator for setting `*inlr` (end of program/activation group).

## 2. Input Washing/Cleansing

- **SQL Option Setup** (possibly for language/collation handling).
- The input buffer is initialized to blanks.
- There is commented and/or versioned code for an SQL REGEXP that strips out any character not on an allowed list, replacing them with spaces.

## 3. Quick Character Translations

```rpg
6.10 c     x'3F':'A'     xlate     p_input       p_input
7.01ac     x'1C':' '     xlate     p_input       p_input
7.01ac     x'25':' '     xlate     p_input       p_input
```
- **XLATE** is used to quickly replace certain single characters in the input string for known problematic values (hex values shown).

## 4. Main Conversion (`xml_konv` Subroutine)

The heart of the program. Steps include:

### a. Initial Handling of `~` and `&`

Because both `~` and `&` need to be handled specially (the ampersand must be XML-escaped, but a literal `~` is also in use as a temporary placeholder):

- Temporary substitution of `~` with `]` to prevent its accidental conversion.
- Replace all `&` with `~amp;`
- Replace all `~` back with `&`
- Then, revert `]` to `~` (restore original `~`)

This is a workaround to safely handle both characters.

### b. Core XML Escaping

For each “dangerous” character, the routine repeatedly scans the string for that character and replaces each occurrence with the appropriate XML entity:

| Character | Replacement          |
|-----------|---------------------|
| `'&'`     | `&amp;`             |
| `'''`     | `&apos;`            |
| `'"'`     | `&quot;`            |
| `'<'`     | `&lt;`              |
| `'>'`     | `&gt;`              |

### c. Extended and European Characters

Handles accented/Scandinavian letters, replacing them with their numeric XML entities (e.g. `'�'` becomes `&#229;` for `å`).

Examples:
- `'�'` (Å): `&#197;`
- `'�'` (å): `&#229;`
- `'�'` (Æ): `&#198;`
- `'�'` (æ): `&#230;`
- `'�'` (Ø): `&#216;`
- `'�'` (ø): `&#248;`
- Many additional characters like accented A, E, O, U, etc.

This ensures that any character outside the ASCII/basic set that XML parsers may choke on is properly represented.

### d. Assignment

At the end of the subroutine, the processed string is assigned back to `w_str_out`.

---

## 5. Cleanup & Program Exit

At the end, if `p_lr = '1'` (last record/return), `*INLR` is set to `*ON` to end the program properly in an ILE environment.

---

# Parameter List Setup

The subroutine `*inzsr` (auto-called on activation) sets up the parameter list, assigning values to the local variables.

---

# Notable Aspects

- **Extensive Comments** and **change log**: Useful for future maintenance and to understand the rationale for changes.
- **Support for SQL RegExp**: There's commented-out or version-dependent SQL code for server-side string cleansing.
- **Special Norwegian and Scandinavian Characters**: The program is carefully customized for extended alphabet support (important in Nordic contexts).
- **Defensive Programming**: Careful handling to avoid bugs in translating overlapping or problematic characters (notably `~` and `&`).

---

# Summary

**Main Purpose:**  
Take an input string, sanitize it for XML, and return the result—by escaping XML-special characters, replacing/removing "illegal" characters, and converting extended European characters into XML-safe entities.

**When to Use:**  
Anytime you need to ensure that strings passed to XML in a Nordic/Scandinavian ERP or business context are valid and well-formed.

**Key Maintenance Areas:**  
- **Character Mapping:** For new required characters, add further scan/replace blocks in the `xml_konv` subroutine.
- **SQL Cleansing:** Enable/expand the regular-expression-based cleansing as database capabilities allow.
- **Version Control:** Review the change log for historic reasons for tricky handling.

---

# Quick Reference

**To add a new character mapping:**
1. In subroutine `xml_konv`, add a block:
   ```rpg
   w_x = %scan('X':w_str_in);
   dow w_x > 0;
      w_str_in = %subst(w_str_in:1:w_x-1)
                + 'REPLACEMENT'
                + %subst(w_str_in:w_x+1);
      w_x = %scan('X':w_str_in);
   enddo;
   ```
where `'X'` is the character to replace and `'REPLACEMENT'` is the XML entity or value.

---

**Best practices:**  
- Always test new/edge characters.
- Ensure correct encoding/decoding between RPG and external XML users.
- Consider expanding the SQL cleansing for other dangerous inputs.

---

This code is a solid example of RPG business programming adapted for modern data interchange requirements and evolving European language needs.