# RPG Program SO511R — Explanation

This RPG program is part of a system called **ASOFAK**, and its purpose is to display invoice line items (fakturalinjer) from a sales system. The Norwegian comments and variable names indicate this is used in a Scandinavian setting. 

Below, we break down the main components and logic of the code for ease of onboarding.

---

## 1. **File Declarations (`F-Specs`)**

- **sohel1, sodtl1, vkhvl1**  
  These are physical files accessed as keyed disk files for reading invoice header, invoice detail, and account reference data, respectively. The `rename` keyword maps the file formats to new record names.
- **so511d**  
  This is a display file used for interacting with the user interface (`workstn`).

---

## 2. **Data Declarations (`D-Specs`)**

### **Parameters**

- **p_firm, p_aarr, ...**  
  These fields are parameters passed to the program. Many are defined as having the same type as existing fields (using `like(...)`).

### **Local Data Area**

- **l_fnav (951:980)**  
  Subfield within the user data structure (UDS).

### **Key Variables**

Variables such as `sohel1_aarr`, `sohel1_binr`, etc, are used to build the keys for file access (CHAIN operations).

### **Miscellaneous Variables**

- **w_firm, w_raba**  
  Working storage variables for the firm code and discounts.

---

## 3. **Initialization & Parameters**

### **Initialization Subroutine (`*inzsr`)**

- Accepts parameters (`plist`) and assigns them to local variables for later use.
- Sets up keyed data lists (`klist`) for the three main files accessed.
- Assigns the firm code parameter to the working variable (`w_firm`).

---

## 4. **Main Logic**

### **A. Load Header Data**

- The program assigns input parameters to key fields and performs a `CHAIN` read on the invoice header file (`sohel1`).
- If the header is not found (`*in90`), the program jumps to the `avslutt` (end) routine.

### **B. Load Detail Data**

- Similar logic applies to the invoice detail line file (`sodtl1`). It populates key fields and performs a `CHAIN` read.
- Again, if not found, control jumps to the program end.

### **C. Populate Screen Fields**

- The detail record’s fields are mapped to screen/display fields (e.g., `b1binr`, `b1numm`, `b1otyp`, etc.).
- `b1salg` (the sales amount) is calculated by subtracting various cost/discount fields from the gross sales (`sdsalg`).
- Project, account, and reference fields are also set.

### **D. Fetch Account Reference Info**

- Subroutine `hent_kto_henv` is called to obtain information about account references. It chains into `vkhvl1` using different variations of keys until a match is found, or it defaults to 'STD'.

### **E. Display the Screen**

- The screen is displayed with `exfmt b1bld`.
- The user can then use function keys; if the key pressed is cancel or exit, the program ends.

---

## 5. **Program End**

- The label `avslutt` sets the LR (last record) indicator and returns from the program, releasing resources.

---

## 6. **Subroutines**

### **hent_kto_henv**
- Attempts to find an account reference in `vkhvl1` matching different combinations (all keys, without account type, with zeroed level type, or with a default 'STD ' code) to ensure a default is always presented if no match exists.

---

## 7. **Key Lists**

- **sohel1_key**: Used for header lookup, includes firm, year, invoice series, invoice number, and suffix.
- **sodtl1_key**: Used for detail lookup, adds text code and line number.
- **vkhvl1_key**: Used for account reference lookup, with various combinations of fields depending on what is available.

---

## 8. **Enhancements and History**

- The header section documents chronological changes to the program, including additional fields, reordering of screen elements, and support for expanded numbering.

---

## 9. **Summary of Flow**

```
[Start] 
    |
    V
[Get Parameters]
    |
    V
[Read Header (sohel1) via KEY]
    |--[Not Found]--> [End]
    |
[Read Detail (sodtl1) via KEY]
    |--[Not Found]--> [End]
    |
[Populate Display Fields]
    |
[Fetch Account Reference Info]
    |
[Display Screen]
    | [Function Key Handling]
    |
[End]
```

---

## 10. **Key Norwegian Terms**

- **Faktura**: Invoice
- **Linje**: Line
- **Kontohenvisning**: Account reference
- **Rabatt**: Discount
- **Hode**: Header
- **Visning**: Display

---

## 11. **Takeaways for New Developers**

- This program is a read-only lookup and display utility for invoice lines.
- Enhancements and bug fixes are tracked in the header.
- Understanding key structures and how chained reads are performed is essential.
- Lookup fallbacks ensure some data is always shown, even if not all reference keys are found.

---

**For further onboarding, review the definitions in the file formats (`sohepfr`, `sodtpfr`, `vkhvpfr`) and the display file (`so511d`) for field mapping and layout details.**