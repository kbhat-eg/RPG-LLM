# Comprehensive Documentation: RK812R – Customer Selection for Autogiro

## Program Overview

**System:** ASOKON  
**Program:** RK812R  
**Title:** Utplukk til autogiro (Selection for Autogiro)  
**Purpose:**  
This program selects customers eligible for Autogiro (direct debit) processing. It filters customers based on a variety of criteria, including firm, customer number, department, category, seller, and date ranges. The resulting records are written to an output file for further Autogiro processing.

The program is designed to be called with a parameter list specifying the selection criteria. It reads customer master and transaction files, applies business rules, and outputs qualifying transactions.

---

## File Definitions

- **rktrl2**: Customer transaction file (postings), used for filtering and output.  
  - Renamed as `rktrl2r` in this program.
- **rkunpf**: Customer master file (primary), used for main customer selection.
- **rkunlu**: Customer master file (secondary), used for lookups and updates.
  - Renamed as `rkunlur` in this program.
- **rkw4pf**: Output file for qualifying records.

---

## Data Structures

### Selection Parameter Structure (`d_parm`)
A 120-byte structure overlayed for parameter passing. Key fields include:
- `pfirm`: Firm number
- `pknrf`, `pknrt`: Customer number range (from/to)
- `pavdf`, `pavdt`: Department range (from/to)
- `pkatf`, `pkatt`: Category range (from/to)
- `pself`, `pselt`: Seller range (from/to)
- `pkdat`: Date (YYMMDD)
- `pfdat`: Secondary date (YYMMDD)
- `palfa`: Alpha flag (sorting control)
- `pbilf`, `pbilt`: Additional customer number ranges (used in transaction selection)

### Key and Work Structures
- **`wkkey`/`wkalfa`**: Used for sorting and key management, overlays for firm, customer, date, and timestamp.
- **`wwdato`**: Work date (YYYYMMDD)
- **`wnrest`**: Running total for transaction amounts per customer.

---

## Indicator Usage (From Header)

- **KA (F1)**: Select firm
- **KC (F3)**: Exit
- **LR**: End program
- **30**: Field protection
- **31–59**: Error/warning indicators
- **60–69**: File indicators (chain, etc.)
- **70–79**: Work indicators (subroutines)
- **80–89**: General work indicators
- **90–99**: Standard subroutine indicators

---

## Main Logic Flow

### 1. Initialization

- The program is called with a parameter list (`d_parm`), which is parsed into individual fields.
- Key lists for file access are set up.
- Work fields for date and selection are initialized based on the provided parameters.

### 2. Customer Selection Loop

- The program starts at the first customer matching the firm and (optional) customer number lower bound.
- For each customer in `rkunpf`:
  - **Firm check**: Exit if firm changes.
  - **Customer range check**: Skip if outside `pknrf`/`pknrt`.
  - **Authorization check**: Only process if `rksent = 1` (authorization sent).
  - **Department/category/seller range checks**: Apply as specified in parameters.
  - **Secondary customer file lookup**: Optionally update `rkunlu` (commented out).
  - **Reset transaction total** for this customer.

### 3. Transaction Selection Loop

- For each qualifying customer, the program reads their transactions from `rktrl2`:
  - **Date range checks**: Skip transactions outside `rkafda`/`rkatda`.
  - **Work date checks**: Additional filtering based on work date and transaction date.
  - **Complaint check**: Skip if flagged as a complaint (`rnrekl = 'J'`).
  - **Outstanding balance check**: Skip if `rnrest <= 0`.
  - **Autogiro status**: Skip if already sent (`rnstat = 'A'` or `rnauto = 'A'`).
  - **Additional customer number range checks**: `pbilf`/`pbilt`.
  - **Value assignment**: Set currency and amount fields if not already set.
  - **Sorting key selection**: Use alpha or numeric key as specified.
  - **Output**: Write qualifying transaction to `rkw4pf`.
  - **Sum outstanding amount** for later use.

### 4. Post-Transaction Processing

- After processing all transactions for a customer:
  - If the sum of outstanding amounts (`wnrest`) is zero or negative, optionally update the customer record in `rkunlu` (commented out).
  - Reset running total and proceed to next customer.

### 5. Program Termination

- When all customers are processed or selection criteria are exhausted, the program sets LR and returns.

---

## Business/Domain-Specific Logic

- **Autogiro Eligibility**: Only customers with an authorization sent (`rksent = 1`) and not already processed (`rnstat`/`rnauto <> 'A'`) are considered.
- **Dynamic Selection**: The program supports flexible selection criteria, allowing batch runs for specific firms, customers, departments, categories, sellers, and date ranges.
- **Output**: Transactions are written to a specific output file (`rkw4pf`) for downstream Autogiro processing.
- **Sorting**: The selection of sorting key (alpha or numeric) is controlled by the `palfa` parameter.

---

## Design and Codebase Conventions

- **Parameter Passing**: All selection criteria are passed as a single overlayed data structure (`d_parm`), a common legacy technique for batch RPG.
- **Indicator Usage**: Indicator numbers are documented for their intended purpose, following site conventions.
- **Commented-Out Logic**: Several update operations are commented out, suggesting that updating the customer master is either deprecated or handled elsewhere.
- **Tag/GOTO Structure**: The code uses tags and `GOTO` for flow control, typical in older RPG codebases but important to note for maintainability.
- **Overlayed Data Structures**: Used extensively for both parameter parsing and key management, reducing memory footprint and simplifying field access in a fixed-layout environment.

---

## External Relationships

- **Files**: The program interacts with customer master (`rkunpf`, `rkunlu`), transaction (`rktrl2`), and output (`rkw4pf`) files. File naming and keys are consistent with the ASOKON system standards.
- **Downstream Processing**: The output file (`rkw4pf`) is assumed to be used by subsequent Autogiro processing routines, possibly for payment collection or reporting.

---

## Summary

This program is a batch selection utility for Autogiro, designed to filter and output eligible customer transactions based on a comprehensive set of business rules and selection parameters. It is tightly coupled to the ASOKON file structures and conventions, and its logic is built for flexibility and extensibility within the constraints of legacy RPG programming.

---

**Note for New Developers:**  
When maintaining or extending this code, pay close attention to:
- The overlayed data structures and their byte offsets.
- The use of indicators and their documented purposes.
- The commented-out update logic, which may be reactivated or removed depending on evolving business requirements.
- The handling of selection criteria, as changes here can have broad impacts on downstream Autogiro processing.