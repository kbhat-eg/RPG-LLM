# RPG Program FO794R – Detailed Explanation

This program is an ILE RPG (also known as RPG IV) application tailored to run on IBM i (AS/400) systems. The program interacts with users via a workstation (terminal) and is meant for selecting which order lines should be changed. Below is a breakdown of its structure, logic, and function:

---

## Header and Documentation

```rpg
     h option(*nodebugio)
```
- **Header specification:** Turns off debug I/O for performance.
- **Comment block:** Details program name, purpose (order line selection), system, references, and change history (with dates and initials).
- **Notable changes:** Introduction of new features (e.g., price group extension, GUI support).

---

## File Specification

```rpg
     ffo794d    cf   e             workstn
```
- **Workstation file ‘fo794d’:** This is a display file used for user interaction (display/input).

---

## Definition of Parameters

```rpg
     d p_valg          s              1
5.70 d p_pval          s              1
     d p_in03          s              1
```
- **p_valg:** Selection value parameter.
- **p_pval:** (added later) Possibly a price group parameter.
- **p_in03:** Parameter indicating "F3=Exit" key pressed.

---

## Variable Definitions

```rpg
     d b_feil          s              1    inz(*off)
```
- **b_feil:** A 1-char flag for input error indication, initialized as off (`'0'`).

---

## Main Logic – Opening Screen Handling

### Initialization

```rpg
     c                   eval      b1valg = '0'
     c                   eval      b1val2 = '0'
```
- **b1valg, b1val2:** Presumed display/input fields initialized to `'0'`.

### Main Display Loop

```rpg
     c     b1taga        tag
     c                   exfmt     b1bld
```
- **exfmt b1bld:** Formats (displays for edit) the main screen (`b1bld` format).

#### F3=Exit Handling

```rpg
     c                   if        *inkc or *inkl
     c                   eval      p_in03 = *on
     c                   goto      avslutt
     c                   endif
```
- **Checks for F3 or another key (indicator KC/KL):**
    - Sets `p_in03` to on.
    - Jumps to the exit part of program.

#### Input Validation

```rpg
     c                   exsr      sjekk_input
     c                   if        b_feil = *on
     c                   goto      b1taga
     c                   endif
```
- **Subroutine `sjekk_input`:** Validates the user input.
- **If error:** Loop back to display (re-input).

#### Parameter Assignment

```rpg
     c                   exsr      flytt_par
```
- **Subroutine `flytt_par`:** Copies screen fields into program parameters.

---

## Ending the Program

```rpg
     c     avslutt       tag
     c                   eval      *inlr = *on
     c                   return
```
- **avslutt Tag:** Standard exit point, sets last record indicator and ends the program.

---

## Subroutine: sjekk_input (Input Validation)

```rpg
     c     sjekk_input   begsr
     c                   eval      b_feil = *off
     c                   if        b1valg <> ' ' and
     c                             b1valg <> '0' and
     c                             b1valg <> '1'
     c                   eval      *in31  = *on
     c                   eval      b_feil = *on
     c                   goto      end_sjekk
     c                   endif
     c     end_sjekk     tag
     c                   endsr
```
- **Resets `b_feil` to off.**
- **Checks if `b1valg` contains a value other than blank, `'0'`, or `'1'`:**
    - If so, sets error indicator 31 and sets `b_feil` to on.
    - Jumps to the end of the subroutine.
- **Otherwise, input passes validation.**

---

## Subroutine: flytt_par (Assign Parameters)

```rpg
     c     flytt_par     begsr
     c                   eval      p_valg = b1valg
5.70 c                   eval      p_pval = b1val2
     c                   endsr
```
- **Copies values from screen fields (`b1valg`, `b1val2`) to the parameters (`p_valg`, `p_pval`).**

---

## Subroutine: *inzsr (Initialization and Parameter List Setup)

```rpg
     c     *inzsr        begsr
     c     *entry        plist
     c                   parm                    p_valg
5.70 c                   parm                    p_pval
     c                   parm                    p_in03
     c                   endsr
```
- **Standard initialization subroutine.**
- **Defines the program's parameter interface:** Receives three parameters from calling program.

---

## Summary of Flow

1. **Program starts, initializes fields.**
2. **Enters display loop.**
   - Shows the selection screen, waits for user input.
   - If F3/exit is pressed, exits cleanly.
   - Otherwise, validates input. Only `' '`, `'0'`, or `'1'` are accepted in `b1valg`.
   - If invalid, returns to input screen.
   - If valid, copies input fields to parameters and exits.
3. **Allows calling program to receive user's selections and if they requested exit.**

---

## Key Concepts

- **Display I/O:** Uses `exfmt` to show and get input from screen.
- **Parameter passing:** Uses both stand-alone variables and passed parameters for communication.
- **Input validation:** Only certain field values are permitted.
- **Subroutine usage:** For code organization and logic separation.
- **Exit handling:** Via special keys and structured exit point.

---

## Onboarding Notes

- **Display file `fo794d` is required;** fields like `b1valg`, `b1val2`, `b1bld` reside there.
- **Typical usage:** Called from a larger order-entry or maintenance suite; does not process business logic, just selection.
- **To extend:** Add more allowed values or fields, expand parameter list, or change input validation logic as needed.
- **Code is in fixed-format RPG IV,** which may be updated to free-format for modern practices.

---

Feel free to ask for details about the display file (`fo794d`), specific subroutines, or suggestions for modernizing/upgrading this code!