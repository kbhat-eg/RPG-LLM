# RPG Program LO402R: Deleting Picks and Unmarking Orders

This RPG program is written for IBM i, handling the deletion of pick lines and parameters, and clearing a flag in an order header record. Below is a detailed, section-by-section explanation of the code.

---

## File Specifications

```rpg
flohelu    uf   e           k disk    rename(lohepfr:lohelur)
flplolu    uf   e           k disk    rename(lplopfr:lplolur)
flplll1    if   e           k disk    rename(lpllpfr:lplll1r)
flplllu    uf   e           k disk    rename(lpllpfr:lplllur)
```
- Declares four physical files:
    - **lohelur**: Order header file (`lohepfr` renamed).
    - **lplolur**: Pick parameter file (`lplopfr` renamed).
    - **lplll1r**: Pick line file 1 (`lpllpfr` renamed, input file).
    - **lplllur**: Pick line update file (`lpllpfr` renamed).
- Access is by **keyed** access (`k`).
- Files specified as update (`uf`) or input (`if`).

---

## Data Definitions

#### Local Data Area (LDA)
```rpg
d                uds
d  l_user               911    920
d l_firm                944    946  0
```
- Defines user data storage, with user ID and firm code extracted from the LDA.

#### Parameters and Key Variables
```rpg
d p_depr          s              1
d p_firm          s                   like(lofirm)
d p_numm          s                   like(lonumm)
d p_suff          s                   like(losuff)
...
d w_firm          s                   like(lofirm)
```
- `p_xxx` variables: Input parameters (department, firm, order number, suffix) received on program entry.
- Variables like `lohelu_numm`, `lplll1_numm` are used as key fields for file access.

---

## Main Logic

### 1. Deleting Pick Lines (UTPLUKK-LINJE)

```rpg
c     lplll1_key    setll     lplll1r
c     lplll1_key    reade     lplll1r

c                   dow       not %eof
c                   eval      lplllu_numm = lklonr
c                   eval      lplllu_suff = lklsuf
c                   eval      lplllu_line = lkllin
c     lplllu_key    chain     lplllur
c                   if        %found
c                   delete    lplllur
c                   endif
c     lplll1_key    reade     lplll1r
c                   enddo
```
- Loops through all pick-line records (`lplll1r`) matching the key.
- For each, maps order and line number to the update file key and attempts to delete the pick line from `lplllur`.

---

### 2. Deleting Pick Parameters (UTPLUKK-PARAM)

```rpg
c     lplolu_key    chain     lplolur
c                   if        %found
c                   delete    lplolur
c                   endif
```
- Directly deletes the pick parameter record from `lplolur` if it exists.

---

### 3. Clearing Marking in Order Header (BESTILLINGS-HODE)

```rpg
c     lohelu_key    chain     lohelur
c                   if        %found
c                   eval      lokode = 0
c                   move      *loval        lokoti
c                   move      *loval        lokoda
c                   eval      lokous = *blank
c                   eval      lokows = *blank
6.10 c                   time                    loedat
6.10 c                   time                    loetim
6.10 c                   eval      loeusr = l_user
c                   update    lohelur
c                   endif
```
- If the order header exists in `lohelur`, reset/blank out certain fields to clear the flag/marking (e.g., code fields, user fields, date/time).
- Updates the record to persist the changes.

---

### 4. Program End

```rpg
c                   eval      *inlr = *on
c                   return
```
- Sets the LR (Last Record) indicator to end the program and return control.

---

## Initialization Subroutine (`*INZSR`)

- Runs automatically at program start.
- Reads parameters from the calling program.
- Sets up the key lists (`klist`) for the various files.
- Populates key variables from parameters.

```rpg
c     *entry        plist
c                   parm                    p_depr
c                   parm                    p_firm
c                   parm                    p_numm
c                   parm                    p_suff
...
c                   eval      w_firm = p_firm
c                   eval      lohelu_numm = p_numm
c                   eval      lohelu_suff = p_suff
...
```
- Parameter list defines how this program receives input from caller.
- All key variables are loaded from the parameters to prepare for file operations.

---

## SUMMARIZED FLOW

1. **Initialize:** Acquire parameters, prepare keys, copy parameter values to variables.
2. **Delete Pick Lines:** Loop and delete all pick line records for the given order.
3. **Delete Pick Parameters:** Delete the pick parameter record for the order.
4. **Unmark Order Header:** Reset relevant fields in the order header to "unmark" it.
5. **Finish:** Set LR indicator to close files and exit.

---

## KEY BUSINESS LOGIC

- **"Pick" records** (lines and parameters) are deleted for a given order/firm.
- The **order header** record is "unmarked" (status fields reset/cleared).
- The job is parameterized; runs for the input firm/order/suffix.
- **Safety:** Only attempts deletes/updates if records are found.

---

## COMMENTS

- Documentation is in Norwegian (e.g., "Sletting av utplukk" = "Deleting pick"), and variable names follow the corresponding business usage.
- The code caters to changes introduced in later versions (see modification comments).
- Uses external file definitions and assumes presence of physical files on the system.

---

## ONBOARDING TIPS

- **Understand the business process:** The program is meant to "reset" orders by deleting picks and unmarking them in the order header.
- **Familiarize with file layouts:** All files are externally defined, and field names like `lonumm`, `lkponr`, etc., are tied to those layouts.
- **Parameter-driven:** Program must be called with appropriate firm, order, and suffix identifiers.
- **Error handling:** The program checks `%found` before delete/update operations but does not perform explicit error reporting/logging.
- **Date/Time fields:** If using version 6.10 or later, some fields are updated with the current system date and time.

---

If onboarding, review the file layouts and understand the downstream effects of deleting these "pick" records and clearing the order header marking. This program is a maintenance/cleanup routine as part of the order picking process.