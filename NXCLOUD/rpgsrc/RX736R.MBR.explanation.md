# RPG Program RX736R – Explanation

This ILE RPG program, named **RX736R**, is designed for use on IBM i (AS/400) systems. Its main function is to process and update supplier records in a physical file (rlevlu), particularly by cleaning up name and alphanumeric fields and formatting telephone numbers. Below is a breakdown of how the code works, its data definitions, and its program logic.

---

## 1. **Header & Description**

```rpg
     h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)**: Debugging input/output is disabled.
- **datedit(*dmy)**: Date fields default to day/month/year format.

### Description Comments
- This program removes commas "," from name fields, updates an alphanumeric field if it matches the first 12 characters of the name, and reformats telephone, telefax, and mobile numbers for suppliers.
- It tracks various program revisions.

---

## 2. **File Definitions**

```rpg
     frlevlu    uf   e           k disk    rename(rlevpfr:rlevlur)
```
- **rlevlu**: This is a physical file, used for updating supplier records. It is renamed internally from `rlevpfr` to `rlevlur`.

---

## 3. **Data Definitions**

- **Local Data Area (LDA) Fields**:
  ```rpg
     d                uds
     d l_user                911    920
     d l_firm                944    946  0
     d l_navn                951    980
  ```
  - Fields from the Local Data Area, such as user ID, firm code, and name.

- **Working Variables**:
  ```rpg
     d w               s              2  0
     d w_firm          s                   like(rlfirm)
     d w_navn          s             12
     d w_navn1         s             30
     d w_navn2         s             30
     d w_tlfi          s             11
     d w_tlfu          s             11
     d w_tlfw          s             11
     d w_tnum          s              2  0
     d w_tptr          s              2  0
     d rlevlu_firm     s                   like(rlfirm)
  ```
  - Various fields are used for data manipulation, especially for processing names and phone numbers.

- **Constants**:
  ```rpg
     d c_digi          s             11    inz('0123456789')
     d lo              c                   'abcdefghijklmnopqrstuvwxyz������'
     d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ������'
     d ux              c                   '���'
     d uy              c                   '���'
  ```
  - `c_digi` contains all digits (for validation and formatting).
  - `lo` and `up` contain lowercase and uppercase alphabets (including Nordic characters).
  - `ux` and `uy` are used for special character translations.

---

## 4. **Main Program Logic**

### A. **Reading and Looping Through Supplier Records**

```rpg
     c                   eval      rlevlu_firm = l_firm
     c     rlevlu_key    setll     rlevlu
     c     rlevlu_key    reade     rlevlu
     c                   dow       *in91 = *off
```
- The program starts by reading the supplier file for the current firm from the LDA.
- It loops through records using a key list (`rlevlu_key`).

---

### B. **Comma Removal from Name and Alphanumeric Fields**

For both `rlnavn` (name) and `rlalfa` (alphanumeric) fields:
- If a comma is found (`,`) not in the first or last allowed position, it is removed and replaced with a blank.
- If it's in the first or last position, the field is truncated appropriately.

#### Example for `rlnavn`:
```rpg
     c                   eval      w      = %scan(',':rlnavn)
     c                   if        w > 1 and w < 30
         // Remove comma and join the two parts with a space
     c                   endif

     c                   if        w = 1
         // Remove comma at the start
     c                   endif

     c                   if        w = 30
         // Remove comma at the end
     c                   endif
```
- Similar code is repeated for the `rlalfa` field, but with length 18 instead of 30.

---

### C. **Special Character Translation in Alphanumeric Field**

```rpg
     c     ux:uy         xlate     rlalfa        rlalfa
```
- Translates Nordic special characters in `rlalfa` field for consistency.

---

### D. **Synchronize Alphanumeric Field with Name Field**

```rpg
     c     lo:up         xlate     rlnavn        w_navn
     c                   if        w_navn = rlalfa
     c     lo:up         xlate     rlnavn        rlalfa
     c                   endif
```
- Converts first 12 characters of name to uppercase and compares it with `rlalfa`.
- If they match, updates `rlalfa` with the (uppercased) name, ensuring up to 18 characters.

---

### E. **Telephone Number Formatting**

For each telephone field (`rltlfn`, `rlmobn`, `rltlfx`):

```rpg
     c                   move      rltlfn        w_tlfi
     c                   exsr      tlf_edit
     c                   move      w_tlfu        rltlfn
```
- Moves the phone number to a work variable.
- Calls the subroutine `tlf_edit` to reformat it.
- Moves the reformatted value back to the record.

---

### F. **Audit Fields Update**
```rpg
6.11 c                   time                    rl2dpt   // date/time stamp
6.11 c                   eval      rlepgm = 'RX736R    ' // program identifier
```
- Updates tracking fields to record the update's time and the program name.

---

### G. **Update Record & Loop**
```rpg
     c                   update    rlevlur
     c     rlevlu_key    reade     rlevlu
     c                   enddo
```
- Updates the supplier file with the changes.
- Reads the next record.

---

## 5. **Subroutines**

### A. **tlf_edit**: Edit Phone Number to 'nn nn nn nn' Format
```rpg
tlf_edit begsr
    // Initialize counters
    // If input is blank or contains non-numeric, return as is
    // Else, extract digits only; if exactly 8 digits, format as "nn nn nn nn"
    // Otherwise, return as is
endsr
```
**Logic step-by-step**:
- If the original value is blank or non-numeric, return as is.
- Otherwise, extract all digits into a temp variable.
- If there are exactly 8 digits, output as 'NN NN NN NN'.
- Else, output the original value.

---

### B. **Program Initialization Subroutine (\*inzsr)**
```rpg
     c     *inzsr        begsr
         // Prepares key list for record read by setting rlevlu_firm
     c     rlevlu_key    klist
     c                   kfld                    rlevlu_firm
     c                   endsr
```
- Sets up the key list for reading supplier records by firm.

---

## 6. **Program End**

```rpg
     c                   eval      *inlr = *on
     c                   return
```
- Turns on the LR (last record) indicator and returns, signaling program end and file closure.

---

## 7. **Summary of Main Operations**

- **Remove commas** from `name` and `alphanumeric` fields.
- **Synchronize** the alphanumeric field with part of the name if appropriate.
- **Translate** special characters for consistency.
- **Format supplier phone numbers** as `nn nn nn nn` where possible.
- **Update tracking/audit fields** for each change.
- **Loop and update** for each supplier record for a given firm.

---

## 8. **Relevant Fields (from context)**

- **rlnavn**: Name field (30 chars)
- **rlalfa**: Alphanumeric/search field (18 chars)
- **rltlfn**: Telephone number
- **rlmobn**: Mobile number
- **rltlfx**: Fax number

---

## 9. **Usage**

This program is typically run as a data cleanup and normalization utility for a supplier master file. It is especially useful in cases where consistent formatting is needed for names and phone numbers, and where special character handling and field synchronization are important for search or display functionality.