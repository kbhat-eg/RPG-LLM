# RPG Program Explanation: Dekningsbidragsstatistikk (Contribution Margin Report)

This RPG program, named `SF615R`, prints a statistical report of "dekningsbidrag" (contribution margin) for a Norwegian business system ("ASSTAT"). Its primary function is to generate reports on sales, costs, discounts, margins, and various key metrics, grouped and summarized at different levels (e.g., product, customer, group, company).

Let's break down the main sections for developer onboarding:

---

## 1. **Header and Program Info**

- The header provides the title, version history, and a brief description in Norwegian.
- `H datedit(*dmy.)` sets the date format for the program.

---

## 2. **File Declarations (`F-specs`)**

The program uses multiple physical and logical database files, mostly with keyed access (for reading sales, product, customer, etc.). Example:
```rpg
Fskwwpf    ip   e           k disk
Fskpml1    if   e           k disk
Frkunl1    if   e           k disk
Fsf615p    o    e             printer oflind(*in30)
```
*Printer file `Fsf615p` is used for output with overflow indicator `*in30`.*

---

## 3. **Data Definitions (`D-specs`)**

### a. **Arrays and Constants**

- `sal`: Array for holding sales numbers, one per month.
- `rt`: Array holding report text descriptions (e.g., group names, customer category names). Populated from compile-time data.

### b. **Data Structures**

These group several related fields, often for keys:
```rpg
D wwrest          ds           330
D wwtext                        30
...
D                 ds
D beg                           15
D  k6                            6  0 overlay(beg)
D   k5                           5  0 overlay(k6)
D    k4                          4  0 overlay(k6)
D     k3                         3  0 overlay(k6)
D      k2                        2  0 overlay(k3)
D       k2a                      2    overlay(k2)
```
*Overlays allow easy extraction of various key-lengths from a single field.*

### c. **Field Naming Convention**

Explained in comments:
- 1st char: data type (`a`=count, `b`=amount, `d`=margin)
- 2nd char: sub-type (`b`=gross, `r`=discount, `n`=net, etc.)
- 3rd char: period (`p`=current period, `i`=year-to-date)
- 4th char: year (`f`=last year, `i`=this year)
- 5th char: grouping

Example: `bbifu` = gross (b), sales (b), year-to-date (i), last year (f), firm total (u)

### d. **Extensive Statistics Fields**

For each grouping and period, the program holds:
- Number of units (sales)
- Gross, discount, net amounts
- Costs, contribution margin (DB)
- Calculated values like deviation percentages, averages, and margin percentage ("dekningsgrad")

---

## 4. **Input Section (`I-specs`)**

Defines how fields are read from files, especially for populating the sales array and grouping variables:
```rpg
Iskwwpfr       01
I                                          sffirm        L7
I                                          swsrt1        L6
I                                          swsrt2        L5
I                                          swsrt3        L4
Iskbul1r
I              sbbu01                      sal(1)
... etc ...
```
*Populates input keys and monthly figures.*

---

## 5. **Main Calculations and Control Breaks (`C-specs`)**

### a. **Initializations on Control Breaks**
For each grouping level (L6=SRT1, L5=SRT2, L4=SRT3), zero out the working totals and prepare text labels. Example:
```rpg
B001 C   L6              do
001 C                   eval      bbpi6 = 0
...
001 C                   eval      textl6 = *blank
001 C                   move      swsrt1        beg
001 C                   eval      rap = rp1
001 C                   exsr      raprut
001 C                   movel     rptek         textl6
E001 C                   enddo
```
*Resets and prepares group label for SRT1.*

### b. **Accumulation of Values**

The program accumulates all relevant statistics at each grouping level, such as period, year-to-date, and last year. Calculations handle "hittil i år" (YTD this year), "hittil i fjor" (YTD last year), "denne periode" (current period), etc, for all statistics.

### c. **Summing and Aggregating**

After each group's data is processed, the totals are rolled up to the next-highest level using subroutines:
- `L4brd` – Sums SRT3 up to SRT2
- `L5brd` – Sums SRT2 up to SRT1
- `L6brd` – Sums SRT1 up to Firm (L7)
- `L7brd` – Final firm totals

Each control break also prepares text descriptions and may trigger output lines.

### d. **Conditional Output**

Indicators (`*in64` - `*in67`) control whether to print sub-totals at each level.

### e. **"beregn" (calculate) Subroutine**

This key subroutine calculates:
- Averages (mean price)
- Percent deviations (from last year/budget)
- Margin percentages (dekningsgrad), ensuring values are within sensible limits (-999.99 to 999.99)

This is critical for preparing the correct report data.

---

## 6. **Text Lookup Subroutine (`raprut`)**

Given a "rap" code (indicating group type or category), this subroutine retrieves the appropriate Norwegian description from a file, using the group key, for use in report headings or subtotals. Handles many groupings: customer, product, category, district, etc.

---

## 7. **Initialization `*inzsr`**

The program's `*inzsr` subroutine handles:
- Setting up report heading texts (by groupings RP1, RP2, RP3)
- Interpreting selection criteria (e.g., what to compare: budget/last year)
- Setting up indicators and workspace for grouping

It builds necessary keys for file lookup subroutines and initializes necessary working variables.

---

## 8. **Report Text Definitions (at the End)**

A compile-time array `rt` defines the possible grouping descriptions (in Norwegian), which are used in report headings and subtotals.

---

# **Summary for Developers**

- **Purpose:** Prints detailed, hierarchical reports on sales/contribution margin, by multiple grouping/aggregation levels (group, sub-group, product, customer, company, etc.), including comparison to budget and last year.
- **Data Model:** Reads transactional and master data from many files, aggregates all key metrics at multiple levels as per grouping definitions.
- **Control Breaks:** On change of grouping, zero totals, lookup group descriptions, and roll up figures to higher levels. Triggers report output at group ends as needed.
- **Key calculations:** Includes detailed metrics for gross, discount, net, costs, contribution margin, averages, deviation percentages, and margin percentages.
- **Customizability:** The groupings, report headings, and comparison (budget/last year) are parameterized, supporting various business reporting needs.
- **Key Subroutines:**
    - `L4brd`, `L5brd`, `L6brd`, `L7brd`: Handle group roll-ups.
    - `beregn`: Performs all per-group summary calculations.
    - `raprut`: Fetches text for group/category headings.
    - `overflow`: Manages page breaks in the printed report.

**Onboarding tips:**  
- Once you understand how values are accumulated and rolled up by group, and how the subroutines operate on breaks, the rest is mostly field management and output formatting.
- Changes are most likely needed if new groupings are added or business metrics change, which will require understanding both the data structure overlays and the field naming conventions.
- Norwegian comments/labels are directly translatable for mapping to business requirements.

---

**For more details**, consult the section of the code specific to the grouping or metric you need to work with, and refer to the report text table for group descriptions.