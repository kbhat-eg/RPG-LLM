# RPG Source Code Explanation for FW621R

---

## High-Level Overview

**Program Name:** FW621R  
**System:** ASOFAK  
**Purpose:**  
- Imports new items (varer) from a supplier’s register
- Creates or updates the item master file (vareregister)
- Prints either a control list (“kontrolliste”) or a journal list (“journalliste”) of the operations performed

The code is typical of classic ILE RPG (RPG IV) on IBM i (AS/400, iSeries) systems, meant for batch data processing jobs with various file IO operations, subroutines, and external program calls.

---

## Main Components and Flow

### 1. **Header, Documentation and History**
This section provides program documentation and a log of changes, clarifying how business requirements have evolved (e.g., changes in data fields, logic, or supporting additional attributes). Comments are partly in Norwegian.

---

### 2. **File Definitions**

**Input/Output Files:**
- Files such as `flval3`, `vvarl5`, `vvarlu`, etc., are defined for reading/writing item and supplier records. Many are renamed upon input to associate with a structure (record format).
- `fw621p` is an output printer file for reports/journals.

Examples:
```rpg
fflval3    if   e           k disk    rename(flvapfr:flval3r)
fvvarl5    if   e           k disk    rename(vvarpfr:vvarl5r)
ffw621p    o    e             printer
```

---

### 3. **Data Structures and Variables**

#### **Local Data Area (LDA) Variables**
- Used to store workstation ID and user info, which are included in printouts.

#### **Parameter Data Structure**
- `d_list` is a 120-character structure for passing parameters into the program. Various fields overlay into it (e.g., firm, supplier, item numbers, VAT, price groups, and flags).

#### **Other Working Variables**
- For status codes, keys, temporary storage, and VAT values.
- Extensive use of `LIKE` keyword to ensure variable formats match those in external files (database records).

---

### 4. **Program Flow**

#### **Initialization (`*inzsr` subroutine):**
- Receives input parameter list
- Copies parameters to internal structure and variables
- Retrieves VAT rates by calling program `'FØ705R'`
- Establishes key lists for file accesses

#### **Mainline Logic:**

**a. Print header information (`hode` subroutine):**
- Fills in standard header details for the report (firm code, user, workstation, timestamps, etc.)
- Fetches supplier and company details for printing

**b. Process item records (`behandling` subroutine):**
- Iterates over supplier item records in `flval3`
- Applies selection filters: only processes items within the requested range and not already on "hold"
- Chains to the item register (`vvarl5`) to ensure the item exists
- Calls subprogram `'FW113R'` for item validation (returns status code and indicator)
- If list type is "journal" (`d_oppd = 2`), calls the `oppdater` subroutine to update/create the item in the master file
- Prints detailed line for each item via the `detalj` subroutine

**c. Ends the program (`*INLR = *ON`)**

---

### 5. **Key Subroutines**

#### **Header Printing (`hode`):**
- Collects and prints firm, supplier, and parameter details
- Handles both journal and control lists

#### **Processing Items (`behandling`):**
- Reads supplier items, applies filter logic
- For each matching item:
    - Validates item (calls validation program)
    - Updates/creates item in master file if needed
    - Prints a transaction line

#### **Updating Master Records (`oppdater`):**
- If the item passes validation:
    - Allocates item numbers if needed (can call `'VV700R'` to find next available)
    - Populates item, price, and item unit records with values from input and parameters
    - Calls various external programs for price, text search, and warehouse creation
    - Handles EAN (barcode) uniqueness and moves EAN numbers as needed
    - Removes the item from any "deleted items" register
    - Puts the supplier record “on hold” after successful update
- Writes all changes to the respective physical files

#### **Printing Details (`detalj`):**
- Moves processed fields into print/buffer variables
- Calculates price and margin fields (for reporting)
- Calls an external program for further financial calculations
- Writes out a detailed line to the report

#### **Overflow Handling (`overflow`):**
- Prints header lines again on page overflow

#### **EAN Check (`sjekk_ean`):**
- Checks if EAN number already exists for a given item/unit
- Sets a duplication flag if the EAN is found (to avoid duplicates)

---

### 6. **Key Lists (KLIST)**
- Predefined key lists are used for chaining (random access) to physical files using composite keys—for example, by firm, supplier, item number, etc.
- This approach keeps key generation consistent across file accesses.

---

## Notable Features

- **Extensive Use of Subroutines (BEGSR/ENDSR):** Modularizes processes, which is vital for maintainability in RPG.
- **External Program Calls:** For various business rule calculations (e.g., VAT, item validation, warehouse updates, text/search).
- **Overlay and Data Structure Techniques:** Implements parameter passing and unpacked storage for tightly packed interfaces.
- **Conditional Control:** Filters, error handling, and alternate paths ensure data is processed according to user intent (journal vs. control).
- **Report Generation:** Produces human-readable output for users (print files), including headers, detail lines, and overflow management.

---

## Business Concepts Encoded

- **Item Master Maintenance:** Ensures new items are properly validated, numbered, and added to the main item file.
- **Supplier Integration:** Only items meeting certain criteria from a supplier are processed.
- **VAT and Pricing:** Dynamically applies pricing and VAT rates per program parameters and item details.
- **EAN Code Management:** Prevents duplicate barcodes and moves EAN from the supplier to the correct item/unit level.
- **Warehouse Creation:** Automatically creates warehouse records as appropriate for new items.
- **Hold and Deletion Logic:** Ensures items are not processed twice and removes items from the deleted register upon re-creation.

---

## Typical Usage Pattern

1. **Called from Batch with Parameters:**  
   Receives firm, supplier, item range, and processing options as input parameters.

2. **Processes All Matching Items from Supplier:**  
   Applies selection logic, validates, and creates/updates items in the master, price, and unit tables.

3. **Generates a Control/Journal List:**  
   Prints a summary and details of all actions taken (or would be taken), useful for auditing and verification.

---

## Takeaway for New Developers

- **RPG Structure:** Classic ILE RPG, modular, reliant on external program calls for business logic.
- **File-Driven:** All business data is read/written through physical file operations, using keyed access and explicit record I/O.
- **Parameter Handling:** Uses data structures with overlays to receive and parse external parameters efficiently.
- **Robust Logging:** Report output is integral for tracing what the batch job processed.
- **Careful State and Error Handling:** Uses record locks, keys, and status codes to avoid duplicating work or creating incorrect records.

---

**When onboarding, focus on understanding:**
- The input parameter data structure (`d_list`)
- The main program flow (mainline, `behandling`, `oppdater`)
- How file keys are constructed and used
- How subprograms are integrated for modular business logic
- Where and how files are updated vs. just read

For further maintenance, you’ll often extend file definitions or business rules (in subroutines or external programs) as business requirements evolve.