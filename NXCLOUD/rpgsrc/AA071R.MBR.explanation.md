# RPG Program AA071R: Maintaining File Copy Line Register

This program is a classic ILE RPG program designed for interactive maintenance of a "file copy line register" table. It offers CRUD (Create/Read/Update/Delete) functionality via subfiles, using various display formats. The code is well-commented and also makes use of indicators to manage field and display attributes.

Below is an explanation, organized by component and structure, to help understand the code for onboarding purposes.

---

## 1. **Purpose and History**

- **System:** ASPGPL
- **Program:** AA071R
- **Description:** Maintains a table for file copy line register ("filkopiering-linje-register"), allowing add, change, show, copy, and delete operations.
- **History/Changes:** Documented in the comments. E.g., support for new parameters, removal of certain functions, and subfile enhancements.

---

## 2. **Indicators:**

Indicators are used throughout the logic to control program flow, field protection, error notifications, subfile states, etc.

- **LR**: End of program
- **10**: Roll key
- **12, 13, 14, 15, 16**: Subfile and control record handling (display, clear, end, readc)
- **21, 22, 30**: Cursor placement, field protection
- **31-79**: Error/warning messages
- **80-99**: Work and file indicators (e.g., chain successful)

---

## 3. **File Declarations:**

Several physical (disk) files and a display file are defined, some with record format renames for update/read operations.

```rpg
facpllr    if   e    k disk    rename(acplpfr:acpllrr)
facpllu    uf a e    k disk    rename(acplpfr:acpllur)
facpll1    if   e    k disk    rename(acplpfr:acpllr1)
facpll2    if   e    k disk    rename(acplpfr:acpll2r)
fafillr    if   e    k disk    rename(afilpfr:afillrr)

faa071d    cf   e      workstn sfile(b1sfl:w_srrn) 
```
- **acpllr/acpllu/etc.:** Different usage modes or record formats against the same file.
- **sfile(...):** Subfile B1SFL used for interactive record lists.

---

## 4. **Data Structures and Variables:**

- **Arrays:**  
  `a_meld` - For message text used in the UI.

- **Local Data Area:**  
  For the logged-in user (`l_user`).

- **Parameters & Keys:**  
  Parameters for file group and company, as well as variables for current keys used in various file operations.

- **Work Variables:**  
  Page/record numbers for subfile navigation, mode indicators (error, cancel, etc.), temporary buffers, etc.

- **Constants:**  
  E.g., `c_sfil` for subfile page size.

---

## 5. **Main Program Flow:**

The logic cycles through three main program states:

1. **Display command panel:** (tag b2taga)
    - Write command keys (b2cmd).
2. **Display subfile:** (tag b2tagb)
    - Subroutine `dsp_subfile` handles subfile display.
3. **Function Key Processing:**
    - Uses `select` statement to trigger routines (end, refresh, add, position, etc.).
    - Subfile positioning and action subroutines process different user requests.
4. **Subfile Control and Actions:**
    - Calls `control` for menu selections (add, change, copy, delete, view).
    - Calls `subfile` for processing records in the subfile (actions on individual records).

---

## 6. **Key Routines:**

### a. **forny (Refresh)**

Positions the file and repopulates the subfile display, based on the current mode (by company or group).

### b. **posisjoner (Positioning)**

Handles cursor or record positioning based on entered file group or company values. Clears and refills the subfile afterward.

### c. **control (Subfile control actions)**

Processes user requests from the main menu:
- Add new (1): Show entry panel
- Change (2): Validate, show change panel
- Copy (3): Show copy dialog
- Delete (4): Show delete dialog
- View (5): Show view-only panel

Handles field validation and error notification via indicators.

### d. **subfile (Process subfile rows)**

Iterates through visible lines in the subfile, processing actions for each. Actions for the selected row are:
- Edit (2), Copy (3), Delete (4), View (5)
- Special (7): Calls a different program for vendor maintenance (as per v6.10 update)

Each action triggers corresponding subroutines and updates the subfile as needed.

---

## 7. **Display and Maintenance Subroutines**

Each maintenance task (add, change, copy, view, delete) has its subroutine:

- **xc1bld**: New row entry panel (and message handling for duplicate).
- **xc1msg**: Message panel if trying to add an already existing row.
- **xc2bld**: Add/change/view panel, handles validation and DB updates, and sets field protections for 'view' mode.
- **xd1win**: Delete confirmation dialog and delete logic.
- **xk1win**: Copy dialog and copy logic.

---

## 8. **Supporting Subroutines**

### a. **clr_subfile**
Clears out the subfile.

### b. **crt_subfile**
Loads the subfile with rows from the physical file, controlling page size and starting point.

### c. **dsp_subfile**
Displays the subfile control record, typically after subfile has been loaded.

### d. **sjekk_key**
Validates that file group and company fields are set, and no duplicate key exists for current session.

### e. **Initialization (*inzsr)**
- Receives parameters from caller
- Initializes key lists for file operations
- Positions to the right place and loads the subfile

---

## 9. **User Interface Components**

- **Subfile Records:** B1SFL
- **Subfile Control:** B2CTL
- **Command Keys Screen:** B2CMD
- **Entry/Change/Copy/Delete/View Panels:** C1BLD, C2BLD, K1WIN, D1WIN, etc.

---

## 10. **Notes on Subfile Logic**

- Subfiles are used for displaying and operating on multiple records.
- Indicators (e.g., IN14 for clear, IN15 for end, IN12/IN13 for display) manage the state of the subfile.
- Positional variables (`w_srrn`, etc.) allow for page navigation and record selection.

---

## 11. **Special Version Updates (v6.10, v6.11)**

- v6.10: Added vendor-maintenance for vendors that shouldn’t be file-copied.
- v6.11: Removed validation against file group on update (was commented out).

---

## 12. **Program Entry and Termination**

- **Entry:** Parameters for file group and company are expected (`p_lfgr`, `p_lfir`). Key lists are set up and subfile is filled from the start.
- **Termination:** *INLR = *ON and return.

---

## 13. **Summary Table at End**

At the end, a small section lists codes for actions:
- 001: New
- 002: Change
- 003: View

---

# **Summary Diagram - Main Screen & Flows**

```
User
 │
 ▼
B2CMD/B2CTL ──► B1SFL (Subfile)
   │
   ├─1=Add───► Entry/Edit (C1BLD/C2BLD)
   ├─2=Change► Edit Line (C2BLD)
   ├─3=Copy──► Copy Window (K1WIN)
   ├─4=Delete► Delete Window (D1WIN)
   └─5=View──► View Panel (C2BLD-protected)

Subfile navigation, refresh, positioning, and error display handled by indicators and subroutines.
```

---

# **Key Takeaways for New Developers**

- The program relies heavily on subfiles for multi-row editing.
- Multiple file formats (record layouts) are used for different operations against the same physical files.
- IBM i indicators are central to managing state, navigation, and field protection.
- Standard maintenance flow: display list, select action, act per-row or from main action bar.
- The code is robust, modular (with subroutines for each logical function), and extensible via parameters and special version markers.

---

**If you need deeper details on a particular subroutine, data structure, or file definition, feel free to ask!**