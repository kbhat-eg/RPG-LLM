# RPG Program Explanation: LH708R – "Finne bestillingssaldo pr. vare og dato"

This program, written in ILE RPG (fixed format), calculates the outstanding order balance for a given item (`vare`) and date (`dato`). It traverses order lines, applies business rules based on order and line types, and sums up the relevant quantities.

Let's break it down section by section.

---

## 1. **Header and Options**
```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*nodebugio`: Do not include file I/O statements in debug views.
- `datedit(*dmy)`: Sets date format to Day-Month-Year for input and output.

The header comments explain the purpose and change history of the program.

---

## 2. **File Declarations**
```rpg
flodtlv  if e k disk    rename(lodtpfr:lodtlvr)
flohelr  if e k disk    rename(lohepfr:lohelrr)
fvotyl1  if e k disk    rename(votypfr:votyl1r)
fvltyl1  if e k disk    rename(vltypfr:vltyl1r)
fvvarl1  if e k disk    rename(vvarpfr:vvarl1r)
fvvenl1  if e k disk    rename(vvenpfr:vvenl1r)
```
These define input files:
- `lodtlv` (Order lines),
- `lohelr` (Order headers),
- `votyl1` (Order type table),
- `vltyl1` (Line type table),
- `vvarl1` (Item table),
- `vvenl1` (Item unit table).

Each is `input`, `full procedural` access, `keyed`, with a record format rename.

---

## 3. **Data Structures and Fields**
### a. **Parameter Input DS**
```rpg
d                 ds
d d_prec                        30
d  d_vare                        8  0 overlay(d_prec)
d  d_tdat                        6  0 overlay(d_prec:9)
d  d_lage                        2  0 overlay(d_prec:15)
d  d_anta                       11  3 overlay(d_prec:17)
```
- Input parameters are packed into `d_prec`, then overlaid for extraction:
  - `d_vare`: Item number
  - `d_tdat`: Date (as numeric)
  - `d_lage`: Warehouse
  - `d_anta`: Quantity

### b. **Local Data Area**
```rpg
d                uds
d l_firm         944    946  0
```
- Extracts the company/firm number from the LDA for use in keyed access.

### c. **Key Variables and Working Variables**
- Variables for keys (`lodtlv_vare`, `lohelr_numm`, etc.) are initialized based on database field types.
- Working variables for dates, quantity, and conversion rates.

---

## 4. **Main Loop: Processing Order Lines**
### a. **Read Loop**
```rpg
c lodtlv_key    reade     lodtlvr                                90
c               dow       *in90 = *off
...
c lodtlv_key    reade     lodtlvr                                90
c               enddo
```
- Reads order line records with the `lodtlv_key` (firm + item).
- Loops while records are found (`*in90 = *off`).

### b. **Check Line Type**
```rpg
c     vltyl1_key    chain     vltyl1                             91
c                   if        vallag = 1
c                   exsr      behandling
c                   endif
```
- For each order line:
  - Loads line type info using `vltyl1_key`.
  - Only processes lines where `vallag` (indicates "included in stock") is 1.

---

## 5. **After Main Loop**
```rpg
c eval      d_anta = w_anta
c eval      w_parm = d_prec
```
- The calculated total is moved to the parameter field for output.

---

## 6. **Program End**
```rpg
c eval      *inlr = *on
c return
```
- Ends the program cleanly.

---

## 7. **Subroutine: `behandling`**
This is where all business logic for a qualifying order line is handled.

### a. **Find Order Header**
```rpg
c eval      lohelr_numm = ldnumm
c eval      lohelr_suff = ldsuff
c lohelr_key    chain     lohelr                             92
c if        *in92 = *on
c goto      end_behand
c endif
```
- Finds the matching order header; skips if not found.

### b. **Check Order Type and Stock Update**
```rpg
c eval      votyl1_otyp = lootyp
c votyl1_key    chain     votyl1                             93
c if        vaosys <> 1 or vaoakk <> 1 or vaolag <> 1
c goto      end_behand
c endif
```
- Chains into the order type file; only processes certain system, acknowledgment, and stock update types.

### c. **Check Correct Warehouse**
```rpg
c if        lolage <> d_lage
c goto      end_behand
c endif
```
- Skips the line unless the order's warehouse matches the requested one.

### d. **Determine Delivery Date**
```rpg
c select
c when      ldldat <> *loval
c   w_bdat = ldldat
c when      lomoda <> *loval
c   w_bdat = lomoda
c when      loldat <> *loval
c   w_bdat = loldat
c when      lobdat <> *loval
c   w_bdat = lobdat
c other
c   goto      end_behand
c endsl
```
- Determines which of several possible delivery date fields is relevant.

### e. **Check Date Range**
```rpg
c if        w_bdat > w_tdat
c goto      end_behand
c endif
```
- Skips orders outside the date limit.

### f. **Delivery Type**
```rpg
c if        ldlety = 1
c goto      end_behand
c endif
```
- Excludes lines with certain delivery types.

### g. **Quantity Calculation**
- If the ordered unit matches the stock unit, use the quantity directly.
- Otherwise, convert units using the conversion factors in `vvenl1`:
  - Find conversion factor for both ordered and stock units
  - Calculate the effective quantity.

### h. **Adjust for Order/Line Sign**
```rpg
c if        vaokre = '-'
c   w_bant = w_bant * -1
c endif
c if        valkre = '-'
c   w_bant = w_bant * -1
c endif
c w_anta = w_anta + w_bant
```
- Multiplies by -1 if order/line type indicates a negative effect on quantity.

---

## 8. **Initialization Subroutine (`*inzsr`)**
- Sets up all needed keys for chains and reads.
- Receives parameters, sets up initial values, converts date, sets up the first key.

---

## 9. **Parameter List**
```rpg
c *entry        plist
c parm                    w_parm
c eval      d_prec = w_parm
```
- Gets the 30-character input parameter block.

---

## 10. **Summary of Program Flow**
1. **Initialization:** Get parameters, set up keys, position file.
2. **Loop Through Order Lines:** For selected item and warehouse, process only those lines that are relevant by type and date.
3. **Business Rules:** Check order/line types, correct warehouse, delivery date/type, then compute or convert quantities as needed, adjusting for plus/minus signs.
4. **Accumulate:** Add all qualifying quantities.
5. **Return Value:** Pass the sum back in the parameter.

---

## 11. **Key Business Rules and Customizations**
- Only lines affecting stock (`vallag = 1`).
- Only if warehouse matches.
- Skips lines outside date range or with certain delivery types.
- Supports unit conversion, using item master/unit tables.
- Handles “negative” orders/lines.
- Can support number expansion and other customizations as shown in changelog.

---

## 12. **Special Notes**
- All file access is keyed; efficient for large datasets.
- Heavy use of Norwegian variable names (e.g., `lager`, `vare`, `bestilling`).
- Well documented with version history and logic comments.
- Handles mixed unit environments and complex business rules.

---

# **Conclusion**
This program computes the number of items on order (not yet delivered) for a specified item and date cutoff, respecting warehouse, unit conversions, line types, and business rules—returning the calculated amount to the calling program or process.