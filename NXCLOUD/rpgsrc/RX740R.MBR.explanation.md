# RPG Program RX740R Explanation

## Overview

This IBM ILE RPG program, named **RX740R**, is written for the ASOKON system. Its main function is to read records from the file `RKUNPF` and copy/update them into another file, `RKU2PF`. There is special logic related to updating a field (`RK2FAS`) based on conditions, controlled by an entry parameter.

---

## Header and Metadata

```rpg
h option(*nodebugio) datedit(*dmy)
```
- **option(*nodebugio)**: Disables debug information for I/O (performance improvement).
- **datedit(*dmy)**: Sets default date format to day/month/year.

The header comments document the purpose, versioning, and code change history. Notably, version 8.01 introduces logic for handling a flag for certain invoice types.

---

## File Declarations

```rpg
frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
frku2lu    uf a e           k disk    rename(rku2pfr:rku2lur)
```
- **rkunlr**: Input keyed file (renamed record format).
- **rku2lu**: Update keyed file (renamed record format).

---

## Local Data Area

```rpg
d                uds
d l_user                911    920
d l_firm                944    946  0
d l_fnav                951    980
```
- Maps fields from the User Data Area (UDA) to local variables.
    - **l_user**: User name.
    - **l_firm**: Firm number.
    - **l_fnav**: Not explained but assumed to be a navigation or firm-related field.

---

## Key and Working Variables

```rpg
d rku2lu_kund     s                   like(rkkund)
d w_firm          s                   like(rkfirm)
8.01 d p_fast     s              1
```
- **rku2lu_kund**/**w_firm**: Used to build keys for file access.
- **p_fast**: 1-character flag parameter (controls special logic).

---

## Constants

```rpg
d Lo              c                   'abcdefghijklmnopqrstuvwxyz���'
d Up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ���'
```
- **Lo**/**Up**: Lowercase and uppercase Norwegian letter strings (for character manipulation, though not used in current logic).

---

## Main Program Loop

```rpg
c                   read      rkunlr
c                   dow       not %eof
c                   eval      rku2lu_kund = rkkund
c     rku2lu_key    chain     rku2lu
c                   if        not %found
c                   clear                   rku2lur
c                   exsr      crt_rku2
8.01 c                   else
8.01 c                   exsr      upd_rku2
c                   endif
c                   read      rkunlr
c                   enddo
```
- **Read rkunlr**: Reads a customer record.
- **While not end of file**: Processes all records.
- **Build Key**: Copies customer number to key variable.
- **Chain (lookup) rku2lu**: Checks if customer already exists in the target file.
- **If not found**:
  - Clears target buffer and calls `crt_rku2` subroutine to create a new record.
- **Else** (version 8.01):
  - Calls `upd_rku2` subroutine to update the existing record.
- **Continue reading next record**.

---

## Program Termination

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
```
- Sets LR (Last Record indicator) to ON, which ends the program.

---

## Subroutines

### 1. `crt_rku2` – Create Register in RKU2PF

```rpg
c     crt_rku2      begsr
c                   eval      rk2fir = rkfirm
c                   eval      rk2kun = rkkund
8.01 c                   if        p_fast = '1'
8.01 c                   if        rkfaty = 24 or
8.01 c                             rkfaty = 28
8.01 c                   eval      rk2fas = 1
8.01 c                   endif
8.01 c                   endif
c                   eval      rk2eus = l_user
c                   time                    rk2eti
c                   time                    rk2eda
c                   eval      rk2sig = l_user
c                   time                    rk2tim
c                   time                    rk2dat
c                   write     rku2lur
c                   endsr
```
- **Sets firm and customer on target record**.
- **If `p_fast` = '1' and invoice type `rkfaty` = 24 or 28**:
  - Sets `rk2fas` = 1 (special flag).
- **Updates user and timestamp fields.**
- **Writes the new record to `RKU2PF`.**

### 2. `upd_rku2` – Update Register in RKU2PF

```rpg
8.01 c     upd_rku2      begsr
8.01 c                   if        p_fast = '1'
8.01 c                   if        rkfaty = 24 or
8.01 c                             rkfaty = 28
8.01 c                   eval      rk2fas = 1
8.01 c                   eval      rk2eus = l_user
8.01 c                   time                    rk2eti
8.01 c                   time                    rk2eda
8.01 c                   endif
8.01 c                   endif
8.01 c                   update    rku2lur
8.01 c                   endsr
```
- **If `p_fast` = '1' and invoice type is 24 or 28**:
  - Updates `rk2fas` to 1, user, and timestamp fields.
- **Updates the record in `RKU2PF`.**

### 3. Program Initialization (`*inzsr`)

```rpg
c     *inzsr        begsr
8.01 c     *entry        plist
8.01 c                   parm                    p_fast
c     rku2lu_key    klist
c                   kfld                    w_firm
c                   kfld                    rku2lu_kund
c                   endsr
```
- Sets up program entry/parameter list.
- Defines keyed list for updates.
- The parameter `p_fast` controls whether to set `rk2fas` for specific invoice types.

---

## Special Notes

- **Indicators**: Uses standard RPG indicators; e.g., `*INLR` denotes program end.
- **Field and Record Naming**: Many fields use Norwegian abbreviations (e.g., `kun` for kunde/customer, `firm` for firm/company).
- **Data Movement**: Moves data from record format to variables and vice versa for file operations.
- **Parameterization**: The logic for updating `rk2fas` is controlled by the program parameter `p_fast`.

---

## Summary

- The program migrates or updates customer records from `RKUNPF` to `RKU2PF`.
- With the 8.01 update, it sets a special flag (`rk2fas` = 1) for customers with invoice types 24 or 28, based on a parameter.
- It uses standard RPG file I/O patterns (READ, CHAIN, WRITE, UPDATE) with subroutines for modularity.
- Useful for data synchronization and enforcing business logic during migration.
