# RPG Program Explanation: BK100R (ButikkKasse Maintenance)

This RPG/400 ILE program is a maintenance program for handling "ButikkKasse" (shop cash registers), supporting CRUD (Create, Read, Update, Delete) operations, and is heavily based around subfile processing for interactive user interfaces.

---

## 1. **Header & Documentation**

- **h option(*nodebugio) datedit(*dmy)**  
  - Disables debugging for IO, sets date format as day/month/year.
- Includes detailed program metadata: name, description, history log, and indicator usage conventions.

---

## 2. **File Definitions**

- **Physical/Logical Files:**  
  - `bkasi1, bkasi2, bkasir, bkasiu, bstsl1, votyl1, awsdl1, awsdlu`: Logical and update files, accessed with various keys, representing cash registers, order types, printer control data, etc.
- **Display File:**  
  - `bk100d`: Workstation file for display.  
    - Uses subfile (`sfile(b1sfl:w_srrn)`) and a feedback data structure (`infds(dspfbk)`).

---

## 3. **Data Definitions**

- **LDA (Local Data Area) Fields:** For user, firm, etc.
- **Display Feedback DS:** For cursor position (`d_fcrn`).
- **Key fields:** Used for file searches & updates.
- **Work variables:**  
  - Subfile paging/record number variables (`w_fcrn`, `w_srrn`, etc.).
  - Various flags (`b_oppr` for create mode, `b_forn` for refresh needed, etc.).
  - Constants for subfile size, etc.

---

## 4. **Subfile Field Documentation**

Describes fields/variables used for subfile handling–for paging, record numbers, navigation, etc.

---

## 5. **Screen/Image Names**

Lists all screen formats used (B1SFL, B2CTL, B2CMD, C1BLD, C1MSG, C2BLD, D1WIN, K1WIN) for corresponding user actions.

---

## 6. **Main Program Logic**

**The mainline consists of several tags and subroutines.**  
**Flow overview:**

1. **Initialization** is done in `*inzsr` subroutine (at the end).
2. **Main display loop:**  
   - Displays command screen (B2CMD; tag `b2taga`).
   - Handles subfile display and user actions (tag `b2tagb` and branching by function key).
   - Provides:
     - Refresh (`forny`)
     - Create (`xc1bld`)
     - Page up/down (`crt_subfile`, `bck_subfile`)
     - Cursor movement and positioning
     - Subfile processing (`subfile` subroutine)
   - Loops until user exits.

### **Function Key Handling (`SELECT`):**
- `*inkc, *inkl`: Exit program.
- `*inke`: Refresh subfile.
- `*inkf`: Enter creation mode.
- `*in10`, `*in11`: Page down/up subfile.
- `*in21`: Home key, move cursor.

### **Positioning & Filtering**
- If the user enters filter values (cash register, description), calls `posisjoner` to re-position and reload the subfile.

---

## 7. **Subroutine Details**

### **forny (Refresh subfile)**
- Chains to the current record if positioned, sets correct file position key (by cash register or description), clears and rebuilds subfile.

### **posisjoner (Position subfile)**
- Positions to entered cash register or description; clears and repopulates subfile; clears filter fields.

### **subfile (Subfile Processing)**
- Loops through subfile records (using `readc`), processes selected row action:
  - Edit (`b1valg=2`): Open for edit
  - Copy (`b1valg=3`): Copy record
  - Delete (`b1valg=4`): Opens delete window
  - View (`b1valg=5`): Open in view only mode
- On any change, sets `b_forn` to refresh/rebuild the subfile.

### **xc1bld (Create New Row)**
- Sets creation mode. Loops displaying entry screen until valid data entered or canceled.
- If record exists, shows a warning (`xc1msg`).
- On success, calls edit routine (`xc2bld`) for details, then returns to main.

### **xc1msg (Show Creation Error/Warning)**
- Displays message if the cash register already exists; sets flag if canceled.

### **xc2bld (Edit/View Row)**
- Loads current data (if existing), otherwise initializes empty fields.
- Fetches user/printer control queues if configured.
- Handles user actions (cancel/leave), validation, and updates (`write/update` on `bkasiur`).
- Updates workstation/printer control files as needed.
- Updates subfile if edit/view came from subfile row.

### **xc3bld (Edit “Pre-Printed Form” fields)**
- Handles the C3 screen for certain fields, similar structure to C2.

### **xd1win (Delete Window)**
- Confirms and handles deletion of a cash register and related printer control records.

### **xk1win (Copy Window)**
- Handles copying a cash register; validates no overwrite, then passes control to the edit routine.

### **clr_subfile (Clear Subfile)**
- Clears subfile display, resets subfile-related variables.

### **crt_subfile (Create/Fill Subfile Page)**
- Reads next page of records from correct file (`bkasi1` or `bkasi2`), writes them to subfile.
- Sets end-of-file when records run out.

### **bck_subfile (Page Up Subfile)**
- Positions recordset backward, fills previous subfile page.

### **dsp_subfile (Display Subfile)**
- Displays subfile with correct indicators for overlays, window control, etc.

### **\*inzsr (Initialization Subroutine)**
- Builds all KLISTs (key lists).
- Loads company from LDA, sets up screen for first use.
- Retrieves necessary settings for order types.
- Opens database at first record and populates first subfile page.

---

## 8. **Indicator Usage**

- The comments at the top describe the meaning of all indicators (`LR`, `10`, `11`, `12`, etc.), which are used for controlling display file behavior, subfile paging, cursor, field protection, and error messaging.

---

## 9. **File Key Lists**

- Key lists (`klist`) are defined for all file operations to simplify chains, reads, and updates with correct keys.

---

## 10. **General Observations**

- **Subfile-driven user interface:**  
  - Allows for interactive editing, viewing, deleting, and copying of records.
  - Efficient paging and positioning.
- **Strong data validation and error handling:**  
  - Prevents duplicates, enforces required fields, provides user feedback.
- **Integration with workstation/printer controls.**
- **Configurable by company/firm (`w_firm` from LDA).**
- **History and structure facilitate ongoing extension (as evidenced by C3BLD additions).**

---

## 11. **Typical User Flow**

1. **See list of cash registers, page through them.**
2. **Create new, edit existing, view, copy or delete a register.**
3. **Update is reflected in both register and workstation/printer files.**
4. **All processing happens interactively, with validation and feedback.**

---

## 12. **Best Practice Notes**

- **Well-factored:** Subroutines cluster similar logic; code is easy to follow for RPG/400-experienced developers.
- **Use of tags:** Structured goto’s, typical for this RPG style.
- **Good comments:** Aids maintainability and onboarding.

---

## 13. **Onboarding Checklist**

- Be familiar with RPG subfile handling (display, read/write, indicators).
- Understand the physical and logical files for cash registers and related control tables.
- Know how key lists (`klist`) are defined and used.
- Learn the specific fields and their mapping between screen, variable, and file.
- Review the use of LDA for current user and company context.
- Study how error and status indicators are used to control UI and flow.

---

**In summary:**  
This program is a classic ILE RPG subfile maintenance tool for handling “ButikkKasse” (shop cash registers), with solid user interface logic, data validation, and file integration. It is a good onboarding case for RPG developers looking to understand modern (pre-RPGLE-free) RPG/400 business applications.