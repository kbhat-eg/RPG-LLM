## LN100R Program Explanation

This RPG/400 (ILE RPG) program, named `LN100R`, is for maintaining log codes in an IBM i (AS/400) environment, using display files with subfile (list) support, and several physical files for lookup and update. The code is well-commented and uses Norwegian notation and terms.

Below is a structured explanation of the program:

---

### **Header Section**

- **Purpose:**  
  The program’s purpose is "Logg-koder, vedlikehold" (log codes maintenance).
- **Change log:**  
  Documents changes, authors, and dates.
- **Indicators Usage:**  
  Details which indicators (`*INxx`) are used for various screen and logic functions.
- **Special RPG options:**  
  - `h option(*nodebugio)` – suppresses debug IO.
  - `h datedit(*dmy)` – sets date edit format to day/month/year.

---

### **File Declarations**

- **Logical and Physical Files:**  
  - `llokl1`, `llokl2`, `lloklr`, `lloklu`: All are logical files over the same physical file (`llokpfr`), but with different record formats.  
  - `ln100d`: Display file, using subfile (`sfile(b1sfl:w_srrn)`), with an information data structure (`infds(dspfbk)`).

---

### **Data Structures & Variables**

- **Local Data Area (LDA):**
  - `l_user`, `l_firm`, `l_fnav`: Used to identify the user, firm, and (possibly) function navigation.
- **Display Feedback Data Structure (`dspfbk`):**
  - `d_fcrn`: Used for cursor positioning and tracking first record displayed.
- **Key Variables:**
  - Used for building keys to chain/setll/setgt to the logical files.
- **Subfile Variables:**
  - `w_fcrn`, `w_stel`, `w_spge`, `w_srrn`, `w_sfrn`, `w_ssrn`: Control subfile behavior (current page, counts, etc.).
- **Control/Flag Variables:**
  - `b_oppr`, `b_forn`, `b_anul`, `b_feil`: Control states for subroutine operations.
- **Constants:**
  - `c_sfil`: Constant for subfile page size (14).

---

### **Program Flow (Mainline Logic)**

1. **Initialization (`*INZSR`):**
   - Builds key lists.
   - Reads firm number from the LDA.
   - Initializes the subfile (positions and fills it).

2. **Main Processing Loop:**
   - Implements a tag-driven (like a finite-state machine) process, alternating between:
     - Sending static command screen (`b2cmd`)
     - Displaying/processing subfiles (exsr `dsp_subfile`)
   - Handles function keys using a `select` statement:
     - `*INKC`/`*INKL` – Exit program.
     - `*INKE` – Refresh subfile.
     - `*INKF` – Add record (invoke create logic).
     - `*IN10` – Next page in subfile.
     - `*IN11` – Previous page in subfile.
     - `*IN21` – Positioning with cursor.

3. **Positioning Logic:**
   - If a type or description is entered for positioning, calls `posisjoner` subroutine.

---

### **Subroutines Overview**

1. **FORNY (Refresh Subfile):**
   - Repositions the subfile based on the key, clears and recreates subfile data.

2. **POSISJONER (Positioning in Subfile):**
   - Positions the subfile list based on entered type or description.
   - Recreates subfile and blanks the positioning fields.

3. **SUBFILE (Process Selected Subfile Rows):**
   - Reads active subfile records.
   - Handles user actions on subfile rows: Edit, Copy, Delete, View.
   - Invokes update routines and refreshes the subfile if needed.

4. **XC1BLD (Create New Row Screen - C1BLD):**
   - Handles the creation of a new record.
   - Checks if the record already exists, displays a message if so.
   - Calls the edit/view routine afterwards.

5. **XC1MSG (Create Message Screen):**
   - Informs the user that the record already exists.
   - Sets "anul" flag if the user cancels.

6. **XC2BLD (Edit/View/Create Screen - C2BLD):**
   - Handles creation, update, or display of a record.
   - Validates input.
   - Updates or writes records to the update logical file.
   - Triggers refresh when necessary.

7. **XD1WIN (Delete Window):**
   - Handles deletion of a record.
   - Calls delete on the update logical file.

8. **XK1WIN (Copy Record Screen):**
   - Handles copying a record to a new key.
   - Checks for existence before copying.
   - Calls edit/view logic for the new record.

9. **CLR_SUBFILE (Clear Subfile):**
   - Clears subfile records and resets counters.

10. **CRT_SUBFILE (Create/Fill Subfile):**
    - Reads records from database to fill the subfile, based on current key and position.
    - Handles paging logic.

11. **BCK_SUBFILE (Backpage Subfile):**
    - Handles going back one page in the subfile, including repositioning logic.

12. **DSP_SUBFILE (Display Subfile):**
    - Formats and displays the subfile control record, sets up for reading user input.

---

### **Screen and File Layouts**

- **Subfile Screens Used:**
  - B1SFL (main subfile record)
  - B2CTL (subfile control)
  - B2CMD (function key screen)
  - C1BLD (new record entry)
  - C1MSG (message)
  - C2BLD (edit/display/create)
  - D1WIN (delete window)
  - K1WIN (copy window)

---

### **Key Control Variables and RPG Indicators**

- **Control Indicator Usage:**
  - 10 - Roll (page down)
  - 11 - Rolldown (page up)
  - 12/13/14/15 - Subfile controls
  - 21/22 - Cursor placement
  - 30 - Protect fields on display
  - 90 - Record not found
  - Others for error/warnings

---

### **Workflows**

#### **Paging in Subfile**
- Page Down: `crt_subfile` called on *IN10.
- Page Up: `bck_subfile` called on *IN11.

#### **Positioning**
- If type/description entered, use `posisjoner` to set the desired starting record.

#### **Row Operations**
- Edit (`b1valg = 2`): Opens edit dialog, updates row on return.
- Copy (`b1valg = 3`): Opens copy dialog, ensures target doesn't exist, allows user to modify.
- Delete (`b1valg = 4`): Opens delete dialog; deletes with confirmation.
- View (`b1valg = 5`): Opens display-only dialog.

#### **Adding a New Record**
- User hits add, opens C1BLD to enter type.
- If type exists, shows message; if not, opens edit screen for new entry.

---

### **Summary Table**

| Subroutine      | Purpose                                   |
|-----------------|-------------------------------------------|
| forny           | Refresh/renew subfile display             |
| posisjoner      | Position subfile to a specific entry      |
| subfile         | Process all subfile row actions           |
| xc1bld          | Handle screen for adding new records      |
| xc1msg          | Display 'record exists' message           |
| xc2bld          | Handle edit/display/create for a record   |
| xd1win          | Handle deleting a record                  |
| xk1win          | Handle copying a record                   |
| clr_subfile     | Clear subfile entries                     |
| crt_subfile     | Fill subfile with next set of entries     |
| bck_subfile     | Page backward in subfile                  |
| dsp_subfile     | Display subfile, handle formatting        |

---

### **Typical Use Case Flow**

1. **Initialization:**  
   User enters program, subfile is displayed with the first page.

2. **User Pages/Positions/Filters:**  
   - Types in filter, pages up/down, or positions to specific description or type.

3. **User Selects a Row or Option:**  
   - Edits, copies, deletes, or views record; each action opens the proper dialog.

4. **User Adds a New Record:**  
   - Screen for key entry. If duplicate, shows message; if not, edit dialog for details.

5. **Subfile Updated:**  
   - After any operation, subfile is refreshed if necessary.

6. **Exit:**  
   - User presses exit key, program ends.

---

### **Key Takeaways**

- The program is a classic subfile maintenance tool for log code records.
- It supports paging, search/positioning, CRUD operations (create, read, update, delete), and copy.
- Logical files are used for different keyed access paths (by type, description, etc.).
- RPG indicators are used extensively for driving screen behavior and flow.
- Error/validation logic uses subfile indicators and extra screens.

---

**If you are onboarding:**  
- Focus on understanding subfile mechanics in RPG and how indicator-driven logic maps to the user interface.
- Explore the DDS source for display files (`ln100d`) to see the screen layouts and field names like B1SFL, B2CTL, etc.
- Review the physical/logical file layouts for `llokpfr` to understand what keys/data the subfile is showing.
- The program's modular, “tag-and-goto” driven flow is typical of classic RPG, and knowing which subroutine maps to which user action is crucial.

---

If you have questions about specific subroutines, indicators, or file logic, feel free to ask!