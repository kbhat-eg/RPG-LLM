# Explanation of RPG ILE Program for Account Movement (RH109R)

## Overview

This legacy ILE RPG program handles maintenance and movement ("Flytting av konto") of accounts within a chart of accounts (kontoplan). It is part of an accounting system (ASOKON) and updates various files related to accounts, customers, vendors, currencies, organizational units, and their respective balances and ledger postings.

The main purpose is to move/rename a chart of account entry and propagate the change to all related tables/files, adjusting keys and references throughout the database.

The code and comments are partly in Norwegian.

---

## High-Level Program Structure

- **Program Entry and Main Routine:** 
  - *EXSR* calls a series of subroutines (`opd_faste`, `opd_kunkat`, ...) that perform updates in various tables.
  - Ends by setting LR (`*INLR`) to close files and stop the program.
- **Parameter Input (`*INZSR`):** 
  - Six key account parameters (old and new account, subaccount, and department) are received as parameters, typically set by a calling program.

---

## File Declarations (`F-Specs`)

- Files such as `ra04lu`, `ra11lu`, etc., are opened for update (UF)/input (IF) as required.
- Files are renamed locally for record format naming consistency and occasionally use the `prefix` keyword for field disambiguation.
- Each file represents a different part of the accounting/ERP reference data.
- The records are typically keyed by company (`w_firm`) and other fields (like account, subaccount, department).

---

## Data Structures and Key Fields

- **Stand-alone Fields:** 
  - Temporary fields for holding old/new values during processing (e.g., `w_gkto`, `w_nkto` are old/new account numbers).
- **Data Structures (DS):** 
  - Overlays for grouping fields for efficient moving (e.g., main account, subaccount, and department).
- **Key Lists:** 
  - Defined for each file to simplify keyed access during chained I/O operations.

---

## Array Definitions (for Saldomatrise/Inngående/Ungående)

- Arrays such as `isa`, `isu`, `qsa`, and `qsu` represent balance or amount matrices for current/incoming/outgoing balances, mapped to fields risa01–risa13, risa00.

---

## Subroutines Overview

### `opd_faste` - Update Fixed Accounts

- Updates *fixed* accounts if the old account matches specific fields (e.g., outgoing VAT, incoming VAT, investment tax, etc.).
- Checks if old subaccount/department matches, and if so, updates the record to use the new account, subaccount, and department.

### `opd_kunkat` - Update Customer Category

- Iterates through `ra11lu` file, updating customer category records that reference the old account, subaccount, or department, replacing them with new values where appropriate.

### `opd_levkat` - Update Vendor Category

- Similar to `opd_kunkat`, but processes vendor categories in the `ra14lu` file.

### `opd_valuta` - Update Currency Codes

- Updates records in the currency code file `ra16lu` where the old account is referenced.

### `opd_virkso` - Update Organizational Unit Codes

- Updates records in `ra23lu` relating to organizational units.

### `opd_hopost` - Update Ledger Entries

- Iterates through all general ledger postings (`rhtrl7r`) for the old account.
- Updates account, subaccount, and department as per the rules.
- Records the user and timestamp for change tracking.

### `opd_hosald` - Update General Ledger Balances

- For each balance (record in `rhsal1r`), collects necessary info, and updates or moves the balance to the new account key in `rhsalur`.
- Deletes the old record after moving.

### `opd_kladde` - Update Journal Block

- Updates draft/journal records in `rklal1r`/`rklalur` for the moved account, subaccount, and department.

### `opd_kontop` - Update Chart of Accounts

- Deletes old account records with the old keys if necessary.
- Updates or creates a new account record (with text updated to indicate the move) in `rhovlur` for the new account only (subaccount and department are reset to 0).

---

## Initialization Routine (`*INZSR`)

- Receives and sets up all parameters.
- Prepares all key lists for chained access to the records.

---

## Key Program Features

### Chained File Access and Updates

- Each subroutine uses keyed operations (`setll`, `reade`, `chain`) to efficiently locate and update records.
- Conditional checks ensure only the relevant records are updated.

### Audit Trail

- For many files, update/add operations log the user and timestamp fields (`rbeusr`, `rbedat`, etc.) for auditability.

### Text Handling

- When moving the account in the chart of accounts, descriptive text is set to indicate if the account was "moved from" or "added from" another account.

### Comprehensive Coverage

- The program touches all files that may reference the changed account, ensuring data integrity throughout the ERP submodules.

---

## Comments and Maintenance Information

- The header includes a change log (in Norwegian), detailing bug fixes, enhancements, and file changes by version and developer.
- Modifications are marked in code (e.g., `6.10`, `T5.40`, `E5.40`), documenting version-specific changes.

---

## Typical Use Scenario

Suppose a user wants to rename or move an account to a new number (perhaps as part of a reorganization). This program:

1. Receives the old (source) and new (target) account parameters.
2. Updates all related files (general ledger, balances, customer/vendor/category references, etc.) to reflect the new account information wherever the old account was previously used.
3. Ensures no dangling references are left and that all audit fields are current.

---

## Summary Table of Files and Their Roles

| File      | Description/Role                         | Subroutine(s) |
|-----------|------------------------------------------|---------------|
| ra04lu    | Fixed accounts (VAT, tax, etc.)          | opd_faste     |
| ra11lu    | Customer categories                      | opd_kunkat    |
| ra14lu    | Vendor categories                        | opd_levkat    |
| ra16lu    | Currency code records                    | opd_valuta    |
| ra23lu    | Organizational unit codes                | opd_virkso    |
| rhovl1/rhovlu | Chart of accounts (main/unique keys) | opd_kontop    |
| rhsal1/rhsalu | General ledger balances              | opd_hosald    |
| rhtrl7    | General ledger postings                  | opd_hopost    |
| rklal1/rklalu | Journal block (draft)                | opd_kladde    |

---

## Special Notes

- **Language:** The column and field names (and comments) are in Norwegian, as is common in legacy Scandinavian systems.
- **RPG Style:** The program is written in classic fixed-format RPG IV, not in the more modern free-format style.

---

## Key Takeaways for New Developers

- **Goal:** Ensure a seamless, traceable move of account numbers throughout an integrated ERP’s financial references.
- **Where to Look:** The main logic is in the subroutines; each handles a specific part of the reference data or transaction ledger.
- **Auditability:** User and timestamp fields are updated for every change.
- **Safety:** Old records are generally deleted only after new records are successfully written, preventing data loss.

---

*If you have further questions about specific subroutines or sections, feel free to ask for deeper dives!*