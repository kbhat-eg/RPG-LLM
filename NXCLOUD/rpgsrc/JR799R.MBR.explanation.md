# RPG Program JR799R â€“ Overview and Explanation

This RPG IV (ILE RPG) program is designed to process a specially formatted file ("Ahlsell format") of item data. It either creates new items or updates prices for existing items in the LVR item register. Notable business rules include creating new items as standalone, not as supplier-linked items, and updating prices based on supplier's item number. A 4.5% markup is added to the purchase price from the file.

Below is a structured explanation of the main components:

---

## 1. File Declarations (`F-Specs`)

The program uses multiple files, most of which are updated (UF, O) or read (IF), many with renamed record formats for clarity:

```rpg
fjrvapf    if   e           k disk              // Input: Ahlsell formatted file (item data)
fjrapl1    if   e           k disk  rename()    // Report master
fjvarl8    if   e           k disk  rename()    // Item master (keyed by supplier)
fjvarlu    uf a e           k disk  rename()    // Item master (unique)
fjvdtlu    o  a e           k disk  rename()    // Item detail
fjstslu    uf   e           k disk  rename()    // Status/counter
fjvpklu    uf a e           k disk  rename()    // Item packaging
fjvprlu    uf a e           k disk  rename()    // Item prices
ffenkl1    if   e           k disk  rename()    // Unit conversion
fjrvgl1    if   e           k disk  rename()    // Item group mapping
fjpfal6    uf a e           k disk  rename()    // Markup/additional charge master
fjpfalu    uf a e           k disk  rename()    // Markup/additional charge unique
```

---

## 2. Data Definitions (`D-Specs`)

### Main Structures and Data Areas

- **Parameters:** For input to the program.
- **Local Data Area:** For operator/user information.
- **Input Record Layout:** Data structure overlays for parsing the 120-character input.

### Example (Input Record Description):

```rpg
d d_inpu       ds             // Complete input row
d  d_lvnr        14 overlay(d_inpu:1)   // Supplier item number
d  d_vtxt        52 overlay(d_inpu:16)  // Item description
d  d_enhe         3 overlay(d_inpu:69)  // Unit
...
```

### Key Variables

- Variables for keys to indexed lookups (`chain`, `setll`, etc.), often using `like()` based on database fields.
- Work variables for handling prices, status, and intermediate calculations.
- Constants for digit and character translation.

---

## 3. Program Logic (Mainline)

### Initialization

- The `*inzsr` subroutine is called at start, parsing parameters and setting up keys.

### Report Master Lookup

- Fetches report master data using the input parameter `d_rapp`.
- Halts execution if not found.

### Main Processing Loop

- Reads each record in the Ahlsell input file.
- Calls the `behandling` subroutine for record-level processing.
- Ends when all records are processed.

---

## 4. Main Subroutine: `behandling`

**Purpose:** Handles each item record from input file.

### Steps:

1. **Input Parse:** Splits the 120-char input into fields.
2. **Validation:** Skips records without supplier item number.
3. **Text Handling:** Trims, translates, and normalizes item description.
4. **Unit Conversion:** Looks up and converts legacy unit codes.
5. **Determine Item (Product) Status:**
   - Checks if the item already exists (`chain` by supplier number).
   - If found, calls `endr_vare` (update existing).
   - If not found, calls `ny_vare` (create new).
6. **EAN Check:** Validates and sets EAN number via `sjk_ean`.
7. **Populate/Update Item Master:**
   - Sets group, text, and various fields.
   - Updates if exists; writes if new.
8. **Item Detail Creation:** For new items, writes item detail record.
9. **Packaging, Pricing, Markup:**
   - Calls respective subroutines: `oppd_pakning`, `oppd_pris`, `oppd_paslag`.
10. **Search Text Update:**
    - Calls external program `'JV790R'` to handle searchable texts.

---

## 5. Subroutines

### `endr_vare` (Update Existing Item)
- If item status isn't 0, 1, or 4 (active statuses), keeps existing status.
- Deletes non-manual item packaging and prices.
- Deletes markup records.

### `ny_vare` (Create New Item)
- Sets item status to 2 (new).
- Fetches next available item number from status/counter file and increments it.
- Sets creation dates.

### `oppd_pakning` (Create Packaging)
- Prepares and writes the packaging record.

### `oppd_pris` (Create Price)
- Extracts price, converts and validates format.
- Adds 4.5% markup to price as per business rule.
- Populates and writes price record.

### `oppd_paslag` (Create Markup)
- Extracts and validates markup from the file.
- Calculates ratio, sets fields, writes markup record.

### `sjk_ean` (Check EAN Number)
- Validates EAN (must be all digits), if not, clears variable.
- If valid, formats to appropriate field.

### `*inzsr` (Program Initialization)
- Handles parameter parsing.
- Sets company number.
- Defines all KLISTs for indexed file access.

---

## 6. Additional Notes

- Many fields use overlays for space efficiency and to mirror data file layouts.
- Norwegian/Scandinavian character handling is explicit in `xlate` operations.
- All database updates are directly on physical files (not using SQL).

---

## 7. Business Rules Summary

- **New items** are always created as new, not tied to price-giving supplier.
- **Update occurs** if supplier item number matches.
- **Price** is increased by **4.5%** before storing.
- **Data cleansing/translation** handles both units and text normalization.
- **EAN** is stored only if it's a valid numeric sequence.

---

## 8. Error Handling

- The program skips records with missing supplier item numbers.
- If mandatory lookups (e.g., report master) fail, the program exits.
- No explicit exception/error handling for other file I/O errors.

---

## 9. Extensibility

- Further logic (like updating search texts) is delegated to external programs.
- The code is modular, using subroutines for each main step in the item handling process.

---

**This program is a strong example of batch-type ILE RPG logic for master data maintenance, making heavy use of overlayed data structures, indexed file access, and procedural subroutine organization.**