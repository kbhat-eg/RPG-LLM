# HR131R – Radio Terminal Transactions, Goods Receipt

## Overview

**Program:** HR131R  
**System:** ASLAGR  
**Purpose:**  
Handles goods receipt transactions via radio terminals, including scanning, validation, registration, and updating of item receipts against purchase orders. The program supports multiple identifier types (item numbers, supplier numbers, EAN/EAN128 barcodes), handles special cases (e.g., substitute items, campaign items, "skaffevarer" [special order items]), and interacts with a broad set of master and transaction files.

---

## Key Business Concepts

- **Varemottak:** Goods receipt, the process of registering received items against purchase orders.
- **Radio Terminal:** Handheld device used in the warehouse for scanning and registering items.
- **Subfile:** Work display for handling multiple line items in a session.
- **Skaffevarer:** Items not normally stocked, but specially ordered.
- **VA:** “Vareregister A” or alternative item register.
- **EAN/EAN128:** Barcode standards for identifying items.

---

## Main Data Flows

### 1. **Initialization (`*INZSR`)**
- Reads parameters (company, code, timestamp, order number, suffix).
- Initializes keys for all relevant files.
- Loads purchase order header and supplier rest code.
- Retrieves price group via call to `VL712R`.
- Checks user access via `AX700R`.
- Fills the subfile with existing receipt lines.

### 2. **Main Loop (`b2taga`/`b2tagb`)**
- Presents the main subfile screen.
- Handles function keys:
  - **F3:** Exit.
  - **F5:** Refresh.
  - **F10:** Add new line.
  - **F4:** Item inquiry (calls `VV580R`).
- Handles scanning input:
  - Calls `scanning` subroutine for barcode/number processing.
- Handles subfile editing (change/delete lines).
- Calls `slutt_mottak` for finalization.

### 3. **Scanning Logic (`scanning`)**
- Determines type of scanned input:
  - **Alphanumeric:** Supplier item number.
  - **26-digit numeric:** EAN128.
  - **≤8-digit numeric:** Item number.
  - **≤14-digit numeric:** EAN.
  - **Other:** Attempts supplier number match.
- For each, attempts to resolve to a known item:
  - Checks VA (alternative item register) if not found.
  - Calls out to external programs for additional validation (`LL871C`, `LL875C`, `VE710R`, etc.).
  - Handles not found cases, including registering in JVSCAPF if necessary.

### 4. **Subfile Handling**
- **Display, edit, and delete** of receipt lines.
- Change and delete operations open modal dialogs for confirmation and editing.
- All changes update the underlying temporary transaction file.

### 5. **Line Registration (`xc2bld`)**
- Presents detailed line entry/edit screen.
- Looks up item details, available units (purchase/sales), and default quantities.
- Handles special logic for VA items, substitute items, and campaigns.
- Validates quantities (e.g., max 1000).
- Supports label printing if requested.

### 6. **Finalization (`slutt_mottak`, `opprett`, `oppdater`)**
- Writes confirmed receipt lines to the main goods receipt file.
- Updates order lines for confirmed receipts.
- Handles creation of picking lines and pack slips via calls to `LO604R` and `LO402R`.

---

## File Interactions

- **hrtrl2, hrtrlr, hrtrlu:** Temporary transaction files for radio terminal receipt sessions.
- **rlevl1:** Supplier master (rest codes).
- **vvarl1, vvarl4:** Item master (by item number, by supplier item number).
- **vvenl1, vvenl2, vvenl4, vvenlu:** Item unit master (purchase/sales units, EAN mapping).
- **lohel1, lodtl1, lodtlu, lodtlv:** Purchase order header/lines.
- **lwvalu:** Temporary goods receipt work file.
- **votyl1:** Order type master.
- **lplolu, lplllu:** Picking header/lines.
- **jvarl1, jvpkl1:** VA item master/unit.
- **vverl1:** Substitute item master.
- **vvlel1:** Timber assortment (for special items).
- **Other:** Calls to external programs for validation, pricing, and label printing.

---

## Domain-Specific Logic and Conventions

- **Indicator Usage:**  
  - 10, 12–16: Subfile and display control.
  - 30: Field protection.
  - 31–79: Error and status indicators.
  - 80–89: Work indicators (e.g., current unit selection).

- **Special Cases:**
  - **Skaffevarer:** Checked via call to `VL710R`; flagged and not allowed for normal receipt.
  - **Substitute Items:** Checked and flagged via `vverl1`; message displayed if relevant.
  - **Timber Items:** Handled via `vvlel1` for special assortment logic.
  - **Campaigns:** Extra information fetched for campaign items.

- **Barcode Handling:**
  - **EAN128:** Parsed via overlay data structure; item, quantity, and unit extracted from barcode.
  - **EAN:** Looked up via `VE710R` call.
  - **Supplier Number:** Used as fallback if item not found by other means.

- **Unit Handling:**
  - When scanning returns a unit, it is used as the default.
  - Up to three units (purchase/sales) are displayed for selection.

- **Subfile Paging:**
  - Subfile page size is fixed (constant).
  - Paging and current record logic handled via `w_srrn`, `w_spge`, etc.

- **External Program Calls:**
  - **LL871C, LL875C:** VA item checks.
  - **VV580R:** Item inquiry.
  - **FP250C:** Label printing.
  - **VP753R:** Pricing logic (campaigns).
  - **LO604R, LO402R:** Packing slip and marking cleanup.

---

## Notable Design Patterns and Decisions

- **Extensive Use of Subroutines:**  
  All business logic is encapsulated in subroutines for clarity and maintainability, following a modular approach.

- **Overlay Data Structures:**  
  Used for parsing EAN128 barcodes, extracting components without explicit parsing code.

- **Database Keying:**  
  All file accesses use named key lists, initialized in `*INZSR`, supporting code clarity and maintainability.

- **Change History and Versioning:**  
  The code is heavily commented with a detailed change log, making it easier to track business rule evolution.

- **Conditional Compilation/Business Rules:**  
  Many blocks are versioned (e.g., 6.11, 6.22, 6.36), and some logic is toggled on/off via comments, reflecting business-driven changes.

- **Error and Status Handling:**  
  Status indicators and error flags are used throughout to control flow and user feedback, tightly coupled to the subfile and display logic.

- **SQL Integration:**  
  For specific lookups (e.g., logistics item resolution), SQL is used inline within the RPG program.

---

## Interactions with Other Modules

- **External Programs:**  
  The program is tightly integrated with other business modules for item validation, pricing, campaign logic, label printing, and picking/packing processes.

- **Purchase Order Processing:**  
  All item receipts are validated and updated against purchase orders, ensuring integrity between receipt and order status.

- **VA System:**  
  Alternative item master (VA) is checked for certain item types, supporting complex product structures.

---

## Summary Table: Main Subroutines

| Subroutine      | Purpose                                                                                     |
|-----------------|--------------------------------------------------------------------------------------------|
| `scanning`      | Handles all scanning logic, item identification, and error handling.                       |
| `forny`         | Refreshes subfile display and reloads data.                                                |
| `subfile`       | Handles editing and deletion of subfile lines.                                             |
| `xc2bld`        | Main item entry/edit screen logic, including units, validation, and updates.               |
| `xd1bld`        | Handles deletion confirmation and processing.                                               |
| `xf1bld`        | Handles "item not found" dialog and logic.                                                 |
| `xg1bld`        | Handles "item not on order" dialog and logic.                                              |
| `xh1bld`        | Handles VA item confirmation dialog.                                                       |
| `xi1bld`        | Handles "skaffevarer" (special order item) dialog.                                         |
| `clr_subfile`   | Clears the subfile.                                                                        |
| `crt_subfile`   | Fills the subfile with current session lines.                                              |
| `dsp_subfile`   | Displays the subfile.                                                                      |
| `slutt_mottak`  | Finalizes goods receipt session, processes all lines.                                      |
| `opprett`       | Writes receipt lines to main file, deletes session lines.                                  |
| `oppdater`      | Updates order lines, creates picking/packing lines, calls packing slip generation.         |
| `finn_linje`    | Finds line number for a given item on the order.                                           |
| `sjekk_ean`     | Validates EAN number via external program.                                                 |
| `ny_linje`      | Registers a new order line if item is not on order.                                        |
| `endre_linje`   | Updates an existing order line with new unit/quantity.                                     |
| `slett_linje`   | Deletes an order line.                                                                     |
| `omr_antall`    | Converts quantity to order unit using conversion factors.                                  |
| `va_enhe`       | Retrieves available units for VA items.                                                    |
| `sjekk_va`      | Checks if item is a VA item.                                                               |
| `sjk_skaff`     | Checks if item is a "skaffevarer" (special order) for the warehouse.                       |
| `sjekk_pkdato`  | Checks if item is valid for the current date (for campaign/timber items).                  |

---

## Practical Notes for New Developers

- **Subfile logic** is central: understand the paging, editing, and update cycle.
- **Barcode scanning** is complex: multiple identification strategies are used, with fallback to VA and supplier numbers.
- **Business rules** (e.g., special order, substitute, campaign) are implemented via both local logic and external program calls.
- **Indicator management** is crucial for display and flow control; always check indicator usage in subroutines.
- **File keys** are initialized in `*INZSR`; adding new keys or changing file structure requires corresponding updates.
- **Versioned logic** (e.g., 6.11, 6.22, 6.36) reflects business changes—always check comments for rationale.
- **SQL is used** for specific lookups—be aware of performance and locking implications.

---

## Conclusion

HR131R is a central program for warehouse goods receipt operations, tightly integrated with item, supplier, order, and VA master files. Its design reflects both the complexity of warehouse processes and the need for flexibility in item identification and validation. The codebase is modular, well-commented, and follows established conventions for indicator and error handling, making it maintainable for experienced RPG developers. However, the business logic is intricate and often driven by evolving requirements—refer to comments and change history for context when making changes.