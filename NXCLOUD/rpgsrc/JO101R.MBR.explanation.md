# RPG Program JO101R: "Matching av varer" (Matching of Products) - Annotated Explanation

This program handles "matching" of items/products in an IBM i (AS400) database environment, utilizing display subfiles for user interaction. The code features subprocedures for displaying, matching, clearing, and updating product records, supporting various types of item matching (e.g., by EAN, supplier, NOBB numbers). Much of the in-line documentation is in Norwegian.

---

## 1. **Header and Options**

```rpg
h option(*nodebugio) datedit(*dmy)
```
- `*NODEBUGIO`: Prevents debugger from stopping on database/file IO.
- `datedit(*DMY)`: Date format: Day-Month-Year.

---

## 2. **File Definitions**

```rpg
fjmatl3    if   e           k disk    rename(jmatpfr:jmatl3r)
fjmatl5    if   e           k disk    rename(jmatpfr:jmatl5r)
fjmatlu    uf a e           k disk    rename(jmatpfr:jmatlur)
fjo101d    cf   e             workstn sfile(b1sfl:w_srrn)
f                                     infds(dspfbk)
```
- `fjmatl3`, `fjmatl5`, `fjmatlu`: Physical files (presumably inventory and matching files, renamed for local use).
- `jo101d`: Workstation file with subfile support (`b1sfl`) for interactive display.
- `infds(dspfbk)`: Field feedback data structure for display.

---

## 3. **Data Structures and Variables**

### Parameter Variables

```rpg
d p_firm          s                   like(jofirm)
d p_ldor          s              6
d p_ogrp          s                   like(joogrp)
d p_hgrp          s                   like(johgrp)
d p_ugrp          s                   like(jougrp)
d p_va1f          s                   like(jovar1)
d p_va1t          s                   like(jovar1)
d p_kode          s                   like(jokode)
```
- Used to pass filter criteria (firm, department, group, product number range, code type).

### Subfile Page Control Variables

```rpg
d w_fcrn          s              4  0   // First record number on page
d w_stel          s              4  0   // Subfile counter
d w_spge          s              4  0   // Subfile page size
d w_srrn          s              4  0   // Relative record number
d w_sfrn          s                   like(w_srrn) // First record on the last page
d w_ssrn          s                   like(w_srrn) // Last record on last page
```
- Controls subfile paging, cursor, and current page record tracking.

### Constants

```rpg
d c_sfil          s              2  0 inz(15)
```
- Page size for subfile (15 records per page).

### Arrays

```rpg
d a_meld          s             25    dim(7) ctdata perrcd(1)   // Messages
```
- Stores various status messages (matched, not matched, etc.) used in UI.

---

## 4. **Indicator Usage**

The program uses indicators (`*INnn`) to manage UI, logic, and error handling. Example roles:
- **LR**: Last record, program end
- **10, 12, 13, ...**: UI actions (roll, subfile display, clear, end)
- **16**: End of subfile records
- **21, 22, 30**: Cursor/home/protection fields
- **31-79**: Warnings and error indicators
- **80-99**: Working indicators

---

## 5. **Logic Flow (Mainline and Subroutines)**

### Initialization (`*INZSR`)
- Reads input parameters, determines which matching file to use, positions file pointers, sets up the display, and populates the subfile.

### Main Loop / Display (implicit mainline)
- Handles user input via subfile (paging, selection, actions).
- Processes function keys (return, refresh, next/previous page, locate).
- Subfile interaction: updating, matching, unmatching, viewing items.

### Subroutines

#### `forny`
- Refreshes subfile by clearing and recreating based on current filters.

#### `subfile`
- Iterates through subfile records (using relative record numbers).
- Handles user actions: match, unmatch, view.
- Calls other subroutines as needed.

#### `match_vare`
- Calls external program `JV501R` to perform item matching, then updates both the item match record and UI subfile row.

#### `fjern_matc`
- Removes the match from an item by updating the match register file and UI subfile row.

#### `clr_subfile`
- Clears subfile and resets all related counters/indicators.

#### `crt_subfile`
- Fills the subfile based on filters/parameters, paginates results.
- Applies all input criteria (group, item number range, etc.).
- Writes item details (from `jmatl3` or `jmatl5`) into subfile records.

#### `bck_subfile`
- (Stub) Intended for going back one page in subfile (not implemented).

#### `dsp_subfile`
- Formats the subfile control record for display, sets indicators.

---

## 6. **Program Internal Logic: Subfile Handling**

- **Display Loop:** The main interaction is through subfiles (scrollable lists of items). Users select actions per item (match, unmatch, view).
- **Paging:** Managed via variables and indicators for first/last record, page size, and the current position.
- **Db Read/Write:** Uses traditional RPG database opcodes (`CHAIN`, `READE`, `UPDATE`, `WRITE`).
- **External Calls:** Matching and viewing actions invoke other programs (`JV501R`, `JV510R`) with related parameters.

---

## 7. **Key Lists (KLISTs)**

Used to construct composite keys for database access:

```rpg
c     jmatl3_key    klist
c                   kfld                    w_firm
c                   kfld                    jmatl3_vkod
c                   kfld                    jmatl3_ldor
c                   kfld                    jmatl3_kode

c     jmatl5_key    klist
c                   kfld                    w_firm
c                   kfld                    jmatl5_vkod
c                   kfld                    jmatl5_kode

c     jmatlu_key    klist
c                   kfld                    w_firm
c                   kfld                    jmatlu_var1
```

---

## 8. **Messages Array**

These are used for status indication in the UI. Example values:

1. Ikke matchet             (Not matched)
2. Manuelt matchet          (Manually matched)
3. Matchet mot lev. varenr  (Matched to supplier item no.)
4. Matchet mot EAN-nr       (Matched to EAN number)
5. Matchet mot Nobbnr       (Matched to NOBB number)

---

## 9. **General Flow**

- **Program Entry:** Parameters are processed. The matching register file is positioned.
- **Subfile is built and displayed.**
- **User interacts:** 
  - Selects item actions (match/unmatch/view).
  - Pages through result sets.
  - Refreshes or exits.
- **Subroutines:** Handle clearing/filling/displaying subfiles, matching/unmatching logic.
- **Program Exit:** When finished, sets LR indicator (`*INLR = *ON`) and returns.

---

## 10. **Special Notes**

- Several fields and routines relate to Norwegian business terminology ("leverand√∏r" = supplier, "vare" = item/product, "nobb" = Norwegian Building Number).
- Comments indicate infrequent but critical maintenance changes (e.g., LVAR field extended from 15 to 20 chars).

---

# Summary Table

| Section                | Purpose/Contents                                             |
|------------------------|-------------------------------------------------------------|
| File Definitions       | Define database/workstation files and subfile (SFL) layouts |
| Parameters             | Filters for item matching/searching                         |
| Subfile Variables      | Track paging, cursor, current record                        |
| Mainline Logic         | Handles user input, actions, and paging                     |
| Subroutines            | Logic for matching, clearing, displaying, updating          |
| Key Lists (KLIST)      | Composite keys for DB access                                |
| Messages Array         | Status messages for UI feedback                             |

---

## **Typical Use Case**

A user wishes to view items needing to be matched, uses the subfile to see results, and can match items to other identifiers (supplier, EAN, NOBB) via on-screen actions, with the program managing database updates and UI feedback.

---

**If you need a step-by-step logic for how, for example, "matching an item" works, or more details about the subfile/paging mechanism, please specify!**