# RPG Program Explanation: SP111R

This program is written in ILE RPG/400, specifically using fixed-format RPG IV (`/TITLE ... C-spec`, etc.). The intent is to manage the selection and maintenance of "alternative main groups" via a subfile-based workstation display. It offers standard subfile operations: display, creation, update, and delete records, mainly working with the files `SKPML1`, `SKPMLR`, `SKPMLU`, and `VAHGL1`.

Let's break the code down by sections and explain their purpose.

---

## File Declarations (`F-Specs`)

```rpg
fsp111d    cf   e             workstn sfile(b1sfl:w_srrn)
fskpml1    if   e           k disk    rename(skpmpfr:skpml1r)
fskpmlr    if   e           k disk    rename(skpmpfr:skpmlrr)
fskpmlu    uf a e           k disk    rename(skpmpfr:skpmlur)
fvahgl1    if   e           k disk    rename(vahgpfr:vahgl1r)
```

- `sp111d` is a workstation file (display file) utilizing a subfile (`B1SFL`) with record number `w_srrn`.
- Database files `SKPML1`, `SKPMLR`, `SKPMLU` use the physical file `SKPMPFR` with different record formats, for reading lookup/maintenance scenarios.
- `VAHGL1` is another lookup file, possibly for description or validation.

---

## Data Declarations (`D-Specs`)

You’ll see many variables and constants set up for:
- Subfile handling and record keys (`w_srrn`, `w_sfrn`, `w_ssrn`, etc.)
- Work variables for the “main group” type, code, value, firm number, text buffers, etc.
- Constants and buffer variables for attribute or key handling.
- Local Data Area (LDA) overlays for passing user/session information.

**Example:**
```rpg
d w_spge          s              4  0
d w_srrn          s              4  0
d c_sfil          s              2  0 inz(12)
...
d                uds
d dsuser                911    920
d dsfirm                944    946  0
d dsnavn                951    980
```

---

## Mainline Logic

### Entry Point (*INZSR)

**Initialization Subroutine - `*INZSR`**
- Sets up key lists for the files.
- Accepts program input parameters (such as type and description of the group) via a parameter list.
- Retrieves the firm/company number from LDA.
- Initializes subfile keys and variables.
- Positions database (`setll`) and loads the subfile (`crt_subfile`).

---

### Main Control Loop

- **Main Screen Write/Read:** Uses tags `b2taga`, `b2tagb` to display or refresh the subfile control screen and data.
- **Function Key Handling:** Includes navigation (`*INKC`, `*INKL` = Exit), refresh (`*INKE`), create (`*INKF`), page down (`*IN10`), "show info" (`*IN21`), and subfile control.
- **Positioning:** If the user enters a value to position the list (via a main group code), the `posisjoner` subroutine is invoked to position and re-populate the subfile accordingly.
- **Subfile Control Handling:** Depending on the action key pressed by the user, performs validation/create/update/delete using subroutines.

---

### Subroutines

#### Subfile Management

- **forny:** Re-positions and reloads the subfile
- **clr_subfile:** Clears out the subfile display and resets counters
- **crt_subfile:** Fills (or expands) the subfile buffer by reading the underlying file. Stops on reaching max page size, end-of-file, or mismatched firm/type/code.
- **dsp_subfile:** Handles the actual display of the subfile or fallback to the command screen if empty.

#### Position/Navigation

- **posisjoner:** Positions the file cursor to the main group value entered and reloads the subfile.

#### CRUD Operations via Panel Flow

- **control:** Handles the user's request for create (`b2valg = '1'`), delete (`b2valg = '4'`), or input validation on code.
- **subfile:** Handles subfile row-by-row processing (read, delete, refresh).
- **xc1bld:** Handles the "new record" screen (C1BLD), including check for pre-existing record, info messages, and calling registration logic (`xc2bld`).
- **xc1msg:** Shows a warning if the row to be created already exists.
- **xc2bld:** Processes create/update logic, including writing values to the update-format file. Checks if update or add is needed.
- **xd1win:** Handles the delete confirmation and logic for a record.

---

### Error and Message Handling

- Subroutines (`xc1msg`, error flags, `*INxx` indicators) are used for user feedback and controlling the flow if errors or duplicates are encountered.

---

## Other Notable Points

- **Indicators** like `*INxx` are used throughout for managing display attributes, exit keys, and error/status feedback.
- **KLIST/KFLD** are used for defining composite keys for file operations.
- **Parameter Passing:** The program is designed to receive parameters from a previous program, allowing for context-sensitive operation.
- **Work Variables:** There is a strong use of local variables to maintain subfile state, selected row, "screen real" numbers, etc.

---

## Overall

- **UI/UX:** This is a classic AS/400 subfile program for working with a list of "main group" records, allowing user interaction for create, read, update, and delete (CRUD).
- **Data Integrity:** All CRUD operations are validated, providing error messages or confirmation prompts as appropriate for business logic.
- **Encapsulation:** Logical flow is maintained by using a clear set of subroutines for each aspect of the UI and record handling.

---

## Summary Table of Main Subroutines

| Subroutine    | Purpose                                                  |
|---------------|----------------------------------------------------------|
| *INZSR        | Program startup and initialization                       |
| clr_subfile   | Clear subfile and counters                               |
| crt_subfile   | Fill subfile buffer with records                         |
| dsp_subfile   | Display subfile                                         |
| posisjoner    | Position and reload subfile at requested value           |
| forny         | Refresh subfile                                          |
| control       | Main control subroutine for create/delete/validate       |
| subfile       | Per-row input handling in subfile                        |
| xc1bld        | Handle new record screen (C1BLD)                         |
| xc2bld        | Create/update record logic                               |
| xd1win        | Handle delete confirmation and record deletion           |
| xc1msg        | Show duplicate/exists warning message                    |

---

## Conclusion

This program is a well-structured classic RPG subfile panel maintenance application, centered on alternative "main groups", with the usual IBM i practices (indicators, klist, etc.), and Norwegian comments throughout the code. The subroutine breakdown and structured flow make it easy to follow event-driven operations typical for green-screen data maintenance.