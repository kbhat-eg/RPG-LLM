# Documentation: RF109R â€“ Summering av bilag

## Overview

This program, `RF109R`, is part of the ASOKON system and is responsible for the **summarization of vouchers (bilag)**. Its main function is to process accounting entries, determine which entries should be summarized, perform the summarization, and output both individual and summary records to the appropriate output files. The program reflects significant domain logic regarding how vouchers from different sources and types are handled, particularly in the context of Norwegian accounting and reporting requirements.

## Business/Domain Context

- **Bilag**: Refers to vouchers or accounting entries.
- **Summarization**: Some vouchers, especially those from external systems, must be summarized according to specific business rules.
- **ALTINN Reporting**: As of 01.01.2017, new reporting requirements via ALTINN have changed how voucher summarization is handled.
- **Member Control**: The code contains logic to process records for specific members (likely organizational units or clients).

## Key Files and Data Structures

- **Input Files**:
  - `RJOUL3` (journal entries, input)
  - `RA01L1` (voucher code register)
  - `RZUML1` (summary records, input)
- **Output Files**:
  - `RZUMLU` (summary records, output)
  - `RJOULU` (journal entries, output)
- **Commented/Obsolete Files**:
  - `RAA4L1` and `RAA4LU` (voucher number tracking, now unused post-ALTINN)
- **Data Structures**:
  - `wssort`: Key structure for output records.
  - Various working fields for accumulating amounts, member/user information, etc.

## High-Level Flow

1. **Initialization**: Receives member/user parameters, sets up key lists for database access.
2. **Main Processing Loop**:
    - For each journal entry:
        - Checks if the entry is for the current member.
        - Identifies if the voucher code should be summarized by looking up `RA01L1`.
        - Applies business rules to determine if the entry should be summarized (e.g., only external system entries, not from "MULT" or "FLOW" users).
        - Handles voucher number assignment (logic now mostly inactive due to ALTINN changes).
        - Resets/accumulates summarization fields as needed.
        - Writes output records:
            - Non-summarized entries go directly to `RJOULU`.
            - Summarized entries are accumulated and written as summary records to `RZUMLU`.
        - Deletes processed input record.
3. **End-of-Group Processing**:
    - At group breaks (e.g., new voucher), writes any accumulated summary records.
    - Updates last used voucher numbers if applicable (now mostly commented out).
4. **Subroutines**:
    - `flytt_poster`: Moves all fields from input journal entry to output structure.
    - `flytt_summer`: Prepares a summary record for output, populating fields from accumulators.
    - `skriv_summer`: Writes a summary record to `RZUMLU`, ensuring unique key by incrementing a counter if necessary.
    - `*inzsr`: Initialization, parameter handling, and key list setup.

## Notable Business Logic & Design Decisions

### 1. Summarization Control

- **Voucher Code Register (`RA01L1`)**: Determines if a voucher code is eligible for summarization via the `raasum` field.
- **User/Source Filtering**: Only entries from external systems (where the posting user differs from the parameter user, and not from "MULT" or "FLOW") are summarized.
- **ALTINN Changes**: As of 01.01.2017, summarization for certain vouchers is disabled in compliance with new reporting rules. This is reflected by commented-out code and disabled logic for voucher number assignment and use of `RAA4L1`/`RAA4LU`.

### 2. Key Management

- **Complex Key Structures**: Output records use composite keys (firm, year, period, voucher number, etc.) to ensure uniqueness and correct grouping.
- **Summary Record Key**: For summary records (`RZUMLU`), a counter (`rztell`) is incremented in a loop to ensure uniqueness if a key collision occurs.

### 3. File Interactions

- **Prefixing and Renaming**: To avoid field name collisions and clarify source/target fields, file prefixes and field renaming are used extensively.
- **Input/Output Segregation**: Distinct files for reading (`RJOUL3`, `RZUML1`) and writing (`RJOULU`, `RZUMLU`).

### 4. Member Handling

- **Member Parameters**: The program is parameterized by member, allowing for batch processing for different organizational units or clients.
- **Member Filtering**: Only processes records for the specified member.

### 5. Audit and Traceability

- **Audit Fields**: Timestamps (`rjedat`, `rjetim`, etc.) and user fields are set for each output record for traceability.
- **Comprehensive Field Copying**: All relevant fields from the input are copied to the output, ensuring data integrity.

## Module Relationships

- **Voucher Code Register (`RA01L1`)**: Central for determining summarization eligibility.
- **Journal Entry Files (`RJOUL3`, `RJOULU`)**: Main transactional data flow.
- **Summary Files (`RZUML1`, `RZUMLU`)**: Store summary records for further processing or reporting.
- **Voucher Number Tracking (`RAA4L1`, `RAA4LU`)**: Now largely obsolete, but previously used for assigning new voucher numbers.

## Code Conventions & Patterns

- **Structured Comments**: Extensive use of structured comments and version history for maintainability.
- **Conditional Compilation/Versioning**: Code sections are marked for different releases and features (e.g., `6.30`, `6.31`), aiding in tracking changes over time.
- **Goto for Flow Control**: Used in key collision handling (e.g., `rzopdt` label) and for early exits.
- **Subroutine-Based Structure**: Key logic is encapsulated in named subroutines for clarity and modularity.

## Special Considerations

- **Legacy/Obsolete Logic**: Due to changes in reporting requirements (ALTINN), some logic is now commented out but retained for historical context.
- **Norwegian Language**: Many comments and variable names are in Norwegian, reflecting the business context and user base.

## Summary Table of Key Business Rules

| Condition                             | Action                                         |
|----------------------------------------|------------------------------------------------|
| Voucher code eligible for summarizing  | Entry may be summarized if from external user  |
| User is "MULT" or "FLOW"               | Never summarize                                |
| From internal user (lcwwus = wpuser)   | Never summarize                                |
| Summarization disabled post-2017 ALTINN| All summarization logic bypassed (see comments)|
| New voucher number needed              | Logic commented out, no longer assigned        |

## Maintenance Notes

- **Do not remove commented-out logic** unless you are certain the ALTINN reporting requirements will not change again.
- **When adding new voucher codes or changing summarization rules**, update both the `RA01L1` register and the relevant logic in this program.
- **When onboarding new members/clients**, ensure member parameters are correctly passed and that all associated master data is in place.

---

For further questions on business logic or integration with other modules, consult the system architect or the latest functional documentation.