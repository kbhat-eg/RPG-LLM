# RPG Program VP715R – Explanation

This program is written in ILE RPG (RPG IV), with a mixture of fixed-format (specifically, C-spec) code. It is a typical business program that looks up product prices for three possible sales units, supporting adjustment for price groups, supplier types, and warehouse/lager logic.

The code is heavily annotated with change history in Norwegian. Below is an explanation, structured for onboarding purposes.

---

## 1. **Purpose & Inputs/Outputs**

**Goal:**  
Given a company, product, price group, supplier type, and date, the program fetches up to three sales units for the product, retrieves both sales and shop prices for each unit, and calculates conversion factors (volume-based) relative to the first unit.

**Inputs (parameters):**
- Company (firma)
- Product number (vare)
- Price group (prisgr.)
- Warehouse (lager)
- Supplier type (lev.type)
- Date (dato)

**Outputs (parameters):**
- For each of three sales units:  
    - Sales unit code (enhet)  
    - Sales price (salgspris)  
    - Shop price (butikkpris)  
    - Conversion factor (omregningsfaktor) for units 2 and 3 vs. unit 1

---

## 2. **File Declarations (`F-spec`)**

```rpg
fvvprl1    if   e           k disk    rename(vvprpfr:vvprl1r)
fvvenl2    if   e           k disk    rename(vvenpfr:vvenl2r)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
```
- **vvprl1**: Product price register
- **vvenl2**: Product sales unit register
- **vvarl1**: Product master register

Each is accessed by key (random-access), renamed in the program for clarity or multi-use.

---

## 3. **Data Definitions (`D-spec`)**

- **Parameter variables**: Used for program parameters and returned values.
- **Key variables**: Used to build dynamic keys for access to files.
- **Other work variables**: Control logic, output conversion, etc.

Example:
```rpg
d p_firm          s                   like(vpfirm)
d p_vare          s                   like(vpvare)
...
d p_enh1          s                   like(vpenhe)
d p_sap1          s                   like(vpsapr)
...
d x               s              1  0
d b_pris          s              1    inz(*off)
```

---

## 4. **Program Initialization (`*inzsr`)**

**Purpose:** Sets up initial program state and output parameters.

- Populates variables from parameter list.
- Initializes keys for file access.
- Sets output parameters to blank/zero values.
- If date input is zero/low-value, set to current system date.

---

## 5. **Main Processing Section**

### 5.1 **Supplier Lookup**

- Calls an external program `'VL721R'` to determine the supplier for the product and warehouse, returning supplier code in `w_ldor`.

### 5.2 **Product Master Lookup**

- Sets `vvarl1_vare = p_vare`, does a chain (direct read) on product master file for more product details.

### 5.3 **Sales Unit Loop**

- Loops through up to three sales units (`x < 3`) read from the sales unit register.
- For each unit:
    - Tries to find a price in order of:
        1. Main supplier for the warehouse (`w_ldor`)
        2. Default/primary supplier (`vvldor`)
        3. Supplier code 0 (general)
    - Uses subroutine `hent_pris` to fetch sales and shop prices for the unit.

### 5.4 **Conversion Factors**

- After gathering prices and omregningsfaktor (`veomre`) from file for each unit, calculates conversion for units 2 and 3 vs. unit 1:
    - `p_omr2 = w_omr2 / w_omr1`
    - `p_omr3 = w_omr3 / w_omr1`

### 5.5 **Program End**

- Sets LR flag (`*inlr = *on`) to end the program.

---

## 6. **Subroutine: `hent_pris` (Fetch Price Information)**

**Purpose:**  
Finds price info for the current sales unit, searching in priority order with fallbacks.

- Tries to read price from register for the current combination of product, supplier, unit, price group, and supplier type.
- If not found for the given supplier type, retries for generic type 0.
- If not found for price group, retries with blank price group.
- Each time a price is not found, keeps trying next fallback until all avenues are exhausted.
- On finding a valid record, fills in:
    - Sales unit (`p_enhX`)
    - Sales price (`p_sapX`)
    - Shop price (`p_bupX`)
    - Conversion factor (`w_omrX`)
- Ensures only the most relevant (latest date <= input date) is used.
- Uses indicator variables (e.g., `*in91`) to control read loops.

---

## 7. **Subroutine: `*inzsr` (Initialization Routine)**

- Reads entry parameters.
- Sets up key lists for file access.
- Initializes all output parameters to blanks or zeros.
- Ensures the business date is valid (today, if not provided).

---

## 8. **Key Lists (`KLIST`)**

- Multiple named key lists for random access to files, e.g.:
    - `vvprl1_key`: For price register, includes company, product, supplier, price group, unit, and supplier type.
    - `vvenl2_key`: For sales units.
    - `vvarl1_key`: For product master.

---

## 9. **Noteworthy Coding Techniques**

- Uses fallback logic for price group and supplier type to maximize likelihood of returning a price.
- Collects up to three "levels" of sales unit/price information.
- Handles parameter passing and output via parameter list, suitable for being called from elsewhere (another program or CL).
- Uses subroutines (`begsr`/`endsr`).

---

## 10. **Typical Use Case Workflow**

1. Program called with company, product, etc.
2. Looks up possible suppliers and product info.
3. For up to three sales units:
    - Looks up the price, using fallback logic.
    - Records sales/shop price, and unit conversion info.
4. Normalizes conversion factor to the first unit.
5. Returns all found info through parameter list.

---

## 11. **Error Handling**

- If no prices are found for requested/alternate combinations, output values default to zero/blank.

---

## 12. **Change History / Norwegian Comments**

- The program was expanded across years (1999–2015), adapting for changes in price group logic, warehouse logic, and more.
- Comments in Norwegian explain every section and each historical enhancement.

---

## 13. **Summary Table of Key Variables**

| Variable     | Purpose                                      |
|--------------|----------------------------------------------|
| `p_firm`     | Input company code                           |
| `p_vare`     | Input product number                         |
| `p_prgr`     | Input price group                            |
| `p_lage`     | Input warehouse/lager                        |
| `w_ldor`     | Supplier for warehouse                       |
| `vvldor`     | Primary/default supplier                     |
| `p_lety`     | Supplier type                                |
| `p_dato`     | Date for price lookup                        |
| `p_enh1-3`   | Output sales unit code (1–3)                 |
| `p_sap1-3`   | Output sales price (1–3)                     |
| `p_bup1-3`   | Output shop price (1–3)                      |
| `p_omr2,3`   | Output conversion factor for unit 2, 3       |

---

# **Summary**

This program is a robust RPG utility for fetching product pricing information for up to three sales units, with comprehensive fallback logic to ensure data is returned if possible. It is modular, easily extended, and well-commented for maintainers, especially those familiar with Norwegian business terminology and AS/400 RPG programming conventions.