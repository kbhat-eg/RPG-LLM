# RPG Program LO570R - Code Explanation

This RPG (ILE) program is used to **search for purchase orders by supplier**. It utilizes display files with subfiles for presenting search results and provides multiple filter options. The code is well-documented, including version history and indicator usage. Below is a structured explanation suitable for onboarding developers.

---

## 1. **Header and Documentation**

- **`h option(*nodebugio) datedit(*dmy)`**  
  - Sets program options: disables debug I/O and sets date edit to DMY (day/month/year).
- Extensive comments document the program's name, description, version history (with notes per version), and the use of indicators.

---

## 2. **File and Display Declarations**

```rpg
flohelk    if   e           k disk    rename(lohepfr:lohelkr)
flodtlv    if   e           k disk    rename(lodtpfr:lodtlvr)
fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)

flo570d    cf   e             workstn sfile(b1sfl:w_srrn)
```
- Four physical files (likely purchase/order master, detail, item master, supplier master) are declared as input files (IF), renamed for local use.
- One display file (`LO570D`) is declared, with a subfile (`b1sfl`), using `w_srrn` as the relative record number.

---

## 3. **Parameter and Variable Definitions**

### Parameters (for called program interface)
```rpg
d p_firm          s                   like(lofirm)
d p_ldor          s                   like(loldor)
d p_numm          s                   like(lonumm)
d p_suff          s                   like(losuff)
d p_lag1-5        s                   like(lolage)
```
- Defines fields to receive parameters from the caller, including company, supplier, order number, suffix, and up to five warehouse numbers.

### Key Field Variables
```rpg
d lohelk_ldor     s                   like(loldor)
d lodtlv_vare     s                   like(ldvare)
d lodtlv_numm     s                   like(ldnumm)
...
```
- Used for database access/setll, chain, etc.

### Local Work Variables / Constants
```rpg
d w_stel          s              4  0   // Subfile counter
d c_sfil          s              2  0 inz(10) // Subfile page size
d lo              c                   'abcdefghijklmnopqrstuvwxyz...'
d up              c                   'ABCDEFGHIJKLMNOPQRSTUVWXYZ...'
...
```
- Subfile navigation, display logic, and filtering all use these.

---

## 4. **Indicator Usage (as per comments)**
- *LR*: End program
- *10*, *11*: Roll/rolldown
- *12*, *13*: Subfile display/CTL
- *14*, *15*: Clear/end subfile
- *22*: Cursor positioning
- 31-99: Warnings, working flags

---

## 5. **Main Logic Structure**

The program is organized in a **tag-driven loop** (mimicking a menu/interaction flow), using tags (labels) and `goto` for navigation.

### Main Processing Cycle
- **b2taga**: Write function key window (`b2cmd`)
- **b2tagb**: Display/update subfile; process function keys; handle subfile selection and logic; loop or exit.

### Function Key Handling
- *F3* (exit) and *F12*: Goto exit
- *F10*: Recreate subfile (calls `crt_subfile`)
- *F21*: Home key, set cursor indicator
- *F5*: Refresh (calls `forny`)
- *F6*: Show filter window (calls `xh1win`)

### Subfile Handling
- **subfile** subroutine: Loops through displayed subfile records, handles selection (set return parameters), or detail view (`b1valg = 5`—calls child program `LO505R`).

---

## 6. **Subroutines**

### `xh1win`: Filter Window Processing
- Presents/updates the search filter panel.
- Supports F4 lookups for order type, item, and buyer fields by calling other programs (`VA550R`, `VV500R`, `RA509R`).
- On filter confirm:  
  - Cleans up bestillingsnr (order number) field.
  - Looks up item description.
  - Updates parameter warehouse fields.

### `forny`: Refresh Subfile
- Optionally repositions on record.
- Rebuilds the subfile (clear and fill).

### `crt_subfile`: Create (Fill) Subfile
- Loops, reads orders for current supplier (from master file), applies filter (`sjk_filter`), and fills subfile with result rows.
- Fetches VAT rates via program call (`FÅ705R`).
- Fixes up data for display (item name cleaning—see `newlo_vask`).

### `clr_subfile`: Clear Subfile
- Sets indicators to clear subfile, resets subfile counters.

### `dsp_subfile`: Display the Subfile
- Handles display logic and subfile indicators, writes/reads subfile control screen.

### `sjk_filter`: Apply Filters to List
- Applies each filter from filter window (date, order number, order type, value intervals, buyer, item number, warehouse).
- Calls `sjk_vare` subroutine to verify item number in order lines when item filter is used.

### `sjk_vare`: Check if Item Exists in Order
- Performs keyed read on order detail file to check if a given item is present in the current order.

### `newlo_vask`: Clean Data for Newlook GUI
- Replaces periods and colons at the end of names, to avoid display errors with specific GUI tools.

---

## 7. **Initialization (`*inzsr`)**

- Receives call parameters.
- Sets up key-lists for file access.
- Sets initial values for warehouse filter fields.
- Positions database to starting point and creates initial subfile page.
- If possible, retrieves and displays supplier name on the UI.

---

## 8. **Notes on Special Features**

- **Multi-warehouse filter**: Enhances filtering via multiple warehouse numbers (handled in Version 7.04/8.01).
- **Adaptation for wider/new GUIs**: Several edits are for compatibility with GUI front-ends or to sanitize data for modern interfaces (see `newlo_vask`).
- **Extensible filter logic**: New fields can be added easily by extending `sjk_filter` and the filter window (`h1win`).
- **Display subfile navigation**: Supports cursor positioning, roll/rolldown, page navigation, and record selection following IBM i subfile conventions.

---

## 9. **High-Level Flow Overview**

1. **Initialization** (parameter receive, setup file keys, create subfile)
2. **Main interaction loop**:
    - Display subfile/page
    - Process function keys (filter, refresh, navigation, exit)
    - Let user select order: set return values and exit, or show detail
3. **Exit**: If nothing selected, return zeros for order and suffix.

---

## 10. **Practical Onboarding Tips**

- **Subfile handling** is central: see `crt_subfile`, `clr_subfile`, `dsp_subfile`.
- **Filtering** is handled in `sjk_filter`, called for each order read for the supplier.
- **Adding new filters**: Update filter window, add logic in `sjk_filter`, and include in parameter passing if needed.
- **Extending subfile fields or UI**: Update display DDS (`LO570D`), field loading in `crt_subfile`.
- **External program calls**: Used for lookups (order type, item, buyer) and VAT calculation.

---

## 11. **Common Norwegian Terms in Code**

- **bestilling**: order
- **leverandør**: supplier
- **lager**: warehouse
- **vare**: item
- **innkjøper**: buyer
- **moms**: VAT
- **navn**: name

---

## 12. **Final Notes**

The code reflects a standard interactive green-screen IBM i interface with heavy use of subfiles for navigation and selection. Modifications for multi-warehouse filtering and GUI adaptations are present. The program is modular, with much of the logic encapsulated in subroutines, making it maintainable and extensible for future enhancements.