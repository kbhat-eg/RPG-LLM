# RPG Program: LI302R — Start Packing Slip Document Printouts

This program is written in IBM ILE RPG (mainly fixed-format RPG IV). Its main responsibility is to initiate the process of generating/printing packing slip documents (`pakkseddel papirer`). It interacts with several database files and contains robust error handling and logging for traceability.

Below is a detailed explanation, broken into logical sections:

---

## 1. **Control Specifications and File Declarations**

```rpg
H DATEDIT(*DMY)
```
- Specifies the date format as *Day-Month-Year* for date fields.

### File Declarations

```rpg
fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
flstsl1    if   e           k disk    rename(lstspfr:lstsl1r)
fraa1l1    if   e           k disk    rename(raa1pfr:raa1l1r)
flpm1lu    uf a e           k disk    rename(lpm1pfr:lpm1lur)
```
- Declares four externally described files, each with their own format renamed for internal use.
- All are keyed disk files, except `lpm1lu` which is also *update* and *add* capable.

---

## 2. **Data Structures and Variables**

### Working Data Structures

```rpg
D DS
D  ldambr                 1     10
D  ldabok                 1      1
D  ldafir                 2      4  0
D  ldalst                 5     10  0

D uds
D  l_wsid               901    910
D  l_user               911    920
D  l_firm               944    946  0
```
- Defines data structures for holding parameters and user/job information. `uds` likely overlays a user data space for session/job values.

### Key and Working Fields

- Various fields for keys, periods, firm, order type, etc.
- Special variables for EDI logging and debug: `w_jnav`, `w_jkey`, `w_jtxt`, `w_jstat`, `w_jtext`, etc.
- `w_debg` is a debug flag, defaulted ON for verbose logging.

### Error Data Structure (PSDS)

```rpg
D PgmError       sds
D  proc_name        *proc
D  pgm_status       *STATUS
...
```
- The program status data structure (PSDS) provides runtime info for error handling: program/status codes, job info, line numbers, etc.

---

## 3. **Mainline Logic**

### Entry Point and Parameter Handling

```rpg
C     *entry        plist
C                   parm                    w_skor
C                   parm                    w_firm
C                   parm                    w_numm
C                   parm                    w_suff
C                   parm                    w_otyp
C                   parm                    w_dira
C                   parm                    w_outq
```
- The program is parameter-driven. It receives input about company, order type, order number, etc.
- On entry, if debugging is enabled, it logs the start of the process (EDI receiving and program start).

### Initialization (`*inzsr`)

- Resets local variables.
- Loads key values for later file access.
- Loads information from `LAGER-STATUS-KODE-REGISTER` (`lstsl1`) and assigns fields for output usage.
- Calls an external program (`L�900R`) to fetch the latest number for the file member.
- Calculates the current period if a record is found in `raa1l1`.

### Direct Print Decision

```rpg
C                   if        w_numm <> 0
C                   goto      f2taga
C                   endif
C                   eval      w_dirk = 0
```
- If a specific order number is passed, direct print is selected (skips interactive selection).

### Retrieve Order Type Data

```rpg
C     f2taga        tag
C                   eval      votyl1_otyp = w_otyp
C     votyl1_key    chain     votyl1
C                   if        vaoakk <> 2
C                   goto      xslutt
C                   endif
```
- Loads order type information.
- If order is not of packing slip type (`vaoakk <> 2`), program ends.

### Start Printing Preparation

```rpg
C     start         tag
C                   eval      w_valg = 0
C                   exsr      param
...
C                   if        w_numm <> 0
C                   goto      neste
C                   endif
C     VAOAKK        IFEQ      2
C                   GOTO      NESTE
C                   END
```
- Calls subroutine `param` to update/create selection parameters for printing.
- If an order number is specified, jumps to `neste` to actually start the print job.

### Call Next Program & Logging

```rpg
C     nestE         tag
C                   if        w_debg = *on
C                   eval      w_jstat = 10
C                   eval      w_jtext = 'EDI Pakkseddel-call-312C'
C                   call      'AB705R'
C                   parm                    w_jkey
C                   parm                    w_jstat
C                   parm                    w_jtext
C                   endif
C                   call      'LI302C'
C                   parm                    ldambr
```
- If debugging, logs the call to the actual print program.
- Calls CL program `LI302C`, passing the member info.

### Program End and Final Logging

```rpg
C     xslutt        tag
C                   if        w_debg = *on
C                   call      'AB710R'
C                   parm                    w_jkey
C                   endif
C                   eval      *inlr = *on
C                   return
```
- On exit, if debugging, logs the end.
- Releases resources and returns.

---

## 4. **Subroutines**

### Parameter Handling (`param`)

```rpg
C     param         begsr
C                   eval      lpm1lu_1lst = w_valg
C     lpm1lu_key    chain     lpm1lu 
...
C                   if        %found
C                   update    lpm1lur
C                   else
C                   eval      lk1fir = w_firm
C                   eval      lk1wsd = l_wsid
C                   eval      lk1usr = l_user
C                   eval      lk1lst = w_valg
C                   write     lpm1lur
C                   endif
C                   endsr
```
- Sets up the correct selection parameters for the print job.
- Updates existing parameter records, or creates if they don’t exist.

### Error Handling (`*pssr`)

```rpg
C     *pssr         begsr
C                   eval      w_errt = ...
C                   call      'AB705R'
C                   parm                    w_jkey
C                   parm                    w_jstat
C                   parm                    w_jtext
C                   endsr
```
- Constructs a human-readable error message from the PSDS.
- Logs the error with job/program context via `AB705R`.

---

## 5. **Key Lists**

```rpg
C     lstsl1_key    klist
C                   kfld                    w_firm
...
C     votyl1_key    klist
C                   kfld                    w_firm
C                   kfld                    votyl1_otyp
...
C     lpm1lu_key    klist
C                   kfld                    w_firm
C                   kfld                    lpm1lu_1wsd
C                   kfld                    lpm1lu_1usr
C                   kfld                    lpm1lu_1lst
...
C     raa1l1_key    klist
C                   kfld                    w_firm
```
- Key lists to be used with `chain` operations and file access.

---

## 6. **Logging**

- The program has extensive logging functionality. It logs:
  - EDI packing slip receipt.
  - Start of the print/export process.
  - Every call to other programs (such as `LI302C`, `AB705R`, `AB710R`).
  - Errors with details.
- Logging can be toggled by the `w_debg` flag.

---

## 7. **Comments and Documentation**

- The program is well-commented, with detailed headers, change logs, and section markers.
- Many variable and comment texts are in Norwegian.

---

## 8. **Summary/Flow**

1. **Initialize**: Load parameters and system/user information, set up keys.
2. **Direct Print?**: If order number is entered, skip selection.
3. **Validate Order Type**: Only proceed if it’s packing slip.
4. **Set Parameters**: Prepare or update print parameter records.
5. **Start Print**: Call CL program to generate/print the packing slips.
6. **Logging and Exit**: Write logs throughout, especially on error or program end.

---

## **Useful for Onboarding**

- **Where to start?** Look at the ENTRY parameters and how they're set in the calling program.
- **Files**: Understand the layout and purposes of `votyl1`, `lstsl1`, `raa1l1`, `lpm1lu`.
- **Error Handling**: All errors are logged in detail with job and program context.
- **Logging Calls**: Search for `call 'AB705R'`, `call 'AB700R'`, etc., for EDI/print event logging.
- **Adding Features**: You will likely add logic into the parameter setup or before/after calling the print CL.

---

**In short:**  
This program validates incoming requests, sets up environment and parameters for packing slip printing, initiates the process, and logs all key steps and errors for tracking/debugging. If you’re working with packing slip automation or EDI in this solution, this is a central module to understand.