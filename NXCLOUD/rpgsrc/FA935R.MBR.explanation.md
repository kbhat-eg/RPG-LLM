# RPG Program Overview and Explanation

This ILE RPG source code implements an automated process for credit evaluation of private individuals by integrating with Bisnode webservices. The program is documented as **FA935R**, running on system **ASOFAK**. Its primary function is to:

- Look up a person by national ID (personnummer).
- Retrieve an internal reference (`internref`) via webservice.
- Use that reference to fetch tax (ligning) and rating/score details.
- Calculate a credit limit (kreditgrense) based on this information.

Let's break down the key sections and logic of the program.

---

## 1. Control and Setup

- **H-specs** set up editing options, binding directories (`CGIDEV2`), and compile options (no default activation group, new activation group).
- **/copy statements** include header and binding source as well as prototypes.

---

## 2. Data Area and Variables

### **LDA (Local Data Area) Mapping**
- The `uds` block maps variables into a user data space for values like user, firm, and group info, used for context and parameterization.

### **Key Working Variables**
- `p_pnum`, `p_kgre`, `p_rati`: Main parameters (personnummer, credit limit, score/rating).
- XML variables: Used for paths and buffers when working with templates and responses.
- User authentication/lookup variables (e.g., `w_usrn`, `w_pass`, etc.).
- Variables for webservice communication (request/response file names).

### **Data Structures**
- `Personalia`: For incoming person data (from XML).
- `Score`: For rating/credit info (from XML).
- `Ligning`: For tax info (could be extended).

---

## 3. External Programs and Prototypes

- The program calls external programs, most significantly:
    - `CO402R`: For retrieving login credentials and other config values.
    - `AW703C`: For invoking the webservice using the request and response files.
    - `AS100R`: For getting/assigning a sequence number (`w_numm`).
- **CGIDEV2 API** is used for manipulating HTML/WS templates.

---

## 4. Main Logic

### **Initialization (`*inzsr` subroutine)**

- Receives parameters: personnummer, credit limit, rating.
- Assigns firm and personnummer from LDA.
- Calls `AS100R` to get a unique sequence number for the request.
- Retrieves login credentials from switch register via `CO402R`.
- Parses out the user id and password from the returned string, storing them in `w_usrk` and `w_pask`.

---

### **Webservice Request/Response Cycle**

#### **A. Person Lookup (PersonSok)**

1. **Build request files** for params, headers, and body using templates (filled via `UpdHTMLVar`/`WrtSection`).
2. **Save filled template files** to the appropriate paths.
3. **Call the webservice** via `AW703C`, providing URL, request, and response paths, plus auth info.
4. **Reads the response XML** and parses the `internref` field from `Personalia`.
5. **Clean up** by deleting intermediate files.

#### **B. Person Info (Score/Ratings)**

1. **Build request files** (params, headers, body) for the second webservice, as above.
2. **Fill in** the `internref` and other required fields.
3. **Call the webservice** using the new request/response files.
4. **Parse** the returned XML for rating (`Score` structure) and vital fields (`w_intr`, `w_besl`, `w_scor`, `w_grav`, `w_grgk`, `w_innt`).
5. **Clean up** by deleting intermediate files.

---

### **Credit Calculation**

- Decodes score (`w_scor`) to a numeric value (`w_scorn`).
- SQL SELECT retrieves score/limit pairs (`rkksc1`/`rkkgr1` ... `rkksc5`/`rkkgr5`) for `PRIVAT` from table `ra33st`.
- Compares score to thresholds and sets `p_kgre` (credit limit) to the maximum applicable value.

#### **SQL Example**
```rpg
select  rkksc1, rkkgr1, rkksc2, rkkgr2, rkksc3, rkkgr3,
        rkksc4, rkkgr4, rkksc5, rkkgr5
  into :w_ksc1, :w_kgr1, :w_ksc2, :w_kgr2, :w_ksc3, :w_kgr3,
       :w_ksc4, :w_kgr4, :w_ksc5, :w_kgr5
 from ra33st
 where rkktyp = 'PRIVAT';
```
- The code checks which score thresholds (if any) are met and assigns the corresponding credit limit.

---

## 5. Error Handling

- **PSSR subroutine** (program error handler): Sets output rating to "Feil" (error), credit limit to 0, and exits.

---

## 6. Program Termination

- Sets *INLR (last record indicator) to *ON and returns.

---

## 7. Subroutines

- **Error routine**
- **Initialization (`*inzsr`)**: Retrieves input parameters, assigns working values, fetches sequence number and login info, and parses out the credentials from the config string.

---

## 8. General Remarks

- The program makes heavy use of CGIDEV2 routines for templating, external program calls for system integration, and SQL for business rule lookup.
- Variables and comments are a mix of Norwegian and English. For example, `ligning` means "tax information," and `beslutning` is "decision".
- The webservice integration is file-based: templates are filled and written to disk, the external program performs the HTTP call, and the response is parsed back from disk.

---

## **Onboarding Summary**

- **To add or adapt logic:** Update templates or business rules in the DB table.
- **To handle new data:** Extend data structures or XML parsing variables.
- **To troubleshoot:** Start by looking at intermediate files, check for proper values in templated fields, and validate webservice responses.
- **For integration:** Webservices are accessed via HTTP requests using prepared files and responses parsed from disk.

---

## **Key File/Variable Naming**

- Templates: `/home/<figr>/Bisnode/Bisnode_mal/`
- Working files: `/home/<figr>/Bisnode/Bisnode_ws/`
- Output/response: Suffix `.txt`, `.txt.params`, `.txt.headers`
- The sequence number differentiates each transaction.

---

**In summary, this RPG program automates the process of querying Bisnode's webservice for a personâ€™s credit assessment by dynamically building request files, invoking webservices, parsing results, and computing a credit limit based on business rules from the database. Error handling and initialization (including credential lookup) are robust, and all data flows through well-named, parameterized files and variables.**