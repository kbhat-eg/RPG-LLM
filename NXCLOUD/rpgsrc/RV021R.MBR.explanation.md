```markdown
# RV001R Program Overview

RV001R is an IBM ILE RPG program that reads invoice‐line records from FOVFL1, looks up related header and customer data, and writes out comma-separated lines for downstream processing (e.g. import into Duett/Visma).

---

## 1. File Definitions (F-Specs)

- **FOVFL1 (input)**  
  Invoice‐line file, keyed, disk.
- **SOHEL1R, VOTYL1R, AFORL1R, RB10L1R, RKUNL1R, RB00L1R** (input)  
  Various lookup files (invoice headers, order types, routines, voucher‐code conversions, customer master, VAT code conversions).  
- **RV01PFR (output)**  
  Comma-separated output file.

---

## 2. Data Definitions (D-Specs)

1. **`l_firm`**  
   Company code read from the user data area.
2. **Date structures**  
   - `d_date`/`d_dati` for invoice date  
   - `d_fdat`/`d_fdati` for due date  
   They unpack a 6-position date into year, month, day or into a 10-position ISO string.
3. **Lookup keys & work fields**  
   - `w_firm, w_aarr, w_binr` – key fields for invoice header lookups  
   - `w_mkod, ww_mkod` – tax code and converted tax code  
   - `xxbilk` – possibly converted voucher‐type code  
   - Customer fields: `w_ladr1`, `w_ladr2`, `w_lposn`, `w_lposs` (delivery address), `wknavu` (customer name), etc.  
   - `t1kkid` – final KID number for output.  

---

## 3. Main Logic Flow

1. **Company Filter**  
   Skip processing if `l_firm` ≠ header field `fffirm`.
2. **Clear Working Fields**  
   Blank out date strings, address/name fields, KID buffers.
3. **Determine MVA (VAT) Code**  
   - If invoice header field `ffdmom` is blank, use `ffcmom`, otherwise use `ffdmom`.  
   - Optionally chain to `RB00L1R` to convert VAT code via a lookup (`w_type = 'MVAKODE'`).
4. **Date Conversion**  
   - Move raw date (`ffbdat`) → internal structure → `w_dato_al2` (`%char(udate)`).  
   - Similar conversion for invoice date and due date if needed.
5. **Invoice‐type Conversion** (Visma/Duett)  
   - Copy `ffbilk` to `xxbilk`, then chain on `RB10L1R` to override with a new code if found.
6. **Department & Amount**  
   - Read `rkponr` → `w_ponr`, add credit limit `rkgrns` → `w_grns`.
   - Choose invoice department from `ffcavd` or `ffdavd`.
7. **Lookup Header & Customer Data**  
   - Call subroutine `CONTROL_INIT` to position on the **last** invoice‐header record in SOHEL1R for this invoice, then:
     - If a delivery-customer code (`solkun`) exists, chain to RKUNL1R to fetch delivery address and split names if they contain commas.  
     - Chain again on `ffkund` (invoice customer) to fetch customer master, splitting names on commas.
     - Optionally fetch order‐type routine or invoke an external program to build the “KID” number.
8. **Assemble CSV Line**  
   Build `rvdata` by concatenating:  
   - Transaction type (`%char(1)`)  
   - Invoice number, dates, text, departments, accounts, amounts, KID (quoted), customer account no., invoice‐reference, currency info, due date, etc.  
   - Delivery and customer address details (quoted), phone, fax, email.  
9. **Write Output**  
   `WRITE RV01PFR` writes the composed `rvdata` record.

---

## 4. Subroutines

### CONTROL_INIT  
Sets up and retrieves all header & customer details for one invoice:
1. Build key (`w_firm + w_aarr + w_binr`) and position to the last record in SOHEL1R (invoice header).  
2. If a delivery-customer code exists:
   - Chain on RKUNL1R 
   - Extract delivery address fields (`rkgate`, `rkadr2`, `rkponr`, `rksted`).
   - Split the delivery name (`rknavn`) into first/last if there’s a comma.
3. Chain on RKUNL1R again for the invoicing customer (`ffkund`), similarly splitting name and alpha sort‐name (`rkalfa`).
4. Optionally look up an order type routine (VOTYL1R→AFORL1R) to determine which KID logic to apply, or call external program `AK710R`.

---

## 5. Change History (Comments)

A series of version notes (6.20 → 7.02) describe incremental enhancements:
- Switching project number to alpha  
- Handling commas in names  
- Skipping unmatched companies  
- VAT code conversion  
- New output format for Duett (with tel/mail)  
- Support for override VAT codes  

---

**Pedagogical Notes**

- This is **fixed‐format RPG** using **calculation specifications (C-specs)**.  
- Legacy date conversion uses EBCDIC “UDATE” and manual unpacking of YYMMDD → strings.  
- Chaining (`CHAIN`/`READE`) is used to position on keyed records.  
- CSV construction handles embedded quotes by enclosing text in `'"' + trim(field) + '"'`.  
- Extensive use of versioned comments (`6.21`, `7.02`, etc.) shows how the program evolved.  
- Subroutines (`BEGSR`/`ENDSR`) encapsulate initialization and lookups.

```