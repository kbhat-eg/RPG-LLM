# Explanation of RPG Program: FO783R

This RPG program (FO783R) is designed for IBM i (AS/400) systems. It interacts with customer and customer project data, performing validations, user interactions, and updating records via a called program. The program uses both display and physical files, as well as local data area (LDA) for session-specific data.

## 1. Header & Comments

- **`h option(*nodebugio) datedit(*dmy)`**: Compiler options; disables debug I/O, and sets default date edit format (day/month/year).
- **Comments**: The box at the top describes the program, authors, change log, and usage notes (in Norwegian).

---

## 2. File Declarations

```rpg
frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
fFO783d    cf   e             workstn
```
- **`frkunl1`**: Input file (likely customer master), with a renamed record format.
- **`ffkprl1`**: Input file (likely customer project master), with a renamed record format.
- **`fFO783d`**: Display file for interactive workstation user interface.

---

## 3. Data Definitions

### Local Data Area (LDA)
```rpg
d                uds
d l_firm                944    946  0
```
- **LDA**: Used for session data; `l_firm` pulls the company number from LDA positions 944–946.

### Key/Field Variables
```rpg
d rkunl1_kund     s                   like(rkkund)
d fkprl1_kund     s                   like(flkund)
d fkprl1_kpro     s                   like(flkpro)
```
- Defines variables for keys in customer and project files.

### Program Variables
```rpg
d b_feil          s              1    inz(*off)
d w_firm          s                   like(rkfirm)
d w_paar          s              4  0
d w_kund          s                   like(rkkund)
d w_kpro          s                   like(flkpro)
d w_knav          s                   like(rknavn)
d w_pnav          s                   like(flnavn)
6.31 d w_bdok      s              1  0
6.31 d w_cobu      s              1  0
```
- **b_feil**: Error indicator.
- **w_firm**: Company number (from LDA).
- **w_paar, w_kund, w_kpro**: Year, customer, and project fields.
- **w_knav, w_pnav**: Name fields for customer and project.
- **w_bdok, w_cobu**: Additional fields added in version 6.31 (Byggdok/Cobuilder flags).

---

## 4. Mainline Code

### Initial Tag (b1taga)
```rpg
c     b1taga        tag
c                   exfmt     b1bld
```
- **`b1taga`**: Main program loop tag.
- **`exfmt b1bld`**: Displays and receives input for screen format `b1bld`.

### Function Key Handling
```rpg
c                   select
c                   when      *inkc = *on or *inkl = *on
c                   goto      avslutt
c                   when      *inkd = *on
c                   exsr      spørring
c                   goto      b1taga
c                   endsl
```
- **F3 (Exit) / F12 (Cancel) pressed**: Go to exit routine.
- **F6 (Inquiry) pressed**: Run subroutine `spørring` (lookup), then loop to input screen.

### Input Field Validation
```rpg
c                   exsr      sjekk_input
c                   if        b_feil = *on
c                   eval      b_feil = *off
c                   goto      b1taga
c                   endif
```
- Calls `sjekk_input` to validate input fields. If errors found, resets error, and loops input.

### Call Update Program
```rpg
c                   move      b1paar        w_paar
c                   move      b1vkun        w_kund
c                   move      b1kpro        w_kpro
6.31 c                   move      b1bdok        w_bdok
6.31 c                   move      b1cobu        w_cobu

c                   call      'FO784R'
c                   parm                    w_paar
c                   parm                    w_kund
c                   parm                    w_kpro
6.31 c                   parm                    w_bdok
6.31 c                   parm                    w_cobu
```
- Transfers input fields into local variables.
- Calls another program (`FO784R`) passing relevant parameters (year, customer, project, additional flags if applicable).

### Reset Fields & Loop
```rpg
c                   eval      b1paar = 0
c                   eval      b1vkun = 0
c                   eval      b1kpro = 0
c                   goto      b1taga
```
- Clears screen input fields and loops to input.

---

## 5. Exit Routine

```rpg
c     avslutt       tag
c                   eval      *inlr = *on
c                   return
```
- Sets last record indicator (`*INLR`) to release resources.
- Exits program.

---

## 6. Subroutines

### Inquiry (`spørring`)
```rpg
c     spørring      begsr
* If field is 'B1VKUN', call RK500R for customer lookup.
* If field is 'B2KPRO', call FL500R for project lookup.
c     end_spørr     endsr
```
- **Purpose**: Handles F6-inquiry; depending on which field has focus, looks up and fetches data for customer or project.

### Input Validation (`sjekk_input`)
```rpg
c     sjekk_input   begsr
* Check if year, customer, or project fields are zero or missing.
* If so, sets error indicators (e.g., *IN31, *IN33, *IN35).
* Uses CHAIN to check if entered customer and project exist in their files.
c     end_sjekk     endsr
```
- **Purpose**: Ensures input values are valid and correspond to existing records.

### Initialization (`*inzsr`)
```rpg
c     *inzsr        begsr
* Defines key lists for CHAIN operations.
* Reads company from LDA.
c                   endsr
```
- **Purpose**: Prepares key lists and necessary variables at program start.

---

## 7. Key Lists

- **`rkunl1_key`**: For customer file lookup (company, customer).
- **`fkprl1_key`**: For project file lookup (company, customer, project).

---

## 8. Typical Program Flow

1. **Initialization**: Reads company from LDA.
2. **Main Loop**:
    - Displays input screen.
    - Handles function keys (Exit, Inquiry).
    - Validates input.
    - On valid input, calls update program with provided details.
    - Resets input fields, repeats.
3. **Exit**: On F3/F12, program ends.

---

## 9. Special Notes

- The program uses hardcoded screen field variables (`b1paar`, `b1vkun`, etc.), likely from display file `FO783d`.
- Error indicators *IN31, *IN33, *IN35 correspond to input fields (for display errors on the screen).
- Inquiry subroutine enables lookups/fill-in for customer and project fields.
- Versioning in the comments (`6.31`, `7.xx`), with notes on changes/additions (e.g., Byggdok/Cobuilder parameters).

---

## 10. Summary Table

| Area         | Purpose                                                                 |
|--------------|-------------------------------------------------------------------------|
| File Section | Connects to customer, project master, and display files.                |
| Data Section | Declares working fields, keys, error flags, and LDA access.             |
| Main Logic   | Shows input screen, manages function keys, validates input, calls update|
| Subroutines  | Inquiry (lookup), input validation, initialization.                     |

---

## 11. Key Takeaways for New Developers

- This is a screen-based RPG program for processing customer/project records.
- It validates data before updating, and allows lookups from the main screen.
- Most fields/structures are shared via data structure overlays or LIKE definitions.
- Nearly all logic is controlled via *IN indicators and subroutine calls.
- Further detail may be needed from the display (`FO783d`) and called programs (`FO784R`, `RK500R`, `FL500R`) for full understanding.

---

### Useful Norwegian terms

- **"kunde"** = customer
- **"kundeprosjekt"** = customer project
- **"Byggdok" / "Cobuilder"** = construction document/collaborator concepts

---

**This program is a template for controlled batch or online processing of customer/project data with strong validation and user feedback.**