      /TITLE  ASOKON Utskrift av kvitteringsliste - Legger ut regn.post
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * System  . . . . : ASOKON                                        *
      * Program . . . . : GL115R                                        *
      * Beskrivelse . . : Utskrift av kvitteringsliste.                 *
      *                   + Legger ut regnskapstransaksjon.             *
      *                                                                 *
      *                   Parameterfeltet WPREGN (i PLIST) er           *
      *                   utfylt med 'JA' dersom det finnes             *
      *                   poster som skal legges ut til regnskap.       *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      * Spesialversjon. :                                               *
      * Tilpasset for . :                                               *
      *                                                                 *
      * Referanse  Dato   Endringsbeskrivelse                      Sign.*
      * --------- ------  ----------------------------------------------*
      *           010195  Nytt program januar-1995                 RH   *
      *                                                                 *
      * 07059     070599  Legger ut valutakode/beløp på RTRAPF.    RH   *
      *                                                                 *
      * 19059     190599  Legger ut LEVERANDØRSPESIFIKASJON i      RH   *
      *                   feltet AVDELING på RTRAPF ved bank-           *
      *                   omkostninger (v/valutaposter).                *
      *                                                                 *
      * 26059     260599  Periode-ÅR ble feilberegnet til ÅR 98    RH   *
      *                   ved forfalssdato på post i ÅR 00 (2000).      *
      *                                                                 *
      * 27059     270599  Legger ut LEVERANDØRSPESIFIKASJON i      RH   *
      *                   feltet AVDELING..-> det manglet fortsatt      *
      *                   noe etter endringen 19/5-99....               *
      *                                                                 *
      * 02069     020699  Summerer VALUTABELØP ut på RTRAPF.       RH   *
      *                                                                 *
      * 16069     160699  Avrundingsfeil ved beregning av kontant- RH   *
      *                   rabatt valuta.                                *
      *                                                                 *
      * 18069     180699  Splitter ut KONTANTRABATT som egen       RH   *
      *                   postering.                                    *
      *                                                                 *
      * 25069     250699  Avdeling (Kategori fra leverandør) er    RH   *
      *                   en spesialtilpasning for BERGSLI A/S.         *
      *                                                                 *
      * 25069     250699  Legger inn avdeling (Kategori fra lev)   RH   *
      *                   på Kontantrabatt posten. NB! Dette er         *
      *                                                                 *
      * 29069     290699  Legger ut "T" i RTBLDE dersom valuta-    RH   *
      *                   transaksjon.  Koden blir i regnskap brukt     *
      *                   til agio/disagio beregningen.                 *
      *                                                                 *
      * 22109     221099  Kaller opp GL125R for sletting av ut-    RH   *
      *                   betalingsforslaget, ved mottak av 1.          *
      *                   gangsretur lønn.                              *
      *                                                                 *
      * 03010     030100  Feil i bergning av "et år tilbake".      RH   *
      *                                                                 *
      * 09020     090200  Avrundingsfeil ved beregning av kontant- RH   *
      *                   rabatt valuta.                                *
      *                                                                 *
      * 22030     220300  Lagt inn behandling av EURO -> EUR       RH   *
      *                                                                 *
      * 23080     230800  JPY er endret fra 1 til 100 i tabellen   RH   *
      *                   i slutten av programmet.                 RH   *
      *                                                                 *
      * 05041     050401  Valutakurs for EURO skal ha forholdstall RH   *
      *                   "1", og ikke "100".                           *
      *                                                                 *
      * 12071     120701  Tar kopi av utbet.forslag før det slettes:    *
T400  * V4.00     170402  Endret bibl. for copymember.                    HFL *
T5.00 * V5.00     131002  Endring i datofelt og key-felt.          HFL  *
T5.00 *                   Ikke lenger key i GUBFPF, bruker L8.     HFL  *
T5.00 *                   Ikke lenger key i RLTRPF, bruker LU.     HFL  *
T5.00 *                   Ikke lenger key i RAA4PF, bruker LU.     HFL  *
S5.01 * V5.01     130203  GAPGIR/GKPGIR sperret ut                 AMD  *
      *                                                                 *
S5.01 * V5.02     111103  Viser forslags- og linjenummer på liste. RHO  *
      *                                                                 *
      * 05014     050104  Legger ut riktig verdier i feltene:      RHO  *
      *                   RSRPER - RSRAAR - RTRPER - RTRAAR.       RHO  *
      *                   Årstallfeltene er nye.  Periode er red.  RHO  *
      *                   fra 4,0 til 2,0 pga at årstall er tatt   RHO  *
      *                   vekk.                                    RHO  *
      *                                                                 *
T5.30 * V5.30     010205  Lev.kategori endret fra 2 til 4 pos.     HFL  *
T5.50 * V5.50     221007  Periode kunne bli feil ved årsskiftet.   HFL  *
 5.61 * V5.61     210709  Endret sumfelt fra 10.2 til 11.2         KOB  *
pdf   * R6.10     120710  Innført PDF utskrift. Innebærer primært åBSA  *
pdf   *                   finne spoolid. Kall av AP620R med dette       *
pdf   *                   som parametre.                                *
6.11  * R6.10 071010 BSA  Overfører bacthtype som en del parameterlista. Viser
6.11  *                   hva slags rutine som kjøres. Legges med i arkivet.
6.12  * R6.10 270511 BSA  Problemer med å sende info om to like spoolfiler
6.13  * R6.10 031111 BSA  Fortsetter rettelse 6.12
6.14  * R6.10 030212 BSA  skal ikke lage xml hvis det ikke er skrevet til
6.14  *                   printerfilen.
6.15  * R6.20 080313 NHO  Legger ikke ut kategori fra kunde dersom bet. *
6.15  *                   men felt rada20 fra fil RA04PF
6.16  * R6.20 260313 bsa  Åpner PF til slutt for at det er den som returneres
6.20  * R6.20 020713 BSA  Endret logikk rundt arkivering
6.21  * R6.20 020713 BSA  Bygger opp tekst til displaytekst i arkivet.
6.nu  * R6.30 210515 NHO  Resultatfelt mot nummerserie var 6 0
6.30  * R6.30 161019 sst  Fors¦k p} felles bilagsnr p} en innb innlesn.
6.31  * R6.30 291019 sst  en post/bilagsnr p} lev./bank pr betaling
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *                                                                 *
      *  BRUK AV INDIKATORER                                            *
      *                                                                 *
      *       KC = F3  = Exit                                           *
      *       KL = F12 = Annuller                                       *
      *                                                                 *
      *       LR = Avslutt program                                      *
      *       31 = *OFF => 1. gangs retur - innland                     *
      *       31 = *ON  => 2. gangs retur - innland                     *
      *    60-69 = Fileindikatorer chain etc.                           *
      *                                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     fgl115d    o    e             workstn
     fraa3l1    if   e           k disk    rename(raa3pfr:raa3l1r)
     fgulfpf    if   e           k disk    rename(gulfpfr:gulfpfr)
     fgul1l1    if   e           k disk    rename(gul1pfr:gul1l1r)
     fgul2l1    if   e           k disk    rename(gul2pfr:gul2l2r)
     fgur1pf    if   e           k disk    rename(gur1pfr:gur1pfrf)
     fgur1l1    if   e           k disk    rename(gur1pfr:gur1pfr1)
     fgur1l2    if   e           k disk    rename(gur1pfr:gur1pfr2)
     fgur1l3    if   e           k disk    rename(gur1pfr:gur1pfr3)
     fgur2pf    if   e           k disk    rename(gur2pfr:gur2pfrf)
     fgur2l1    if   e           k disk    rename(gur2pfr:gur2pfr1)
     fgur2l2    if   e           k disk    rename(gur2pfr:gur2pfr2)
     fgurfpf    if   e           k disk    rename(gurfpfr:gurfpfr)
     frlevl1    if   e           k disk    rename(rlevpfr:rlevl1r)
     frltrlu    uf   e           k disk    rename(rltrpfr:rltrlur)
12071fgkbfpf    o  a e           k disk    rename(gkbfpfr:gkbfpfr)
     fgubflu    uf   e           k disk    rename(gabfpfr:gabfpfu)
     fgubfl8    if   e           k disk    rename(gabfpfr:gabfpff)
      *
     fraa4lu    uf a e           k disk    rename(raa4pfr:raa4lur)
     frbunl1    if   e           k disk    rename(rbunpfr:rbunpf1)
     frbunlu    uf a e           k disk    rename(rbunpfr:rbunpfu)
     frtrapf    o  a e           k disk
      *
     fra04l1    if   e           k disk    rename(ra04pfr:ra04l1f)
     fra16l1    if   e           k disk    rename(ra16pfr:ra16l1f)
      *
     fgl115pl   o    e             printer
pdf  f                                     usropn
6.13 fgl115pf   o    e             printer
6.13 f                                     usropn
      *
      /eject
     d per             s              6  0 dim(20)
     d bun             s              5  0 dim(20)
     d deb             s             11  2 dim(20)
     d kre             s             11  2 dim(20)
     d ape             s              4  0 dim(12)
      *
     d m               s             66    dim(100) ctdata perrcd(1)
     d vk              s              3    dim(30) ctdata perrcd(1)
     d vf              s              3    dim(30) ctdata perrcd(1)
      *
6.11 d p_btyp          s            100
6.12 d b_lst1          s              1    inz(*off)
6.12 d b_lst2          s              1    inz(*off)
6.20 d w_year          s              4  0
6.21 d w_dspl          s             30
      *
      * Forfallsdato på format ÅÅÅÅMMDD:
      *
     d                 ds
     d dsfor1                         8  0
     d  dsfÅr1                        4  0 overlay(dsfor1)
     d  dsfmn1                        2  0 overlay(dsfor1:5)
     d  dsfda1                        2  0 overlay(dsfor1:7)
      *
      * Periode til bruk for å slå opp i tabell:
      *
     d                 ds
     d dstabb                         6  0
     d  dsperÅ                        4  0 overlay(dstabb)
     d  dsperm                        2  0 overlay(dstabb:5)
      *
      * Forfallsdato på format DDMMÅÅÅÅ:
      *
     d                 ds
     d dsfor2                         8  0
     d  dsfda2                        2  0 overlay(dsfor2)
     d  dsfmn2                        2  0 overlay(dsfor2:3)
     d  dsfÅr2                        4  0 overlay(dsfor2:5)
      *
      * Forfallsdato på format DDMMÅÅ:
      *
     d                 ds
     d dsfor3                         6  0
     d  dsfda3                        2  0 overlay(dsfor3)
     d  dsfmn3                        2  0 overlay(dsfor3:3)
     d  dsfÅr3                        2  0 overlay(dsfor3:5)
      *
      * Datastruktur for regnskapsperiode:
      *
     d                 ds
     d dsperi                         6
     d  dspemÅ                        2  0 overlay(dsperi)
     d  dspeÅr                        4  0 overlay(dsperi:3)
      *
      * Datastruktur for konvertering av referansenummer
      * i fra alfa til numerisk:
      *
     d                 ds
     d dsrfal                         5
     d  dsrfnu                        5  0 overlay(dsrfal)
      *
      * Datastruktur som brukes i test på om bilaget skal
      * posteres på foregående år:
      *
     d                 ds
     d dspÅr1                         4  0
     d  dspÅr2                        2  0 overlay(dspÅr1)
     d  dspÅr3                        2  0 overlay(dspÅr1:3)
      *
      * Datastruktur for bankreferanse:
      *
     d                 ds
     d dsbref                        12
     d  dsbrf1                        4    overlay(dsbref)
     d  dsbrf2                        8    overlay(dsbref:5)
      *  Faste konti - koderegister
S5.00d*COPY ASOKON401/QCPYSRC,RA04PFDS
S5.00 *  Valutakoder - koderegister
     d*COPY ASOKON401/QCPYSRC,RA16PFDS
      *
      * Henter firmanavn.
      *
     d                uds
pdf  d l_poff                584    584
pdf  d l_bach                595    635
pdf  d l_skje                637    637  0
     d l_user                911    920
     d dsfirm                944    946  0
     d dsfnav                951    980
      *
610  d rbunlu_nivo     s                   like(rsnivo)
610  d rbunlu_memb     s                   like(rsmemb)
610  d w_mem1          s                   like(rsmemb)
610  d w_mem2          s                   like(rsmemb)
     d i               s              3  0
     d k               s              2  0
     d w_arow          s              2  0
     d w_acol          s              3  0
     d wfØrst          s              1
6.nu d*wpbiln          s              6  0
6.nu d wpbiln          s              8  0
     d wpbref          s             12
     d wpbunt          s                   like(rsbunt)
     d wpfor1          s              8  0
     d wpfor2          s              8  0
E5.30d wpkatg          s              4  0
     d wpkavd          s                   like(rapavd)
     d wpkkto          s                   like(rtckto)
     d wpksps          s                   like(rapsps)
     d wplev1          s              6  0
     d wplinj          s              5  0
     d wplonn          s              1
     d wpnfor          s              8  0
     d wpnlev          s              6  0
     d wpnlon          s              6  0
     d wpnul6          s              6  0
     d wpnval          s              3
     d wpokbu          s              1
     d wpokno          s             12  8
     d wppavd          s                   like(rapavd)
     d wpperi          s              6
     d wppkto          s                   like(rapkto)
     d wpprol          s             10  2
     d wppsps          s                   like(rapsps)
     d wprabb          s             10  2
     d wprabf          s             10  2
     d wpregn          s              2
6.nu d*wprfnr          s              6  0
6.nu d wprfnr          s              8  0
5.61 d wpsumf          s             11  2
5.61 d wpsuml          s             11  2
5.61 d wpsumv          s             11  2
5.61 d wpsuno          s             11  2
5.61 d wpsuvk          s             11  2
     d wptbel          s             15  2
     d wptfir          s              3
     d wptubf          s              3
     d wpvalb          s             11  2
     d wpvalk          s              3
     d wpyear          s              2  0
     d wtraar          s              2  0
     d x               s              2  0
T5.50d w_per           s              2  0
6.30 d w_sbiln         s                   like(rtbiln)
      *
     d ra04l1_firm     s                   like(radfir)
     d ra16l1_firm     s                   like(rapfir)
     d ra16l1_pkod     s                   like(rapkod)
pdf   *
pdf  d splfname2       s             10a
pdf  d jobname2        s             10a
pdf  d username2       s             10a
pdf  d jobnbr2         s              6a
pdf  d splfnbr2        s             10i 0
pdf  d splfname3       s             10a
pdf  d jobname3        s             10a
pdf  d username3       s             10a
pdf  d jobnbr3         s              6a
pdf  d splfnbr3        s             10i 0
6.20 d p_tagg0         s             20
6.20 d p_tagg0val      s             50
6.20 d p_tagg1         s             20
6.20 d p_tagg1val      s             50
6.20 d p_tagg2         s             20
6.20 d p_tagg2val      s             50
6.20 d p_tagg3         s             20
6.20 d p_tagg3val      s             50
6.20 d p_tagg4         s             20
6.20 d p_tagg4val      s             50
6.20 d p_tagg5         s             20
6.20 d p_tagg5val      s             50
6.20 d p_tagg6         s             20
6.20 d p_tagg6val      s             50
6.20 d p_tagg7         s             20
6.20 d p_tagg7val      s             50
6.20 d p_tagg8         s             20
6.20 d p_tagg8val      s             50
6.20 d p_tagg9         s             20
6.20 d p_tagg9val      s             50
6.20 d p_refn          s             50
6.20 d p_dspl          s            100
      *
pdf  d qsprilsp        pr                  extpgm('QSPRILSP')
pdf  d rcvvar                     32767a   options(*varsize)
pdf  d rcvvarlen                     10i 0 const
pdf  d format                         8a   const
pdf  d errorcode                  32767a   options(*varsize)
pdf   *
pdf  d sprl0100        ds
pdf  d  bytesrtn                     10i 0
pdf  d  bytesavl                     10i 0
pdf  d  splfname                     10a
pdf  d  jobname                      10a
pdf  d  username                     10a
pdf  d  jobnbr                        6a
pdf  d  splfnbr                      10i 0
pdf  d  systemname                    8a
pdf  d  createdate                    7a
pdf  d                                1a
pdf  d  createtime                    6a
pdf   *
pdf  d errorcode       ds
pdf  d  bytesprov                    10i 0 inz(0)
pdf  d  byteavail                    10i 0 inz(0)
      *
      /eject
      *
      * LØNN:
      *
      * Skriver kvitteringliste ved feilretur:
      *
     c                   exsr      xfeill
      *
      * Skriver kvitteringliste ved 1.gangs retur:
      *
     c                   exsr      x1grel
      *
      * Skriver kvitteringliste ved 2.gangs retur:
      *
     c                   exsr      x2grel
pdf   *
pdf   * Generer xml for videre utskrift
pdf   *
pdf  c                   if        l_poff = '1'
6.12 c                   if        b_lst2 = *on
pdf  c                   exsr      spoolnbr2
pdf  c**                 exsr      xml_create
6.12 c                   endif
pdf  c                   close     gl115pl
pdf  c                   if        1=2
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf  c                   endif
      *
      * FAKTURAER:
      *
      * Skriver kvitteringliste ved feilretur:
      *
     c                   exsr      xfeilr
      *
      * Skriver kvitteringliste 1. gangs retur - Innland:
      *
     c                   exsr      x1grin
      *
      * Skriver kvitteringliste 1. gangs retur - Utland:
      *
     c                   exsr      x1grut
      *
      * Skriver kvitteringliste 2. gangs retur - Innland:
      *
     c                   exsr      x2grin
      *
      * Skriver kvitteringliste 2. gangs retur - Utland:
      *
     c                   exsr      x2grut
      *
      * Legger ut regnskapstransaksjon:
      *
     c                   exsr      xregns
pdf   *
pdf   * Generer xml for videre utskrift
pdf   *
pdf  c                   if        l_poff = '1'
6.13 c                   if        b_lst1 = *on
pdf  c                   exsr      spoolnbr
6.12 c                   endif
pdf  c                   close     gl115pf
pdf  c                   if        1=2
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf   * Avslutt jobbiden
6.14 c                   if        b_lst1 = *on
pdf  c                   exsr      xml_create
6.14 c                   endif
pdf  c                   call      'AB710R'
pdf  c                   parm                    l_bach
pdf  c                   endif
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Avslutt program                                                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xslutt        tag
      *
      * Ventemelding sendes ved opprydding av forslagfile og
      * tømming av returfiler:
      *
     c                   eval      w_arow = 8
     c                   eval      w_acol = 31
RHO  c                   write     s1win
     c                   write     c8win
      *
      * Oppdaterer buntfile dersom det er lagt ut poster til
      * regnskap.  Parameterfeltet WPREGN er utfylt med "JA"
      * dersom dette er tilfelle:
      *
     c                   if        wpregn = 'JA'
      *                                                              .
     c                   eval      k = 1
     c     k             do        20            k
     c                   if        per(k) <> 0
610  c                   eval      rbunlu_nivo = *blank
610  c                   eval      rbunlu_memb = w_mem2
     c                   eval      wpbunt = bun(k)
     c     key10         chain     rbunpfu                            61
      *                                                          . . .
     c                   if        *in61 = *off
      *                                                        . . . .
      * Tabellen APE har info om ev. avviende perioder.        . . . .
      * (PER=ååååmm , APE=mmåå)                                . . . .
      *                                                        . . . .
     c                   move      per(k)        x
05014c** F Ø R           move      ape(x)        rsrper
      *                                                        . . . .
05014c                   movel     per(k)        rsraar
05014c                   move      per(k)        rsrper
      *                                                        . . . .
      * Dersom post har posteringsår eldre enn inneværende     . . . .
      * år, så legges det ut inneværende år minus 1.           . . . .
      *                                                        . . . .
26059 * Tester samtidig på at årstall på post ikke er ÅR2000!  . . . .
      *                                                        . . . .
     c                   movel     per(k)        dspÅr1
T5.50c                   move      per(k)        w_per
      *                                                        . . . .
      * Ny test i forbindelse med ÅR2000:                      . . . .
      *                                                        . . . .
03010c                   if        uyear = 00
03010c                             and dspÅr3 = 99
03010c                   move      wpyear        rsrper
03010c                   endif
      *                                                        . . . .
     c                   if        dspÅr3 < uyear
26059c                             and dspÅr3 <> 0
05014c                   movel     20            rsraar
05014c                   move      wpyear        rsraar
05014c***  F Ø R         move      wpyear        rsrper
S5.50c*                  move      dsfmn3        rsrper
T5.50c                   move      w_per         rsrper
     c                   endif
      *                                                        . . . .
     c                   move      deb(k)        rspdeb
     c                   move      kre(k)        rspkre
     c                   eval      rsbsum = rspdeb
610  c                   time                    rsedat
610  c                   time                    rsetim
610  c                   eval      rseusr = l_user
     c                   update    rbunpfu
     c                   else
     c                   unlock    gubflu
     c                   endif
     c                   endif
     c                   enddo
     c                   endif
      *
      * Rydder opp i forslagsfile:
      *
     c                   exsr      xrydde
      *
      * Tømmer returfiler:
      *
      * Dersom det er mottatt 1.gangsretur på lønn, så skal
      * "lønnsfile" slettes i tillegg til å tømme de andre
      * returfilene:
      *
     c                   call      'GL116C'
     c                   parm                    wplonn
      *
     c                   eval      *inlr = *on
     c                   return
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 1. Gangs Retur - Lønn:                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x1grel        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      g1suma = 0
      *
      * *IN31=*OFF ==> 1. gangs retur.
      *
     c                   move      *off          *in31
22109 *
22109 * Initierer hjelpefelt til bruk for å fjerne alle poster i fra
22109 * utbetalingsforslagsfile GUBFPF ved 2.gangsretur lønn:
22109 *
22109c                   move      'J'           wfØrst
      *
      * Skriver kvitteringliste 1. gangs retur:
      *
     c     key01         setll     gul1l1
     c     key01         reade     gul1l1                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   write     g1hdr
6.21 c                   if        *in31 = *off
6.21 c                   eval      w_dspl = 'Kvitteringsliste 1.gangs retur'
6.21 c                   endif
6.12 c                   eval      b_lst2 = *on
      *                                                      .
      * Oppdaterer hjelpefelt for å indikere at det er       .
      * mottatt 1.gangs retur på lønn.  Feltet blir senere   .
      * (GL116C) brukt til å slette "lønnsfile":             .
     c                   move      '1'           wplonn
      *                                                      .
     c                   endif
      *
     c                   dow       *in60 = *off
22109 *                                                              .
22109 * Sletter forslag i fra Utbetalingsforslag:                    .
22109 *                                                              .
22109c                   if        wfØrst = 'J'
22109c                   movel     gdsfir        wptfir
22109c                   movel     gdsubf        wptubf
22109 *                                                      .       .
22109c                   call      'GL125R'
22109c                   parm                    wptfir
22109c                   parm                    wptubf
22109 *                                                      .       .
22109c                   move      'N'           wfØrst
22109c                   endif
      *                                                              .
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Lønnsnummer:                                                 .
     c                   eval      g1slon = gdslon
      * Navn:                                                        .
     c                   eval      g1savn = *blanks
     c                   movel     gdsnav        g1savn
      * Bankreferansenummer:                                         .
     c                   movel     gdsref        g1sref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdsfor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      g1sfor = dsfor2
     c                   eval      g1dato = dsfor2
      * Forslagsnummer:                                              .
     c                   eval      g1subf = gdsubf
      * Beløp:                                                       .
     c                   eval      g1sbel = gdsbel
      * Adderer totalsummer:                                         .
     c                   eval      g1suma = g1suma + gdsbel
      * Til kontonummer:                                             .
     c                   eval      g1stki = gdstki
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     g1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     g1hdr
6.12 c                   eval      b_lst2 = *on
     c                   endif
      *                                                              .
     c     key01         reade     gul1l1                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     g1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     g1hdr
6.12 c                   eval      b_lst2 = *on
     c                   endif
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 2. Gangs Retur - Lønn:                                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x2grel        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      g1suma = 0
      *
      * *IN31=*ON ==> 2. gangs retur.
      *
     c                   move      *on           *in31
      *
      * Initierer hjelpefelt til bruk for å fjerne alle poster i fra
      * utbetalingsforslagsfile GUBFPF ved 2.gangsretur lønn:
      *
     c                   move      'J'           wfØrst
      * Skriver kvitteringliste 1. gangs retur:
      *
     c     key01         setll     gul2l1
     c     key01         reade     gul2l1                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   write     g1hdr
6.21 c                   if        *in31 = *on
6.21 c                   eval      w_dspl = 'Kvitteringsliste 2.gangs retur'
6.21 c                   endif
6.12 c                   eval      b_lst2 = *on
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Sletter forslag i fra Utbetalingsforslag:                    .
      *                                                              .
     c                   move      'J'           wfØrst
     c                   if        wfØrst = 'J'
     c                   movel     gdtfir        wptfir
     c                   movel     gdtubf        wptubf
      *                                                      .       .
     c                   call      'GL125R'
     c                   parm                    wptfir
     c                   parm                    wptubf
      *                                                      .       .
     c                   move      'N'           wfØrst
     c                   endif
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Lønnsnummer:                                                 .
     c                   eval      g1slon = gdtlon
      * Navn:                                                        .
     c                   eval      g1savn = *blanks
     c                   movel     gdtnav        g1savn
      * Bankreferansenummer:                                         .
     c                   movel     gdtref        g1sref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdtfor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      g1sfor = dsfor2
     c                   eval      g1dato = dsfor2
      * Forslagsnummer:                                              .
     c                   eval      g1subf = gdtubf
      * Beløp:                                                       .
     c                   eval      g1sbel = gdtbel
      * Adderer totalsummer:                                         .
     c                   eval      g1suma = g1suma + gdtbel
      * Til kontonummer:                                             .
     c                   eval      g1stki = gdttki
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     g1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     g1hdr
6.12 c                   eval      b_lst2 = *on
     c                   endif
      *                                                              .
     c     key01         reade     gul2l1                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     g1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     g1hdr
6.12 c                   eval      b_lst2 = *on
     c                   endif
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Feilretur - Lønn:                                               *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xfeill        begsr
      *
      * Leser file:
      *
     c     key01         setll     gulfpf
     c     key01         reade     gulfpf                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   write     h1hdr
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Legger over data, og skriver ut post:                        .
      *                                                              .
     c                   eval      h1pret = gdvret
     c                   movel     gdvtrk        h1ptrk
      * Leverandør:                                                  .
     c                   eval      h1plon = gdvlon
      * Leverandør:                                                  .
     c                   eval      h1navn = *blanks
     c                   movel     gdvnav        h1navn
      * Hent feilmelding:                                            .
     c                   eval      i = gdvret + 1
     c                   movel     m(i)          h1mtxt
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     h1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     h1hdr
     c                   endif
      *                                                              .
     c     key01         reade     gulfpf                                 60
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 1. Gangs Retur - Innland                                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x1grin        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      t1suma = 0
     c                   eval      t1sumb = 0
      *
      * *IN31=*OFF ==> 1. gangs retur.
      *
     c                   move      *off          *in31
      *
      * Skriver kvitteringliste 1. gangs retur NOK:
      *
     c     key01         setll     gur1l1
     c     key01         reade     gur1l1                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   eval      w_arow = w_arow + 2
     c                   eval      w_acol = w_acol - 4
     c                   eval      wpnlev = gdnlev
     c                   eval      wpnfor = gdnfor
     c                   write     a1hdr
6.21 c                   if        *in31 = *off
6.21 c                   eval      w_dspl = 'Kvitteringsliste 1.gangs retur'
6.21 c                   endif
6.12 c                   eval      b_lst1 = *on
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Skriver totalsum pr. dato dersom brudd på lev./forfall:      .
      *                                                              .
     c                   if        wpnlev <> gdnlev
     c                             or wpnfor <> gdnfor
     c                   write     t1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1tota2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      t1suma = 0
     c                   endif
      *                                                              .
      * Legger over inneværende leverandør og forfallsdato til       .
      * hjelpefeltene.  De blir brukt til å lagre "foregående"       .
      * post, i forbindelse med test på om ny leverandør/forfall.    .
      *                                                              .
     c                   eval      wpnlev = gdnlev
     c                   eval      wpnfor = gdnfor
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Leverandørnummer:                                            .
     c                   eval      d1nlev = gdnlev
      *                                                              .
      * Henter leverandørnavn:                                       .
      *                                                              .
     c     key02         chain     rlevl1                             61
     c                   if        *in61 = *off
     c                   movel     rlnavn        d1navn
19059c                   eval      wpkatg = rlkatg
     c                   else
     c                   eval      d1navn = *blanks
     c                   movel     '*UKJENT'     d1navn
19059c                   eval      wpkatg = 0
     c                   endif
      * Factoringnummer:                                             .
     c                   eval      d1stat = *blank
     c                   eval      d1nfac = gdnfac
     c                   if        d1nfac <> 0
     c                   movel     '*'           d1stat
     c                   endif
      * Bankreferansenummer:                                         .
     c                   movel     gdnref        d1nref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdnfor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      d1nfor = dsfor2
     c                   eval      t1dato = dsfor2
      * Bilagsnummer:                                                .
     c                   eval      d1nbnr = gdnbnr
      * Forslagsnummer:                                              .
     c                   eval      d1nubf = gdnubf
      * Beløp:                                                       .
     c                   eval      d1nbel = gdnbel
      * Adderer totalsummer:                                         .
     c                   eval      t1suma = t1suma + gdnbel
     c                   eval      t1sumb = t1sumb + gdnbel
      * Til kontonummer:                                             .
     c                   eval      d1ntki = gdntki
      * KID:                                                         .
     c                   movel     gdnkid        d1nkid
     c                   if        d1nkid = *blanks
     c                   movel     m(98)         d1nkid
     c                   endif
      * Tester på om allerede oppdatert:                             .
     c                   if        gdnopp = 1
     c                   movel     m(99)         d1nkid
     c                   endif
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     d1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   endif
      *                                                              .
     c     key01         reade     gur1l1                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     t1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1tota2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1tota2                              30
     c                   endif
      *                                                        .     .
     c                   write     t1totb1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1totb2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1totb2                              30
     c                   endif
      *                                                        .     .
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 1. Gangs Retur - Utland                                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x1grut        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      u1sumn = 0
     c                   eval      u1sumv = 0
     c                   eval      u2sumn = 0
     c                   eval      u3sumn = 0
      *
      * *IN31=*OFF ==> 1. gangs retur.
      *
     c                   move      *off          *in31
      *
      * Skriver kvitteringliste 1. gangs retur - Valuta:
      *
     c     key01         setll     gur1l2
     c     key01         reade     gur1l2                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   eval      w_arow = w_arow + 2
     c                   eval      w_acol = w_acol - 4
     c                   eval      wpnlev = gdnlev
     c                   eval      wpnfor = gdnfor
     c                   movel     gdnval        wpnval
     c                   write     b1hdr
6.21 c                   if        *in31 = *off
6.21 c                   eval      w_dspl = 'Kvitteringsliste 1.gangs retur'
6.21 c                   endif
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Skriver delsum pr. valuta dersom brudd på valutakode,        .
      * forfallsdato eller leverandør.                               .
      *                                                              .
     c                   if        wpnlev <> gdnlev
     c                             or wpnfor <> gdnfor
     c                             or wpnval <> gdnval
     c                   write     u1tota1                              30
      * Overflow ?                                             .     .
     c                   if        *in30 = *on
     c                   write     u1tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u1tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      u1sumn = 0
     c                   eval      u1sumv = 0
     c                   endif
      *                                                              .
      * Skriver totalsum pr. dato dersom brudd på leverandør         .
      * eller forfallsdato:                                          .
      *                                                              .
     c                   if        wpnlev <> gdnlev
     c                             or wpnfor <> gdnfor
     c                   write     u2tota1                              30
      * Overflow ?                                             .     .
     c                   if        *in30 = *on
     c                   write     u2tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u2tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      u2sumn = 0
     c                   endif
      *                                                              .
      * Legger over inneværende leverandør, forfallsdato og          .
      * valutakode til hjelpefelter.  De blir brukt til å lagre      .
      * "foregående" post som er behandlet.                          .
      *                                                              .
     c                   eval      wpnlev = gdnlev
     c                   eval      wpnfor = gdnfor
     c                   movel     gdnval        wpnval
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Leverandørnummer:                                            .
     c                   eval      d1nlev = gdnlev
      *                                                              .
      * Henter leverandørnavn:                                       .
      *                                                              .
     c     key02         chain     rlevl1                             61
     c                   if        *in61 = *off
     c                   movel     rlnavn        e1navn
19059c                   eval      wpkatg = rlkatg
     c                   else
     c                   eval      e1navn = *blanks
     c                   movel     '*UKJENT'     e1navn
19059c                   eval      wpkatg = 0
     c                   endif
      * Factoringnummer:                                             .
     c                   eval      d1stat = *blank
     c                   eval      d1nfac = gdnfac
     c                   if        d1nfac <> 0
     c                   movel     '*'           d1stat
     c                   endif
      * Bankreferansenummer:                                         .
     c                   movel     gdnref        d1nref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdnfor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      d1nfor = dsfor2
     c                   eval      u2dato = dsfor2
     c                   movel     gdnval        u1nval
      * Forslagsnummer:                                              .
     c                   eval      d1nubf = gdnubf
      * Bilagsnummer:                                                .
     c                   eval      d1nbnr = gdnbnr
      * Beløp:                                                       .
     c                   eval      d1nvbe = gdnvbe
     c                   eval      d1nbel = gdnbel
      * Adderer totalsummer:                                         .
     c                   eval      u1sumv = u1sumv + gdnvbe
     c                   eval      u1sumn = u1sumn + gdnbel
     c                   eval      u2sumn = u2sumn + gdnbel
     c                   eval      u3sumn = u3sumn + gdnbel
      * Til kontonummer:                                             .
     c                   movel     gdntku        d1ntku
      * Valutakode:                                                  .
     c                   movel     gdnval        d1nval
      * Tester på om allerede oppdatert:                             .
     c                   if        gdnopp = 1
     c                   movel     m(99)         d1ntku
     c                   endif
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     e1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     b1hdr
     c                   endif
      *                                                              .
     c     key01         reade     gur1l2                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     u1tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u1tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u1tota2                              30
     c                   endif
      *                                                      .       .
     c                   write     u2tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u2tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u2tota2                              30
     c                   endif
      *                                                      .       .
     c                   write     u3tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u3tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u3tota2                              30
     c                   endif
      *                                                      .       .
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 2. Gangs Retur - Innland                                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x2grin        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      t1suma = 0
     c                   eval      t1sumb = 0
      *
      * *IN31=*OFF ==> 1. gangs retur.
      *
     c                   move      *on           *in31
      *
      * Skriver kvitteringliste 2. gangsretur NOK:
      *
     c     key01         setll     gur2l1
     c     key01         reade     gur2l1                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   eval      w_arow = w_arow + 2
     c                   eval      w_acol = w_acol - 4
     c                   eval      wpnlev = gdolev
     c                   eval      wpnfor = gdofor
     c                   write     a1hdr
6.21 c                   if        *in31 = *on
6.21 c                   eval      w_dspl = 'Kvitteringsliste 2.gangs retur'
6.21 c                   endif
6.12 c                   eval      b_lst1 = *on
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Skriver totalsum pr. dato dersom brudd på lev./forfall:      .
      *                                                              .
     c                   if        wpnlev <> gdolev
     c                             or wpnfor <> gdofor
      *                                                        .     .
     c                   write     t1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1tota2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      t1suma = 0
     c                   endif
      *                                                              .
      * Legger over inneværende leverandør og forfallsdato til       .
      * hjelpefeltene.  De blir brukt til å lagre "foregående"       .
      * post, i forbindelse med test på om ny leverandør/forfall.    .
      *                                                              .
     c                   eval      wpnlev = gdolev
     c                   eval      wpnfor = gdofor
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Leverandørnummer:                                            .
     c                   eval      d1nlev = gdolev
      *                                                              .
      * Henter leverandørnavn:                                       .
      *                                                              .
     c     key02         chain     rlevl1                             61
     c                   if        *in61 = *off
     c                   movel     rlnavn        d1navn
19059c                   eval      wpkatg = rlkatg
     c                   else
     c                   eval      d1navn = *blanks
     c                   movel     '*UKJENT'     d1navn
19059c                   eval      wpkatg = 0
     c                   endif
      * Factoringnummer:                                             .
     c                   eval      d1stat = *blank
     c                   eval      d1nfac = gdofac
     c                   if        d1nfac <> 0
     c                   movel     '*'           d1stat
     c                   endif
      * Bankreferansenummer:                                         .
     c                   movel     gdoref        d1nref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdofor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      d1nfor = dsfor2
     c                   eval      t1dato = dsfor2
      * Forslagsnummer:                                              .
     c                   eval      d1nubf = gdoubf
      * Bilagsnummer:                                                .
     c                   eval      d1nbnr = gdobnr
      * Beløp:                                                       .
     c                   eval      d1nbel = gdobel
      * Adderer totalsummer:                                         .
     c                   eval      t1suma = t1suma + gdobel
     c                   eval      t1sumb = t1sumb + gdobel
      * Til kontonummer:                                             .
     c                   eval      d1ntki = gdotki
      * KID:                                                         .
     c                   movel     gdokid        d1nkid
     c                   if        d1nkid = *blanks
     c                   movel     m(98)         d1nkid
     c                   endif
      * Tester på om allerede oppdatert:                             .
     c                   if        gdoopp = 1
     c                   movel     m(99)         d1nkid
     c                   endif
      *                                                              .
      * Skriver detaljlinje på rapport:                              .
      *                                                              .
     c                   write     d1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   endif
      *                                                              .
      * Leser neste post:                                            .
      *                                                              .
     c     key01         reade     gur2l1                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     t1tota1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1tota2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1tota2                              30
     c                   endif
      *                                                        .     .
     c                   write     t1totb1                              30
      * Overflow?                                              .     .
     c                   if        *in30 = *on
     c                   write     t1totb2                              30
     c                   write     a1hdr
6.12 c                   eval      b_lst1 = *on
     c                   else
     c                   write     t1totb2                              30
     c                   endif
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * 2. Gangs Retur - Utland                                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     x2grut        begsr
      *
      * Nullstiller tellere:
      *
     c                   eval      u1sumn = 0
     c                   eval      u1sumv = 0
     c                   eval      u2sumn = 0
     c                   eval      u3sumn = 0
      *
      * *IN31=*OFF==> 1. gangs retur.
      *
     c                   move      *on           *in31
      *
      * Skriver kvitteringliste 2. gangs retur - Valuta.
      * File GUR2L2 har "omit" på poster som har valutakode
      * ulik blank, d.v.s. kun poster i valuta blir lest:
      *
     c     key01         setll     gur2l2
     c     key01         reade     gur2l2                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   eval      w_arow = w_arow + 2
     c                   eval      w_acol = w_acol - 4
     c                   eval      wpnlev = gdolev
     c                   eval      wpnfor = gdofor
     c                   movel     gdoval        wpnval
     c                   write     b1hdr
6.21 c                   if        *in31 = *on
6.21 c                   eval      w_dspl = 'Kvitteringsliste 2.gangs retur'
6.21 c                   endif
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Skriver delsum pr. valuta dersom brudd på valutakode,        .
      * forfallsdato eller leverandør.                               .
      *                                                              .
     c                   if        wpnlev <> gdolev
     c                             or wpnfor <> gdofor
     c                             or wpnval <> gdoval
     c                   write     u1tota1                              30
      * Overflow ?                                             .     .
     c                   if        *in30 = *on
     c                   write     u1tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u1tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      u1sumn = 0
     c                   eval      u1sumv = 0
     c                   endif
      *                                                              .
      * Skriver totalsum pr. dato dersom brudd på leverandør         .
      * eller forfallsdato:                                          .
      *                                                              .
     c                   if        wpnlev <> gdolev
     c                             or wpnfor <> gdofor
     c                   write     u2tota1                              30
      * Overflow ?                                             .     .
     c                   if        *in30 = *on
     c                   write     u2tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u2tota2                              30
     c                   endif
      *                                                        .     .
     c                   eval      u2sumn = 0
     c                   endif
      *                                                              .
      * Legger over inneværende leverandør, forfallsdato og          .
      * valutakode til hjelpefelter.  De blir brukt til å lagre      .
      * "foregående" post som er behandlet.                          .
      *                                                              .
     c                   eval      wpnlev = gdolev
     c                   eval      wpnfor = gdofor
     c                   movel     gdoval        wpnval
      *                                                              .
      * Legger over felt i fra file til variabel i rapport:          .
      *                                                              .
      * Leverandørnummer:                                            .
     c                   eval      d1nlev = gdolev
      *                                                              .
      * Henter leverandørnavn:                                       .
      *                                                              .
     c     key02         chain     rlevl1                             61
     c                   if        *in61 = *off
     c                   movel     rlnavn        e1navn
19059c                   eval      wpkatg = rlkatg
     c                   else
     c                   eval      e1navn = *blanks
     c                   movel     '*UKJENT'     e1navn
19059c                   eval      wpkatg = 0
     c                   endif
      * Factoringnummer:                                             .
     c                   eval      d1stat = *blank
     c                   eval      d1nfac = gdofac
     c                   if        d1nfac <> 0
     c                   movel     '*'           d1stat
     c                   endif
      * Bankreferansenummer:                                         .
     c                   movel     gdoref        d1nref
      * Snur forfallsdato:                                           .
     c                   eval      dsfor1 = gdofor
     c                   eval      dsfda2 = dsfda1
     c                   eval      dsfmn2 = dsfmn1
     c                   eval      dsfÅr2 = dsfÅr1
     c                   eval      d1nfor = dsfor2
     c                   eval      u2dato = dsfor2
     c                   movel     gdoval        u1nval
      * Forslagsnummer:                                              .
     c                   eval      d1nubf = gdoubf
      * Bilagsnummer:                                                .
     c                   eval      d1nbnr = gdobnr
      * Beløp:                                                       .
     c                   eval      d1nvbe = gdovbe
     c                   eval      d1nbel = gdobel
      * Adderer totalsummer:                                         .
     c                   eval      u1sumv = u1sumv + gdovbe
     c                   eval      u1sumn = u1sumn + gdobel
     c                   eval      u2sumn = u2sumn + gdobel
     c                   eval      u3sumn = u3sumn + gdobel
      * Til kontonummer:                                             .
     c                   movel     gdotku        d1ntku
      * Valutakode:                                                  .
     c                   movel     gdoval        d1nval
      * Tester på om allerede oppdatert:                             .
     c                   if        gdoopp = 1
     c                   movel     m(99)         d1ntku
     c                   endif
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     e1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     b1hdr
     c                   endif
      *                                                              .
     c     key01         reade     gur2l2                                 60
      *                                                              .
      * Skriver totalsummer ved EOF:                                 .
      *                                                              .
     c                   if        *in60 = *on
     c                   write     u1tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u1tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u1tota2                              30
     c                   endif
      *                                                    . .       .
     c                   write     u2tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u2tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u2tota2                              30
     c                   endif
      *                                                    . .       .
     c                   write     u3tota1                              30
      * Overflow ?                                           .       .
     c                   if        *in30 = *on
     c                   write     u3tota2                              30
     c                   write     b1hdr
     c                   else
     c                   write     u3tota2                              30
     c                   endif
      *                                                    . .       .
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Regnskapsoppdatering:                                           *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xregns        begsr
      *
      * Nullstiller tellere.  WPSUML=Sum v/brudd på Leverandør/Forfall->NOK
02069 *                       WPSUMV=Sum v/brudd på Leverandør/Forfall->VAL
PROV  *                       WPPROL=Sum provisj. ----------"---------.
      *                       WPSUNO=Rabattsum v/brudd Lev./Forfall.
18069 *                       WPSUVK=Sum kto.rabatt valuta
      *                       WPSUMF=Sum v/brudd på Forfall.
      *                       WPRFNR=Referansenummer.
      *
     c                   eval      wpsuml = 0
02069c                   eval      wpsumv = 0
PROV c                   eval      wpprol = 0
     c                   eval      wpsuno = 0
19069c                   eval      wpsuvk = 0
     c                   eval      wpsumf = 0
     c                   eval      wprfnr = 0
      *
      * Nullstiller bruddfelt:  WPLEV1 og
      *                         WPFOR1  = Brudd på Leverandør/Forfall
      *                         WPRFNR  = Brudd på forfallsdato.
      *
     c                   eval      wplev1 = 0
     c                   eval      wpfor1 = 0
     c                   eval      wpfor2 = 0
      *
      * File leses på firmanummer (KEY01):
      *
     c     key01         setll     gur2pf
     c     key01         reade     gur2pf                                 60
      *
      * Hent sist brukte samlebilagsnummer:
      *
     c                   if        *in60 = *off
     c                   exsr      xovper
05014c**** F Ø R         move      rtrper        wtraar
05014c                   move      rtraar        wtraar
     c                   move      wtraar        ra4aar
     c                   if        wtraar > 81
     c                   movel     19            ra4aar
     c                   else
     c                   movel     20            ra4aar
     c                   endif
      *  Hente nytt bilagsnr
     c                   exsr      xsamle
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Det må testes på om det er dobbel oppdatering mot det        .
      * samme forslagnummeret, d.v.s. forslaget er i såfall          .
      * allerede fjernet:                                            .
      *                                                              .
     c     key08         chain     gubfl8                             61
     c     *in61         cabeq     *on           xnyles
      *                                                              .
      * Tester på om det er valutatransaksjon.  Dersom "JA", så      .
      * skal valutakonto benyttes dersom utfylt:                     .
      *                                                              .
     c                   eval      wppkto = radk15
     c                   eval      wppsps = rads15
     c                   eval      wppavd = rada15
      *                                                              .
     c                   if        gabeva = 'J'
     c                   eval      ra16l1_firm = gdofir
     c                   eval      ra16l1_pkod = gdoval
      *
     c     ra16l1_key    chain     ra16l1
      *
     c                   if        not%found
     c                   move      *on           *in61
     c                   else
     c                   move      *off          *in61
     c                   endif
      *
     c                   if        *in61 = *off
     c                             and rapkto <> 0
     c                   eval      wppkto = rapkto
     c                   eval      wppsps = rapsps
     c                   eval      wppavd = rapavd
     c                   endif
     c                   endif
      *                                                              .
      * Tester på om det er nytt Leverandørnummer eller ny           .
      * Forfallsdato for post som er lest inn:                       .
      *                                                              .
     c                   if        gdolev <> wplev1
     c                             and wplev1 <> 0
     c                             or gdofor <> wpfor1
     c                             and wpfor1 <> 0
      *                                                        .     .
      * Oppdaterer hjelpefelter + regnskapsfile:               .     .
      *                                                        .     .
     c                   exsr      xdebko
      *                                                        .     .
      * Ved brudd på Leverandør/Forfallsdato må nytt samle-    .     .
      * bilagsnummer hentes opp:                               .     .
6.32  *  Flyttet
6.32 c                   eval      wprfnr = wprfnr
      *                                                        .     .
     c                   endif
      *                                                              .
      * Kreditpostering (motpost) legges ut ved NY FORFALLSDATO      .
      * eller NY BELASTNINGSKONTO.  Ny belastningskonto vil være     .
      * tilfelle dersom det er brukt forskjellige valutakonti.       .
      *                                                              .
      * GDOFOR = Forfallsdato for gjeldende valutatype.              .
      * WPFOR1 = Sist brukte forfallsdato ut på kreditpost.          .
      * WPPKTO = Kreditkonto på inneværende poster.                  .
      * WPKKTO = Sist brukte kontonummer på kreditpost.              .
      *                                                              .
     c                   if        gdofor <> wpfor1
     c                             and wpfor1 <> 0
     c                             or wppkto <> wpkkto
     c                             and wppkto <> 0
     c                             and wpkkto <> 0
      *                                                        .     .
      * Henter generert samlebilagsnummer, som skal legges     .     .
      * ut for motpost:                                        .     .
      *                                                        .     .
     c                   exsr      xgener
      *                                                        .     .
      * Oppdaterer hjelpefelter + legger ut motpost:           .     .
      *                                                        .     .
     c                   exsr      xkreko
6.32  *  Hent bilagnummer til ny innlest post
6.32 c                   exsr      xsamle
      *                                                        .     .
     c                   endif
      *                                                              .
      * Overfører felter på post som er lest inn:                    .
      *                                                              .
     c                   exsr      xoverf
      *                                                              .
      * Finner neste ledige buntnummer:                              .
      *                                                              .
     c                   if        wpokbu = *blanks
     c                   exsr      xbuntn
     c                   endif
      *                                                              .
      * Tester om element for PERIODE finnes i tabellen:             .
      *                                                              .
     c                   eval      dsperÅ = dsfÅr1
     c                   eval      dsperm = dsfmn1
      *                                                              .
     c                   eval      k = 1
     c     dstabb        lookup    per(k)                                 61
      *                                                              .
      * Periode finnes ikke i tabell (*IN61=*OFF).                   .
      * Element opprettes:                                           .
      *                                                              .
     c                   if        *in61 = *off
     c                   eval      k = 1
     c     wpnul6        lookup    per(k)                                 61
     c                   movel     dsfÅr1        per(k)
     c                   move      dsfmn1        per(k)
      *                                                        .     .
      * Finner sist brukte buntnummer, og legger ut ny         .     .
      * buntrecord:                                            .     .
      *                                                        .     .
610  c                   eval      rbunlu_nivo = *blank
610  c                   eval      rbunlu_memb = w_mem2
     c                   eval      wpbunt = 99999
     c     key10         setll     rbunl1
D610 c***  dsfirm        readpe    rbunl1                                 61
610  c     key10a        readpe    rbunl1                                 61
      *                                                        .     .
     c                   if        *in61 = *on
     c                   eval      wpbunt = 1
     c                   else
     c                   eval      wpbunt = rsbunt + 1
     c                   endif
      *                                                        .     .
     c                   eval      rsbunt = wpbunt
      *                                                        .     .
      * Legger ut firmanummer:                                 .     .
      *                                                        .     .
     c                   eval      rsfirm = dsfirm
      *                                                        .     .
      * Skriver ut post på buntfile:                           .     .
      *                                                        .     .
610  c                   eval      rsnivo = *blank
610  c                   eval      rsmemb = w_mem2
610  c                   time                    rsedat
610  c                   time                    rsetim
610  c                   eval      rseusr = l_user
     c                   write     rbunpfu
      * Tabellelement for buntnummer:                          .     .
     c                   eval      bun(k) = wpbunt
      *                                                        .     .
     c                   endif
      * Buntnummer:
     c                   eval      rtbunt = bun(k)
      *                                                              .
      * Oppdaterer totalsummer for perioden.  "K" inneholder         .
      * verdi for riktig tabellelement:                              .
      *                                                              .
     c                   eval      deb(k) = deb(k) + gdobel
     c                   eval      kre(k) = kre(k) + gdobel
     c                   eval      kre(k) = kre(k) + gdopro
     c                   eval      deb(k) = deb(k) + gdopro
      *                                                              .
      * Oppdaterer faktura på leverandørtrans.file RLTRPF med        .
      * samlebilagsnummer.  Henter først nøkkelverdier i fra         .
      * forslagfile GUBFPF, til bruk mot file RLTRPF:                .
      *                                                              .
      *  NB-1 Samtidig hentes opprinnelig beløpsfelt i fra           .
      *       forslagsfile, for å beregne ev. rabatt.                .
      *                                                              .
      *  NB-2 Post slettes her i fra forslagfile:                    .
      *                                                              .
     c     key08         chain     gubflu                             61
      *                                                              .
     c                   if        *in61 = *off
      *                                                            . .
      * VED LOKAL VALUTA:                                          . .
      *                                                            . .
      * Beregner rabatt dersom utbetalt beløp til leverandør       . .
      * er mindre enn opprinnelig beløp:                           . .
      *                                                            . .
      * GAOPBN = Opprinnelig beløp i NOK før ev. rabatt.           . .
      * GDOBEL = Utbetalt beløp i NOK, justert med ev. rabatt/agio . .
      *                                                            . .
     c                   if        gavalk = *blanks
     c                             or gavalk = 'NOK'
     c                   if        gdobel < gaopbn
      *                                                        . . . .
      * Beregner hvor mye rabatt som er trukket:               . . . .
      *                                                        . . . .
     c                   eval      wprabb = gaopbn - gdobel
      *                                                        . . . .
      * Tester om det er rabatt-1, rabatt-2 eller rabatt-3     . . . .
      * som er benyttet, og legger ev. beløpet ut i feltet     . . . .
      * som senere vil bli overført til felt RTKRAB på file    . . . .
      * RTRAPF (transaksjoner til regnskapsoppdatering):       . . . .
      *                                                        . . . .
      * Snur først fortegn på rabattbeløpene:                  . . . .
      *                                                        . . . .
     c                   eval      garbn1 = garbn1 * -1
     c                   eval      garbn2 = garbn2 * -1
     c                   eval      garbn3 = garbn3 * -1
      *                                                        . . . .
      * Kontroll på at rabatten som er trukket er en av tre    . . . .
      * rabattbeløp:                                           . . . .
      *                                                        . . . .
     c                   if        wprabb = garbn1
     c                             or wprabb = garbn2
     c                             or wprabb = garbn3
     c                   eval      wpsuno = wpsuno + wprabb
     c                   endif
      *                                                        . . . .
     c                   endif
     c                   endif
      *                                                            . .
      * VED FREMMED VALUTA:                                        . .
      *                                                            . .
      * Beregner rabatt dersom utbetalt beløp til leverandør       . .
      * er mindre enn opprinnelig beløp:                           . .
      *                                                            . .
      * GAOPBV = Opprinnelig beløp i Valuta før rabatt:            . .
      * GDOBEL = Utbetalt beløp i NOK, justert med ev. rabatt/agio . .
      *                                                            . .
     c                   if        gavalk <> *blanks
     c                             and gavalk <> 'NOK'
      *                                                          . . .
      * Beregner hvor mye rabatt som er trukket i valuta,        . . .
      * for deretter å omregne dette til NOK:                    . . .
      *                                                          . . .
     c                   eval      wprabb = gaopbv - gavalb
      *                                                          . . .
     c                   if        wprabb <> 0
      *                                                        . . . .
      * Det må testes på om valuta som brukes er i forholdet   . . . .
      * 1 eller 100 mot NOK:                                   . . . .
      *                                                        . . . .
     c                   eval      x = 1
     c     gavalk        lookup    vk(x)                                  63
      *                                                        . . . .
16069c                   eval      wpokno = gdokno
      *                                                        . . . .
     c                   if        vf(x) = '100'
16069c                   eval      wpokno = wpokno / 100
     c                   endif
      *                                                        . . . .
      * Summerer kontantrabatt før det regnes om til NOK:      . . . .
      *                                                        . . . .
19069c                   eval      wpsuvk = wpsuvk + wprabb
      *                                                        . . . .
16069c                   eval(h)   wprabb = wprabb * wpokno
     c                   endif
      *                                                          . . .
      * Summerer rabattbeløp:                                    . . .
      *                                                          . . .
     c                   if        wprabb <> 0
     c                   eval      wpsuno = wpsuno + wprabb
     c                   endif
      *                                                          . . .
     c                   endif
      *                                                            . .
      * Henter post fra RLTRPF:                                    . .
      *                                                            . .
     c     key06         chain     rltrlu                             61
     c                   if        *in61 = *off
     c                   eval      rosamb = wprfnr
     c                   update    rltrlur
     c                   endif
      *                                                            . .
      * Tar kopi av forslaget før det slettes:                     . .
      *                                                            . .
12071c                   exsr      xcopy
      *                                                            . .
      * Sletter forslagspost:                                      . .
      *                                                            . .
     c                   delete    gabfpfu
      *                                                            . .
     c                   endif
      *                                                              .
     c     xnyles        tag
      *                                                              .
      * Leser neste post:                                            .
      *                                                              .
     c     key01         reade     gur2pf                                 60
      *                                                              .
      * Før det avsluttes må også regnskapsfile oppdateres for       .
      * den sist leste posten:                                       .
      *                                                              .
     c                   if        *in60 = *on
     c                   exsr      xdebko
      *                                                              .
      * Henter generert samlebilagsnummer før motpost legges ut:     .
      *
     c                   exsr      xgener
     c                   exsr      xkreko
     c                   endif
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Oppdaterer hjelpefelter + legger ut regnskapstransaksjon:       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xdebko        begsr
      *
      * Beløp:
     c                   eval      rtbelØ = wpsuml
      * Kontantrabatt:
19069c                   eval      rtkrab = 0
      * Referansenummer:
     c                   eval      rtbref = *blanks
     c                   movel     dsbref        rtbref
      * Valutakode:
07059c                   move      wpvalk        rtvalk
02069c                   eval      rtvalb = wpsumv
      * Debet konto:
     c                   eval      rtdkto = wplev1
     c                   eval      rtdavd = 0
     c                   eval      rtdsps = 0
      * Kredit konto:
     c                   eval      rtckto = 0
     c                   eval      rtcavd = 0
     c                   eval      rtcsps = 0
      * Bilagsnummer:
6.31 c                   eval      rtbiln = wprfnr
6.31 c**  lagt tilbake   eval      rtbiln = w_sbiln
      * Refn.nr. til automatisk avkryssing:
     c                   eval      rtrefn = wprfnr
      *
      *
      * Henter avdeling (FRA KATEGORIFELT) på leverandør:
      * SPESIALTILPASNING FOR BERGSLI:
      *
25069c                   eval      d1nlev = wplev1
25069c     key02         chain     rlevl1                             61
25069c                   if        *in61 = *off
25069c                   eval      wpkatg = 0
25069c                   else
25069c                   eval      wpkatg = 0
25069c                   endif
      *
      * Legger ut REGNSKAPSTRANSAKSJON:
      *
18069 * Legger FØRST ut eventuell kontantrabatt:
      *
18069c                   if        wpsuno <> 0
  "   *                                                         .
  "  c                   eval      rtbilk = 96
  "  c                   eval      rtbelØ = wpsuno
  "  c                   eval      rtvalb = wpsuvk
  "   *                                                         .
  "   * Kredit konto.                                           .
  "   *                                                         .
  "  c                   if        radk16 = 0
  "  c                   eval      rtcavd = rada07
  "  c                   eval      rtckto = radk07
  "  c                   eval      rtcsps = rads07
  "  c                   else
  "  c                   eval      rtcavd = rada16
  "  c                   eval      rtckto = radk16
  "  c                   eval      rtcsps = rads16
  "  c                   endif
  "   *                                                         .
  "  c                   exsr      xoppda
  "   *                                                         .
  "  c                   eval      rtckto = 0
  "  c                   eval      rtcavd = 0
  "  c                   eval      rtcsps = 0
  "   *                                                         .
18069c                   endif
      *
      * Legger ut "hoved"-transaksjonen.  Dersom det er VALUTA, så
      * må RTBLDE oppdateres med "T".  Koden blir senere brukt til
      * å beregne agio/disagio:
      *
29069c                   eval      rtblde = *blanks
29069c                   if        wpsumv <> 0
29069c                   movel     'T'           rtblde
29069c                   endif
      *
     c                   eval      rtbilk = 86
     c                   eval      rtbelØ = wpsuml
     c                   eval      rtvalb = wpsumv
      *
     c                   exsr      xoppda
      *
      * Nullstiller sum pr. Leverandør/Forfallsdato:
      *
     c                   eval      wpsuml = 0
02069c                   eval      wpsumv = 0
     c                   eval      wpsuno = 0
19069c                   eval      wpsuvk = 0
29069c                   eval      rtblde = *blanks
PROV  *
PROV  * Legger ut regnskapstransaksjon ved provisjoner:
PROV  *
PROV c                   if        wpprol <> 0
      *                                                        .
07059c                   eval      rtvalk = *blanks
07059c                   eval      rtvalb = 0
PROV c                   eval      rtbelØ = wpprol
PROV c                   eval      rtkrab = 0
PROV c                   eval      rtdkto = radk20
6.15 c**                 eval      rtdavd = wpkatg
6.15 c                   eval      rtdavd = rada20
PROV c                   eval      rtdsps = rads20
      *                                                        .
      * Bilagskode:                                            .
      *                                                        .
18069c                   eval      rtbilk = 86
      *                                                        .
PROV c                   exsr      xoppda
PROV c                   eval      wpsumf = wpsumf + wpprol
PROV c                   eval      wpprol = 0
19059c                   eval      wpkatg = 0
PROV c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Oppdaterer hjelpefelter + legger ut regnskapstransaksjon:       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xkreko        begsr
      *
      * Henter frem laveste bankreferansenummer, og legger dette
      * ut på post til regnskap:
      *
07059c                   eval      rtvalk = *blanks
07059c                   eval      rtvalb = 0
      *
     c                   eval      rtbref = *blanks
     c                   movel     wpbref        rtbref
     c                   eval      wpbref = *blanks
      * Beløp:
     c                   eval      rtbelØ = wpsumf
      * Kontantrabatt:
     c                   eval      rtkrab = 0
      * Debet konto:
     c                   eval      rtdavd = 0
     c                   eval      rtdkto = 0
     c                   eval      rtdsps = 0
      * Refn.nr. til automatisk avkryssing:
     c                   eval      rtrefn = 0
      *
      * WPPKTO = Valutakonto for gjeldende valutatype.
      * WPKKTO = Sist brukte kontonummer ut på kreditpost.
      *
      * Kredit konto.  Det må testes på om valutakontonummer
      * skal benyttes:
      *
     c                   if        wpkkto = 0
     c                   eval      rtcavd = rada15
     c                   eval      rtckto = radk15
     c                   eval      rtcsps = rads15
     c                   else
     c                   eval      rtcavd = wpkavd
     c                   eval      rtckto = wpkkto
     c                   eval      rtcsps = wpksps
     c                   endif
      * Legger kreditkontonr. ut i hjelpefelt for sist brukte ktonr.
     c                   eval      wpkkto = rtckto
      * Bilagsnummer:
6.32 c                   eval      rtbiln = wprfnr
6.32 c**                 eval      rtbiln = wpbiln
6.30 c**   lagt tilbake  eval      rtbiln = w_sbiln
      *
      * Legger ut regnskapstransaksjon:
      *
      * Bilagskode:
      *
18069c                   eval      rtbilk = 86
      *
     c                   exsr      xoppda
      *
      * Nullstiller sum pr. Forfallsdato:
      *
     c                   eval      wpsumf = 0
      *
     c                   endsr
      *
     c     xovper        begsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Hent riktig periode/år for regnskapstrans                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Bilagsdato:
     c                   eval      dsfor1 = gdofor
     c                   eval      dsfda3 = dsfda1
     c                   eval      dsfmn3 = dsfmn1
     c                   move      dsfÅr1        dsfÅr3
      *
     c     *dmy          move      dsfor3        rtbdat
      * Periode (tabellen APE har info om ev. avvikende perioder):
     c                   eval      x = dsfmn3
05014c**** F Ø R         move      ape(x)        rtrper
05014c                   movel     ape(x)        rtrper
05014c                   movel     20            rtraar
05014c                   move      dsfÅr3        rtraar
      *
      * Dersom post har posteringsår eldre enn inneværende
      * år, så legges det ut inneværende år minus 1.
      *
      * Tester samtidig på at årstall på post ikke er ÅR2000!
      *
     c                   movel     dsfÅr1        dspÅr1
     c                   if        dspÅr3 < uyear
     c                             and dspÅr3 <> 0
05014c*** F Ø R          move      wpyear        rtrper
05014c                   movel     ape(x)        rtrper
05014c                   movel     20            rtraar
05014c                   move      wpyear        rtraar
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Overfører felter i fra 2.g.retur til felter som senere skal     *
      * legges ut på regnskapstransaksjon:                              *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xoverf        begsr
      *
      * Bygger Bankreferansenummer i datastruktur:
      *
     c                   movel     gdoref        dsbrf2
      *
      * Tar vare på laveste Bankreferansenummer:
      *
     c                   if        wpbref = *blanks
     c                   movel     dsbref        wpbref
     c                   endif
      *
     c                   if        dsbref < wpbref
     c                   movel     dsbref        wpbref
     c                   endif
      *
      * WPLEV1, WPFOR1 og WPFOR2 er som tidligere beskrevet
      * hjelpefelter som brukes til kontroll på om det leses
      * ny Leverandør og/eller ny Forfallsdato:
      *
     c                   eval      wplev1 = gdolev
     c                   eval      wpfor1 = gdofor
     c                   eval      wpfor2 = gdofor
      *
      * Valutakode:
      *
07059c                   move      gdoval        wpvalk
07059c                   eval      wpvalb = gdovbe
02069c                   eval      wpsumv = wpsumv + gdovbe
      * Summerer beløp:
     c                   eval      wpsumf = wpsumf + gdobel
     c                   eval      wpsuml = wpsuml + gdobel
PRO  c                   eval      wpprol = wpprol + gdopro
     c                   eval      wptbel = wptbel + gdobel
      *
     c                   eval      rtfirm = gdofir
      * Bilagsdato:
     c                   eval      dsfor1 = gdofor
     c                   eval      dsfda3 = dsfda1
     c                   eval      dsfmn3 = dsfmn1
     c                   move      dsfÅr1        dsfÅr3
     c***                eval      rtbdat = dsfor3
     c     *dmy          move      dsfor3        rtbdat
      *
      * WPPKTO = Valutakonto for gjeldende valutatype.
      * WPKKTO = Sist brukte valutakontonummer ut på kreditpost.
      *
     c                   eval      wpkkto = wppkto
     c                   eval      wpkavd = wppavd
     c                   eval      wpksps = wppsps
      * Periode (tabellen APE har info om ev. avvikende perioder):
     c                   eval      x = dsfmn3
05014c**** F Ø R         move      ape(x)        rtrper
05014c                   move      dsfmn3        rtrper
05014c                   movel     20            rtraar
05014c                   move      dsfÅr3        rtraar
      *
      * Dersom post har posteringsår eldre enn inneværende
      * år, så legges det ut inneværende år minus 1.
      *
26059 * Tester samtidig på at årstall på post ikke er ÅR2000!
      *
     c                   movel     dsfÅr1        dspÅr1
     c                   if        dspÅr3 < uyear
26059c                             and dspÅr3 <> 0
05014c**** F Ø R         move      wpyear        rtrper
05014c                   move      dsfmn3        rtrper
05014c                   movel     20            rtraar
05014c                   move      dsfÅr3        rtraar
     c                   endif
      * Forfallsdato:
     c***                eval      rtfdat = dsfor3
     c     *dmy          move      dsfor3        rtfdat
      * Bankreferanse:
     c                   move      gdoref        dsrfal
     c                   move      dsrfal        rtbref
      * Avkryssing:
     c                   movel     'S'           rtkrys
      * Deklarasjonskode:
     c                   eval      rtdeck = *blanks
     c     key08         chain     gubflu                             61
     c                   if        *in61 = *off
     c                   movel     gadeck        rtdeck
     c                   unlock    gubflu
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Oppdatering av regnskap:                                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xoppda        begsr
      *
     c                   eval      wplinj = wplinj + 1
     c                   eval      rtlinj = wplinj
      *
      * Skriver regnskapstransaksjon ut i fra den betingelsen at
      * post finnes i file GUBFLU (Utbetalingsforslag).  Denne
      * kontrollen gjøres i program GL112R, og legger verdien "1"
      * ut i statusfeltet GDOOPP dersom post ikke finnes.  Dette
      * indikerer at det ENTEN er feil, ELLER at forslaget allerede
      * er bokført.
      *
      * LEVERANDØRRESKONTRO:
      * Det genereres EN POST VED BRUDD PR. LEVERANDØR/FORFALL.
      *
      * HOVEDBOK:
      * Det genereres EN POST VED BRUDD PR. FORFALL.
      *
     c                   if        gdoopp <> 1
610  c                   eval      rtnivo = *blank
610  c                   eval      rtmemb = w_mem2
610  c                   time                    rtedat
610  c                   time                    rtetim
610  c                   eval      rteusr = l_user
     c                   write     rtrapfr
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Feilretur:                                                      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xfeilr        begsr
      *
      * Leser file:
      *
     c     key01         setll     gurfpf
     c     key01         reade     gurfpf                                 60
      *
      * Skriver header dersom det finnes post på filen:
      *
     c                   if        *in60 = *off
     c                   eval      w_arow = w_arow + 2
     c                   eval      w_acol = w_acol - 4
     c                   write     c1hdr
     c                   endif
      *
     c                   dow       *in60 = *off
      *                                                              .
      * Legger over data, og skriver ut post:                        .
      *                                                              .
     c                   eval      f1pret = gdpret
     c                   movel     gdptrk        f1ptrk
     c                   eval      f1fakt = *blanks
      * Faktura:                                                     .
     c                   if        gdptrk = 'BETFOR04'
     c                             or gdptrk = 'BETFOR23'
     c                   movel     'JA'          f1fakt
     c                   endif
      * Leverandør:                                                  .
     c                   eval      f1plev = gdplev
     c                   eval      f1navn = *blanks
     c                   if        gdplev <> 0
     c     key03         chain     rlevl1                             61
     c                   if        *in61 = *off
     c                   movel     rlnavn        f1navn
19059c                   eval      wpkatg = rlkatg
     c                   else
     c                   movel     '*UKJENT'     f1navn
19059c                   eval      wpkatg = 0
     c                   endif
     c                   endif
      * Bilagsnummer:                                                .
     c                   eval      f1pbnr = gdpbnr
      * Hent feilmelding:                                            .
     c                   eval      i = gdpret + 1
     c                   movel     m(i)          f1mtxt
      * Forslagsnummer og Linjenummer:                               .
     c                   eval      f1pubf = gdpubf
     c                   eval      f1pbfl = gdpbfl
      *                                                              .
      * Skriver detaljlinje:                                         .
      *                                                              .
     c                   write     f1det                                30
      * Overflow?                                                    .
     c                   if        *in30 = *on
     c                   write     c1hdr
     c                   endif
      *                                                              .
     c     key01         reade     gurfpf                                 60
      *                                                              .
     c                   enddo
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Henter sist brukte samlebilagsnummer:
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xsamle        begsr
      *
     c     keyaa4        chain     raa4lu                             61
     c                   if        *in61 = *off
     c                   eval      ra4sug = ra4sug + 1
     c                   eval      wprfnr = ra4sug
     c                   update    raa4lur
      *                                                      .
     c                   else
     c                   eval      ra4sug = 1
     c                   eval      wprfnr = ra4sug
     c                   write     raa4lur
     c                   endif
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Henter sist brukte genererte bilagsnummer:
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xgener        begsr
      *
     c     keyaa4        chain     raa4lu                             61
     c                   if        *in61 = *off
     c                   eval      ra4sgb = ra4sgb + 1
     c                   eval      wpbiln = ra4sgb
     c                   update    raa4lur
      *                                                      .
     c                   else
     c                   eval      ra4sgb = 1
     c                   eval      wpbiln = ra4sgb
     c                   write     raa4lur
     c                   endif
6.30 c                   eval      w_sbiln = wpbiln
      *
     c                   endsr
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å rydde opp i forslagsfile:                       *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      *
     c     xrydde        begsr
      *
      * FEILRETUR:
      *
      * Feltet GASTAT (status) på forslagsfile GUBFLU blankes.  Post
      * blir da igjen tilgjengelig i Vedlikehold av utbetalingsforslag.
      *
      * MEN DET KAN LIGGE FLERE BATCHER MED D.S. FORSL.NR: ->
      *
      * Det ligger kontroll på om det finnes batcher tilhørende det
      * samme forslaget, i file for godkjent 1. gangsretur.
      * Dersom det sistnevnte er tilfelle, så blir post "nullstilt"
      * tilbake til lev.trans.file, d.v.s. forslag må kjøres på nytt
      * på vanlig måte for å få med transaksjonen.  Grunnen til dette
      * er at forslagfile etter denne kjøringen da inneholde poster
      * hvor det er mottatt 1.gangsretur.
      *
      * ENDRING!!  FORSLAG BLIR IKKE TILBAKESTILT TIL TRANSAKSJONSFIL
      *            SELVOM DET FINNES BÅDE FEILRETURER OG 1.GANGS RETUR.
      *            POST BLIR MERKET MED "1" ELLER "F".
      *
     c     key01         setll     gurfpf
     c     key01         reade     gurfpf                                 60
      *
     c                   dow       *in60 = *off
      *                                                            .
      * Tester om forslagsnummeret det er feil i også finnes i     .
      * file for 1.gangsretur.  Dersom dette IKKE er tilfelle,     .
      * så blir forslaget åpnet for vedlikehold:                   .
      *                                                            .
     c                   if        gdpubf <> 0
      *                                                          . .
     c     key05         chain     gur1l3                             61
      *                                                          . .
      * D.s. forslag finnes IKKE i 1.g.returfile, og forslag     . .
      * kan derfor åpnes:                                        . .
      *                                                          . .
     c                   if        *in61 = *on
      * Post gjøres klar til vedlikehold:                      . . .
     c     key04         chain     gubflu                             62
     c                   if        *in62 = *off
     c                   eval      gastat = *blanks
      *                                                      . . . .
      *Post merkes med "F" ved feilretur:                    . . . .
      *                                                      . . . .
ENDR c                   movel     'F'           gareko
     c                   update    gabfpfu
      * Oppdaterer lev.trans.file:                           . . . .
     c     key06         chain     rltrlu                             62
     c                   if        *in62 = *off
     c                   eval      robetk = *blanks
     c                   update    rltrlur
     c                   endif
     c                   endif
     c                   endif
      *                                                          . .
      * D.s. forslagsnummer FINNES i 1.gangsreturfile, og        . .
      * forslaget kan derfor IKKE åpnes.  Postering blir         . .
      * derfor "tilbakestilt" til RLTRPF:                        . .
      *                                                          . .
     c                   if        *in61 = *off
      *Post gjøres klar til vedlikehold:                       . . .
     c     key04         chain     gubflu                             62
     c                   if        *in62 = *off
      *                                                      . . . .
      *Post merkes med "F" ved feilretur:                    . . . .
      *                                                      . . . .
     c                   movel     'F'           gareko
     c                   update    gabfpfu
     c                   endif
     c                   endif
      *                                                          . .
     c                   endif
      *                                                            .
     c     key01         reade     gurfpf                                 60
     c                   enddo
      *
      * 1. GANGS RETUR:
      *
      * Feltet ROBETK på transaksjonsfile RLTRPF oppdateres med "1"
      * for å indikerer at 1. gangs retur er mottatt.
      *
     c     key01         setll     gur1pf
     c     key01         reade     gur1pf                                 60
      *
     c                   dow       *in60 = *off
      *                                                            .
      * Oppdaterer RLTRPF når posten som leses har utfylt          .
      * forslagsnummer.                                            .
      *                                                            .
     c                   if        gdnubf <> 0
      *                                                          . .
      * Leser forslagsfile for å "hente" nøkkelverdier:          . .
      *                                                          . .
     c     key07         chain     gubflu                             61
ETTERc                   if        *in61 = *off
ENDR c                   move      '1'           gareko
ENDR c                   update    gabfpfu
      * Oppdaterer lev.trans.file:                           .   . .
     c     key06         chain     rltrlu                             61
     c                   if        *in61 = *off
     c                   movel     '1'           robetk
     c                   update    rltrlur
     c                   endif
     c                   endif
      *                                                          . .
     c                   endif
      *                                                            .
     c     key01         reade     gur1pf                                 60
     c                   enddo
      *
      * 2. GANGS RETUR:
      *
      * Feltet ROBETK på transaksjonsfile RLTRPF oppdateres med "2"
      * for å indikerer at 2. gangs retur er mottatt.
      * Samtidig blir "tilhørende" linje i på forslagsfile slettet.
      *
     c     key01         setll     gur2pf
     c     key01         reade     gur2pf                                 60
      *
     c                   dow       *in60 = *off
      *                                                            .
      * Oppdaterer RLTRPF når posten som leses har utfylt          .
      * forslagsnummer.                                            .
      *                                                            .
     c                   if        gdoubf <> 0
      *                                                          . .
      * Leser forslagsfile for å "hente" nøkkelverdier:          . .
     c     key08         chain     gubflu                             61
     c                   if        *in61 = *off
     c                   delete    gabfpfu
      * Oppdaterer lev.trans.file:                             . . .
     c     key06         chain     rltrlu                             61
     c                   if        *in61 = *off
     c                   movel     '2'           robetk
     c                   update    rltrlur
     c                   endif
     c                   endif
      *                                                          . .
     c                   endif
      *                                                            .
     c     key01         reade     gur2pf                                 60
     c                   enddo
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for å etablere ny bunt:                               *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xbuntn        begsr
      *
      * Denne rutninen skal KUN kjøres en gang.
      * Variabel WPOKBU "flagges" for å indikere at rutinen
      * er kjørt:
      *
     c                   movel     '1'           wpokbu
      *
      * Finner sist brukte buntnummer:
      *
610  c                   eval      rbunlu_nivo = *blank
610  c                   eval      rbunlu_memb = w_mem2
     c                   eval      wpbunt = 99999
     c     key10         setll     rbunl1
D610 c**** dsfirm        readpe    rbunl1                                 61
610  c     key10a        readpe    rbunl1                                 61
      *
     c                   if        *in61 = *on
     c                   eval      wpbunt = 1
     c                   else
     c                   eval      wpbunt = rsbunt + 1
     c                   endif
      *
      * Legger ut 1. tabellelement for periode:
      *
     c                   movel     dsfÅr1        per(1)
     c                   move      dsfmn1        per(1)
      *
      * Legger ut 1. tabellelement for buntnummer:
      *
     c                   eval      bun(1) = wpbunt
      *
      * Legger ut firmanummer:
      *
     c                   eval      rsfirm = dsfirm
      *
      * Legger ut ny buntrecord:
      *
     c                   eval      rsbunt = wpbunt
610  c                   eval      rsnivo = *blank
610  c                   eval      rsmemb = w_mem2
610  c                   time                    rsedat
610  c                   time                    rsetim
610  c                   eval      rseusr = l_user
     c                   write     rbunpfu
      *
     c                   endsr
      *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for kopi av forslaget før det slettes                 *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
12071c     xcopy         begsr
      *
12071c                   movel     gastat        gkstat
12071c                   eval      gkfirm = gafirm
12071c                   eval      gkbfnr = gabfnr
12071c                   eval      gkbfli = gabfli
12071c                   eval      gklevr = galevr
     c                   eval      gkbdat = gabdat
     c                   eval      gktist = gatist
12071c                   movel     ganavn        gknavn
12071c                   movel     gavalk        gkvalk
12071c                   movel     gafval        gkfval
12071c                   movel     gaatts        gkatts
12071c                   movel     gabilk        gkbilk
12071c                   eval      gkbelØ = gabelØ
12071c                   eval      gkrest = garest
12071c                   eval      gkbiln = gabiln
12071c                   eval      gkvalb = gavalb
12071c                   eval      gkvalr = gavalr
12071c                   movel     gabetk        gkbetk
12071c                   eval      gkraar = garaar
12071c                   eval      gkrper = garper
12071c                   eval      gkjour = gajour
12071c                   eval      gksamb = gasamb
12071c                   eval      gkrefn = garefn
12071c                   movel     gatext        gktext
12071c                   movel     gavirk        gkvirk
     c                   eval      gkfdat = gafdat
12071c                   eval      gkrrf1 = garrf1
12071c                   eval      gkrrf2 = garrf2
12071c                   movel     gadeck        gkdeck
12071c                   movel     gakidi        gkkidi
12071c                   movel     gakids        gkkids
12071c                   eval      gkavde = gaavde
12071c                   movel     garekl        gkrekl
12071c                   eval      gkdelb = gadelb
12071c                   movel     gabetb        gkbetb
12071c                   movel     garemk        gkremk
12071c                   eval      gkrbn1 = garbn1
12071c                   eval      gkrbn2 = garbn2
12071c                   eval      gkrbn3 = garbn3
12071c                   eval      gkrbv1 = garbv1
12071c                   eval      gkrbv2 = garbv2
12071c                   eval      gkrbv3 = garbv3
     c                   eval      gkrda1 = garda1
     c                   eval      gkrda2 = garda2
     c                   eval      gkrda3 = garda3
12071c                   movel     garabb        gkrabb
12071c                   eval      gkopbn = gaopbn
12071c                   eval      gkopbv = gaopbv
     c                   eval      gkopfd = gaopfd
12071c                   eval      gkbgir = gabgir
S5.01c***                eval      gkpgir = gapgir
12071c                   movel     gatenr        gktenr
12071c                   eval      gkteku = gateku
12071c                   eval      gkavtk = gaavtk
12071c                   movel     gaavtm        gkavtm
12071c                   movel     gabeva        gkbeva
12071c                   movel     gareko        gkreko
     c                   eval      gkopda = gaopda
12071c                   movel     gaopav        gkopav
      *
12071c                   write     gkbfpfr
      *
12071c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Finner spool som er generert av jobben
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     spoolnbr      begsr
pdf   /Free
pdf
pdf            QSPRILSP( SPRL0100
pdf                    : %size(SPRL0100)
pdf                    : 'SPRL0100'
pdf                    : errorcode );
pdf   /End-free
pdf  c*
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Finner spool som er generert av jobben
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     spoolnbr2     begsr
pdf   /Free
pdf
pdf            QSPRILSP( SPRL0100
pdf                    : %size(SPRL0100)
pdf                    : 'SPRL0100'
pdf                    : errorcode );
pdf   /End-free
pdf   *
pdf  c                   eval      splfname2 = splfname
pdf  c                   eval      jobname2 = jobname
pdf  c                   eval      username2 = username
pdf  c                   eval      jobnbr2 = jobnbr
pdf  c                   eval      splfnbr2 = splfnbr
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Kaller eget program for generering av xml fil. Eget pgm         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_create    begsr
pdf   *
pdf  c                   eval      splfname3 = *blanks
pdf  c                   eval      jobname3 = *blanks
pdf  c                   eval      username3 = *blanks
pdf  c                   eval      jobnbr3 = *blanks
pdf  c                   eval      splfnbr3 = *zeros
6.11 c                   eval      p_btyp = 'TELEBANK KVITTERINGSLISTER'
6.21 c                   eval      p_dspl = w_dspl
6.20 c                   eval      p_refn = %char(w_year)
6.20 c                   eval      p_tagg0 = 'AAR'
6.20 c                   eval      p_tagg0val = %char(w_year)
6.20 c                   eval      p_tagg1 = 'TOTALSUM'
6.20 c                   eval      p_tagg1val = %char(t1sumb)
6.20 c                   eval      p_tagg2 = *blanks
6.20 c                   eval      p_tagg2val = *blanks
6.20 c                   eval      p_tagg3 = *blanks
6.20 c                   eval      p_tagg3val = *blanks
6.20 c                   eval      p_tagg4 = *blanks
6.20 c                   eval      p_tagg4val = *blanks
6.20 c                   eval      p_tagg5 = *blanks
6.20 c                   eval      p_tagg5val = *blanks
6.20 c                   eval      p_tagg6 = *blanks
6.20 c                   eval      p_tagg6val = *blanks
6.20 c                   eval      p_tagg7 = *blanks
6.20 c                   eval      p_tagg7val = *blanks
6.20 c                   eval      p_tagg8 = *blanks
6.20 c                   eval      p_tagg8val = *blanks
6.20 c                   eval      p_tagg9 = *blanks
6.20 c                   eval      p_tagg9val = *blanks
pdf   *
6.20 c**                 call      'AP620R'
6.20 c                   call      'AP627R'
pdf  c                   PARM                    splfname
pdf  c                   PARM                    jobname
pdf  c                   PARM                    username
pdf  c                   PARM                    jobnbr
pdf  c                   PARM                    splfnbr
pdf  c                   PARM                    splfname2
pdf  c                   PARM                    jobname2
pdf  c                   PARM                    username2
pdf  c                   PARM                    jobnbr2
pdf  c                   PARM                    splfnbr2
pdf  c                   PARM                    splfname3
pdf  c                   PARM                    jobname3
pdf  c                   PARM                    username3
pdf  c                   PARM                    jobnbr3
pdf  c                   PARM                    splfnbr3
6.20 c                   parm                    p_tagg0
6.20 c                   parm                    p_tagg0val
6.20 c                   parm                    p_tagg1
6.20 c                   parm                    p_tagg1val
6.20 c                   parm                    p_tagg2
6.20 c                   parm                    p_tagg2val
6.20 c                   parm                    p_tagg3
6.20 c                   parm                    p_tagg3val
6.20 c                   parm                    p_tagg4
6.20 c                   parm                    p_tagg4val
6.20 c                   parm                    p_tagg5
6.20 c                   parm                    p_tagg5val
6.20 c                   parm                    p_tagg6
6.20 c                   parm                    p_tagg6val
6.20 c                   parm                    p_tagg7
6.20 c                   parm                    p_tagg7val
6.20 c                   parm                    p_tagg8
6.20 c                   parm                    p_tagg8val
6.20 c                   parm                    p_tagg9
6.20 c                   parm                    p_tagg9val
pdf  c                   PARM                    l_bach
6.11 c                   PARM                    p_btyp
6.20 c                   parm                    p_refn
6.20 c                   parm                    p_dspl
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf  c                   if        l_skje = 1
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    l_bach
pdf   *
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   *
      /eject
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutine for initiering av program                             *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     *inzsr        begsr
      *
      * Parameterliste inneholde regnskapsperiode:
      *
     c     *entry        plist
     c                   parm                    wpregn
610  c                   parm                    w_mem1
610  c                   parm                    w_mem2
      *
      * Gml. regnskapsperiode:
      *
     c                   eval      wpperi = *blanks
      *
      * Valutakode:
      *
07059c                   eval      wpvalk = *blanks
07059c                   eval      wpvalb = 0
19059c                   eval      wpkatg = 0
      *
      * Felt for mellomlagring av laveste bankref.nr:
      *
     c                   eval      wpbref = *blanks
      *
      * Legger ut 7974 i bankrefferansefeltet:
      * (Kode for Den norske Bank)
      *
     c                   movel     '7974'        dsbrf1
      *
      * Linjeteller ut på regnskapsfile RTRAPF:
      *
     c                   eval      wplinj = 0
      *
      * Hjelpefelt for valutakurs:
      *
16069c                   eval      wpokno = 0
      *
      * Hjelpefelt for å indikere at det er mottatt 1.gangs-
      * retur på lønn.  Feltet blir senere (GL116C) brukt til
      * å slette "lønnsfile":
      *
     c                   eval      wplonn = *blank
      *
      * Initierer hjelpefelt til bruk for å fjerne alle poster i fra
      * utbetalingsforslagsfile GUBFPF ved 2.gangsretur lønn:
      *
     c                   move      'J'           wfØrst
      *
      * Beløpsfelter som brukes v/regnskapsoppdatering:
      *
     c                   eval      wptbel = 0
      * Sum faktura:
     c                   eval      wpsuml = 0
02069c                   eval      wpsumv = 0
     c                   eval      wpsumf = 0
      * Sum provisjoner:
     c                   eval      wpprol = 0
      * Sum rabatt:
     c                   eval      wpsuno = 0
     c                   eval      wprabf = 0
19069c                   eval      wpsuvk = 0
      * Hjelpefelt for rabattberegning:
     c                   eval      wprabb = 0
      * Hjelpefelt for buntnummer:
     c                   eval      wpokbu = *blank
      * Hjelpefelt for kontonummer:
      *
      * Ref.nr./Bilgsnummer som brukes v/regnskapsoppdatering:
      *
     c                   eval      wprfnr = 0
     c                   eval      wpbiln = 0
      *
      * "Bruddfelter" som brukes v/regnskapsoppdatering:
      *
     c                   eval      wplev1 = 0
     c                   eval      wpfor1 = 0
     c                   eval      wpfor2 = 0
      *
      * Konverterer regnskapsperiode i fra Alfa til Numerisk:
      *
     c                   movel     wpperi        dsperi
      *
      * Legger over firmanavn:
      *
     c                   eval      a1nfir = dsfirm
     c                   movel     dsfnav        a1fnav
      *
      * Hjelpevariabel som inneholder sist leste leverandør,
      * forfallsdato og valutakode.
      *
     c                   eval      wpnlon = 0
     c                   eval      wpnlev = 0
     c                   eval      wpnfor = 0
     c                   eval      wpnval = *blanks
      *
      * Hjelpevariabel til bruk for oppslag i tabell for meldinger:
      *
     c                   eval      i = 0
      *
      * Hjelpevariable til bruk for oppslag i tabell:
      *
     c                   eval      k = 0
     c                   eval      x = 0
     c                   eval      wpnul6 = 0
      *
      * Definering av nøkkel til oppslag mot koder "sist brukte bilagsnr.":
      *
     c     keyaa4        klist
     c                   kfld                    dsfirm
     c                   kfld                    ra4aar
      *
      * Definering av nøkkel til oppslag mot "kvitteringsfile":
      *
     c     key01         klist
     c                   kfld                    dsfirm
      *
      * Definering av nøkkel til oppslag mot leverandørregister:
      *
     c     key02         klist
     c                   kfld                    dsfirm
     c                   kfld                    d1nlev
      *
      * Definering av nøkkel til oppslag mot leverandørregister:
      *
     c     key03         klist
     c                   kfld                    dsfirm
     c                   kfld                    gdplev
      *
      * Definering av nøkkel til oppslag mot forslagsfile:
      *
     c     key04         klist
     c                   kfld                    dsfirm
     c                   kfld                    gdpubf
     c                   kfld                    gdpbfl
      *
      * Definering av nøkkel til oppslag mot 1.gangs returfile:
      *
     c     key05         klist
     c                   kfld                    dsfirm
     c                   kfld                    gdpubf
      *
      * Definering av nøkkel til oppslag mot transaksjonsfile (LEV):
      *
     c     key06         klist
     c                   kfld                    dsfirm
     c                   kfld                    galevr
     c                   kfld                    gabdat
     c                   kfld                    gatist
      *
      * Definering av nøkkel til oppslag mot forslagsfile, med
      * nøkkelverdier i fra 1.gangs retur file:
      *
     c     key07         klist
     c                   kfld                    dsfirm
     c                   kfld                    gdnubf
     c                   kfld                    gdnbfl
      *
      * Definering av nøkkel til oppslag mot forslagsfile, med
      * nøkkelverdier i fra 2.gangs retur file:
      *
     c     key08         klist
     c                   kfld                    dsfirm
     c                   kfld                    gdoubf
     c                   kfld                    gdobfl
      *
      * Definering av nøkkel til oppslag mot buntfile:
      *
     c     key10         klist
610  c                   kfld                    rbunlu_nivo
610  c                   kfld                    rbunlu_memb
     c                   kfld                    dsfirm
     c                   kfld                    wpbunt
      *
     c     key10a        klist
610  c                   kfld                    rbunlu_nivo
610  c                   kfld                    rbunlu_memb
     c                   kfld                    dsfirm
      * Definering av nøkkel til oppslag mot faste konti
      *
     c     ra04l1_key    klist
     c                   kfld                    ra04l1_firm
      *
      * Definering av nøkkel til oppslag mot valutakoder
      *
     c     ra16l1_key    klist
     c                   kfld                    ra16l1_firm
     c                   kfld                    ra16l1_pkod
      *
pdf  c                   open      gl115pl
6.16 c                   open      gl115pf
6.12 c                   eval      b_lst1 = *off
6.12 c                   eval      b_lst2 = *off
6.20 c                   eval      w_year = *year
      *
      * Henter record kontoinformasjon.
      *
     c                   move      dsfirm        ra04l1_firm
      *
     c     ra04l1_key    chain     ra04l1
      *
     c                   if        not%found
     c                   move      *on           *in60
     c                   else
     c                   move      *off          *in60
     c                   endif
      *
      * Oppdaterer informasjon om ev. avvikende perioder:
      *
     c                   eval      k = 1
     c     k             do        12            k
     c                   movel     k             ape(k)
     c                   move      uyear         ape(k)
     c                   enddo
      *
      * Beregner forrige år:
      *
03010c                   if        uyear = 00
03010c                   eval      wpyear = 99
03010c                   else
     c                   eval      wpyear = uyear - 1
03010c                   endif
      *
     c                   if        wpyear > 81
     c                   move      1900          ra4aar
     c                   else
     c                   move      2000          ra4aar
     c                   endif
     c                   move      wpyear        ra4aar
      *
      * Henter info om avvikende perioder:
      *
     c     key01         chain     raa3l1                             60
      *
      * Oppdaterer tabell:
      *
     c                   if        ra3p01 <> 0
     c                   movel     ra3p01        ape(1)
     c                   if        ra3p01 > 1
     c                   move      wpyear        ape(1)
     c                   endif
     c                   endif
      *
     c                   if        ra3p02 <> 0
     c                   movel     ra3p02        ape(2)
     c                   if        ra3p02 > 2
     c                   move      wpyear        ape(2)
     c                   endif
     c                   endif
      *
     c                   if        ra3p03 <> 0
     c                   movel     ra3p03        ape(3)
     c                   if        ra3p03 > 3
     c                   move      wpyear        ape(3)
     c                   endif
     c                   endif
      *
     c                   if        ra3p04 <> 0
     c                   movel     ra3p04        ape(4)
     c                   if        ra3p04 > 4
     c                   move      wpyear        ape(4)
     c                   endif
     c                   endif
      *
     c                   if        ra3p05 <> 0
     c                   movel     ra3p05        ape(5)
     c                   if        ra3p05 > 5
     c                   move      wpyear        ape(5)
     c                   endif
     c                   endif
      *
     c                   if        ra3p06 <> 0
     c                   movel     ra3p06        ape(6)
     c                   if        ra3p06 > 6
     c                   move      wpyear        ape(6)
     c                   endif
     c                   endif
      *
     c                   if        ra3p07 <> 0
     c                   movel     ra3p07        ape(7)
     c                   if        ra3p07 > 7
     c                   move      wpyear        ape(7)
     c                   endif
     c                   endif
      *
     c                   if        ra3p08 <> 0
     c                   movel     ra3p08        ape(8)
     c                   if        ra3p08 > 8
     c                   move      wpyear        ape(8)
     c                   endif
     c                   endif
      *
     c                   if        ra3p09 <> 0
     c                   movel     ra3p09        ape(9)
     c                   if        ra3p09 > 9
     c                   move      wpyear        ape(9)
     c                   endif
     c                   endif
      *
     c                   if        ra3p10 <> 0
     c                   movel     ra3p10        ape(10)
     c                   if        ra3p10 > 10
     c                   move      wpyear        ape(10)
     c                   endif
     c                   endif
      *
     c                   if        ra3p11 <> 0
     c                   movel     ra3p11        ape(11)
     c                   if        ra3p11 > 11
     c                   move      wpyear        ape(11)
     c                   endif
     c                   endif
      *
     c                   if        ra3p12 <> 0
     c                   movel     ra3p12        ape(12)
     c                   if        ra3p12 > 12
     c                   move      wpyear        ape(12)
     c                   endif
     c                   endif
      *
      * Sender ventemelding:
      *
     c                   eval      w_arow = 6
     c                   eval      w_acol = 35
      *
     c                   endsr
      *
**
Hele batchen avvist.                                                01
*                                                                   02
*                                                                   03
*                                                                   04
*                                                                   05
*                                                                   06
*                                                                   07
*                                                                   08
*                                                                   09
*                                                                   10
Feil i foretaksnummer.                                              11
Endring/sletting ikke tillatt.                                      12
Totalsum fakturaer/kreditnotaer må ikke være mindre enn 0.          13
Løpenummer finnes ikke.                                             14
Transaksjonstype kan ikke endres i BETFOR21.                        15
*                                                                   16
*                                                                   17
Feil bruk av KID / Ugyldig KID.                                     18
*                                                                   19
Kredit kontonummer ikke gyldig.                                     20
Belastningskontonummer er ugyldig                                   21
Feil i betalingsdato.                                               22
Ref.nummer finnes ikke, eller er ugyldig.                           23
*                                                                   24
*                                                                   25
Utløpt passord.  (Passord er for gammelt).                          26
Operatør er sperret.                                                27
Feil passord.                                                       28
Operatør er ikke autorisert.                                        29
Ugyldig operatørnummer.                                             30
Ugyldig versjonsnummer i BETFOR00.                                  31
*                                                                   32
*                                                                   33
*                                                                   34
Feil i navn / adresse felt.                                         35
Feil valutasort.                                                    36
Feil i avtalt kurs / terminkurs.                                    37
*                                                                   38
*                                                                   39
*                                                                   40
*                                                                   41
Feil i betalingsartkode.                                            42
*                                                                   43
*                                                                   44
Feil i mottakers landkode.                                          45
*                                                                   46
*                                                                   47
*                                                                   48
*                                                                   49
*                                                                   50
*                                                                   51
*                                                                   52
*                                                                   53
*                                                                   54
*                                                                   55
*                                                                   56
*                                                                   57
*                                                                   58
*                                                                   59
*                                                                   60
*                                                                   61
*                                                                   62
*                                                                   63
*                                                                   64
*                                                                   65
*                                                                   66
*                                                                   67
*                                                                   68
*                                                                   69
*                                                                   70
*                                                                   71
*                                                                   72
*                                                                   73
*                                                                   74
*                                                                   75
*                                                                   76
*                                                                   77
*                                                                   78
*                                                                   79
*                                                                   80
Feil i sekvenskontrollfelt.                                         81
Feil oppbygd batch.                                                 82
Ugyldig transaksjonskode.                                           83
Seglfeil.                                                           84
*                                                                   85
*                                                                   86
*                                                                   87
*                                                                   88
*                                                                   89
Summeringsfeil av antall transaksjoner innenfor batch (BETFOR99).   90
Sekvensfeil i AH-sekvens (applikasjonsheader).                      91
Ukjent AH-RUTINE-ID.                                                92
Feil i AH-TRANS-DATO.                                               93
*                                                                   94
*                                                                   95
Ugyldig divisjon.                                                   96
*                                                                   97
* KID ER IKKE UTFYLT *                                              98
* MOTTATT TIDLIGERE *                                               99
*                                                                   100
**
USD
DEM
SEK
DKK
NLG
BEF
GBP
CHF
FRF
ITL
JPY
ATS
FIM
CAD
ESP
PTE
ISK
IEP
GRD
ECU
SDR
AUD
HKD
INR
SGD
EUR
*
*
*
*
**
1  USD
100DEM
100SEK
100DKK
100NLG
100BEF ?
1  GBP
100CHF
100FRF
100ITL
100JPY
100ATS
100FIM
1  CAD
100ESP
1  PTE
1  ISK
1  IEP
1  GRD
1  ECU
1  SDR
   AUD  ?
   HKD  ?
   INR  ?
   SGD  ?
1  EUR
*
*
*
*
