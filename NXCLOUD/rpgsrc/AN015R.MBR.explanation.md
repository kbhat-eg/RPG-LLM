# RPG Program AN015R: Explanation

This source code is for an RPG (Report Program Generator) program called **AN015R**. The overall purpose of this program is to **generate a night routine backup by dynamically composing a CL program**, reflecting parameters such as backup destination (tape or save file) and backup density. The code is annotated with Norwegian comments and documentation.

---

## 1. **Header and Documentation**

- `h option(*nodebugio) datedit(*dmy)`: Specifies compile options—no debug I/O, and date editing is day/month/year.
- The block of comments provides **change history**, program description (“generering av nattrutine, backup”—generating night routine, backup), and notes about functional revisions.

---

## 2. **File and Table Definitions**

- `fqcllesrc  o  a f  096        disk`: Output file definition, likely used to write out the dynamically generated CL program.

- **Table (Array) Definitions:**
    - `rec s 80 dim(31) ctdata perrcd(1)`: An array of 31, 80-character records, loaded from compile-time data (represents lines of the CL program to output).
    - `fra s 1 dim(10)`, `til s 1 dim(84)`: Helper arrays for character manipulation.

---

## 3. **Data Structures**

- **Date Data Structure:**  
  Used for extracting year, month, and day from a 6-digit date.
    ```rpg
    d                 ds
    d d_dato                         6  0
    d  d_aaar                        2  0 overlay(d_dato)
    d  d_mmnd                        2  0 overlay(d_dato:3)
    d  d_ddag                        2  0 overlay(d_dato:5)
    ```

- **Local Data Area:**  
  128-character work area, with overlays to access specific fields.
    ```rpg
    d                 ds
    d d_valg                       128
    d  d_time                        6  0 overlay(d_valg)
    d  d_dens                       11    overlay(d_valg:7)
    d  d_rorg                        1    overlay(d_valg:18)
    ...
    d  d_savf                        1    overlay(d_valg:24)  // Save file flag
    ...
    ```

---

## 4. **Variables**

- Working variables: `n, w_dato, w_recc, w_tell, x, y, z`.
- `p_valg`: 128-character input parameter, passed in at program start.

---

## 5. **Program Execution Logic**

### **A. Initialization**

- In the `*inzsr` subroutine, working variables and dates are initialized from the system date.
- The input parameter (`p_valg`) is loaded into `d_valg`, thus parsing out the individual selection flags (like density, save file option, etc.).

### **B. Outputting CL Program Steps**

The core logic is a sequence of output operations to the CL source file, based on the parameter choices.

#### **i. Output Initial CL Lines**
```rpg
for n = 1 to 4
    add 100 to w_tell
    movel rec(n) to w_recc
    except xrecut     // Output the CL line
endfor
```
- The first four lines of the CL program template are copied out.

#### **ii. Output Save File Parameter Line**
```rpg
if d_savf = ' '      // No save file, output standard line
    movel rec(5) to w_recc
    except xrecut
endif
if d_savf = '1'      // Backup to save file and tape
    movel rec(6) to w_recc
    except xrecut
endif
if d_savf = '2'      // Backup to save file only (no tape)
    movel rec(7) to w_recc
    except xrecut
endif
```
- Which line to output depends on the save file flag.

#### **iii. Outputing the Density (DENS) Parameter**
- Calls subroutine `xdensi` to edit and output the line which sets the density value in the CL script.
- The subroutine finds the first non-blank characters in the density field, picks the template record with the right number of blanks, and merges the non-blank density value into it before output.

#### **iv. Output Later Sections of the CL Template**
```rpg
for n = 12 to 18
    add 100 to w_tell
    movel rec(n) to w_recc
    except xrecut
endfor
```
- Lines 12–18 (middle section) are always output.

#### **v. Optional Section Based on Savefile Selection**
- Lines 19–25 output only **if savefile is not '2'** (i.e., if you are not only saving to a save file).
- This logic is presently commented out (`*Sper`), indicating that saving to save file only is not currently implemented for this section.

#### **vi. Final (footer) Section**
```rpg
for n = 26 to 31
    add 100 to w_tell
    movel rec(n) to w_recc
    except xrecut
endfor
```
- Outputs the last CL commands (usually, program end).

---

### **C. Subroutines**

#### **xdensi** (Set DENSITY in CL Script)
- **Purpose:** Finds the correct CL line template for DENSITY (lines 8–11), based on the length of the non-blank density string.
- It overlays the user-supplied density value into the correct template, then outputs the completed CL command.

#### **\*inzsr** (Initialization)
- **Purpose:** Initializes all working variables and parses the date and input parameter.

---

## 6. **Exception Output Specification**

- The `EXCEPT xrecut` statement refers to the output specification, which writes:
    - `w_recc` (the CL line, up to 96 chars)
    - `w_tell` (6 digits, probably a line counter or marker)
    - `w_dato` (the date, padded to 12 chars)

---

## 7. **Compile-Time CL Template**

- The records for the `rec` array are provided at the end as a compile-time data block (`**` indicates start of CTDATA).
- These represent the skeleton CL program to produce, with numbered lines corresponding to indices in `rec()`.
- Lines 5–7 are `CHGVAR VAR(&SAVF) VALUE('X')` depending on savefile option.
- Lines 8–11 are for DENS (CHGVAR VAR(&DENS)), with varying numbers of blanks to be replaced by actual density.
- The rest are CL commands for the backup process.

---

## 8. **Summary of Operation**

### **What does this program do?**

1. **Reads user choices** (parameters about backup modes/flags).
2. **Dynamically generates a CL program** (command language script) for backup, adjusting the output based on user-provided flags (particularly for save file usage and backup density).
3. **Outputs the CL script line by line** into a member or source file (`qcllesrc`), so it can be later executed as part of the backup routine.

---

## 9. **Key Decision Points**

- **Savefile (d_savf) logic:** Determines which lines for savefile handling are included.
- **Backup Density:** Customizes the DENS parameter line in the output CL script.
- **Section inclusion/exclusion:** Certain sections of the template are conditionally outputted based on parameters.

---

## 10. **Why is this useful?**

- **Parameterizes and automates** the nightly backup operations,
- **Abstracts CL script generation,** so changes or customizations can be applied by updating parameters instead of manually editing scripts,
- Optimizes IBM i operations for environments with complex or configurable backup needs.

---

### **Onboarding Tips**

- **Understand the structure of the CL template** (lines in `rec()` and which fields are replaced on-the-fly).
- **Key parameters** for customization are all in `d_valg` (especially `d_savf` for savefile, and `d_dens` for density).
- **Any change to the backup process** (e.g., adding new tape devices, modifying backup libraries) can often be accommodated by adjusting the `rec()` array or input parameter structure.

---

## **In summary**

- This RPG program builds a custom CL script for backups.
- It is highly parameterized—behavior changes based on flags in the input.
- It uses classic RPG IV style arrays, overlays, and manual string manipulation to construct the final output.

---

**Let me know if you’d like a visual flowchart or deeper dive into any particular section!**