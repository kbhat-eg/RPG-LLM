# RPG Program JM730R – Code Explanation

This RPG program, **JM730R**, is designed to process, update, and create campaign data in an IBM i (AS/400) environment. It reads data from an XML file, parses campaign and item information, and updates two main *physical files*: the campaign header and campaign item files. The context is Norgros/NIB campaigns (which are vendor/distributor campaigns in Norway, thus some Norwegian variable names). The code is written in ILE RPG (RPG IV) using the traditional fixed format.

Below, you'll find a high-level walkthrough and a breakdown of key areas in the source.

---

## 1. **Header and Documentation**

- **Program Name**: JM730R
- **Purpose**: Import and update campaigns ("kampanje") and their lines (items) from an XML format originating from Norgros/NIB.
- **Documentation**: Provided in Norwegian, with version history and change references (line numbers with version numbers, e.g., 6.34).

---

## 2. **Files / Tables Declaration**

- **nxkapf**: Input XML campaign file (UF – update, full procedural file, keyed disk).
- **jvarl3**: Item (product) master file (IF – input, keyed disk), renamed in program.
- **jkahlu**: Campaign header file (UF – update, keyed disk), renamed.
- **jkavlu**: Campaign item file (UF – update, keyed disk), renamed.
- **jstsl1**: Status/reference file (IF – input, keyed disk), renamed.

---

## 3. **Data Structure and Variable Declarations**

### **a. Parameters and Local Data Area**

- **p_firm**: The company/firm number (numeric 3,0).
- **l_user**: The user name from the User Data Section (UDS).

### **b. Campaign Header Data Structure (`d_hrec`)**

Structured as a 120-byte field with **overlayed fields** representing various XML values:
- **d_kamp**: Campaign identifier.
- **d_besk**: Campaign description.
- **d_fdat, d_tdat**: From and to dates.
- **d_ansv**: Responsible person.
- **d_beda**: Order date.
- **d_spda**: Blocked date.
- **d_pala**: Flag, etc.
- ISO date overlays are used for date conversions.

### **c. Campaign Item Data Structure (`d_vrec`)**

Structured as a 260-byte field with overlays for:
- **d_vare**: Item number (NIB).
- **d_nobb**: NOBB item number (numeric).
- **d_vtxt**: Item text.
- **d_levn**: Supplier number.
- **d_inkp, d_salp, d_palp**: Purchase, sales, and imposed prices (each split into kroner and øre).
- **d_bsen, d_lbet, d_anmk**: Central warehouse flag, delivery terms, and remarks.
- **d_bedf**: Order date at item line level (newer addition).

### **d. Control and Working Variables**

- Various flags (`b_ny`, `b_kfel`, `b_kild`, etc.) control logic flow.
- String work fields for XML parsing and text translation.
- Key fields for efficient database access.

---

## 4. **Constants**

- XML tags (e.g., `<Kampanje>`, `<Navn>`, etc.) are defined as program constants.
- Translation constants for XML-escape sequence handling.
- Numeric and price formatting constants.

---

## 5. **Main Program Logic**

### **a. Initialization (`*inzsr`)**

- Receives company number (`p_firm`) as parameter.
- Sets up key lists for the database files.
- Reads company information from status/reference table.

### **b. Main Reading Loop**

- Reads the XML file (`nxkapfr`); each record is (presumably) an XML element or tag.
- **Detects the sender/source** by searching for `<Kilde>` and sets a flag if the source matches expected (e.g., NIB).
- When a `<Kampanje>` tag is detected, it starts processing a campaign via `exsr beh_kamp`.

### **c. Campaign Processing (`beh_kamp`)**

- Initializes campaign data fields.
- Loops through subsequent XML lines belonging to the campaign.
- Identifies and processes embedded `<Vare>` (item) elements via its own routine.
- For each recognized campaign field, calls the corresponding subroutine to handle and store field values.
- At the end of the campaign element (`</Kampanje>`), writes or updates the campaign header depending on whether it's new (`b_ny` flag).

### **d. Campaign Item Processing (`beh_vare`)**

- Initializes item data fields.
- Loops through lines belonging to the item.
- For each field, calls the appropriate subroutine to decode/store values.
- At the end of the item element (`</Vare>`), completes the lookup/insert/update logic:
  - Looks up product information by NOBB number.
  - Looks up existing campaign lines and either updates or inserts a new line as needed.

---

## 6. **Subroutines Overview**

### **a. Field Extraction Subroutines**

Each XML tag has its own handler:
- **uttr_navn**: Campaign Name.
- **uttr_besk**: Description.
- **uttr_fdat**: From-date.
- **uttr_tdat**: To-date.
- **uttr_ansv**: Responsible.
- **uttr_bdat**: Order date.
- and similar for item-level fields.

**Function**: These subroutines extract data, de-escape text, convert numeric/date fields, and store results in the working data structures.

### **b. Creation/Update Routines**

- **skr_kamp**: Writes a new campaign header.
- **upd_kamp**: Updates an existing campaign header.
- **skr_vare**: Writes a new campaign item.
- **opd_vare**: Updates an existing campaign item.

**Function**: Move data from work structures to file buffers, perform time-stamping, handle supplier corrections, and commit changes.

### **c. Lookup Routines**

- **sjekk_kamp**: Checks if the campaign exists in the header file, sets new/existing flag.
- **konv_XML_esc**: Converts XML-escaped sequences (like `&amp;`, `&lt;`, etc.) to plain text in string fields.

---

## 7. **Special Handling and Business Rules**

- **Supplier Correction**: If supplier number is `212588`, it is replaced with `214384` (based on a customer-specific rule).
- **Date Adjustments**: Some date fields are calculated (e.g., `adddur` is used to add days to dates, e.g., to calculate valid-to date).
- **Error/Validity Flags**: Control fields such as `b_kfel` and `b_ny` ensure that only valid, new data is written, and that errors are detected early.

---

## 8. **Comments, Version History, and Change Notes**

The program maintains **inline historical comments** (with version numbers) to explain why certain changes were made, particularly in the handling of new fields, business rules, or bug fixes.

---

## 9. **Summary of Data Flow**

1. **Program starts and initializes.**
2. **Reads company parameter.**
3. **Parses XML file line by line.**
4. **Detects sender/source; processes only if valid.**
5. **For each `<Kampanje>` block:**
   - Extracts campaign info.
   - For each `<Vare>` inside the campaign:
     - Extracts item info.
     - Looks up/updates/creates campaign item line.
   - At campaign end, updates or creates campaign header.
6. **Main loop continues until XML file is exhausted.**
7. **Program ends.**

---

## 10. **Additional Technical Notes**

- **Overlay** (`overlay`) and **ISO date** (`datfmt(*iso)`) attributes are used to minimize storage and facilitate conversion.
- **Key lists** (`klist`) are set up for efficient file access using keys.
- **De-escaping** of XML text fields is handled in a custom subroutine.
- **Use of indicators** like `*on`, `*off` to control procedural logic.
- **File operations**: `read`, `chain`, `update`, `write`, `delete` are used to manage database records.

---

## 11. **Conclusion**

This program is a custom batch job that automates the import of campaign and campaign line data from an XML file into an IBM i DB2 database, applying several business rules and handling data validation and transformation in the process. It shows advanced use of RPG IV constructs (e.g., data structures, overlays, subroutines, and key-based file I/O).

**Tip for Onboarding:** If you need to modify or extend this program:
- Study the XML structure and corresponding data structures in the code.
- Pay attention to version comments for business rule context.
- Test changes with sample XML and observe database file updates.
- Use modern RPG (free-format) for new code if possible for maintainability.