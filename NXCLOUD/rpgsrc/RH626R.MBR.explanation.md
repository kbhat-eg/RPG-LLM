# Explanation of RPG Source Code: RH626R

This RPG (Report Program Generator) program, named **RH626R**, is designed to process user input for printing a “cost carrier” report (kostnadsbærerrapport) based on a variety of parameters, such as date, period, account, department, cost carrier, and groups thereof.

The program is written in ILE RPG (RPG IV, or "ILE RPG/400"), using fixed-format specifications.

## High-Level Overview

- The program presents a screen to the user to gather report parameters.
- It processes and validates the input, providing lookup capabilities (e.g., searching for cost carriers, accounts, departments, etc.).
- Once parameters are validated, they are stored for later use (presumably by a report generation step).

---

## Main Sections of the Source Code

### 1. Header & Comments

- Numerous descriptive comments (in Norwegian) provide a change log, versioning, and explanation of indicator usage.
- Indicators (e.g., *INLR, *INKC) are used throughout for program control and feedback to the user.

### 2. File Declaration

```rpg
frh626d    cf   e             workstn
```
This defines a workstation file (likely a display file) for the interactive session.

---

### 3. Data Declarations (`D-specs`)

Variables are declared for holding parameters, temporary fields, and work fields, including user and firm information, dates, report ranges, etc.

**Examples:**
```rpg
d rhpkda                300    305  0      // Report date
d rhprår                         4  0      // Fiscal year
d rhpper                         2  0      // Period
d ... (others for account, department, etc.)
```
- Many variables are named according to the data they store: "rh" prefix for report handling, "a2" for screen variables, "w" for working variables, "p_" for temporary parameter transfer variables, etc.

---

### 4. Main Processing Loop & Screen Handling

#### a. Entry and Main Screen

The entry point calls a display format (`exfmt a2bld`) to present the parameter selection screen to the user.

#### b. Exit Handling

If the user presses F3 (*INKC is *ON), the program sets an exit indicator, jumps to the end (`goto xslutt`), and ends.

#### c. Indicator Resets

After each screen input, indicators 40–47 are reset to off, clearing error states before new input is processed.

#### d. Lookup (Inquiry) Operations

If the user requests a lookup (usually by pressing a function key), the program checks which field is active (by `wactfe` value) and calls the appropriate subprogram for selection:

- **Cost carrier (`A2PBØF` and `A2PBØT`)**: Calls `RA528R`
- **Cost carrier group (`A2PBØF` and `A2PBØT`)**: Calls `RA527R`
- **Account (`A2PKTF` and `A2PKTT`)**: Calls `RH500R`
- **Department (`A2PAVF` and `A2PAVT`)**: Calls `RA507R`

Each call passes parameters (firm, code, text) and receives a selected value.

#### e. Range Checks and Validations

- Ensures that "from" values are not higher than "to" values for department, cost carrier, cost carrier group, and account.
- Checks validity of the report date (`a2pkda`), using the current date if not entered.
- Checks the fiscal year (`a2prår`) is not greater than the system year.
- Checks the input period range is consistent.

If any check fails, the corresponding indicator (31–37) is set *ON, and the user is sent back to the screen for corrections.

#### f. Parameter Assignment

If all input is valid, user entries from the screen are copied to report parameter fields (`rhp...` variables).

---

### 5. Program Exit

When complete or the user chooses to exit, *INLR is set *ON (end of program), and a RETURN is executed.

---

### 6. Initialization Subroutine (`*INZSR`)

This special subroutine runs at program initialization and:

- Sets work fields to initial (zero or blank) values.
- Loads user and firm info from input fields.
- Sets parameter ranges to their defaults (e.g., 9999 for "to" values).
- Sets default values for group switches and date.
- Computes the default period (previous month, adjusting the year if needed).

Parameter entry variable (`wpin03`) is also initialized.

The program expects its primary parameter (`wpin03`) to be passed on program entry.

---

## Key Concepts

- **Indicators**: RPG uses numbered indicators for logic control, error reporting, and screen handling. *INLR ends the program, *INKC signals exit, etc.
- **Screen File (`workstn`)**: Handles user interaction.
- **Lookup Programs (`RA528R`, etc.)**: Called to perform record selection for specific fields.
- **PLIST/Parameter List**: The entry parameters are managed via a parameter list.
- **Validation**: Multiple checks prevent invalid input scenarios, with immediate user feedback.

---

## Typical Flow

1. **Program starts, initializes variables.**
2. **User presented with the selection screen.**
3. **User enters parameter ranges and optional inquiries (lookups).**
4. **Lookups are serviced by external programs if requested.**
5. **Input is validated; errors sent back to the screen with messages.**
6. **Valid parameters are stored for report generation.**
7. **User exits or program ends.**

---

## Example: Account Lookup and Validation

```rpg
c if *inkd = *on and wactfe = 'A2PKTF'
c  call     'RH500R'
c  parm      w_firm   info
c  parm      p_kont   info
c  parm      p_spes   info
c  parm      p_avde   info
c  parm      p_text   info
c  if        p_kont <> *zero
C   eval      *in45 = *on
c   move      p_kont   a2pktf
c  endif
c  goto      a2tagb
c endif
```

- If inquiry mode active and "from account" field selected, calls `RH500R` to let the user pick an account.
- Receives the selected account in `p_kont` and updates the screen variable accordingly.

---

## Error Handling Example

```rpg
c if a2pavf > a2pavt
c   eval *in31 = *on
c   goto a2taga
c endif
```
- If the "from department" is greater than the "to department," sets error indicator 31 and loops back to input.

---

## Summary

This program ensures that users can safely and efficiently enter selection criteria for a cost carrier report, with robust input validation, lookup functionality, and error feedback, in a classic IBM i workstation environment. It includes legacy RPG idioms (indicators, tags, `goto`, external subroutines, and CALL/PARM passing) that are common in traditional IBM i business applications.