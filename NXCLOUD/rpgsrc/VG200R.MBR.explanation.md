# Documentation of Program VG200R (Average Cost Price per Item and Warehouse)

This RPG program (VG200R) manages the average item cost price records per warehouse. It displays and maintains these records through a subfile interface and supports navigation, editing, and historical tracking of cost price changes. Below is an overview of its structure, purpose, and domain-specific logic.

---

## Purpose and High-Level Flow

1. The program retrieves firm (company) information from the Local Data Area (LDA) and sets up workspace variables for warehouse (lage), user, and item references.  
2. A subfile (B1SFL) is used to list cost price records for items in a specified warehouse.  
3. The user can search for items (via external call “VV500R”), search for warehouses (via “RA510R”), update cost prices, or view cost price history (“VG201R”).  
4. When a cost price is changed, the program creates a history entry (marked with “H”) for the old record.  
5. Additional functionality includes editing cost price factors through “VG220R”.

---

## Key Domain Objects

- **Cost Price Files**:  
  - VGKPI1 / VGKPIR / VGKPIU: These appear to be variations of the same physical file or related logical files for reading, writing, and updating cost price records. They store fields like item number (vgvare), warehouse (vglage), and cost price (vgcost).  
  - VGKKIR: Holds parameters or default values for cost price handling, e.g., certain flags that indicate whether cost price logs should be kept.

- **Item Master (VVARL1)**: Referenced to fetch supplementary item data such as descriptive text (vvtek1) or unit of measure (vvenhl).

- **Screen Files**:  
  - VG200D defines the display file containing subfile records (B1SFL) and control screens (B2CTL, B2CMD, etc.).  
  - Subfile control and subfile records are manipulated by routines that write or clear records (e.g., CLR_SUBFILE, CRT_SUBFILE).

- **Additional Tools/Programs**:  
  - “VV500R” is invoked to search for items externally.  
  - “RA510R” is invoked to search for warehouses.  
  - “VG201R” is invoked to display cost price history for a chosen item/warehouse.  
  - “VG220R” is invoked for cost price factor maintenance.

---

## Structure and Key Logic

### Initialization (∗INZSR)  
- Loads firm data (w_firm) from LDA.  
- Initializes keys (klist definitions) for cost price files and item register.  
- Positions on the cost price file (VGKPI1) using a null/blank entry as a starting point.  
- Calls CRT_SUBFILE to build an initial subfile view of cost prices.

### Main Label (B2TAGA / B2TAGB)  
The main processing loop does the following:  
1. Writes a command screen (B2CMD).  
2. Calls DSP_SUBFILE to manage the subfile display.  
3. Handles function keys (e.g., F3/F12 for exit, F4 for search, F5/F6 for different actions like editing item cost), as well as page-forward and page-back keys (IN10, IN11).  
4. Positions the file read (POSISJONER) if the user enters an item or warehouse code.  
5. Calls the SUBFILE routine to handle read/update logic for subfile records.

### Subfile Operations

1. **CLR_SUBFILE**  
   - Clears the subfile (B1SFL) by setting indicators (IN14, IN15) and resets record counters (w_srrn, w_sfrn, etc.).

2. **CRT_SUBFILE**  
   - Reads the VGKPI1 file to fill the subfile.  
   - Filters out records not matching the firm (vgfirm) or current warehouse (vglage).  
   - Loads item text from VVARL1 (LES_VARE).  
   - Displays cost price data for each row until the page limit (c_sfil) or end-of-file.

3. **BCK_SUBFILE**  
   - Reads backward (READP) to populate a previous page of records in the subfile.  
   - Resets the subfile and calls CRT_SUBFILE again to display the newly loaded data.

4. **DSP_SUBFILE**  
   - Displays the subfile control record (B2CTL) or the command screen, enabling subfile actions or function key processing.

### Editing and Viewing Cost Prices

1. **XC2BLD** (New/Edit/View Screen – C2BLD)  
   - Chains the cost price file (VGKPIR) to load an existing record. If found, preloads fields like cost price, unit, etc.  
   - If the user wants to modify the cost price, “B1VALG=2,” the record is opened for edit. The program requires a non-zero cost price and valid date (c2gdat).  
   - Updates are written to VGKPIU. If an existing record is found, it first moves that record into history (PRIS_HIST).  

2. **PRIS_HIST**  
   - Copies the existing cost price record to a history record (marked by “H”) before writing the updated cost price.

3. **VIS_HISTORIKK**  
   - Calls “VG201R” to show detailed historical changes for a selected item and warehouse.

4. **KP_FAKT**  
   - Calls “VG220R” for adjusting cost price calculation factors.

---

## Notable Design and Conventions

- **Historic Tracking**: Before updating a record, the code makes a copy in historical form (hence “H” in vghkod). This allows traceability of cost price changes over time.  
- **Subfile Paging**: The program uses chunked reads (c_sfil = 14 records per “page”) and maintains page counters for forward/backward navigation.  
- **External Searches**: Calls (VV500R, RA510R) allow the user to look up item and warehouse data outside this module’s scope, keeping search logic encapsulated.  
- **Indicators**: This code uses manual indicators (INxx) for common display actions like clearing subfiles (IN14), paging up/down (IN10/IN11), or setting protective fields (IN30). Many are conventional, but keep an eye on the specific usage in each subroutine.  
- **Local Data Area (LDA)**: Used for capturing user (l_user) and firm (l_firm) context at the start. The w_firm variable is set from the LDA, linking all cost price file reads to the correct firm record.

---

## Relationships with Other Modules

- **VV500R**: Item search. Returns item number (w_vare) and partial descriptive text (w_tek1).  
- **RA510R**: Warehouse search (w_lage, w_ltek).  
- **VG201R**: Displays cost price history for an item/warehouse combination.  
- **VG220R**: Maintains cost price factors (e.g., overhead or additional cost calculation logic).

---

## Summary

Program VG200R focuses on the maintenance and display of cost price data per item and warehouse. It relies on subfiles for listing and navigation and uses external calls to handle searches and related cost price functions. Historical changes are preserved by creating “H” records whenever a cost price is updated, ensuring comprehensive tracking of cost price evolution over time.