# RPG Program JV190R Explanation

This ILE RPG program is called `JV190R`, running on IBM i (AS/400) and is used for "Vare Egenskap, spøring" — which means "Item Property, Inquiry". It uses traditional fixed-format RPG and operates primarily with subfiles for display and user interaction.

---

## 1. **Header and Documentation**
- The `H` spec sets program options, including date editing and disables debug I/O.
- The extensive comments explain:
  - Author, date, and history of changes.
  - Which indicators are used for what (see "Bruk av indikatorer").
    - Example: *INLR = program exit, *IN10 = Rollup, *IN14 = Subfile clear, etc.

---

## 2. **File Definitions**
- **Physical Files:**
  - `JVARL3` (`jvarpfr`): Item master or similar main file.
  - `JVEGI1` (`jvegst`): Possibly item property details.

- **Display File:**
  - `JV190D`: Workstation file with subfiles; contains SFL, control, command, and window records.
  - The InfDS `dspfbk` is used for display file feedback (cursor location, etc.).

---

## 3. **Data Structures and Variables**
- **LDA (Local Data Area) mapping**: Variables read from the LDA (for user, firm, etc.).
- **Display feedback DS**: For capturing screen feedback like cursor row.
- **Work variables**:
  - Counters for subfile handling: page sizes, record numbers, etc.
  - Flags for different program states.
  - Buffers for item and property keys and descriptions.
- **Constants**:
  - `c_sfil`: Used as subfile page length, set to 13.

---

## 4. **Subfiles and Screen Design**
- Subfile record layouts:
  - `B1SFL`, `B2CTL`, `B2CMD` for main subfile, control, and command entry.
  - Other screens for data entry and windows for editing, copying, deleting, etc.
- The comments provide a mapping between RPG indicators and screen logic.

---

## 5. **Mainline Logic**
The program's execution revolves around a main tag/dispatch loop, using `GOTO` and subroutines much like an old event loop. The sequence is:

### **Startup (`*INZSR`)**
- Entry parameter `p_wnob` (item number) is loaded.
- Initializes key fields and retrieves main item info.
- Sets up subfile contents for the given item.

---

### **Main Display and User Loop**
- **Main Loop Entry Point (`b2taga`):**
  - Shows CMD screen (`b2cmd`).
- **Data Display (`b2tagb`):**
  - Calls `dsp_subfile` to show subfile on screen.
- **Function Key Handling:**
  - Checks indicators (function keys) to determine user actions:
    - Exit: `*INKC` or `*INKL`
    - Refresh: `*INKE` → `forny` (refresh subfile)
    - Rollup: `*IN10` → next page `crt_subfile`
    - Rolldown: `*IN11` → previous page `bck_subfile`
    - Home: `*IN21` (sets cursor placement)
  - After processing, returns to appropriate tag.
- **Positioning and Subfile Processing:**
  - If positioned (`b2wgui` not blank), goes to `posisjoner` subroutine, then refreshes display.
  - Otherwise, runs `subfile` subroutine for main processing of subfile rows.

---

### **Ending the Program**
- Tag `avslutt`: sets *INLR on, returns.

---

## 6. **Subroutines Overview**

### **forny** — Refresh Subfile

- If a page is active, chains to the current subfile.
- Positions the database to correct spot.
- Clears and rebuilds subfile.

### **posisjoner** — Position in Subfile

- If user provides a key to jump to, positions file accordingly.
- Clears and refills subfile from this position.
- Blanks positioning field post-processing.

### **subfile** — Process Subfile Entries

- Toggles a flag for refresh.
- Reads through current records in the subfile, allowing selection/actions on records.
- If a record is selected for view (`b1valg = 5`), launches view (`xc2bld`).

### **xc2bld** — Show/Edit/View Screen

- Displays a detail screen for a subfile entry.
- Loads item property details and sets up fields for display.
- Breaks long description into four fields (`c2wnav1..4`) for screen show.

### **clr_subfile** — Clear the Subfile

- Sets indicator to clear subfile and writes the subfile control record.

### **crt_subfile** — Fill the Subfile (Next Page)

- Reads the next set of records from the detail file into the subfile, up to the subfile page length.
- Stops if EOF or item number changes.
- Updates record counters and markers.

### **bck_subfile** — Back a Page

- Reads back one page in the detail file.
- Repositions file pointer, clears and fills subfile page with previous set of records.

### **dsp_subfile** — Display Subfile

- If there are subfile records, sets indicator to show the subfile; otherwise shows CMD screen.
- Reads cursor position after display.

---

## 7. **Initialization (`*INZSR`)**
- Loads parameter, retrieves master item, initializes subfile keys.
- Fills subfile with matching item properties for display.

---

## 8. **Key Concepts in This Program**
- **Subfiles**: Used for scrolling/inquiry over lists of item properties (paging logic present).
- **Indicators**: Control most of the screen and subfile logic.
- **Subroutines**: Modular blocks for each major function: filling, clearing, viewing, paging, etc.
- **Navigation**: Paging logic for next/previous page of subfile using rollup/rolldown keys.

---

## 9. **Main Data Flow**
1. **Startup**: Gets item number via parameter, loads details, fills subfile.
2. **Display Loop**: Shows subfile, reacts to user key (paging, select for view, refresh, exit).
3. **Paging**: Loads next/previous page of subfile on rollup/rolldown.
4. **Selection**: If user selects a property (`b1valg = 5`), shows detail screen.
5. **Exit**: User presses exit keys, program ends.

---

## 10. **Typical User Experience**
- User runs program with an item number.
- Sees a list (subfile) of properties for that item.
- Can page through the list, select a property to view details in a detail screen.
- Can refresh/reposition the list, or exit the program.

---

## 11. **Tips for Maintenance and Onboarding**
- **Indicator usage** is central; refer to comments for meanings.
- All subfile logic is in dedicated subroutines (paging, filling, clearing).
- File layouts and display formats are defined externally, so check `JV190D`, `JVARL3`, `JVEGI1` DDS for field details.
- The code can be migrated or modernized using RPG IV/free format for clarity, but current logic is classic fixed-format style.
- Error handling is minimal/implicit, be mindful when modifying database interaction.
- **Key lists** (`klist`) define composite keys for chain/setll – maintain these with DB schema changes.

---

**In summary:**  
This RPG program is a classic AS/400 inquiry screen for item properties using subfiles, with support for positioning, paging, and viewing detailed property records. It is driven by user interaction with function keys and relies heavily on indicators and subroutines for UI and data navigation logic.