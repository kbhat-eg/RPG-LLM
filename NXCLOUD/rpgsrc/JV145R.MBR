     h option(*nodebugio) datedit(*dmy)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : JV145R
      * Beskrivelse . . : Va info, kalk av kostpris
      *
      * Spesialversjon. : Nytt program 17.02.11   NHO
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
6.30  * 6.30  270314 bof  feilretting + test om varepris VA er utgått
6.31  * 6.30  140714 bof  Bruker dagens dato for å hente riktig pris
6.3x  * 6.30  040615 bof  utvidet parm i forb. med prgr. på betingelse
6.32  * 6.30  130416 bsa  Mangler parametre i lista til JV750R.
6.33  * 6.30  140416 bsa  Lev.varenr er utvidet fra 15 til 20 pos.
6.34  * 6.30  070715 bof  Feilretting vedr. leverandørnr.
6.35  * 6.30  020816 bof  Feilretting vedr. test på til prisdato.
6.36  * 6.30  030816 bof  Skal bruke innkjøpspris(1) i innkjøpspris
6.37  * 6.30  221118 bof  Utvidet med logistikk-vare
      *
8.01  *       080223 bof  Feilretting vedr. hva som vises av enheter og omregn.
8.02  *       130223 bof  Utvidet med innkjøpspris 2 og frakt.faktor i bildet
8.03  *PRG2   150622 BOF  Utvidet prisgruppe fra 1 til 2 posisjoner
8.03  *PRG2   210324 BOF  Tilpasse parameter til jv750r (prisgr.)
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     fjv145d    cf   e             workstn
     fjvarl1    if   e           k disk    rename(jvarpfr:jvarl1r)
     fjlevl3    if   e           k disk    rename(jlevpfr:jlevl3r)
     fjvdtl1    if   e           k disk    rename(jvdtpfr:jvdtl1r)
     fjvprl1    if   e           k disk    rename(jvprpfr:jvprl1r)
      *
      * Definering av parametre
      *
     d p_firm          s                   like(jvdfir)
     d p_vare          s                   like(jvvare)
     d p_lety          s              1  0
8.03 d p_prgr          s              2
     d p_dato          s                   like(jvedat)
     d p_ldor          s                   like(jvldor)
      *
     d                uds
     d l_firm                944    946  0
     d l_user                911    920
     d l_fnav                951    980
      *
      * Definering av variable
     d jlevl3_enum     s                   like(jlenum)
     d jvprl1_vare     s                   like(jxvare)
     d jvprl1_ldor     s                   like(jxldor)
      *
     d w_grpr          s              9  2
     d w_enhe          s              3
     d w_enh1          s              3
     d w_enh2          s              3
     d w_enh3          s              3
     d w_eni1          s              3
     d w_eni2          s              3
     d w_eni3          s              3
     d w_enp1          s              3
     d w_enp2          s              3
     d w_enp3          s              3
     d w_ofp1          s             12  6
     d w_ofp2          s             12  6
     d w_ofp3          s             12  6
     d w_ofv2          s             12  6
     d w_ofv3          s             12  6
     d w_ofi1          s             12  6
     d w_ofi2          s             12  6
     d w_ofi3          s             12  6
     d w_bldo          s              6  0
     d w_bogr          s              2  0
     d w_bhgr          s              2  0
     d w_bugr          s              3  0
     d w_bmod          s              8  0
     d w_bvar          s             15
     d w_bvty          s              1
     d w_blet          s              1  0
     d w_bbet          s             35
     d w_ntpr          s              8  2
     d w_ifak          s              8  6
     d w_pogr          s              2  0
     d w_phgr          s              2  0
     d w_pugr          s              3  0
     d w_pldo          s              6  0
     d w_pmod          s              8  0
     d w_pvar          s             15
     d w_ppko          s              1
     d w_pvty          s              1
     d w_plet          s              1  0
     d w_kfak          s              8  6
     d w_kbel          s              7  2
     d w_sfak          s              8  6
     d w_midl          s              1  0
     d w_inpr          s              9  2
     d w_nopr          s              9  2
     d w_kopr          s              9  2
     d w_s1pr          s              9  2
     d w_s1im          s              9  2
     d w_s2pr          s              9  2
     d w_s2im          s              9  2
     d w_s3pr          s              9  2
     d w_s3im          s              9  2
     d w_dekn          s              5  2
     d w_ste1          s             35
     d w_ste2          s             35
     d w_ste3          s             35
     d w_ste4          s             35
     d w_ste5          s             35
     d w_pkod          s              1
     d w_skod          s              1  0
     d w_lety          s              1  0
     d w_gprk          s              1  0
     d w_eldo          s                   like(jvldor)
     d w_osts          s              1  0
6.33 d*w_lvar          s                   like(jvvare)
6.33 d w_lvar          s                   like(jvlvar)
     d w_xxxx          s                   like(jvldor)
8.03 d w_prut          s              2
8.03 d w_pgbe          s              2
8.03 d w_pgfr          s              2
6.3y d w_oppd          s              1
     d w_udat          s               d   datfmt(*iso)
     d w_utim          s               t   timfmt(*iso)
     d w_bup1          s              9  2
     d w_pda1          s               d   datfmt(*iso)
     d w_bup2          s              9  2
     d w_omr2          s             12  6
     d w_pda2          s               d   datfmt(*iso)
     d w_bup3          s              9  2
     d w_omr3          s             12  6
     d w_pda3          s               d   datfmt(*iso)
     d w_fdat          s               d   datfmt(*iso)
     d w_ftid          s               t   timfmt(*iso)
     d w_tdat          s               d   datfmt(*iso)
     d w_ttid          s               t   timfmt(*iso)
     d w_kamp          s              5
     d w_tip1          s              9  2
     d w_tkp1          s              9  2
     d w_tip2          s              9  2
     d w_tip3          s              9  2
     d w_enin          s              3
     d w_enps          s              3
     d w_pspr          s              9  2
6.34 d w_ffak          s              8  6
6.34 d w_inp2          s              9  2
6.32 d w_utgp          s              1  0
6.32 d w_dato          s               d   datfmt(*iso)
6.34 d w_pgiv          s                   like(jlldor)
      *
      *
     d w_firm          s              3  0
     d w_vare          s                   like(jvvare)
     d w_gdat          s               d   datfmt(*iso)
6.37 d b_logv          s              1    inz(*off)
6.37 d w_lv_vare       s                   like(jvvare)
6.37 d w_lv_modn       s                   like(jvmodn)
6.37 d w_lv_kldo       s                   like(jvldor)
6.37 d w_lv_nobb       s                   like(jvnobb)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
6.37 C/Exec SQL
6.37 C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR
6.37 C/End-Exec
      *
     c                   eval      w_firm = p_firm
     c                   eval      w_vare = p_vare
      *
     c     jvarl1_key    chain     jvarl1
     c                   if        not %found
     c                   goto      avslutt
     c                   endif
      *
      * Hent leverandørinformasjon
6.37  * flyttet les av levrandør slik at riktig lev. for finn logivar
6.37 c                   if        p_ldor <> 0
6.37 c                   clear                   jlevl3r
6.37 c                   eval      jlevl3_enum = p_ldor
6.37 c     jlevl3_key    chain     jlevl3
6.37 c                   if        %found
6.37 c                   eval      c2navn = jlnavn
6.37 c                   eval      c2ldor = jlldor
6.37 c                   endif
6.37 c                   endif
6.37 c                   exsr      finn_logivar
6.37  *
      *
     c                   eval      c2ldor = jvldor
     c                   eval      c2vare = jvvare
     c                   eval      c2vtek = jvtek1
6.37 c                   if        w_lv_vare <> *blank
6.37 c                   eval      c2nobb = w_lv_nobb
6.37 c                   eval      c2modn = w_lv_modn
6.37 c                   else
     c                   eval      c2nobb = jvnobb
     c                   eval      c2modn = jvmodn
6.37 c                   endif
     c                   eval      c2penh = jvpenh
     c                   eval      c2ean1 = jvean1
     c                   eval      c2ogrp = jvogrp
     c                   eval      c2hgrp = jvhgrp
     c                   eval      c2ugrp = jvugrp
      *
      * Finner gtin ut fra vare - enhet
      *
      *
      * finner prisdato for leverandør
      *
     c                   eval      jvprl1_vare = p_vare
6.34 c                   eval      jvprl1_ldor = jlldor
6.31 c     jvprl1_key    setll     jvprl1
6.31 c     jvprl1_key    reade     jvprl1
6.31 c                   dow       not %eof(jvprl1)
6.31 c                   if        w_udat >= jxgdat
6.30 c                   if        (jxtdat =  *loval) or
6.30 c                             (jxtdat <> *loval and
6.35 c                             jxtdat >= w_udat)
6.35 c                   if        jxgdat >= p_dato
     c                   eval      w_gprk = 1
     c                   else
     c                   eval      w_gprk = 0
6.30 c                   endif
6.30 c                   endif
6.31 c                   endif
6.31 c     jvprl1_key    reade     jvprl1
6.31 c                   enddo
     c
      *
      * Hent priskode
     c     jvdtl1_key    chain     jvdtl1
     c                   if        %found
     c                   eval      c2pkod = jvdpko
     c                   endif
      *
      * Henter salgspris fra fellesprogram
     c                   exsr      hent_pris
      *
     c                   eval      c2gdat = 0
     c                   if        w_gdat <> *loval
     c     *dmy          move      w_gdat        c2gdat
     c                   endif
      *
      * Henter prisinformasjon fra eget vareregister
     c*                  exsr      hent_pri1
      *
     c                   exfmt     c2bld
      *
      * F3=Avslutt
      *
     c                   if        *inkc or *inkl
     c                   goto      avslutt
     c                   endif
      *
      * Tar vare på "gammel" kostpris for test for vising av bilde
      *
      *
      * Avslutter program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
     c                   return
      *
      ****************************************************************
     c     hent_pris     begsr
     c                   eval      w_pkod = jvdpko
     c                   eval      w_skod = jvdsko
     c                   eval      w_xxxx = 0
6.3y c                   eval      w_oppd = *blank
6.34 c                   eval      w_pgiv = jlldor
      *
     c                   call      'JV750R  '
      *
     c                   parm                    w_firm
     c                   parm                    jvvare
5.70 c                   parm                    c2prgr
6.34 c                   parm                    w_pgiv
     c                   parm                    w_pkod
     c                   parm                    w_skod
     c                   parm                    p_lety
     c                   parm                    w_gprk
6.32 c                   parm                    w_dato
6.32 c                   parm                    w_utgp
      *
     c                   parm                    w_osts
      *
6.34 c                   parm                    c2ldor
     c                   parm                    w_lvar
     c                   parm                    w_eldo
     c                   parm                    w_nopr
     c                   parm                    w_gdat
      *
     c                   parm                    w_enhe
     c                   parm                    w_enh1
     c                   parm                    w_enh2
     c                   parm                    w_enh3
     c                   parm                    w_eni1
     c                   parm                    w_eni2
     c                   parm                    w_eni3
     c                   parm                    w_enp1
     c                   parm                    w_enp2
     c                   parm                    w_enp3
     c                   parm                    w_ofp1
     c                   parm                    w_ofp2
     c                   parm                    w_ofp3
     c                   parm                    w_ofv2
     c                   parm                    w_ofv3
     c                   parm                    w_ofi1
     c                   parm                    w_ofi2
     c                   parm                    w_ofi3
      *
     c                   parm                    c2bldo
     c                   parm                    c2bogr
     c                   parm                    c2bhgr
     c                   parm                    c2bugr
     c                   parm                    c2bmod
     c                   parm                    w_bvar
     c                   parm                    w_bvty
     c                   parm                    w_blet
     c                   parm                    c2bbet
     c                   parm                    c2ntpr
     c                   parm                    c2ifak
      *
     c                   parm                    w_pogr
     c                   parm                    w_phgr
     c                   parm                    w_pugr
     c                   parm                    w_pldo
     c                   parm                    w_pmod
     c                   parm                    w_pvar
     c                   parm                    w_ppko
     c                   parm                    w_pvty
     c                   parm                    w_plet
     c                   parm                    c2kfak
     c                   parm                    c2kbel
     c                   parm                    w_sfak
      *
     c                   parm                    w_midl
     c                   parm                    w_inpr
     c                   parm                    w_kopr
     c                   parm                    w_s1pr
     c                   parm                    w_s1im
     c                   parm                    w_s2pr
     c                   parm                    w_s2im
     c                   parm                    w_s3pr
     c                   parm                    w_s3im
     c                   parm                    w_dekn
     c                   parm                    w_prut
6.34 c                   parm                    w_ffak
6.34 c                   parm                    w_inp2
6.3x c                   parm                    w_pgbe
6.3y c                   parm                    w_pgfr
6.3y c                   parm                    w_oppd
      *
6.36 c****               eval(h)   w_inpr = w_inpr * w_ffak
      *
8.02 c                   eval      c2ffak = w_ffak
8.01 c                   eval      c2enh1 = w_enh1
8.01 c                   eval      c2enh2 = w_enh2
8.01 c                   eval      c2enh3 = w_enh3
8.01 c                   select
8.01 c                   when      w_enhe = w_enh1
8.01 c                   eval      c2nopr = w_nopr
8.01 c                   when      w_enhe = w_enh2
8.01 c                   eval(h)   c2nopr = w_nopr * w_ofp2
8.01 c                   when      w_enhe = w_enh3
8.01 c                   eval(h)   c2nopr = w_nopr * w_ofp3
8.01 c                   endsl

     c                   eval      c2nop1 = w_nopr
     c                   eval      c2kop1 = w_kopr
     c                   eval      c2inp1 = w_inpr
8.02 c                   eval      c2in21 = w_inp2
8.01 c                   eval(h)   c2nop2 = w_nopr * w_ofp2
8.01 c                   eval(h)   c2kop2 = w_kopr * w_ofp2
8.01 c                   eval(h)   c2inp2 = w_inpr * w_ofp2
8.02 c                   eval(h)   c2in22 = w_inp2 * w_ofp2
8.01 c                   eval(h)   c2nop3 = w_nopr * w_ofp3
8.01 c                   eval(h)   c2kop3 = w_kopr * w_ofp3
8.01 c                   eval(h)   c2inp3 = w_inpr * w_ofp3
8.02 c                   eval(h)   c2in23 = w_inp2 * w_ofp3
      *
     c                   endsr
      *****************************************************************
      * Henter prisinformasjon fra eget vareregister
     c*    hent_pri1     begsr
      *
     c*                  call      'VP716R'
     c*                  parm                    w_firm
5.70 c*                  parm                    w_vare
5.70 c*                  parm                    c2prgr
     c*                  parm                    c2lety
     c*                  parm                    p_dato
     c*                  parm                    w_utim
     c*                  parm                    w_enh1
     c*                  parm                    w_s1gm
     c*                  parm                    w_bup1
     c*                  parm                    w_k1gm
     c*                  parm                    w_i1gm
     c*                  parm                    w_pda1
     c*                  parm                    w_enh2
     c*                  parm                    w_s2gm
     c*                  parm                    w_bup2
     c*                  parm                    w_omr2
     c*                  parm                    w_pda2
     c*                  parm                    w_enh3
     c*                  parm                    w_s3gm
     c*                  parm                    w_bup3
     c*                  parm                    w_omr3
     c*                  parm                    w_pda3
     c*                  parm                    w_fdat
     c*                  parm                    w_ftid
     c*                  parm                    w_tdat
     c*                  parm                    w_ttid
     c*                  parm                    w_kamp
     c*                  parm                    w_tip1
     c*                  parm                    w_tkp1
     c*                  parm                    w_tip2
     c*                  parm                    w_tip3
     c*                  parm                    w_enin
     c*                  parm                    w_enps
     c*                  parm                    w_pspr
     c*                  endsr
6.37  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.37  * Finn info om logistikkvare for riktig prisgiver
6.37  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.37  *
6.37 c     finn_logivar  begsr
6.37  *
6.37 c                   eval      b_logv = *off
6.37 c                   eval      w_lv_vare = *blank
6.37 c                   eval      w_lv_kldo = 0
6.37 c                   eval      w_lv_nobb = 0
6.37 c                   eval      w_lv_modn = 0
6.37  *
6.37 c/exec sql
6.37 c+ select a.jvvare,
6.37 c+        b.jvkldo,
6.37 c+        c.jvquno,
6.37 c+    (select d.jvmodn from jvarpf d where d.jvnobb = c.jvquno)
6.37 c+ into   :w_lv_vare,
6.37 c+        :w_lv_kldo,
6.37 c+        :w_lv_nobb,
6.37 c+        :w_lv_modn
6.37 c+ from   jvarpf a
6.37 c+ inner join jvkhpf b on jvkvnr = jvvare and jvkfir = :w_firm
6.37 c+ inner join jvklpf c on jvqvnr = jvvare and jvqfir = :w_firm
6.37 c+ where  jvqvnr = :jvvare
6.37 c+    and jvqldo = :jlldor fetch first 1 rows only
6.37 c/end-exec
6.37  *
6.37 c                   if        sqlcod = 100 or sqlstt = '02000'
6.37 c                   leavesr
6.37 c                   endif
6.37 c                   if        sqlcod <> 0
6.37 c                   leavesr
6.37 c                   endif
6.37  *
6.37 c                   eval      b_logv = *on
6.37  *
6.37 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_firm
     c                   parm                    p_vare
     c                   parm                    p_prgr
     c                   parm                    p_lety
     c                   parm                    p_dato
     c                   parm                    p_ldor
      *
      *
      * Key for oppslag på vare
     c     jvarl1_key    klist
     c                   kfld                    w_vare
      *
      * Key for oppslag på leverandør
      *
     c     jlevl3_key    klist
     c                   kfld                    jlevl3_enum
      *
      * Key for oppsalg på vare-detalj
      *
     c     jvdtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_vare
      *
      * Key for oppslag på varepris
      *
     c     jvprl1_key    klist
     c                   kfld                    jvprl1_vare
     c                   kfld                    jvprl1_ldor
      *
      *
     c                   eval      c2prgr = p_prgr
6.30 c                   time                    w_udat
6.32 c                   time                    w_dato
      *
      *
     c                   endsr
