# Program RE601R – Saldobalanse til PC – Utplukk

## Overview

This program is part of the ASOKON system and is responsible for extracting and aggregating account balance data (saldobalanse) for transfer to a PC (likely for reporting or further processing). The extraction supports filtering by company, period, department, and allows for summarization by account and/or department. The program reads from the account master and balance matrix files, processes the data, and writes the results to a transfer file.

---

## Main Data Files

- **Rhovl1 (rhovpfr)**: Account master file, providing the list of accounts to process.
- **Rhsal1 (rhsapfr)**: Balance matrix, providing periodical balances, budgets, and related data for each account.
- **Re03lu (re03pfr)**: Output/transfer file, where the aggregated results are written.

Each file is accessed with a key, and record formats are renamed for clarity and to avoid naming conflicts.

---

## Key Variables and Structures

- **sal(14)**: Array holding balances for each period (13 periods + 1 for total/other).
- **sa�(14), saf(14), sab(14)**: Arrays for current year balance, previous year balance, and budget, respectively, for each period.
- **pfirm, pnavn, puser, pdato, praar, pperf, ppert, pavdf, pavdt, prapp, psumm, psums**: Parameters controlling which data to extract (company, year, period, department range, report type, summarization options).
- **wfkont**: Tracks the last processed account to avoid duplicate processing.
- **w_raar**: Stores the previous year (praar - 1), for comparison.

---

## Program Flow

### 1. Initialization (`*inzsr` subroutine)

- Sets up working variables, including the previous year and initializes all working fields to zero.
- Builds key lists for accessing the main files.

### 2. Main Processing Loop

#### a. Read Account Master

- Loops through all accounts in the master file for the selected company (`rhovl1`).
- Ensures each account is only processed once (using `wfkont`).

#### b. For Each Account

- Resets the balance arrays (`sa�`, `saf`, `sab`) to zero.
- Reads the balance matrix (`rhsal1`) for the current account.

#### c. For Each Balance Record

- Filters records by year and department range.
- Accumulates balances into the arrays:
    - **Current year (`sa�`)**: Where year matches `praar` and type is 1.
    - **Previous year (`saf`)**: Where year matches `w_raar` and type is 1.
    - **Budget (`sab`)**: Where year matches `praar` and type is 3.
- If any relevant balance is found, calls the `summer` subroutine to aggregate and write/update the output.

### 3. Aggregation and Output (`summer` subroutine)

- Determines whether to summarize by account or department based on `psums` and `psumm` flags.
    - If summarized, sets the corresponding fields (`rhspes`, `rhavde`) to zero; otherwise, uses the specific values.
- Chains (searches) for an existing record in the output file (`re03lu`) with the same keys.
    - If found, accumulates the new balances into the existing record and updates it.
    - If not found, creates a new record with the computed balances (only if at least one balance is non-zero).
- The subroutine handles three types of balances for both the current and previous year, as well as budget.

---

## Key Business/Domain Logic

- **Summarization**: The program can aggregate data at different levels (by account, by department, or both) based on parameters. This allows flexibility in reporting granularity.
- **Period Handling**: Balances are managed per period (up to 13), supporting both monthly and annual reporting.
- **Department Filtering**: Only balances within a specified department range are considered.
- **Yearly Comparison**: Both current and previous year balances are extracted for comparative reporting.
- **Budget Inclusion**: Budget data is processed alongside actual balances for variance analysis.

---

## Design Patterns and Conventions

- **Record Locking and Keyed Access**: All file accesses are keyed, supporting efficient processing even for large datasets.
- **Zero Suppression**: Output records are only written if at least one balance field is non-zero, avoiding unnecessary empty records.
- **Modularization**: The use of subroutines (`summer`, `*inzsr`) encapsulates logic for initialization and aggregation.
- **Array-based Accumulation**: Balances are accumulated in arrays indexed by period, simplifying period-based calculations.

---

## External Interactions

- **Input**: Reads from the account master (`rhovl1`) and balance matrix (`rhsal1`) files.
- **Output**: Writes to the output/transfer file (`re03lu`), which is designed for further processing or export to PC-based systems.
- **Parameter Passing**: The program expects external parameters (company, year, period, department range, summarization flags) that control its operation.

---

## Notable Implementation Details

- **Language/Localization**: Comments and field names indicate Norwegian business terminology (e.g., "Saldobalanse", "Firma", "Avdeling").
- **Performance**: By using keyed access and only processing each account once, the program is optimized for batch runs.
- **Backward Compatibility**: The field and logic structure suggests support for legacy data layouts (e.g., 13 periods, special handling for period 00/14).

---

## Summary

This program is a batch extraction utility for generating summarized account balances, supporting flexible filtering and aggregation. It is tightly coupled to the ASOKON system's data model and is designed for high-performance processing of large financial datasets, with output intended for downstream PC-based analysis or reporting tools. The codebase employs standard RPG/400 idioms, with careful attention to business rules and data integrity.