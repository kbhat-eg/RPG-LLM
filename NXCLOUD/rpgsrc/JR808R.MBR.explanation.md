# RPG Program Explanation: JR799R

## Overview

**Program:** JR799R  
**System:** ASVADM  
**Description:**  
The program reads a generic CSV file to create new items and update prices of existing items in a product master file (LVR).  
- New items are created as new records in LVR, not as items under price-giving suppliers.
- Price updates are made based on matching the supplier’s item number.

**File usage:** Several logical & physical files for items, prices, packs, etc.  
**Main logic:** For each input record (CSV line), extract data, normalize/convert, then update or create records in item master and related tables.

---

## Main Program Structure

### Header and File Definitions

- `h option(*nodebugio) datedit(*dmy)`: Compile options—disables debugger’s I/O, uses DMY date format.
- File specifications (`f`): Define several databases files (item master, prices, supplier info, etc.) with record formats, keys, and rename clauses.

### Data Definitions

- **Parameters**: `p_list`, used for inbound parameter handling.
- **Local Data Area**: `l_user` (user information).
- **Parameter List Data Structure**: Used to extract input parameters (firm, report, date).
- **Input Record Data Structure**: For holding and mapping fields from the CSV input line.
- **Key Variables**: For keyed access to various files.
- **Variables**: Such as flags, group codes, positions, EANs, constants.
- **Constants**: For digit checking, null value, character translations.

---

## Main Program Logic

### Initialization

- **INZSR** subroutine: Initializes key lists, fills parameter data structure, extracts firm code.

### Mainline

1. **Lookup Report Information**: Chains to the report file (`jrapl1`) using input parameters.
   - If not found, jump to program end.
2. **Read Input File Loop**: Reads each record from the CSV file (`jrvapf`).
   - For each record, calls the `behandling` ("processing") subroutine.

3. **Program End**: Sets LR (last record) and returns.

---

## Core Subroutines

### 1. `behandling` (Process Item/Price)

- **Clear Input Data Structure**.
- **Parse CSV Line**: Calls `utled_ds` to split CSV line into fields.
  - If incomplete or invalid, returns immediately.
- **Normalize/Convert Data**:
  - Trims text, translates special/illegal characters.
  - Converts units using cross-reference if available.
- **Determine Create/Update**:
  - Tries to locate the item (by supplier’s item number).
  - If found: calls `endr_vare` (update/replace).
  - If not: calls `ny_vare` (create new).
- **Update Main Tables**:
  - Update/create item master record (`jvarlur`).
  - If new item, also create item detail (`jvdtlur`).
- **Related Data**:
  - Creates/updates packaging (`oppd_pakning`).
  - Creates/updates price records (`oppd_pris`).
- **Indexing/Search**: Calls a search text updating program (`JV790R`).

### 2. `endr_vare` (Update Existing Item)

- **Status Handling**: If current status is 0/1/4, set to 1; otherwise retain.
- **Delete Old Packs/Prices**:
  - Loops through and deletes packaging and price records not marked as "registered manually" (status 0).
- **Unlocks records if not to be deleted.**

### 3. `ny_vare` (Create New Item)

- **Assign Status 2 (New)**.
- **Get Next Item Number**: Reads from status table (`jstslu`), increments, writes back.
- **Sets creation dates.**

### 4. `oppd_pakning` (Create Packaging)

- **Writes Packaging Record**: 
  - Writes default pack ('000'), then another with pack '001' for GTIN.
- **Fills in needed fields.**

### 5. `oppd_pris` (Create Price)

- **Fills Price Record**:
  - Calculates price from kr + øre.
  - Sets fields, writes price record.
- **Supplier Link**:
  - Deletes any old supplier links.
  - Creates new supplier record for this item.

### 6. `sjk_ean` (Check EAN)

- **Validate/Format EAN**:
  - If input contains non-digit chars, skips.
  - Otherwise, pads and normalizes.

### 7. `utled_ds` (Parse Input CSV Record)

- **Splits CSV line (`jrvrad`) into fields**:
  - Splits out supplier item number, description, price, EAN, unit, group.
  - Converts price to a normalized numeric (pads with zeros, ensures decimal).
- **Checks for valid data, sets flag `b_ok`.**

---

## Key Aspects and Design Decisions

- **CSV Parsing** is manual, using `%scan` and `%subst` for semi-colon delimited fields.
- **Character Translation**: Illegal/unknown chars in description replaced/normalized.
- **Update vs Insert Logic**: Checks if item exists, deletes dependent records as needed before re-insertion.
- **Data Integrity**: Price, packaging, and supplier links are always recreated for each input.
- **Hardcoded Grouping**: Product group fields are parsed from a single group variable.
- **Subroutines**: Used for compartmentalizing tasks, e.g., parsing, normalization, updating/inserting.

---

## Summary Table

| Subroutine       | Purpose                                         |
|------------------|------------------------------------------------|
| behandling       | Main item/price processing per CSV line        |
| endr_vare        | Update existing item, delete old packs/prices  |
| ny_vare          | Create new item, assign number, set status     |
| oppd_pakning     | Create packaging records                       |
| oppd_pris        | Create price records, update supplier link     |
| sjk_ean          | Check and normalize EAN number                 |
| utled_ds         | Parse CSV into fields, normalize price         |
| *inzsr           | Initialization, key list setup, param extract  |

---

## File Definitions (Main Ones)

- **jrvapf**: Input – CSV import file.
- **jrapl1**: Reporter info.
- **jvarl8, jvarlu**: Item master/lookup.
- **jvdtlu**: Item detail.
- **jvpklu**: Packaging
- **jvprlu**: Prices
- **jvlelu**: Item-supplier link
- **fenkl1**: Unit conversion (enheter)

---

## Error Handling

- Skips invalid/malformed input records.
- Defensive checks when updating/deleting dependent records (checks status fields).

---

## Typical Flow (for one CSV line)

1. Parse the CSV line into fields.
2. Translate the description, convert units.
3. If item exists by supplier number: update item, delete old packs/prices, else get next item number and create new.
4. (Re)create necessary packaging and price records for the item.
5. Update linking/search info.

---

## Onboarding Advice

- **Understand each file's schema**: Critical for mapping fields.
- **Know the CSV format**: The program expects a fixed order with semicolon delimiters.
- **Check constants and translations**: Adjust if new illegal chars are found.
- **Test with a small input file**: To observe the update/creation flow.
- **Look for TODOs**: Some logic is hardcoded (e.g., product group splitting).

---

This program is modular but was written in classic ILE RPG, pre-free-form syntax, and handles all data parsing, normalization, and database updates in code. It is robust for batch import and update tasks for product master data.