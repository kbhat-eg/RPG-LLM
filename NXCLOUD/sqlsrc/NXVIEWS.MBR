CREATE OR REPLACE PROCEDURE ADB.SP_NEXSTEP_CREATE_VIEW_630
(in p_lib varchar(10),in p_table varchar(10))
LANGUAGE SQL
MODIFIES SQL DATA
BEGIN

-- For å kjøre create av trigger, må statement legges i en variable også
-- kjøre execute på variabelen.
-- Viktig at det ikke er ; etter siste end i variabel statement


/* kjør slik
        -- bruk CL for å kjøre SP, slik rett filgruppe er CUR
    CALL ASPGPLU630/VIEWCRT PARM('630')
    CALL ASPGPLU630/VIEWCRT PARM('630' 'VVARPF')
    CALL ASPGPLU630/VIEWCRT PARM('630' '*ALL')
*/


/*  MAL
SET stmt = '
create or replace view
...........
end
';
PREPARE s1 FROM stmt;
EXECUTE s1;

  END IF;
 */

DECLARE stmt VARCHAR(32000);

DECLARE msgtxt CHAR(250);
DECLARE PrevSQLState CHAR(5);
DECLARE SQLSTATE CHAR(5);

DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
BEGIN
  SET PrevSQLState=SQLSTATE;
  GET DIAGNOSTICS EXCEPTION 1 msgtxt=MESSAGE_TEXT;
  insert into ajltpf(ajtfir,ajtjid,ajtlin,ajtsta,ajttxt,ajtoda,ajtoti,ajtous)
    values
    ( 0 , 'SQL_VIW_CRT_' || VARCHAR_FORMAT(current_timestamp,
	'YYYYMMDDHHMISSFF3'), 1 , 10
 ,'SQLSTATE: ' ||  PrevSQLState || ', MESSAGE_TEXT: ' || SUBSTR(msgtxt, 1 , 70)
    ,CURRENT_DATE,CURRENT_TIME,USER);
  insert into ajltpf(ajtfir,ajtjid,ajtlin,ajtsta,ajttxt,ajtoda,ajtoti,ajtous)
    values
    ( 0 , 'SQL_VIW_CRT_' || VARCHAR_FORMAT(current_timestamp,
	'YYYYMMDDHHMISSFF3'), 2 , 10
    ,SUBSTR( stmt , 1 , 150 )
    ,CURRENT_DATE,CURRENT_TIME,USER);
END;


SET msgtxt = 'START:' CONCAT  p_lib CONCAT ':' CONCAT p_table CONCAT ':' ;
insert into ajltpf(ajtfir,ajtjid,ajtlin,ajtsta,ajttxt,ajtoda,ajtoti,ajtous)
  values
  ( 0 , 'SQL_VIW_CRT_' || VARCHAR_FORMAT(current_timestamp
  ,'YYYYMMDDHHMISSFF3'), 1 , 10
  , msgtxt
  ,CURRENT_DATE,CURRENT_TIME,USER);

/* **************************************************************************
TEST TEST TEST TEST TEST TEST
*/

/* **************************************************************************
TEST TEST TEST TEST TEST TEST
*/



/* **************************************************************************
START NEWLOOK
*/


-- FODTPF   VVENPF

  IF  (UPPER(TRIM(p_table)) = 'FODTPF' OR UPPER(TRIM(p_table)) = 'VVENPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- VAREFORM_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VARELINJER_VEKT_NWL_VIEW  FOR SYSTEM NAME NWLVARVEKT
(FDFIRM, FDNUMM, FDSUFF, FDLINE, FDANTA, FDVARE, FDENH1, VEKT, VOLUM)
AS
  SELECT DISTINCT FDFIRM, FDNUMM, FDSUFF, FDLINE, FDANTA, FDVARE, FDENH1
  , IFNULL ( CASE
     WHEN E.VEVEKT > 0 THEN (FDANTA * E.VEVEKT)
     ELSE (FDANTA * (OMR.VEVEKT * E.VEOMRE))
     END , 0 ) AS VEKT
  , IFNULL( CASE
     WHEN E.VEVOLU > 0 THEN (FDANTA * E.VEVOLU)
     ELSE (FDANTA * (OMR.VEVOLU * E.VEOMRE))
     END , 0) AS VOLUM
  FROM FODTPF
  LEFT OUTER JOIN VVENPF E ON E.VEFIRM = FDFIRM AND E.VEVARE = FDVARE AND
  E.VEENHE = FDENH1
  LEFT OUTER JOIN VVENPF OMR ON OMR.VEFIRM = FDFIRM AND OMR.VEVARE = FDVARE
  AND  OMR.VEOMRE = 1
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVARVEKT IS 'NewlookView Varelinjer vekt';

  END IF;  -- stopp tabell



-- SSTAPF

  IF  (UPPER(TRIM(p_table)) = 'SSTAPF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN


-------- VAREFORM_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VAREFORM_NWL_VIEW  FOR SYSTEM NAME NWLVFVIEW
(SFFIRM,SFBIDA_F,SFBIDA,SFORNR,SFANTO_F,SFENHO,SFOTYP,SFSUMB_F,SFRAB1_F,
SFRAB2_F,SFRABO_F,NETTO_F,NETTO_ENHET_F,SFVARE)
AS
  SELECT
     SFFIRM
    , adb.nwl_date_fmt(SFBIDA) as SFBIDA_F
    ,SFBIDA
    ,SFORNR
    ,ADB.nwl_num_fmt(SFANTO, 3) AS SFANTO_F
    ,SFENHO
    ,SFOTYP
    ,ADB.nwl_num_fmt(SFSUMB, 2) AS SFSUMB_F
    ,ADB.nwl_num_fmt(SFRAB1, 2) AS SFRAB1_F
    ,ADB.nwl_num_fmt(SFRAB2, 2) AS SFRAB2_F
    ,ADB.nwl_num_fmt(SFRABO, 2) AS SFRABO_F
    ,ADB.nwl_num_fmt((SFSUMB-SFRAB1-SFRAB2-SFRABO), 2) as NETTO_F
    ,ADB.nwl_num_fmt(((SFSUMB-SFRAB1-SFRAB2-SFRABO)/SFANTO), 2) as
	  NETTO_ENHET_F
    ,SFVARE
  FROM SSTAPF A
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVFVIEW IS 'NewlookView Vareform';

-------- KUNDFORM_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW KUNDFORM_NWL_VIEW FOR SYSTEM NAME NWLKFVIEW
  (SFFIRM,SFBIDA_F,SFBIDA,SFNOBB,SFTEK1,SFORNR,SFOTYP,SFANTO_F,SFENHO,
  SFSUMB_F,SFRAB1_F,SFRAB2_F,SFRABO_F,NETTO_F,NETTO_ENHET_F,SFVKUN)
  AS
  SELECT
     SFFIRM
    , adb.nwl_date_fmt(SFBIDA) as SFBIDA_F
    ,SFBIDA
    , SFNOBB
    , ADB.nwl_json_clean(SFTEK1) AS SFTEK1
    , SFORNR
    , SFOTYP
    , ADB.nwl_num_fmt(SFANTO, 3) AS SFANTO_F
    , SFENHO
    , ADB.nwl_num_fmt(SFSUMB, 2) AS SFSUMB_F
    , ADB.nwl_num_fmt(SFRAB1, 2) AS SFRAB1_F
    , ADB.nwl_num_fmt(SFRAB2, 2) AS SFRAB2_F
    , ADB.nwl_num_fmt(SFRABO, 2) AS SFRABO_F
    , ADB.nwl_num_fmt((SFSUMB-SFRAB1-SFRAB2-SFRABO), 2) as NETTO_F
    , ADB.nwl_num_fmt(((SFSUMB-SFRAB1-SFRAB2-SFRABO)/SFANTO), 2) as
	  NETTO_ENHET_F
    , SFVKUN
  FROM SSTAPF
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKFVIEW IS 'NewlookView KundeForm';

  END IF;  -- stopp tabell


-- ZKAPST
  IF  (SELECT COUNT(*) FROM QSYS2.SYSTABLES WHERE SYSTEM_TABLE_SCHEMA = p_lib
  AND TABLE_NAME='ZKAPST') = 1  THEN
  IF  (UPPER(TRIM(p_table)) = 'ZKAPST' OR  UPPER(TRIM(p_table)) = '*ALL') THEN

-------- VAREPRIS_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW VAREPRIS_MGR_NWL_VIEW FOR SYSTEM NAME NWLVPMVIEW
  (INSTANS,FIRMA,KUNDENUMMER,ORDRENUMMER,VARENUMMER,ENHET,AVDELINGSGRUPPE,
   KUNDEGRUPPE,KUNDEKJOPSTYPE,STARTPRIS,TARGETPRIS,FLOORPRICE,TIMESTAMP)
  AS
  SELECT
      INSTANS
      ,FIRMA
      ,KUNDENUMMER
      ,ORDRENUMMER
      ,VARENUMMER
      ,ENHET
      ,AVDELINGSGRUPPE
      ,KUNDEGRUPPE
      ,KUNDEKJOPSTYPE
      ,ADB.nwl_num_fmt(STARTPRIS , 2) AS STARTPRIS
      ,ADB.nwl_num_fmt(TARGETPRIS, 2) AS TARGETPRIS
      ,ADB.nwl_num_fmt(FLOORPRICE, 2) AS FLOORPRICE
      ,TIMESTAMP
  FROM ZKAPST A
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVPMVIEW IS 'NewlookView VarePris MGR';

  END IF;  -- stopp tabell
  END IF;  -- stopp tabell ZKAPST sjekk




-- SSTAPF / FKPRPF
  IF  (UPPER(TRIM(p_table)) = 'SSTAPF'  OR UPPER(TRIM(p_table)) = 'VUGRPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- VAREFORM_STAT_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW VAREFORM_STAT_NWL_VIEW FOR SYSTEM NAME NWLVFSVIEW
  (SFFIRM,SFVARE,SFPAAR,SFPMND,NETTO_F,TOTALT_UGR_F,UGR_NAVN)
  AS
  SELECT
      SFFIRM
    , SFVARE
    , SFPAAR
    , SFPMND
    , ADB.nwl_num_fmt(sum(SFSUMB-SFRAB1-SFRAB2-SFRABO), 2) as NETTO_F
    , (SELECT SUM(B.SFSUMB-B.SFRAB1-B.SFRAB2-B.SFRABO) FROM SSTAPF B WHERE
	B.SFFIRM = A.SFFIRM AND B.SFPAAR=A.SFPAAR AND B.SFPMND = A.SFPMND AND
	B.SFOGRP=A.SFOGRP AND B.SFHGRP=A.SFHGRP AND B.SFUGRP=A.SFUGRP
	GROUP BY B.SFPAAR,B.SFPMND) AS TOTALT_UGR_F
    , (SELECT ADB.nwl_json_clean(VGUTXT) FROM VUGRPF WHERE VGUFIR=A.SFFIRM
	AND VGUOGR=A.SFOGRP AND VGUHGR=A.SFHGRP AND VGUUGR=A.SFUGRP) AS UGR_NAVN
  FROM SSTAPF A
  GROUP BY SFFIRM,SFVARE,SFPAAR,SFPMND,SFOGRP,SFHGRP,SFUGRP
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVFSVIEW IS 'NewlookView VareFormStat';

  END IF;  -- stopp tabell


-- VLTPPF
  IF  (UPPER(TRIM(p_table)) = 'VLTPPF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN

-------- LEVERINGSTYPE_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW LEVERINGSTYPE_NWL_VIEW FOR SYSTEM NAME NWLLVTVIEW
  (FIRM,JOBJ)
  AS
    WITH d AS
    (SELECT VYFIRM,VYLETY,VYBESK FROM VLTPPF)
    ,h AS
    (SELECT JSON_ArrayAgg(JSON_Object(''N'' : h1) RETURNING VarChar(500)
	 CCSID 1208) AS ObjH
     FROM (VALUES (''Kode''),(''Tekst'')) hh(h1))
    ,th AS
    (SELECT JSON_Object(''tr'': ObjH Format JSON RETURNING VarChar(500) CCSID
	1208) AS ObjTr
     FROM h)
    , vltp_j AS
    (SELECT VYFIRM,
        VYLETY,
        VYBESK ,
        JSON_Object(''D'': RIGHT(REPEAT(''0'', 5) || LTRIM(VYLETY), 5),
		''T'' : ''S'' Absent ON NULL RETURNING VarChar(40) CCSID 1208)
		AS json_SORT ,
        JSON_Object(''D'': TRIM(VYLETY), ''T'' : ''I'' Absent ON NULL
		RETURNING
		VarChar(40) CCSID 1208) AS json_VYLETY ,
        JSON_Object(''D'': TRIM(VYBESK), ''T'' : ''T'' Absent ON NULL
		RETURNING VarChar(100) CCSID 1208) AS json_VYBESK
     FROM d )
    , tds AS
    (SELECT VYFIRM ,
        JSON_ArrayAgg(JSON_Array(
          json_SORT Format JSON
        , json_VYLETY Format JSON
        , json_VYBESK Format JSON
         RETURNING VarChar(1000) CCSID 1208)
        order by json_SORT RETURNING VarChar(2000) CCSID 1208) AS ObjRad
     FROM vltp_j
     GROUP BY VYFIRM)
    , js AS
    (SELECT VYFIRM ,
        JSON_Object(
        ''table'' : ''LEVERINGSTYPE_NWL_VIEW''
        , ''showheader'' : ''Koder for Leveringstype''
        , ''theader'': ObjTr Format JSON
        , ''tablerows'': ObjRad Format JSON RETURNING VarChar(20000)
		CCSID 1208) AS ObjT
     FROM th,tds)
    SELECT VYFIRM,
       JSON_Object(''htmltable'': ObjT Format JSON RETURNING VarChar(32000)
	   CCSID 1208) AS JOBJ
    FROM js
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLLVTVIEW IS 'NewlookView Leveringstype';

  END IF;  -- stopp tabell

-- RA17PF
  IF  (UPPER(TRIM(p_table)) = 'RA17PF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN

-------- FORSENDELSESMATER_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW FORSENDELSESMATER_NWL_VIEW FOR SYSTEM NAME NWLFSMVIEW
  (FIRM,JOBJ)
  AS
    WITH d AS
    (SELECT RAQFIR,RAQKOD,RAQTXT  FROM RA17PF )
    ,h AS
    (SELECT JSON_ArrayAgg(JSON_Object(''N'' : h1) RETURNING VarChar(500)
	CCSID 1208) AS ObjH
     FROM (VALUES (''Kode''),(''Tekst'')) hh(h1))
    ,th AS
    (SELECT JSON_Object(''tr'': ObjH Format JSON RETURNING VarChar(500)
	CCSID 1208) AS ObjTr
     FROM h)
    , vltp_j AS
    (SELECT RAQFIR,
        RAQKOD,
        RAQTXT ,
        JSON_Object(''D'': RIGHT(REPEAT(''0'', 5) || LTRIM(RAQKOD), 5), ''T''
		: ''S'' Absent ON NULL RETURNING VarChar(40) CCSID 1208) AS json_SORT ,
        JSON_Object(''D'': TRIM(RAQKOD), ''T'' : ''I'' Absent ON NULL
		RETURNING VarChar(40) CCSID 1208) AS json_RAQKOD ,
        JSON_Object(''D'': TRIM(RAQTXT), ''T'' : ''T'' Absent ON NULL
		RETURNING VarChar(100) CCSID 1208) AS json_RAQTXT
     FROM d)
    , tds AS
    (SELECT RAQFIR ,
        JSON_ArrayAgg(JSON_Array(
          json_SORT Format JSON
        , json_RAQKOD Format JSON
        , json_RAQTXT Format JSON
        RETURNING VarChar(30000) CCSID 1208)
        order by json_SORT RETURNING VarChar(31000) CCSID 1208) AS ObjRad
     FROM vltp_j
     GROUP BY RAQFIR)
    , js AS
    (SELECT RAQFIR ,
        JSON_Object(
        ''table'' : ''FORSENDELSESMATER_NWL_VIEW''
        , ''showheader'' : ''Koder for Forsendelsesmåter''
        , ''theader'': ObjTr Format JSON
        , ''tablerows'': ObjRad Format JSON
        RETURNING VarChar(32000) CCSID 1208) AS ObjT
     FROM th,tds)
    SELECT RAQFIR,
       JSON_Object(''htmltable'': ObjT Format JSON RETURNING VarChar(32000)
	   CCSID 1208) AS JOBJ
    FROM js
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLFSMVIEW IS 'NewlookView Forsendelsesmåter';

  END IF;  -- stopp tabell


-- SSTAPF / FKPRPF
  IF  (UPPER(TRIM(p_table)) = 'SSTAPF'
  OR UPPER(TRIM(p_table)) = 'FKPRPF'
  OR UPPER(TRIM(p_table)) = 'SODTPF'
  OR UPPER(TRIM(p_table)) = 'SOHEPF'
  OR UPPER(TRIM(p_table)) = 'FODTPF'
  OR UPPER(TRIM(p_table)) = 'FOHEPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN


-------- VARELINJER_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VARELINJER_NWL_VIEW FOR SYSTEM NAME NWLVLIVIEW
(SFFIRM,SFBIDA_F,SFBIDA,SFORNR,SFANTO_F,SFENHO,SFSUMB_F,SFRAB1_F,SFRAB2_F,
SFRABO_F,NETTO_F,NETTO_ENHET_F,SFVARE,SFVKUN,SFKPRO,FLNAVN)
AS
  SELECT
    SFFIRM
  , adb.nwl_date_fmt(SFBIDA) as SFBIDA_F
  ,SFBIDA
  , SFORNR
  , ADB.nwl_num_fmt(SFANTO, 3) AS SFANTO_F
  , SFENHO
  , ADB.nwl_num_fmt(SFSUMB, 2) AS SFSUMB_F
  , ADB.nwl_num_fmt(SFRAB1, 2) AS SFRAB1_F
  , ADB.nwl_num_fmt(SFRAB2, 2) AS SFRAB2_F
  , ADB.nwl_num_fmt(SFRABO, 2) AS SFRABO_F
  , ADB.nwl_num_fmt((SFSUMB-SFRAB1-SFRAB2-SFRABO), 2) as NETTO_F
  , ADB.nwl_num_fmt(((SFSUMB-SFRAB1-SFRAB2-SFRABO)/SFANTO), 2) as
  NETTO_ENHET_F
  , SFVARE
  , SFVKUN
  , SFKPRO
  , CASE WHEN SFKPRO=0 THEN '''' ELSE COALESCE(FLNAVN, ''SLETTET'') END AS
  FLNAVN
  FROM SSTAPF A
  LEFT OUTER JOIN FKPRPF ON SFFIRM = FLFIRM AND SFVKUN = FLKUND AND SFKPRO =
  FLKPRO
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVLIVIEW IS 'NewlookView Varelinjer';


SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_VARE
VARCHAR(20) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_FIRM
NUMERIC(3, 0) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_KUNDE
NUMERIC(6, 0) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_NOT_ORDRE
NUMERIC(8, 0) DEFAULT 0';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_NOT_SUFFIX
NUMERIC(2, 0) DEFAULT 0';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VARIABLE VARELINJER_JSON_NWL_VIEW_FETCH BIGINT
DEFAULT 30 ';
PREPARE s1 FROM stmt;
EXECUTE s1;

--
--  Viewet bruker disse variablene:
--    VARELINJER_JSON_NWL_VIEW_VARE    må ha en verdi
--    VARELINJER_JSON_NWL_VIEW_FIRM
--    VARELINJER_JSON_NWL_VIEW_KUNDE     kan være 0 eller kundenr
--    VARELINJER_JSON_NWL_VIEW_NOT_SUFFIX  ikke ta med ordre
--    VARELINJER_JSON_NWL_VIEW_NOT_SUFFIX  ikke ta med ordre med suffix
--    VARELINJER_JSON_NWL_VIEW_FETCH     totalt antall rader hentet
--

-- Dropper view som er avheninge av VARELINJER_BASE_NWL_VIEW
SET stmt = 'DROP VIEW VARELINJER_JSON_NWL_VIEW';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'DROP VIEW VARELINJER2_JSON_NWL_VIEW';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW VARELINJER_BASE_NWL_VIEW FOR SYSTEM NAME NLVARLBS (
SFFIRM,ORDRETYPE,SFBIDA_F,SFBIDA,SFORNR,SFORSU,SFANTO_F,SFENHO,SFSUMB_F,
SFSAPR_F,SFRAB1_P,SFRAB2_P
,SFRABO_P,BRUTTO_ENHET_F,SFRAB1_F,SFRAB2_F,SFRABO_F,NETTO_F,NETTO_ENHET_F,
SFVARE,SFVKUN,SFKPRI_F,SFKPRO,FLNAVN,FUNCTION_LINK,FUNCTION_LINK_TEXT
,json_ORDRETYPE,json_SFBIDA_F ,json_SFORNR,json_SFORSU,json_SFANTO_F ,
json_SFENHO,json_SFSAPR_F
,json_SFRAB1_P,json_SFRAB2_P,json_SFSUMB_F,json_BRUTTO_ENHET_F,json_NETTO_F,
json_NETTO_ENHET_F
,json_SFKPRO,json_SFKPRI_F,json_FLNAVN,json_FUNCTION_LINK,
json_FUNCTION_LINK_TEXT
)
AS
  WITH ST (SFFIRM,ORDRETYPE,SFBIDA,SFORNR,SFORSU,SFANTO,SFENHO,SFSUMB,
  SFSAPR,SFRAB1_P,SFRAB2_P,SFRABO_P,
       SFRAB1_KR,SFRAB2_KR,SFRABO_KR,SFVARE,SFVKUN,SFKPRI_F,SFKPRO,
	   FLNAVN) as (
    SELECT
    SFFIRM
    , (SELECT vaotxt FROM VOTYPF WHERE VAOFIR = sffirm AND vaotyp =
	SFOTYP) AS ORDRETYPE
    , SFBIDA
    , SFORNR
    , SFORSU
    , SFANTO
    , SFENHO
    , SFSUMB
    , CAST( COALESCE(SDSAPR, (SFSUMO/SFANTO), 0.0) AS DECIMAL(15, 2))
	AS SFSAPR
    , CAST( COALESCE(SDRAB1, ROUND((100-(((SFSUMB-SFRAB1)/SFSUMB)*100)),
	1), 0.0) AS DECIMAL(5, 2)) AS SFRAB1_P
    , CAST( COALESCE(SDRAB2,
	ROUND((100-((((SFSUMB-SFRAB1)-SFRAB2)/(SFSUMB-SFRAB1))*100)), 1), 0.0) AS
	DECIMAL(5, 2)) AS SFRAB2_P
    , CAST( COALESCE(SORABP, 0.0) AS DECIMAL(5, 2)) SFRABO_P
    , SFRAB1 AS SFRAB1_KR
    , SFRAB2 AS SFRAB2_KR
    , SFRABO AS SFRABO_KR
    , SFVARE
    , SFVKUN
    , CASE
       WHEN SFKPRI=''A'' THEN ''Avtale''
       WHEN SFKPRI=''B'' THEN ''Brutto''
       WHEN SFKPRI=''F'' THEN ''Fast''
       WHEN SFKPRI=''N'' THEN ''Netto''
       WHEN SFKPRI=''T'' THEN ''Tilbud''
       ELSE '''' END SFKPRI_F
    , SFKPRO
    , CASE WHEN SFKPRO=0 THEN '''' ELSE (SELECT COALESCE(FLNAVN, ''SLETTET'')
	FROM FKPRPF WHERE FLFIRM=SFFIRM AND FLKUND = SFVKUN AND FLKPRO=SFKPRO) END
	AS FLNAVN
    FROM SSTAPF A
    LEFT OUTER JOIN SODTPF ON SDFIRM = SFFIRM AND SDAARR = SFPAAR AND SDNUMM =
	SFORNR AND SDSUFF = SFORSU AND SDLINE = SFORLI
    LEFT OUTER JOIN SOHEPF ON SOFIRM = SFFIRM AND SOAARR = SFPAAR AND SONUMM =
	SFORNR AND SOSUFF = SFORSU
    WHERE (SFSUMB <> 0.00) AND (SFANTO <> 0.00) AND (SFVARE =
	VARELINJER_JSON_NWL_VIEW_VARE)
    AND (SFFIRM = VARELINJER_JSON_NWL_VIEW_FIRM) AND (SFVKUN =
	VARELINJER_JSON_NWL_VIEW_KUNDE OR VARELINJER_JSON_NWL_VIEW_KUNDE = 0)
    AND ((VARELINJER_JSON_NWL_VIEW_NOT_ORDRE = 0) OR NOT((SFORNR =
	VARELINJER_JSON_NWL_VIEW_NOT_ORDRE) AND (SFORSU =
	VARELINJER_JSON_NWL_VIEW_NOT_SUFFIX)))
  )
  ,FO (SFFIRM,ORDRETYPE,SFBIDA,SFORNR,SFORSU,SFANTO,SFENHO,SFSUMB,
  SFSAPR,SFRAB1_P,SFRAB2_P,SFRABO_P
     ,SFRAB1_KR,SFRAB2_KR,SFRABO_KR,SFVARE,SFVKUN,SFKPRI_F,SFKPRO,FLNAVN) as (
    SELECT
    FDFIRM
    , (SELECT vaotxt FROM VOTYPF WHERE VAOFIR = fdfirm AND vaotyp = (SELECT
	footyp FROM fohepf WHERE fofirm = fdfirm AND fonumm = fdnumm AND fosuff =
	fdsuff)) AS ORDRETYPE
    , FOBDAT
    , FDNUMM
    , FDSUFF
    , FDANTA
    , FDENH1
    , FDSUMS
    , FDSAPR
    , FDRAB1
    , FDRAB2
    , FORABP
    , ((fdsums * fdrab1) / 100) as FDRAB1_KR
    , (((fdsums - ((fdsums * fdrab1) / 100)) * fdrab2) / 100) as FDRAB2_KR
    ,  (((fdsums - ((fdsums * fdrab1) / 100) - (((fdsums - ((fdsums * fdrab1)/
	100)) * fdrab2) / 100) ) * forabp) / 100 ) as FORABP_KR
    , FDVARE
    , FDKUND
    , CASE
      WHEN FDKPRI=''A'' THEN ''Avtale''
      WHEN FDKPRI=''B'' THEN ''Brutto''
      WHEN FDKPRI=''F'' THEN ''Fast''
      WHEN FDKPRI=''N'' THEN ''Netto''
      WHEN FDKPRI=''T'' THEN ''Tilbud''
      ELSE '''' END SFKPRI_F
    , FOKPRO
    , CASE WHEN FOKPRO=0 THEN '''' ELSE (SELECT COALESCE(FLNAVN, ''SLETTET'')
	FROM FKPRPF WHERE FLFIRM=FDFIRM AND FLKUND=FOKUND AND FLKPRO=FOKPRO) END AS
	FLNAVN
    FROM FODTPF A
    INNER JOIN FOHEPF ON FOFIRM = FDFIRM AND FONUMM = FDNUMM AND FOSUFF =
	FDSUFF
    WHERE (FDSUMS <> 0.00) AND (FDANTA <> 0.00) AND (FDVARE =
	VARELINJER_JSON_NWL_VIEW_VARE )
    AND (FDFIRM = VARELINJER_JSON_NWL_VIEW_FIRM) AND (FDKUND =
	VARELINJER_JSON_NWL_VIEW_KUNDE OR VARELINJER_JSON_NWL_VIEW_KUNDE = 0)
    AND ((VARELINJER_JSON_NWL_VIEW_NOT_ORDRE = 0) OR NOT((FDNUMM =
	VARELINJER_JSON_NWL_VIEW_NOT_ORDRE) AND (FDSUFF =
	VARELINJER_JSON_NWL_VIEW_NOT_SUFFIX)))
  )
  , ST_FO as (
    (SELECT * FROM ST)
  UNION ALL
    (SELECT * FROM FO)
  ORDER BY SFBIDA desc FETCH FIRST VARELINJER_JSON_NWL_VIEW_FETCH ROWS ONLY
  )
  , ST_FO2 (SFFIRM,ORDRETYPE,SFBIDA_F,SFBIDA,SFORNR,SFORSU,SFANTO_F,SFENHO,
  SFSUMB_F,SFSAPR_F,SFRAB1_P,SFRAB2_P,SFRABO_P,BRUTTO_ENHET_F,SFRAB1_F,
  SFRAB2_F,SFRABO_F,NETTO_F
  ,NETTO_ENHET_F,SFVARE,SFVKUN,SFKPRI_F,SFKPRO,FLNAVN,FUNCTION_LINK,
  FUNCTION_LINK_TEXT) as (
    SELECT
    SFFIRM
    , ORDRETYPE
    , adb.nwl_date_fmt(SFBIDA) as SFBIDA_F
    , SFBIDA
    , SFORNR
    , SFORSU
    , SFANTO AS SFANTO_F
    , SFENHO
    , SFSUMB AS SFSUMB_F
    , SFSAPR AS SFSAPR_F
    , SFRAB1_P AS SFRAB1_P
    , SFRAB2_P AS SFRAB2_P
    , SFRABO_P AS SFRABO_P
    , ((SFSUMB)/SFANTO) as BRUTTO_ENHET_F
    , SFRAB1_KR AS SFRAB1_F
    , SFRAB2_KR AS SFRAB2_F
    , SFRABO_KR AS SFRABO_F
    , (SFSUMB-SFRAB1_KR-SFRAB2_KR) as NETTO_F
    , ((SFSUMB-SFRAB1_KR-SFRAB2_KR)/SFANTO) as NETTO_ENHET_F
    , SFVARE
    , SFVKUN
    , SFKPRI_F
    , SFKPRO
    , FLNAVN
    , ''CopyPrice('''''' concat SFSAPR concat '''''','''''' concat SFRAB1_P
	concat '''''','''''' concat SFRAB2_P concat '''''', '''''' concat SFENHO
	concat '''''')'' as FUNCTION_LINK
    , ''Hent pris for enhet'' as FUNCTION_LINK_TEXT
    FROM ST_FO
    )
  , ST_FO_J as (
  select SFFIRM,ORDRETYPE,SFBIDA_F,SFBIDA,SFORNR,SFORSU,SFANTO_F,SFENHO,
  SFSUMB_F,SFSAPR_F,SFRAB1_P,SFRAB2_P,SFRABO_P,BRUTTO_ENHET_F,SFRAB1_F,
  SFRAB2_F,SFRABO_F,NETTO_F,NETTO_ENHET_F,SFVARE,SFVKUN,SFKPRI_F,SFKPRO,
  FLNAVN,FUNCTION_LINK,FUNCTION_LINK_TEXT
      ,JSON_Object(''D'': Trim(ORDRETYPE),      ''T'' : ''200''
	  Absent on NULL
	  Returning VarChar(60) CCSID 1208) as json_ORDRETYPE
      ,JSON_Object(''D'': Trim(SFBIDA_F),       ''T'' : ''200''  Absent
	  on NULL Returning VarChar(50)  CCSID 1208) as json_SFBIDA_F
      ,JSON_Object(''D'': Trim(SFORNR),       ''T'' : ''I''  Absent
	  on NULL Returning VarChar(50)  CCSID 1208) as json_SFORNR
      ,JSON_Object(''D'': Trim(SFORSU),       ''T'' : ''I''  Absent
	  on NULL Returning VarChar(50)  CCSID 1208) as json_SFORSU
      ,JSON_Object(''D'': Trim(SFANTO_F),       ''T'' : ''N3''  Absent
	  on NULL Returning VarChar(70)  CCSID 1208) as json_SFANTO_F
      ,JSON_Object(''D'': Trim(SFENHO),       ''T'' : ''200''  Absent
	  on NULL Returning VarChar(50)  CCSID 1208) as json_SFENHO
      ,JSON_Object(''D'': Trim(SFSAPR_F),       ''T'' : ''N2''  Absent
	  on NULL Returning VarChar(70)  CCSID 1208) as json_SFSAPR_F
      ,JSON_Object(''D'': Trim(SFRAB1_P),       ''T'' : ''N''  Absent
	  on NULL Returning VarChar(70)  CCSID 1208) as json_SFRAB1_P
      ,JSON_Object(''D'': Trim(SFRAB2_P),       ''T'' : ''N''  Absent
	  on NULL Returning VarChar(70)  CCSID 1208) as json_SFRAB2_P
      ,JSON_Object(''D'': Trim(SFSUMB_F),       ''T'' : ''N2''  Absent
	  on NULL Returning VarChar(70) CCSID 1208) as json_SFSUMB_F
      ,JSON_Object(''D'': Trim(BRUTTO_ENHET_F),   ''T'' : ''N2''  Absent
	  on NULL Returning VarChar(70) CCSID 1208) as json_BRUTTO_ENHET_F
      ,JSON_Object(''D'': Trim(NETTO_F),      ''T'' : ''N2''  Absent
	  on NULL Returning VarChar(70) CCSID 1208) as json_NETTO_F
      ,JSON_Object(''D'': Trim(NETTO_ENHET_F),    ''T'' : ''N2''  Absent
	  on NULL Returning VarChar(70) CCSID 1208) as json_NETTO_ENHET_F
      ,JSON_Object(''D'': Trim(SFKPRO),       ''T'' : ''I''  Absent on
	  NULL Returning VarChar(50) CCSID 1208) as json_SFKPRO
      ,JSON_Object(''D'': Trim(SFKPRI_F),       ''T'' : ''200''  Absent on
	  NULL Returning VarChar(100) CCSID 1208) as json_SFKPRI_F
      ,JSON_Object(''D'': Trim(FLNAVN),       ''T'' : ''200''  Absent on
	  NULL Returning VarChar(100) CCSID 1208) as json_FLNAVN
      ,JSON_Object(''D'': Trim(FUNCTION_LINK),    ''T'' : ''200''  Absent on
	  NULL Returning VarChar(100) CCSID 1208) as json_FUNCTION_LINK
      ,JSON_Object(''D'': Trim(FUNCTION_LINK_TEXT), ''T'' : ''200''  Absent on
	  NULL Returning VarChar(100) CCSID 1208) as json_FUNCTION_LINK_TEXT
  FROM ST_FO2
  )
  SELECT * FROM ST_FO_J
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NLVARLBS IS 'NewlookView Varelinjer BASE';


-------- VARELINJER_JSON_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VARELINJER_JSON_NWL_VIEW FOR SYSTEM NAME NLVARLJS
(SFFIRM,SFVARE,SFVKUN,JOBJ)
AS
  with h as (
  select JSON_ArrayAgg(JSON_Object(''N'' : h1) Returning VarChar(500)
  CCSID 1208) as ObjH from (
  values (''Ordretype''),(''Billagsdato''),(''Ordrenummer''),(''Suffiks''),
  (''Antall ordre''),(''Enhet ordre'')
    ,(''Salgspris''),(''Rabatt1''),(''Rabatt2'')
    ,(''Netto pr enh''),(''Netto''),(''Priskode''),(''Kundeprosjekt''),
	(''Kundeprosjekt''),(''FUNCTION_LINK''),(''FUNCTION_LINK_TEXT'')
  ) hh(h1)
  )
  , th as (
    select JSON_Object(''tr'': ObjH Format JSON Returning VarChar(500)
	CCSID 1208) as ObjTr from h
  )
  , ST_FO_J AS (
  SELECT * FROM VARELINJER_BASE_NWL_VIEW
  )
  , tds as (
    select SFFIRM,SFVARE,SFVKUN
      ,JSON_ArrayAgg(
        JSON_Array(
        json_ORDRETYPE Format JSON,json_SFBIDA_F Format JSON,
		json_SFORNR Format JSON,json_SFORSU Format JSON
        ,json_SFANTO_F  Format JSON,json_SFENHO Format JSON,
		json_SFSAPR_F Format JSON
         ,json_SFRAB1_P Format JSON,json_SFRAB2_P Format JSON
         ,json_NETTO_ENHET_F Format JSON, json_NETTO_F Format JSON,
		 json_SFKPRI_F Format JSON
         ,json_SFKPRO Format JSON,json_FLNAVN Format JSON,json_FUNCTION_LINK
		 Format JSON,json_FUNCTION_LINK_TEXT Format JSON
         Returning VarChar(30000) CCSID 1208
        )
      Returning VarChar(31000) CCSID 1208) as ObjRad
    FROM ST_FO_J
    GROUP BY SFFIRM,SFVARE,SFVKUN
  )
  , JS as (
    select SFFIRM,SFVARE,SFVKUN
    ,JSON_Object(
      ''table'' : ''VARELINJER_NWL_VIEW'',
      ''showheader'' : ''Siste kjøp av denne varen'',
      ''theader'': ObjTr Format JSON,
      ''tablerows'': ObjRad Format JSON
      Returning VarChar(32000) CCSID 1208
    ) as ObjT
    FROM TH, TDS
  )
  select SFFIRM,SFVARE,SFVKUN, JSON_Object(''htmltable'': ObjT Format
  JSON Returning VarChar(32000) CCSID 1208) as JOBJ
  FROM JS
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NLVARLJS IS 'NewlookView Varelinjer JSON';

-------- VARELINJER2_JSON_NWL_VIEW -----------------
----------------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VARELINJER2_JSON_NWL_VIEW FOR SYSTEM NAME NLVA2LJS
(SFFIRM,SFVARE,JOBJ)
AS
  with h as (
  select JSON_ArrayAgg(JSON_Object(''N'' : h1) Returning VarChar(500)
  CCSID 1208) as ObjH from (
  values (''Ordretype''),(''Billagsdato''),(''Ordrenummer''),(''Suffiks''),
  (''Antall ordre''),(''Enhet ordre''),(''Brutto''),(''Brutto pr enh'')
    ,(''Netto''),(''Netto pr enh''),(''Kundeprosjekt''),(''Kundeprosjekt'')
  ) hh(h1)
  )
  , th as (
    select JSON_Object(''tr'': ObjH Format JSON Returning VarChar(1000)
	CCSID 1208) as ObjTr from h
  )
  , ST_FO_J AS (
  SELECT * FROM VARELINJER_BASE_NWL_VIEW
  )
  , tds as (
    select SFFIRM,SFVARE
      ,JSON_ArrayAgg(
        JSON_Array(
        json_ORDRETYPE Format JSON,json_SFBIDA_F Format JSON,json_SFORNR
		Format JSON,json_SFORSU Format JSON
        ,json_SFANTO_F  Format JSON,json_SFENHO Format JSON,json_SFSAPR_F
		Format JSON
         ,json_SFRAB1_P Format JSON,json_SFRAB2_P Format JSON
         ,json_NETTO_ENHET_F Format JSON,json_NETTO_F Format JSON
         ,json_SFKPRO Format JSON,json_FLNAVN Format JSON
         Returning VarChar(10000) CCSID 1208
        )
      Returning VarChar(15000) CCSID 1208) as ObjRad
    FROM ST_FO_J
    GROUP BY SFFIRM,SFVARE
  )
  , JS as (
    select SFFIRM,SFVARE
    ,JSON_Object(
      ''table'' : ''VARELINJER_NWL_VIEW'',
      ''showheader'' : ''Siste kjøp av denne varen'',
      ''theader'': ObjTr Format JSON,
      ''tablerows'': ObjRad Format JSON
      Returning VarChar(20000) CCSID 1208
    ) as ObjT
    FROM TH, TDS
  )
  select SFFIRM,SFVARE, JSON_Object(''htmltable'': ObjT Format JSON Returning
  VarChar(25000) CCSID 1208) as JOBJ
  FROM JS
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NLVA2LJS IS 'NewlookView Varelinjer JSON';


  END IF;  -- stopp tabell

-- FODTPF
  IF  (UPPER(TRIM(p_table)) = 'FODTPF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN

-------- VARELINJER_ORDRE_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW VARELINJER_ORDRE_NWL_VIEW FOR SYSTEM NAME NWLVLOVIEW
(FDFIRM,FDNUMM,FDSUFF,FDLINE,FDVARE,FDTEKT,FDANTA_F,FDENH1,FDSAPR_F,FDRABT_F)
AS
  SELECT
     FDFIRM
    ,FDNUMM
    ,FDSUFF
    ,FDLINE
    ,FDVARE
    ,RTRIM(ADB.nwl_json_clean(FDTEK1)) concat '' '' concat RTRIM(
	ADB.nwl_json_clean(FDTEK2)) AS FDTEKT
    ,ADB.nwl_num_fmt(FDANTA, 3) as FDANTA_F
    ,FDENH1
    ,ADB.nwl_num_fmt(FDSAPR, 2) AS FDSAPR_F
    ,ADB.nwl_num_fmt((CASE WHEN FDSUMR=0 THEN 0 ELSE
	ROUND((FDSUMR*100)/FDSUMS, 2) END ), 2) AS FDRABT_F
  FROM FODTPF
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLVLOVIEW IS 'NewlookView VarelinjerOrdre';

  END IF;  -- stopp tabell

-- RKUNPF
  IF (UPPER(TRIM(p_table)) = 'RKUNPF'
  OR  UPPER(TRIM(p_table)) = 'RKMEPF'
  OR  UPPER(TRIM(p_table)) = 'RA11PF'
  OR  UPPER(TRIM(p_table)) = 'RA06PF'
  OR  UPPER(TRIM(p_table)) = 'RA03PF'
  OR  UPPER(TRIM(p_table)) = 'RKTRPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN



-------- KUNDEDETALJ_1_NWL_VIEW -----------------
--  FAAK03 <> 5  : IKKE NAV
--  FAAK03 = 5   : NAV
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW KUNDEDETALJ_1_NWL_VIEW  FOR SYSTEM NAME NWLKD1VIEW
(LINJENR,HVA,RKFIRM ,RKKUND,VERDI)
AS
  SELECT 0 AS LINJENR, ''Kunde'' AS HVA        , RKFIRM ,RKKUND , CAST((RKKUND
  concat '' '' concat ADB.nwl_json_clean(RKNAVN))AS VARCHAR(50))
  AS VERDI FROM RKUNPF A UNION ALL
  SELECT 1 AS LINJENR, ''Mobilnr'' AS HVA      , RKFIRM ,RKKUND , CAST(RKMOBN
  AS VARCHAR(50))                                                   AS VERDI
  FROM RKUNPF A UNION ALL
  SELECT 2 AS LINJENR, ''Epost'' AS HVA        , RKFIRM ,RKKUND , CAST(RKEMAL
  AS VARCHAR(50))                                                   AS VERDI
  FROM RKUNPF A UNION ALL
  SELECT 3 AS LINJENR, ''Kredittgrense'' AS HVA    , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE CAST((RKGRNS * 1000) concat '',00'' AS
  VARCHAR(50)) END  )                    AS VERDI FROM RKUNPF A UNION ALL
  SELECT 4 AS LINJENR, ''Disponibel kreditt'' AS HVA , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE
      COALESCE(CAST(((RKGRNS * 1000) - ((SELECT (CAST(sum(RNREST) AS BIGINT))
	  FROM RKTRPF C WHERE C.RNKUND = A.RKKUND AND  C.RNFIRM = A.RKFIRM) + (SELECT
	  (CAST((RKMEMS*1.25) AS BIGINT)) FROM RKMEPF B WHERE B.RKFIRM = A.RKFIRM AND
	  B.RKKUND = A.RKKUND))) concat '',00'' AS VARCHAR(50)),'''')  END  )
      AS VERDI FROM RKUNPF A, FSTSPF WHERE FAAFIR = RKFIRM  AND FAAK03 <> 5
	  UNION ALL
  SELECT 4 AS LINJENR, ''Disponibel kreditt'' AS HVA , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE
      COALESCE(CAST(((RKGRNS * 1000) - ((CAST((RKSALD) AS BIGINT)) + (SELECT
	  (CAST((RKMEMS*1.25) AS BIGINT)) FROM RKMEPF B WHERE B.RKFIRM = A.RKFIRM
	  AND B.RKKUND = A.RKKUND))) concat '',00'' AS VARCHAR(50)),'''')  END  )
      AS VERDI FROM RKUNPF A, FSTSPF WHERE FAAFIR = RKFIRM  AND FAAK03 = 5
	  UNION ALL
  SELECT 5 AS LINJENR, ''Ordreverdi inkl. mva'' AS HVA , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT CAST((COALESCE(RKMEMS, 0))*1.25 AS BIGINT) FROM
  RKMEPF B WHERE B.RKFIRM = A.RKFIRM AND B.RKKUND = A.RKKUND) concat '',00''
  AS VARCHAR(50)),'''')  AS VERDI FROM RKUNPF A UNION ALL
  SELECT 7 AS LINJENR, ''Kundekategori'' AS HVA    , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKKATG concat '' - '' concat RAKTXT FROM RA11PF WHERE
  RAKFIR = RKFIRM AND RAKKOD = RKKATG) AS VARCHAR(50)),'''')  AS VERDI FROM
  RKUNPF A UNION ALL
  SELECT 8 AS LINJENR, ''Rabattkategori'' AS HVA   , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKRABK concat '' - '' concat RAFTXT FROM RA06PF
  WHERE RAFFIR = RKFIRM AND RAFKOD = RKRABK) AS VARCHAR(50)),'''')  AS
  VERDI FROM RKUNPF A UNION ALL
  SELECT 9 AS LINJENR, ''Betalingsbetingelse'' AS HVA, RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKBETB concat '' - '' concat RACTXT FROM RA03PF
  WHERE RACFIR = RKFIRM AND RACKOD = RKBETB) AS VARCHAR(50)),'''')  AS VERDI
  FROM RKUNPF A  UNION ALL
  SELECT 10 AS LINJENR, ''Selger'' AS HVA, RKFIRM ,RKKUND , COALESCE(
  CAST((SELECT RAITXT FROM RA09PF B WHERE B.RAIFIR = A.RKFIRM AND B.RAIKOD =
  A.RKSLGR) AS VARCHAR(50)),'''')             AS VERDI FROM RKUNPF A UNION ALL
  SELECT 11 AS LINJENR, ''Sperret'' AS HVA       , RKFIRM ,RKKUND , (CASE WHEN
  RKSPRK=''J'' THEN ''KUNDE_SPERRET'' ELSE ''nei'' END)
  AS VERDI FROM RKUNPF A UNION ALL
  SELECT 12 AS LINJENR, ''E-handelskunde'' AS HVA       , RKFIRM ,RKKUND ,
  (CASE WHEN RKEBIZ=0 THEN '' '' ELSE CAST(RKEBIZ AS VARCHAR(50)) END)
  AS VERDI FROM RKUNPF A
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKD1VIEW IS 'NewlookView Kundedetalj1';

  IF  (SELECT COUNT(*) FROM QSYS2.SYSTABLES WHERE SYSTEM_TABLE_SCHEMA = p_lib
  AND TABLE_NAME='ZKUNST') = 1  THEN
  --IF (SELECT COUNT(*) FROM ZKUNST) > 0 THEN

SET stmt = '
CREATE OR REPLACE VIEW KUNDEDETALJ_1_MGR_NWL_VIEW FOR SYSTEM NAME NWLKDMVIEW
(LINJENR,HVA,RKFIRM ,RKKUND,VERDI)
AS
  SELECT 0 AS LINJENR, ''Kunde'' AS HVA        , RKFIRM ,RKKUND , CAST((RKKUND
  concat '' '' concat ADB.nwl_json_clean(RKNAVN))AS VARCHAR(50))
  AS VERDI FROM RKUNPF A UNION ALL
  SELECT 1 AS LINJENR, ''Mobilnr'' AS HVA      , RKFIRM ,RKKUND , CAST(RKMOBN
  AS VARCHAR(50))                                                   AS VERDI
  FROM RKUNPF A UNION ALL
  SELECT 2 AS LINJENR, ''Epost'' AS HVA        , RKFIRM ,RKKUND , CAST(RKEMAL
  AS VARCHAR(50))                                                   AS VERDI
  FROM RKUNPF A UNION ALL
  SELECT 3 AS LINJENR, ''Kredittgrense'' AS HVA    , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE CAST((RKGRNS * 1000) concat '',00'' AS
  VARCHAR(50)) END  )                    AS VERDI FROM RKUNPF A UNION ALL
  SELECT 4 AS LINJENR, ''Disponibel kreditt'' AS HVA , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE
      COALESCE(CAST(((RKGRNS * 1000) - ((SELECT (CAST(sum(RNREST) AS BIGINT))
	  FROM RKTRPF C WHERE C.RNKUND = A.RKKUND AND  C.RNFIRM = A.RKFIRM) + (SELECT
	  (CAST((RKMEMS*1.25) AS BIGINT)) FROM RKMEPF B WHERE B.RKFIRM = A.RKFIRM AND
	  B.RKKUND = A.RKKUND))) concat '',00'' AS VARCHAR(50)),'''')  END  )
      AS VERDI FROM RKUNPF A, FSTSPF WHERE FAAFIR = RKFIRM  AND FAAK03 <> 5
	  UNION ALL
  SELECT 4 AS LINJENR, ''Disponibel kreditt'' AS HVA , RKFIRM ,RKKUND , (CASE
  WHEN RKGRNS=0 THEN '' '' ELSE
      COALESCE(CAST(((RKGRNS * 1000) - ((CAST((RKSALD) AS BIGINT)) + (SELECT
	  (CAST((RKMEMS*1.25) AS BIGINT)) FROM RKMEPF B WHERE B.RKFIRM = A.RKFIRM AND
	  B.RKKUND = A.RKKUND))) concat '',00'' AS VARCHAR(50)),'''')  END  )
      AS VERDI FROM RKUNPF A, FSTSPF WHERE FAAFIR = RKFIRM  AND FAAK03 = 5
	  UNION ALL
  SELECT 5 AS LINJENR, ''Ordreverdi inkl. mva'' AS HVA , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT CAST((COALESCE(RKMEMS, 0))*1.25 AS BIGINT) FROM RKMEPF
  B WHERE B.RKFIRM = A.RKFIRM AND B.RKKUND = A.RKKUND) concat '',00'' AS
  VARCHAR(50)),'''')  AS VERDI FROM RKUNPF A UNION ALL
  SELECT 7 AS LINJENR, ''Kundekategori'' AS HVA    , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKKATG concat '' - '' concat RAKTXT FROM RA11PF WHERE
  RAKFIR = RKFIRM AND RAKKOD = RKKATG) AS VARCHAR(50)),'''')  AS VERDI FROM
  RKUNPF A UNION ALL
  SELECT 8 AS LINJENR, ''Rabattkategori'' AS HVA   , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKRABK concat '' - '' concat RAFTXT FROM RA06PF WHERE
  RAFFIR = RKFIRM AND RAFKOD = RKRABK) AS VARCHAR(50)),'''')  AS VERDI FROM
  RKUNPF A UNION ALL
  SELECT 9 AS LINJENR, ''Betalingsbetingelse'' AS HVA, RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT RKBETB concat '' - '' concat RACTXT FROM RA03PF WHERE
  RACFIR = RKFIRM AND RACKOD = RKBETB) AS VARCHAR(50)),'''')  AS VERDI FROM
  RKUNPF A  UNION ALL
  SELECT 10 AS LINJENR, ''Selger'' AS HVA, RKFIRM ,RKKUND , COALESCE(CAST((
  SELECT RAITXT FROM RA09PF B WHERE B.RAIFIR = A.RKFIRM AND B.RAIKOD =
  A.RKSLGR)
  AS VARCHAR(50)),'''')             AS VERDI FROM RKUNPF A UNION ALL
  SELECT 11 AS LINJENR, ''Sperret'' AS HVA       , RKFIRM ,RKKUND , (CASE WHEN
  RKSPRK=''J'' THEN ''KUNDE_SPERRET'' ELSE ''nei'' END)
  AS VERDI FROM RKUNPF A  UNION ALL
  SELECT 12 AS LINJENR, ''Zilliant kundegruppe'' AS HVA  , RKFIRM ,RKKUND ,
  COALESCE(CAST((SELECT KUNDEGRUPPE FROM ZKUNST B WHERE B.FIRMA = A.RKFIRM AND
  B.KUNDENUMMER = A.RKKUND) AS VARCHAR(50)),'''') AS VERDI FROM RKUNPF A
  UNION ALL
  SELECT 13 AS LINJENR, ''Zilliant kundekjøpstype'' AS HVA , RKFIRM ,RKKUND
  , COALESCE(CAST((SELECT KUNDEKJOPSTYPE FROM ZKUNST B WHERE B.FIRMA = A.RKFIRM
  AND B.KUNDENUMMER = A.RKKUND) AS VARCHAR(50)),'''') AS VERDI FROM RKUNPF A
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKDMVIEW IS 'NewlookView Kundedetalj1 MGR';

  --END IF;  -- stopp tabell SJEKK ZKUNST count
  END IF;  -- stopp tabell SJEKK ZKUNST

  END IF;  -- stopp tabell



-- FOHEPF
  IF  (UPPER(TRIM(p_table)) = 'FOHEPF'
  OR   UPPER(TRIM(p_table)) = 'SOHEPF'
  OR   UPPER(TRIM(p_table)) = 'VOTYPF'
  OR   UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- KUNDEDETALJ_2_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW KUNDEDETALJ_2_NWL_VIEW  FOR SYSTEM NAME NWLKD2VIEW
(TABELL, FIRM, KUND , ORDRETEKST, AKKUMULATOR, ANTALL, FUNCTION_LINK, PARM1,
 PARM2, PARM3)
AS
  (
    SELECT ''Ordre'' AS Tabell, fofirm AS FIRM, fokund AS KUND, vaotxt AS
	Ordretekst, vaoakk AS Akkumulator, count(*) AS Antall
    , ''ShowOrdreForCustomer('''''' concat FOFIRM concat '''''', ''''''
	concat FOKUND concat '''''', '''''' concat VAOTYP concat '''''')'' as
	FUNCTION_LINK, FOFIRM, FOKUND, VAOTYP
    FROM FOHEPF
    LEFT JOIN votypf ON vaofir = FOFIRM AND vaotyp = FOOTYP
    GROUP BY fofirm, fokund, vaotxt, vaoakk,vaotyp
  )
  UNION ALL
  (
    SELECT ''Faktura'' AS Tabell, sofirm AS FIRM, sokund AS KUND, vaotxt
	AS Ordretekst, vaoakk AS Akkumulator, count(*) AS Antall
    , ''ShowFakturaForCustomer('''''' concat SOFIRM concat '''''', ''''''
	concat SOKUND concat '''''', '''''' concat VAOTYP concat '''''')'' as
	FUNCTION_LINK, SOFIRM, SOKUND, VAOTYP
    FROM SOHEPF
    LEFT JOIN votypf ON vaofir = SOFIRM AND vaotyp = SOOTYP
    WHERE year(sodate) = year(CURRENT_DATE)
    GROUP BY sofirm, sokund, vaotxt, vaoakk,vaotyp
  )
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKD2VIEW IS 'NewlookView Kundedetalj2';

  END IF;  -- stopp tabell

-- RKTRPF
  IF  (UPPER(TRIM(p_table)) = 'RKTRPF'
  OR   UPPER(TRIM(p_table)) = 'RKMEPF'
  OR   UPPER(TRIM(p_table)) = 'RKUNPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN


-------- KUNDEDETALJ_3_NWL_VIEW -----------------
--  FAAK03 <> 5  : IKKE NAV
--  FAAK03 = 5   : NAV
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW KUNDEDETALJ_3_NWL_VIEW FOR SYSTEM NAME NWLKD3VIEW
  (LINJENR,HVA,FIRM ,KUND,VERDI,FUNCTION_LINK,FUNCTION_LINK_TEXT,PARM1,PARM2)
  AS
  (
    SELECT  0 AS LINJENR, ''Saldo inkl. mva'' AS Tekst, rnfirm AS FIRM,
	rnkund AS KUND , ADB.nwl_num_fmt(sum(rnrest), 2) AS Verdi
    , ''ShowSaldoForCustomer('''''' concat rnfirm concat '''''', ''''''
	concat rnkund concat '''''')'' as FUNCTION_LINK
    , ''Vis mer om saldo'' as FUNCTION_LINK_TEXT
    , RNFIRM, RNKUND
    FROM RKTRPF, FSTSPF
    WHERE rnrest <> 0 AND FAAFIR = RNFIRM AND FAAK03 <> 5
    GROUP BY RNFIRM, RNKUND
  )
  UNION ALL
  (
    SELECT  0 AS LINJENR, ''Saldo inkl. mva'' AS Tekst, rkfirm AS FIRM,
	rkkund AS KUND ,ADB.nwl_num_fmt(RKSALD, 2) AS Verdi
    , ''NOT_SHOW'' as FUNCTION_LINK
    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
    , RKFIRM, RKKUND
    FROM RKUNPF, FSTSPF
    WHERE FAAFIR = RKFIRM AND FAAK03 = 5
  )
  UNION ALL
  (
    SELECT  1 AS LINJENR, ''Ordreverdi eks. mva'' AS Tekst, rkfirm AS FIRM,
	rkkund AS KUND ,ADB.nwl_num_fmt(rkmems, 2) AS Verdi
    , ''NOT_SHOW'' as FUNCTION_LINK
    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
    , RKFIRM, RKKUND
    FROM rkmepf, FSTSPF
    WHERE FAAFIR = RKFIRM AND FAAK03 <> 5
  )
  UNION ALL
  (
    SELECT 2 AS LINJENR, ''Forfalt per idag'' AS Tekst, rnfirm AS FIRM,
	rnkund AS KUND ,ADB.nwl_num_fmt(sum(rnrest), 2) AS Verdi
    , ''ShowOverdueOrderForCustomer('''''' concat rnfirm concat '''''',
	'''''' concat rnkund concat '''''')'' as FUNCTION_LINK
    , ''Vis mer om forfalt idag'' as FUNCTION_LINK_TEXT
    , rnfirm, rnkund
    FROM RKTRPF, FSTSPF
    WHERE rnfdat <= CURRENT_DATE AND rnrest <> 0  AND FAAFIR = RNFIRM AND
	FAAK03 <> 5
    GROUP BY rnfirm, RNKUND
  )
--  UNION ALL
--  (
--    SELECT 3 AS LINJENR, ''Kjøp i år'' AS Tekst, rkfirm AS FIRM, rkkund AS
KUND ,ADB.nwl_num_fmt(RKKJØP, 2) AS Verdi
--    , ''NOT_SHOW'' as FUNCTION_LINK
--    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
--    , RKFIRM, RKKUND
--    FROM rkunpf, FSTSPF
--    WHERE FAAFIR = RKFIRM AND FAAK03 <> 5
--  )
  UNION ALL
  (
    SELECT 3 AS LINJENR, ''Kjøp i år'' AS Tekst, sffirm AS FIRM, sfvkun AS
	KUND ,ADB.nwl_num_fmt(sum(sfsumb - sfrab1 - sfrab2), 2) AS Verdi
    , ''NOT_SHOW'' as FUNCTION_LINK
    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
    , sffirm, sfvkun
    FROM sstapf, FSTSPF
    WHERE FAAFIR = sfFIRM --AND FAAK03 = 5
    AND SFPAAR = YEAR(CURRENT_DATE) AND SFOTYP IN (SELECT VAOTYP FROM VOTYPF
	WHERE VAOFIR = SFFIRM AND VAOOKO = 1)
    GROUP BY SFFIRM, SFVKUN
  )
--  UNION ALL
--  (
--    SELECT 4 AS LINJENR, ''Kjøp i fjor'' AS Tekst, rkfirm AS FIRM, rkkund
AS KUND ,ADB.nwl_num_fmt(RKKJØF, 2) AS Verdi
--    , ''NOT_SHOW'' as FUNCTION_LINK
--    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
--    , RKFIRM, RKKUND
--    FROM rkunpf, FSTSPF
--    WHERE FAAFIR = RKFIRM AND FAAK03 <> 5
--  )
  UNION ALL
  (
    SELECT 3 AS LINJENR, ''Kjøp i fjor'' AS Tekst, sffirm AS FIRM, sfvkun
	AS KUND ,ADB.nwl_num_fmt(sum(sfsumb - sfrab1 - sfrab2), 2) AS Verdi
    , ''NOT_SHOW'' as FUNCTION_LINK
    , ''NOT_SHOW'' as FUNCTION_LINK_TEXT
    , sffirm, sfvkun
    FROM sstapf, FSTSPF
    WHERE FAAFIR = sfFIRM --AND FAAK03 = 5
    AND SFPAAR = (YEAR(CURRENT_DATE)-1) AND SFOTYP IN (SELECT VAOTYP FROM
	VOTYPF WHERE VAOFIR = SFFIRM AND VAOOKO = 1)
    GROUP BY SFFIRM, SFVKUN
  )
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKD3VIEW IS 'NewlookView Kundedetalj3';

  END IF;  -- stopp tabell

-- FOHEPF
  IF  (UPPER(TRIM(p_table)) = 'FOHEPF'
  OR   UPPER(TRIM(p_table)) = 'RKUNPF'
  OR   UPPER(TRIM(p_table)) = 'RUKPPF'
  OR   UPPER(TRIM(p_table)) = 'FKPRPF'
  OR   UPPER(TRIM(p_table)) = 'RA09PF'
  OR   UPPER(TRIM(p_table)) = 'LOHEPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- ORDREDETALJ_1_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW ORDREDETALJ_1_NWL_VIEW  FOR SYSTEM NAME NWLOD1VIEW
(LINJENR,HVA,FOFIRM, FONUMM, FOSUFF,VERDI)
AS
  SELECT 0   AS LINJENR, ''Ordre'' AS HVA , FOFIRM, FONUMM, FOSUFF , CAST((
  FOOTYP CONCAT '' '' CONCAT FONUMM) AS VARCHAR(50)) AS VERDI FROM FOHEPF A
  UNION ALL
  SELECT 10  AS LINJENR, ''Lev dato'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(COALESCE(ADB.NWL_DATE_FMT(FOLDAT), '''') AS VARCHAR(50)) AS VERDI FROM
  FOHEPF A UNION ALL
  SELECT 20  AS LINJENR, ''Selger'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(COALESCE((SELECT RAITXT FROM RA09PF WHERE RAIFIR=FOFIRM AND RAIKOD=
  FOSELG), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF A UNION ALL
  SELECT 30  AS LINJENR, ''Kunderef'' AS HVA , FOFIRM, FONUMM, FOSUFF , CAST(
  FODREF AS VARCHAR(50)) AS VERDI FROM FOHEPF A UNION ALL
  SELECT 40  AS LINJENR, ''Kontaktperson tlf.'' AS HVA, FOFIRM, FONUMM,
  FOSUFF, CAST(COALESCE((SELECT RUMTLF FROM RUKPPF WHERE RUFIRM=FOFIRM AND
  RUKPNR=FOKPNR and RUKUND=FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF
  A UNION ALL
  SELECT 50  AS LINJENR, ''Kontaktperson e-post'' AS HVA, FOFIRM, FONUMM,
  FOSUFF, CAST(COALESCE((SELECT RUMAIL FROM RUKPPF WHERE RUFIRM=FOFIRM AND
  RUKPNR=FOKPNR and RUKUND=FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF
  A UNION ALL
  SELECT 60  AS LINJENR, ''Ordre tlf.'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(FOMOBI AS VARCHAR(50)) AS VERDI FROM FOHEPF A UNION ALL
  SELECT 70  AS LINJENR, ''Kundeprosjekt ref.'' AS HVA, FOFIRM, FONUMM,
  FOSUFF, CAST(COALESCE((SELECT FLKPRS FROM FKPRPF WHERE FLFIRM=FOFIRM AND
  FLKPRO=FOKPRO AND FLKUND=FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF
  A UNION ALL
  SELECT 80  AS LINJENR, ''Kundeprosjekt tlf.'' AS HVA, FOFIRM, FONUMM, FOSUFF
  , CAST(COALESCE((SELECT FLTLFM FROM FKPRPF WHERE FLFIRM=FOFIRM AND
  FLKPRO=FOKPRO AND FLKUND=FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF
  A UNION ALL
  SELECT 90  AS LINJENR, ''Kundeprosjekt e-post'' AS HVA, FOFIRM, FONUMM,
  FOSUFF, CAST(COALESCE((SELECT FLMAIL FROM FKPRPF WHERE FLFIRM=FOFIRM AND
  FLKPRO=FOKPRO AND FLKUND=FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF
  A UNION ALL
  SELECT 100  AS LINJENR, ''Kunde tlf.'' AS HVA, FOFIRM, FONUMM, FOSUFF,
  CAST(COALESCE((SELECT RKMOBN FROM RKUNPF WHERE RKFIRM=FOFIRM AND RKKUND=
  FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF A UNION ALL
  SELECT 100  AS LINJENR, ''Kunde e-post.'' AS HVA, FOFIRM, FONUMM, FOSUFF,
  CAST(COALESCE((SELECT RKEMAL FROM RKUNPF WHERE RKFIRM=FOFIRM AND RKKUND=
  FOKUND), '''') AS VARCHAR(50)) AS VERDI FROM FOHEPF A UNION ALL
  SELECT 110  AS LINJENR, ''Bestilling'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(COALESCE((SELECT CAST(LOOTYP AS VARCHAR(8)) FROM LOHEPF WHERE LOFIRM=
  FOFIRM AND LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0), '''')
  CONCAT  '' '' CONCAT CAST(COALESCE((SELECT LONUMM FROM LOHEPF WHERE
  LOFIRM=FOFIRM AND
  LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0), 0) AS VARCHAR(50)) AS
  VARCHAR(50)) AS VERDI FROM FOHEPF A
    WHERE (select count(*) from lohepf where LOFIRM=FOFIRM AND LOORNR=FONUMM
	AND LOORSU=FOSUFF AND LOSUFF=0)<=1 UNION ALL
  SELECT 111  AS LINJENR, ''Bestilling'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(''Flere bestillinger (10=Hist)'' AS VARCHAR(50)) AS VERDI FROM FOHEPF A
    WHERE (select count(*) from lohepf where LOFIRM=FOFIRM AND LOORNR=FONUMM
	AND	LOORSU=FOSUFF AND LOSUFF=0)>1 UNION ALL
  SELECT 120 AS LINJENR, ''Ønsket lev dato'' AS HVA , FOFIRM, FONUMM, FOSUFF ,
  CAST(COALESCE(ADB.NWL_DATE_FMT((SELECT LOLDAT FROM LOHEPF WHERE LOFIRM=
  FOFIRM AND LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0)), '''') AS
  VARCHAR(50)) AS VERDI FROM FOHEPF A WHERE (select count(*) from lohepf where
  LOFIRM=FOFIRM AND LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0)=1 UNION ALL
  SELECT 130 AS LINJENR, ''Bekreftet lev dato'' AS HVA , FOFIRM, FONUMM,
  FOSUFF , CAST(COALESCE(ADB.NWL_DATE_FMT((SELECT LOMODA FROM LOHEPF WHERE
  LOFIRM=FOFIRM AND LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0)), '''') AS
  VARCHAR(50)) AS VERDI FROM FOHEPF A WHERE (select count(*) from lohepf where
  LOFIRM=FOFIRM AND LOORNR=FONUMM AND LOORSU=FOSUFF AND LOSUFF=0)=1 UNION ALL
  SELECT 140 AS LINJENR, ''Vekt'' AS HVA , FOFIRM, FONUMM, FOSUFF , CAST((
  SELECT ADB.nwl_num_fmt(SUM(VEKT), 3) FROM VARELINJER_VEKT_NWL_VIEW WHERE
  FDFIRM=FOFIRM AND FDNUMM=FONUMM AND FDSUFF=FOSUFF GROUP BY FDFIRM,FDNUMM,
  FDSUFF) AS VARCHAR(50)) concat '' kg'' AS VERDI FROM FOHEPF A UNION ALL
  SELECT 150 AS LINJENR, ''Volum'' AS HVA , FOFIRM, FONUMM, FOSUFF , CAST((
  SELECT ADB.nwl_num_fmt(SUM(VOLUM), 3) FROM VARELINJER_VEKT_NWL_VIEW WHERE
  FDFIRM=FOFIRM AND FDNUMM=FONUMM AND FDSUFF=FOSUFF GROUP BY FDFIRM,FDNUMM,
  FDSUFF) AS VARCHAR(50)) concat '' m3'' AS VERDI FROM FOHEPF A
';
PREPARE s1 FROM stmt;
EXECUTE s1;


LABEL ON TABLE NWLOD1VIEW IS 'NewlookView Ordredetalj1';

  END IF;  -- stopp tabell

-- FOHEPF
  IF  (UPPER(TRIM(p_table)) = 'FOHEPF'
  OR   UPPER(TRIM(p_table)) = 'FODTPF'
  OR   UPPER(TRIM(p_table)) = 'RA09PF'
  OR   UPPER(TRIM(p_table)) = 'AUSRPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- ORDRER_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW ORDRER_NWL_VIEW FOR SYSTEM NAME NWLORDVIEW
  (FOFIRM,FONUMM,FOSUFF,FOOTYP,FOKUND,FOKUNA,FONAVN,FOBDAT,FOBDAT_F,FOLDAT,
  FOLDAT_F,FOTOTS_F,FOTOTR_F,NETTO_F,RABATT_F,FDBENR_F
  ,SELGER,FOUSER,FODATE,FODATE_F,FOOOUS,FOOOUS_NAVN,FOEDAT,FOEDAT_F,FOETIM,
  FOEUSR,FOEUSR_NAVN,FUNCTION_LINK,FUNCTION_LINK_TEXT,FUNCTION_LINK2,
  FUNCTION_LINK_TEXT2,PARM1,PARM2,PARM3)
  AS
  SELECT FOFIRM, FONUMM, FOSUFF, FOOTYP, FOKUND, FOKUNA,
  ADB.nwl_json_clean(FONAVN)
  , FOBDAT, adb.nwl_date_fmt(FOBDAT) AS FOBDAT_F
  , FOLDAT, adb.nwl_date_fmt(FOLDAT) AS FOLDAT_F
  , ADB.nwl_num_fmt(FOTOTS, 2) AS FOTOTS_F
  , ADB.nwl_num_fmt(FOTOTR, 2) AS FOTOTR_F
  , ADB.nwl_num_fmt((FOTOTS-FOTOTR), 2) AS NETTO_F
  , ADB.nwl_num_fmt((CASE WHEN FOTOTR=0 THEN 0 ELSE ROUND((FOTOTR*100)/
  (FOTOTS-FOTOTR), 2) END ), 2) AS RABATT_F
  , COALESCE((SELECT FDBENR FROM FODTPF WHERE FDFIRM = FOFIRM AND FDNUMM
  = FONUMM AND FDSUFF = FOSUFF FETCH FIRST 1 ROWS ONLY), 0) AS FDBENR_F
  , COALESCE(RAITXT, '''') AS SELGER
  ,FOUSER
  ,FODATE, adb.nwl_date_fmt(FODATE) AS FODATE_F
  ,FOOOUS
  ,COALESCE(AUSR1.ABNAVN, '''') AS FOOOUS_NAVN
  ,FOEDAT, adb.nwl_date_fmt(FOEDAT) AS FOEDAT_F
  ,FOETIM
  ,FOEUSR
  ,COALESCE(AUSR2.ABNAVN, '''') AS FOEUSR_NAVN
  , ''OpenOrdre('''''' concat FOFIRM concat '''''', '''''' concat FONUMM
  concat '''''', '''''' concat FOSUFF concat '''''')'' as FUNCTION_LINK
  , ''Åpne '' concat FONUMM concat ''-'' concat FOSUFF as FUNCTION_LINK_TEXT
  , ''ShowOrdre('''''' concat FOFIRM concat '''''', '''''' concat FONUMM
  concat '''''', '''''' concat FOSUFF concat '''''')'' as FUNCTION_LINK2
  , ''Vis '' concat FONUMM concat ''-'' concat FOSUFF as FUNCTION_LINK_TEXT2
  , FOFIRM,FONUMM,FOSUFF
  FROM FOHEPF
  LEFT OUTER JOIN RA09PF ON RAIFIR = FOFIRM AND RAIKOD = FOSELG
  LEFT OUTER JOIN AUSRPF AUSR1 ON AUSR1.ABUSER = FOOOUS
  LEFT OUTER JOIN AUSRPF AUSR2 ON AUSR2.ABUSER = FOEUSR
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLORDVIEW IS 'NewlookView Ordre';

  END IF;  -- stopp tabell

-- SOHEPF
  IF  (UPPER(TRIM(p_table)) = 'SOHEPF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN


-------- KUNDEFAKTURA_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW KUNDEFAKTURA_NWL_VIEW FOR SYSTEM NAME NWLKFAVIEW
  (SOFIRM, SOBINR, SONUMM, SOSUFF, SOOTYP, SOKUND,SONAVN, SOFKDA, SOFKDA_F,
  SOFFDA
               , SOFFDA_F, SOFSUM_F, SOTOTR_F , NETTO_F , RABATT_F,SOUSER,
			   SODATE, SODATE_F,SOOUSR,SOEDAT, SOEDAT_F,SOEUSR)
  AS
  SELECT SOFIRM, SOBINR, SONUMM, SOSUFF, SOOTYP, SOKUND,
  ADB.nwl_json_clean(SONAVN)
  , SOFKDA, adb.nwl_date_fmt(SOFKDA) AS SOFKDA_F
  , SOFFDA, adb.nwl_date_fmt(SOFFDA) AS SOFFDA_F
  , ADB.nwl_num_fmt(SOFSUM, 2) AS SOFSUM_F
  , ADB.nwl_num_fmt(SORK1P, 2) AS SOTOTR_F
  , ADB.nwl_num_fmt((SOFSUM-SORK1P), 2) AS NETTO_F
  , ADB.nwl_num_fmt(SORABP, 2) AS RABATT_F
  ,SOUSER
  ,SODATE, adb.nwl_date_fmt(SODATE) AS SODATE_F
  ,SOOUSR
  ,SOEDAT, adb.nwl_date_fmt(SOEDAT) AS SOEDAT_F
  ,SOEUSR
  FROM SOHEPF
  WHERE year(sodate) = year(current_date)
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKFAVIEW IS 'NewlookView KundeFaktura';

  END IF;  -- stopp tabell


-- RKTRPF
  IF  (UPPER(TRIM(p_table)) = 'RKTRPF' OR  UPPER(TRIM(p_table)) = '*ALL') THEN

-------- KUNDE_FORFALT_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW KUNDE_FORFALT_NWL_VIEW  FOR SYSTEM NAME NWLKFLVIEW
  ( RNFIRM,RNKUND,RNBILN,RNBDAT,RNBDAT_F,RNBILK,RNTEXT,RNFDAT,RNFDAT_F,
  DAYS_SINCE_FORFALL
        ,RNBELØ_F,RNREST_F,INNBET_F,RNREFN)
  AS
    SELECT
     RNFIRM
    ,RNKUND
    ,RNBILN
    ,RNBDAT
    , adb.nwl_date_fmt(RNBDAT) AS RNBDAT_F
    ,RNBILK
    ,RNTEXT
    ,RNFDAT
    , adb.nwl_date_fmt(RNFDAT) AS RNFDAT_F
    ,(days(current_date)-days(rnfdat)) AS DAYS_SINCE_FORFALL
    ,ADB.nwl_num_fmt(RNBELØ, 2) AS RNBELØ_F
    ,ADB.nwl_num_fmt(RNREST, 2) AS RNREST_F
    ,ADB.nwl_num_fmt(RNBELØ-RNREST, 2) AS INNBET_F
    ,RNREFN
    FROM RKTRPF
    WHERE rnfdat < CURRENT_DATE AND rnrest > 0
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKFLVIEW IS 'NewlookView KundeForfalt';


-------- KUNDE_SALDO_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW KUNDE_SALDO_NWL_VIEW FOR SYSTEM NAME NWLKSDVIEW
    ( RNFIRM,RNKUND,RNBILN,RNBDAT,RNBDAT_F,RNBILK,RNTEXT,RNFDAT,RNFDAT_F,
	DAYS_SINCE_FORFALL
        ,RNBELØ_F,RNREST_F,INNBET_F,RNREFN)
  AS
    SELECT
     RNFIRM
    ,RNKUND
    ,RNBILN
    ,RNBDAT
    , adb.nwl_date_fmt(RNBDAT) AS RNBDAT_F
    ,RNBILK
    ,RNTEXT
    ,RNFDAT
    , adb.nwl_date_fmt(RNFDAT) AS RNFDAT_F
    ,(days(current_date)-days(rnfdat)) AS DAYS_SINCE_FORFALL
    ,ADB.nwl_num_fmt(RNBELØ, 2) AS RNBELØ_F
    ,ADB.nwl_num_fmt(RNREST, 2) AS RNREST_F
    ,ADB.nwl_num_fmt(RNBELØ-RNREST, 2) AS INNBET_F
    ,RNREFN
    FROM RKTRPF
    --WHERE rnrest > 0
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLKSDVIEW IS 'NewlookView KundeSaldo';

  END IF;  -- stopp tabell


-- FODTPF
  IF  (UPPER(TRIM(p_table)) = 'FODTPF'
  OR   UPPER(TRIM(p_table)) = 'JVOMPF'
  OR   UPPER(TRIM(p_table)) = 'JVARPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-- KAN EN LAGE VIEW I ADB OG LVR ??

-------- ORDRE_LINJE_MER_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
  CREATE OR REPLACE VIEW ORDRE_LINJE_MER_NWL_VIEW  FOR SYSTEM NAME NWLOLMVIEW
  ( FIRM, NUMM, SUFF, LINE, VARE, HVA, INFO, NOBB)
  AS
SELECT FIRM, NUMM, SUFF, LINE, VARE, HVA, INFO, NOBB FROM (
  (
    SELECT  FDFIRM AS FIRM, FDNUMM AS NUMM, FDSUFF AS SUFF, FDLINE AS LINE,
	FDVARE AS VARE,JVOTYP AS HVA,CAST(JVOTX1 AS VARCHAR(200)) AS INFO,FDNOBB
	AS NOBB FROM FODTPF A
    LEFT OUTER JOIN JVOMPF C ON JVONOB = FDNOBB
    WHERE (JVOTYP IS NOT NULL AND FDNOBB > 0)
  )
  UNION ALL
  (
    SELECT FDFIRM AS FIRM, FDNUMM AS NUMM, FDSUFF AS SUFF, FDLINE AS LINE,
	FDVARE AS VARE,''Vare er utgått'' AS HVA, CAST(FDVARE  concat
	'' erstattes av '' concat  JVENOB AS VARCHAR(200)) AS INFO,FDNOBB AS
	NOBB FROM FODTPF A
    LEFT OUTER JOIN JVARPF B ON JVVARE = FDVARE AND JVENOB > 0
    WHERE (JVENOB IS NOT NULL AND FDNOBB > 0)
  )
) AA
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLOLMVIEW IS 'NewlookView OrdreLinjerMer';

  END IF;  -- stopp tabell



-- SLOGPF
  IF  (UPPER(TRIM(p_table)) = 'SLOGPF'
  OR   UPPER(TRIM(p_table)) = 'AUSRPF'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN


-------- ENDRE_LOG_NWL_VIEW -----------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW ENDRE_LOG_NWL_VIEW FOR SYSTEM NAME NWLLOGVIEW
  (  ELFIRM, ELREGI, ELFORE, ELFORT, jobj)
  AS
with h as (
  select JSON_ArrayAgg(JSON_Object(''colname'' : h1) Returning VarChar(5000)
  CCSID 1208) as ObjH from (
  values(''Hva er endret''),(''Endret fra''),(''Endret til''),(''Tidspunkt''),
  (''Endret av'')
  ) hh(h1)
)
, th as (
  select JSON_Object(''tr'': ObjH Format JSON Returning VarChar(5000)
  CCSID 1208) as ObjTr from h
)
, dummy as (
  select ELFIRM from SLOGPF FETCH FIRST 1 ROWS ONLY
)
, td as (
SELECT   ELFIRM,ELREGI, ELFORE, ELFORT,
    JSON_Object(''coldata'': Trim(IFNULL((SELECT FELTTEKST FROM SLGNST
	WHERE REGISTERFELT = ELFELT AND REGISTER = ELREGI), ELREGI))
    , ''coltype'' : ''200''
    Absent on NULL Returning VarChar(5000) CCSID 1208) as ObjRader1
    ,JSON_Object(''coldata'': Trim(ELFRAV)
    , ''coltype'' : ''200''
    Absent on NULL Returning VarChar(5000) CCSID 1208) as ObjRader2
    ,JSON_Object(''coldata'': Trim(ELTILV)
    , ''coltype'' : ''200''
    Absent on NULL Returning VarChar(5000) CCSID 1208) as ObjRader3
    ,JSON_Object(''sort'': timestamp(ELRDAT,ELRtim)
    , ''coldata'': TO_CHAR(timestamp(ELRDAT,ELRtim), ''DD.MM.YY HH24.MI'')
    , ''coltype'' : ''200''
    Absent on NULL Returning VarChar(5000) CCSID 1208) as ObjRader4
    ,JSON_Object(''coldata'': trim((select abnavn from ausrpf where
	abuser = elrusr))
    , ''coltype'' : ''200''
    Absent on NULL Returning VarChar(5000) CCSID 1208) as ObjRader5
 FROM SLOGPF  A ORDER BY ELRDAT DESC, ELRTIM DESC
)
, tds as (
  select ELFIRM,ELREGI, ELFORE, ELFORT
  ,JSON_ArrayAgg(
    JSON_Array(ObjRader1 Format JSON, ObjRader2 Format JSON, ObjRader3
	Format JSON
         , ObjRader4 Format JSON, ObjRader5 Format JSON Returning
		 VarChar(5000) CCSID 1208)
    order by ObjRader4 desc Returning VarChar(5000) CCSID 1208) as
	ObjRad from td
  GROUP BY ELFIRM, ELREGI, ELFORE, ELFORT
)
, js as (
  select ELFIRM, ELREGI, ELFORE, ELFORT,JSON_Object(
  ''table'' : ''ENDRE_LOG_NWL_VIEW'',
  ''showheader'' : ''Endringslogg'',
  ''theader'': ObjTr Format JSON,
  ''tablerows'': ObjRad Format JSON
  Returning VarChar(5000) CCSID 1208) as ObjT from th, tds
)
select ELFIRM, ELREGI, ELFORE, ELFORT, JSON_Object(''htmltable'':
ObjT Format JSON Returning VarChar(5000) CCSID 1208) as j from js
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLLOGVIEW IS 'NewlookView endringslogg';

  END IF;  -- stopp tabell



-- AMNHPF, AMNUPF
  IF  (UPPER(TRIM(p_table)) = 'AMNHST'
  OR   UPPER(TRIM(p_table)) = 'AMNUST'
  OR  UPPER(TRIM(p_table)) = '*ALL')  THEN

-------- EGNE_MENYER_NWL_VIEW-------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW EGNE_MENYER_NWL_VIEW FOR SYSTEM NAME NWLEGMVIEW
  (  AMHMNU,AMUUSR, JOBJ)
  AS
WITH H1 AS (
  SELECT
   AMHMNU,AMHSEQ,AMUUSR
  ,JSON_OBJECT(
   ''MENY''   : TRIM(AMHMNU)
  ,''MENUTEXT'' : TRIM(AMHTXT)
  ,''MENUTYPE'' : TRIM(AMHTYP)
  ,''MENUOPT''  : TRIM(AMHOPT)
  Returning VarChar(500) CCSID 1208 normalized)  "AMENU"
  FROM (
   SELECT AMHMNU,AMHSEQ,AMHTXT,AMHSEL,AMHTYP,AMHOPT,AMUUSR FROM
   AMNHST
   INNER JOIN AMNUST ON AMUMNU = AMHMNU
   WHERE (1=1)
   AND (AMHTYP=''OWNMENU''  OR AMHTYP=''OWNPRG''
  )
   ) X1(AMHMNU,AMHSEQ,AMHTXT,AMHSEL,AMHTYP,AMHOPT,AMUUSR)
)
, H2 AS (
   SELECT AMHMNU,AMUUSR
   ,JSON_ArrayAgg(
      AMENU FORMAT JSON
  order by AMHSEQ
  Returning VarChar(5000) CCSID 1208) ObjH2
   FROM H1
   GROUP BY AMHMNU,AMUUSR
)
SELECT AMHMNU,AMUUSR, JSON_Object(''MENUS'' : ObjH2 format JSON Returning
VarChar(5000) CCSID 1208) JOBJ FROM H2
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLEGMVIEW IS 'NewlookView egne menyer';


-------- NYE_MENYER_NWL_VIEW-------------
------------------------------------------
SET stmt = '
CREATE OR REPLACE VIEW NYE_MENYER_NWL_VIEW FOR SYSTEM NAME NWLNYMVIEW
  (  AMHMNU,AMUUSR, JOBJ)
  AS
WITH H1 AS (
  SELECT
   AMHMNU,AMHSEQ,AMUUSR
  ,JSON_OBJECT(
   ''MENY''   : TRIM(AMHMNU)
  ,''MENUTEXT'' : TRIM(AMHTXT)
  ,''MENUTYPE'' : TRIM(AMHTYP)
  ,''MENUOPT''  : TRIM(AMHOPT)
  Returning VarChar(500) CCSID 1208 normalized)  "AMENU"
  FROM (
   SELECT AMHMNU,AMHSEQ,AMHTXT,AMHSEL,AMHTYP,AMHOPT,AMUUSR FROM
   AMNHST
   INNER JOIN AMNUST ON AMUMNU = AMHMNU
   WHERE (1=1)
   AND (AMHTYP=''NEWMENU''  OR AMHTYP=''NEWPRG''
  )
   ) X1(AMHMNU,AMHSEQ,AMHTXT,AMHSEL,AMHTYP,AMHOPT,AMUUSR)
)
, H2 AS (
   SELECT AMHMNU,AMUUSR
   ,JSON_ArrayAgg(
      AMENU FORMAT JSON
  order by AMHSEQ
  Returning VarChar(5000) CCSID 1208) ObjH2
   FROM H1
   GROUP BY AMHMNU,AMUUSR
)
SELECT AMHMNU,AMUUSR, JSON_Object(''MENUS'' : ObjH2 format JSON Returning
VarChar(5000) CCSID 1208) JOBJ FROM H2
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE NWLNYMVIEW IS 'NewlookView nye menyer';

  END IF;  -- stopp tabell


/* **************************************************************************
STOPP NEWLOOK
*/



/* **************************************************************************
START OPTIMERA XML SOLVE
*/

--SOLVE
  IF  (UPPER(TRIM(p_table)) = 'SOLVE')  THEN

------ PRIS XML -----------------
----------------------------------------

SET stmt = 'CREATE OR REPLACE VARIABLE PRIS_SOLVE_XML_V VARCHAR(256) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW PRIS_XML_SOLVE_VIEW FOR SYSTEM NAME PRSSLVVIEW
(
 ArticleNo
,SupplierNo
,PriceGroup
,UnitCode
,ValidFrom
,SalesPrice
,CostPrice
,PurchasePriceExShipping
,PurchasePriceIncShipping
,BasePrice
,SupplierArticleNumber
)
as
select *  from
XMLTABLE(
''ArticlePrices/ArticlePrice''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(PRIS_SOLVE_XML_V))
COLUMNS
   "ArticleNo"          VARCHAR(20)  PATH ''ArticleNo''
   ,"SupplierNo"        VARCHAR(20)  PATH ''SupplierNo''
   ,"PriceGroup"        VARCHAR(20) DEFAULT '''' PATH ''PriceGroup''
   ,"UnitCode"          VARCHAR(20)  PATH ''UnitCode''
   ,"ValidFrom"         VARCHAR(20)  PATH ''ValidFrom''
   ,"SalesPrice"        VARCHAR(20)  PATH ''SalesPrice''
   ,"CostPrice"         VARCHAR(20)  PATH ''CostPrice''
   ,"purchasePriceExShipping"   VARCHAR(20)  PATH ''PurchasePriceExShipping''
   ,"PurchasePriceIncShipping"  VARCHAR(20)  PATH ''PurchasePriceIncShipping''
   ,"BasePrice"         VARCHAR(20)  PATH ''BasePrice''
   ,"SupplierArticleNumber"   VARCHAR(20)  PATH ''SupplierArticleNumber''
   ) pris
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE PRSSLVVIEW IS 'SolveXMLview Pris';

--**************************************************************************

SET stmt = 'CREATE OR REPLACE VARIABLE MODUL_SOLVE_XML_V VARCHAR(256) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW MODUL_XML_SOLVE_VIEW FOR SYSTEM NAME MODSLVVIEW
(
NOBBmodulNr
,DeltakerNr
,VareGruppeNr
,Merkenavn
,ModulTekst1
,ModulTekst2
,Stikkord1
,Stikkord2
,Stikkord3
,Stikkord4
,Stikkord5
,Stikkord6
,Stikkord7
,Stikkord8
,Stikkord9
,Stikkord10
,Stikkord11
,Stikkord12
,Stikkord13
,Stikkord14
,Stikkord15
,Stikkord16
,Stikkord17
,Stikkord18
,Stikkord19
,Stikkord20
,Stikkord21
,Stikkord22
,Stikkord23
,Stikkord24
,Stikkord25
,Stikkord26
,Stikkord27
,Stikkord28
,Stikkord29
,Stikkord30
,Stikkord31
,Stikkord32
,Stikkord33
,Stikkord34
,Stikkord35
,Stikkord36
,Stikkord37
,Stikkord38
,Stikkord39
,Stikkord40
,Stikkord41
,Stikkord42
,Stikkord43
,Stikkord44
,Stikkord45
,Stikkord46
,Stikkord47
,Stikkord48
,Stikkord49
,Stikkord50
  )
AS
select * from
XMLTABLE(
 ''ModulResult/ModulListe/Modul''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(MODUL_SOLVE_XML_V))
COLUMNS
   "NOBBmodulNr"     VARCHAR(8)  PATH ''NOBBmodulNr''
  ,"DeltakerNr"      VARCHAR(6)  PATH ''DeltakerNr''
  ,"VareGruppeNr"    VARCHAR(7)  PATH ''VareGruppeNr''
  ,"Merkenavn"       VARCHAR(30) PATH ''Merkenavn''
  ,"ModulTekst1"     VARCHAR(35) PATH ''ModulTekst1''
  ,"ModulTekst2"     VARCHAR(35) PATH ''ModulTekst2''
  ,"Stikkord1 "      VARCHAR(30) PATH ''Stikkord[1 ]'' DEFAULT ''''
  ,"Stikkord2 "      VARCHAR(30) PATH ''Stikkord[2 ]'' DEFAULT ''''
  ,"Stikkord3 "      VARCHAR(30) PATH ''Stikkord[3 ]'' DEFAULT ''''
  ,"Stikkord4 "      VARCHAR(30) PATH ''Stikkord[4 ]'' DEFAULT ''''
  ,"Stikkord5 "      VARCHAR(30) PATH ''Stikkord[5 ]'' DEFAULT ''''
  ,"Stikkord6 "      VARCHAR(30) PATH ''Stikkord[6 ]'' DEFAULT ''''
  ,"Stikkord7 "      VARCHAR(30) PATH ''Stikkord[7 ]'' DEFAULT ''''
  ,"Stikkord8 "      VARCHAR(30) PATH ''Stikkord[8 ]'' DEFAULT ''''
  ,"Stikkord9 "      VARCHAR(30) PATH ''Stikkord[9 ]'' DEFAULT ''''
  ,"Stikkord10"      VARCHAR(30) PATH ''Stikkord[10]'' DEFAULT ''''
  ,"Stikkord11"      VARCHAR(30) PATH ''Stikkord[11]'' DEFAULT ''''
  ,"Stikkord12"      VARCHAR(30) PATH ''Stikkord[12]'' DEFAULT ''''
  ,"Stikkord13"      VARCHAR(30) PATH ''Stikkord[13]'' DEFAULT ''''
  ,"Stikkord14"      VARCHAR(30) PATH ''Stikkord[14]'' DEFAULT ''''
  ,"Stikkord15"      VARCHAR(30) PATH ''Stikkord[15]'' DEFAULT ''''
  ,"Stikkord16"      VARCHAR(30) PATH ''Stikkord[16]'' DEFAULT ''''
  ,"Stikkord17"      VARCHAR(30) PATH ''Stikkord[17]'' DEFAULT ''''
  ,"Stikkord18"      VARCHAR(30) PATH ''Stikkord[18]'' DEFAULT ''''
  ,"Stikkord19"      VARCHAR(30) PATH ''Stikkord[19]'' DEFAULT ''''
  ,"Stikkord20"      VARCHAR(30) PATH ''Stikkord[20]'' DEFAULT ''''
  ,"Stikkord21"      VARCHAR(30) PATH ''Stikkord[21]'' DEFAULT ''''
  ,"Stikkord22"      VARCHAR(30) PATH ''Stikkord[22]'' DEFAULT ''''
  ,"Stikkord23"      VARCHAR(30) PATH ''Stikkord[23]'' DEFAULT ''''
  ,"Stikkord24"      VARCHAR(30) PATH ''Stikkord[24]'' DEFAULT ''''
  ,"Stikkord25"      VARCHAR(30) PATH ''Stikkord[25]'' DEFAULT ''''
  ,"Stikkord26"      VARCHAR(30) PATH ''Stikkord[26]'' DEFAULT ''''
  ,"Stikkord27"      VARCHAR(30) PATH ''Stikkord[27]'' DEFAULT ''''
  ,"Stikkord28"      VARCHAR(30) PATH ''Stikkord[28]'' DEFAULT ''''
  ,"Stikkord29"      VARCHAR(30) PATH ''Stikkord[29]'' DEFAULT ''''
  ,"Stikkord30"      VARCHAR(30) PATH ''Stikkord[30]'' DEFAULT ''''
  ,"Stikkord31"      VARCHAR(30) PATH ''Stikkord[31]'' DEFAULT ''''
  ,"Stikkord32"      VARCHAR(30) PATH ''Stikkord[32]'' DEFAULT ''''
  ,"Stikkord33"      VARCHAR(30) PATH ''Stikkord[33]'' DEFAULT ''''
  ,"Stikkord34"      VARCHAR(30) PATH ''Stikkord[34]'' DEFAULT ''''
  ,"Stikkord35"      VARCHAR(30) PATH ''Stikkord[35]'' DEFAULT ''''
  ,"Stikkord36"      VARCHAR(30) PATH ''Stikkord[36]'' DEFAULT ''''
  ,"Stikkord37"      VARCHAR(30) PATH ''Stikkord[37]'' DEFAULT ''''
  ,"Stikkord38"      VARCHAR(30) PATH ''Stikkord[38]'' DEFAULT ''''
  ,"Stikkord39"      VARCHAR(30) PATH ''Stikkord[39]'' DEFAULT ''''
  ,"Stikkord40"      VARCHAR(30) PATH ''Stikkord[40]'' DEFAULT ''''
  ,"Stikkord41"      VARCHAR(30) PATH ''Stikkord[41]'' DEFAULT ''''
  ,"Stikkord42"      VARCHAR(30) PATH ''Stikkord[42]'' DEFAULT ''''
  ,"Stikkord43"      VARCHAR(30) PATH ''Stikkord[43]'' DEFAULT ''''
  ,"Stikkord44"      VARCHAR(30) PATH ''Stikkord[44]'' DEFAULT ''''
  ,"Stikkord45"      VARCHAR(30) PATH ''Stikkord[45]'' DEFAULT ''''
  ,"Stikkord46"      VARCHAR(30) PATH ''Stikkord[46]'' DEFAULT ''''
  ,"Stikkord47"      VARCHAR(30) PATH ''Stikkord[47]'' DEFAULT ''''
  ,"Stikkord48"      VARCHAR(30) PATH ''Stikkord[48]'' DEFAULT ''''
  ,"Stikkord49"      VARCHAR(30) PATH ''Stikkord[49]'' DEFAULT ''''
  ,"Stikkord50"      VARCHAR(30) PATH ''Stikkord[50]'' DEFAULT ''''
   ) modul
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE MODSLVVIEW IS 'SolveXMLview Modul';

--**************************************************************************

SET stmt = 'CREATE OR REPLACE VARIABLE ENHET_SOLVE_XML_V VARCHAR(256) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW ENHET_XML_SOLVE_VIEW FOR SYSTEM NAME ENHSLVVIEW
 (
  ENHET
, BESKRIVELSE
)
AS
select *  from
XMLTABLE(
 ''UnitCodes/UnitCode''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(ENHET_SOLVE_XML_V))
COLUMNS
   "Enhet"       VARCHAR(3)  PATH ''Code''
  ,"Beskrivelse"   VARCHAR(64) PATH ''Name''
   ) enhet
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE ENHSLVVIEW IS 'SolveXMLview ENHET';

--**************************************************************************
-- 170220 bof : Endret i hht hva som kommer fra Solve (varetype / logistikkv)
--
SET stmt = 'CREATE OR REPLACE VARIABLE VARE_SOLVE_XML_V VARCHAR(256) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = 'CREATE OR REPLACE VIEW VARE_XML_SOLVE_VIEW FOR SYSTEM NAME
VARSLVVIEW
(
 ArticleNo
,ArticleOverGroupCode
,ArticleMainGroupCode
,ArticleGroupCode
,ArticleText1
,ArticleText2
,BaseUnit
,StatisticsUnit
,InventoryUnit
,ArticleType
,SArticleNo
,SupplierNOBBArticleNo
,SupplierArticleNumber
,ModuleNo
,SupplierNo
,ExpiryDate
,MainSupplier
,USupplierNo
,UArticleNo
,PackageNumber
,UnitCode
,SalesUnit
,PurchaseUnit
,PricebookUnit
,ConversionFactor
,LengthInMillimeters
,WidthInMillimeters
,HeightInMillimeters
,WeightInKilograms
,VolumeInCubicMeters
,Gtin
,Purchasable
,FPak
,DPak
,TPak
)
as select *  from
XMLTABLE( ''Articles/Article/Suppliers/Supplier/Units/Unit''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(VARE_SOLVE_XML_V))
COLUMNS
   "ArticleNo"           VARCHAR(100)  PATH ''../../../../ArticleNo''
   ,"ArticleOverGroupCode"     VARCHAR(100)  PATH
   ''../../../../ArticleOverGroupCode''
   ,"ArticleMainGroupCode"     VARCHAR(100)  PATH
   ''../../../../ArticleMainGroupCode''
   ,"ArticleGroupCode"       VARCHAR(100)  PATH
   ''../../../../ArticleGroupCode''
   ,"ArticleText1"         VARCHAR(100)  PATH ''../../../../ArticleText1''
   ,"ArticleText2"         VARCHAR(100)  PATH ''../../../../ArticleText2''
   ,"BaseUnit"           VARCHAR(100)  PATH ''../../../../BaseUnit''
   ,"StatisticsUnit"       VARCHAR(100)  PATH ''../../../../StatisticsUnit''
   ,"InventoryUnit"        VARCHAR(100)  PATH ''../../../../InventoryUnit''
   ,"ArticleType"          VARCHAR(5)  PATH ''../../../../ArticleType''
  ,"SArticleNo"          VARCHAR(100)  PATH ''../../ArticleNo''
  ,"SupplierNOBBArticleNo"     VARCHAR(100)  PATH ''../../NOBBArticleNo''
  ,"SupplierArticleNumber"     VARCHAR(100)  PATH
  ''../../SupplierArticleNumber''
   ,"ModuleNo"           VARCHAR(100)  PATH ''../../ModuleNo''
   ,"SupplierNo"         VARCHAR(100)  PATH ''../../SupplierNo''
   ,"ExpiryDate"         VARCHAR(100)  PATH ''../../ExpiryDate''
   ,"MainSupplier"         VARCHAR(100)  PATH ''../../MainSupplier''
   ,"USupplierNo"        VARCHAR(100)  PATH ''../../SupplierNo''
  ,"UArticleNo"          VARCHAR(100)  PATH ''../../ArticleNo''
   ,"PackageNumber"        VARCHAR(100)  PATH ''PackageNumber''
   ,"UnitCode"           VARCHAR(100)  PATH ''UnitCode''
   ,"SalesUnit"          VARCHAR(100)  PATH ''SalesUnit''
   ,"PurchaseUnit"         VARCHAR(100)  PATH ''PurchaseUnit''
   ,"PricebookUnit"        VARCHAR(100)  PATH ''PricebookUnit''
   ,"ConversionFactor"       VARCHAR(100)  PATH ''ConversionFactor''
   ,"LengthInMillimeters"    VARCHAR(100) DEFAULT ''''
   PATH ''LengthInMillimeters''
   ,"WidthInMillimeters"     VARCHAR(100) DEFAULT ''''
   PATH ''WidthInMillimeters''
   ,"HeightInMillimeters"    VARCHAR(100) DEFAULT '''' PATH
   ''HeightInMillimeters''
   ,"WeightInKilograms"      VARCHAR(100) DEFAULT '''' PATH
   ''WeightInKilograms''
   ,"VolumeInCubicMeters"    VARCHAR(100) DEFAULT '''' PATH
   ''VolumeInCubicMeters''
   ,"Gtin"             VARCHAR(100)  PATH ''Gtin''
   ,"Purchasable"        VARCHAR(100)  PATH ''Purchasable''
   ,"FPak"             VARCHAR(100) DEFAULT '''' PATH ''FPak''
   ,"DPak"             VARCHAR(100) DEFAULT '''' PATH ''DPak''
   ,"TPak"             VARCHAR(100) DEFAULT '''' PATH ''TPak''
   ) vare';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE VARSLVVIEW IS 'SolveXMLview VARE';


--**************************************************************************

SET stmt = '
CREATE OR REPLACE VIEW VARE_ENHET_XML_SOLVE_VIEW FOR SYSTEM NAME VENHETSLV
 (
  VARENR
, NOBBLDOR
, OMREGNFAKT
, ENHET
, ENHETNR
, LENGDE
, HOYDE
, BREDDE
, VEKT
, VOLUM
, SALGSNR
, KJOPSNR
, PRISBOKNR
)
AS
select *  from
XMLTABLE(
XMLNAMESPACES(
  ''http://solve/integration/export/gausdal/ArticleExport'' AS "ns2")
, ''ns2:ArticleExport/Articles/Article/Suppliers/Supplier[IsArticleOwner/text()
="true"]/Units/Unit''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(VARE_SOLVE_XML_V))
COLUMNS
   "VareNr"             VARCHAR(8)  PATH ''../../ArticleNo''
  ,"NOBBSupplierNo"         VARCHAR(8)  PATH ''../../NOBBSupplierNo''
  ,"ConversionFactor"         VARCHAR(13) PATH ''ConversionFactor''
  ,"UnitCode"             VARCHAR(3)  PATH ''UnitCode''
  ,"UnitNo"             VARCHAR(1)  PATH ''UnitNo''
  ,"UnitLengthInMillimeters"    VARCHAR(7)  PATH ''UnitLengthInMillimeters''
  ,"UnitHeightInMillimeters"    VARCHAR(7)  PATH ''UnitHeightInMillimeters''
  ,"UnitWidthInMillimeters"     VARCHAR(7)  PATH ''UnitWidthInMillimeters''
  ,"UnitWeightInKilograms"      VARCHAR(10) PATH ''UnitWeightInKilograms''
  ,"UnitFreightVolumeInCubicMeters" VARCHAR(10) PATH
  ''UnitFreightVolumeInCubicMeters''
  ,"SalesUnitNumber"        VARCHAR(1)  PATH ''SalesUnitNumber''
  ,"PurchaseUnitNumber"       VARCHAR(1)  PATH ''PurchaseUnitNumber''
  ,"PricebookUnitNumber"      VARCHAR(1)  PATH ''PricebookUnitNumber''
   ) vareEnhet
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE VENHETSLV IS 'SolveXMLview VARE ENHET';

--**************************************************************************

SET stmt = '
CREATE OR REPLACE VIEW VARE_GTIN_XML_SOLVE_VIEW FOR SYSTEM NAME VGTINSLV
 (
  VARENR
, NOBBLDOR
, ENHET
, GTIN
, PAKNKLASSE
, BESTILLBAR
, SALGSENHET
, MASTERGITIN
)
AS
select *  from
XMLTABLE(
XMLNAMESPACES(
  ''http://solve/integration/export/gausdal/ArticleExport'' AS "ns2")
, ''ns2:ArticleExport/Articles/Article/Suppliers/Supplier/Gtins/Gtin''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(VARE_SOLVE_XML_V))
COLUMNS
   "VareNr"     VARCHAR(8)  PATH ''../../ArticleNo''
  ,"NOBBSupplierNo" VARCHAR(8)  PATH ''../../NOBBSupplierNo''
  ,"UnitCode"     VARCHAR(3)  PATH ''UnitCode''
  ,"Gtin"       VARCHAR(14) PATH ''Gtin''
  ,"PackageType"  VARCHAR(10) PATH ''PackageType''
  ,"Purchasable"  VARCHAR(10) PATH ''Purchasable''
  ,"SalesUnit"    VARCHAR(10) PATH ''SalesUnit''
  ,"MasterGtin"   VARCHAR(10) PATH ''MasterGtin''
   ) vareEnhet
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE VGTINSLV IS 'SolveXMLview VARE GTIN';


--**************************************************************************

SET stmt = 'CREATE OR REPLACE VARIABLE VAREGRUPPE_SOLVE_XML_V VARCHAR(256) ';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW VAREGRUPPE_XML_SOLVE_VIEW FOR SYSTEM NAME VAREGRSLV
 (
   OVERGRUPPENR
   ,OVERGRUPPEBESKRIVELSE
   ,HOVEDGRUPPENR
   ,HOVDEGRUPPEBESKRIVELSE
   ,UNDERGRUPPENR
   ,UNDERGRUPPEBESKRIVELSE
)
AS
select *  from
XMLTABLE(
 ''VaregruppestrukturListe/Overgruppe/Hovedgruppe/Varegruppe''
 PASSING XMLPARSE(DOCUMENT GET_XML_FILE(VAREGRUPPE_SOLVE_XML_V))
COLUMNS
   "OvergruppeNr"       VARCHAR(2)  PATH ''../../OvergruppeNr''
  ,"OvergruppeBeskrivelse"  VARCHAR(64) PATH ''../../Beskrivelse''
  ,"HovedgruppeNr"      VARCHAR(4)  PATH ''../HovedgruppeNr''
  ,"HovdegruppeBeskrivelse"   VARCHAR(64) PATH ''../Beskrivelse''
  ,"UndergruppeNr"      VARCHAR(7)  PATH ''VaregruppeNr''
  ,"UndergruppeBeskrivelse"   VARCHAR(64) PATH ''Beskrivelse''
   ) varegruppe
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE VAREGRSLV IS 'SolveXMLview VAREGRUPPE';

--**************************************************************************

SET stmt ='CREATE OR REPLACE VARIABLE KAMPANJE_XML_SOLVE_VIEW_V VARCHAR(256)';
PREPARE s1 FROM stmt;
EXECUTE s1;

SET stmt = '
CREATE OR REPLACE VIEW KAMPANJE_XML_SOLVE_VIEW FOR SYSTEM NAME KAMPANJSLV
(
 CampaignCode
,CampaignDescription
,CampaignResponsible
,CampaignFromDate
,CampaignFromTime
,CampaignToDate
,CampaignToTime
,NobbNumber
,SenderItemNumber
,SenderItemText
,SenderItemStatus
,SalesPriceUnit
,CampaignPurchasePrice
,CampaignCostPrice
,RecommendedCampaignPrice
,ImposedCampaignPrice
,PurchaseInformation
,ItemInformation
,SupplierInformation
,NobbParticipantNumber
,ItemResponsible
,StorageLocation
,Tv
,PurchasePeriodFromDate
,PurchasePeriodToDate
,ImprovedPurchasePrice
,Code
,Description
)
as
select *  from
XMLTABLE(
''Campaign/CampaignLines/Line/ValidationErrors/ValidationError''
PASSING XMLPARSE(DOCUMENT GET_XML_FILE(KAMPANJE_XML_SOLVE_VIEW_V))
COLUMNS
   "CampaignCode"      VARCHAR(100)  PATH ''../../../../CampaignCode''
   ,"CampaignDescription"  VARCHAR(100)  PATH
   ''../../../../CampaignDescription''
   ,"CampaignResponsible"  VARCHAR(100) DEFAULT '''' PATH
   ''../../../../CampaignResponsible''
   ,"CampaignFromDate"     VARCHAR(100)  PATH ''../../../../CampaignFromDate''
   ,"CampaignFromTime"     VARCHAR(100)  PATH ''../../../../CampaignFromTime''
   ,"CampaignToDate"     VARCHAR(100)  PATH ''../../../../CampaignToDate''
   ,"CampaignToTime"     VARCHAR(100)  PATH ''../../../../CampaignToTime''
   ,"NobbNumber"       VARCHAR(100)  PATH ''../../NobbNumber''
   ,"SenderItemNumber"     VARCHAR(100)  PATH ''../../SenderItemNumber''
   ,"SenderItemText"     VARCHAR(100)  PATH ''../../SenderItemText''
   ,"SenderItemStatus"     VARCHAR(100)  PATH ''../../SenderItemStatus''
   ,"SalesPriceUnit"     VARCHAR(100)  PATH ''../../SalesPriceUnit''
   ,"CampaignPurchasePrice"  VARCHAR(100)  PATH
   ''../../CampaignPurchasePrice''
   ,"CampaignCostPrice"    VARCHAR(100)  PATH ''../../CampaignCostPrice''
   ,"RecommendedCampaignPrice" VARCHAR(100)  PATH
   ''../../RecommendedCampaignPrice''
   ,"ImposedCampaignPrice"   VARCHAR(100)  PATH ''../../ImposedCampaignPrice''
   ,"PurchaseInformation"    VARCHAR(100)  PATH ''../../PurchaseInformation''
   ,"ItemInformation"      VARCHAR(100)  PATH ''../../ItemInformation''
   ,"SupplierInformation"    VARCHAR(100)  PATH ''../../SupplierInformation''
   ,"NobbParticipantNumber"  VARCHAR(100)  PATH
   ''../../NobbParticipantNumber''
   ,"ItemResponsible"      VARCHAR(100)  PATH ''../../ItemResponsible''
   ,"StorageLocation"      VARCHAR(100)  PATH ''../../StorageLocation''
   ,"Tv"             VARCHAR(100)  PATH ''../../Tv''
   ,"PurchasePeriodFromDate"   VARCHAR(100)  PATH
   ''../../PurchasePeriodFromDate''
   ,"PurchasePeriodToDate"   VARCHAR(100)  PATH ''../../PurchasePeriodToDate''
   ,"ImprovedPurchasePrice"  VARCHAR(100)  PATH
   ''../../ImprovedPurchasePrice''
   ,"Code"           VARCHAR(100)  PATH ''Code''
   ,"Description"        VARCHAR(100)  PATH ''Description''
    ) kampanje
';
PREPARE s1 FROM stmt;
EXECUTE s1;

LABEL ON TABLE KAMPANJSLV IS 'SolveXMLview KAMPANJE';




  END IF;  -- stopp tabell





/* **************************************************************************
STOPP OPTIMERA XML SOLVE
*/


SET msgtxt = 'STOP:' CONCAT  p_lib CONCAT ':' CONCAT p_table CONCAT ':' ;
insert into ajltpf(ajtfir,ajtjid,ajtlin,ajtsta,ajttxt,ajtoda,ajtoti,ajtous)
  values
  ( 0 , 'SQL_VIW_CRT_' || VARCHAR_FORMAT(current_timestamp,'YYYYMMDDHHMISSFF3')
  , 1 , 10  , msgtxt  ,CURRENT_DATE,CURRENT_TIME,USER);



----------------------------------------------------------------

END



