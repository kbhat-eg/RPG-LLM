name: AI Jira Auto-Update

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: 'PR Title (include Jira ID, e.g. feat(PROJ-123): my change)'
        required: true
        default: 'feat(PROJ-123): test run'
      pr_body:
        description: 'PR Body / description'
        required: false
        default: 'Manual test run to verify Jira integration'
      pr_number:
        description: 'PR Number'
        required: false
        default: '1'
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  update-jira:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract Jira ticket ID
        id: jira
        run: |
          PR_TITLE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_title || github.event.pull_request.title }}"
          JIRA_ID=$(echo "$PR_TITLE" | grep -oE '[A-Z]+-[0-9]+' | head -1)
          if [ -z "$JIRA_ID" ]; then
            echo "No Jira ticket ID found in PR title: $PR_TITLE"
            exit 1
          fi
          echo "Found Jira ticket: $JIRA_ID"
          echo "jira_id=$JIRA_ID" >> $GITHUB_OUTPUT

      - name: Get PR Diff
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual test run - no real PR diff available." > pr_diff.txt
            echo "Treat this as a sample change for testing Jira update." >> pr_diff.txt
          else
            git diff ${{ github.event.pull_request.base.sha }} \
                     ${{ github.event.pull_request.merge_commit_sha }} \
                     --unified=5 > pr_diff.txt
          fi

      - name: Claude AI - Generate Jira description
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_TITLE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_title || github.event.pull_request.title }}"
          PR_BODY="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_body || github.event.pull_request.body }}"
          PR_NUMBER="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }}"
          JIRA_ID="${{ steps.jira.outputs.jira_id }}"
          DIFF_CONTENT=$(cat pr_diff.txt)

          claude -p "You are a technical writer. Generate a Jira ticket description based on this PR merge.

          PR Title  : $PR_TITLE
          PR Body   : $PR_BODY
          PR Number : $PR_NUMBER
          Jira Ticket: $JIRA_ID
          Merged By : ${{ github.actor }}
          Repository: ${{ github.repository }}

          Git Diff:
          $DIFF_CONTENT

          Write a clear, detailed description with exactly these sections:

          ## Summary
          What was implemented or fixed and why, based on actual code changes.

          ## Changes Made
          - Specific files, APIs, functions changed
          - New endpoints or modified logic
          - Config or dependency changes if any

          ## Acceptance Criteria
          - [ ] Testable criteria based on actual diff
          - [ ] Another testable criteria
          - [ ] Edge cases and error handling verified

          ## Testing Done
          Tests added or run - unit, integration, manual.

          ## Impact and Notes
          Breaking changes, dependencies updated, deployment steps if needed.

          Output ONLY the description text. No preamble, no explanation." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/jira_description.txt

          echo "Description generated ($(wc -c < /tmp/jira_description.txt) bytes)"
          cat /tmp/jira_description.txt

      - name: Claude AI - Generate Jira comment
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_TITLE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_title || github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }}"
          JIRA_ID="${{ steps.jira.outputs.jira_id }}"
          DIFF_CONTENT=$(cat pr_diff.txt)

          claude -p "You are a technical writer. Write a short Jira comment (2-4 sentences) announcing that PR #$PR_NUMBER ('$PR_TITLE') was merged to develop by ${{ github.actor }}.
          Mention the Jira ticket $JIRA_ID and that the ticket description has been automatically updated with full details by Claude AI.
          Include a brief one-line summary of what changed based on this diff:

          $DIFF_CONTENT

          Output ONLY the comment text. No preamble, no explanation." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/jira_comment.txt

          echo "Comment generated:"
          cat /tmp/jira_comment.txt

      - name: Verify Jira credentials
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PAT: ${{ secrets.JIRA_PAT }}
        run: |
          # Strip trailing slash to avoid double-slash in URLs
          BASE_URL="${JIRA_BASE_URL%/}"
          JIRA_ID="${{ steps.jira.outputs.jira_id }}"
          API_URL="${BASE_URL}/rest/api/2/issue/${JIRA_ID}"
          echo "Testing URL: ${API_URL}"

          HTTP_STATUS=$(curl -s -o /tmp/get_response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${JIRA_PAT}" \
            -H "Accept: application/json" \
            "${API_URL}")

          echo "Credential check HTTP status: $HTTP_STATUS"
          cat /tmp/get_response.json | head -c 500
          echo ""

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: Expected HTTP 200 but got $HTTP_STATUS"
            echo "Check: JIRA_PAT is a valid Personal Access Token (Jira profile â†’ Personal Access Tokens)"
            echo "Check: JIRA_BASE_URL is the correct base URL with no trailing slash (e.g. https://jira.yourcompany.com)"
            echo "Check: Ticket $JIRA_ID exists and is accessible by your account"
            exit 1
          fi
          echo "Jira credentials and URL verified OK"
          # Save the stripped base URL for subsequent steps
          echo "${BASE_URL}" > /tmp/jira_base_url.txt

      - name: Update Jira ticket description
        env:
          JIRA_PAT: ${{ secrets.JIRA_PAT }}
        run: |
          BASE_URL=$(cat /tmp/jira_base_url.txt)
          JIRA_ID="${{ steps.jira.outputs.jira_id }}"
          API_URL="${BASE_URL}/rest/api/2/issue/${JIRA_ID}"
          echo "Updating description at: ${API_URL}"

          DESCRIPTION=$(cat /tmp/jira_description.txt)
          PAYLOAD=$(jq -n --arg desc "$DESCRIPTION" '{
            fields: { description: $desc }
          }')

          # Try PATCH first (allowed by more proxies than PUT)
          HTTP_STATUS=$(curl -s -o /tmp/update_response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${JIRA_PAT}" \
            -H "Content-Type: application/json" \
            -X PATCH \
            -d "$PAYLOAD" \
            "${API_URL}")

          echo "PATCH HTTP status: $HTTP_STATUS"

          # Fall back to PUT if PATCH is not accepted
          if [ "$HTTP_STATUS" = "405" ] || [ "$HTTP_STATUS" = "404" ]; then
            echo "PATCH not accepted, retrying with PUT..."
            HTTP_STATUS=$(curl -s -o /tmp/update_response.json -w "%{http_code}" \
              -H "Authorization: Bearer ${JIRA_PAT}" \
              -H "Content-Type: application/json" \
              -X PUT \
              -d "$PAYLOAD" \
              "${API_URL}")
            echo "PUT HTTP status: $HTTP_STATUS"
          fi

          cat /tmp/update_response.json
          if [ "$HTTP_STATUS" != "204" ]; then
            echo "Failed to update Jira description (got $HTTP_STATUS)"
            echo "If you see 405 for both PATCH and PUT, ask your Jira admin to allow PUT/PATCH"
            echo "through the reverse proxy for path: /rest/api/2/issue/*"
            exit 1
          fi
          echo "Jira ticket $JIRA_ID description updated successfully"

      - name: Add Jira comment
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PAT: ${{ secrets.JIRA_PAT }}
        run: |
          JIRA_ID="${{ steps.jira.outputs.jira_id }}"
          COMMENT=$(cat /tmp/jira_comment.txt)

          PAYLOAD=$(jq -n --arg body "$COMMENT" '{body: $body}')

          HTTP_STATUS=$(curl -s -o /tmp/comment_response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${JIRA_PAT}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            "${JIRA_BASE_URL}/rest/api/2/issue/${JIRA_ID}/comment")

          echo "Jira comment HTTP status: $HTTP_STATUS"
          cat /tmp/comment_response.json

          if [ "$HTTP_STATUS" != "201" ]; then
            echo "Failed to add Jira comment (expected 201, got $HTTP_STATUS)"
            exit 1
          fi
          echo "Comment added to Jira ticket $JIRA_ID successfully"
