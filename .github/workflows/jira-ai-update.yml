name: AI Jira Auto-Update

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: 'PR Title (include Jira ID, e.g. feat(PROJ-123): my change)'
        required: true
        default: 'feat(PROJ-123): test run'
      pr_body:
        description: 'PR Body / description'
        required: false
        default: 'Manual test run to verify Jira integration'
      pr_number:
        description: 'PR Number'
        required: false
        default: '1'
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  update-jira:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual test run - no real PR diff available." > pr_diff.txt
            echo "Treat this as a sample change for testing Jira update." >> pr_diff.txt
          else
            git diff ${{ github.event.pull_request.base.sha }} \
                     ${{ github.event.pull_request.merge_commit_sha }} \
                     --unified=5 > pr_diff.txt
          fi
          echo "Diff step complete"

      - name: Claude AI - Analyze and Update Jira
        uses: anthropics/claude-code-action@beta
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          mode: agent
          allowed_tools: "Bash,Read"
          direct_prompt: |
            You are a technical writer. Analyze the git diff and update the Jira ticket automatically.
            Use your Bash tool to run all curl commands. Use your Read tool to read files.

            PR Title  : ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_title || github.event.pull_request.title }}
            PR Body   : ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_body || github.event.pull_request.body }}
            PR Number : ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number || github.event.pull_request.number }}
            Merged By : ${{ github.actor }}
            Repository: ${{ github.repository }}

            STEP 1 - Extract the Jira ticket ID from the PR title using the pattern [A-Z]+-\d+
            Example: "feat(PROJ-123): add login API" means Jira ID is PROJ-123.
            If no Jira ID is found, print a warning and stop.

            STEP 2 - Use your Read tool to read the file pr_diff.txt and understand what code changed.

            STEP 3 - Use your Bash tool to run this curl command to get the Jira ticket details:
              curl -s -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
                -H "Accept: application/json" \
                "$JIRA_BASE_URL/rest/api/3/issue/{JIRA_ID}"
            Read the response to understand the current ticket state.

            STEP 4 - Generate a detailed Jira description (as plain text) based on the diff.
            Structure the description with these sections:

              ## Summary
              [What was implemented or fixed and why, based on actual code changes]

              ## Changes Made
              - [Specific files, APIs, functions changed]
              - [New endpoints or modified logic]
              - [Config or dependency changes if any]

              ## Acceptance Criteria
              - [ ] [Testable criteria based on actual diff]
              - [ ] [Another testable criteria]
              - [ ] [Edge cases and error handling verified]

              ## Testing Done
              [Tests added or run - unit, integration, manual]

              ## Impact and Notes
              [Breaking changes, dependencies updated, deployment steps if needed]

            STEP 5 - Use your Bash tool to update the Jira ticket description. Write the full
            description text to /tmp/jira_desc.txt first, then use jq to build the JSON payload
            and run curl to PUT it:

              DESCRIPTION=$(cat /tmp/jira_desc.txt)
              PAYLOAD=$(jq -n --arg desc "$DESCRIPTION" '{
                fields: {
                  description: {
                    type: "doc",
                    version: 1,
                    content: [{
                      type: "paragraph",
                      content: [{ type: "text", text: $desc }]
                    }]
                  }
                }
              }')
              curl -s -o /tmp/update_response.json -w "%{http_code}" \
                -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
                -X PUT \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD" \
                "$JIRA_BASE_URL/rest/api/3/issue/{JIRA_ID}"

            Check the HTTP status code. A 204 means success.

            STEP 6 - Use your Bash tool to add a comment to the Jira ticket:

              COMMENT="PR #$PR_NUMBER merged by $GITHUB_ACTOR. This description was auto-generated by Claude AI after merge to develop."
              COMMENT_PAYLOAD=$(jq -n --arg body "$COMMENT" '{
                body: {
                  type: "doc",
                  version: 1,
                  content: [{
                    type: "paragraph",
                    content: [{ type: "text", text: $body }]
                  }]
                }
              }')
              curl -s -o /tmp/comment_response.json -w "%{http_code}" \
                -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
                -X POST \
                -H "Content-Type: application/json" \
                -d "$COMMENT_PAYLOAD" \
                "$JIRA_BASE_URL/rest/api/3/issue/{JIRA_ID}/comment"

            Check the HTTP status code. A 201 means success.

            STEP 7 - Print a summary: Jira ticket ID updated, description length, comment status,
            and any errors encountered.
