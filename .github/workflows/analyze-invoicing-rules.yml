name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze invoicing business rules
        if: false  # temporarily skipped
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO616R (invoice engine) and FO615R (invoice line processing). Main tables: SOHEPF (Invoice Header) and SODTPF (Invoice Lines).

          Provide markdown output describing the validation logic and calculations that occur during invoice processing, after orders have been selected. Include these sections:

          ## Product and Pricing Rules
          - Product validation during invoice creation
          - Price validation and application
          - Quantity validation on invoice lines

          ## Tax/VAT (MVA) Rules
          - Tax code validation with VMVAPF table
          - Tax rate matching and application
          - Tax base amount calculation (Quantity × Price - Discounts)
          - Tax amount calculation and rounding (Norwegian rules)

          ## Discount Rules
          - Customer discount application from RKUNPF (RERAB1, RERAB2, RERAB3)
          - Discount cascade calculation sequence
          - Product group discount handling
          - Special discounts (bruksrett) validation

          ## Deposit and Prepayment Rules
          - Deposit amount validation from SDEPPFR
          - Deposit deduction from final invoice (SOFORS field)
          - Deposit invoice vs. final invoice type handling

          ## Total Calculation Rules
          - Line totals summation logic
          - Invoice header total calculation (SOFSUM)
          - Rounding difference tolerance (±0.05 øre)
          - Zero-value invoice handling

          ## Payment and KID Rules
          - Payment terms validation and due date calculation
          - KID (Customer ID) number generation via RN012R
          - MOD10/MOD11 checksum algorithms

          ## Configuration and System Rules
          - Accounting period validation (AARRF.ARSTRT)
          - System lock checks via FA730R
          - Invoice number sequence generation

          NOTE: Do NOT include order validation rules (customer exists, order status, order locks, user authorization). Those belong in sales-order-business-rules.md.

          Format as markdown with this structure:
          - Each rule has: Logic, File, Field, Condition sections
          - Group rules by the categories above
          - Include subprogram calls section
          - Include summary of critical blocking conditions

          Use DB2 TABLE.COLUMN notation where identifiable.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Analyze sales order business rules
        if: false
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO100R, FO500R, FO614R, and FO730R to document the complete sales order business rules for the NexStep ERP system.

          Primary tables:
          - SOHEPF: Sales Order/Invoice Header (key fields: SOFIRM, SOAARR, SOBINR, SONUMM, SOSUFF, SOOTYP, SOKUND, SOLKUN, SOKPRO, SOBDAT, SOLDAT, SOFKDA, SOSELG, SOAVDE, SOLAGE, SOLETY, SOLMAT, SOBETB, SORABP, SOFSUM)
          - SODTPF: Sales Order/Invoice Line Items (key fields: SDFIRM, SDAARR, SDBINR, SDNUMM, SDSUFF, SDLINE, SDVARE, SDANTA, SDSAPR, SDKOPR, SDRAB1, SDRAB2, SDSALG, SDLTYP, SDLAGE, SDAVDE)

          Lookup/reference tables: RKUNPF (customer master), VOTYPF (order types), VLTPPF (delivery types), FKPRPF (customer projects), VVARPF (item master), RKMEPF (customer memo balance), RA07PF (warehouses), RA09PF (salespersons), RA17PF (shipping methods)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          - Purpose of the document
          - How to use it (field prefix convention: SO = header fields, SD = line fields)
          - Key terminology: Order vs Quote (Tilbud), Memo Balance (Memosaldo), Resting (back-order), Customer Project (Kundeprosjekt)

          ## 2. Database Schema Overview
          - SOHEPF table with field name, type, and English description for the core fields listed above
          - SODTPF table with field name, type, and English description for the core fields listed above
          - Related lookup tables summary

          ## 3. Order Creation Prerequisites
          - Required master data (customer in RKUNPF, order type in VOTYPF with VASYST=0, warehouse in RA07PF, salesperson, payment terms)
          - User permission requirements (FUSRPF, warehouse/department restrictions, packing slip mode)

          ## 4. Customer Validation Rules
          - 4.1 Customer existence: SOKUND/SOLKUN must exist in RKUNPF by RKKUND
          - 4.2 Customer status: RKUNPF.RKSPER (0=active, 1=blocked)
          - 4.3 Cash customer restrictions: cash customers can only create quotes not orders
          - 4.4 Invoice customer vs goods customer: RKUNPF.RKFAKU must match SOKUND
          - 4.5 Customer project requirements [CONFIGURABLE]: driven by RKKATG, project must exist in FKPRPF
          - 4.6 Internal customer validation: RKAVGF/RKFABI require internal order types

          ## 5. Credit Limit Rules
          - 5.1 Credit limit check: Available Credit = RKUNPF.RKGREN minus RKMEPF.RKMEMS
          - 5.2 Credit block status: RKUNPF.RKKRSP — blocked orders, quotes still allowed, F18 override
          - 5.3 Quote exception: order types with accumulator type=0 bypass credit block
          - 5.4 Credit override permissions: F18 approval, audit logging
          - 5.5 Extended memo balance [CONFIGURABLE]: includes future uninvoiced orders with VAT
          - 5.6 Public discount limit (Almenning): RKUNPF.RKGRAL

          ## 6. Order Header Validation
          - 6.1 Order type (SOOTYP): must exist in VOTYPF, VASYST=0, cannot change when lines exist
          - 6.2 Order number (SONUMM): system-assigned from order type number series, suffix rules for backorders
          - 6.3 Salesperson (SOSELG): must exist in RA09PF, inherits from user profile or RKUNPF.RKSLGR
          - 6.4 Warehouse (SOLAGE): must exist in RA07PF, user restrictions apply
          - 6.5 Department (SOAVDE) [CONFIGURABLE]: must exist in department register, consistent with warehouse
          - 6.6 Warehouse-department consistency: cross-reference defines valid combinations
          - 6.7 Delivery type (SOLETY): must exist in VLTPPF; affects purchase order creation and pricing
          - 6.8 Shipping method (SOLMAT): must exist in RA17PF
          - 6.9 Payment terms (SOBETB): must exist in payment terms register, inherits from customer master
          - 6.10 Customer references: SOVREF, SODREF, SOREKV — configurable required fields
          - 6.11 Delivery address: from customer project or goods customer; LAOK confirmation may be required

          ## 7. Order Line Validation
          - 7.1 Line type (SDLTYP): Normal (full validation), Text (no pricing), D-Type (manual pricing); check VLTYPF.VALKTX
          - 7.2 Item number (SDVARE): must exist in VVARPF, item status must allow sales
          - 7.3 Quantity (SDANTA): sign rules (positive=sales, negative=returns via VALKRE='-'), 3 decimal places
          - 7.4 Unit of measure (SDENH1): must be valid for the item
          - 7.5 Line-level warehouse (SDLAGE): defaults from header, can be overridden, must be valid
          - 7.6 Line-level department (SDAVDE): defaults from header, must be consistent with warehouse

          ## 8. Price and Discount Rules
          - 8.1 Price determination via VP900R: hierarchy = customer-specific → customer price group → standard → manual (type D)
          - 8.2 Discount hierarchy: Order Discount (SORABP) → Line Disc 1 (SDRAB1) → Line Disc 2 (SDRAB2) → Bracket Disc 1 (SDBRR1) → Bracket Disc 2 (SDBRR2); show calculation formula
          - 8.3 Discount category override: FL710R customer project discount override
          - 8.4 Price group (SDPRGR): 2-char code determined by VL712R, used in price matrix
          - 8.5 Return fee [CONFIGURABLE]: CO402R configuration, added as extra line in FOD2PF
          - 8.6 Manual pricing (type D items): VVARPF.VVVTYP='D', skip automatic lookup
          - 8.7 Public discount limit: RKUNPF.RKGRAL tracking

          ## 9. Date Validation Rules
          - 9.1 Order date (SOBDAT): valid date, not more than 1 year past/future, not in closed accounting period
          - 9.2 Delivery date (SOLDAT): valid date, must be >= SOBDAT, [CONFIGURABLE] required
          - 9.3 Follow-up date (FODDAT) for quotes: >= order date, auto-calculated from FAAOPF days
          - 9.4 Expiry date (FOTDAT) for quotes: > order date, auto-calculated from FAAUTG days
          - 9.5 Invoice date (SOFKDA): set by invoicing process FO614R, not validated on entry

          ## 10. Status and Workflow Rules
          - 10.1 Order states: New (no lines) → Open (has lines) → On Hold (info code) → Picking (FOAKKT) → Picked → Invoiced (SOBINR>0) → Partial
          - 10.2 Order lock: system locks during processing, user override may be available
          - 10.3 Picking status: FOAKKT set locks the order; limited modifications may be allowed
          - 10.4 Info code hold: SOINF1/SOINF2 can block processing; must be cleared before fulfillment
          - 10.5 Backorder (Resting) processing: original suffix incremented, new suffix for backordered items

          ## 11. Integration Rules
          - 11.1 Customer project integration: delivery address, contact info, discount category, payment terms, invoice type all overridden by project
          - 11.2 EDI requirements: SOEDIH indicates EDI order, SONREF required; line-level SDEDIH/SDEDIL
          - 11.3 Transport integration: certain SOLMAT values trigger transport API calls and cancellation on change
          - 11.4 Deposit/prepayment: SODEPO indicator, SODEPB billing ref, SOFOSA/SOFOSI settlement; cannot delete orders with unsettled deposits

          ## 12. Field Reference
          - Complete SOHEPF header field table: Field | Type | Norwegian | English Description (include all fields from SOFIRM through SOEUSR)
          - Complete SODTPF line field table: Field | Type | Norwegian | English Description (include all fields from SDFIRM through SDEUSR)

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Use DB2 TABLE.COLUMN notation where identifiable. Format as markdown." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/sales-order-rules-new.md

      - name: Analyze customer and AR business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs RK100R, RK108R, RK110R, RK400R, RK500R, RK620R, RE110R, RE120R, RE600R, RE601R, RE602R, RE603R, RE609R, RE613R, RE615R, RE621R, RE623R, RE630R, RE632R, RE633R, AR100R, AR700R to document the complete Customer and Accounts Receivable business rules for the NexStep ERP system.

          FIELD CORRECTIONS (verified from DDS source):
          - RKTRPF field prefix is RN (RNFIRM, RNKUND, RNBILK, RNBELØ, RNREST, RNSTAT, RNKID, RNFDAT) — not RT
          - RE01PF/RE02PF/RE03PF are GL reporting tables (Trioplan balance matrix, income register, trial balance) — NOT AR transaction tables
          - Key RKUNPF field names: RKGRNS=credit limit, RKKRES=credit block, RKSPRK=block status, RKSALD=sales YTD, RKEMAL=email, RKFTNR=org number, RKRABK=discount, RKLAGR=warehouse, RKPASS=passive flag, RKMEPF.RKMEMA=memo amount

          Primary tables (read DDS source for all field names):
          - RKUNPF: Customer Master
          - RKMEPF: Customer Memo Balance (real-time credit exposure, amount field RKMEMA)
          - RKTRPF: Customer Postings (field prefix RN, not RT)
          - REKUPF: Customer AR Ledger Summary
          - REMSPF: GL/AR Posting Registration (field prefix RT)

          Lookup tables: AKIDPF (KID references), RA1HKT/RA1HRS (customer number range config), ARAFPF (company), RA09PF (salespersons), SOHEPF (sales orders for deletion check)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          Purpose, how to use it, field prefix conventions (RK=customer master, RN=postings in RKTRPF, RT=GL registration in REMSPF), key Norwegian terminology: Kunderegister, Memosaldo, Postering, Aldersfordeling, KID, Remisse, Spesialavtale.

          ## 2. Database Schema Overview
          Field tables for RKUNPF, RKMEPF, RKTRPF, REKUPF, REMSPF — each with field name, type, length, English description from DDS source. Note that RE01PF/RE02PF/RE03PF are GL reporting tables only.

          ## 3. Customer Master Prerequisites
          Required master data lookups (company, payment terms, salesperson in RA09PF, department, category), user permission model (maintenance rights, department restriction ABBAVD), customer number range rules (RA1HKT to RA1HRS).

          ## 4. Customer Master Validation Rules
          Name (RKNAVN) required; alpha key (RKALFA) auto-populated via RK750R; org number (RKFTNR) format; block status (RKSPRK); invoice customer (RKFAKU); duplicate detection via RK108R; deletion checklist via RK400R (no open RKTRPF/SOHEPF); merge/move rules via RK108R with TESTSPERRE check.

          ## 5. Credit and Financial Limit Rules
          Credit limit (RKGRNS) vs memo balance (RKMEPF.RKMEMA); why RKMEPF is used over RKSALD for real-time checks; four-level credit block (RKKRES); payment terms inheritance (RKBETB); Almenning purchase limit (RKKJAL/RKGRAL).

          ## 6. Customer Transaction Rules
          Document types in RKTRPF (RNBILK): FA=Invoice, BE=Payment, KR=Credit note; period/date validation (1–13, open period check); amount sign rules; KID generation via RN012R (MOD10/MOD11); accounting period assignment with two-digit year handling.

          ## 7. AR Ledger Rules
          Document creation rules; RNSTAT status lifecycle (O=Open, L=Settled, D=Deleted); payment allocation; three-way balance reconciliation (RKTRPF/RKMEPF/RKSALD); interest calculation using RA6 configuration.

          ## 8. Payment Processing Rules
          Manual payment entry via REMSPF; remittance/OCR KID matching 4-step process via RE630R–RE633R; overpayment credit posting; write-off rules; credit note lifecycle.

          ## 9. AR Aging and Collections Rules
          Aging bucket boundaries by due date with real-world example; dunning configuration (level increments, charges, dispute flag); what updates when a dunning notice is sent; collections escalation via RKINKK; statement generation parameters via RK620R.

          ## 10. Customer Account Status and Workflow Rules
          Five lifecycle states (Active/Order Blocked/Credit Locked/Fully Blocked/Passive); passive customer rules (RKPASS); modification restrictions on key fields (RKFAKU, RKKUND, RKBETB, RKGRNS); year-end processing (RKSALD/RKSAIF sequence reset).

          ## 11. Integration Rules
          External import via RE110R/RK110R (7 rules including non-zero-overwrite logic, number range check); sales order credit check flow (reads RKGRNS and RKMEMA); GL posting split (dann_resk vs dann_trans); KID/bank file matching via RE630R–RE633R; email/PDF delivery via RKEMAL.

          ## 12. Field Reference
          Complete field tables for RKUNPF, RKTRPF, RKMEPF — every field with Norwegian name, English description, type, length from DDS source.

          Do NOT include SQL queries. Use plain English with 'What is checked', 'Why this is required', 'What happens when' explanations and real-world examples. Use DB2 TABLE.COLUMN notation. Format as markdown.

          OUTPUT RULE: Write the markdown document directly. Do NOT write a summary or describe what you created. Start immediately with the # title heading." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/customer-ar-rules-new.md

      - name: Cleanup extra files
        run: |
          # Remove any files created by Claude in root directory
          rm -f invoice*.md sales*.md purchase*.md customer*.md
          echo "Cleaned up extra files"

      - name: Check for changes
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false

          # Check invoicing rules
          INVOICING_FILE="docs/invoice-business-rules.md"
          if [ -f "$INVOICING_FILE" ]; then
            if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in invoice business rules"
              cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new invoice business rules file"
            cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
          fi

          # Check sales order rules
          SALES_FILE="docs/sales-order-business-rules.md"
          if [ -f "$SALES_FILE" ]; then
            if ! diff -q "$SALES_FILE" /tmp/sales-order-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in sales order business rules"
              cp /tmp/sales-order-rules-new.md "$SALES_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new sales order business rules file"
            cp /tmp/sales-order-rules-new.md "$SALES_FILE"
          fi

          # Check customer/AR rules
          CUSTOMER_AR_FILE="docs/customer-ar-business-rules.md"
          if [ -f "$CUSTOMER_AR_FILE" ]; then
            if ! diff -q "$CUSTOMER_AR_FILE" /tmp/customer-ar-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in customer/AR business rules"
              cp /tmp/customer-ar-rules-new.md "$CUSTOMER_AR_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new customer/AR business rules file"
            cp /tmp/customer-ar-rules-new.md "$CUSTOMER_AR_FILE"
          fi

          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in any business rules files"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Files Updated
            - `docs/invoice-business-rules.md` - Invoice/billing validation rules
            - `docs/sales-order-business-rules.md` - Sales order validation and processing rules
            - `docs/customer-ar-business-rules.md` - Customer master and accounts receivable rules

            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated