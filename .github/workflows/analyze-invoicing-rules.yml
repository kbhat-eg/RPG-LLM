name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only
  push:
    paths:
      - '**/SO*.MBR'
      - '**/FO*.MBR'
      - '**/LO*.MBR'
      - '.github/workflows/analyze-invoicing-rules.yml'

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect-changes
        run: |
          mkdir -p .github/cache

          # Get changed files from the last commit or compare with main
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, get ALL relevant files for comprehensive business logic analysis
            echo "Manual trigger - analyzing ALL module files for complete business logic extraction"
            SO_FILES=$(find NXCLOUD NXKORR -name "SO*.MBR" -type f 2>/dev/null || echo "")
            FO_FILES=$(find NXCLOUD NXKORR -name "FO*.MBR" -type f 2>/dev/null || echo "")
            LO_FILES=$(find NXCLOUD NXKORR -name "LO*.MBR" -type f 2>/dev/null || echo "")

            # Count files for logging
            SO_COUNT=$(echo "$SO_FILES" | grep -c . || echo "0")
            FO_COUNT=$(echo "$FO_FILES" | grep -c . || echo "0")
            LO_COUNT=$(echo "$LO_FILES" | grep -c . || echo "0")
            echo "Found $SO_COUNT invoicing files, $FO_COUNT sales order files, $LO_COUNT purchase order files"
          else
            # For push events, get only changed files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            SO_FILES=$(echo "$CHANGED_FILES" | grep "SO.*\.MBR" || echo "")
            FO_FILES=$(echo "$CHANGED_FILES" | grep "FO.*\.MBR" || echo "")
            LO_FILES=$(echo "$CHANGED_FILES" | grep "LO.*\.MBR" || echo "")
          fi

          # Calculate hash for invoicing files and check cache
          if [ -n "$SO_FILES" ]; then
            CURRENT_SO_HASH=$(echo "$SO_FILES" | xargs -r md5sum 2>/dev/null | md5sum | cut -d' ' -f1 || echo "none")
            PREVIOUS_SO_HASH=$(cat .github/cache/invoicing-hash.txt 2>/dev/null || echo "")

            if [ "$CURRENT_SO_HASH" != "$PREVIOUS_SO_HASH" ]; then
              echo "invoicing=true" >> $GITHUB_OUTPUT
              echo "$SO_FILES" > /tmp/so-files.txt
              echo "$CURRENT_SO_HASH" > .github/cache/invoicing-hash.txt
              echo "Invoicing files changed (hash: $CURRENT_SO_HASH)"
            else
              echo "invoicing=false" >> $GITHUB_OUTPUT
              echo "Invoicing files unchanged - skipping analysis (cached)"
            fi
          else
            echo "invoicing=false" >> $GITHUB_OUTPUT
          fi

          # Calculate hash for sales order files and check cache
          if [ -n "$FO_FILES" ]; then
            CURRENT_FO_HASH=$(echo "$FO_FILES" | xargs -r md5sum 2>/dev/null | md5sum | cut -d' ' -f1 || echo "none")
            PREVIOUS_FO_HASH=$(cat .github/cache/sales-order-hash.txt 2>/dev/null || echo "")

            if [ "$CURRENT_FO_HASH" != "$PREVIOUS_FO_HASH" ]; then
              echo "sales-order=true" >> $GITHUB_OUTPUT
              echo "$FO_FILES" > /tmp/fo-files.txt
              echo "$CURRENT_FO_HASH" > .github/cache/sales-order-hash.txt
              echo "Sales order files changed (hash: $CURRENT_FO_HASH)"
            else
              echo "sales-order=false" >> $GITHUB_OUTPUT
              echo "Sales order files unchanged - skipping analysis (cached)"
            fi
          else
            echo "sales-order=false" >> $GITHUB_OUTPUT
          fi

          # Calculate hash for purchase order files and check cache
          if [ -n "$LO_FILES" ]; then
            CURRENT_LO_HASH=$(echo "$LO_FILES" | xargs -r md5sum 2>/dev/null | md5sum | cut -d' ' -f1 || echo "none")
            PREVIOUS_LO_HASH=$(cat .github/cache/purchase-order-hash.txt 2>/dev/null || echo "")

            if [ "$CURRENT_LO_HASH" != "$PREVIOUS_LO_HASH" ]; then
              echo "purchase-order=true" >> $GITHUB_OUTPUT
              echo "$LO_FILES" > /tmp/lo-files.txt
              echo "$CURRENT_LO_HASH" > .github/cache/purchase-order-hash.txt
              echo "Purchase order files changed (hash: $CURRENT_LO_HASH)"
            else
              echo "purchase-order=false" >> $GITHUB_OUTPUT
              echo "Purchase order files unchanged - skipping analysis (cached)"
            fi
          else
            echo "purchase-order=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.detect-changes.outputs.invoicing == 'true' || steps.detect-changes.outputs.sales-order == 'true' || steps.detect-changes.outputs.purchase-order == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        if: steps.detect-changes.outputs.invoicing == 'true' || steps.detect-changes.outputs.sales-order == 'true' || steps.detect-changes.outputs.purchase-order == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze invoicing business rules
        if: steps.detect-changes.outputs.invoicing == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the list of changed files
          CHANGED_SO_FILES=$(cat /tmp/so-files.txt | tr '\n' ' ')
          FILE_COUNT=$(cat /tmp/so-files.txt | wc -l)

          echo "Analyzing $FILE_COUNT invoicing file(s): $CHANGED_SO_FILES"

          # Create file list argument for Claude
          FILE_ARGS=""
          for file in $CHANGED_SO_FILES; do
            FILE_ARGS="$FILE_ARGS --file $file"
          done

          claude -p "Analyze ONLY the provided RPG source files related to INVOICING/BILLING (Table SOHEPF and related tables).

          Focus on extracting VALIDATION RULES and BUSINESS LOGIC from these specific files:

          ## Validation Rules
          - Field validations with DB2 table.column references
          - Data type constraints and allowed values
          - Required fields and null handling

          ## Blockers (What Stops the Process)
          - Conditions that prevent invoice creation
          - Error conditions that halt processing
          - Business rule violations that block completion

          ## Prerequisites
          - What must exist before invoicing can proceed
          - Required master data (customers, products, prices)
          - Status requirements on related records

          ## Key Calculations
          - Tax/VAT (MVA) calculation rules with table references
          - Discount and pricing logic
          - Totaling and rounding rules

          Be concise and focus only on rules found in the provided files. Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable." \
          $FILE_ARGS \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Analyze sales order business rules
        if: steps.detect-changes.outputs.sales-order == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the list of changed files
          CHANGED_FO_FILES=$(cat /tmp/fo-files.txt | tr '\n' ' ')
          FILE_COUNT=$(cat /tmp/fo-files.txt | wc -l)

          echo "Analyzing $FILE_COUNT sales order file(s): $CHANGED_FO_FILES"

          # Create file list argument for Claude
          FILE_ARGS=""
          for file in $CHANGED_FO_FILES; do
            FILE_ARGS="$FILE_ARGS --file $file"
          done

          claude -p "Analyze ONLY the provided RPG source files related to SALES ORDERS (Main table FOHEPF and related tables).

          Focus on extracting VALIDATION RULES and BUSINESS LOGIC from these specific files:

          ## Validation Rules
          - Field validations with DB2 table.column references
          - Data type constraints and allowed values
          - Required fields and null handling

          ## Flow
          - How a salesorder moves through different stages

          ## Blockers (What Stops the Process)
          - Conditions that prevent order creation/processing
          - Credit limit violations
          - Inventory/availability blocks
          - Error conditions that halt processing

          ## Prerequisites
          - What must exist before order can be created
          - Required master data (customers, products, inventory)
          - Status requirements on related records

          ## Status Transitions
          - Valid order status values and transitions
          - What triggers status changes
          - Conditions for order completion

          Be concise and focus only on rules found in the provided files. Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable." \
          $FILE_ARGS \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/sales-order-rules-new.md

      - name: Analyze purchase order business rules
        if: steps.detect-changes.outputs.purchase-order == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the list of changed files
          CHANGED_LO_FILES=$(cat /tmp/lo-files.txt | tr '\n' ' ')
          FILE_COUNT=$(cat /tmp/lo-files.txt | wc -l)

          echo "Analyzing $FILE_COUNT purchase order file(s): $CHANGED_LO_FILES"

          # Create file list argument for Claude
          FILE_ARGS=""
          for file in $CHANGED_LO_FILES; do
            FILE_ARGS="$FILE_ARGS --file $file"
          done

          claude -p "Analyze ONLY the provided RPG source files related to PURCHASE ORDERS (Main table LOHEPF and related tables).

          Focus on extracting VALIDATION RULES and BUSINESS LOGIC from these specific files:

          ## Validation Rules
          - Field validations with DB2 table.column references
          - Data type constraints and allowed values
          - Required fields and null handling

          ## Blockers (What Stops the Process)
          - Conditions that prevent PO creation/processing
          - Vendor/supplier validation failures
          - Budget or approval blocks
          - Error conditions that halt processing

          ## Prerequisites
          - What must exist before PO can be created
          - Required master data (vendors, products, contracts)
          - Approval requirements

          ## Receiving Rules
          - Goods receipt validation rules
          - Quantity matching rules (over/under receipt handling)
          - Quality inspection requirements

          Be concise and focus only on rules found in the provided files. Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable. Include source file references." \
          $FILE_ARGS \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/purchase-order-rules-new.md

      - name: Check for changes
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false

          # Check invoicing rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.invoicing }}" = "true" ] && [ -f "/tmp/invoicing-rules-new.md" ]; then
            INVOICING_FILE="docs/invoicing-business-rules.md"
            if [ -f "$INVOICING_FILE" ]; then
              if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
                CHANGES_DETECTED=true
                echo "Changes detected in invoicing business rules"
                cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
              fi
            else
              CHANGES_DETECTED=true
              echo "Creating new invoicing business rules file"
              cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
            fi
          fi

          # Check sales order rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.sales-order }}" = "true" ] && [ -f "/tmp/sales-order-rules-new.md" ]; then
            SALES_FILE="docs/sales-order-business-rules.md"
            if [ -f "$SALES_FILE" ]; then
              if ! diff -q "$SALES_FILE" /tmp/sales-order-rules-new.md > /dev/null 2>&1; then
                CHANGES_DETECTED=true
                echo "Changes detected in sales order business rules"
                cp /tmp/sales-order-rules-new.md "$SALES_FILE"
              fi
            else
              CHANGES_DETECTED=true
              echo "Creating new sales order business rules file"
              cp /tmp/sales-order-rules-new.md "$SALES_FILE"
            fi
          fi

          # Check purchase order rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.purchase-order }}" = "true" ] && [ -f "/tmp/purchase-order-rules-new.md" ]; then
            PURCHASE_FILE="docs/purchase-order-business-rules.md"
            if [ -f "$PURCHASE_FILE" ]; then
              if ! diff -q "$PURCHASE_FILE" /tmp/purchase-order-rules-new.md > /dev/null 2>&1; then
                CHANGES_DETECTED=true
                echo "Changes detected in purchase order business rules"
                cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
              fi
            else
              CHANGES_DETECTED=true
              echo "Creating new purchase order business rules file"
              cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
            fi
          fi

          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in analyzed business rules files"
          fi

      - name: Commit cache files
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add .github/cache/*.txt 2>/dev/null || true

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Modules Analyzed
            ${{ steps.detect-changes.outputs.invoicing == 'true' && '- **Invoicing** - SO*.MBR files changed' || '' }}
            ${{ steps.detect-changes.outputs.sales-order == 'true' && '- **Sales Orders** - FO*.MBR files changed' || '' }}
            ${{ steps.detect-changes.outputs.purchase-order == 'true' && '- **Purchase Orders** - LO*.MBR files changed' || '' }}

            ### Files Updated
            ${{ steps.detect-changes.outputs.invoicing == 'true' && '- `docs/invoicing-business-rules.md` - Invoice/billing validation rules' || '' }}
            ${{ steps.detect-changes.outputs.sales-order == 'true' && '- `docs/sales-order-business-rules.md` - Sales order validation rules' || '' }}
            ${{ steps.detect-changes.outputs.purchase-order == 'true' && '- `docs/purchase-order-business-rules.md` - Purchase order validation rules' || '' }}

            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated
