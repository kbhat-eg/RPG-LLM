name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze invoicing business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO616R (invoice engine) and FO615R (invoice line processing).

          Generate markdown document titled '# Business Logic for Invoice Processing'

          STRUCTURE (22 numbered rules in 7 sections):

          ## Product and Pricing Rules (Rules 1-3)
          1. Product Must Exist in Master File → VVARPF.VAVARE, check SODTPF.SDVARE
          2. Product Must Have Valid Price → SODTPF.SDSAPR from FODTPF.FDSAPR
          3. Quantity Must Be Valid → SODTPF.SDANTA > 0 from FODTPF.FDANTA

          ## Tax/VAT (MVA) Rules (Rules 4-7)
          4. Tax Code Must Be Valid → VMVAPF.VAMVA (0=0%, 1=25%, 2=15%, 3=12%)
          5. Tax Rate Must Match Tax Code → VMVAPF.VAPROC
          6. Tax Base Amount Must Be Calculated Correctly → SDSALG = SDANTA × SDSAPR
          7. Tax Amount Must Be Calculated and Rounded Correctly → SOHEPF.SOMVGH, ±0.5 rounding

          ## Discount Rules (Rules 8-10)
          8. Customer Discount Must Be Applied Correctly → RKUNPF.RERAB1/RERAB2/RERAB3 cascade
          9. Product Group Discount Must Be Applied → VVARPF.VAVAGL
          10. Special Discount (Bruksrett) Must Be Validated → SODTPF.SDBRRB

          ## Deposit and Prepayment Rules (Rules 11-13)
          11. Deposit Amount Must Be Validated → SDEPPFR.SKDEPB >= SKDEPO
          12. Deposit Must Be Deducted from Final Invoice → SOHEPF.SOFORS
          13. Deposit Invoice vs. Final Invoice Type → SOHEPF.SOTYPE

          ## Total Calculation Rules (Rules 14-16)
          14. Line Totals Must Sum Correctly → SOFSUM = sum(SDSALG) + SOMVGH - SOFORS
          15. Rounding Differences Must Be Within Tolerance → ±0.05 øre
          16. Zero-Value Invoices Must Be Handled Specially → SOFSUM = 0

          ## Payment and KID Rules (Rules 17-19)
          17. Payment Terms Must Be Valid → RKUNPF.REBETA
          18. Due Date Must Be Calculated Correctly → SOFRDA = SOFKDA + payment days
          19. KID Number Must Be Generated or Validated → RN012R, MOD10/MOD11

          ## Configuration and System Rules (Rules 20-22)
          20. Accounting Period Must Be Open → AARRF.ARSTRT ≠ '1'
          21. System Must Not Be Locked for Invoicing → FA730R check
          22. Invoice Number Sequence Must Be Available → SOBINR sequential

          RULE FORMAT:
          ### [Number]. [Title]
          *   **Logic:** [Plain English explanation]
          *   **File:** \`TABLE\` ([Description])
          *   **Field:** or **Fields:** \`FIELD\`
          *   **Condition:** [Detailed explanation with table.column references]

          Include:
          - Subprogram Calls Affecting Logic (7 programs)
          - Summary of Critical Blocking Conditions (15 items)
          - Invoice Processing Flow Summary (3 steps)

          NO SQL queries. Use plain English with 'What is checked', 'Why this is required', 'What happens when' format." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Analyze sales order business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO601R (order entry), FO602R/FO603R (order selection).

          Generate markdown document titled '# Business Logic for Sales Order Management'

          STRUCTURE (34 numbered rules in 9 sections):

          ## Order Header Creation Rules (Rules 1-5)
          1. Customer Must Exist and Be Active → RKUNPF.REKUND, RESPER ≠ '1'
          2. Order Type Must Be Valid → VOTYF.VAOTYP, affects stock/statistics flags
          3. Order Date Must Be Valid → FOHEPF.FOOLDA, valid date format
          4. Requested Delivery Date Must Be Logical → FOLEDA >= FOOLDA
          5. Currency Must Be Valid → FOHEPF.FOVALU

          ## Order Line Creation Rules (Rules 6-10)
          6. Product Must Exist and Be Active → VVARPF.VAVARE, VASTOP ≠ '1'
          7. Quantity Must Be Greater Than Zero → FODTPF.FDANTA > 0
          8. Unit of Measure Must Be Valid → FODTPF.FDENHE
          9. Price Must Be Determined → FODTPF.FDSAPR
          10. Line Total Must Be Calculated → FDSALG = FDANTA × FDSAPR

          ## Inventory and Stock Rules (Rules 11-13)
          11. Stock Availability Must Be Checked → LVAREF.LLDISP >= ordered qty, if VOTYF.VAOOKO='1'
          12. Product Must Allow Sales from Stock → VVARPF.VALAGL
          13. Warehouse/Location Must Be Valid → FODTPF.FDLOKE

          ## Pricing and Discount Rules (Rules 14-17)
          14. Customer Price Agreement Must Be Applied
          15. Promotional Pricing Must Be Applied
          16. Discount Cascades Must Be Applied Correctly → FDRAB1/FDRAB2/FDRAB3
          17. Manual Discount Overrides Must Be Authorized → FUSER check

          ## Credit Limit and Financial Rules (Rules 18-20)
          18. Customer Credit Limit Must Not Be Exceeded → REKRLI >= REKSDO + new order
          19. Overdue Invoices May Block New Orders → RKUNPF.REKRSP = '1'
          20. Payment Terms Must Be Assigned → FOBETA from REBETA

          ## Order Status and Flow Rules (Rules 21-24)
          21. Order Status Must Follow Valid Transitions → FOSTUS: 10→20→30→40→50→60→90
          22. Order Cannot Be Modified After Picking → FOSTUS >= 40
          23. Order Cannot Be Deleted If Invoiced → FOBINR exists
          24. Cancelled Orders Must Retain Audit Trail → FOSTUS = 90

          ## Partial Delivery and Invoicing Rules (Rules 25-27)
          25. Partial Shipments Must Be Tracked → FDLEVQ vs FDANTA
          26. Partial Invoicing Must Reference Original Order → SDONR
          27. Final Invoice Must Complete the Order → FDLEVQ = FDANTA

          ## Special Order Types and Handling (Rules 28-31)
          28. Project Orders Must Reference Valid Projects → FOPROJ
          29. Credit Notes Must Reference Original Invoices → FOOTYP, FOBINR
          30. Rush Orders Must Be Flagged → FOEKSP = '1'
          31. Direct Delivery Orders Skip Warehouse → FOLEVT

          ## Integration and Automation Rules (Rules 32-34)
          32. EDI Orders Must Pass Format Validation
          33. Web Orders Must Include Authentication
          34. Duplicate Order Prevention

          RULE FORMAT:
          ### [Number]. [Title]
          *   **Logic:** [Plain English explanation]
          *   **File:** \`TABLE\` ([Description])
          *   **Field:** or **Fields:** \`FIELD\`
          *   **Condition:** [Detailed explanation]

          Include:
          - Subprogram Calls Affecting Sales Order Logic (5 programs)
          - Summary of Critical Blocking Conditions (12 items)
          - Order Lifecycle Flow (6 steps)

          NO SQL queries. Use plain English." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/sales-order-rules-new.md

      - name: Analyze purchase order business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs for PURCHASE ORDER MANAGEMENT.

          Generate markdown document titled '# Business Logic for Purchase Order Management'

          STRUCTURE (30+ numbered rules in 9 sections):

          ## PO Header Creation Rules (Rules 1-5)
          1. Vendor Must Exist and Be Active → Vendor master, vendor blocked flag
          2. PO Type Must Be Valid → PO type master
          3. PO Date Must Be Valid → LOHEPF.LOORDA date format
          4. Requested Delivery Date Must Be Logical → delivery date >= PO date
          5. Currency Must Be Valid → LOHEPF currency code

          ## PO Line Creation Rules (Rules 6-10)
          6. Product Must Exist → Product master, product number
          7. Quantity Must Be Greater Than Zero → LODTPF quantity > 0
          8. Unit of Measure Must Be Valid → LODTPF unit of measure
          9. Unit Price Must Be Valid → LODTPF unit price
          10. Line Total Must Be Calculated → line total = qty × price

          ## Vendor and Supplier Rules (Rules 11-15)
          11. Vendor Must Not Be Blocked
          12. Vendor Payment Terms Must Be Valid
          13. Vendor Currency Requirements
          14. Vendor Lead Time Validation
          15. Vendor Minimum Order Quantity

          ## Budget and Approval Rules (Rules 16-20)
          16. Budget Must Be Available
          17. Approval Workflow Must Be Followed
          18. User Approval Limits Must Not Be Exceeded
          19. Multi-Level Approval Thresholds
          20. Emergency PO Authorization

          ## Pricing and Contract Rules (Rules 21-24)
          21. Contract Prices Must Be Applied
          22. Price Tolerance Checks
          23. Volume Discount Application
          24. Price History Validation

          ## Receiving and Goods Receipt Rules (Rules 25-30)
          25. Goods Receipt Must Reference Valid PO → LLOHE, LLODT files
          26. Received Quantity Must Match PO → Over/under receipt tolerances
          27. Three-Way Matching Must Pass → PO, GR, Invoice
          28. Quality Inspection Requirements
          29. Partial Receipt Handling
          30. Receipt Reversal Rules

          ## PO Status and Flow Rules (Rules 31-34)
          31. PO Status Must Follow Valid Transitions → Draft→Approved→Ordered→Received→Closed
          32. PO Cannot Be Modified After Approval
          33. PO Cannot Be Deleted If Received
          34. Closed POs Must Retain History

          ## Invoice Matching Rules (Rules 35-37)
          35. Invoice Must Match PO
          36. Price Variance Must Be Within Tolerance
          37. Quantity Variance Handling

          ## Special PO Types (Rules 38-40)
          38. Blanket POs Must Have Contract Reference
          39. Standing Orders Must Have Schedule
          40. Drop Ship POs Must Have Delivery Address

          RULE FORMAT:
          ### [Number]. [Title]
          *   **Logic:** [Plain English explanation]
          *   **File:** \`TABLE\` ([Description])
          *   **Field:** \`FIELD\`
          *   **Condition:** [Detailed explanation]

          Include:
          - Subprogram Calls
          - Summary of Critical Blocking Conditions
          - PO Lifecycle Flow

          NO SQL queries. Use plain English. Include source file references." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/purchase-order-rules-new.md

      - name: Check for changes
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false

          # Check invoicing rules
          INVOICING_FILE="docs/invoicing-business-rules.md"
          if [ -f "$INVOICING_FILE" ]; then
            if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in invoicing business rules"
              cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new invoicing business rules file"
            cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
          fi

          # Check sales order rules
          SALES_FILE="docs/sales-order-business-rules.md"
          if [ -f "$SALES_FILE" ]; then
            if ! diff -q "$SALES_FILE" /tmp/sales-order-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in sales order business rules"
              cp /tmp/sales-order-rules-new.md "$SALES_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new sales order business rules file"
            cp /tmp/sales-order-rules-new.md "$SALES_FILE"
          fi

          # Check purchase order rules
          PURCHASE_FILE="docs/purchase-order-business-rules.md"
          if [ -f "$PURCHASE_FILE" ]; then
            if ! diff -q "$PURCHASE_FILE" /tmp/purchase-order-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in purchase order business rules"
              cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new purchase order business rules file"
            cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
          fi

          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in any business rules files"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Files Updated
            - `docs/invoicing-business-rules.md` - Invoice/billing validation rules
            - `docs/sales-order-business-rules.md` - Sales order validation rules
            - `docs/purchase-order-business-rules.md` - Purchase order validation rules

            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated
