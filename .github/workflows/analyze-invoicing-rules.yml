name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze invoicing business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO616R (invoice engine) and FO615R (invoice line processing). Main tables: SOHEPF (Invoice Header) and SODTPF (Invoice Lines).

          Provide markdown output describing the validation logic and calculations that occur during invoice processing, after orders have been selected. Include these sections:

          ## Product and Pricing Rules
          - Product validation during invoice creation
          - Price validation and application
          - Quantity validation on invoice lines

          ## Tax/VAT (MVA) Rules
          - Tax code validation with VMVAPF table
          - Tax rate matching and application
          - Tax base amount calculation (Quantity × Price - Discounts)
          - Tax amount calculation and rounding (Norwegian rules)

          ## Discount Rules
          - Customer discount application from RKUNPF (RERAB1, RERAB2, RERAB3)
          - Discount cascade calculation sequence
          - Product group discount handling
          - Special discounts (bruksrett) validation

          ## Deposit and Prepayment Rules
          - Deposit amount validation from SDEPPFR
          - Deposit deduction from final invoice (SOFORS field)
          - Deposit invoice vs. final invoice type handling

          ## Total Calculation Rules
          - Line totals summation logic
          - Invoice header total calculation (SOFSUM)
          - Rounding difference tolerance (±0.05 øre)
          - Zero-value invoice handling

          ## Payment and KID Rules
          - Payment terms validation and due date calculation
          - KID (Customer ID) number generation via RN012R
          - MOD10/MOD11 checksum algorithms

          ## Configuration and System Rules
          - Accounting period validation (AARRF.ARSTRT)
          - System lock checks via FA730R
          - Invoice number sequence generation

          NOTE: Do NOT include order validation rules (customer exists, order status, order locks, user authorization). Those belong in sales-order-business-rules.md.

          Format as markdown with this structure:
          - Each rule has: Logic, File, Field, Condition sections
          - Group rules by the categories above
          - Include subprogram calls section
          - Include summary of critical blocking conditions

          Use DB2 TABLE.COLUMN notation where identifiable.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Analyze sales order business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO100R, FO500R, FO614R, and FO730R to document the complete sales order business rules for the NexStep ERP system.

          Primary tables:
          - SOHEPF: Sales Order/Invoice Header (key fields: SOFIRM, SOAARR, SOBINR, SONUMM, SOSUFF, SOOTYP, SOKUND, SOLKUN, SOKPRO, SOBDAT, SOLDAT, SOFKDA, SOSELG, SOAVDE, SOLAGE, SOLETY, SOLMAT, SOBETB, SORABP, SOFSUM)
          - SODTPF: Sales Order/Invoice Line Items (key fields: SDFIRM, SDAARR, SDBINR, SDNUMM, SDSUFF, SDLINE, SDVARE, SDANTA, SDSAPR, SDKOPR, SDRAB1, SDRAB2, SDSALG, SDLTYP, SDLAGE, SDAVDE)

          Lookup/reference tables: RKUNPF (customer master), VOTYPF (order types), VLTPPF (delivery types), FKPRPF (customer projects), VVARPF (item master), RKMEPF (customer memo balance), RA07PF (warehouses), RA09PF (salespersons), RA17PF (shipping methods)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          - Purpose of the document
          - How to use it (field prefix convention: SO = header fields, SD = line fields)
          - Key terminology: Order vs Quote (Tilbud), Memo Balance (Memosaldo), Resting (back-order), Customer Project (Kundeprosjekt)

          ## 2. Database Schema Overview
          - SOHEPF table with field name, type, and English description for the core fields listed above
          - SODTPF table with field name, type, and English description for the core fields listed above
          - Related lookup tables summary

          ## 3. Order Creation Prerequisites
          - Required master data (customer in RKUNPF, order type in VOTYPF with VASYST=0, warehouse in RA07PF, salesperson, payment terms)
          - User permission requirements (FUSRPF, warehouse/department restrictions, packing slip mode)

          ## 4. Customer Validation Rules
          - 4.1 Customer existence: SOKUND/SOLKUN must exist in RKUNPF by RKKUND
          - 4.2 Customer status: RKUNPF.RKSPER (0=active, 1=blocked)
          - 4.3 Cash customer restrictions: cash customers can only create quotes not orders
          - 4.4 Invoice customer vs goods customer: RKUNPF.RKFAKU must match SOKUND
          - 4.5 Customer project requirements [CONFIGURABLE]: driven by RKKATG, project must exist in FKPRPF
          - 4.6 Internal customer validation: RKAVGF/RKFABI require internal order types

          ## 5. Credit Limit Rules
          - 5.1 Credit limit check: Available Credit = RKUNPF.RKGREN minus RKMEPF.RKMEMS
          - 5.2 Credit block status: RKUNPF.RKKRSP — blocked orders, quotes still allowed, F18 override
          - 5.3 Quote exception: order types with accumulator type=0 bypass credit block
          - 5.4 Credit override permissions: F18 approval, audit logging
          - 5.5 Extended memo balance [CONFIGURABLE]: includes future uninvoiced orders with VAT
          - 5.6 Public discount limit (Almenning): RKUNPF.RKGRAL

          ## 6. Order Header Validation
          - 6.1 Order type (SOOTYP): must exist in VOTYPF, VASYST=0, cannot change when lines exist
          - 6.2 Order number (SONUMM): system-assigned from order type number series, suffix rules for backorders
          - 6.3 Salesperson (SOSELG): must exist in RA09PF, inherits from user profile or RKUNPF.RKSLGR
          - 6.4 Warehouse (SOLAGE): must exist in RA07PF, user restrictions apply
          - 6.5 Department (SOAVDE) [CONFIGURABLE]: must exist in department register, consistent with warehouse
          - 6.6 Warehouse-department consistency: cross-reference defines valid combinations
          - 6.7 Delivery type (SOLETY): must exist in VLTPPF; affects purchase order creation and pricing
          - 6.8 Shipping method (SOLMAT): must exist in RA17PF
          - 6.9 Payment terms (SOBETB): must exist in payment terms register, inherits from customer master
          - 6.10 Customer references: SOVREF, SODREF, SOREKV — configurable required fields
          - 6.11 Delivery address: from customer project or goods customer; LAOK confirmation may be required

          ## 7. Order Line Validation
          - 7.1 Line type (SDLTYP): Normal (full validation), Text (no pricing), D-Type (manual pricing); check VLTYPF.VALKTX
          - 7.2 Item number (SDVARE): must exist in VVARPF, item status must allow sales
          - 7.3 Quantity (SDANTA): sign rules (positive=sales, negative=returns via VALKRE='-'), 3 decimal places
          - 7.4 Unit of measure (SDENH1): must be valid for the item
          - 7.5 Line-level warehouse (SDLAGE): defaults from header, can be overridden, must be valid
          - 7.6 Line-level department (SDAVDE): defaults from header, must be consistent with warehouse

          ## 8. Price and Discount Rules
          - 8.1 Price determination via VP900R: hierarchy = customer-specific → customer price group → standard → manual (type D)
          - 8.2 Discount hierarchy: Order Discount (SORABP) → Line Disc 1 (SDRAB1) → Line Disc 2 (SDRAB2) → Bracket Disc 1 (SDBRR1) → Bracket Disc 2 (SDBRR2); show calculation formula
          - 8.3 Discount category override: FL710R customer project discount override
          - 8.4 Price group (SDPRGR): 2-char code determined by VL712R, used in price matrix
          - 8.5 Return fee [CONFIGURABLE]: CO402R configuration, added as extra line in FOD2PF
          - 8.6 Manual pricing (type D items): VVARPF.VVVTYP='D', skip automatic lookup
          - 8.7 Public discount limit: RKUNPF.RKGRAL tracking

          ## 9. Date Validation Rules
          - 9.1 Order date (SOBDAT): valid date, not more than 1 year past/future, not in closed accounting period
          - 9.2 Delivery date (SOLDAT): valid date, must be >= SOBDAT, [CONFIGURABLE] required
          - 9.3 Follow-up date (FODDAT) for quotes: >= order date, auto-calculated from FAAOPF days
          - 9.4 Expiry date (FOTDAT) for quotes: > order date, auto-calculated from FAAUTG days
          - 9.5 Invoice date (SOFKDA): set by invoicing process FO614R, not validated on entry

          ## 10. Status and Workflow Rules
          - 10.1 Order states: New (no lines) → Open (has lines) → On Hold (info code) → Picking (FOAKKT) → Picked → Invoiced (SOBINR>0) → Partial
          - 10.2 Order lock: system locks during processing, user override may be available
          - 10.3 Picking status: FOAKKT set locks the order; limited modifications may be allowed
          - 10.4 Info code hold: SOINF1/SOINF2 can block processing; must be cleared before fulfillment
          - 10.5 Backorder (Resting) processing: original suffix incremented, new suffix for backordered items

          ## 11. Integration Rules
          - 11.1 Customer project integration: delivery address, contact info, discount category, payment terms, invoice type all overridden by project
          - 11.2 EDI requirements: SOEDIH indicates EDI order, SONREF required; line-level SDEDIH/SDEDIL
          - 11.3 Transport integration: certain SOLMAT values trigger transport API calls and cancellation on change
          - 11.4 Deposit/prepayment: SODEPO indicator, SODEPB billing ref, SOFOSA/SOFOSI settlement; cannot delete orders with unsettled deposits

          ## 12. Field Reference
          - Complete SOHEPF header field table: Field | Type | Norwegian | English Description (include all fields from SOFIRM through SOEUSR)
          - Complete SODTPF line field table: Field | Type | Norwegian | English Description (include all fields from SDFIRM through SDEUSR)

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Use DB2 TABLE.COLUMN notation where identifiable. Format as markdown." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/sales-order-rules-new.md

      - name: Analyze customer and AR business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs RK100R, RK108R, RK110R, RK400R, RK500R, RK620R, RE110R, RE120R, RE600R, RE601R, RE602R, RE603R, RE609R, RE613R, RE615R, RE621R, RE623R, RE630R, RE632R, RE633R, AR100R, AR700R to document the complete Customer and Accounts Receivable business rules for the NexStep ERP system.

          FIELD CORRECTIONS (verified from DDS source):
          - RKTRPF field prefix is RN (RNFIRM, RNKUND, RNBILK, RNBELØ, RNREST, RNSTAT, RNKID, RNFDAT) — not RT
          - RE01PF/RE02PF/RE03PF are GL reporting tables (Trioplan balance matrix, income register, trial balance) — NOT AR transaction tables
          - Key RKUNPF field names: RKGRNS=credit limit, RKKRES=credit block, RKSPRK=block status, RKSALD=sales YTD, RKEMAL=email, RKFTNR=org number, RKRABK=discount, RKLAGR=warehouse, RKPASS=passive flag, RKMEPF.RKMEMA=memo amount

          Primary tables (read DDS source for all field names):
          - RKUNPF: Customer Master
          - RKMEPF: Customer Memo Balance (real-time credit exposure, amount field RKMEMA)
          - RKTRPF: Customer Postings (field prefix RN, not RT)
          - REKUPF: Customer AR Ledger Summary
          - REMSPF: GL/AR Posting Registration (field prefix RT)

          Lookup tables: AKIDPF (KID references), RA1HKT/RA1HRS (customer number range config), ARAFPF (company), RA09PF (salespersons), SOHEPF (sales orders for deletion check)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          Purpose, how to use it, field prefix conventions (RK=customer master, RN=postings in RKTRPF, RT=GL registration in REMSPF), key Norwegian terminology: Kunderegister, Memosaldo, Postering, Aldersfordeling, KID, Remisse, Spesialavtale.

          ## 2. Database Schema Overview
          Field tables for RKUNPF, RKMEPF, RKTRPF, REKUPF, REMSPF — each with field name, type, length, English description from DDS source. Note that RE01PF/RE02PF/RE03PF are GL reporting tables only.

          ## 3. Customer Master Prerequisites
          Required master data lookups (company, payment terms, salesperson in RA09PF, department, category), user permission model (maintenance rights, department restriction ABBAVD), customer number range rules (RA1HKT to RA1HRS).

          ## 4. Customer Master Validation Rules
          Name (RKNAVN) required; alpha key (RKALFA) auto-populated via RK750R; org number (RKFTNR) format; block status (RKSPRK); invoice customer (RKFAKU); duplicate detection via RK108R; deletion checklist via RK400R (no open RKTRPF/SOHEPF); merge/move rules via RK108R with TESTSPERRE check.

          ## 5. Credit and Financial Limit Rules
          Credit limit (RKGRNS) vs memo balance (RKMEPF.RKMEMA); why RKMEPF is used over RKSALD for real-time checks; four-level credit block (RKKRES); payment terms inheritance (RKBETB); Almenning purchase limit (RKKJAL/RKGRAL).

          ## 6. Customer Transaction Rules
          Document types in RKTRPF (RNBILK): FA=Invoice, BE=Payment, KR=Credit note; period/date validation (1–13, open period check); amount sign rules; KID generation via RN012R (MOD10/MOD11); accounting period assignment with two-digit year handling.

          ## 7. AR Ledger Rules
          Document creation rules; RNSTAT status lifecycle (O=Open, L=Settled, D=Deleted); payment allocation; three-way balance reconciliation (RKTRPF/RKMEPF/RKSALD); interest calculation using RA6 configuration.

          ## 8. Payment Processing Rules
          Manual payment entry via REMSPF; remittance/OCR KID matching 4-step process via RE630R–RE633R; overpayment credit posting; write-off rules; credit note lifecycle.

          ## 9. AR Aging and Collections Rules
          Aging bucket boundaries by due date with real-world example; dunning configuration (level increments, charges, dispute flag); what updates when a dunning notice is sent; collections escalation via RKINKK; statement generation parameters via RK620R.

          ## 10. Customer Account Status and Workflow Rules
          Five lifecycle states (Active/Order Blocked/Credit Locked/Fully Blocked/Passive); passive customer rules (RKPASS); modification restrictions on key fields (RKFAKU, RKKUND, RKBETB, RKGRNS); year-end processing (RKSALD/RKSAIF sequence reset).

          ## 11. Integration Rules
          External import via RE110R/RK110R (7 rules including non-zero-overwrite logic, number range check); sales order credit check flow (reads RKGRNS and RKMEMA); GL posting split (dann_resk vs dann_trans); KID/bank file matching via RE630R–RE633R; email/PDF delivery via RKEMAL.

          ## 12. Field Reference
          Complete field tables for RKUNPF, RKTRPF, RKMEPF — every field with Norwegian name, English description, type, length from DDS source.

          Do NOT include SQL queries. Use plain English with 'What is checked', 'Why this is required', 'What happens when' explanations and real-world examples. Use DB2 TABLE.COLUMN notation. Format as markdown.

          OUTPUT RULE: Write the markdown document directly. Do NOT write a summary or describe what you created. Start immediately with the # title heading." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/customer-ar-rules-new.md

      - name: Analyze item and product maintenance business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs VV100R, VV101R, VV102R, VV105R, VV106R, VV110R, VV120R, VV400R, VV500R, VV550R, VV555R, VV580R, VV590R, VV600R, VV603R, VV620R, VV680R, VV700R, VV710R, VV740R, VV750R, VP110R, VP410R, VP505R, VP510R, VP600R, VP700R, VP800R, VP900R to document Item and Product Maintenance business rules for the NexStep ERP system.

          FIELD PREFIX CORRECTIONS (verified from DDS source):
          - VVARPF: prefix VV | VVPRPF: prefix VP | VLAGPF: prefix VL | VPGRPF: prefix VPG | VPDTPF: prefix VJ | VVTYPF: prefix VAV | VVLEPF: prefix VVL | VVAAPF: prefix VVA

          Primary tables (read DDS source for all field names):
          - VVARPF: Item Master (prefix VV, key fields: VVVARE, VVTEK1, VVVTYP, VVENHE, VVKMVA, VVKPRI, VVLDOR, VVNOBB, VVMINI, VVMAKS, VVBPUN, VVLTID, VVUDAT)
          - VVPRPF: Item Pricing (prefix VP, extends item master)
          - VLAGPF: Warehouse Item Register (prefix VL, per-warehouse stock data)
          - VPGRPF: Price Group Register (prefix VPG)
          - VPDTPF: Markup Line Register (prefix VJ)
          - VVLEPF: Item-Supplier Register (prefix VVL)

          Lookup tables: VVTYPF (item types, prefix VAV), RKUNPF (customer for price group), RA07PF (warehouses), VVGKPF (item group keys)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          Purpose, field prefix conventions (VV=VVARPF, VP=VVPRPF, VL=VLAGPF, VPG=VPGRPF), Norwegian terminology: Vare, Varenummer, Basisenhet, Lagerenhet, Prisgruppe, Leverandoer, Nobb.

          ## 2. Database Schema Overview
          Field tables for VVARPF, VVPRPF, VLAGPF, VPGRPF, VPDTPF, VVLEPF with field name, type, length, English description from DDS source. Include group hierarchy fields (VVOGRP, VVHGRP, VVUGRP).

          ## 3. Item Master Prerequisites
          Required master data (item groups in VVGKPF, item types in VVTYPF, VAT codes, units); user permissions; item number range rules via VV100R.

          ## 4. Item Master Validation Rules
          Item number (VVVARE) uniqueness; description (VVTEK1/VVTEK2) required; item type (VVVTYP) controls field activation and sales/purchase/stock rules; VAT code (VVKMVA); base unit (VVENHE); alternative item (VVAVAR); item number change via VV110R transfers all references.

          ## 5. Item Classification and Grouping Rules
          Three-level hierarchy: overgroup (VVOGRP) to main group (VVHGRP) to subgroup (VVUGRP); ABC code (VVKABC, VVLABC=lock); bonus code (VVKBON); discount code (VVKORD); group maintenance via VV400R.

          ## 6. Item Pricing Rules
          Price code (VVKPRI); price list via VP410R/VP510R; price groups via VPGRPF; markup via VPDTPF (VJ); price adjustment via VV105R/VV106R using conversion factor (VVOMRN); supplier prices via VP600R/VPRLPF; lookup hierarchy via VP700R/VP900R.

          ## 7. Item Unit and Conversion Rules
          Base unit (VVENHE); storage unit (VVENHL); statistics unit (VVENHS); price comparison unit (VVENPS); conversions via VV555R; decimal precision (VVDESI); unit maintenance via VV550R.

          ## 8. Item Inventory Control Rules
          Min/max stock (VVMINI/VVMAKS); safety stock (VVSIKL); order point (VVBPUN); order quantity (VVBMEN); break-bulk (VVANBR); lead time (VVLTID); location (VVPLAS); per-warehouse data in VLAGPF managed by LI-series programs.

          ## 9. Item Supplier Rules
          Primary supplier (VVLDOR) and supplier item number (VVLVAR); NOBB: number (VVNOBB), price provider (VVNLEV), price (VVNOPR); multiple suppliers via VVLEPF; supplier pricing via VV600R/VP600R; approved purchase flag (VVGODT).

          ## 10. Item Status and Lifecycle Rules
          Discontinuation date (VVUDAT) blocks new orders; item type changes affect operations; deletion rules (no open orders, no stock, no open POs); alternative item (VVAVAR) redirect; item number change via VV110R.

          ## 11. Integration Rules
          Sales order: VVARPF lookup via VV680R, VVVTYP controls line type; price lookup via VP900R using customer price group from RKUNPF; stock check via VLAGPF; purchase order: VVLDOR/VVLVAR and VVLTID for delivery date; NOBB sync via VVNOBB/VVNLEV; catalog via VV620R.

          ## 12. Field Reference
          Complete field tables for VVARPF and VLAGPF -- every field with Norwegian name, English description, type, length from DDS source.

          Do NOT include SQL queries. Use plain English with What is checked, Why this is required, What happens when explanations. Use DB2 TABLE.COLUMN notation. Format as markdown.

          OUTPUT RULE: Write the markdown document directly. Do NOT write a summary or describe what you created. Start immediately with the # title heading." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/item-product-rules-new.md

      - name: Analyze item and product maintenance business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs JV100R, JV101R, JV113R, JV114R, JV115R, JV116R, JV117R, JV118R, JV119R, JV120R, JV125R, JV130R, JV140R, JV145R, JV150R, JV151R, JV155R, JV160R, JV165R, JV170R, JV171R, JV180R, JV185R, JV190R to document the JV Item and Product Maintenance business rules for the NexStep ERP system.

          FIELD PREFIX CORRECTIONS (all field definitions are in JFRF.MBR reference file):
          - JVARPF: prefix JV | JVDTPF: prefix JVD | JLEVPF: prefix JLEV | JW (packaging): prefix JW | JX (pricing): prefix JX | JVL (item-supplier): prefix JVL | JVB (alt numbers): prefix JVB | JVN (NRF data): prefix JVN

          Primary tables (read JFRF.MBR for all field names):
          - JVARPF: Item Master (prefix JV, key fields: JVVARE, JVTEK1, JVTEK2, JVNOBB, JVTYPE, JVSTAT, JVADAT, JVUDAT, JVLDOR, JVLVAR, JVOGRP, JVHGRP, JVUGRP, JVPENH, JVEAN1, JVTONO, JVTOEU)
          - JVDTPF: Item Detail per Company (prefix JVD, fields: JVDFIR, JVDVAR, JVDPKO, JVDSKO, JVDHKO)
          - JLEVPF: Supplier Master (prefix JLEV)
          - JW packaging table (prefix JW, fields: JWVARE, JWPAKN, JWENHE, JWGTIN, JWBRED, JWLENG, JWHOYD, JWVEKT, JWVOLU, JWBEST, JWANTP)
          - JX pricing table (prefix JX, fields: JXVARE, JXLDOR, JXPRIS, JXGDAT, JXTDAT, JXVALU, JXFBEL)
          - JVL item-supplier links (prefix JVL, fields: JVLVNR, JVLLDO, JVLVEI, JVLLVA, JVLUDA)

          Lookup tables: VUGRPF (product groups), VENHPF (units), JKATPF (categories), JPROPF (producers), JSOKPF (search text), ANOTPF (notes)

          Produce a comprehensive business rules document with EXACTLY these 12 sections:

          ## 1. Introduction
          Purpose, field prefix conventions (JV=JVARPF item master, JVD=JVDTPF detail, JW=packaging, JX=pricing, JLEV=supplier), Norwegian terminology: Vare, Varenummer, Nobb, Leverandoer, Pakning, Prisenhet, Forpakning.

          ## 2. Database Schema Overview
          Field tables for JVARPF, JVDTPF, JLEVPF, JW packaging, JX pricing, JVL item-supplier links -- each with field name, type, length, English description from JFRF.MBR. Include group hierarchy fields (JVOGRP, JVHGRP, JVUGRP) and own-group override fields (JVEOGR, JVEHGR, JVEUGR).

          ## 3. Item Master Prerequisites
          Required master data (product groups in VUGRPF, units in VENHPF, categories in JKATPF, supplier in JLEVPF); NOBB registration requirements (JVNOBB must be valid); user permissions; item number format rules via JV100R.

          ## 4. Item Master Validation Rules
          Item number (JVVARE) uniqueness and format; description (JVTEK1/JVTEK2) required; NOBB type (JVTYPE: ST=Standard, SS=Assembled, SP=Special, DS=Display); status (JVSTAT: 0=manual, 1=machine, 2=new, 4=deleted); active date (JVADAT); discontinuation date (JVUDAT); under-construction flag (JVUARB); alternative item numbers via JV113R and JVB table.

          ## 5. Item Classification and Grouping Rules
          Three-level hierarchy: overgroup (JVOGRP) to main group (JVHGRP) to subgroup (JVUGRP); own-group overrides (JVEOGR/JVEHGR/JVEUGR) for company-specific classification; assortment code (JVSORT) and assortment supplier (JVSLDO); delivery type (JVLEVE: 0=Normal, 1=On Order); category responsible (JVKATE); documentation indicator (JVDOKI) with 8 document types.

          ## 6. NOBB and External Database Integration
          NOBB number (JVNOBB) as primary external key; NOBB dates: created (JVNODA), changed (JVNBED), deleted (JVNSDA); replacement NOBB (JVENOB); NRF data in JVN table (JVNNOB, JVNNRF, JVNSTS); alternative product numbers in JVB table (TUN and FINFO types); EAN/GTIN (JVEAN1); producer number (JVPROD) linked to JPROPF; module number (JVMODN).

          ## 7. Item Pricing Rules
          JX pricing table (prefix JX): supplier price (JXPRIS), valid from/to dates (JXGDAT/JXTDAT), currency (JXVALU), freight amount (JXFBEL), cross-docking flag (JXCRDO); price unit (JVPENH) on item master; price code per company in JVDTPF (JVDPKO); procurement code (JVDSKO) and hold code (JVDHKO); supplier pricing maintenance via JV155R/JV160R.

          ## 8. Item Packaging Rules
          JW packaging table (prefix JW): unit code (JWPAKN), GTIN (JWGTIN), dimensions in mm (JWBRED/JWLENG/JWHOYD), weight in grams (JWVEKT), volume in m3 (JWVOLU), quantity per package (JWANTP), orderable flag (JWBEST), packaging class (JWPKLA), pallet layers (JWPAPP); net dimensions (JWNBRE/JWNLEN/JWNHOY/JWNVEK/JWNVOL); PSE flag (JWPSEN); outer packaging via JZ table; packaging maintenance via JV140R/JV145R.

          ## 9. Item Supplier Rules
          JVL item-supplier link table (prefix JVL): supplier number (JVLLDO), product owner flag (JVLVEI), supplier product number (JVLLVA), discontinued date (JVLUDA); supplier markings (JVLMR1/JVLMR2/JVLMR3); supplier media in JVM table (URL and media type); primary supplier (JVLDOR) and supplier item number (JVLVAR) on item master; maintenance via JV155R/JV165R.

          ## 10. Environmental and Compliance Rules
          Environmental marks (JVMMK1/JVMMK2) with country codes (JVMLK1/JVMLK2); hazardous goods: UN number (JVUNNR), hazard number (JVFANR), hazard description (JVFABS); packaging marking (JVEMBM) and packaging group (JVEMGR); PSE marking flag (JVHPSE); frost tolerance (JVTFRO); expiry date tracking (JVHDAT); Norwegian tariff code (JVTONO) and EU tariff code (JVTOEU); approval status (JVGSTS); brand name (JVBRAN).

          ## 11. Item Status and Lifecycle Rules
          Status lifecycle (JVSTAT: 0=manual, 1=machine-processed, 2=new, 4=deleted); active date (JVADAT) -- item not visible before this date; discontinuation date (JVUDAT) -- blocks new orders; under-construction flag (JVUARB) restricts editing; in-stock flag (JVLFOR); product release per file group in JVFFPF (JVFFGR, JVFVAR, JVFOVF); product linkage (JVK/JVQ tables) for composed products; cross-sell and up-sell links in JVO table.

          ## 12. Field Reference
          Complete field tables for JVARPF and JVDTPF -- every field with Norwegian name, English description, type, length from JFRF.MBR.

          Do NOT include SQL queries. Use plain English with What is checked, Why this is required, What happens when explanations. Use DB2 TABLE.COLUMN notation. Format as markdown.

          OUTPUT RULE: Write the markdown document directly. Do NOT write a summary or describe what you created. Start immediately with the # title heading." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/item-product-maintenance-rules-new.md

      - name: Cleanup extra files
        run: |
          # Remove any files created by Claude in root directory
          rm -f invoice*.md sales*.md purchase*.md customer*.md
          echo "Cleaned up extra files"

      - name: Check for changes
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false

          # Check invoicing rules
          INVOICING_FILE="docs/invoice-business-rules.md"
          if [ -f "$INVOICING_FILE" ]; then
            if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in invoice business rules"
              cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new invoice business rules file"
            cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
          fi

          # Check sales order rules
          SALES_FILE="docs/sales-order-business-rules.md"
          if [ -f "$SALES_FILE" ]; then
            if ! diff -q "$SALES_FILE" /tmp/sales-order-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in sales order business rules"
              cp /tmp/sales-order-rules-new.md "$SALES_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new sales order business rules file"
            cp /tmp/sales-order-rules-new.md "$SALES_FILE"
          fi

          # Check customer/AR rules
          CUSTOMER_AR_FILE="docs/customer-ar-business-rules.md"
          if [ -f "$CUSTOMER_AR_FILE" ]; then
            if ! diff -q "$CUSTOMER_AR_FILE" /tmp/customer-ar-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in customer/AR business rules"
              cp /tmp/customer-ar-rules-new.md "$CUSTOMER_AR_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new customer/AR business rules file"
            cp /tmp/customer-ar-rules-new.md "$CUSTOMER_AR_FILE"
          fi

          # Check item/product rules (VV module)
          ITEM_FILE="docs/item-product-business-rules.md"
          if [ -f "$ITEM_FILE" ]; then
            if ! diff -q "$ITEM_FILE" /tmp/item-product-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in item/product business rules"
              cp /tmp/item-product-rules-new.md "$ITEM_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new item/product business rules file"
            cp /tmp/item-product-rules-new.md "$ITEM_FILE"
          fi

          # Check item/product Maintenance rules
          JV_ITEM_FILE="docs/item-product-maintenance-rules.md"
          if [ -f "$JV_ITEM_FILE" ]; then
            if ! diff -q "$JV_ITEM_FILE" /tmp/item-product-maintenance-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in JV item/product business rules"
              cp /tmp/item-product-maintenance-rules-new.md "$JV_ITEM_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new JV item/product business rules file"
            cp /tmp/item-product-maintenance-rules-new.md "$JV_ITEM_FILE"
          fi

          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in any business rules files"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Files Updated
            - `docs/invoice-business-rules.md` - Invoice/billing validation rules
            - `docs/sales-order-business-rules.md` - Sales order validation and processing rules
            - `docs/customer-ar-business-rules.md` - Customer master and accounts receivable rules
            - `docs/item-product-business-rules.md` - Item master, pricing, and inventory control rules (VV module)
            - `docs/jv-item-product-business-rules.md` - JV item/product maintenance rules with NOBB integration


            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated