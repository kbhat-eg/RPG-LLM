name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze invoicing business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG programs FO616R (invoice engine) and FO615R (invoice line processing). Main tables: SOHEPF (Invoice Header) and SODTPF (Invoice Lines).

          Document invoice business rules - the validation logic and calculations that occur during invoice processing, after orders have been selected.

          ## Product and Pricing Rules
          - Product validation during invoice creation
          - Price validation and application
          - Quantity validation on invoice lines

          ## Tax/VAT (MVA) Rules
          - Tax code validation with VMVAPF table
          - Tax rate matching and application
          - Tax base amount calculation (Quantity × Price - Discounts)
          - Tax amount calculation and rounding (Norwegian rules)

          ## Discount Rules
          - Customer discount application from RKUNPF (RERAB1, RERAB2, RERAB3)
          - Discount cascade calculation sequence
          - Product group discount handling
          - Special discounts (bruksrett) validation

          ## Deposit and Prepayment Rules
          - Deposit amount validation from SDEPPFR
          - Deposit deduction from final invoice (SOFORS field)
          - Deposit invoice vs. final invoice type handling

          ## Total Calculation Rules
          - Line totals summation logic
          - Invoice header total calculation (SOFSUM)
          - Rounding difference tolerance (±0.05 øre)
          - Zero-value invoice handling

          ## Payment and KID Rules
          - Payment terms validation and due date calculation
          - KID (Customer ID) number generation via RN012R
          - MOD10/MOD11 checksum algorithms

          ## Configuration and System Rules
          - Accounting period validation (AARRF.ARSTRT)
          - System lock checks via FA730R
          - Invoice number sequence generation

          NOTE: Do NOT include order validation rules (customer exists, order status, order locks, user authorization). Those belong in sales-order-business-rules.md.

          Format as markdown with this structure:
          - Each rule has: Logic, File, Field, Condition sections
          - Group rules by the categories above
          - Include subprogram calls section
          - Include summary of critical blocking conditions

          Use DB2 TABLE.COLUMN notation where identifiable.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable." \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Check for changes
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false

          # Check invoicing rules
          INVOICING_FILE="docs/invoicing-business-rules.md"
          if [ -f "$INVOICING_FILE" ]; then
            if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
              CHANGES_DETECTED=true
              echo "Changes detected in invoicing business rules"
              cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
            fi
          else
            CHANGES_DETECTED=true
            echo "Creating new invoicing business rules file"
            cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
          fi

          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in any business rules files"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Files Updated
            - `docs/invoicing-business-rules.md` - Invoice/billing validation rules

            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated