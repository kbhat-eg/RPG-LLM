name: Analyze Business Rules

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  analyze-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
           - name: Analyze invoicing business rules
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG source files related to INVOICE PROCESSING. Focus on programs FO616R (invoice engine) and FO615R (invoice line processing). Main table: SOHEPF (Invoice Header) and SODTPF (Invoice Lines).

          Extract INVOICE PROCESSING RULES. Document the business logic that occurs DURING invoice calculation and creation, AFTER orders have been selected.

          ## Product and Pricing Rules
          - Product validation during invoice creation
          - Price validation and application
          - Quantity validation on invoice lines

          ## Tax/VAT (MVA) Rules
          - Tax code validation with VMVAPF table
          - Tax rate matching and application
          - Tax base amount calculation (Quantity × Price - Discounts)
          - Tax amount calculation and rounding (Norwegian rules)

          ## Discount Rules
          - Customer discount application from RKUNPF (RERAB1, RERAB2, RERAB3)
          - Discount cascade calculation sequence
          - Product group discount handling
          - Special discounts (bruksrett) validation

          ## Deposit and Prepayment Rules
          - Deposit amount validation from SDEPPFR
          - Deposit deduction from final invoice (SOFORS field)
          - Deposit invoice vs. final invoice type handling

          ## Total Calculation Rules
          - Line totals summation logic
          - Invoice header total calculation (SOFSUM)
          - Rounding difference tolerance (±0.05 øre)
          - Zero-value invoice handling

          ## Payment and KID Rules
          - Payment terms validation and due date calculation
          - KID (Customer ID) number generation via RN012R
          - MOD10/MOD11 checksum algorithms

          ## Configuration and System Rules
          - Accounting period validation (AARRF.ARSTRT)
          - System lock checks via FA730R
          - Invoice number sequence generation

          NOTE: Do NOT include order validation rules (customer exists, order status, order locks, user authorization). Those belong in sales-order-business-rules.md.

          Format as markdown with this structure:
          - Each rule has: Logic, File, Field, Condition sections
          - Group rules by the categories above
          - Include subprogram calls section
          - Include summary of critical blocking conditions
          - Include invoice processing flow diagram

          Use DB2 TABLE.COLUMN notation where identifiable.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Keep DB2 TABLE.COLUMN references but explain validations in words, not SQL code.\" \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/invoicing-rules-new.md

      - name: Analyze sales order business rules
        if: steps.detect-changes.outputs.sales_order_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG source files related to SALES ORDERS. Main table FOHEPF and related tables.

          Extract VALIDATION RULES and BUSINESS LOGIC for DB2 database AI context. Document:

          ## Validation Rules
          - Field validations with DB2 table.column references
          - Data type constraints and allowed values
          - Required fields and null handling

          ## Flow
          - How a salesorder moves through different stages

          ## Blockers (What Stops the Process)
          - Conditions that prevent order creation/processing
          - Credit limit violations
          - Inventory/availability blocks
          - Error conditions that halt processing

          ## Prerequisites
          - What must exist before order can be created
          - Required master data (customers, products, inventory)
          - Status requirements on related records

          ## Status Transitions
          - Valid order status values and transitions
          - What triggers status changes
          - Conditions for order completion

          Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Keep DB2 TABLE.COLUMN references but explain validations in words, not SQL code.\" \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/sales-order-rules-new.md

      - name: Analyze purchase order business rules
        if: steps.detect-changes.outputs.purchase_order_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Analyze RPG source files related to PURCHASE ORDERS. Main table LOHEPF and related tables.

          Extract VALIDATION RULES and BUSINESS LOGIC for DB2 database AI context. Document:

          ## Validation Rules
          - Field validations with DB2 table.column references
          - Data type constraints and allowed values
          - Required fields and null handling

          ## Blockers (What Stops the Process)
          - Conditions that prevent PO creation/processing
          - Vendor/supplier validation failures
          - Budget or approval blocks
          - Error conditions that halt processing

          ## Prerequisites
          - What must exist before PO can be created
          - Required master data (vendors, products, contracts)
          - Approval requirements

          ## Receiving Rules
          - Goods receipt validation rules
          - Quantity matching rules (over/under receipt handling)
          - Quality inspection requirements

          Format as markdown. Use DB2 TABLE.COLUMN notation where identifiable. Include source file references.

          IMPORTANT: Do NOT include SQL queries (SELECT, INSERT, UPDATE, DELETE statements). Instead, use plain English explanations with:
          - 'What is checked' descriptions
          - 'Why this is required' reasoning
          - 'What happens when...' scenarios
          - Real-world examples with actual values
          - Conversational, simple language

          Keep DB2 TABLE.COLUMN references but explain validations in words, not SQL code.\" \
          --model sonnet \
          --dangerously-skip-permissions \
          --output-format text > /tmp/purchase-order-rules-new.md

      - name: Check for changes and copy files
        id: check-changes
        run: |
          mkdir -p docs
          CHANGES_DETECTED=false
          UPDATED_FILES=""

          # Check invoicing rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.invoicing_changed }}" = "true" ]; then
            INVOICING_FILE="docs/invoicing-business-rules.md"
            if [ -f /tmp/invoicing-rules-new.md ]; then
              if [ -f "$INVOICING_FILE" ]; then
                if ! diff -q "$INVOICING_FILE" /tmp/invoicing-rules-new.md > /dev/null 2>&1; then
                  CHANGES_DETECTED=true
                  echo "✓ Changes detected in invoicing business rules"
                  cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
                  UPDATED_FILES="$UPDATED_FILES\n- Invoicing/Billing rules"
                else
                  echo "○ No content changes in invoicing business rules"
                fi
              else
                CHANGES_DETECTED=true
                echo "✓ Creating new invoicing business rules file"
                cp /tmp/invoicing-rules-new.md "$INVOICING_FILE"
                UPDATED_FILES="$UPDATED_FILES\n- Invoicing/Billing rules (new)"
              fi
            fi
          else
            echo "⊘ Skipped invoicing analysis - no RPG changes detected"
          fi

          # Check sales order rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.sales_order_changed }}" = "true" ]; then
            SALES_FILE="docs/sales-order-business-rules.md"
            if [ -f /tmp/sales-order-rules-new.md ]; then
              if [ -f "$SALES_FILE" ]; then
                if ! diff -q "$SALES_FILE" /tmp/sales-order-rules-new.md > /dev/null 2>&1; then
                  CHANGES_DETECTED=true
                  echo "✓ Changes detected in sales order business rules"
                  cp /tmp/sales-order-rules-new.md "$SALES_FILE"
                  UPDATED_FILES="$UPDATED_FILES\n- Sales Order rules"
                else
                  echo "○ No content changes in sales order business rules"
                fi
              else
                CHANGES_DETECTED=true
                echo "✓ Creating new sales order business rules file"
                cp /tmp/sales-order-rules-new.md "$SALES_FILE"
                UPDATED_FILES="$UPDATED_FILES\n- Sales Order rules (new)"
              fi
            fi
          else
            echo "⊘ Skipped sales order analysis - no RPG changes detected"
          fi

          # Check purchase order rules (only if it was analyzed)
          if [ "${{ steps.detect-changes.outputs.purchase_order_changed }}" = "true" ]; then
            PURCHASE_FILE="docs/purchase-order-business-rules.md"
            if [ -f /tmp/purchase-order-rules-new.md ]; then
              if [ -f "$PURCHASE_FILE" ]; then
                if ! diff -q "$PURCHASE_FILE" /tmp/purchase-order-rules-new.md > /dev/null 2>&1; then
                  CHANGES_DETECTED=true
                  echo "✓ Changes detected in purchase order business rules"
                  cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
                  UPDATED_FILES="$UPDATED_FILES\n- Purchase Order rules"
                else
                  echo "○ No content changes in purchase order business rules"
                fi
              else
                CHANGES_DETECTED=true
                echo "✓ Creating new purchase order business rules file"
                cp /tmp/purchase-order-rules-new.md "$PURCHASE_FILE"
                UPDATED_FILES="$UPDATED_FILES\n- Purchase Order rules (new)"
              fi
            fi
          else
            echo "⊘ Skipped purchase order analysis - no RPG changes detected"
          fi

          # Set outputs
          if [ "$CHANGES_DETECTED" = true ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "updated_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$UPDATED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "○ No documentation changes needed"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update business rules documentation"
          branch: docs/business-rules-update
          delete-branch: true
          title: "Update Business Rules Documentation"
          body: |
            ## Automated Business Rules Update

            This PR was automatically generated by Claude Code analysis of the RPG codebase.

            ### Files Updated
            ${{ steps.check-changes.outputs.updated_files }}

            ### Change Detection
            - ✓ Analyzed only modules with RPG program changes
            - ○ Skipped modules without changes
            - ⊘ Optimized for efficiency

            ### What's Documented
            Each file focuses on:
            - **Validation Rules** - Field validations with DB2 table.column references
            - **Blockers** - Conditions that stop the process
            - **Prerequisites** - What must exist before processing
            - **Key calculations/transitions** - Domain-specific logic

            ### Review checklist
            - [ ] Review the extracted business rules for accuracy
            - [ ] Verify DB2 table/column references are correct
            - [ ] Check for any sensitive information that should be redacted
          labels: |
            documentation
            automated
