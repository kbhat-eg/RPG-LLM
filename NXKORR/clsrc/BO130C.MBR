STRPGM:      PGM

/*-------------------------------------------------------------------*/
/* Initiering av parametere                                          */
/*                                                                   */
/* 8.01 090924 bsa Sender mail                                       */
/* 8.02 090425 bsa Må kalle RV015R med to parametere                 */
/* 8.03 100925 bsa Flagger at poster er sendt regnskap. NB Ikke      */
/* 8.03            NX økonomi.                                       */
/* 8.04 221024 bsa Kun hvis kjøring i batc (e-mail)                  */
/* 8.05 091025 ask Ny løsning for valg av økonomisystem             */
/*                                                                   */
/*                                                                   */
/*-------------------------------------------------------------------*/

/*8.01*/     DCL        VAR(&WKOD)     TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&KODE)     TYPE(*DEC)  LEN(2 0)
             DCL        VAR(&ONOF)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&MLD3)     TYPE(*CHAR) LEN(50)
             DCL        VAR(&MLD4)     TYPE(*CHAR) LEN(50)
             DCL        VAR(&SVAR)     TYPE(*CHAR) LEN(1)
             DCL        VAR(&IN12)     TYPE(*DEC)  LEN(1 0)
             DCL        VAR(&TOMT)     TYPE(*CHAR) LEN(1)
             DCL        VAR(&PARM)     TYPE(*CHAR) LEN(1) VALUE('2')

             DCL        VAR(&VALG)     TYPE(*DEC)  LEN(2 0) VALUE(0)
             DCL        VAR(&NXDR)     TYPE(*DEC)  LEN(1 0) VALUE(0)
             dcl        var(&batch)    type(*char) len(1)
             dcl        var(&msg)      type(*char) len(100)
             dcl        var(&mj)       type(*char) len(3)
             dcl        var(&mi)       type(*dec)  len(3 0) value(0)
             dcl        var(&okkode)   type(*char) len(2)
             dcl        var(&oktext)   type(*char) len(30)

             DCL        VAR(&MLD1)     TYPE(*CHAR) LEN(50) +
                          VALUE('Ingen poster for overføring +
                          ble funnet')

/*  Kjøres jobben i batch                                             */

             rtvjoba    type(&batch)
             if         cond(&batch *eq '0') then(do)
               chgvar   var(&msg)   value('Dagsoppgjør,  Oppdatering av +
                                           Økonomi starter')
               CallSubr subr(melding)
             enddo


/* Kontrollere skjerm/kasse/bruker -tilgang                          */

             if         cond(&batch *eq '1') then(do)
               CALL       PGM(BOSJKR) PARM(&PARM)

               IF         COND(&PARM *EQ '9') THEN(DO)
/*8.01*/       chgvar     var(&wkod) value(9)
/*8.01*/       call       pgm(bo132r)  parm(&wkod)
               GOTO       CMDLBL(ENDPGM)
               ENDDO

/* Kjøres oppdatering av regnskap allerede ?                         */

               CHGVAR     VAR(&KODE)     VALUE(04)
               CHGVAR     VAR(&ONOF)     VALUE(0)
               CALL       PGM(FA730R)    PARM(&KODE &ONOF)

/* Sjekk om jobben skal avbrytes                                     */

               IF         COND(&ONOF *EQ 1) THEN(DO)
/*8.01*/       chgvar     var(&wkod) value(&onof)
/*8.01*/       call       pgm(bo132r)  parm(&wkod)
               GOTO       CMDLBL(ENDPGM)
               ENDDO

             enddo

/* Finnes det poster ?, hvis ikke, avslutt                           */

             CALL       PGM(BO795C)    PARM(&TOMT)
             IF         COND(&TOMT *EQ 'J') THEN(DO)
               if       cond(&batch *eq '1') then(do)
                 CALL       PGM(AA005R)    PARM(&MLD1)
                 enddo
               else do
                 chgvar var(&msg)  value('Dagsoppgjør,  Ingen poster +
                                          til oppdatering regnskap')
                 CallSubr subr(melding)
/*8.01*/       chgvar     var(&wkod) value(2)
/*8.01*/       call       pgm(bo132r)  parm(&wkod)
               enddo
               GOTO       CMDLBL(ENDPGM)
             ENDDO

/* Varselbilde med bekreftelse på om jobb skal settes i gang         */

             if       cond(&batch *eq '1') then(do)
               CHGVAR     VAR(&MLD3) +
                          VALUE('Overføring til regnskap settes igang ')
               CHGVAR     VAR(&MLD4) +
                          VALUE('Bekreft at dette ønskes ! ')
               CALL       PGM(AA007R)    PARM(&MLD3 &MLD4 &SVAR &IN12)

               IF         COND(&IN12 *EQ 1 ) +
                            THEN(GOTO CMDLBL(ENDPGM))

               IF         COND(&SVAR *EQ 'J') +
                            THEN(GOTO CMDLBL(VIDERE))
               ELSE       CMD(GOTO CMDLBL(ENDPGM))
             enddo

/* Oppdater jobb-register med aktiv-flagg                            */

VIDERE:      CHGVAR     VAR(&KODE)     VALUE(04)
             CHGVAR     VAR(&ONOF)     VALUE(1)
             CALL       PGM(FA720R)    PARM(&KODE &ONOF)

             CALL       PGM(RF1TRANS)  PARM('SHOP')

/* Sjekker om Nexstep økonomi skal oppdateres                        */

/*8.05       CALL       PGM(RV015R)  PARM(&VALG &NXDR)      */
/*8.05*/     CALL       pgm(ROM01R)  parm(&valg)
/*8.05*/     CALL       PGM(RV015R)  PARM(&NXDR)

             if         cond(&valg *ne 0 *and +
                             &batch *eq '0') then(do)
               chgvar   var(&okkode) value(&valg)
               call     pgm(bo131r)  parm(&okkode &oktext)
               chgvar   var(&msg)  value('Dagsoppgjør,  Posteringer er +
                                          lagt ut til ' *cat &oktext)
               CallSubr subr(melding)
             enddo

/*8.03*/     IF         COND(&NXDR *NE 0) THEN(DO)
/*8.03*/       chgvar     var(&wkod) value(98)
/*8.03*/       call       pgm(bo132r)  parm(&wkod)
/*8.03*/     ENDDO

             IF         COND(&NXDR *EQ 0) THEN(DO)
             CALL       PGM(RF1JOURN)  PARM('SHOP')
               chgvar   var(&msg)  value('Dagsoppgjør,  Posteringer er +
                                          Oppdatert i Nexstep')
               CallSubr subr(melding)
/*8.04*/       if         cond(&batch *eq '0') then(do)
/*8.01*/       chgvar     var(&wkod) value(99)
/*8.01*/       call       pgm(bo132r)  parm(&wkod)
/*8.04*/       enddo
             ENDDO

/* Oppdater jobb-register med jobb-ferdig-flagg                      */

             CHGVAR     VAR(&KODE)     VALUE(04)
             CHGVAR     VAR(&ONOF)     VALUE(0)
             CALL       PGM(FA720R)    PARM(&KODE &ONOF)

/* ______________________________________________________________________*/
Subr         Subr(Melding)
             chgvar     var(&mi)              value(&mi + 1)
             chgvar     var(&mj)              value(&mi)
             call       pgm(egd97c) parm+
                        ('Dagsoppgj.' +
                         'BO130C    ' +
                         &mj +
                         &msg)
EndSubr

/* Avslutt program                                                   */
ENDPGM:      ENDPGM
