      /TITLE  Utskrift av Faktura
     h decedit('0.') datedit(*dmy.) option(*nodebugio)
pdf  h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
pdf   /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Program . . . . : FO946R
      * Beskrivelse . . : Utskrift av Faktura (Byggmester-faktura)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      * R3.10 010200 AMD  Skille mellom år var ikke lagt på plass
3.12  * R3.12 310800 AMD  Lagt inn mulighet for utprint av avdelingsnavn
3.12  *                   i stedet for firmanavn dersom ønskelig
3.13  * R3.13 110900 AMD  Dersom vare er hentet fra LVR settes det inn
3.13  *                   2 desimaler som standard (finnes jo ikke i EVR)
3.31  * R3.31 181200 AMD  Lagt inn betalingsmåte og antall kopier for å
3.31  *                   kunne benytte dette i Optra forms
3.32  * R3.31 040101 AMD  Dato for mva er endret fra ordre- til fakturadato.
3.33  * R3.33 280301 AMD  Lagt inn mulighet for å styre om rabatter skal
      *                   vises med prosent, eller som bare et nettobeløp.
3.34  * R3.34 080601 AMD  Differensiert moms, 24 og 12 %
3.35  * R3.35 150801 AMD  Differensiert moms, 24 og 12 % (Byggmesterløsn.)
3.36  * R3.36 170602 AMD  Lagt inn ny logikk for håndtering av printer-
      *                   styringen via INFDS.  Variabler for linjetelling
      *                   w_tell og w_test er fjernet
5.04  * R5.04 161002 AMD  Kiddnummer hentes nå fra hist fakt reg.
5.04  *                   Rutineregister styrer om kort eller lang kidd
5.22  * R5.22 010903 AMD  Skriver tekstlinje 2, dersom utfyllt
5.22  *                   + lagt inn utskrift av leveringstype
5.22  *                   + lagt inn skråstrek mellom telefon / telefax
5.31  * R5.31 140205 GRO  Ikke skriv ut fakt. av typen eFaktura o.l.
5.45  * R5.45 300605 AMD  Lagt inn dummy-parameter for å hindre
5.45  *                   forurensning av parameter-lister
5.46  * R5.46 010905 AMD  Korrigering av leveringsmåtetekst som ble
5.46  *                   dratt med fra første ordre til de etterfølgende
5.47  * R5.47 150306 AMD  Utskrift av leveringsbetingelse dersom utfylt
5.48  * R5.48 150306 AMD  Fjernet Regns. prosjekt og lagt inn lev.dato
5.49  * R5.49 040107 BOF  Styrer slik at kopi kommer ut hvis e-faktura
5.60  * R5.60 040408 AMD  Lagt inn utskrift av eksternt prosjektnummer
5.60  *                   + utprint av IBAN og SWIFT fra firmaregister
5.62  * R5.62 230508 AMD  Lagt inn løsning for depositum
6.10  * R6.10 070909 BSA  Utskriften endret pga utvidelse av referansefelter.
6.11  * R6.11 140909 AMD  Endring for å løse problemet dersom siste
      *                   ordre ikke har noen varelinjer (Fakt.sum=0)
6.12  * R6.12 180909 AMD  Lagt inn spesifisering av flere mva-satser
6.13  * R6.13 251009 AMD  Samme som 6.12 men gjelder Byggm. fakturaen
6.14  * R6.14 100310 AMD  Linjejustering for å slippe endr. i Interform
6.14  *                   (Bare i printfilen)
6.15  * R6.15 160310 AMD  Mvagrunnlag akkumulerte seg på faktura
pdf   * R5.60 260410 bsa  Lagt inn funksjonalitet for eksport til XML
pdf   *                   format for videre arkivering og utskrift.
6.16  * R6.10 270910 bsa  Tillegg av faste tagger. Display tag + ordrenummer
6.16  *                   hvis den finnes.
6.17  * R6.10 300910 bsa  Hvis konvtertering av spesialtegn, legges til flere tegn
6.17  *                   som kan gjøre at noen av disse faller utenfor pga av felt-
6.17  *                   lengde.
6.18  * R6.10 071010 bsa  Legger inn test om gyldig utkø. Hvis ikke, legger vi ikke
6.18  *                   ut "printer kommand" tagger.
6.19  * R6.10 211010 bsa  Kaller eget program for scann av tegn til xml.
6.20  * R6.10 221010 bsa  Hånterer materialliste.
6.21  * R6.10 051110 bsa  Bruksrettsrabatt for Eidsvoll, xml håndtering
6.22  * R6.10 181110 bsa  Sikrer at jobbnummer finnes.
6.23  * R6.10 191110 bsa  Sikrer nullstilling av variabler for å unngå at verdier
6.23  *                   "henger" igjen.
6.24  * R6.10 241110 bsa  Håndtering av linjeskift i e-mail utsendelse
9.01  *  9.01 051110 Amd  Bruksrettsrabatt for Eidsvoll
6.25  * R6.10 091210 bsa  Legger ut innhenting av FIFO folder for håndtering
6.25  *                   av xml'er i rekkefølge.
6.26  * R6.10 040111 bsa  Slå sammen tekstlinje 1 og 2 på samme linje
6.27  * R6.10 210111 bsa  Kaller eget program for scann av tegn til xml.
6.28  * R6.10 150211 bsa  Håndtering av ekstra papirkopier skjer forskjellig når
6.28  *                   kunden ikke har arkiv og interform.
6.29  * R6.10 030311 bsa  Feil rundt girohåndtering.
6.30  * R6.10 070311 bsa  Feil syklus ved håndtering av ordre
6.31  * R6.10 160311 bsa  Ved valg av *ARKIV som skriver skal den kun arkiveres
6.32  * R6.10 240311 bsa  Hvis kunden kjører med nettopriser, skal rabattprosenten
6.32  *                   fjernes.
6.33  * R6.10 030511 bsa  Manglende slutt tagg for bunntekst.
6.34  * R6.10 050511 bsa  Kiddnummer skal ikke ut på kreditnota.
6.35  * R6.10 110511 bsa  Legger ut rapporttekst og metatagg
6.36  * R6.10 120511 bsa  Problemer med initiering av e-mail parametre
6.37  * R6.10 120511 bsa  Displaytag må skille på fakt/kred.
6.38  * R6.38 230511 NHO  Mobil nr skal legges ut dersom 1 i felt
      *                   FAAMSA i fil FSTSPF
6.39  * R6.20 260511 bsa  Hvis e-print/e-mail skal det kun lages
6.39  *                   xml. Det skal ikke skrives ut noe.
6.40  * R6.20 260511 bsa  Henter inn nummer for bruk i xml fila.
6.41  * R6.20 290611 bsa  Reversert endring 6.34. Styres av rutinereg.
6.42  * R6.20 100811 bsa  Legger ut tagg for kundekopi
6.43  * R6.20 260811 bsa  Legger ut tagg for bruttopris materialliste
6.44  * R6.20 130212 bsa  Windows håndtering av skuffnavn.
6.1A  * R6.20 021111 bsa  Sjekksiffer til fakturaen får egen tagg.
6.1B  * R6.20 071211 bsa  Scanner flere felt for spesialtegn
6.1C  * R6.20 190112 bsa  Topp/bunn tekst er for kort ved konv av spesialtegn
6.1D  * R6.20 200112 bsa  Legger ut leveringsmåte
6.1E  * R6.10 260112 bsa  Flere strenger som må scannes
6.1F  * R6.10 170212 bsa  Legge ut leveringstype og ikke linjetype på linja
6.1G  * R6.10 210212 bsa  Slår sammen tekstlinjer til ei linje ved topp/bunntekst
6.1H  * R6.20 280312 bsa  Håndetring av "space" mellom tekst 1 og 2 ved tekstlinjer
6.2A  * R6.20 290512 bsa  Feil nummer sendes inn i e-post program
6.2B  * R6.20 030712 bsa  Strukturendring av og nye xml tagger
6.2C  * R6.20 260912 bsa  Lagt til øreavrundingstagg. I utgpkt spes for
6.2C  *                   Skattum, men følger standard for å opprettholde
6.2C  *                   lik XML mal.
6.2D  * R6.20 171012 bsa  Finner giroskuff
6.2E  * R6.20 141112 bsa  Manglende slutt tagg for bunntekst, ved bruksrettsrabatt
6.2F  * R6.20 231112 bsa  Manglende nullstilling av eksternt posjektnummer
6.2G  * R6.10 180113 bsa  Hvis kun topptekst må vi huske å lukke xml taggen riktig
6.45  * R6.10 070213 nho  Mulighet til kort kid,faktnr + kontrollsiffer
6.2H  * R6.20 041212 bsa  Legger ut nytt unikt refno, utvidet metatagger
6.2I  * R6.20 040113 bsa  Endrer logikken for oppbygging av refno
6.2J  * R6.20 030613 bsa  Endrer logikken for utlegg av bunntekst og avgifter.
6.2K  * R6.20 100613 bsa  Blanker ut topptekstlinjer, slik at det ikke skal legges
6.2K  *                   ut linjer fra tidligere fakturaer. Skjer hvis det skal
6.2K  *                   skrives ut blanke linjer.
6.2L  * R6.20 040913 bsa  Endrer betingelsen for å lage mva oversikt
6.2M  * R6.20 240913 bsa  Bruker fakturaår som refnr.
6.2N  * R6.20 201113 bsa  Scanner lev.varenr etter ugyldige tegn
6.2O  * R6.20 260914 bsa  Legger dokumenttypen i klartekst i taggen
6.2Q  * R6.20 181114 bsa  Skal ikke legge ut tagg for "lastpagedrawer" hvis det ikke
6.2Q  *                   skal lages giro, eller det er en kreditnota.
6.2R  * R6.20 140415 bsa  0 stiller minne for gjenbruk av XML info
6.2S  * R6.20 130515 bsa  Skiller dokumenttyper pga fakturakopi for de som ikke
6.2S  *                   har arkiv eller interform.
6.2t  * R6.20 020615 bsa  Scanner eksternt prosjekt for ugyldige tegn
6.nu  * R6.30 030614 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.3a  * R6.30 120914 bsa  Utvidet parameterliste til FO798R. Håndtering av
6.3a  *                   flere mailfelter.
6.3b  * R6.30 031114 bsa  Bruker feil tagg
6.3c  * 6.30  051214 Bsa  Utvidet parameterliste til FÅ707R
6.3d  * R6.30 020414 bsa  Skriver til datakø for å trigge java sniffer
6.3e  * 6.30  040915 bsa  Legger ut avdeling som tagg for arkiveringsformål.
6.3f  * 6.30  230915 bsa  Bruker egen datakø for unik eksekvering av faktura
6.3g  * 6.30  170616 bsa  Trekker ut depositum fra avrunding. Hvis ikke blir
6.3g  *                   beløpet her feil.
6.3h  * 6.30  241016 bsa  Flyttet sekvens for leveringsmåte
6.3i  * 6.30  100117 bsa  Litt tilfeldig hvilken fakturadato som brukes for
6.3i  *                   å bygge opp referansenummer på arkivering.
6.3j  * 6.30  210217 bsa  Hvis rutine er kopi eller butikk, legges xml
6.3j  *                   i hurtigkøa.
6.3k  * 6.30  070618 bsa  Hvis rutine er kopi eller butikk, skriv også til riktig
6.3k  *                   datakø.
6.3l  * 6.30  161018 bof  Utvidet med trelast sortiment
6.3m  * 6.30  290519 bsa  Endret litt på beregning av nettopris
7.01  * 7.00  130619 bkv  Lagt til FTP kommand for overføring til factoring
      *                   NB Legger ikke ut printkommand hvsi det ikke er
      *                   kopiutskrift. NB Da skrives ikke fakturaen med FTP info.
      *                   Legger ut organisasjonsnummer
      *                   Legger kun ut FTP info hvis fakturatype er <> 0.
7.02  * 7.00  130619 bkv  Justerer måten å finne mailadresse på - ref FO181R
7.03  * 6.30  091019 bsa  Bruker spesial KID pga VISMA
7.04  * 6.30  091019 bsa  Legger ut leveringsadresse i eksternt prosjektnummer
7.05  * 6.30  270120 bkv  Utvider antallsfelt pga overflow. Endring kun i printerfile.
7.06  * 7.00  270120 BKV  Lagt inn utskrift av leveringstype
7.07  * 7.00  270120 BKV  Leveringstype legges ut på xml for test av
      *                   logo i iReport.
7.08  * 7.00  271020 bkv  Eiker ønsker sperre for utprint av F11-linjer
7.07  * 7.00  270120 BKV  Leveringstype legges ut på xml for test av
      *                   logo i iReport.
7.08  * 7.00  280120 bkv  Sperre for utprint av F11-linjer. Eiker
7.09  * 7.00  280120 bkv  Fjernet sofaty test i FTP kode
7.0a  * 7.00  060220 bkv  Lagt inn sofaty test som switch
7.10  * K000  090620 bsa  Scanner enda flere strenger.
7.11  * K000  230620 bsa  Feil i utlegg av deres ref.
7.12  * K000  290620 bof  Utvidet arbeidsfelt adressefelt
7.13  * K000  171220 bsa  Utvidet sjekk mot bruken av tilleggsparametre
7.13  * K000              ved overføring av fakturaer til FTP. Valg satt til
7.13  * K000              2 betyr både print og FTP på ordrer uten fakturatype.
7.14  * K000  260221 bsa  Justert sjekk på utskrift.
      *
7.fb  * K000  260121 bsa  Forskuddsbetaling.
7.f1  * K000  240321 bsa  Henter egen mal hvis det er forskuddsbetaling
      *
8.02  * K000  180122 bsa  Feil utlegg hvis både depositum og almrab.
8.03  * 800   270422 ask  Henter "Partnercellphone" fra kunderegister.
8.04  * 800   230222 ask  Switchstyrt - factoring via iizy,             8.08
8.04  *                   legger inn info avhengig av factoringselskap. 8.08
8.05  * 800   080223 ask  Utvidet felter for brukerid/passord for FTP
8.06  * 800   020323 bsa  Henter e-post fra kunde uansett. Flytter IF.
8.07  * 800   010623 bsa  Legger ut e-post uansett, uavhengig av switch
8.07  * 800               702. Da hentes e-post adressen fra kunde.
8.08  *800    201123 ask  Lagt på sjekk på ordretype og kunde ved factoring
      *                   OBS! Noe logikk er flyttet ut av "xstrsr" subrutinen til "sjk_fact"
      *                   Endringer tidliger merket med 8.04 er nå remerket med 8.08
8.09  * 800   241024 bsa  Ved samlefakrutering av flere ordretyper, skal det ikke sjekke
8.09  * 800               på ordretyper i programmet. Vi aksepterer alle.
8.10  * 800   141124 bsa  Må hente informasjon om ordretype for hver nye faktura, hvis
8.10  * 800               ny samlefakturering.
8.11  * 800   130225 bsa  Skriver inn til tabell for bruk ved søking i arkiv.
8.12  *K0000  250325 bsa  Sjekker ikke om topptekst er utfylt.
8.13  * 800   030725 ask  Endret test på "Kunde utelatt fra factoring*"

      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     fvpkol1    if   e           k disk    rename(vpkopfr:vpkol1r)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
6.11 fsohelr    if   e           k disk    rename(sohepfr:sohelrr)
     fsodtl1    if   e           k disk    rename(sodtpfr:sodtl1r)
6.11 fsodtlr    if   e           k disk    rename(sodtpfr:sodtlrr)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
5.60 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
5.31 ffnufl1    if   e           k disk    rename(fnufpfr:fnufl1r)
5.31 ffmftl1    if   e           k disk    rename(fmftpfr:fmftl1r)
6.38 fra09l1    if   e           k disk    rename(ra09pfr:ra09l1r)
6.2B fra07pf    if   e           k disk
7.fb fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
3.36 ffo946p    o    e             printer infds(d_infds)
      *
6.12  *
6.12  * Definering av array's
6.12  *
6.12 d mko             s              1    dim(9)
6.12 d msa             s              5  2 dim(9)
6.12 d mgr             s             11  2 dim(9)
6.12 d mbe             s             11  2 dim(9)
6.12 d mog             s             11  2 dim(9)
6.12 d mor             s             11  2 dim(9)
6.13 d ngr             s             11  2 dim(9)
6.13 d nbe             s             11  2 dim(9)
      *
      * Modulus 10 utregninger.
      *
     d a10             s              1    dim(24)
     d m10             s              1  0 dim(24)
     d u10             s              1  0 dim(12)
      *
      * Datastruktur parameter-inn
      *
     d                 ds
6.nu d d_parm                        34
     d  d_aarr                        4  0 overlay(d_parm)
     d  d_otyp                        2    overlay(d_parm:5)
6.nu d  d_ffnr                        8  0 overlay(d_parm:7)
6.nu d  d_tfnr                        8  0 overlay(d_parm:15)
6.nu d  d_prog                       10    overlay(d_parm:23)
6.nu d  d_kopi                        1    overlay(d_parm:33)
6.nu d  d_dumy                        1    overlay(d_parm:34)
3.36  *
3.36  * Informasjon fra printer-file
3.36  *
3.36 d d_infds         ds
3.36 d  d_linnbr             367    368B 0
3.36 d  d_pagnbr             369    372B 0
      *
      * Definering av local data area
      *
     d                uds
pdf  d l_poff                584    584
6.31 d l_utqm                585    594
pdf  d l_bach                595    635
pdf  d l_arch                636    636  0
pdf  d l_skje                637    637  0
pdf  d l_land                638    638  0
pdf  d l_exlp                639    639  0
pdf  d l_mail                640    640  0
6.28 d l_kopi                641    641
pdf  d l_ruti                800    809
pdf  d l_outq                810    819
pdf  d l_akop                838    843  0
     d d_alin                856    858  0
pdf  d l_bgir                881    881  0
     d d_kidk                883    883  0
     d d_ocrk                885    885  0
6.2H d l_wsid                901    910
pdf  d l_user                911    920
pdf  d l_filg                931    933
pdf  d l_firm                944    946  0
6.3e d  l_avde               947    950  0
      *
      * Definering av parametere
      *
6.nu d p_parm          s             34
pdf  d p_mail          s              1
pdf  d p_kund          s              6  0
pdf  d p_kpro          s              6  0
6.nu d p_numm          s              8  0
6.3a d p_suff          s                   like(sosuff)
pdf  d p_selg          s              4  0
pdf  d p_serv          s             35
pdf  d p_stat          s              1
pdf  d p_kule          s              1
pdf  d p_navn          s             30
pdf  d p_emal          s             50
pdf  d p_ema2          s             50
6.3a d p_ema3          s             50
6.3a d p_kopi          s             50
pdf  d p_emne          s             50
pdf  d p_txt1          s             50
pdf  d p_txt2          s             50
pdf  d p_txt3          s             50
pdf  d p_txt4          s             50
pdf  d p_pers          s             50
pdf  d p_inif          s             40
pdf  d p_in03          s              1
6.18 d p_ok            s              1
6.19 d p_lr            s              1
6.19 d p_str_in        s            512
6.19 d p_str_out       s            512
6.2B d p_firm          s                   like(sofirm)
6.2B d p_ldor          s                   like(vvldor)
6.2B d p_vare          s                   like(vvvare)
6.2B d p_enhe          s                   like(vvenhe)
6.2B d p_gtin          s             14  0
6.3d d p_filg          s             10
6.3d d p_xmlf          s            256

      * Definering av variable i nøkler
6.38 d ra09l1_ikod     s                   like(raikod)
6.2B d ra07pf_avde     s                   like(ragkod)
      *
     d w_firm          s                   like(sofirm)
     d sohel1_aarr     s                   like(soaarr)
     d sohel1_binr     s                   like(sobinr)
     d sohel1_numm     s                   like(sonumm)
     d sohel1_suff     s                   like(sosuff)
6.11 d sohelr_aarr     s                   like(soaarr)
6.11 d sohelr_binr     s                   like(sobinr)
6.11 d sohelr_numm     s                   like(sonumm)
6.11 d sohelr_suff     s                   like(sosuff)
     d sodtl1_aarr     s                   like(sdaarr)
     d sodtl1_binr     s                   like(sdbinr)
     d sodtl1_numm     s                   like(sdnumm)
     d sodtl1_suff     s                   like(sdsuff)
     d sodtl1_ktxt     s                   like(sdktxt)
     d sodtl1_line     s                   like(sdline)
6.11 d sodtlr_aarr     s                   like(sdaarr)
6.11 d sodtlr_binr     s                   like(sdbinr)
6.11 d sodtlr_numm     s                   like(sdnumm)
6.11 d sodtlr_suff     s                   like(sdsuff)
     d rkunl1_kund     s                   like(sokund)
5.60 d fkprl1_kund     s                   like(flkund)
5.60 d fkprl1_kpro     s                   like(flkpro)
     d votyl1_otyp     s                   like(vaotyp)
     d vltyl1_ltyp     s                   like(sdltyp)
     d vpkol1_pkod     s                   like(vapkod)
     d vvarl1_vare     s                   like(vvvare)
5.31 d fnufl1_aarr     s                   like(fnuaar)
5.31 d fnufl1_binr     s                   like(fnubin)
5.31 d fmftl1_faty     s                   like(fmtfat)
     d aforl1_ruti     s             10
7.fb d sdepl1_numm     s                   like(sknumm)
7.fb d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
      *
      * Definering av variable
      *
3.12 d w_prfi          s              1  0
3.12 d w_ffir          s              3  0
3.12 d w_avde          s              4  0
3.12 d w_fnav          s             30
3.12 d w_fad1          s             30
3.12 d w_fad2          s             30
3.12 d w_fste          s             30
3.12 d w_fftx          s             30
3.12 d w_tfax          s              8
3.12 d w_ftlf          s             11
3.12 d w_ffax          s             11
     d w_csts          s              1
     d w_ctx2          s             20
     d w_tell          s              4  0
     d w_krab          s              4  2
     d w_mvaf          s             10  9
3.34 d w_mv2f          s             10  9
     d w_mvas          s              6  2
3.34 d w_mv2s          s              6  2
     d w_mvat          s              5  4
3.34 d w_mv2t          s              5  4
     d w_mvax          s             30
     d w_qmva          s              1
     d w_retk          s              1
     d w_txt2          s             20
5.47 d w_rtx1          s             25
5.47 d w_rtx2          s             25
5.47 d w_rtx3          s             25
     d w_ffda          s               d   datfmt(*iso)
     d w_binr          s                   like(sobinr)
     d w_totb          s                   like(sorkop)
     d w_kund          s                   like(faakun)
8.08 d w_fack          s              1  0
5.31 d b_nopr          s              1    inz(*off)
8.08 d b_ftp           s              1    inz(*off)
8.08 d b_fact          s              1    inz(*off)
8.09 d b_saml          s              1    inz(*off)
      *
     d w1rab1          s                   like(sdsapr)
     d fa10            s              1  0
     d fcycle          s              1  0
     d kidd10          s             24
     d ksif10          s              1  0
     d modr10          s              1  0
     d mods10          s              3  0
     d n               s              2  0
     d xx              s              2  0
     d yy              s              2  0
6.45 d w_kidd          s             24
6.45 d w_kid2          s             24
6.nu d*w_kidr          s              6  0
6.nu d w_kidr          s              8  0
3.34 d w_mvag          s                   like(sosalp)
6.12 d m               s              2  0
6.12  *
6.12 d w_stat          s              1
6.12 d w_mvak          s              1
6.12 d w_mvtx          s             30
6.12 d w_bpro          s              5  2
6.12 d w_orab          s             13  2
6.3c d w_mail          s             50
6.3c d w_weba          s             50
7.10 d w_lmt1          s             50
6.12  *
9.01  *
9.01 d d1bgr1          s                   like(sosalp)
9.01 d d1bgr2          s                   like(sosalp)
9.01 d d1brb1          s                   like(sosalp)
9.01 d d1brb2          s                   like(sosalp)
9.01 d d3bgr2          s                   like(sosalp)
9.01 d d3brb2          s                   like(sosalp)
9.01 d t1bgr1          s                   like(sosalp)
9.01 d t1bgr2          s                   like(sosalp)
9.01 d t1brb1          s                   like(sosalp)
9.01 d t1brb2          s                   like(sosalp)
pdf  d b_pdfp          s              1    inz(*off)
pdf  d b_pdfp_first    s              1    inz(*off)
pdf  d b_topt          s              1    inz(*off)
pdf  d b_bott          s              1    inz(*off)
pdf  d b_ordr          s              1    inz(*off)
6.39 d b_faty          s              1    inz(*off)
6.3k d b_dtaq2         s              1    inz(*off)
pdf  d x_numm          s             15
pdf  d x_vref          s             25
pdf  d x_betb          s             42
pdf  d w_bdat          s               d   datfmt(*iso)
pdf  d w_date          s               d   datfmt(*iso)
6.3i d w_fkda          s               d   datfmt(*iso)
pdf  d w_kode          s              1
pdf  d w_fell          s              6
pdf  d w_type          s              2
pdf  d w_fast          s             10
pdf  d w_ruti          s             10
6.nu d w_numm          s              8  0
pdf  d w_pdf           s              1  0
pdf  d w_jnav          s             15
pdf  d w_jkey          s             41
pdf  d w_jtxt          s             35
pdf  d w_pdf_ds        s            512
pdf  d w_mtxt          s            300
pdf  d w_jstat         s              2  0
pdf  d w_jtext         s            200
pdf  d w_mark          s              5
pdf  d w_spol          s              5
pdf  d w_land          s              9
pdf  d w_copy          s             15
6.2S d w_copy2         s             15
pdf  d w_time          s              6  0
pdf  d w_str_in        s            512
pdf  d w_str_out       s            512
pdf  d w_x             s              3  0
pdf  d w_bgir          s              5
pdf  d w_path          s            256
pdf  d w_bach          s                   like(l_bach)
6.44 d w_draw1         s             25
6.44 d w_draw2         s             25
6.2D d w_giro          s             25
6.2D d w_skuf          s             25
6.16 d w_dspl          s            250
6.19 d w_tek1          s            512
6.19 d w_tek2          s            512
6.26 d w_tek0          s            512
6.27 d w_1dref         s            512
6.27 d w_1vref         s            512
6.17 d w_1fnav         s             50
6.17 d w_1fad1         s             50
6.17 d w_1fad2         s             50
6.17 d w_1navn         s             50
6.17 d w_1gate         s             50
6.17 d w_1adr2         s             50
6.17 d w_2navn         s             50
7.12 d w_2adr1         s            100
7.12 d w_2adr2         s            100
6.1b d w_2sted         s             50
6.27 d w_rekv          s             50
6.27 d w_ptxt1         s             75
6.27 d w_ptxt2         s             75
6.27 d w_ptxt3         s             75
6.27 d w_ptxt4         s             75
6.27 d w_ppers         s             75
6.27 d w_pemne         s             75
6.34 d w_kkid          s             21
6.2D d w_dtray         s             10
6.2D d w_gtray         s             10
6.1C d w_ttxt          s            200
6.1D d w_lmtx          s             50
6.1G d w_ttx1          s            100
6.1G d w_ttx2          s            100
6.38 d w_selgn         s             16
6.2B d w_lbtx          s             50
6.2B d w_ddeno         s                   like(ragkod)
6.2B d w_dnavn         s             50
6.2B d w_dadr1         s             50
6.2B d w_dadr2         s             50
6.2B d w_dpcde         s                   like(ragpnr)
6.2B d w_dpstd         s             50
6.2B d w_dphon         s                   like(ragtlf)
6.2B d w_dfaxn         s                   like(ragfax)
6.2B d w_ldat          s              6  0
6.2B d w_lddt          s              6  0
6.2B d w_gtin          s             14  0
6.2c d w_avrd          s             11  2
6.2H d w_refn          s             50
6.2N d w_lvar          s             50
7.04 d w_epro          s            150
6.3l d w_nobb          s                   like(vvnobb)
6.3l d w_lv_nobb       s                   like(vvnobb)
6.3l d w_lv_modn       s                   like(vvnmod)
6.3l d w_lv_lldo       s                   like(vvldor)
6.3l d w_lv_llva       s                   like(vvlvar)
6.3l d w_lv_vtyp       s                   like(vvvtyp)
6.3l d w_lv_udat       s                   like(vvedat)
6.3l d w_lv_ldor       s                   like(vvldor)
6.3l d b_inlr          s              1    inz(*off)
7.f1 d w_jmal          s            256
7.01 d w_host          s             50
7.01 d w_usr           s             50
7.01 d w_pwd           s             50
7.01 d w_fldr          s             50
7.01 d w_pos           s              2  0
7.01 d w_fname         s             25
7.02 d w_emal          s             50
7.02 d w_maip          s             50
7.02 d w_krol          s             20
7.04 d x_epro          s            100
7.0a d w_faty          s              1
8.11 d w_year          s              4  0
8.11 d w_stmp          s               z
      *
6.38  *
6.38 d                 ds
6.38 d x_mobi                        12
6.38 d  d_tegn                        1    overlay(x_mobi:1)
6.38 d  d_mobn                       11    overlay(x_mobi:2)
pdf   *
pdf  d XML_Output      s            256a   Varying
pdf  d XML_path        s            256a   Varying
pdf  d                                     Inz('/home/asp/print/adb')
7.f1 d jasper_mal      s            256a   Varying
pdf  d jasper_logo     s            256a   Varying
pdf  d tmpdate         s               D
pdf  d tmptime         s               T
6.24 d crlf            c                   const(X'0d25')
pdf   *
pdf  d d_pdf_ds        ds
pdf  d  d_xmlm                       75
pdf  d  d_jasm                       75
pdf  d  d_logo                       75
pdf  d  d_path                      100
pdf  d  d_emal                       50
6.25 d  d_fifo                       75
6.28 d  d_fkop                        1
6.3d d  d_dtaq                        1
6.3d d  d_sign                        1
8.08 d w_fsel          s             10
8.08 d w_fbkk          s             11  0
8.08 d w_fftp          s             50
8.05 d w_fusr          s             50
8.05 d w_fpwd          s             50
8.08 d w_fiba          s             30
8.08 d w_fswi          s             30
8.08 d w_fspl          s              1
8.08 d w_ponr          s              4
8.08 d w_pste          s             25
8.08 d w_oty1          s              2
8.08 d w_oty2          s              2
8.08 d w_oty3          s              2
8.08 d w_oty4          s              2
8.08 d w_oty5          s              2
8.10 d w_otyp          s              2
      *
pdf   /copy prototypeb
pdf   /copy usec
      * Eksternt program
7.00   dcl-s co402_verdi1  char(1);
7.00   dcl-s co402_verdi2  char(2048);
7.00   DCL-PR CO402R EXTPGM('CO402R');
7.00     p_filgrp            char(3)     const;
7.00     p_firm              packed(3:0) const;
7.00     p_lager             packed(2:0) const;
7.00     p_nokkel            char(50)    const;
7.00     p_verdi1            char(1);
7.00     p_verdi2            char(2048);
7.00   END-PR;
7.01 d u_701           s              1    inz(*off)
7.02 d u_702           s              1    inz(*off)
7.04 d u_704           s              1    inz(*off)
7.07 d u_707           s              1    inz(*off)
7.08 d u_708           s              1    inz(*off)
7.0a d u_70a           s              1    inz(*off)
7.03 d u_vkid          s              1    inz(*off)
8.08 d u_803           s              1    inz(*off)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Definering av formater
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Benyttede formater
      * - - - - - - - - - -
      *
      * A1HDR  - Heading A1 på rapport
      * A2HDR  - Heading A2 på rapport
      * A3HDR  - Heading A3 på rapport, Ordrehode over varelinje
      * D1DET  - Detail  D1 på rapport, Varelinje
      * D2DET  - Detail  D2 på rapport, Tekstlinje
      * O1DET  - Detail  O1 på rapport, Overføring til/fra neste side
      * R1TOT  - Total   R1 på rapport, ordrerabatt
      * T1TOT  - Total   T1 på rapport
      *
      *
      * Forklaring på variabler
      * - - - - - - - - - - - -
      *
      * D1ANT0 - Antall med 0 desimaler
      * D1ANT1 - Antall med 1 desimaler
      * D1ANT2 - Antall med 2 desimaler
      * D1ANT3 - Antall med 3 desimaler
      * D1BPRI - Brutto pris
      * D1NBEL - Netto  beløp
      * D1RABP - Rabatt i prosent (Sum prosent 1 og 2)
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Styre-rutine
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.11  *
8.11 C/Exec SQL
8.11 C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
8.11 C+             commit=*none
8.11 C/End-Exec
      *
      * Initierings-rutine
      *
     c     fcycle        caseq     *zero         xstrsr
     c                   endcs
      *
      * Behandle ordrehode
      *
     c     htag01        tag
     c     *in61         cabeq     *on           xslutt
     c     sofirm        cabne     w_firm        xslutt
3.10 c     soaarr        cabne     d_aarr        xslutt
     c     sobinr        cabgt     d_tfnr        xslutt
8.09 c                   if        b_saml = *off
     c     sootyp        cabne     d_otyp        ntag03
8.09 c                   endif
5.31  *
5.31  * Sjekk utg. fakt.logg - sjekk om faktura evt ikke skal printes
5.31  *
5.31 c                   exsr      sjk_uf_log
5.31 c                   if        b_nopr = *on
5.31 c                   read      sohel1                                 61
5.31 c                   goto      htag01
5.31 c                   endif
6.11  *
6.11  * Sjekk om ordren har noen varelinjer
6.11  *
6.11 c                   exsr      sjk_varlin
6.11 c                   if        b_nopr = *on
6.11 c                   read      sohel1                                 61
6.11 c                   goto      htag01
6.11 c                   endif
8.08  *
8.08  * Sjekk om factoring på ordretype/kunde og legg evt. inn factoring info
8.08  *
8.08      if u_803 = *on;
8.08       exsr sjk_fact;
8.08      endif;
8.08
8.08      exsr bygg_fact;
8.08  *
     c                   if        sobinr <> w_binr
     c                   exsr      xhode1
     c                   else
     c                   exsr      xhode2
     c                   endif
     c                   eval      w_binr = sobinr
8.08  *
      *
      * Behandle varelinje
      *
     c                   eval      sodtl1_binr = sobinr
     c                   eval      sodtl1_numm = sonumm
     c                   eval      sodtl1_suff = sosuff
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
     c     sodtl1_key    setll     sodtl1
     c                   read      sodtl1                                 62
      *
     c     vtag01        tag
     c     *in62         cabeq     *on           ntag02
     c     sdfirm        cabne     sofirm        ntag02
     c     sdbinr        cabne     sobinr        ntag02
     c     sdnumm        cabne     sonumm        ntag03
     c     sdsuff        cabne     sosuff        ntag03
      *
     c                   exsr      xvare1
     c                   read      sodtl1                                 62
     c                   goto      vtag01
      *
      * Ny faktura
      *
     c     ntag02        tag
     c                   eval      a1side = 1
6.2J c* Pga xml håndtering, må bunntekster legges til slutt. Problemer i
6.2J c* kombinasjon med avgifter.
6.2J c                   if        b_pdfp = *on
6.2J c                   exsr      xml_btxt
6.2J c                   endif
     c                   exsr      xorrab
     c                   exsr      xtotal
     c                   read      sohel1                                 61
     c                   goto      htag01
      *
      * Ny ordre
      *
     c     ntag03        tag
6.2J c* Pga xml håndtering, må bunntekster legges til slutt. Problemer i
6.2J c* kombinasjon med avgifter.
6.2J c                   if        b_pdfp = *on
6.2J c                   exsr      xml_btxt
6.2J c                   endif
     c                   exsr      xorrab
     c                   read      sohel1                                 61
     c                   goto      htag01
      *
      * Ferdig
      *
     c     xslutt        tag
pdf   * PDF print er aktivert
pdf  c                   if        b_pdfp = *on
pdf   * Vi har skrevet en faktura som ikke er e-print etc.
pdf  c                   if        b_pdfp_first = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Hvis forhåndvisning må vi kjøre linken
pdf  c                   if        l_skje = 1 and
pdf  c                             l_bach = w_bach
pdf  c                   exsr      pdf_preview
pdf  c                   endif
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
6.22 c                   parm                    w_bach
pdf   *
pdf  c                   endif
pdf  c                   endif
6.28  * Hvis det skal skrives kopi, må denne initieres. Skal ikke kjøre kopi på kopi
6.28 c                   if        d_kopi <> 'K'
6.28 c                   if        d_fkop = '1'
6.28 c                   eval      d_kopi = 'K'
6.28 c                   eval      l_kopi = '1'
6.28 c                   eval      p_parm = d_parm
6.28  * Nuller ut gammel unikverdi, slik at det blir generert på nytt
6.28 c                   eval      l_bach = *blanks
6.28 c                   endif
6.28 c                   endif
6.28  *
     c                   eval      *inlr = *on
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * A1HDR Behandle heading A1 + A2
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhode1        begsr
      *
8.10 c                   if        b_saml = *on
8.10  *
8.10  * Vi kommer hit "første" runde og etter vi har brudd på
8.10  * fakturanummer. Det betyr at vi har lest inn "neste" ordre-
8.10  * hode, og SOOTYP kan være feil hvis vi benytter "samling" av
8.10  * positive og negative ordretyper.
8.10  *
8.10 c                   if        w_otyp <> *blanks
8.10 c                   eval      votyl1_otyp = w_otyp
8.10 c                   else
8.10 c                   eval      votyl1_otyp = sootyp
8.10 c                   endif
8.10 c     votyl1_key    chain     votyl1r
8.10 c                   if        %found
8.10 c                   eval      w_otyp = sootyp
8.10 c                   endif
8.10  *
8.10  * Er ordretype negativ ?
8.10  *
8.10 c                   eval      *in36 = *off
8.10 c                   if        vaokre = '-'
8.10 c                   eval      *in36 = *on
8.10 c                   endif
8.10  *
8.10 c                   eval      aforl1_ruti = vaorut
8.10 c     aforl1_key    chain     aforl1r
8.10 c                   if        %found
8.10 c                   eval      a1txt1 = aftxt1
8.10 c                   eval      t1mld1 = afmld1
8.10 c                   eval      t1mld3 = afmld3
8.10 c                   eval      t3mld1 = afmld1
8.10 c                   eval      t3mld3 = afmld3
8.10 c                   endif
8.10  *
8.10  * Sjekke om dette er en
8.10  * faktura-kopi
8.10  *
8.10 c                   eval      *in50 = *off
8.10 c                   eval      w_copy = *blanks
8.10 c                   eval      w_copy2 = *blanks
8.10 c                   if        d_kopi = 'K'
8.10 c                   eval      *in50 = *on
8.10 c                   if        *in36 = *off
8.10 c                   eval      w_copy = 'FAKTUR'
8.10 c                   eval      w_copy2 = 'FAKTURAKOPI'
8.10 c                   else
8.10 c                   eval      w_copy = 'KREDITNOTA'
8.10 c                   eval      w_copy2 = 'KREDITNOTAKOPI'
8.10 c                   endif
8.10 c                   else
8.10 c                   if        *in36 = *off
8.10 c                   eval      w_copy = 'FAKTURA'
8.10 c                   eval      w_copy2 = 'FAKTURA'
8.10 c                   else
8.10 c                   eval      w_copy = 'KREDITNOTA'
8.10 c                   eval      w_copy2 = 'KREDITNOTA'
8.10 c                   endif
8.10 c                   endif
8.10  *
8.10 c                   endif
pdf   * Skriv ut forrige PDF, lager ny batch
pdf  c                   if        w_binr <> 0 and
pdf  c                             b_pdfp = *on
pdf   * Skriv xml fila på disk
pdf  c                   exsr      xml_end
pdf   * Avslutt jobbiden
pdf  c                   call      'AB710R'
pdf  c                   parm                    w_bach
pdf   * Lager nytt batchnummer
6.40 c                   exsr      proa_nummer
pdf   *
pdf  c                   eval      w_jnav = 'PDF' + %char(w_numm)
pdf  c                   eval      w_jtxt = 'Utskrift av faktura via Jasper'
pdf  c                   call      'AB700R'
pdf  c                   parm                    w_jnav
pdf  c                   parm                    w_jkey
pdf  c                   parm                    w_jtxt
pdf   *
pdf  c                   eval      w_bach = w_jkey
pdf   * Vi logger at utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av faktura har startet'
pdf  c                   call      'AB705R'
6.22 c                   parm                    w_jkey
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   * Vi skriver xml for miljø formater
pdf  c                   exsr      xml_envm
pdf  c                   endif
      * Null-stilling av
      * variabler
8.10  *
8.10 c                   if        b_saml = *on
8.10  * Da er vi ferdig med å skrive ut "gammel" faktura.
8.10  * Hvis vi benytter samling av negative og positive ordretyper, må
8.10  * vi sette riktig indikator for dette. Bruk da ordrtypen fra sist
8.10  * innlest ordrethode.
8.10  *
8.10 c                   eval      votyl1_otyp = sootyp
8.10 c     votyl1_key    chain     votyl1r
8.10 c                   if        %found
8.10 c                   eval      w_otyp = sootyp
8.10 c                   endif
8.10  *
8.10  * Er ordretype negativ ?
8.10  *
8.10 c                   eval      *in36 = *off
8.10 c                   if        vaokre = '-'
8.10 c                   eval      *in36 = *on
8.10 c                   endif
8.10  *
8.10 c                   eval      aforl1_ruti = vaorut
8.10 c     aforl1_key    chain     aforl1r
8.10 c                   if        %found
8.10 c                   eval      a1txt1 = aftxt1
8.10 c                   eval      t1mld1 = afmld1
8.10 c                   eval      t1mld3 = afmld3
8.10 c                   eval      t3mld1 = afmld1
8.10 c                   eval      t3mld3 = afmld3
8.10 c                   endif
8.10  *
8.10  * Sjekke om dette er en
8.10  * faktura-kopi
8.10  *
8.10 c                   eval      *in50 = *off
8.10 c                   eval      w_copy = *blanks
8.10 c                   eval      w_copy2 = *blanks
8.10 c                   if        d_kopi = 'K'
8.10 c                   eval      *in50 = *on
8.10 c                   if        *in36 = *off
8.10 c                   eval      w_copy = 'FAKTUR'
8.10 c                   eval      w_copy2 = 'FAKTURAKOPI'
8.10 c                   else
8.10 c                   eval      w_copy = 'KREDITNOTA'
8.10 c                   eval      w_copy2 = 'KREDITNOTAKOPI'
8.10 c                   endif
8.10 c                   else
8.10 c                   if        *in36 = *off
8.10 c                   eval      w_copy = 'FAKTURA'
8.10 c                   eval      w_copy2 = 'FAKTURA'
8.10 c                   else
8.10 c                   eval      w_copy = 'KREDITNOTA'
8.10 c                   eval      w_copy2 = 'KREDITNOTA'
8.10 c                   endif
8.10 c                   endif
8.10  *
8.10 c                   endif
      *
     c                   eval      t3tell = 0
     c                   eval      o3trsp = 0
     c                   eval      o1trsp = 0
      *
     c                   exsr      xhodef
      *
      * Snu fakturadato
      *
6.3i c                   eval      w_fkda = sofkda
     c                   if        sofkda <> *loval
     c     *dmy          move      sofkda        a1fkda
     c                   endif
      *
      * Snu forfallsdato
      *
     c                   if        soffda <> *loval
     c     *dmy          move      soffda        a1ffda
     c                   endif
      *
      * Legg inn ordrenummer
      *
     c                   move      sonumm        a1numm
     c                   movel     '/'           a1suff
     c                   move      sosuff        a1suff
7.06  *
7.06  * Legg inn leveringstype
7.06  *
7.06 c                   eval      a2lety = solety
      *
      * Hente inn kunderegister
      *
     c                   eval      rkunl1_kund = sokund
     c     rkunl1_key    chain     rkunl1r                            64
     c                   eval      a1kund = sokund
     c                   eval      a1navn = rknavn
     c                   eval      a1gate = rkgate
     c                   eval      a1adr2 = rkadr2
     c                   eval      a1sted = rksted
Till c                   eval      a2betm = rkbetm
Till c                   eval      a2fcop = rkfcop
      *
      * Sjekke tilbuds-kunden
      *
     c                   if        sokund = w_kund
     c                   eval      sokund = solkun
     c                   eval      a1navn = sonavn
     c                   eval      a1gate = soadr1
     c                   eval      a1adr2 = soadr2
     c                   eval      a1sted = sosted
     c                   eval      solkun = *zero
     c                   eval      sonavn = *blank
     c                   eval      soadr1 = *blank
     c                   eval      soadr2 = *blank
     c                   eval      sosted = *blank
     c                   endif
      *
      * Finner hvilken mva-sats
      * som skal benyttes
      *
     c                   call      'FÅ705R'
     c                   parm                    w_firm
3.32 c                   parm                    sofkda
     c                   parm                    w_mvas
     c                   parm                    w_mvat
     c                   parm                    w_mvaf
3.34  *
3.34  * Finner hvilken mva-sats
3.34  * som skal benyttes (for halv sats)
3.34  *
3.34 c                   call      'FÅ706R'
3.34 c                   parm                    w_firm
3.34 c                   parm                    sofkda
3.34 c                   parm                    w_mv2s
3.34 c                   parm                    w_mv2t
3.34 c                   parm                    w_mv2f
      *
      * Hente inn betalings-
      * betingelser
      *
     c                   call      'FÅ703R'
     c                   parm                    w_firm
     c                   parm                    sobetb
     c                   parm                    sofkda
     c                   parm                    w_csts
     c                   parm                    w_ffda
     c                   parm                    a1ctxt
     c                   parm                    w_ctx2
      *
      * Er det registrert
      * leveringsadresse?
      *
     c                   eval      *in31 = *off
     c                   if        sonavn <> *blank
     c                   eval      *in31 = *on
     c                   eval      a2navn = sonavn
     c                   eval      a2adr1 = soadr1
     c                   eval      a2adr2 = soadr2
     c                   eval      a2sted = sosted
     c                   endif
      *
      * Flytte øvrige felter
      *
     c                   eval      a1binr = sobinr
3.12  *
3.12  *  Hent inn firma/avd. opplysninger dersom
3.12  *  kode for det er satt i rutineregister
3.12  *
3.12 c                   if        afprfi = 1 or
3.12 c                             afprfi = 2
3.12 c                   eval      w_prfi = afprfi
3.12 c                   eval      w_ffir = w_firm
3.12 c                   eval      w_avde = soavde
3.12  *
3.12 c                   call      'FÅ707R'
3.12 c                   parm                    w_prfi
3.12 c                   parm                    w_ffir
3.12 c                   parm                    w_avde
3.12 c                   parm                    w_fnav
3.12 c                   parm                    w_fad1
3.12 c                   parm                    w_fad2
3.12 c                   parm                    w_fste
3.12 c                   parm                    w_fftx
3.12 c                   parm                    w_tfax
3.12 c                   parm                    w_ftlf
3.12 c                   parm                    w_ffax
6.3c c                   parm                    w_mail
6.3c c                   parm                    w_weba
3.12  *
3.12 c                   eval      a1fnav = w_fnav
3.12 c                   eval      a1fad1 = w_fad1
3.12 c                   eval      a1fad2 = w_fad2
3.12 c                   eval      a1fste = w_fste
3.12 c                   eval      a1fftx = w_fftx
3.12 c                   eval      a1tfax = w_tfax
3.12 c                   eval      a1ftlf = w_ftlf
3.12 c                   eval      a1ffax = w_ffax
3.12 c                   endif
5.22  *
5.22  * Legger inn '/' mellom
5.22  * telefon og telefax
5.22  *
5.22 c                   eval      a1skra =  ' '
5.22 c                   if        a1ftlf <> *blank and
5.22 c                             a1ffax <> *blank
5.22 c                   eval      a1skra =  '/'
5.22 c                   endif
6.2B  * Hent inn avdelingsinfo - uavhengig av om dette ligger i firmatagger
6.2B c                   exsr      hnt_avde
      *
      * Skrive heading
      *
     c                   eval      w_tell = 0
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
pdf  c                   else
pdf   * Vi skriver til XML taggene for heading faktura
pdf  c                   if        b_pdfp_first = *off
pdf  c                   exsr      xml_envm
pdf  c                   eval      b_pdfp_first = *on
pdf  c                   endif
pdf  c                   exsr      xml_head_inv
pdf  c                   endif
      *
      * Dersom prosjekt lager og lev.måte
      * ikke er oppgitt, la vær å skrive
      *
     c                   eval      *in34  = *off
5.48 c                   if        a1ldat = 0 and
     c                             a1lage = 0 and
     c                             a1lmtx = *blank
     c                   eval      *in34  = *on
     c                   endif
      *
      * Skriv heading
      * over varelinjer
      *
     c                   eval      a3numm = a1numm
     c                   eval      a3suff = a1suff
     c                   eval      a3avde = a1avde
     c                   eval      a3vref = a1vref
     c                   eval      a3bdat = a1bdat
     c                   eval      a3lage = a1lage
     c                   eval      a3dref = a1dref
5.48 c                   eval      a3ldat = a1ldat
     c                   eval      a3selg = a1selg
     c                   eval      a3lmtx = a1lmtx
     c                   eval      a3rekv = a1rekv
5.47 c                   eval      a3lbet = a1lbet
5.60 c                   eval      a3kpro = a1kpro
5.60 c                   eval      a3epro = a1epro
      *
     c                   eval      w_tell = w_tell + 3
      *
     c                   if        *in34  = *off
     c                   eval      w_tell = w_tell + 1
     c                   endif
      *
     c                   if        *in35  = *on
     c                   eval      w_tell = w_tell + 1
     c                   endif
5.60  *
5.60 c                   if        *in37  = *on
5.60 c                   eval      w_tell = w_tell + 1
5.60 c                   endif
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a3hdr
pdf   * Vi skriver til XML taggene for heading ordre
pdf  c                   else
pdf  c                   exsr      xml_head_ord
pdf  c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Flere ordre pr.faktura
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhode2        begsr
      *
     c                   exsr      xhodef
      *
      * Legge inn ordrenr
      * og suffix
      *
     c                   move      sonumm        a1numm
     c                   movel     '/'           a1suff
     c                   move      sosuff        a1suff
      *
      * Dersom prosjekt lager og lev.måte
      * ikke er oppgitt, la vær å skrive
      *
     c                   eval      *in34  = *off
5.48 c                   if        a1ldat = 0 and
     c                             a1lage = 0 and
     c                             a1lmtx = *blank
     c                   eval      *in34  = *on
     c                   endif
      *
      * Skriv heading
      * over varelinjer
      *
     c                   eval      a3numm = a1numm
     c                   eval      a3suff = a1suff
     c                   eval      a3avde = a1avde
     c                   eval      a3vref = a1vref
     c                   eval      a3bdat = a1bdat
     c                   eval      a3lage = a1lage
     c                   eval      a3dref = a1dref
5.48 c                   eval      a3ldat = a1ldat
     c                   eval      a3selg = a1selg
     c                   eval      a3lmtx = a1lmtx
     c                   eval      a3rekv = a1rekv
      *
     c                   eval      w_tell = w_tell + 3
      *
     c                   if        *in34  = *off
     c                   eval      w_tell = w_tell + 1
     c                   endif
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  a3hdr
pdf   * Vi skriver til XML taggene for heading ordre
pdf  c                   else
pdf   * Sørg for at vi har skrevet avsluttende tagger fra forrige ordre
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
6.30 c                   exsr      xml_oend_tag
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf  c                   exsr      xml_head_ord
pdf  c                   endif
      *
      * Er det overflow ?
      *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Felles rutine for XHODE1 og XHODE2
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xhodef        begsr
      *
      * Summere salg og
      * rabatter
      *
     c                   eval      a1vref = *blank
     c                   eval      a1dref = *blank
     c                   eval      a1rekv = *blank
6.23 c                   if        b_pdfp = *on
6.23 c                   eval      a1kpro = *zero
6.23 c                   eval      a2navn = *blank
6.23 c                   eval      a2adr1 = *blank
6.23 c                   eval      a2adr2 = *blank
6.23 c                   eval      a2sted = *blank
6.23 c                   endif
      *
      * Snu ordredato
      *
     c                   if        sobdat <> *loval
     c     *dmy          move      sobdat        a1bdat
     c                   endif
5.48  *
5.48  * Snu leveringsdato
5.48  *
5.48 c                   if        soldat <> *loval
5.48 c     *dmy          move      soldat        a1ldat
6.2B c     *dmy          move      soldat        w_ldat
5.48 c                   endif
      *
      * Er det registrert
      * rekvisisjon?
      *
     c                   eval      *in35 = *off
     c                   if        sorekv <> *blank
     c                   eval      *in35 = *on
     c                   eval      a1rekv = sorekv
     c                   endif
5.47  *
5.47  * Er det registrert
5.47  * leveringsbetingelser
5.47  *
5.47 c                   eval      w_retk = *blank
5.47 c                   eval      w_rtx1 = *blank
5.47 c                   eval      w_rtx2 = *blank
5.47 c                   eval      w_rtx3 = *blank
5.47 c                   if        solbet <> 0
5.47 c                   eval      *in35  = *on
5.47 c                   call      'RS718R'
5.47 c                   parm                    w_retk
5.47 c                   parm                    solbet
5.47 c                   parm                    w_rtx1
5.47 c                   parm                    w_rtx2
5.47 c                   parm                    w_rtx3
5.47 c                   eval      a1lbet = w_rtx1
5.47 c                   endif
5.60  *
5.60  * Er det kundeprosjekt på
5.60  * denne ordre
5.60  *
5.60 c                   eval      *in37 = *off
5.60 c                   if        sokpro <> 0
5.60 c                   eval      *in37 = *on
5.60 c                   eval      a1kpro = sokpro
5.60 c                   endif
5.60  *
5.60  * Hent over eksternt prosjektnr
5.60  * dersom dette finnes
5.60  *
6.2E c                   eval      a1epro = *blanks
5.60 c                   if        *in37  = *on
5.60 c                   eval      fkprl1_kund = sokund
5.60 c                   eval      fkprl1_kpro = sokpro
5.60 c     fkprl1_key    chain     fkprl1r
5.60 c                   if        %found
5.60 c                   eval      a1epro = flepro
5.60 c                   endif
5.60 c                   endif
      *
     c                   eval      a1dref = sodref
     c                   eval      a1vref = sovref
     c                   eval      a1avde = soavde
     c                   eval      a1lage = solage
     c                   eval      a1selg = soselg
5.46 c                   eval      a1lmtx = solmtx
6.38  *
6.38 C                   eval      x_mobi = *blank
6.38 C                   eval      x_mobn = *blank
6.38  *
6.38 C                   if        faamsa = 1
6.38 C                   eval      ra09l1_ikod = soselg
6.38 C     ra09l1_key    chain     ra09l1
6.38 C                   if        raimob <> *blank
6.38 C                   move      '/'           d_tegn
6.38 C                   move      raimob        d_mobn
6.38 C                   move      x_mobi        x_mobn
6.38 C                   endif
6.38 C                   endif
6.38  *
3.33  *
3.33  * Skal faktura skrives uten rabatter,
3.33  * kun med nettobeløp ?
3.33  *
3.33 c                   eval      *in39  = *off
3.33 c                   if        soneto = 1
3.33 c                   eval      *in39  = *on
3.33 c                   endif
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * D1DET Behandle detail D1
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xvare1        begsr
      *
      * Nullstilling av variabler
      *
     c                   eval      d1vare = *blank
     c                   eval      d1tek1 = *blank
     c                   eval      d1tek2 = *blank
     c                   eval      d1enh1 = *blank
     c                   eval      d1tine = *blank
     c                   eval      d1info = *blank
5.22 c                   eval      d1lety = *zero
5.22 c                   eval      d3lety = *zero
     c                   eval      d1ant0 = *zero
     c                   eval      d1ant1 = *zero
     c                   eval      d1ant2 = *zero
     c                   eval      d1ant3 = *zero
     c                   eval      *in44 = *off
     c                   eval      *in46 = *off
9.01 c                   eval      d1rtxt = *blank
      *
      * Sjekker om tekstlinjer
      * fra F11
      *
     c     sdktxt        cabeq     1             tag02a
6.2J c**   sdktxt        cabeq     5             tag02a
6.2J c                   if        b_pdfp = *on
6.2J c     sdktxt        cabeq     5             vslutt
6.2J c                   else
6.2J c     sdktxt        cabeq     5             tag02a
6.2J c                   endif
      *
      * Hent linje-type
      *
     c                   eval      vltyl1_ltyp = sdltyp
     c     vltyl1_key    chain     vltyl1r                            68
      *
      * Sjekker om linjen ikke skrives på ordretypen
      *
     c     sdotyp        cabeq     valo01        vslutt
      *
     c     sdotyp        cabeq     valo02        vslutt
      *
     c     sdotyp        cabeq     valo03        vslutt
      *
     c     sdotyp        cabeq     valo04        vslutt
      *
      * Tekstlinjer på
      * varelinjenivå ? (F2)
      *
     c     valktx        cabeq     1             tag02a
      *
      * Oppslag mot vareregister
      *
     c                   eval      vvarl1_vare = sdvare
     c     vvarl1_key    chain     vvarl1r                            69
      *
6.3l c                   eval      w_lv_nobb = 0
6.3l c                   eval      w_lv_modn = 0
6.3l c                   eval      w_lv_lldo = 0
6.3l c                   eval      w_lv_llva = *blank
6.3l  * sjekker om logistikk-vare
6.3l c                   if        %found(vvarl1)
6.3l  *
6.3l  * Kaller program for henting av prisgruppe
6.3l  *
6.3l c                   call      'VL710R'
6.3l c                   parm                    w_firm
6.3l c                   parm                    sdvare
6.3l c                   parm                    sdlage
6.3l c                   parm                    w_lv_vtyp
6.3l c                   parm                    w_lv_udat
6.3l c                   parm                    w_lv_ldor
6.3l c                   parm                    b_inlr
6.3l c                   parm                    w_lv_nobb
6.3l c                   parm                    w_lv_modn
6.3l c                   parm                    w_lv_lldo
6.3l c                   parm                    w_lv_llva
6.3l c                   endif
      *
      * Sjekk om tilbud/netto-pris
      *
     c                   if        sdrab1 = *zero
     c                   eval      *in46 = *on
     c                   eval      d1tine = *blank
     c                   eval      vpkol1_pkod = sdkpri
     c     vpkol1_key    chain     vpkol1r                            69
     c                   if        *in69 = *off
     c                   eval      d1tine = vaptxt
     c                   endif
     c                   endif
      *
      * Sjekk om beløp ikke skal
      * inngå i ordrerabattgrl.
      *
     c                   if        sdkord = 1
     c                   eval      d1info = '*'
     c                   endif
3.13  *
3.13  * Dersom vare er hentet fra LVR,
3.13  * sett inn  2 desimaler som std.
3.13  *
3.13 c                   if        sdlvre = 1
3.13 c                   eval      vvdesi = 2
3.13 c                   endif
      *
      * Test på antall desimaler
      *
     c                   eval      *in40 = vvdesi = 0
     c                   eval      *in41 = vvdesi = 1
     c                   eval      *in42 = vvdesi = 2
     c                   eval      *in43 = vvdesi = 3
     c                   if        *in40 = *on
     c                   eval      d1ant0 = sdanta
     c                   endif
     c                   if        *in41 = *on
     c                   eval      d1ant1 = sdanta
     c                   endif
     c                   if        *in42 = *on
     c                   eval      d1ant2 = sdanta
     c                   endif
     c                   if        *in43 = *on
     c                   eval      d1ant3 = sdanta
     c                   endif
      *
      * Varelinje
      *
     c                   eval      d1vare = sdvare
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1enh1 = sdenh1
5.22 c                   eval      d1lety = sdlety
5.22 c                   eval      d3lety = sdlety
9.01  *
9.01 c                   if        sdbrr1 > 99,99
9.01 c                   eval      d1brr1 = 99,99
9.01 c                   else
9.01 c                   eval      d1brr1 = sdbrr1
9.01 c                   endif
9.01  *
9.01 c                   if        sdbrr2 > 99,99
9.01 c                   eval      d1brr2 = 99,99
9.01 c                   else
9.01 c                   eval      d1brr2 = sdbrr2
9.01 c                   endif
9.01  *
9.01 c                   eval      d1rtxt = *blank
9.01 c                   if        d1brr1 <> 0 or
9.01 c                             d1brr2 <> 0
9.01 c                   eval      d1rtxt = 'Brrab.'
9.01 c                   endif
      *
      * Brutto pris
      *
     c                   eval      d1bpri = sdsapr
3.33 c                   eval      d3bpri = sdsapr
      *
      * Beregne snittrabatt
      *
     c                   eval      w1rab1 = 100 - sdrab1
     c                   eval      w1rab1 = w1rab1 * sdrab2
     c                   eval      w1rab1 = w1rab1 / 100
     c                   eval      w1rab1 = w1rab1 + sdrab1
     c                   eval      d1rabp = w1rab1
Bygm  *
Bygm  * Brutto beløp
Bygm  *
Bygm c                   eval      d1bbel = sdsalg
3.33  *
3.33  * Skal rabatter vises som nettobeløp
3.33  * uten prosentsatser ?
3.33  *
3.33 c                   if        *in39  = *on
6.3m c                   eval(h)   d1bpri = d1bpri -
3.33 c                                     (d1bpri * d1rabp / 100)
3.33 c                   endif
      *
      * Netto beløp
      *
     c                   eval      d1nbel = sdsalg
     c                   eval      d1nbel = d1nbel - sdrkr1
     c                   eval      d1nbel = d1nbel - sdrkr2
9.01  *
9.01  * Bruksrettsrabatter
9.01  *
9.01 c                   eval      d1bgr1 = 0
9.01 c                   eval      d1brb1 = 0
9.01 c                   if        sdbrr1 <> 0
9.01 c                   eval      d1bgr1 = d1nbel
9.01 c                   eval      d1brb1 = (d1bgr1 * sdbrr1) / 100
9.01 c                   endif
9.01  *
9.01 c                   eval      d1bgr2 = 0
9.01 c                   eval      d1brb2 = 0
9.01 c                   if        sdbrr1 <> 0 and
9.01 c                             sdbrr2 <> 0
9.01 c                   eval      d1bgr2 = d1bgr1 - d1brb1
9.01 c                   eval      d1brb2 = (d1bgr2 * sdbrr2) / 100
9.01 c                   endif
6.12  *
6.12  * Akkumuler til fakturatotaler
6.12  *
9.01 c                   eval      t1bgr1 = t1bgr1 + d1bgr1
9.01 c                   eval      t1bgr2 = t1bgr2 + d1bgr2
9.01 c                   eval      t1brb1 = t1brb1 + d1brb1
9.01 c                   eval      t1brb2 = t1brb2 + d1brb2
6.12 c                   eval      t1tnet = t1tnet + d1nbel
6.13 c                   eval      t5tnet = t5tnet + d1bbel
9.01 c                   eval      t1tnet = t1tnet - d1brb1
9.01 c                   eval      t1tnet = t1tnet - d1brb2
6.12  *
6.12  * Henter mva-kode, beregn mva
6.12  * + legger ut riktig sats på varlinje
6.12  *
6.12 c***>               eval      d1mvap = 0
6.12 c                   eval      w_mvas = 0
6.12  *
6.12 c                   if        sdomva <> *blank
6.12 c                   eval      w_stat = *blank
6.12 c                   eval      w_mvak = sdomva
6.12  *
6.12 c                   call      'RS205R'
6.12 c                   parm                    w_stat
6.12 c                   parm                    w_mvak
6.12 c                   parm                    w_mvtx
6.12 c                   parm                    sofkda
6.12 c                   parm                    w_mvas
6.12 c                   parm                    w_mvat
6.12 c                   parm                    w_mvaf
6.12 c                   parm                    w_bpro
6.12  *
6.2L c                   if        w_mvak <> *blanks
6.2L c**                 if        w_mvas > 0
6.12 c***>               eval(h)   d1mvap = w_mvas
6.12 c                   exsr      xarray
6.12 c                   endif
6.12 c                   endif
      *
      * Akkumuler til overføringssum
      *
Bygm c                   eval      o1trsp = o1trsp + d1nbel
Bygm c                   eval      o3trsp = o3trsp + sdsalg
      *
      * Skriv varelinjer/
      * tekstlinjer
      *
     c     tag02a        tag
      *
      * Skriv tekstlinjer
      * fra F11
      *
7.08 c                   if        u_708 = *off
     c                   if        sdktxt = 1
     c                             or sdktxt = 5
     c                   eval      w_tell = w_tell + 1
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1tek2 = sdtek2
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3tek2 = d1tek2
     c                   eval      *in44 = *on
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d2det
pdf   * Skriver XML tagger for detaljer
pdf  c                   else
pdf  c                   if        sdktxt = 1
pdf  c                   if        b_topt = *off
pdf  c                   exsr      xml_topt_str
pdf  c                   eval      b_topt = *on
pdf  c                   endif
pdf  c                   exsr      xml_topptxt
pdf  c                   else
pdf  c                   if        sdktxt = 5
pdf  c                   if        b_bott = *off
pdf  c                   exsr      xml_bott_str
pdf  c                   eval      b_bott = *on
pdf  c                   endif
pdf  c                   exsr      xml_bunntxt
pdf  c                   endif
pdf  c                   endif
pdf  c                   endif
     c                   goto      tag03a
     c                   endif
7.08 c                   endif
      *
      * Skriv varelinjer
      * ordinær/tekst
      *
     c                   eval      d3vare = d1vare
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3ant0 = d1ant0
     c                   eval      d3ant1 = d1ant1
     c                   eval      d3ant2 = d1ant2
     c                   eval      d3ant3 = d1ant3
     c                   eval      d3enh1 = d1enh1
3.33 c***                eval      d3bpri = d1bpri
     c                   eval      d3info = d1info
      *
     c                   if        valktx <> 1
     c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d1det
pdf  c                   endif
     c                   else
     c                   eval      w_tell = w_tell + 1
     c                   eval      d1tek1 = sdtek1
     c                   eval      d1tek2 = sdtek2
     c                   eval      d3tek1 = d1tek1
     c                   eval      d3tek2 = d1tek2
     c                   eval      *in44 = *on
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  d2det
pdf  c                   endif
     c                   endif
5.22  *
5.22  * Er det overflow ?
5.22  *
5.22 c                   if        %error = '1'
5.22 c                   exsr      xovrfl
5.22 c                   endif
5.22  *
5.22  * Skrive tekst 2,
5.22  * dersom den er oppgitt
5.22  *
5.22 c                   if        valktx <> 1
9.01 c                   if        sdtek2 <> *blank or
9.01 c                             d1rtxt <> *blank
5.22 c                   eval      d1tek2 = sdtek2
5.22 c                   eval      d3tek2 = sdtek2
5.22 c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
5.22 c                   write(e)  d1det2
pdf  c                   endif
5.22 c                   endif
5.22 c                   endif
pdf   * Skriver XML tagger for detaljer
pdf  c                   if        b_pdfp = *on
pdf  c                   exsr      xml_deta
6.21  * Finnes det allmenningsrabatt ?
6.21 c                   if        d1rtxt <> *blank
6.21 c                   exsr      xml_usrdisc
6.21 c                   endif
pdf  c                   endif
      *
     c     tag03a        tag
      *
      * Er det overflow ?
      *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c     vslutt        endsr
6.12  *
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.12  * Subrutine for array-håndtering av mva
6.12  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.12  *
6.12 c     xarray        begsr
6.12  *
6.12 c     1             do        9             m
6.12 c                   if        mko(m) = w_mvak or
6.12 c                             mko(m) = ' '
6.12 c                   eval      mko(m) = w_mvak
6.12 c                   eval      msa(m) = w_mvas
6.12 c                   eval      mgr(m) = mgr(m) + d1nbel
6.13 c                   eval      ngr(m) = ngr(m) + d1bbel
6.12  *
6.12 c                   if        sorabp > 0
6.12 c                   if        vvkord = 0
6.12 c                   eval      mog(m) = mog(m) + d1nbel
6.12 c                   eval      w_orab = d1nbel * sorabp / 100
6.12 c                   eval      mor(m) = mor(m) + w_orab
6.12 c                   endif
6.12 c                   endif
6.12  *
6.12 c                   leave
6.12 c                   endif
6.12 c                   enddo
6.12  *
6.12 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for ordre-rabatt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xorrab        begsr
      *
     c                   if        sorabp <> *zero
     c                   eval      w_tell = w_tell + 1
     c                   eval      r1rabp = sorabp
     c                   eval      r1rabg = sorbgp + sorbgf
3.34 c                   eval      r1rabg = r1rabg + sorbgh
     c                   eval      r1rabb = sorkop + sorkof
3.34 c                   eval      r1rabb = r1rabb + sorkoh
     c                   eval      r1rabb = r1rabb * -1
6.12 c                   eval      t1tnet = t1tnet + r1rabb
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  r1tot
pdf  c                   else
pdf  c                   exsr      xml_rabatt
pdf  c                   endif
     c                   endif
3.36  *
3.36  * Er det overflow ?
3.36  *
3.36 c                   if        %error = '1'
3.36 c                   exsr      xovrfl
3.36 c                   endif
      *
     c                   endsr
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * T1TOT Behandle total T1
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xtotal        begsr
6.11  *
6.11  * Henter inn siste post fra fakturahode
6.11  *
6.11 c                   eval      sohelr_binr = sobinr
6.nu c                   eval      sohelr_numm = 99999999
6.11 c                   eval      sohelr_suff = 99
6.11 c     sohelr_key    setll     sohelrr
6.11 c                   readp     sohelrr                                63
      *
      * Legg ut eksakt fakturabeløp
      *
6.12 c                   eval      t1fsum = sofsum
9.01  *
8.02  * Flyttet foran depositum, da dette ble feil i rekkefølge på tagger.
9.01  * Legg inn en blank linje før utskrift
9.01  * av almenningsrabatter dersom de finnes
9.01  *
9.01 c                   if        t1brb1 <> 0 or
9.01 c                             t1brb2 <> 0
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det0
6.21 c                   endif
9.01 c                   endif
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
9.01  *
9.01  * Skrive ut almenningsrabatter
9.01  * dersom de finnes
9.01  *
9.01  * Bruksrettrabatt 1
9.01  *
9.01 c                   if        t1brb1 <> 0                                  Mva. grunnl.
9.01 c                   eval      d3tek1 = 'Bruksrettrabatt 1 (Grunnl/Rab)'
9.01 c                   eval      d3bgr1 = t1bgr1
9.01 c                   eval      d3brb1 = t1brb1 * -1
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det1
6.21 c                   else
6.21 c                   exsr      xml_usrsum1
6.21 c                   endif                                                  Mva. grunnl.
9.01 c                   endif                                                  Mva. grunnl.
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
9.01  *
9.01  * Bruksrettrabatt 2
9.01  *
9.01 c                   if        t1brb2 <> 0                                  Mva. grunnl.
9.01 c                   eval      d3tek2 = 'Bruksrettrabatt 2 (Grunnl/Rab)'
9.01 c                   eval      d3bgr2 = t1bgr2
9.01 c                   eval      d3brb2 = t1brb2 * -1
9.01 c                   eval      w_tell = w_tell + 1
6.21 c                   if        b_pdfp = *off
9.01 c                   write(e)  d3det2
6.21 c                   else
6.21 c                   exsr      xml_usrsum2
6.21 c                   endif                                                  Mva. grunnl.
9.01 c                   endif                                                  Mva. grunnl.
9.01  *
9.01  * Er det overflow ?
9.01  *
9.01 c                   if        %error = '1'
9.01 c                   exsr      xovrfl
9.01 c                   endif
7.fb  *
7.fb  * Sjekke om det er depositum
7.fb  *
7.fb c                   eval      sdepl1_numm = sonumm
7.fb c                   eval      sdepl1_kund = sokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1r
7.fb c                   if        %found(sdepl1) and
7.fb c                             skdepb > 0
7.fb c**                 if        sodept <> 0
5.62 c                   eval      r2totb = sofsum
7.fb c**                 eval      r2dept = sodept
7.fb c                   eval      r2dept = skdepb
7.fb c**                 eval      t1fsum = t1fsum - sodept
7.fb c                   eval      t1fsum = t1fsum - skdepb
5.62 c                   eval      w_tell = w_tell + 1
pdf  c                   if        b_pdfp = *off
5.62 c                   write(e)  r2tot
pdf  c                   else
pdf  c                   exsr      xml_depositum
pdf  c                   endif
5.62 c                   endif
5.62  *
5.62  * Oppdater antall linjer pr. faktura
5.62  *
5.62 c                   eval      t3tell = t3tell + w_tell
pdf   * Skriver netto for faktura
pdf  c                   if        b_pdfp = *on
pdf  c                   exsr      xml_netto
pdf  c                   endif
6.12  *
6.12  * Beregner mva for de forskjellige satser
6.12  *
6.12 c                   eval      mbe = (mgr - mor) * msa / 100
6.12 c                   xfoot     mbe           t1tmva
6.13 c                   eval      nbe =  ngr        * msa / 100
6.13 c                   xfoot     nbe           t5tmva
6.12  *
6.12 c     1             do        9             m
6.12 c                   if        mko(m) <> ' '
6.12 c                   eval      t1mvas = msa(m)
6.12 c                   eval      t1mvag = mgr(m) - mor(m)
6.12 c                   eval      t1mvab = mbe(m)
6.13 c                   eval      t5mvas = msa(m)
6.13 c                   eval      t5mvag = ngr(m)
6.13 c                   eval      t5mvab = nbe(m)
pdf  c                   if        b_pdfp = *off
6.12 c                   write     t1tot2                               30
pdf  c                   else
pdf  c                   exsr      xml_vat
pdf  c                   endif
6.12 c                   endif
6.12 c                   enddo
      *
      * Finne ut om det er
      * plass til å skrive
      * avslutning uten å
      * skifte til ny side
      * først.
      *
      * Skrive ny heading ?
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   if        (d_linnbr + 2) > 86
3.36 c                   eval      a1side = a1side + 1
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
     c                   eval      w_tell = 0
     c                   endif
pdf  c                   endif
      *
5.04  * Klargjøring av kidd-nummer
5.04  *
5.04 c                   if        d_kidk <> 0
5.04 c                   eval      t1hkid = 'KID-nummer'
5.04 c                   endif
5.04  *
5.04 c                   if        d_kidk = 1
5.04 c                   movel     sokidd        t1kkid
5.04 c                   endif
5.04  *
5.04 c                   if        d_kidk = 2
5.04 c                   movel     sokidr        t1kkid
5.04 c                   endif
      *
6.45  *
6.45 c                   if        d_kidk = 3
7.03 c                   if        u_vkid = *on
7.03 c                   movel     sokidr        t1kkid
7.03 c                   else
6.45 c                   movel     sokidr        w_kidr
6.45 c                   call      'AK710R'
6.45 c                   parm                    w_firm
6.45 c                   parm                    w_kidr
6.45 c                   parm                    w_kidd
6.45 c                   parm                    w_kid2
6.45 c                   movel     w_kid2        t1kkid
7.03 c                   endif
6.45 c                   endif
      *
      * Beregne modulus 10
      * på beløpsfeltet
      *
     c                   move      *blank        kidd10
6.12 c                   move      t1fsum        kidd10
     c                   exsr      mod10
     c                   move      ksif10        t1bsif
6.13 c                   eval      t5fsum = t5tnet + t5tmva
      *
      * Skrive totalsum
      *
pdf  c                   if        b_pdfp = *off
3.36 c                   write(e)  t1tot
pdf  c                   else
pdf  c                   exsr      xml_totaler
pdf  c                   endif
6.15  *
6.15  * Null-stilling av array's
6.15  *
6.15 c                   eval      mko = *blank
6.15 c                   eval      msa = *zero
6.15 c                   eval      mgr = *zero
6.15 c                   eval      mbe = *zero
6.15 c                   eval      mog = *zero
6.15 c                   eval      mor = *zero
6.15 c                   eval      ngr = *zero
6.15 c                   eval      nbe = *zero
6.15  *
6.15 c                   eval      t1tnet = 0
6.15 c                   eval      t5tnet = 0
9.01 c                   eval      t1bgr1 = 0
9.01 c                   eval      t1bgr2 = 0
9.01 c                   eval      t1brb1 = 0
9.01 c                   eval      t1brb2 = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for overflow
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xovrfl        begsr
      *
     c                   eval      a1side = a1side + 1
pdf  c                   if        b_pdfp = *off
     c                   eval      *in45 = *on
3.36 c                   write(e)  o1det
3.36 c                   write(e)  a1hdr
3.36 c                   write(e)  a2hdr
     c                   eval      *in45 = *off
3.36 c                   write(e)  o1det
pdf  c                   endif
     c                   eval      t3tell = t3tell + w_tell
     c                   eval      w_tell = 0
      *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * MDMEMBER *** Kopiert inn fra MODUS10 copy-member. ***
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Husk!! inn før /COPY av MODUS10 i ditt program følgende
      * statmemnt:
      *                    MOVE *BLANK    KIDD10 24
      *                    MOVE 'felt'    KIDD10
      *  'felt' må byttes ut med det felt som det i hvert tilfelle
      *         skal beregnes MODULUS 10 av.
      *
      *     Kall av subrutine MOD10 for modulus-10 utregning.
      *
      *                    EXSR MOD10
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Husk!! Felt KSIF10, KIDD10 inneholder h.h.v. sjekksiffer/
      *        utregningssiffer (beløp-kundeident.felt e.l.).
      *        Dersom det i programmet er flere modulus 10 sjekker
      *        må disse feltene bevares i egne opprettede felt, fordi
      *        de vil endres ved hver modulus 10 sjekk da de brukes
      *        omigjen.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     CSR   MOD10         BEGSR
      *
      * MDMEMBER *** Kopiert inn fra MODUS10 copy-member. ***
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *        Start subrutinen for modulus-10 utregning.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - -
     C                   Z-ADD     1             XX                2 0
     C                   Z-ADD     2             YY                2 0
     C                   Z-ADD     2             FA10              1 0
     C                   Z-ADD     0             MODS10            3 0
     C                   Z-ADD     0             MODR10            1 0
     C                   Z-ADD     0             KSIF10            1 0
      *
      * På grunn av forskjeller mellom S/36 og AS400
      * må MOVEA gå via et alfa-array før det legges
      * over i et nummerisk array.
      *
     C                   MOVEA     KIDD10        A10
     C                   MOVE      A10           M10
      *
     C     UTR10         TAG
      *
     C     XX            IFGT      12
     C                   Z-ADD     1             XX
     C                   Z-ADD     1             YY
     C                   GOTO      ADD10
     C                   ELSE
     C     M10(YY)       MULT      FA10          U10(XX)
     C     M10(YY)       IFGT      4
     C                   ADD       1             MODS10
     C                   END
     C                   ADD       1             XX
     C                   ADD       2             YY
     C                   GOTO      UTR10
     C                   END
      *
     C     ADD10         TAG
      *
     C     XX            IFGT      12
     C                   GOTO      SIF10
     C                   END
     C                   ADD       U10(XX)       MODS10
     C                   ADD       M10(YY)       MODS10
     C                   ADD       1             XX
     C                   ADD       2             YY
      *
     C                   GOTO      ADD10
      *
     C     SIF10         TAG
     C                   MOVE      MODS10        MODR10
     C     10            SUB       MODR10        KSIF10
      *
     C                   ENDSR
5.31  *
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  * Subrutine for kontroll av utgående fakturalogg / fakturatype
5.31  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.31  *
5.31 c     sjk_uf_log    begsr
5.31  *
6.39 c                   eval      b_faty = *off
5.31 c                   eval      b_nopr = *off
5.31  *
5.31 c                   eval      fnufl1_aarr = soaarr
5.31 c                   eval      fnufl1_binr = sobinr
5.31 c     fnufl1_key    chain     fnufl1
5.31 c                   if        not %found
5.31 c                   leavesr
5.31 c                   endif
5.31  *
5.31 c                   eval      fmftl1_faty = fnufat
5.31 c     fmftl1_key    chain     fmftl1
5.31 c                   if        not %found
5.31 c                   leavesr
5.31 c                   endif
5.31  *
5.31  * Sjekk indikatorer :Undertrykk utskrift=Ja(1) og Test=Nei(0)
5.31  *
5.49 c                   if        d_kopi = *blank
5.31 c                   if        fmtuts = 1
5.31 c                   if        fmttes = 0
6.39 c                   if        b_pdfp = *off
5.31 c                   eval      b_nopr = *on
6.39 c                   else
6.39 c                   if        l_arch = 1
6.39 c                   eval      b_faty = *on
6.39 c                   else
5.31 c                   eval      b_nopr = *on
6.39 c                   endif
6.39 c                   endif
5.31 c                   endif
5.31 c                   endif
5.49 c                   endif
5.31  *
5.31 c                   endsr
6.11  *
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  * Subrutine for å sjekke om ordre har varelinjer
6.11  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.11  *
6.11 c     sjk_varlin    begsr
6.11  *
6.11 c                   eval      b_nopr = *off
6.11  *
6.11 c                   eval      sodtlr_aarr = soaarr
6.11 c                   eval      sodtlr_binr = sobinr
6.11 c                   eval      sodtlr_numm = sonumm
6.11 c                   eval      sodtlr_suff = sosuff
6.11 c     sodtlr_key    setll     sodtlrr
6.11 c                   read      sodtlrr
6.11 c                   if        sdaarr <> soaarr or
6.11 c                             sdbinr <> sobinr or
6.11 c                             sdnumm <> sonumm or
6.11 c                             sdsuff <> sosuff
6.11 c                   eval      b_nopr = *on
6.11 c                   endif
6.11  *
6.11 c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for oppstart
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     xstrsr        begsr
      *
     c                   eval      a1side = 1
     c                   eval      fcycle = 1
      *
      * Legger inn firma i nøkkel
      *
     c                   eval      w_firm = l_firm
7.01  *
7.01  * Endring 7.01
7.01  *
7.13 c                   eval      w_faty = *blanks
7.01  *
7.01   CallP CO402R(l_filg:w_firm:0:'FO946R_701':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01     w_pos = %scan('¤' : co402_verdi2);
7.01     if (w_pos > 0);
7.01       w_host = %subst(co402_verdi2 : 1 : w_pos - 1);
7.01       co402_verdi2 =  %subst(co402_verdi2:w_pos+1:512-w_pos);
7.01       w_pos = %scan('¤' : co402_verdi2);
7.01       w_usr  = %subst(co402_verdi2 : 1 : w_pos - 1);
7.01       co402_verdi2 =  %subst(co402_verdi2:w_pos+1:512-w_pos);
7.01       w_pos = %scan('¤' : co402_verdi2);
7.01       w_pwd  = %subst(co402_verdi2 : 1 : w_pos - 1);
7.01       co402_verdi2 =  %subst(co402_verdi2:w_pos+1:512-w_pos);
7.01       w_pos = %scan('¤' : co402_verdi2);
7.01       w_fldr = %subst(co402_verdi2 : 1 : w_pos - 1);
7.01       if (w_host <> *blank and w_usr <> *blank
7.01            and w_pwd <> *blank and w_fldr <> *blank);
7.01         u_701 = *on;
7.0a         co402_verdi2 =  %subst(co402_verdi2:w_pos+1:512-w_pos);
7.0a         w_pos = %scan('¤' : co402_verdi2);
7.0a         if (w_pos > 0);
7.0a           w_faty = %subst(co402_verdi2 : 1 : w_pos - 1);
7.0a           if (w_faty = '1');
7.0a             u_70a = *on;
7.0a           endif;
7.0a         endif;
7.01       endif;
7.01     endif;
7.01   endif;
7.02  *
7.02  * Endring 7.02
7.02  *
7.02   CallP CO402R(l_filg:w_firm:0:'FO946R_702':
7.02                    co402_verdi1:co402_verdi2);
7.02   if co402_verdi1 = '1';
7.02     u_702 = *on;
7.02   endif;
7.03  *
7.03  * Sjekk om det skal kjøres med spesial KID
7.03  *
7.03   CallP CO402R(l_filg:w_firm:0:'FO946_VISMA_KID':
7.03                    co402_verdi1:co402_verdi2);
7.03   if co402_verdi1 = '1';
7.03     u_vkid = *on;
7.03   endif;
7.04  *
7.04  * Endring 7.04
7.04  *
7.04   CallP CO402R(l_filg:w_firm:0:'FO946R_704':
7.04                    co402_verdi1:co402_verdi2);
7.04   if co402_verdi1 = '1';
7.04     u_704 = *on;
7.04   endif;
7.07  *
7.07  * Endring 7.07
7.07  *
7.07   CallP CO402R(l_filg:w_firm:0:'FO946R_707':
7.07                    co402_verdi1:co402_verdi2);
7.07   if co402_verdi1 = '1';
7.07     u_707 = *on;
7.07   endif;
7.08  *
7.08  * Endring 7.08
7.08  *
7.08   CallP CO402R(l_filg:w_firm:0:'FO946R_708':
7.08                    co402_verdi1:co402_verdi2);
7.08   if co402_verdi1 = '1';
7.08     u_708 = *on;
7.08   endif;
8.09  *
8.09  * Endring 8.09 - Mulighet for samlefakturering, fakt/kred samtidig.
8.09  *
8.09   CallP CO402R(l_filg:w_firm:0:'SAMLEFAKTURERE_DEBET_KREDIT':
8.09                    co402_verdi1:co402_verdi2);
8.09   if co402_verdi1 = '1';
8.09     b_saml = *on;
8.09   endif;
8.08  *
8.08  * Sjekk om det skal kjøres factoring via iizy
8.08  *
8.08   CallP CO402R(l_filg:w_firm:0:'FACTORING_VIA_IIZY':
8.08                    co402_verdi1:co402_verdi2);
8.08   if co402_verdi1 = '1';
8.08     u_803 = *on;
8.08   endif;
8.08  *
8.08  * Henter factoring informasjon fra koderegister
8.08  *
8.08      if u_803 = *on;
8.08       exec sql
8.08        select rkfsel, rkfbkk, rkfspl, rkfiba, rkfswi,
8.08               rkfftp, rkfusr, rkfpwd, rkffld,
8.08               rkfot1, rkfot2, rkfot3, rkfot4, rkfot5
8.08         into :w_fsel, :w_fbkk, :w_fspl, :w_fiba, :w_fswi,
8.08              :w_fftp, :w_fusr, :w_fpwd, :w_fldr,
8.08              :w_oty1, :w_oty2, :w_oty3, :w_oty4, :w_oty5
8.08           from ra34st
8.08              where rkffir = :w_firm;
8.08         endif;
      *
      * Legger inn år i nøkkel
      *
     c                   eval      sohel1_aarr = d_aarr
6.11 c                   eval      sohelr_aarr = d_aarr
     c                   eval      sodtl1_aarr = d_aarr
6.11 c                   eval      sodtlr_aarr = d_aarr
      *
      * Klargjøre resterende
      * nøkkelbegrep
      *
     c                   eval      sohel1_binr = d_ffnr
     c                   eval      sohel1_numm = *zero
     c                   eval      sohel1_suff = *zero
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
     c     sohel1_key    setll     sohel1
     c                   read      sohel1                                 61
     c                   eval      sodtl1_ktxt = *zero
     c                   eval      sodtl1_line = *zero
      *
      * Klargjøring dersom firma -
      * opplysninger skal printes ut
      *
5.60 c                   eval      a1ibah = *blank
5.60 c                   eval      a1ibat = *blank
5.60 c                   eval      a1swih = *blank
5.60 c                   eval      a1swit = *blank
5.60  *
      * Hente Kunde-tilbuds-nummer
      *
     c     fstsl1_key    chain     fstsl1r                            69
      *
     c                   if        *in69 = *off
     c                   eval      w_kund = faakun
     c                   endif
      *
      * Slår opp ordretype
      *
     c                   eval      votyl1_otyp = d_otyp
     c     votyl1_key    chain     votyl1r                            67
      *
      * Er ordretype negativ ?
      *
     c                   if        vaokre = '-'
     c                   eval      *in36 = *on
     c                   endif
      *
      * Sjekke om dette er en
      * faktura-kopi
      *
pdf  c                   eval      w_copy = *blanks
6.2S c                   eval      w_copy2 = *blanks
     c                   if        d_kopi = 'K'
     c                   eval      *in50 = *on
pdf  c                   if        *in36 = *off
6.20 c                   eval      w_copy = 'FAKTUR'
6.2S c                   eval      w_copy2 = 'FAKTURAKOPI'
pdf  c                   else
6.20 c                   eval      w_copy = 'KREDITNOTA'
6.2S c                   eval      w_copy2 = 'KREDITNOTAKOPI'
pdf  c                   endif
pdf  c                   else
pdf  c                   if        *in36 = *off
pdf  c                   eval      w_copy = 'FAKTURA'
6.2S c                   eval      w_copy2 = 'FAKTURA'
pdf  c                   else
pdf  c                   eval      w_copy = 'KREDITNOTA'
6.2S c                   eval      w_copy2 = 'KREDITNOTA'
pdf  c                   endif
     c                   endif
6.12  *
6.12  * Nullstilling av array's
6.12  *
6.12 c                   eval      mko = *blank
6.12 c                   eval      msa = *zero
6.12 c                   eval      mgr = *zero
6.12 c                   eval      mbe = *zero
6.12 c                   eval      mog = *zero
6.12 c                   eval      mor = *zero
6.13 c                   eval      ngr = *zero
6.13 c                   eval      nbe = *zero
6.12  *
6.12 c                   eval      t1tnet = 0
6.13 c                   eval      t5tnet = 0
      *
     c                   endsr
      *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_envm      begsr
pdf   * Hvis skjermvisning skal vi ikke lagre i spoolfile
pdf  c                   if        l_skje = 1
pdf  c                   eval      w_spol = 'true'
pdf  c                   else
pdf  c                   eval      w_spol = 'false'
pdf  c                   endif
7.f1  *
7.f1  * Hvis det er betalt depositum på fakturaen, husk å bytte mal
7.f1  *
7.f1 c                   eval      jasper_mal  = %trim(d_jasm)
7.f1 c                   eval      sdepl1_numm = sonumm
7.f1 c                   eval      sdepl1_kund = sokund
7.f1 c                   eval      sdepl1_tell = 0
7.f1 c     sdepl1_key    chain     sdepl1r
7.f1 c                   if        %found(sdepl1) and
7.f1 c                             skdepb > 0 and
7.f1 c                             %trim(w_jmal) <> *blanks
7.f1 c                   eval      jasper_mal = %trim(w_jmal)
7.f1 c                   endif
pdf   *
pdf   /Free
pdf    // Finne nytt batch nummer
pdf    UpdHTMLVar('BatchNo':             w_jkey);
pdf    UpdHTMLVar('Batchtype':        'FAKTURA');
pdf    UpdHTMLVar('Username':            l_user);
pdf    WrtSection('Topp');
pdf    // Finn credential variabler
pdf    UpdHTMLVar('IPAdr':                  ' ');
pdf    UpdHTMLVar('User':                l_user);
pdf    UpdHTMLVar('PW':                     ' ');
pdf    UpdHTMLVar('Schema':        'ADB'+l_filg);
pdf    UpdHTMLVar('Companyno':    %char(l_firm));
6.3e   UpdHTMLVar('Departmentnoarkiv': %char(l_avde));
pdf    WrtSection('Credential');
pdf    // Finn report command variabler
7.f1   //      UpdHTMLVar('Jaspertemplate':      d_jasm);
7.f1           UpdHTMLVar('Jaspertemplate': %trim(jasper_mal));
pdf            UpdHTMLVar('Logo':           jasper_logo);
pdf            UpdHTMLVar('Keepspool':           w_spol);
pdf            WrtSection('ReportCommand');
pdf   /End-free
pdf   *
pdf   * Hvis skjermvisning skal ikke PDF skrives
pdf   *
7.0a  * hvis 'K'                 : print
7.0a  * eller hvis u_701 = *off  : print
7.0a  * eller hvis u_701 = *on
7.0a  *         og u_70a = *on
7.0a  *         og sofaty = 0    : print
7.0a c                   if        (d_kopi = 'K') or (u_701 = *off) or
7.0a c                             ((u_701 = *on) and (u_70a = *on) and
7.13 c                              (sofaty = 0)) or
7.13 c                             ((u_701 = *on) and (w_faty = '2') and
7.13 c                              (sofaty = 0))
pdf  c                   if        l_skje = 0 and
pdf  c                             l_mail = 0
6.31  * Hvis *ARKIV er valgt som skriver, skal det ikke skrives ut
6.31 c                   if        l_utqm <> '*ARKIV'
7.14 c                   if        b_faty = *off or
7.14 c                             w_faty = '2'
pdf   *
pdf  c                   if        l_land = 1
pdf  c                   eval      w_land = 'LANDSCAPE'
pdf  c                   else
pdf  c                   eval      w_land = 'PORTRAIT'
pdf  c                   endif
6.18  * Sjekk at valgt outq støttes av skriveren. Kan skli gjennom hvis
6.18  * jobben legges på jobbkø.
6.18 c                   eval      p_ok = '0'
6.18 c                   call      'AP612R'
6.18 c                   parm                    l_filg
6.18 c                   parm                    l_outq
6.18 c                   parm                    p_ok
6.18  * Hvis feil utkø, logges dette i transaksjonsloggen
6.18 c                   if        p_ok = '0'
6.18 c                   eval      w_jstat = 20
6.18 c                   eval      w_jtext = 'Ugyldig utkø '+ l_outq + ' er val+
6.18 c                             gt. Ingen utskrift er generert. Utskrift kan+
6.18 c                              arkiveres.'
6.18 c                   call      'AB705R'
6.18 c                   parm                    l_bach
6.18 c                   parm                    w_jstat
6.18 c                   parm                    w_jtext
6.18 c                   else
pdf   * Hent inn skuffinformasjon for skriveren
6.44 c                   eval      w_dtray = *blank
6.44 c                   eval      w_gtray = *blank
pdf  c                   call      'AP611R'
pdf  c                   parm                    l_filg
pdf  c                   parm                    l_outq
6.44 c                   parm                    w_dtray
6.44 c                   parm                    w_gtray
6.44  * Hent inn skuffinformasjon for skriveren - default inskuff
6.2D c                   eval      w_draw1 = *blank
6.2D c                   movel     w_dtray       w_skuf
6.44 c                   call      'AP614R'
6.44 c                   parm                    l_outq
6.2D c                   parm                    w_skuf
6.44 c                   parm                    w_draw1
6.44  * Hent inn skuffinformasjon for skriveren - giroskuff
6.44 c                   eval      w_draw2 = *blank
6.2D c                   movel     'GIROSKUFF'   w_giro
6.44 c                   call      'AP614R'
6.44 c                   parm                    l_outq
6.2D c                   parm                    w_giro
6.44 c                   parm                    w_draw2
6.2Q  * Sjekk om giro skal skrives ?
6.2Q c                   if        a2betm <> 1 and
6.2Q c                             l_bgir = 0
6.2Q c                   eval      w_draw2 = *blanks
6.2Q c                   endif
6.2Q  * Kreditnota
6.2Q c                   if        *in36 = *on
6.2Q c                   eval      w_draw2 = *blanks
6.2Q c                   endif
pdf   *
pdf   /Free
pdf    // Finn print informasjon
pdf    UpdHTMLVar('Printername':         l_outq);
pdf    UpdHTMLVar('Copies':       %char(l_akop));
pdf    UpdHTMLVar('Papersource':        w_draw1);
pdf    UpdHTMLVar('Lastpagedrawer':     w_draw2);
pdf    UpdHTMLVar('Duplex':             'false');
pdf    UpdHTMLVar('Quality':                ' ');
pdf    UpdHTMLVar('Sorting':                ' ');
pdf    UpdHTMLVar('Staple':              'true');
pdf    UPDHTMLVar('Alignment':           w_land);
pdf    WrtSection('PrintCommand');
pdf   /End-free
6.18 c                   endif
6.31 c                   endif
6.39 c                   endif
pdf  c                   endif
7.01 c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading faktura         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head_inv  begsr
pdf   *
6.27 c                   eval      w_ptxt1 = *blanks
6.27 c                   eval      w_ptxt2 = *blanks
6.27 c                   eval      w_ptxt3 = *blanks
6.27 c                   eval      w_ptxt4 = *blanks
6.27 c                   eval      w_ppers = *blanks
6.27 c                   eval      w_pemne = *blanks
pdf   *
pdf  c                   eval      w_mtxt = *blanks
pdf  c                   eval      x_numm = %char(a1numm)+a1suff
pdf    //                eval      x_vref = %char(a1selg)+' '+a1vref
6.23 c                   eval      w_selgn = %trim(%char(a1selg) + x_mobi)
pdf  c     *hms          move      sotime        w_time
pdf  c**                 eval      x_betb = a1btx1 + ' ' + a1btx2
pdf   *
pdf   * Hvis mail skal skrives, må vi hente mail informasjon
pdf   *
pdf  c                   if        l_mail = 1
pdf  c                   eval      p_kule = 'K'
pdf  c                   eval      p_kund = a1kund
pdf  c                   eval      p_kpro = a1kpro
6.2A c**                 eval      p_numm = sonumm
6.2A c                   eval      p_numm = sobinr
pdf  c                   eval      p_selg = soselg
pdf   * Henter tilbake mailserver
pdf  c                   eval      p_serv = *blank
pdf  c                   eval      p_stat = *blank
pdf  c                   call      'AM705C'
pdf  c                   parm                    p_serv
pdf  c                   parm                    p_stat
pdf   *
6.36 c                   eval      p_in03 = *off
pdf  c                   call      'FO798R'
pdf  c                   parm                    p_kule
pdf  c                   parm                    p_kund
pdf  c                   parm                    p_kpro
pdf  c                   parm                    p_numm
6.3a c                   parm                    p_suff
pdf  c                   parm                    p_selg
pdf  c                   parm                    p_navn
pdf  c                   parm                    p_emal
6.3a c                   parm                    p_ema2
6.3a c                   parm                    p_ema3
pdf  c                   parm                    p_emne
pdf  c                   parm                    p_txt1
pdf  c                   parm                    p_txt2
pdf  c                   parm                    p_txt3
pdf  c                   parm                    p_txt4
pdf  c                   parm                    p_pers
6.3a c                   parm                    p_kopi
pdf  c                   parm                    p_inif
pdf  c                   parm                    p_in03
6.27  * Scann av strenger
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_emne        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_pemne
6.27  *
6.27  * Scann av strenger
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_txt1        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_ptxt1
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_txt2        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_ptxt2
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_txt3        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_ptxt3
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_txt4        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_ptxt4
6.27  *
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     p_pers        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_ppers
6.27  *
6.27 c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
6.27 c                                      %trim(w_ptxt2) + crlf +
6.27 c                                      %trim(w_ptxt3) + crlf +
6.27 c                                      %trim(w_ptxt4) + crlf +
6.27 c                                      %trim(w_ppers)
pdf   *
6.3a c                   if        p_kopi = *blanks
6.3a c                   eval      p_kopi = d_emal
pdf  c                   endif
pdf   *
pdf  c                   if        p_in03 = *off
pdf   *
pdf   /Free
pdf    // Skriv mailinformasjon
6.3a   WrtSection('MailCommandStart');
6.3a   //   UpdHTMLVar('Receivers':           p_emal);
6.3a   if %Trim(p_emal)<> *blanks;
6.3a     UpdHTMLVar('Receivers':           p_emal);
6.3a     WrtSection('MailReceiver');
6.3a   endif;
6.3a   if %Trim(p_ema2)<> *blanks;
6.3a     UpdHTMLVar('Receivers':           p_ema2);
6.3a     WrtSection('MailReceiver');
6.3a   endif;
6.3a   if %Trim(p_ema3)<> *blanks;
6.3a     UpdHTMLVar('Receivers':           p_ema3);
6.3a     WrtSection('MailReceiver');
6.3a   endif;
pdf    UpdHTMLVar('CC':                     ' ');
6.3a   UpdHTMLVar('BCC':                 p_kopi);
6.3a   UpdHTMLVar('Sender':              p_kopi);
6.27   //    UpdHTMLVar('Subject':             p_emne);
6.27   UpdHTMLVar('Subject':             w_pemne);
pdf    UpdHTMLVar('Message':             w_mtxt);
pdf    UpdHTMLVar('SMTPServer':          p_serv);
pdf    UPDHTMLVar('SMTPUser':               ' ');
pdf    UPDHTMLVar('SMTPPw':                 ' ');
6.3a   //   WrtSection('MailCommand');
6.3a   WrtSection('MailCommandEnd');
pdf   /End-free
pdf  c                   endif
pdf  c                   endif
7.01  * FTP overføring
7.01 c                   if        u_701 = *on
7.01 c                   if        d_kopi <> 'K'
7.0a  * hvis u_70a er *off blir alle ftp (default)
7.0a  * hvis u_70a er *on blir de med sofaty > 0 ftp,
7.0a  *                        de med sofaty = 0 print
7.13 c                   if        ((sofaty <> 0) or (u_70a = *off)) or
7.13 c                             ((sofaty = 0) and (w_faty = '2'))
7.01 c                   eval      w_fname = 'faktura_' +
7.01 c                             %char(sobinr) + '.xml'
8.08 c                   eval      b_ftp = *on
8.08 c                   endif
8.08 c                   endif
8.08 c                   endif
8.08  *
8.08  * Henter FTP informasjon fra koderegister hvis iizy
8.08  *
8.08    if u_803 = *on and
8.08       b_fact = *off;
8.08         w_host = w_fftp;
8.08         w_usr = w_fusr;
8.08         w_pwd = w_fpwd;
8.08         w_fname = 'Faktura_' + %char(sobinr) + '.xml';
8.08         b_ftp = *on;
8.08         endif;
7.01  /Free
7.01   // Skriv FTP informasjon
8.08   if b_ftp = *on;
7.01     UpdHTMLVar('Host':  w_host);
7.01     UpdHTMLVar('User':  w_usr);
7.01     UpdHTMLVar('Password': w_pwd);
7.01     UpdHTMLVar('Folder':   w_fldr);
7.01
7.01     UpdHTMLVar('Filename':     %trim(w_fname));
7.01     UpdHTMLVar('Usetempsuffix':       'false');
7.01     UpdHTMLVar('Sendonlyattachements': 'false');
7.01     WrtSection('FtpCommand');
8.08   endif;
7.01  /End-free
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Firma
6.17 c                   eval      w_1fnav = *blank
6.17 c                   eval      w_1fad1 = *blank
6.17 c                   eval      w_1fad2 = *blank
6.17 c                   eval      w_1navn = *blank
6.17 c                   eval      w_1gate = *blank
6.17 c                   eval      w_1adr2 = *blank
6.17 c                   eval      w_2navn = *blank
6.17 c                   eval      w_2adr1 = *blank
6.17 c                   eval      w_2adr2 = *blank
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fnav        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_1fnav
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fad1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_1fad1
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1fad2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.17 c                   movel     p_str_out     w_1fad2
      *
      * Vi må oversette aktuelle tekster til "xml" tegn - Partner
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1navn        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.17 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_1navn
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1gate        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_1gate
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a1adr2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_1adr2
      *
7.11 c                   eval      w_1dref = *blank
7.11 c                   eval      p_str_in = *blank
7.11 c                   eval      p_lr = '0'
7.11 c                   movel     a1dref        p_str_in
7.11 c                   call      'AP613R'
7.11 c                   parm                    p_str_in
7.11 c                   parm                    p_str_out
7.11 c                   parm                    p_lr
7.11 c                   movel     p_str_out     w_1dref
      *
6.1E c                   eval      p_str_in = *blank
6.1E c                   eval      p_lr = '0'
6.1E c                   movel     a1vref        P_str_in
6.1E c                   call      'AP613R'
6.1E c                   parm                    p_str_in
6.1E c                   parm                    p_str_out
6.1E c                   parm                    p_lr
6.1E c                   movel     p_str_out     w_1vref
      * Avdelingsinformasjon - navn
6.2B c                   eval      p_str_in = *blank
6.2B c                   eval      p_lr = '0'
6.2B c                   movel     w_dnavn       P_str_in
6.2B c                   call      'AP613R'
6.2B c                   parm                    p_str_in
6.2B c                   parm                    p_str_out
6.2B c                   parm                    p_lr
6.2B c                   movel     p_str_out     w_dnavn
      * Avdelingsinformasjon - adresse
6.2B c                   eval      p_str_in = *blank
6.2B c                   eval      p_lr = '0'
6.2B c                   movel     w_dadr1       P_str_in
6.2B c                   call      'AP613R'
6.2B c                   parm                    p_str_in
6.2B c                   parm                    p_str_out
6.2B c                   parm                    p_lr
6.2B c                   movel     p_str_out     w_dadr1
      * Avdelingsinformasjon - adresse 2
6.2B c                   eval      p_str_in = *blank
6.2B c                   eval      p_lr = '0'
6.2B c                   movel     w_dadr2       P_str_in
6.2B c                   call      'AP613R'
6.2B c                   parm                    p_str_in
6.2B c                   parm                    p_str_out
6.2B c                   parm                    p_lr
6.2B c                   movel     p_str_out     w_dadr2
      * Avdelingsinformasjon - poststed
6.2B c                   eval      p_str_in = *blank
6.2B c                   eval      p_lr = '0'
6.2B c                   movel     w_dpstd       P_str_in
6.2B c                   call      'AP613R'
6.2B c                   parm                    p_str_in
6.2B c                   parm                    p_str_out
6.2B c                   parm                    p_lr
6.2B c                   movel     p_str_out     w_dpstd
7.01  * Finner mailadresser
8.06 c**                 if        u_702 = *on
7.02 c                   eval      w_emal = rkemal
8.06 c                   if        u_702 = *on
7.02  * prøver først å finne mail på kontaktperson - rolle EMAIL
7.02 c                   eval      w_krol = 'EMAIL1'
7.02 c                   call      'RS752R  '
7.02 c                   parm                    w_firm
7.02 c                   parm                    sokund
7.02 c                   parm                    w_krol
7.02 c                   parm                    w_maip
7.02  *
7.02 c                   if        %trim(w_maip) <> *blank
7.02 c                   eval      w_emal = %trim(w_maip)
7.02 c                   else
7.02  * prøver å finne mailadresse 2
7.02 c                   eval      w_krol = 'EMAIL2'
7.02 c                   call      'RS752R  '
7.02 c                   parm                    w_firm
7.02 c                   parm                    sokund
7.02 c                   parm                    w_krol
7.02 c                   parm                    w_maip
7.02 c                   if        %trim(w_maip) <> *blank
7.02 c                   eval      w_emal = %trim(w_maip)
7.02 c                   endif
7.02 c                   endif
7.02  * Blanker mailadresse hvis fakturatype 21.
7.02 c                   if        rkfaty = 21
7.02 c                   eval      w_emal = *blanks
7.02 c                   endif
7.02 c                   endif
pdf   /Free
pdf
pdf    // Skriv firmavariabler
6.35   UpdHTMLVar('Reporttext':            a1txt1);
6.17   UpdHTMLVar('CompanyName':          w_1fnav);
6.17   UpdHTMLVar('Companyadress1':       w_1fad1);
6.17   UpdHTMLVar('Companyadress2':       w_1fad2);
pdf    UpdHTMLVar('Companypostalcode':        ' ');
pdf    UpdHTMLVar('Companypostoffice':     a1fste);
pdf    UpdHTMLVar('Companyphone':          a1ftlf);
pdf    UpdHTMLVar('Companyfax':            a1ffax);
pdf    UpdHTMLVar('Companyorgno':          a1fftx);
pdf    UpdHTMLVar('Companygiro':    %char(a1fbgi));
6.3c   UpdHTMLVar('Companyemail':   %trim(w_mail));
6.3c   UpdHTMLVar('Companywebpage': %trim(w_weba));
6.2B   WrtSection('Company');
6.2B
6.2B   UpdHTMLVar('Departmentno':    %char(soavde));
6.2B   UpdHTMLVar('Departmentname':        w_dnavn);
6.2B   UpdHTMLVar('Departmentadress1':     w_dadr1);
6.2B   UpdHTMLVar('Departmentadress2':     w_dadr2);
6.2B   UpdHTMLVar('Departmentpostalcode':      ' ');
6.2B   UpdHTMLVar('Departmentpostoffice':  w_dpstd);
6.2B   UpdHTMLVar('Departmentphone':       w_dphon);
6.2B   UpdHTMLVar('Departmentfax':         w_dfaxn);
6.2B   WrtSection('Department');
pdf
pdf    test(de) *dmy a1fkda;
pdf    if %error;
pdf      tmpdate = *loval;
pdf    else;
pdf      tmpdate = %date(a1fkda : *dmy);
pdf    endif;
pdf    UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));
pdf
pdf    test(te) *hms w_time;
pdf    if %error;
pdf      tmptime = *loval;
pdf    else;
pdf      tmptime = %time(w_time : *hms);
pdf    endif;
pdf    UpdHTMLVar('Creationtime': %char(tmptime : *hms));
pdf    WrtSection('Creation');
8.08  *
8.08  * Splitter postnr og sted hvis det er valgt i kodesetting
8.08  *
8.08    if u_803 = *on and
8.08       b_fact = *off and
8.08       w_fspl = 'J';
8.08       w_ponr = %subst(a1sted:1:4);
8.08       w_pste = %subst(a1sted:6:25);
8.08     else;
8.08      if (u_707 = *on);
8.08       w_ponr = %char(a2lety);
8.08       else;
8.08       w_ponr = ' ';
8.08      endif;
8.08       w_pste = a1sted;
8.08    endif;
pdf
pdf    // Skriv partnerinfo (kunde)
8.08   if b_ftp = *on;
7.01     UpdHTMLVar('PartnerOrgNo':    %char(rkftnr));
7.01     UpdHTMLVar('PartnerGLNNo':    %char(rkeank));
7.01   endif;
pdf    UpdHTMLVar('Partnerno':       %char(a1kund));
pdf    UpdHTMLVar('Partnercategory': %char(rkkatg));
6.17   UpdHTMLVar('Partnername':          w_1navn);
6.17   UpdHTMLVar('Partneradress1':       w_1gate);
6.17   UpdHTMLVar('Partneradress2':       w_1adr2);
8.08   UpdHTMLVar('Partnerpostalcode':    w_ponr);
8.08   UpdHTMLVar('Partnerpostoffice':    w_pste);
pdf    UpdHTMLVar('Partnerphone':           rktlfn);
8.03   UpdHTMLVar('Partnercellphone':       rkmobn);
pdf    UpdHTMLVar('Partnerfax':             rktlfx);
pdf    UpdHTMLVar('Salesdocumentno': %char(a1binr));
6.27   UpdHTMLVar('Partnerrefname':        w_1dref);
pdf    UpdHTMLVar('Partnerrefphone':           ' ');
8.07   // if (u_702 = *on);
7.02     UpdHTMLVar('Partnerrefmail':         w_emal);
8.07   // else;
8.07   // UpdHTMLVar('Partnerrefmail':            ' ');
8.07   // endif;
pdf    WrtSection('Partner');
pdf
pdf    // Selger informasjon
6.38   UpdHTMLVar('Salesrefno':           w_selgn);
6.1E   UpdHTMLVar('Salesrefname':         w_1vref);
6.2B   UpdHTMLVar('Salesrefemail':         raiema);
6.2B   UpdHTMLVar('Salesrefcellphone':     raimob);
pdf    WrtSection('SalesRef');
pdf   /End-free
6.3h  * Flyttet start
6.1d c                   eval      p_str_in = *blank
6.1d c                   eval      p_lr = '0'
6.1d c                   movel     solmtx        p_str_in
6.1d c                   call      'AP613R'
6.1d c                   parm                    p_str_in
6.1d c                   parm                    p_str_out
6.1d c                   parm                    p_lr
6.1d c                   movel     p_str_out     w_lmtx
      *
6.2B c                   eval      p_str_in = *blank
6.2B c                   eval      p_lr = '0'
6.2B c                   movel     solbtx        p_str_in
6.2B c                   call      'AP613R'
6.2B c                   parm                    p_str_in
6.2B c                   parm                    p_str_out
6.2B c                   parm                    p_lr
6.2B c                   movel     p_str_out     w_lbtx
6.3h  * Sekvens flyttet
pdf  c                   if        %trim(a2navn) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Prosjekt
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2navn        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_2navn
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2adr1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_2adr1
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     a2adr2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_2adr2
      *
6.1b c                   eval      p_str_in = *blank
6.1b c                   eval      p_lr = '0'
6.1b c                   movel     a2sted        p_str_in
6.1b c                   call      'AP613R'
6.1b c                   parm                    p_str_in
6.1b c                   parm                    p_str_out
6.1b c                   parm                    p_lr
6.1b c                   movel     p_str_out     w_2sted
pdf   *
pdf   /Free
pdf    // Prosjekt informasjon
pdf    UpdHTMLVar('Projectno':      %char(a1kpro));
6.17   UpdHTMLVar('Projectname':          w_2navn);
6.17   UpdHTMLVar('Projectadress1':       w_2adr1);
6.17   UpdHTMLVar('Projectadress2':       w_2adr2);
pdf    UpdHTMLVar('Projectpostalcode':        ' ');
6.1b   //    UpdHTMLVar('Projectpostoffice':     a2sted);
6.1b   UpdHTMLVar('Projectpostoffice':    w_2sted);
pdf    WrtSection('Project');
pdf   /End-free
pdf  c                   endif
pdf   /Free
6.2B   UpdHTMLVar('Currency':              sovalk);
6.2B   UpdHTMLVar('Discountcat':    %char(sorkat));
6.2B   UpdHTMLVar('Agent':          %char(sosped));
6.2B   WrtSection('InfoHead1');

6.2B   UpdHTMLVar('Deliverymethod':               w_lmtx);
6.2B   test(de) *dmy w_ldat;
6.2B   if %error;
6.2B     tmpdate = *loval;
6.2B   else;
6.2B     tmpdate = %date(w_ldat : *dmy);
6.2B   endif;
6.2B   UpdHTMLVar('Deliverydate':   %char(tmpdate : *iso));
6.2B   UpdHTMLVar('Deliverytype':           %char(solety));
6.2B   UpdHTMLVar('Deliveryterms':                 w_lbtx);
6.2B   UpdHTMLVar('Drivingroute':           %char(sokjor));
6.2B   WrtSection('DeliveryInfo');
pdf
6.2B   UpdHTMLVar('District':       %char(sodist));
6.2B   UpdHTMLVar('Warehouse':      %char(solage));
6.2O   //    UpdHTMLVar('Documenttype':          sootyp);
6.2O   UpdHTMLVar('Documenttype':   %trim(w_copy));
pdf    test(de) *dmy a1ffda;
pdf    if %error;
pdf      tmpdate = *loval;
pdf    else;
pdf      tmpdate = %date(a1ffda : *dmy);
pdf    endif;
pdf    UpdHTMLVar('Duedate':   %char(tmpdate : *iso));
pdf    UpdHTMLVar('Paymentcondition':         a1ctxt);
6.1d   UpdHTMLVar('Deliverymethod':           w_lmtx);
pdf    UpdHTMLVar('Discountcategory':  %char(sorkat));
pdf    WrtSection('InfoHead2');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Heading ordre           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_head_ord  begsr
pdf   *
pdf  c                   eval      x_numm = %char(a1numm)+a1suff
pdf  c                   eval      b_ordr = *on
      *
6.27 c                   eval      w_1dref = *blank
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     a1dref        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_1dref
      *
6.27 c                   eval      w_1vref = *blank
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     a1vref        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_1vref
      *
6.27 c                   eval      w_rekv = *blank
6.27 c                   eval      p_str_in = *blank
6.27 c                   eval      p_lr = '0'
6.27 c                   movel     a1rekv        p_str_in
6.27 c                   call      'AP613R'
6.27 c                   parm                    p_str_in
6.27 c                   parm                    p_str_out
6.27 c                   parm                    p_lr
6.27 c                   movel     p_str_out     w_rekv
      *
6.2t c                   eval      w_epro = *blank
7.04 c                   eval      x_epro = *blank
7.04 c                   eval      x_epro = %trim(%trim(a1epro)+' '+
7.04 c                             %trim(sonavn))
6.2t c                   eval      p_str_in = *blank
6.2t c                   eval      p_lr = '0'
7.04 c                   if        u_704 = *on
7.04 c                   movel     x_epro        p_str_in
7.04 c                   else
6.2t c                   movel     a1epro        p_str_in
7.04 c                   endif
6.2t c                   call      'AP613R'
6.2t c                   parm                    p_str_in
6.2t c                   parm                    p_str_out
6.2t c                   parm                    p_lr
6.2t c                   movel     p_str_out     w_epro
      *
7.10 c                   eval      w_lmt1 = *blank
7.10 c                   eval      p_str_in = *blank
7.10 c                   eval      p_lr = '0'
7.10 c                   movel     a1lmtx        p_str_in
7.10 c                   call      'AP613R'
7.10 c                   parm                    p_str_in
7.10 c                   parm                    p_str_out
7.10 c                   parm                    p_lr
7.10 c                   movel     p_str_out     w_lmt1
pdf   *
pdf   /Free
pdf    // Ordreheading informasjon
pdf    UpdHTMLVar('Orderno':                  x_numm);
pdf    test(de) *dmy a1bdat;
pdf    if %error;
pdf      tmpdate = *loval;
pdf    else;
pdf      tmpdate = %date(a1bdat : *dmy);
pdf    endif;
pdf    UpdHTMLVar('Orderdate': %char(tmpdate : *iso));
pdf
pdf    test(de) *dmy a1ldat;
pdf    if %error;
pdf      tmpdate = *loval;
pdf    else;
pdf      tmpdate = %date(a1ldat : *dmy);
pdf    endif;
pdf    UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
pdf    UpdHTMLVar('Salespersonno':        %char(a1selg));
6.27   //   UpdHTMLVar('Salespersonname':             a1vref);
6.27   UpdHTMLVar('Salespersonname':            w_1vref);
6.27   UpdHTMLVar('Customerreference':          w_1dref);
pdf    UpdHTMLVar('Department':           %char(a1avde));
6.3b   UpdHTMLVar('Store':                %char(a1lage));
7.10   // UpdHTMLVar('Deliverytype':                  a1lmtx);
7.10   UpdHTMLVar('Deliverytype':         %trim(w_lmt1));
pdf    UpdHTMLVar('Deliverycondition':           a1lbet);
pdf    UpdHTMLVar('Customerproject':      %char(a1kpro));
6.2t   //   UpdHTMLVar('Externalproject':             a1epro);
6.2t   UpdHTMLVar('Externalproject':             w_epro);
6.27   UpdHTMLVar('Requisitionno':               w_rekv);
pdf    WrtSection('OrderStart');
pdf
pdf    //  Legg ut 'heading' på linje
pdf    WrtSection('InvoiceLines');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Detaljer                *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_deta      begsr
pdf   * Sørg for at vi har skrevet siste tag for topptext før vi begynner
pdf   * med detaljer.
pdf  c                   if        b_topt = *on
pdf  c                   exsr      xml_topt_end
pdf  c                   eval      b_topt = *off
pdf  c                   endif
pdf   *
pdf  c                   if        valktx <> 1
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Varetekster
6.17 c                   eval      w_tek1 = *blank
6.17 c                   eval      w_tek2 = *blank
      *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_tek1
pdf   *
pdf  c                   if        d1tek2 <> *blank
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_tek2
pdf  c                   endif
6.2N  * Scann av leverenadørens varenummer
6.2N c                   eval      p_str_in = *blank
6.2N c                   eval      p_lr = '0'
6.3l c                   if        w_lv_nobb <> 0
6.3l c                   movel     w_lv_llva     p_str_in
6.3l c                   eval      w_nobb = w_lv_nobb
6.3l c                   else
6.2N c                   movel     vvlvar        p_str_in
6.3l c                   eval      w_nobb = vvnobb
6.3l c                   endif
6.2N c                   call      'AP613R'
6.2N c                   parm                    p_str_in
6.2N c                   parm                    p_str_out
6.2N c                   parm                    p_lr
6.2N c                   movel     p_str_out     w_lvar
pdf   *
pdf  c                   eval      w_mark = 'false'
pdf  c                   if        d1info = '*'
pdf  c                   eval      w_mark = 'true '
pdf  c                   endif
6.32  * Hvis nettopriset kunde, skal ikke rabatten vises
6.32 c                   if        *in39 = *on
6.32 c                   eval      d1rabp = 0
6.32 c                   endif
pdf   * Håndtere riktig antall desimaler
pdf  c                   if        *in40 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant0))
pdf  c                   callp     updHTMLVar('NoDecimals':        '0')
pdf  c                   elseif    *in41 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant1))
pdf  c                   callp     updHTMLVar('NoDecimals':        '1')
pdf  c                   elseif    *in42 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant2))
pdf  c                   callp     updHTMLVar('NoDecimals':        '2')
pdf  c                   elseif    *in43 = *on
pdf  c                   callp     updHTMLVar('Quantity':%char(d1ant3))
pdf  c                   callp     updHTMLVar('NoDecimals':        '3')
pdf  c                   endif
6.2B  *
6.2B c                   if        sdldat <> *loval
6.2B c     *dmy          move      sdldat        w_lddt
6.2B c                   endif
6.2B  * Henter inn GTIN nummer
6.2B c                   eval      p_firm = l_firm
6.2B c                   eval      p_ldor = *zeros
6.2B c                   eval      p_vare = sdvare
6.2B c                   eval      p_enhe = sdenh1
6.2B c                   eval      p_gtin = *zeros
6.2B c                   eval      p_stat = *blanks
6.2B  *
6.2B c                   call      'VE713R'
6.2B c                   parm                    p_firm
6.2B c                   parm                    p_ldor
6.2B c                   parm                    p_vare
6.2B c                   parm                    p_enhe
6.2B c                   parm                    p_gtin
6.2B c                   parm                    p_stat
6.2B  *
6.2B c                   eval      w_gtin = p_gtin
pdf   *
pdf   /Free
pdf    // Skriv detaljer
6.2B   WrtSection('LineStart');
6.2B
6.2B   // Ved spesialer legges disse i freedef tagger
6.2B   WrtSection('LineFreeDef');
pdf
pdf    UpdHTMLVar('Itemno':             d1vare);
6.17   UpdHTMLVar('Text1':              w_tek1);
6.17   UpdHTMLVar('Text2':              w_tek2);
pdf    UpdHTMLVar('Unit':                d1enh1);
pdf    UpdHTMLVar('VAT':          %char(w_mvas));
pdf    UpdHTMLVar('Bookingno':   %char(sdbenr));
6.1F   UpdHTMLVar('Linetype':     %char(sdlety));
pdf    UpdHTMLVar('Priceexvat':   %char(d1bpri));
6.43   UpdHTMLVar('Grosspriceexvat':%char(d3bpri));
pdf    UpdHTMLVar('Discount1':     %char(d1rabp));
pdf    UpdHTMLVar('Discount2':            '0.00');
pdf    UpdHTMLVar('Discountremark':     d1tine);
pdf    UpdHTMLVar('Netamount':    %char(d1nbel));
pdf    UpdHTMLVar('Additionalfee':        '0.00');
pdf    UpdHTMLVar('Totalsum':     %char(d1nbel));
pdf    UpdHTMLVar('DiscountAccounting': %trim(w_mark));
6.20   UpdHTMLVar('Grossamount':  %char(d1bbel));
6.2B   UpdHTMLVar('Currency':            sovalk);
6.3l   UpdHTMLVar('Nobbno':        %char(w_nobb));
6.2B   UpdHTMLVar('Lineno':        %char(sdline));
6.2N   UpdHTMLVar('Warehouseline': %char(sdlage));
6.2B   test(de) *dmy w_lddt;
6.2B   if %error;
6.2B     tmpdate = *loval;
6.2B   else;
6.2B     tmpdate = %date(w_lddt : *dmy);
6.2B   endif;
6.2B   UpdHTMLVar('Deliverydate': %char(tmpdate : *iso));
6.2N   //    UpdHTMLVar('Partneritemno':       vvlvar);
6.2N   UpdHTMLVar('Partneritemno': %trim(w_lvar));
6.2B   UpdHTMLVar('Campaign':               ' ');
6.2B   UpdHTMLVar('Gtin':           %char(w_gtin));
6.2B   //     WrtSection('Line');
6.2B   WrtSection('LineRest');
pdf
pdf   /End-free
pdf   *
pdf  c                   else
6.17 c                   eval      w_tek1 = *blank
6.17 c                   eval      w_tek2 = *blank
pdf  c                   movel     sdtek1        d1tek1
pdf  c                   movel     sdtek2        d1tek2
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Tekstlinjer
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_tek1
pdf   *
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c                   movel     p_str_out     w_tek2
6.1H c                   if        %subst(d1tek1:35:1) = ' ' or
6.1H c                             %subst(d1tek2:1:1) = ' '
6.1H c                   eval      w_tek0 = %trim(w_tek1) + ' ' + %trim(w_tek2)
6.1H c                   else
6.1H c                   eval      w_tek0 = %trim(w_tek1) + %trimr(w_tek2)
6.1H c                   endif
pdf   *
pdf   /Free
6.26   UpdHTMLVar('Text1':       %trim(w_tek0));
6.26   UpdHTMLVar('Text2':                 ' ');
pdf    WrtSection('TextLine');
pdf
pdf   /End-free
pdf   *
pdf  c                   endif
pdf   *
pdf  c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt             *
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrdisc   begsr
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21   UpdHTMLVar('Text1':     'Bruksrettrabatt');
6.21   UpdHTMLVar('Userdiscount1': %char(d1brr1));
6.21   UpdHTMLVar('Userdiscount2': %char(d1brr2));
6.21   WrtSection('LineUserDiscount');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt oppsummering*
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrsum1   begsr
6.2e  * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
6.2e  * avslutter.
6.2e c                   if        b_bott = *on
6.2e c                   exsr      xml_bott_end
6.2e c                   eval      b_bott = *off
6.2e c                   endif
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21   UpdHTMLVar('Usersummarytext':          d3tek1);
6.21   UpdHTMLVar('Usersummarybasis':  %char(d3bgr1));
6.21   UpdHTMLVar('Usersummaryamount': %char(d3brb1));
6.21   WrtSection('UserDiscountSummary');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21  * Subrutiner for XML/jasper integrasjon - bruksrabatt oppsummering*
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.21 c     xml_usrsum2   begsr
6.2e  * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
6.2e  * avslutter.
6.2e c                   if        b_bott = *on
6.2e c                   exsr      xml_bott_end
6.2e c                   eval      b_bott = *off
6.2e c                   endif
6.21  *
6.21 c*                  eval      p_str_in = *blank
6.21 c*                  eval      p_lr = '0'
6.21 c*                  movel     d1tek2        p_str_in
6.21 c*                  call      'AP613R'
6.21 c*                  parm                    p_str_in
6.21 c*                  parm                    p_str_out
6.21 c*                  parm                    p_lr
6.21 c*                  movel     p_str_out     w_tek2
6.21  *
6.21  /Free
6.21   UpdHTMLVar('Usersummarytext':          d3tek2);
6.21   UpdHTMLVar('Usersummarybasis':  %char(d3bgr2));
6.21   UpdHTMLVar('Usersummaryamount': %char(d3brb2));
6.21   WrtSection('UserDiscountSummary');
6.21
6.21  /End-free
6.21  *
6.21 c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Sluttagg for ordren     *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_ordr_end  begsr
6.2G  * Sørg for at vi har skrevet siste tag for topptext før vi begynner
6.2G  * med detaljer.
6.2G c                   if        b_topt = *on
6.2G c                   exsr      xml_topt_end
6.2G c                   eval      b_topt = *off
6.2G c                   endif
6.33  * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
6.33  * avslutter.
6.33 c                   if        b_bott = *on
6.33 c                   exsr      xml_bott_end
6.33 c                   eval      b_bott = *off
6.33 c                   endif
pdf   *
pdf   /Free
pdf    // Avslutt ordren
pdf    WrtSection('OrderEnd');
pdf
pdf   /End-free
6.30 c**                 eval      b_ordr = *off
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Rabatt                  *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_rabatt    begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
6.30 c**                 eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf    // Skriv rabattlinjer
pdf    UpdHTMLVar('Discountinpercent':   %char(r1rabp));
pdf    UpdHTMLVar('Discountbasis':       %char(r1rabg));
pdf    UpdHTMLVar('Sumdiscount':         %char(r1rabb));
pdf    WrtSection('DiscountLine');
pdf
pdf   /End-free
pdf   *
6.30  * Sørg for at vi har skrevet siste tag for ordren før vi
6.30  * avslutter.
6.30 c                   if        b_ordr = *on
6.30 c                   exsr      xml_oend_tag
6.30 c                   eval      b_ordr = *off
6.30 c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Depositum               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_depositum begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
pdf  c                   exsr      xml_oend_tag
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf    // Netto
pdf    UpdHTMLVar('DepositTotal':         %char(r2totb));
pdf    UpdHTMLVar('DepositAmount':        %char(r2dept));
pdf    WrtSection('Depositum');
pdf   /End-free
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Netto                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_netto     begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Sørg for at vi har skrevet siste tag for ordren før vi begynner
pdf   * avslutter.
pdf  c                   if        b_ordr = *on
pdf  c                   exsr      xml_ordr_end
6.30 c                   exsr      xml_oend_tag
pdf  c                   eval      b_ordr = *off
pdf  c                   endif
pdf   *
pdf   /Free
pdf    // Netto
pdf    UpdHTMLVar('Sumnettoexcvat':       %char(t1tnet));
6.20   UpdHTMLVar('Sumnettoexcvatexcdiscount': %char(t5tnet));
pdf    WrtSection('NettoLine');
pdf   /End-free
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Vat                     *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_vat       begsr
pdf   *
pdf   /Free
pdf    // Skriv mva grunnlag 1
pdf    UpdHTMLVar('Vatpercent':            %char(t1mvas));
6.20   UpdHTMLVar('Vatpercentexcdiscount': %char(t5mvas));
pdf    UpdHTMLVar('Vatbasis':              %char(t1mvag));
6.20   UpdHTMLVar('Vatbasisexcdiscount':   %char(t5mvag));
pdf    UpdHTMLVar('Sumvat':                %char(t1mvab));
6.20   UpdHTMLVar('Sumvatexcdiscount':     %char(t5mvab));
pdf    WrtSection('VatLine');
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Totaler                 *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_totaler   begsr
6.2c  * Beregner øreavrunding. NBNBNBNB Denne kan avvike fra den som er kalkulert
6.2c  * i FO616R. Brukes ikke standard i iReport malen.
6.2c c                   eval      w_avrd=0
6.3g c**                 eval      w_avrd=t1fsum-t1tmva-t1tnet
6.3g c                   eval      w_avrd=t1fsum-t1tmva-t1tnet+sodept
pdf   *
pdf   /Free
pdf    // Skriv totallinje
pdf    UpdHTMLVar('Sumtotal':                    %char(t1fsum));
6.20   UpdHTMLVar('Sumtotalexcdiscount':         %char(t5fsum));
pdf    UpdHTMLVar('Sumvattotal':                 %char(t1tmva));
6.20   UpdHTMLVar('Sumvattotalexcdiscount':      %char(t5tmva));
pdf    UpdHTMLVar('Sumvatbasistotal':            %char(t1tnet));
6.20   UpdHTMLVar('Sumvatbasistotalexcdiscount': %char(t5tnet));
6.1A   UpdHTMLVar('Checknumber':                       t1bsif);
6.2c   UpdHTMLVar('Rounding':                    %char(w_avrd));
pdf    WrtSection('TotalLine');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst start         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topt_str  begsr
pdf   *
pdf   /Free
pdf    // Skriv tekstlinjer
pdf    WrtSection('TopTextStart');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topptxt   begsr
pdf   *
6.2K c                   eval      w_ttx1 = *blank
6.2K c                   eval      w_ttx2 = *blank
pdf   *
pdf  c                   if        %trim(d1tek1) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.1G c                   eval      w_ttx1 = *blank
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.1G c                   movel     p_str_out     w_ttx1
6.1G c                   endif
6.1G  *
6.1G  * Flyttet for å slå sammen begge linjene da de hører sammen
6.1G  *
6.1G c                   if        %trim(d1tek2) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Topptekst
6.1G c                   eval      w_ttx2 = *blank
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.1G c                   movel     p_str_out     w_ttx2
6.1G c                   endif
6.1G  * Så slår vi sammen linjene
6.1G c                   eval      w_ttxt = *blank
6.1G c                   eval      w_ttxt = %trim(w_ttx1) + %trim(w_ttx2)
6.1G  *
8.12 c**                 if        %trim(w_ttxt) <> *blank
pdf   /Free
pdf    // Skriv tekstlinjer 1
6.1C   //  UpdHTMLVar('Toptext':     d1tek1);
6.1C   UpdHTMLVar('Toptext':     w_ttxt);
pdf    WrtSection('TopTextLine');
pdf   /End-free
8.12 c**                 endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Topptekst slutt         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_topt_end  begsr
pdf   *
pdf   /Free
pdf    // Skriv tekstlinjer
pdf    WrtSection('TopTextEnd');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst start         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bott_str  begsr
pdf   *
pdf   /Free
pdf    // Skriv tekstlinjer
pdf    WrtSection('BottomTextStart');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst               *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bunntxt   begsr
pdf   *
6.2K c                   eval      w_ttx1 = *blanks
6.2K c                   eval      w_ttx2 = *blanks
pdf   *
pdf  c                   if        %trim(d1tek1) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek1        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.1G c                   movel     p_str_out     w_ttx1
6.1G c                   endif
      *
6.1G  * Flyttet for å slå sammen begge linjene da de hører sammen
      *
pdf  c                   if        %trim(d1tek2) <> *blank
pdf   * Vi må oversette aktuelle tekster til "xml" tegn - Bunntekst
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '0'
6.19 c                   movel     d1tek2        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.1G c                   movel     p_str_out     w_ttx2
6.1G c                   endif
6.1G  * Så slår vi sammen linjene
6.1G c                   eval      w_ttxt = *blank
6.1G c                   eval      w_ttxt = %trim(w_ttx1) + %trim(w_ttx2)
6.1G  *
6.1G c                   if        %trim(w_ttxt) <> *blank
pdf   /Free
pdf    // Skriv bunntekst
6.1C   //  UpdHTMLVar('Bottomtext':  d1tek1);
6.1C   UpdHTMLVar('Bottomtext':  w_ttxt);
pdf    WrtSection('BottomTextLine');
pdf
pdf   /End-free
pdf  c                   endif
pdf   *
pdf  c                   endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Bunntekst slutt         *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_bott_end  begsr
pdf   *
pdf   /Free
pdf    // Skriv slutt på bunntext
pdf    WrtSection('BottomTextEnd');
pdf
pdf   /End-free
pdf   *
pdf  c                   endsr
6.2J  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2J  * Subrutiner for XML/jasper integrasjon - Bunntekst               *
6.2J  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2J c     xml_btxt      begsr
6.2J  *
6.2J  * Les alle varelinjer på nytt, for å sjekke om det er bunntekst
6.2J  *
6.2J c                   eval      sodtl1_binr = sobinr
6.2J c                   eval      sodtl1_numm = sonumm
6.2J c                   eval      sodtl1_suff = sosuff
6.2J c                   eval      sodtl1_ktxt = *zero
6.2J c                   eval      sodtl1_line = *zero
6.2J  *
6.2J c     sodtl1_key    setll     sodtl1
6.2J c                   read      sodtl1                                 62
6.2J  *
6.2J c     ny_btxt_les   tag
6.2J c     *in62         cabeq     *on           xml_btxt_end
6.2J c     sdfirm        cabne     sofirm        xml_btxt_end
6.2J c     sdbinr        cabne     sobinr        xml_btxt_end
6.2J c     sdnumm        cabne     sonumm        xml_btxt_end
6.2J c     sdsuff        cabne     sosuff        xml_btxt_end
6.2J  *
6.2J c                   if        sdktxt = 5
6.2J c                   if        b_bott = *off
6.2J c                   exsr      xml_bott_str
6.2J c                   eval      b_bott = *on
6.2J c                   endif
6.2J c                   eval      d1tek1 = sdtek1
6.2J c                   eval      d1tek2 = sdtek2
6.2J c                   exsr      xml_bunntxt
6.2J c                   endif
6.2J  * Les ny linje
6.2J c                   read      sodtl1                                 62
6.2J c                   goto      ny_btxt_les
6.2J  *
6.2J c     xml_btxt_end  endsr
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Slutt                   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     xml_end       begsr
pdf   * Sørg for at vi har skrevet siste tag for bunntext før vi begynner
pdf   * avslutter.
pdf  c                   if        b_bott = *on
pdf  c                   exsr      xml_bott_end
pdf  c                   eval      b_bott = *off
pdf  c                   endif
pdf   * Giroinfo
pdf  c                   eval      w_bgir = *blanks
pdf  c                   if        l_bgir = 0
pdf  c                   eval      w_bgir = 'false'
pdf  c                   else
pdf  c                   eval      w_bgir = 'true'
pdf  c                   endif
      *
6.29 c                   if        a2betm = 1
6.29 c                   eval      w_bgir = 'true'
6.29 c                   endif
pdf   * Faktura/kreditnota
      *
6.34 c                   eval      w_kkid = t1kkid
6.29 c**                 eval      w_type = *blanks
pdf  c                   if        *in36 = *on
6.29 c                   eval      w_bgir = 'false'
6.34 c** 6.41            eval      w_kkid = *blank
6.29 c                   endif
pdf   /Free
pdf    // Skriv kid og giroinfo for alle ordre
6.34   //  UpdHTMLVar('Kidno':              t1kkid);
6.34   UpdHTMLVar('Kidno':              w_kkid);
pdf    UpdHTMLVar('Bankaccount': %char(t1fbgi));
6.2S   //    UpdHTMLVar('Invoicetype':        w_copy);
6.2S   UpdHTMLVar('Invoicetype':       w_copy2);
pdf    UpdHTMLVar('Printgiro':          w_bgir);
pdf    UpdHTMLVar('Swift':              aaswif);
pdf    UpdHTMLVar('Iban':               aaiban);
pdf    WrtSection('InvoiceEnd');
pdf   /End-free
6.20  *
6.20  * Skal det skrives materialliste på denne kunden ?
6.20  *
6.20 c                   if        a2fcop > 1 and
6.28 c                             l_kopi <> '1'
6.20  /Free
6.20   // Skriv kode for materialliste
6.20   UpdHTMLVar('Printmateriallist': 'true');
6.20   WrtSection('MaterialList');
6.20  /End-free
6.20 c                   endif
6.42  *
6.42  * Skal det skrives kundekopi skrives på denne kunden ?
6.42  *
6.42 c                   if        a2fcop = 1 or
6.42 c                             a2fcop = 3
6.42  /Free
6.42   // Skriv kode for kundekopi
6.42   UpdHTMLVar('Printkundekopi': 'true');
6.42   WrtSection('Kundekopi');
6.42  /End-free
6.42 c                   endif
6.20  *
6.20  /Free
6.20   // Skriv sluttag for faktura
6.20   WrtSection('InvoiceEndTag');
6.20  /End-free
pdf   *
pdf   * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
pdf   *
pdf  c                   if        l_arch = 1
6.16  * Lag tag for visning i arkivklienten
6.16 c                   eval      w_dspl = *blank
6.37 c                   if        *in36 = *off
6.16 c                   eval      w_dspl = 'Faktura: ' + %char(a1binr) +
6.16 c                             ' Kunde: ' +  %trim(%char(a1kund) + ' - ' +
6.16 c                             %trim(a1navn) + '  Beløp ' + %char(t1fsum))
6.37 c                   else
6.37 c                   eval      w_dspl = 'Kreditnota: ' + %char(a1binr) +
6.37 c                             ' Kunde: ' +  %trim(%char(a1kund) + ' - ' +
6.37 c                             %trim(a1navn) + '  Beløp ' + %char(t1fsum))
6.37 c                   endif
6.16  *
6.19 c**                 movel     w_dspl        w_str_in
6.19 c                   eval      p_str_in = *blank
6.19 c                   eval      p_lr = '1'
6.19 c                   movel     w_dspl        p_str_in
6.19 c                   call      'AP613R'
6.19 c                   parm                    p_str_in
6.19 c                   parm                    p_str_out
6.19 c                   parm                    p_lr
6.19 c**                 movel     w_str_out     w_dspl
6.19 c                   movel     p_str_out     w_dspl
6.2H  * Referansetagg
6.2H c                   eval      w_refn = *blank
6.2M c**                 eval      w_refn = %char(%subdt(w_date:*years)) +
6.3i c**                 eval      w_refn = %char(%subdt(sofkda:*years)) +
6.3i c                   eval      w_refn = %char(%subdt(w_fkda:*years)) +
6.2I c                             %char(a1binr)
pdf   /Free
pdf
pdf    // Skriv metattags
6.16
6.2H   UpdHTMLVar('Refno':          %trim(w_refn));
6.16   UpdHTMLVar('Displaytag':     %trim(w_dspl));
pdf    WrtSection('ArchiveCommandStart');
6.16
pdf    UpdHTMLVar('Metavalue':      %char(a1binr));
pdf    UpdHTMLVar('Metakey':      'FAKTURANUMMER');
pdf    WrtSection('MetaTag');
pdf
pdf    UpdHTMLVar('Metavalue':             l_user);
pdf    UpdHTMLVar('Metakey':             'BRUKER');
pdf    WrtSection('MetaTag');
pdf
pdf    UpdHTMLVar('Metavalue':      %char(a1kund));
pdf    UpdHTMLVar('Metakey':         'KUNDENUMMER');
pdf    WrtSection('MetaTag');
pdf
6.16   UpdHTMLVar('Metavalue':            w_1navn);
pdf    UpdHTMLVar('Metakey':          'KUNDENAVN');
pdf    WrtSection('MetaTag');
pdf
pdf    UpdHTMLVar('Metavalue':      %char(t1fsum));
pdf    UpdHTMLVar('Metakey':              'BELOP');
pdf    WrtSection('MetaTag');
pdf
pdf
pdf    UpdHTMLVar('Metavalue': %char(w_date:*iso));
pdf    UpdHTMLVar('Metakey':               'DATO');
pdf    WrtSection('MetaTag');
6.16
6.16   UpdHTMLVar('Metavalue':      %char(a1numm));
6.16   UpdHTMLVar('Metakey':        'ORDRENUMMER');
6.16   WrtSection('MetaTag');
6.35
6.35   UpdHTMLVar('Metavalue':             a1txt1);
6.35   UpdHTMLVar('Metakey':         'RUTINETEKST');
6.35   WrtSection('MetaTag');
6.2H
8.10   //UpdHTMLVar('Metavalue':             l_ruti);
8.10   UpdHTMLVar('Metavalue':             vaorut);
6.2H   UpdHTMLVar('Metakey':             'RUTINE');
6.2H   WrtSection('MetaTag');
6.2H
6.2H   UpdHTMLVar('Metavalue':             l_wsid);
6.2H   UpdHTMLVar('Metakey':             'SKJERM');
6.2H   WrtSection('MetaTag');
6.2H
6.2H   UpdHTMLVar('Metavalue':      %char(l_firm));
6.2H   UpdHTMLVar('Metakey':              'FIRMA');
6.2H   WrtSection('MetaTag');
pdf
pdf    WrtSection('ArchiveCommandEnd');
pdf   /End-free
8.11  *
8.11  * Skriv inn i tabell for bruk til søk i arkiv.
8.11  *
8.11         exec sql
8.11         insert into xlnkst
8.11           (xlfirm,xlyear,xldocn,xlbatc,
8.11            xlbatt,xlrefn,xlstmp)
8.11         values(:w_firm,:w_year,:a1binr,:w_jkey,
8.11                'FAKTURA',:w_refn,:w_stmp);
8.11         commit;
8.11  *
pdf  c                   endif
pdf   *
pdf   /Free
pdf    WrtSection('Footer');
pdf   /End-free
pdf   *
pdf   *
6.40 c                   exsr      proa_nummer
6.3j  * Hvis kopi eller fra butikk, skrives det ikke til fifo folder. Kan være
6.3j  * utilsiktet forsinkelse ved store faktureringer.
6.3k c                   eval      b_dtaq2 = *on
6.3j c                   if        l_ruti = 'BFAKT'  or
6.3j c                             l_ruti = 'BKRED'  or
6.3j c                             l_ruti = 'FFAKT1' or
6.3j c                             l_ruti = 'FKRED1'
6.3j c                   eval      d_fifo = *blanks
6.3k c                   eval      b_dtaq2 = *off
6.3j c                   endif
pdf   * Skriv xmlfila til disk
6.25 c                   if        %trim(d_fifo) = *blanks
6.25 c                   eval      XML_Output = %trim(XML_path) + l_filg +'/'+
6.40 c                             'Fakt_'+ %char(w_numm) + '.' + %char(a1binr)+
6.40 c                             '.xml'
6.40 c**                           'Fakt_'+ %trim(w_jkey) + '.xml'
6.25 c                   else
6.25 c                   eval      XML_Output = %trim(d_fifo) + '/'+
6.40 c                             'Fakt_'+%char(w_numm)+ '.' + %char(a1binr)+
6.40 c                             '.xml'
6.40 c**                           'Fakt_'+ %trim(w_jkey) + '.xml'
6.25 c                   endif
pdf   *
pdf  c                   callp     WrtHtmlToStmf(XML_Output: 819)
6.3d  * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
6.3d c                   if        d_dtaq = '1'
6.3d c                   eval      p_xmlf = xml_output
6.3d c                   eval      p_filg = 'ADB'+l_filg
6.3k c                   if        b_dtaq2 = *on
6.3f c                   call      'AP629C2'
6.3d c                   parm                    p_filg
6.3d c                   parm                    p_xmlf
6.3k c                   else
6.3k c                   call      'AP629C'
6.3k c                   parm                    p_filg
6.3k c                   parm                    p_xmlf
6.3k c                   endif
6.3d c                   endif
pdf   *
pdf  c                   endsr
pdf   *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf   * Subrutiner for XML/jasper integrasjon - Skjermvisning           *
pdf   * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
pdf  c     pdf_preview   begsr
pdf   *
pdf   * Vi kaller program for launch av PDF i browser
pdf  c                   call      'AP621R'
pdf  c                   parm                    w_jkey
pdf   *
pdf  c                   endsr
pdf   *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30  * Subrutiner for XML/jasper integrasjon - Sluttag ordre           *
6.30  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.30 c     xml_oend_tag  begsr
6.30  *
6.30  /Free
6.30   // Skriv sluttag før fakturaslutt
6.30   WrtSection('OrderEndTag');
6.30
6.30  /End-free
6.30  *
6.30 c                   endsr
6.40  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.40  * Subrutiner for XML/jasper integrasjon - Sluttag ordre           *
6.40  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.40 c     proa_nummer   begsr
6.40  *
6.40  * Henter inn nytt nummer for bruk i xml filnavn
6.40  *
6.40 c                   eval      w_kode = '0'
6.40 c                   eval      w_firm = l_firm
6.40 c                   eval      w_fell = 'NXTKLI'
6.40 c                   eval      w_type = *blank
6.40 c                   eval      w_fast = *blank
6.40 c                   eval      w_numm = *zero
6.40  *
6.40 c                   call      'AS100R'
6.40 c                   parm                    w_kode
6.40 c                   parm                    w_firm
6.40 c                   parm                    w_fell
6.40 c                   parm                    w_type
6.40 c                   parm                    w_fast
6.40 c                   parm                    w_numm
6.40  *
6.40 c                   endsr
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B  * Subrutiner for XML/jasper integrasjon - Detaljer                *
6.2B  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
6.2B c     hnt_avde      begsr
6.2B  * Hent inn avdelingsinformasjon
6.2B c
6.2B c                   eval      w_ddeno = soavde
6.2B c                   eval      w_dnavn = *blank
6.2B c                   eval      w_dadr1 = *blank
6.2B c                   eval      w_dadr2 = *blank
6.2B c                   eval      w_dpcde = *zeros
6.2B c                   eval      w_dpstd = *blank
6.2B c                   eval      w_dphon = *blank
6.2B c                   eval      w_dfaxn = *blank
6.2B  *
6.2B c                   eval      ra07pf_avde = soavde
6.2B c     ra07pf_key    chain     ra07pfr                            90
6.2B c                   if        *in90  = *off
6.2B c                   eval      w_dnavn = ragtxt
6.2B c                   eval      w_dadr1 = ragadr
6.2B c                   eval      w_dadr2 = ragad2
6.2B c                   eval      w_dpcde = ragpnr
6.2B c                   eval      w_dpstd = (%char(ragpnr) + ' ' + ragste)
6.2B c                   if        ragtlf <> *blank
6.2B c                   eval      w_dphon = ragtlf
6.2B c                   endif
6.2B c                   if        ragfax <> *blank
6.2B c                   eval      w_dfaxn = ragfax
6.2B c                   endif
6.2B c                   endif
6.2B  *
6.2B c                   endsr
8.08  *
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  * Subrutine for sjekk om ordretype eller kunde er utelatt fra factoring
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  *
8.08 c     sjk_fact      begsr
8.08  *
8.08  * Ordretype utelatt?
8.08  *
8.13           b_fact = *off;
8.08
8.08          if w_oty1 = sootyp or
8.08             w_oty2 = sootyp or
8.08             w_oty3 = sootyp or
8.08             w_oty4 = sootyp or
8.08             w_oty5 = sootyp;
8.13           b_fact = *on;
8.08          endif;
8.08  *
8.08  * Kunde utelatt ?
8.08  *
8.08          exec sql
8.08            select rkfack
8.08              into :w_fack
8.08            from rkunpf
8.08               where rkfirm = :w_firm and
8.08                     rkkund = :sokund;
8.08
8.08          if w_fack = 1;
8.13           b_fact = *on;
8.08          endif;
8.08  *
8.08 c                   endsr
8.08  *
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  * Legg inn informasjon for factoring
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  *
8.08 c     bygg_fact     begsr
8.08  *
8.08  *  Hent firmainformasjon
8.08  *
8.08 c                   if        afprfi = 1 or
8.08 c                             afprfi = 2
8.08 c     afirl1_key    chain     afirl1r                            66
8.08  *
8.08 c                   endif
8.08  *
8.08  * Bankgironummer må redigeres inn i et alfafelt p.g.a. OCR
8.08  * Legger inn info fra koderegister hvis factoring via iizy
8.08  *
8.08    if u_803 = *on and
8.08       b_fact = *off;
8.08       a1fbgi = w_fbkk;
8.08       t1fbgi = w_fbkk;
8.08     else;
8.08       a1fbgi = aafbgi;
8.08       t1fbgi = aafbgi;
8.08    endif;
8.08  *
8.08  * Klargjør IBAN og SWIFT
8.08  * dersom dette er lagt inn
8.08  * Henter bankinfo fra koderegister hvis factoring via iizy
8.08  *
8.08    if u_803 = *on and
8.08       b_fact = *off;
8.08    if w_fiba <> ' ' and
8.08       w_fswi <> ' ';
8.08       aaiban = w_fiba;
8.08       aaswif = w_fswi;
8.08    endif;
8.08    endif;
8.08  *
8.08 c                   if        aaiban <> *blank
8.08 c                   eval      a1ibah =  'IBAN :'
8.08 c                   eval      a1ibat =  aaiban
8.08 c                   endif
8.08  *
8.08 c                   if        aaswif <> *blank
8.08 c                   eval      a1swih =  'SWIFT:'
8.08 c                   eval      a1swit =  aaswif
8.08 c                   endif
8.08  *
8.08 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *  Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      w_retk = *blank
     c                   eval      w_txt2 = *blank
     c                   eval      w_krab = *zero
      *
     c                   eval      w_qmva = *blank
     c                   eval      w_mvax = *blank
     c                   eval      w_mvas = *zero
     c                   eval      w_mvat = *zero
     c                   eval      w_mvaf = *zero
3.34 c                   eval      w_mv2s = *zero
3.34 c                   eval      w_mv2t = *zero
3.34 c                   eval      w_mv2f = *zero
      *
     c                   eval      aforl1_ruti = *blank
     c                   eval      w_tell = *zero
     c                   eval      n = *zero
      *
6.38  * Key for posisjonering på selgere
6.38  *
6.38 c     ra09l1_key    klist
6.38 c                   kfld                    w_firm
6.38 c                   kfld                    ra09l1_ikod
      * Key for Heading-file
      *
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohel1_aarr
     c                   kfld                    sohel1_binr
     c                   kfld                    sohel1_numm
     c                   kfld                    sohel1_suff
6.11  *
6.11  * Key for Heading-file les siste post
6.11  *
6.11 c     sohelr_key    klist
6.11 c                   kfld                    w_firm
6.11 c                   kfld                    sohelr_aarr
6.11 c                   kfld                    sohelr_binr
6.11 c                   kfld                    sohelr_numm
6.11 c                   kfld                    sohelr_suff
      *
      * Key for Detalj-file
      *
     c     sodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
     c                   kfld                    sodtl1_numm
     c                   kfld                    sodtl1_suff
     c                   kfld                    sodtl1_ktxt
     c                   kfld                    sodtl1_line
6.11  *
6.11  * Key for Detalj-file (sjekking om det finnes linjer)
6.11  *
6.11 c     sodtlr_key    klist
6.11 c                   kfld                    w_firm
6.11 c                   kfld                    sodtlr_aarr
6.11 c                   kfld                    sodtlr_binr
6.11 c                   kfld                    sodtlr_numm
6.11 c                   kfld                    sodtlr_suff
      *
      * Key for kunderegister
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
5.60  *
5.60  * Key for oppslag på kundeprosjekt
5.60  *
5.60 c     fkprl1_key    klist
5.60 c                   kfld                    w_firm
5.60 c                   kfld                    fkprl1_kund
5.60 c                   kfld                    fkprl1_kpro
      *
      * Key for firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for ordretyper
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for linjetyper
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for statusregister
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for formular-register
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for vare-register
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for priskode-register
      *
     c     vpkol1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vpkol1_pkod
5.31  *
5.31  * Key for oppslag av fakturalogg
5.31  *
5.31 c     fnufl1_key    klist
5.31 c                   kfld                    w_firm
5.31 c                   kfld                    fnufl1_aarr
5.31 c                   kfld                    fnufl1_binr
5.31  *
5.31  * Key for les av fakturatype
5.31  *
5.31 c     fmftl1_key    klist
5.31 c                   kfld                    w_firm
5.31 c                   kfld                    fmftl1_faty
6.2B  *
6.2B  * Key for oppslag på avdelings-register
6.2B  *
6.2B c     ra07pf_key    klist
6.2B c                   kfld                    w_firm
6.2B c                   kfld                    ra07pf_avde
7.fb  *
7.fb  * Key for oppslag på depositum-fil
7.fb  *
7.fb c     sdepl1_key    klist
7.fb c                   kfld                    w_firm
7.fb c                   kfld                    sdepl1_numm
7.fb c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
      *
      * Hente inn rutinenavn
      * og meldingstekst
      *
     c                   eval      aforl1_ruti = l_ruti
      *
     c     aforl1_key    chain     aforl1r                            69
     c                   if        *in69 = *off
     c                   eval      a1txt1 = aftxt1
     c                   eval      t1mld1 = afmld1
     c                   eval      t1mld3 = afmld3
     c                   eval      t3mld1 = afmld1
     c                   eval      t3mld3 = afmld3
     c                   endif
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      *
     c     *entry        plist
     c                   parm                    p_parm
      *
     c                   eval      d_aarr = *zero
     c                   eval      d_otyp = *blank
     c                   eval      d_ffnr = *zero
     c                   eval      d_tfnr = *zero
     c                   eval      d_kopi = *blank
     c                   eval      d_parm = p_parm
pdf   *
pdf   * Sjekk om vi skal bruke JASPER og XML generering av dokumenter
pdf  c                   if        l_poff = '1'
pdf  c                   eval      b_pdfp = *off
pdf  c                   eval      b_topt = *off
pdf  c                   eval      b_bott = *off
pdf  c                   eval      w_pdf = 0
pdf  c                   eval      w_pdf_ds = *blanks
pdf  c                   eval      w_ruti = l_ruti
pdf   *
pdf  c                   call      'AP609R'
pdf  c                   parm                    w_ruti
pdf  c                   parm                    w_pdf
pdf  c                   parm                    w_pdf_ds
pdf  c                   eval      d_pdf_ds = w_pdf_ds
pdf   * Vi skal kjøre med jasper
pdf  c                   if        w_pdf = 1 and
pdf  c                             %trim(d_xmlm) <> *blanks
pdf  c                   eval      p_mail = '0'
6.22 c**                 eval      w_jkey = l_bach
pdf   *
pdf   * Hent inn xml templaten
pdf   *
pdf  c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
6.2R c                   callp     ClrHtmlBuffer
pdf   *
pdf   * Finn hvor xml'en skal legges
pdf   *
pdf  c                   eval      XML_path = *blanks
pdf  c                   eval      XML_path = %trim(d_path)
pdf   *
pdf   * Finn path til logo
pdf   *
pdf  c                   eval      jasper_logo = *blanks
pdf  c                   eval      jasper_logo = %trim(d_logo)
pdf   *
pdf   * Batchnummer er allerede generert i AP600R. Overføres i *lda
pdf   *
6.22 c                   eval      w_jkey = l_bach
6.22  * Lager nytt batchnummer
6.22 c                   if        l_bach = *blanks
6.40 c                   exsr      proa_nummer
6.22  *
6.22 c                   eval      w_jnav = 'PDF' + %char(w_numm)
6.22 c                   eval      w_jtxt = 'Utskrift av faktura via Jasper'
6.22 c                   call      'AB700R'
6.22 c                   parm                    w_jnav
6.22 c                   parm                    w_jkey
6.22 c                   parm                    w_jtxt
6.22  *
6.22 c                   eval      l_bach = w_jkey
6.22  *
6.22 c                   endif
pdf   *
pdf  c                   time                    w_date
8.11 c                   eval      w_year = %subdt(w_date:*years)
8.11 c                   time                    w_stmp
pdf   * Vi logger ar utskriftprogrammet har startet
pdf  c                   eval      w_jstat = 10
pdf  c                   eval      w_jtext = 'Utskrift av faktura har startet'
pdf  c                   call      'AB705R'
6.22 c                   parm                    w_jkey
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf   *
pdf  c                   eval      w_bach = w_jkey
pdf   * Vi skriver xml for miljø formater
pdf  c** flyttet         exsr      xml_envm
pdf  c                   eval      b_pdfp = *on
pdf  c                   eval      b_pdfp_first = *off
pdf   *
pdf  c                   endif
pdf   * Hvis et eller annet er galt med parametrene, logges og kjør uten PROA
pdf  c                   if        %trim(d_xmlm) = *blanks
pdf  c                   eval      b_pdfp = *off
pdf   * Vi logger at noe er galt med parametrene
pdf  c                   eval      w_jstat = 20
pdf  c                   eval      w_jtext = 'Finner ikke path til xml !!! +
pdf  c                             Sjekk rutineregister !'
pdf  c                   call      'AB705R'
6.22 c                   parm                    w_jkey
pdf  c                   parm                    w_jstat
pdf  c                   parm                    w_jtext
pdf  c                   endif
pdf   *
pdf  c                   else
pdf  c                   eval      b_pdfp = *off
pdf  c                   endif
7.f1  *
7.f1  * Henter inn evnt overstyrt jasper mal for evnt forskuddsbetaling
7.f1  *
7.f1 c                   if        b_pdfp = *on
7.f1  *
7.f1 c                   eval      w_jmal = *blanks
7.f1  *
7.f1  /Free
7.f1   exec sql
7.f1    select afudss
7.f1    into   :w_jmal
7.f1    from   afpspf
7.f1    where  afufil = :l_filg and
7.f1           afuide = 'FAKTFOR   ';
7.f1
7.f1  /End-Free
7.f1  *
7.f1 c                   endif
7.f1  *
      *
     c                   endsr
      *
