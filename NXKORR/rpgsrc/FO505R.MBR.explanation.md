# RPG Program Explanation: FO505R – Order Inquiry

This source code is a classic (fixed-format) ILE RPG program designed for order inquiry functionality—displaying order headers and details, providing information on customers, items, and relevant pricing, and supporting interactive subfile-based lists.

Below is an explanation organized into logical sections to help developers quickly onboard and understand the code.

---

## 1. **Header and Change History**

- Program: `FO505R`
- Description: "Vise ordre" (Show orders)
- The header includes a detailed changelog, listing releases, authors, and modification descriptions (mostly in Norwegian). Features such as new lookup programs for warehouse, mobile number overrides, additional reference fields, GUI adjustments, user-cost viewing restrictions, and Newlook compatibility are noted.

---

## 2. **File Declarations (`F` Specs)**

### Physical and Logical Files
- **Order Header:** `fohel1` (renamed record format: `fohel1r`)
- **Customer:** `rkunl1`
- **Order Line/Detail:** `fodtl1`
- **Price Code:** `vpkol1`
- **Line Type:** `vltyl1`
- **User:** `fusrl1` *(conditional on release/version)*
- **Item Master:** `vvarl1`
- **Deposit:** `sdepl1` *(for deposit/advance payment handling)*

### Workstation File
- `fo505d` defines a display device file using subfiles (e.g., `b1sfl`) and an *information data structure* (`infds(dspfbk)`) for feedback.

---

## 3. **Data Structures and Local Variables (`D` Specs)**

- **Local Data Area:** Used for user information (`l_user`), function name, etc.
- **Information Data Structure:** Captures the current cursor row (`d_fcrn`) on displays.
- **Detail Line Data Structure:** (commented out in later code, replaced by direct fields)
- **Parameters:** `p_firm`, `p_numm`, `p_suff` – order keys.
- **Key Variables:** For use in keyed file lookups (`chain`, `setll`), e.g., customer, price code, item, user, etc.
- **Work Variables:** Include subfile handling (`w_fcrn`, `w_srrn`, etc.), currency/date fields, text buffers, calculation fields, and flags, including indicators for GUI-specific features and cost price visibility (`b_kost`).

---

## 4. **Indicator Usage**

- **LR:** Last record, ends the program.
- **10, 11, etc.:** Control subfile scrolling (roll up/down), subfile display/clear, field protection, error/warning indications, and worker indicators.

---

## 5. **Main Control Flow**

### Initial Setup

- **`*inzsr`** (Initialization subroutine): Collects parameters, sets up keys for file access, and determines user permissions (e.g., ability to view cost price).
- **Control Info Subroutine:** `control_init` is called to populate the control header section of the display using order header and customer data.
- **Loading the Subfile:** Keyed read (`setll`/`reade`) is used to fill the subfile with order lines via subroutine `crt_subfile`.

### Main Display Loop

- Uses a tag/label-based structure (`b2taga`, `b2tagb`), alternating between command and subfile display.
- Responds to function keys (e.g., F3=Exit, F12=Cancel, F14=Customer Info, etc.), each executing various CALLs to other programs or subroutines.

### Subfile Processing

- `subfile` subroutine: Handles user actions selected within the subfile (such as inquiry into a specific line's details).
- `forny` subroutine: Refreshes the subfile (e.g., after actions).
- `clr_subfile` and `crt_subfile`: Clear and refill the subfile pages, with paging logic to manage large lists.

---

## 6. **Special Handling and Features**

### Display/Inquiry Features

- **Mobile Number Display:** Shows the customer’s mobile number, overridable by order header if present.
- **Deposit Handling:** Checks deposit balances and sets screen indicators for coloring lines based on payment status.
- **Customer/Project Lookups:** Invokes related programs for additional info (F14/F21).
- **Line/Item Inquiry:** Calls external programs for inventory (`LL500R`) or item info (`VV550R`).

### User Permissions

- Cost price data visibility is controlled based on user authority, determined in the `*inzsr` subroutine.

### Subfile Buffer Handling

- Key variables manage which set of lines are on screen, where the cursor is, and what should be refreshed or updated.
- Supports multiple pages with tracking for current/first/last records, cursor placement, and scroll.

### Data Cleaning / Newlook Compatibility

- **`newlo_vask`** subroutine (added for Newlook GUI): Strips certain punctuations (periods and colons at the end of lines) from specific text fields to avoid GUI misinterpretation.

### Amount Calculations

- Calculates totals for order lines (net, gross, discount, cost, etc.).
- Handles discounts: If no explicit discount is set, pulls text descriptors from the price code file.

### Field/Line Types

- Reads line type information from the line type file (`vltyl1`). Special handling for text vs. item lines (e.g., how long descriptions are built).

---

## 7. **Subroutines Overview**

- **`control_init`:** Loads and displays order header and customer info; handles mobile number logic and deposit status.
- **`forny`:** Resets and refreshes the subfile.
- **`subfile`:** Handles actions on lines (e.g., selecting a line to view details).
- **`clr_subfile`:** Clears subfile contents and resets state variables.
- **`crt_subfile`:** Loads (pages of) order lines into the subfile for display, handling all necessary joins and calculations.
- **`dsp_subfile`:** Presents the populated subfile to the user.
- **`newlo_vask`:** Cleans display strings for GUI compatibility.

---

## 8. **Initialization (`*inzsr`)**

- Accepts parameters for company, order number, and suffix.
- Builds keys for all necessary files.
- Loads user settings and permissions, specifically cost price access (`b_kost`).
- Prepares display state.

---

## 9. **Best Practices and RPG Features in Use**

- **Separation of Concerns:** Business logic is organized into distinct subroutines.
- **Subfiles:** Implements RPG subfile paging and interaction patterns for detail browsing.
- **Data Validation:** Carefully checks EOF/record existence after all file operations.
- **System Integration:** Uses program calls for cross-program inquiries (inventory, customer, item).
- **Comments/Changelog:** Maintains a thorough in-line documentation tradition.
- **Indicator Usage:** Heavy use to manage RPG classic screen and data state.
- **Overlaying Data Structures:** (Earlier approach, now largely replaced by individual variables).

---

## 10. **Key Takeaways for Onboarding**

- **Order Inquiry:** The program’s main function is to display and allow inquiry into order headers and their associated lines, with full lookup and paging support.
- **Screen/Display Management:** Relies heavily on subfiles for UI listing. Knowing how RPG subfiles work will be crucial for maintenance.
- **User Security:** Some data (e.g., cost price) is only visible depending on user record’s settings.
- **File Relationships:** Understanding how keys are built for each file (`KLIST`) will help troubleshoot data retrieval issues.
- **Norwegian Comments:** Most comments are Norwegian, so familiarity or translation help may be needed.
- **Legacy RPG:** The code is classic fixed-format RPG; modernizing or extending will require comfort with this style.

---

### **Summary Table: Important Variables**

| Name          | Purpose                                              |
| ------------- | ----------------------------------------------------|
| *Indicators*  | Controls subfile, error/warning, paging, actions    |
| w_srrn, w_ssrn, w_spge, w_fcrn | Subfile record navigation     |
| b_kost        | User right to view cost price info                  |
| b1...         | Fields for subfile records (order line info)        |
| p_firm, p_numm, p_suff | Program parameters (company, order, suffix)|
| l_user        | Logged-in user                                      |

---

## 11. **References / Next Steps**

- **IBM Subfile Concepts:** Understand subfile management in RPG.
- **Display Files:** Review DDS for `fo505d` to see how fields/UI are set up.
- **Related Programs:** See `LL500R`, `FL510R`, `VV550R`, and `FD505R` for inquiry logic.
- **Company Structures:** Get to know how files like `fohel1`, `fodtl1` map to real-world business data.

---

**In summary**, this program provides a robust inquiry and display facility over orders and their lines, with deep integration to customer, item, pricing, and user permission data, making it a critical part of sales/order management systems on IBM i environments.