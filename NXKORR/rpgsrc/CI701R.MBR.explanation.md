# RPG Program Overview and Explanation

This RPG program is a complex batch export utility, which extracts product and price information from multiple files, processes data (including sales, campaigns, stock, etc.), and writes a flat file for internet or external use.

Let's break down the source structure and main logic:

---

## Program Header and History
- The `H` spec sets program options and date editing format.
- The lengthy comments document the history and purpose:
  - It exports product and price data, for internet or similar external systems.
  - Handles various business rules (campaigns, stock, price groups, etc.).
  - Supports special handling for e.g. weekends (Saturday logic), different units of measure, campaign prices, etc.
  - Has extensive change history; this is a business-critical, evolving utility.

---

## File Declarations (`F` Specs)
- Many physical and logical files are declared for input; each "rename" clause maps to a record format.
- The output flat file is `cintpf`, where the processed data is written.

---

## Data Structures and Variables

### Parameter Handling
- Parameters are passed as an 8-byte input string, representing firm and department info (`d_list`).
- These are split into fields for the firm (`d_firm`) and department (`d_avde`).

### Export Record Format
- `d_int` is the assembled 520-byte output record mapped with overlays for all export fields (product info, prices, units, group codes, campaign info, statistics, etc.).
- Fields use overlays to map individual names onto specific positions in the record, matching a flat-file layout.

### Variables for Processing
- Many variables and work fields: for prices, sales, dates, units, stock, keys for file access, etc.
- Separate work variables exist for various units/prices (base, 2nd, 3rd unit).
- Date/time variables are handled with ISO and DMY formats as needed.

---

## Main Program Flow

### Initialization
- SQL default date format is set to ISO.
- The current date/time is initialized.
- If the current day is Saturday, the effective "processing" date is set to 2 days later; otherwise, to 1 day later. (This ensures the export always reflects the next logical business day.)
- Other date variables are calculated: 15 months ago, 12 months ago, 3 months ago, 1 month ago, and 3 days ago.

### Main Processing Loop
- The program reads all items from the master product file (`vvarl1`), processing each record in turn.
- For each product, it executes the `behandling` (processing) subroutine.
- At the end, writes out a processed export record to the output file.

---

## Subroutine: `behandling` (Main Item Processing)

The bulk of the business logic is here. For each product:

1. **Initialization**
   - Clears the export record and resets all work variables (prices, units, etc.).

2. **Basic Product Checks**
   - Skips products that are not stock-managed or special acquisition.
   - Further checks filter out products based on types, using fields in the product master or warehouse records.

3. **Populates Product Info**
   - Fills fields: item number, NOBB number (Norwegian building item registry), description/text, supplier info, groupings, creation and expiry dates.
   - Sets indicator if item is a "skaffevare" (special order item).
   - Gets latest expiry date from either warehouse or product master, whichever is more relevant.

4. **Unit of Measure and Price Info**
   - Gets available sales units for the product (base, second, third unit).
   - Stops processing if units are missing.

5. **Supplier Selection**
   - Determines relevant supplier: if there's an overridden supplier for the warehouse, use it; otherwise use the product's normal supplier.

6. **Sales Price Lookup (Multiple Sale Units)**
   - Looks up the "current" sales price for all available sales units, using supplier, price group, and unit as keys, falling back through several variants if needed.
   - Handles multiple sale units (base, second, third), and calculates price including VAT.

7. **Campaign Price Logic**
   - Looks up if there's a current campaign (promotion) price valid for the item/unit/date/time. If not found, falls back to price group blank, or to different group/level combinations using the `tilb_sjekk` and `hent_tilb` routines.
   - For each sale unit, if a campaign price is found, calculates price including VAT.
   - Sets campaign from/to dates/times.

8. **Supplier Name**
   - Fetches supplier name for output.

9. **Logistics Item Info (NOBB, supplier product number)**
   - Uses embedded SQL to read logistics-specific data for the item/supplier, overwriting product fields if present.

10. **Sales Statistics**
    - Extracts sales in the last 3 months and in the period 15-12 months ago.
    - Converts units from statistics to sales unit, handling conversion factors as needed.

11. **Order and Delivery Info**
    - Reads current outstanding (unfilled) orders and quantities.
    - Finds earliest confirmed delivery date within business rule constraints (not older than 3 days).

12. **Stock Calculation**
    - Calculates available stock, quantities in order, on order, and computes available for sale after adjusting for outstanding orders, etc.
    - Converts all quantities to sales unit for consistency.

13. **Output**
    - Builds the output record (populates `d_int` with all overlays/fields), then writes it to the output file (`cintpfr`).

---

## Campaign Price Search: `tilb_sjekk` and `hent_tilb`

- If no campaign price is found for the item and price group, attempts to find one based on increasingly broad groupings:
  1. Item groupings (over group, main group, sub group)
  2. With/without supplier
  3. With/without price group
  4. Using the above combinations, calls `hent_tilb` for each possibility
- `hent_tilb` actually performs the file read for campaign records, validates date/time, and calculates the discount price as a percentage off the current sale price, updating work variables.

---

## Startup/Initialization Subroutine: `*inzsr`

- Parses the input parameter into the firm and department.
- Sets up many file keys for later use (for fast access during loops).
- Determines the warehouse/location to use for the export (from department or fallback).
- Determines price group allocation according to location and department.
- Fetches the VAT rates (both standard and reduced) via sub-program calls.

---

## Miscellaneous
- Throughout, the code makes heavy use of conversion for numeric to character formats (for output).
- Handles handling of minus values and overflow, including special logic for maximum campaign prices.
- Overlay fields and careful substring handling are used to build the exact required export layout.
- Handles special Norwegian characters (e.g. `x'1C'`, which in EBCDIC is 'Ã˜' or similar).

---

## Summary Table

| Section   | Purpose                                                                              |
|-----------|--------------------------------------------------------------------------------------|
| F-specs   | Declare input/output files                                                           |
| D-specs   | Declare data structures, overlays for export layout, work variables                  |
| Main line | Set up dates, loops over all products, calls main item processing                    |
| behandling| Main item processing: fetches all info, prices, units, stock, statistics, writes out |
| tilb_sjekk| Tries various group/supplier combinations to find valid campaign price               |
| hent_tilb | Actually searches and applies campaign discount from campaign master                 |
| *inzsr    | Initialization: parameters, key fields, warehouse, price group, VAT                 |

---

## Practical Onboarding Notes

- The program is designed to be robust and flexible, handling many business rules and fallback scenarios (especially for price/campaign/stock).
- Data overlays and substring logic make it critical to keep the output format spec in sync with the requirements of whoever consumes the flat file.
- Numeric/character conversion is handled manually for output records.
- To add new data to the export file, one must adjust the overlays, work fields, and the assembly of the output record.
- Highly dependent on file layouts and the correct definition of input files (logical/physical).
- Many routines are driven by date logic, VAT, and campaign (promotion) logic, with fallback chains for missing data.
- The program relies on both RPG-native I/O and embedded SQL.

---

## TL;DR

**This is an export utility that reads all products for a firm/location, extracts and calculates all relevant product, supplier, price, campaign, sales, and stock information, and writes a flattened export record per item for use on the internet or similar systems, handling a complex set of business rules for each field.**