# RPG Program FV102R - Maintenance of Status/Order Codes (Spesielle koder)

This RPG program is centered on maintaining and processing special *status codes* and related parameters used in an order-management system running on IBM i (AS/400). The code is written in ILE RPG, a procedural language predominantly used on IBM i systems for business logic and file processing.

Below, the program is explained by its main logical sections to help you onboard quickly.

---

## **1. Program Metadata and Change Log**

- **Header area**: Program documentation, system and program name, and a detailed change log.
- **Purpose**: The program's main role is to handle maintenance (read, display, update) of special codes governing order and status management logic.
- **Change log**: Shows how the program evolved. Pay attention to lines like `Lagt inn kode for kontroll av neste ordretype` (Added code for next order type) as they indicate added features or significant changes.

---

## **2. File Definitions**

This section defines all physical, logical, and work station files used:

- **Physical/Logical Files:**
  - `fstsl1`, `fstslu` (primary code register, both input and update capable)
  - Variations with suffixes like `rscdl1`, `aftpl1`, etc. are introduced for new screen layouts or data expansions.
  - Files are RENAMED to internal names for program logic.
- **Workstation file:**
  - `fv102d` is defined as the display file (workstation), allowing the user to interact with the program via screens.

---

## **3. Variable Definitions**

- **Fields like `l_user`, `l_firm`, etc.:** Used for tracking user IDs, firm numbers, etc.
- **Working variables:** Used for calculations and temporary storage, e.g., for economic system selection and manipulation.
- **Screen record fields:** Variables like `a1abnd`, `a2ak03`, etc., are mapped to screen (display) fields for data entry/display.

---

## **4. SQL Options**

- **Exec SQL section:** Sets SQL environment to ISO date, Norwegian language/collation, etc.
- **Direct SQL* used for:
  - Reading/describing economic system codes
  - Updating economic system code fields

---

## **5. Main Program Flow**

### **Screen 1: Main Maintenance Panel (`a1bld`)**

- **Fetch Record:** Chains (randomly reads) to status code register (file `fstsl1`) using composite key `stskey`.
    - If found, moves file fields into working/screen variables.
    - Also fetches extended fields from `fst2l1` if available.
    - If not found, initializes fields to *blank* or *zero*.
- **Display panel:** `exfmt a1bld` triggers user interaction.
- **Function keys:** F3 (`*inkc`) for exit; other keys might lead to other screens or actions.

---

### **Screen 2: Extra Parameters (`a2bld`)**

- **Display extra parameter screen** for the code.
- **Branching logic:** Depending on function keys:
  - F10, F11 (`*inkg`, `*inke`): Calls maintenance programs for related data (e.g., voucher code maintenance: 'RB100R', 'RB101R').
  - F13 (`*inkd`): Opens economic system selection subroutine; updates screen display with chosen info.
  - F15 (`*inkf`): Jumps to screen 3.
- **Screen exit with F3.**

---

### **Screen 3: Scheduler/FTP Parameters (`a3bld`)**

- **Fetch secondary code register (`rscdl1`).**
- **Initialize fields if not found.**
- **Display scheduler/FTP setup screen.**
- **Function key actions:**
    - F3: Exit.
    - F13 (`*inkd`): Calls FTP request handler.
    - F15 (`*inkf`): Sets up a job in the scheduler; includes validation of start time and FTP path.
    - F10 (`*inkg`): Calls additional scheduler-related program.
- **Writes back updated fields to `rscdlur`.** If record exists, it is updated; otherwise, it is inserted.

---

### **Screen 4: Additional Details (`a4bld`)**

- **Used only if a specific module is enabled (advance payment, controlled via `b_for`).**
- **Fetches and displays details from `fst2lu`.**
- **Handles update/insert logic similar to other screens.**

---

## **6. Updating/Maintaining Files**

- **Primary Code Register (`fstslu`):**
  - Data from screen variables is moved back to file fields.
  - Sets various audit fields (date, time, user).
  - If record exists, updates it; else, writes a new record.
- **Extended Code Register (`fst2lu`), If Used:**
  - Same logic applies as above for extended set of fields.

---

## **7. Economic System Selection / Special Handling**

- **Two fields, `faak03` and `faak08`,** represent the economic system code, combined as `a2ak03 = faak08 * 10 + faak03`.
- **Lookup:** Uses SQL to find the economic system description for the code.
- **Update:** When saving, splits `a2ak03` into its two digits and updates the corresponding fields in `fstspf` using SQL.
    - Commits the change immediately.

---

## **8. Subroutines**

- **Initialization (`*inzsr`):**
  - Defines keys for all files.
  - Sets the *firm number* in each key.
  - Checks if the prepaid module is available and flags `b_for` accordingly.

---

## **9. Program End**

- **Graceful Exit:**
  - `seton lr` (last record indicator) and `return` indicate program completion and allow resource cleanup.

---

# **Key Points for Maintenance Onboarding**

- **Program Structure:** Traditional RPG 'cycle', but heavily based on user screen navigation using display files.
- **Record Fetch/Write:** Each main screen (panel) is backed by chain/update/write logic on relevant files.
- **Screen-Driven:** Navigation and branching are function-key based.
- **Custom Business Logic:** Many variables/fields are tied to the company’s order handling, specific codes, and economic system integration.
- **Module Expansion:** New features are regularly introduced by adding new fields and panels/screens with minimal intrusive changes.
- **SQL Integration:** Used for certain lookups and updates, complementing record-level access.
- **Audit Trail:** Maintains who/when changes were made via time/user stamps.

---

# **Typical Onboarding Tasks**

When onboarding to this code, a developer should:

1. **Understand All File Structures:** Know what `fstspfr`, `fst2pfr`, `rscdpfr`, etc. contain and how their fields map to business concepts.
2. **Trace Key Flow:** Follow how keys are constructed and used for each file operation.
3. **Grasp Function Key Logic:** See which function keys drive navigation and branching.
4. **Read Change Log:** Many behaviors or “why”s are explained in the comments.
5. **Mind Module Flags:** Some logic/screen flows are gated by module configuration or flags (e.g., `b_for` for advance payment module).
6. **Economic System Handling:** Special logic for combining/splitting economic system codes across two fields is present and frequently updated.

---

If you need a **visual/stepwise flowchart**, mappings of screen fields to file fields, or a legend of all physical/logical files used, those can be prepared to further assist onboarding.