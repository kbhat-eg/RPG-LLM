# RPG Program GL118R - Overview and Explanation

This program, part of the ASOKON system, is a classic ILE RPG/400 application for IBM i (AS/400), tailored for working with "retur" (return) files, specifically handling Telegiro, OCR, and other payment/return file types. The program is interactive, using subfiles (multi-line lists on the display) and is highly customized for batch processing of payment returns, likely for financial reconciliation and updates.

Below is a detailed breakdown to onboard a developer:

---

## 1. **Header and Change Log**

- The header documents program evolution, referencing versions, enhancements, and bug fixes, annotated by date and developer initials.
- The comments describe functionality changes, especially handling of new file types and improvements in how members (data partitions in physical files) are named and managed.

---

## 2. **File Specifications (F-Specs)**

- **Workstation file** (`gl118d`): Handles the UI and subfiles (B1, C1, D1).
- **Database files**: Handles both input (I), update (U), output (O), and keyed access (K) to various files:
  - **GATRL1/U**, **GAVTL2**, etc. - Master/payment proposal files.
  - **GBTRPF** (copy/backup), **GTRTPF** (Telegiro returns), **GORTPF** (OCR returns).
  - **RCNRPF**, **GUR2PF**, etc. - Additional payment/return handling files.
- Several files are renamed for multiple access paths.

---

## 3. **Data Structures & Variables (D-Specs)**

- Extensive use of arrays and data structures (DS) for handling batched data.
- *Subfile navigation* variables: Arrays and counters for pages, records, sides, etc.
- *Date handling*: DS overlays for extracting year/month/day from packed or numeric dates.
- *Batch and transaction variables*: Arrays and working fields for giro number, line sequence, types, timestamps, file group, company (firm), etc.
- *Flags and indicators*: Single-character flags to track SEPA handling, technical acceptance, ACTC status, etc.

---

## 4. **Indicators and User Input**

- **Indicators** manage RPG's control flow (e.g., F3=Exit, F5=Refresh, F12=Cancel), subfile activities (roll, display, clear), and error/status handling.
- **Function keys and indicators** are thoroughly mapped for user interactions, invoking the appropriate logic in the main processing loop.

---

## 5. **Core Program Flow & Subroutines**

### A. **Main Loop - B2CTL (Openingsbildet med Subfile)**

- Handles primary user display and command processing.
- **EXIT** (`F3` or indicator KC): Terminates program, release resources.
- **REFRESH** (`F5` or indicator KE): Reloads data, refreshes subfile.
- **ROLL** (Paging): Navigates through paged subfile lists.

### B. **Subfile Handling (READC Loop)**

- Iterates over subfile records to detect user actions (update, delete, view).
- Batch processing logic checks if an item is selected for update or deletion, ensures no double updates, and collects details of batches to be processed.

### C. **Batch Selection, Update, and Deletion**

- **Update (`Valg 1`)**: Gathers selected batches into arrays, ensuring no duplicates or invalid states, and marks the status for further processing.
- **Delete (`Valg 4`)**: Prompts user for confirmation, then deletes corresponding records, including cleaning up the subfile and maintaining position.
- **View (`Valg 5`)**: Jumps into a detail-view subfile, loading related records for viewing.

### D. **Batch Processing & Validation**

- Handles the update processing for selected batches, differentiating based on the type:
  - **Telegiro (TFx, TLx, SP1, SP2)**: Updates GTRTPF, groups 4 records per transaction, performs copy and delete operations.
  - **OCR**: Updates GORTPF file, ensures a "null-post" is left for audit/control.
  - **Inkasso (CNx)**: Updates RCNRPF.
  - **SEPA**: Special logic parses XML-like structures, extracting and allocating payment information for new formats.

- There is logic for:
  - Avoiding double processing (especially for OCR/Telegiro).
  - Managing copies for backup and archiving (e.g., GBTRPF).
  - Handling technical acceptance statuses and error cases, with ACTC technical validation markers.

### E. **Regnskap (Accounting) Update**

- If batches to be updated affect accounting (2nd returns or OCR), processes are routed to additional programs (RF120C, etc.) with necessary parameters, and journals are generated (journalliste/Kontrolliste).
- Period validation to ensure correct accounting periods, with checks for valid months, years, and not allowing post-dated or pre-dated entries.

### F. **Subfile Utility Routines**

- **xclr01/02/03**: Clear (empty) subfiles.
- **xcrt01/02/03**: Populate (fill) subfiles with relevant data.
- **xdsp01/02/03**: Display and manage navigation for subfiles.
- **xsbf3/xoppd/xslett/xcopy**: Handle selection, update, batch copying, and deletion logic.

### G. **SEPA/Advanced Format Handling (8.xx logic)**

- Special routines parse XML-like SEPA return files, extract references, payment status, technical validation, etc., and update payment proposal and supplier transaction files accordingly.

### H. **Initialization and Key Lists**

- Sets up program, variables, screen fields, and retrieves required company/file group data at program start.
- Defines all main key lists for efficient file access (`SETLL`, `READE`, `CHAIN`), including keys for new SEPA format files.
- Loads explanatory/help texts for use in screen fields (F9, etc.).

---

## 6. **Other Noteworthy Points**

- **Indicator Management**: RPG's *Inxx indicators are used everywhere for control, action, and screen management.
- **Comments**: The code is heavily commented (in Norwegian), providing context for every major block and data structure.
- **Error/Warning Handling**: The program actively checks for potential conflicting situations and proactively warns the user or prevents undesired operations.
- **Data Area Use**: Some settings and parameters are loaded from or written to data areas (`*DTAARA`) for cross-program communication.

---

## 7. **Summary for Onboarding**

- **Purpose**: This program is an interactive utility that allows users to view, select, update, or delete batches of payment returns, with robust support for Telegiro, OCR, Inkasso, and SEPA formats.
- **Approach**: Uses RPG's classic subfile paradigm for multi-record editing and navigation, with a heavy focus on maintaining data integrity and preventing double processing.
- **Integration**: Calls out to other programs for specific tasks like technical validation, regnskap (accounting) updates, journaling, and member management.
- **Modernization**: Recent changes show ongoing adaptation to new payment formats (SEPA, One Nexstep), new GUI needs, and regulatory requirements.

---

## 8. **For the Developer**

- **Familiarize yourself** with the subfile patterns (B1SFL, C1SFL, D1WSF).
- **Understand the main batch processing loop** (READC, array collection, branching on `b1valg`).
- **Trace the update logic** by looking at the subroutines called during update (especially `xoppd`).
- **Refer to the change log in the header** for context of why certain logic or file structures exist.
- **Localization**: Though code comments are Norwegian, variable naming and flow are systematic and traceable.

---

This code represents a robust, well-documented RPG application handling a critical business process, with extensive handling for data integrity, user control, and adaptability to new payment/return file structures.