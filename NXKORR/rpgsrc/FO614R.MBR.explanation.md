Program Overview  
---------------  
This ILE RPG program (FO614R) automates order handling: selection, printing, resting (back‐ordering), inventory updates, sorting and logging. It reads “pick” parameters, loops each selected order, generates packing slips, invoices/credit notes, splits or restocks lines, updates order headers/lines, calls subprograms for inventory (VL001R), numbering (AS100R), logging (FU900R), and metadata (AP600R), and finally cleans up pick records.

1. Header Comments & Version History  
   • Describes system, program name, function (“Behandling av ordre…”), and chronological change log.  
   • Highlights major features added over versions: support for email, multi‐order invoicing, Cobuilder/ByggDok integration, deposit handling, memo balance updates, suffix/number management, etc.

2. File Declarations  
   • Input/Update/Output files (IF, UF, O specs) renamed to align with local naming conventions (e.g. fpm2lu → fpm2lur).  
   • Key‐list definitions at end of program for each file to support CHAIN, READ, READP, DELETE, UPDATE, WRITE.

3. Data Structures  
   • hlrec (128‐byte) overlays a structure for inventory update fields: item, date/time, order numbers, quantities, operation codes.  
   • sorter (114‐byte) holds concatenated sort‐key fields (customer number, name+address, order number/suffix, project, payment terms).  
   • d_urec for logging updates: firm, order keys, user, timestamp.  

4. Local Data Area (LDA)  
   • Variables l_alt*, l_peri, l_dato, l_ruti, l_outq, l_prog, l_wsid, l_user, etc., passed to printing subprograms via *DTAARA.  

5. Key Variables  
   • w_firm, w_tonr, w_tsuf, w_otyp, w_lage, w_date, w_oakk, w_rest, w_test – working variables for current order’s firm, number, suffix, type, location flag, date, processing code, test flag.  
   • Boolean flags b_* to control special features (ByggDok, deposit, invoice grouping) and program calls.

6. Initialization (inzsr)  
   • Clears working fields (w_test, w_sald, w_enor, w_ruti).  
   • Defines access path keys for all files (klist/kfld).  
   • Retrieves user settings from OFAK‐code register and user profile.  
   • Determines date/timestamp (w_date) and feature flags (ByggDok/Cobuilder modules).

7. Reading Pick Parameters  
   • Moves parameters from UTPLUKK‐PARAM‐FILE (fplol1r) into working keys (order range, firm).  
   • Default range end to 99999999/99 if not specified.  
   • Loop tag XSTART: READ fplol1r; exit if beyond range or not matching firm/screen/user restrictions.

8. Per‐Order Processing  
   a. Load order header & type:  
      – CHAIN ORDRE‐HODE (fohel1r) and ORDRETYPE (votyl1r) to get printing routine (vaoakk ⇒ w_ruti).  
   b. Override l_ruti/l_outq for alternatives (offers, email, manual output queue).  
   c. OUT to LDA, CALL ‘AP600R’ to launch print/UI routine.  
   d. IN from LDA to restore control values.  
   e. Set l_alt1 (print option) and l_peri/l_dato for invoices (vaoakk=3).  
   f. OUT LDA again before actual data extraction.

9. Order Header & Info Filters  
   • Skip if: order’s info code stops invoicing; user not authorized; packing slip already printed (when forbidding reprint).  
   • For invoices: skip orders without line items.  
   • Respect invoicing date filter (fofkda > user‐entered date).

10. Sorting Key Assembly  
   • Clear sorter structure; move customer no. into sor001.  
   • If multi‐order invoicing (vaosam=1), adjust sor006/007 to zero for grouping.  
   • For invoice grouping modes (w_samf flags 2–4), build sor002 from project or blank to control grouping.  
   • Include payment terms, overridden billing or due dates (w_fkda, w_ffda) into sor005 to force break.  
   • MOVEL sorter into order’s fkssrt field for printing program to sequence orders.

11. Printing vs. Resting Branch  
   • CHAIN ORDRETYPE to decide if we rest lines (fkpres <>0) or purely print.  
   • For resting (olrest subroutine):  
     – HNTSUF: get next suffix (and new order no. for offer→order conversions).  
     – OLREST: loop ORDER‐LINE records, CROSS‐CHECK UTPLUKK‐LINJE register to decide pick code (1=pick,3=copy text,4=hold back,5=no restock).  
         • Write new lines to new suffix (fodtlur), delete or update old ones.  
     – Update inventory via OPPLAG subroutine/ VL001R for both old (“from”) and new (“to”) suffix lines.  
     – If no lines picked (w_test=0), delete old heading; else update balances and call FO730R to recalc sums on old heading.  
     – CALL FO190R to update order header status.

   • For non‐rest inventory adjustment only (laglag subroutine):  
     – If faalag flag set and no resting, loop lines and call OPPLAG with saved/target location codes.

12. New Order After Resting  
   • Tag100: update new order header fohelur with suffix, type/flags, delivery dates, user/timestamp, then call FO730R to sum new order, and FO190R to set header status.

13. Extracting to Pick‐Line Register  
   • Under linje, foran, etter subroutines: read new suffix’s ORDER‐LINE (fodtl1r) and ORDER‐TEXT (fotxl1r) in three phases (body, header text “foran”, trailer text “etter”), and WRITE/UPDATE entries in PLUKK‐S‐LINJE (fpsolur) with codes H (header), V (line), K (text) and store sort keys there.  
   • Finally DELETE pick‐param record, GOTO XSTART for next order.

14. Subroutines & Calls  
   • hntsuf: find next suffix by READP highest suffix, increment; if offer→order, call hntnum to fetch new number.  
   • hntnum: build parameters and call numbering service AS100R (possibly VA752R override) to get new order number.  
   • opplag: populate hlrec, CALL VL001R to record inventory movement.  
   • upd_logg: record user action on order events via FU900R.  
   • sjekk_lkode: check if user may trigger invoicing (=0 code) via FU702R.  
   • FO730R: recalc order sums (old/new).  
   • FO190R: update header status after rest or pick.  
   • FO709R: prepare new order heading and copy data.  
   • FO763R: update memo balance for invoicing.  
   • AP600R: UI/printing interface called at start; passes routine, change flag, batch/in03/in03.  
   • CO402R: property lookup for Cobuilder “no NOBB number” requirement.

15. Cleanup & Exit  
   • After all pick‐params processed, flags cleared, program returns.  

Pedagogical Tips  
• Understand the high‐level loop: fetch pick parameters → process one order completely → delete param → repeat.  
• OLREST is the heart of restocking: it splits lines between old/new suffix and manages inventory.  
• Sorting keys (sorter) determine how multiple orders group on one print.  
• subroutine opplag/ hntsuf / hntnum encapsulate inventory and numbering logic, isolating complexity.