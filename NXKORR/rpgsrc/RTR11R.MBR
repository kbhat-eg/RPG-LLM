     h option(*nodebugio) datedit(*dmy)
     h decedit('0.')
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : RTR11R
      * Beskrivelse . . : Leser linjer fra FOVF til semikolon separert fil
      *
      * Spesialversjon. : Utlegg av poster til Tripletex
      * Tilpasset for . :
      * ----- ------ ---- -------------------------------------------------
8.00  *       110123 mst  Behandler ikke reskontroposter, dvs konto > 9999
8.01  *       180123 mst  Poster til kostpris konto, behandles spesielt
8.02  *       240123 mst  'Orderline count' endres slik at den
      *                   styrer om det er faktura/kreditnota
8.03  *       240124 mst  Leser poster sortert
8.04  *       120225 mst  Benytter konto for øreavrunding mhp momskode
      * ----- ------ ---- -------------------------------------------------
8.03 f*ovupf    if   e             disk
8.03 ffovul1    if   e           k disk    rename(fovupfr:fovul1r)
     frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
     fsodtl1    if   e           k disk    rename(sodtpfr:sodtl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
     fra04l1    if   e           k disk    rename(ra04pfr:ra04l1r)
     frb00l1    if   e           k disk    rename(rb00pfr:rb00l1r)
8.01 fvgkkir    if   e           k disk    rename(vgkkst:vgkkirr)
      *
      *
     frm11pf    o    e           k disk
8.01 frm1xpf    o    e           k disk
      *
      * Definering av Local data area
      *
     d                uds
     d l_filg                931    933
     d l_firm                944    946  0
      *
      * Definering av variabler i nøkler
     d votyl1_otyp     s                   like(vaotyp)
     d aforl1_ruti     s                   like(afruti)
     d w_kidr          s              8  0
     d w_kidd          s                   like(sokidd)
     d w_kid2          s                   like(sokidd)
     d t1kkid          s             23
      *
     d b_kkid          s              1    inz(*off)
      *
     d fovfl1_peri     s                   like(ffperi)
8.03 d fovfl1_biln     s                   like(ffbiln)
      *
     d rkunl1_kund     s                   like(rkkund)
      *
     d rhovl1_kont     s                   like(rhkont)
     d rhovl1_spes     s                   like(rhspes)
     d rhovl1_avde     s                   like(rhavde)
     d ra04l1_firm     s                   like(radfir)
      *
     d sodtl1_aarr     s                   like(sdaarr)
     d sodtl1_binr     s                   like(sdbinr)
     d sodtl1_numm     s                   like(sdnumm)
     d sodtl1_suff     s                   like(sdsuff)
      *
      * Datastruktur for bilagsdato
     d                 ds
     d b_jdati                 1     10
     d  b_fa                   1      4
     d  b_f1                   5      5
     d  b_fn                   6      7
     d  b_f2                   8      8
     d  b_fd                   9     10
      *
      * Datastruktur for forfallsdato
     d                 ds
     d b_xdati                 1     10
     d  x_fa                   1      4
     d  x_f1                   5      5
     d  x_fn                   6      7
     d  x_f2                   8      8
     d  x_fd                   9     10
      * Datastruktur for forfallsdato
     d                 ds
     d b_fdati                 1     10
     d  f_fa                   1      4
     d  f_f1                   5      5
     d  f_fn                   6      7
     d  f_f2                   8      8
     d  f_fd                   9     10
      *
      *
     d fØrste          s              1  0
     d w_ponr          s              4
     d w_ident         s              6
     d w_jdat8         s              8
     d w_xdat8         s              8
     d w_jdat4         s              4
     d w_xdat4         s              4
     d w_bilk          s              3  0
     d x_bilk          s              3  0
     d w_period        s              2  0
     d w_aar           s              4  0
     d w_numb          s              7  0
     d w_vkod          s              5  0
     d x_vkod          s              1
     d w_belp          s             15  2
     d w_firm          s              3  0
     d w_binr          s                   like(sobinr)
     d w_aarr          s                   like(soaarr)
     d w_kundn         s              9  0
     d w_suppn         s             10  0
     d w_cont          s             30
     d w_adres         s            200
     d w_city          s             30
     d w_invtxt        s             25
     d w_t1kkid        s             30
     d w_fdat8         s              8
     d w_fdat4         s              4
     d w_blank         s              1
     d w_account       s             19
     d w_ledger        s            100
     d w_custdes       s            100
     d w_proj          s              6
     d w_depart        s              4
     d w_payment       s              4
     d w_blank1        s              1
     d w_gross         s             20  2
     d w_iban          s             50
     d w_swift         s             50
     d rb00l1_gkod     s                   like(r00kod)
     d w_type          s             10
     d w_rkftnr        s                   like(rkftnr)
     d w_nyf           s              1
     d w_count         s                   like(sdanta)
8.01 d y_bilk          s              3  0
     d w_navn          s                   like(rknavn)
     d w_notuse        s             30
     d w_ffmvag        s                   like(ffmvag)
      *
      * Eksternt program
       dcl-s co402_verdi1  char(1);
       dcl-s co402_verdi2  char(2048);
       DCL-PR CO402R EXTPGM('CO402R');
         p_filgrp            char(3)     const;
         p_firm              packed(3:0) const;
         p_lager             packed(2:0) const;
         p_nokkel            char(50)    const;
         p_verdi1            char(1);
         p_verdi2            char(2048);
       END-PR;
      * Heading
     c                   eval      rmdata = *blank
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Invoice no')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Invoice date')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Due date')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('KID')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c*                  eval      rmdata = %trim(rmdata) + %trim('"')
     c*                  eval      rmdata = %trim(rmdata) +
     c*                                     %trim('Payment type')
     c*                  eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c*                  eval      rmdata = %trim(rmdata) + %trim('"')
     c*                  eval      rmdata = %trim(rmdata) + %trim('Paid Amount')
     c*                  eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Order no')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Order date')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Customer no')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Customer name')
     c                   eval      rmdata = %trim(rmdata) + %trim('"')  + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata)
     c                                      + %trim('Organization NO')
     c                   eval      rmdata = %trim(rmdata) + %trim('"')  + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Customer email')
     c                   eval      rmdata = %trim(rmdata) + %trim('"')  + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Customer phone')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Customer mobile')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Adr. line 1')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Postal no')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c*                  eval      rmdata = %trim(rmdata) + %trim('"')
     c*                  eval      rmdata = %trim(rmdata) + %trim('Adr. line 1')
     c*                  eval      rmdata = %trim(rmdata) + %trim('"')  + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %trim('Postal city')
     c                   eval      rmdata = %trim(rmdata) + %trim('"')  +';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Delivery date')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Order line - description')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Order line - unit price')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Order line - count')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) +
     c                                      %trim('Order line - VAT code')
     c                   eval      rmdata = %trim(rmdata) + %trim('"') + ';'
     c                   write     rm11pfr
      *
8.01  * Finn hvilken bilagskode som skal benyttes
8.01 c                   eval      y_bilk  = vgkbik
      *
     c                   clear                   w_nyf
     c*                  eval      fovfl1_peri = 0
8.03 c*    fovfl1_key    setll     fovfl1
8.03 c     fovfl1_key    setll     fovul1
8.03 c*                  read      fovupf
8.03 c                   read      fovul1
     c                   dow       not %eof
8.00  * Ikke reskontoposter
8.00 c                   if        ffdkto <> 0
8.00 c                   if        ffdkto > 9999
8.00 c                   goto      les1
8.00 c                   endif
8.00 c                   endif
8.00 c                   if        ffckto <> 0
8.00 c                   if        ffckto > 9999
8.00 c                   goto      les1
8.00 c                   endif
8.00 c                   endif
8.00  *
8.01  * Spesial behandling hvis kostpris-poster
8.01 c                   if        ffbilk = y_bilk
8.01 c                   exsr      kostp
8.00 c                   goto      les1
8.01 c                   endif
8.01  *
     c                   if        l_firm <> fffirm
     c                   goto      slutt
     c                   endif
     c                   movel     'N'           w_nyf
      * Identification
     c                   eval      w_ident = 'GBAT10'
      *
      * Journal date
     c                   movel     ffbdat        b_jdati
     c                   movel     b_fa          w_jdat8
     c                   movel     b_fn          w_jdat4
     c                   move      b_fd          w_jdat4
     c                   move      w_jdat4       w_jdat8
      *
      *
      * Due date
     c                   movel     fffdat        b_xdati
     c                   movel     x_fa          w_xdat8
     c                   movel     x_fn          w_xdat4
     c                   move      x_fd          w_xdat4
     c                   move      w_xdat4       w_xdat8
      *
      * Journal type
      *
      * Øreavrunding på faktura
     c                   if        ffbilk = 17
     c                   if        x_bilk = 1
     c                   eval      w_bilk = x_bilk
     c                   eval      x_bilk = ffbilk
     c                   eval      fØrste = 0
     c                   goto      ettes
     c                   endif
     c                   endif
      *
      *
     c                   if        ffbilk = 3
     c                   eval      x_bilk = 3
     c                   endif
      *
     c                   if        ffbilk = 17
     c                   eval      x_bilk = 3
     c                   endif
      * Øreavrunding på kreditnota
      *
     c                   if        ffbilk = 17
     c                   if        x_bilk = 3
     c                   eval      w_bilk = x_bilk
     c                   eval      x_bilk = ffbilk
     c                   eval      fØrste = 0
     c                   goto      ettes
     c                   endif
     c                   endif
      *
     c                   eval      w_bilk = ffbilk
      *
     c                   if        ffbilk = 40
     c                   eval      w_bilk = 5
     c                   endif
      *
      * Ta vare på bilagskode første gang
     c                   if        fØrste = 0
     c                   add       1             fØrste
     c                   eval      x_bilk = w_bilk
     c                   endif
      *
     c     ettes         tag
      *
      * Period
     c                   movel     ffperi        w_period
      *
      * Accounting year
     c                   movel     w_jdat8       w_aar
      *
      * Accounting number
     c                   if        ffdkto > 9999
     c                   eval      ffdkto = radk05
     c                   else
     c                   if        ffckto > 9999
     c                   eval      ffckto = radk05
     c                   endif
     c                   endif
      *
      * Accounting number
     c                   if        ffdkto <> *zeros
     c*                  if        ffdkto = 3000
     c*                  eval      ffdkto = 3010
     c*                  eval      w_numb = ffdkto
     c*                  endif
     c                   eval      w_numb = ffdkto
     c                   else
     c*                  if        ffckto = 3000
     c*                  eval      ffckto = 3010
     c*                  eval      w_numb = ffckto
     c*                  else
     c                   eval      w_numb = ffckto
     c*                  endif
     c                   endif
      *
      * Vat Code
     c                   if        ffdmom <> *blank
     c                   move      ffdmom        w_vkod
     c                   else
     c                   move      ffcmom        w_vkod
     c                   endif
8.04  * Sjekker om momskode  skal konverteres,
8.04  *               kun hvis det ikke er konto for øredifferanse
8.04 c                   if        ffckto = radk14
8.04 c                   goto      eikon
8.04 c                   endif
8.04 c                   if        ffdkto = radk14
8.04 c                   goto      eikon
8.04 c                   endif
      * Sjekker om momskode  skal konverteres
     c                   eval      w_type      = 'MVAKODE'
     c                   clear                   rb00l1_gkod
     c*                  move      w_vkod        rb00l1_gkod
     c                   if        ffdmom <> *blank
     c                   move      ffdmom        rb00l1_gkod
     c                   else
     c                   move      ffcmom        rb00l1_gkod
     c                   endif
     c     rb00l1_key    chain     rb00l1
     c                   if        %found
     c*                  movel     r00nko        w_vkod
     c                   move      r00nko        w_vkod
     c                   endif
8.04 c     eikon         tag
      *
      *
     c                   if        ffckto = radk05
     c                   eval      w_vkod = 0
     c                   endif
      *
     c                   if        ffdkto = radk05
     c                   eval      w_vkod = 0
     c                   endif
      * Balance
     c                   if        ffdkto <> 0
     c                   eval      w_belp = ffbelp
     c                   eval      w_gross = ffbelp
     c                   else
     c     ffbelp        mult      -1            ffbelp
     c                   eval      w_belp = ffbelp
     c                   eval      w_gross = ffbelp
     c                   endif
      * Customer number
     c                   eval      w_kundn = ffkund
      * Address
     c                   eval      rkunl1_kund = ffkund
     c     rkunl1_key    chain     rkunl1                             90
     c                   movel     rkgate        w_adres
      *
      * Postcode
     c                   movel     rkponr        w_ponr
      * Finner kid
     c                   exsr      control_init
     c                   movel     t1kkid        w_t1kkid
      * Due date
     c                   movel     fffdat        b_xdati
     c                   movel     x_fa          w_xdat8
     c                   movel     x_fn          w_xdat4
     c                   move      x_fd          w_xdat4
     c                   move      w_xdat4       w_xdat8
      *
      * Invoice number
     c                   movel     ffbiln        w_invtxt
      * Gross
     c                   eval      w_blank1 = 'T'
      *
      * Sjekk hovedboks konto Bank account
     c                   if        ffdkto <> 0
     c                   move      ffdkto        rhovl1_kont
     c                   eval      rhovl1_spes = *zero
     c                   eval      rhovl1_avde = *zero
     c     rhovl1_key    chain     rhovl1                             62
      *
     c                   if        *in62 = *off
     c                   movel     ffdkto        w_account
     c                   movel     rhtext        w_ledger
     c                   else
     c                   if        ffckto <> 0
     c                   move      ffckto        rhovl1_kont
     c                   eval      rhovl1_spes = *zero
     c                   eval      rhovl1_avde = *zero
     c     rhovl1_key    chain     rhovl1                             62
      *
     c                   if        *in62 = *off
     c                   movel     ffckto        w_account
     c                   movel     rhtext        w_ledger
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
      * Project
     c                   movel     ffproj        w_proj
      *
      * Ordre linje
     c                   if        w_nyf  = 'N'
     c                   eval      sodtl1_aarr = w_aar
     c                   eval      sodtl1_binr = ffbiln
     c                   clear                   sodtl1_numm
     c                   clear                   sodtl1_suff
     c     sodtl1_key    setll     sodtl1
      *
     c     les2          tag
     c                   if        w_nyf = 'N' or w_nyf ='O'
     C                   exsr      ordre
     c                   if        w_nyf = ' '
     c                   goto      les1
     c                   endif
     c                   endif
      *
     c                   endif
      **********************************************************************
     c*
     c**********
     c* Disse to felt skrives ikke ut verdi
     c                   clear                   w_belp
     c                   clear                   sdbinr
     c                   if        sdsapr >= 0
     c                   z-add     1             w_numb
     c                   else
     c                   z-sub     1             w_numb
     c                   endif
8.02  *
8.02 c                   if        ffdkto <> 0
8.02 c     w_numb        mult      -1            w_numb
8.02 c                   endif
8.02  *
     c                   if        ffmvag =  0
     c                   z-add     ffbelp        w_ffmvag
     c                   else
     c                   z-add     ffmvag        w_ffmvag
     c                   endif
      *
     c                   eval      rmdata = *blank
     c   40              eval      rmdata = %trim('"')
      *
      * Journalnr.
     c                   eval      rmdata = %trim(rmdata) + %char(ffbiln) +
     c                                                      %trim('"') + ';'
      * Journal date
     c*                                     %trim(w_jdat8) + &trim('"') + ';' +
     c*                                                     + %trim('"')
     c*                  eval      rmdata = %trim(rmdata) + %char(w_jdat8) +
     c*                                                     %trim('"') + ';' +
     c                   eval      rmdata = %trim(rmdata) + ('"') + %char(b_fa)
     c*                                                     + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fn)
     c*                                                     + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fd)
     c                                                      + %trim('"') + ';'
      * Due date
     c*                                     %trim(w_xdat8) + ('"')
     c*                                                     %trim('"')
     c*                  eval      rmdata = %trim(rmdata) + %char(w_xdat8) +
     c*                                                     %trim('"') + ';'
     c                   eval      rmdata = %trim(rmdata) + ('"') + %char(x_fa)
     c*                                                     + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(x_fn)
     c*                                                     + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(x_fd)
     c                                                      + %trim('"') + ';'
      * Kid
     c*  40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) + %trim(w_t1kkid)
     c*  40              eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';'
     c*  40              eval      rmdata = %trim(rmdata) + '"'
     c*                  eval      rmdata = %trim(rmdata) + '"'
     c*                  eval      rmdata = %trim(rmdata) + ';' +
      * Journal type
     c*                                                     %trim('"') +
     c*                                     %char(w_bilk) + %trim('"') + ';' +
      * Balance
     c*                                                     %trim('"') +
     c*                                     %char(w_belp)  + %trim('"') + ';'+
      * Order nr
     c                   eval      rmdata = %trim(rmdata) +  '"' +
     c*                                                     %trim('"') +
    *c                                      %char(sdnumm)  + %trim('"') + ';'
      * Order date
     c*                  eval      rmdata = %trim(rmdata) + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + ('"') + %char(b_fa)
     c*                                                     + %trim('"')
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fn)
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fd)
     c                                                      + %trim('"') + ';'
    *c*                                     %char(w_jdat8) + %trim('"') +  ';' +
      * Customer numb
     c                   eval      rmdata = %trim(rmdata) + %trim('"') +
     c                                      %char(w_kundn) + %trim('"')  + ';'
      * Contact name
     c   40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  %trim(rknavn)
     c   40              eval      rmdata = %trim(rmdata) + '"'
     c*                  eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';'
      * Org.no
     c*  40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  %char(w_rkftnr)
     c*  40              eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';' +
      * Customer email
     c                                                      %trim('"') +
     c                                      %trim(rkemal)  + %trim('"') + ';' +
      * Customer phone
     c                                                      %trim('"') +
     c                                      %trim(rktlfn)  + %trim('"') + ';'  +
      * Customer mobil
     c                                                      %trim('"') +
     c                                      %trim(rkmobn)  + %trim('"') + ';'
      * Adress
     c   40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  %trim(w_adres)
     c   40              eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';'
      * Postcode
     c   40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  %trim(w_ponr)
     c   40              eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';'
      * City
     c   40              eval      rmdata = %trim(rmdata) +  '"'
     c                   eval      rmdata = %trim(rmdata) +  %trim(w_city)
     c   40              eval      rmdata = %trim(rmdata) + '"'
     c                   eval      rmdata = %trim(rmdata) + ';' +
      * Delivery date
     c                                                      %trim('"')
     c                   eval      rmdata = %trim(rmdata) + %char(b_fa)
    *c*                                     %trim(w_jdat8) + %trim('"') + ';' +
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fn)
     c                   eval      rmdata = %trim(rmdata) + '-'
     c                   eval      rmdata = %trim(rmdata) + %char(b_fd)
     c                                                      + %trim('"') + ';'
      * Order line description
     c                   eval      rmdata = %trim(rmdata) + %trim('"') +
    *c*                                     %trim(sdtek1) + %trim('"') + ';'  +
    *c                                      %trim(fftext) + %trim('"') + ';'  +
      * Order line Unit price
    *c*                                     %char(sdsapr) + ';'  +
    *c*                                     %char(ffbelp) + ';'  +
    *c                                      %char(w_ffmvag) + ';'  +
      * Order line count
     c                                                      %trim('"') +
     c                                      %char(w_numb) + %trim('"') + ';'  +
      * VAT code
     c                                                      %trim('"') +
     c                                      %char(w_vkod)  + %trim('"') + ';'

     c************************************************************************
     c*    'Æ':X'46'     xlate     nsdata        nsdata
     c*    'æ':X'A0'     xlate     nsdata        nsdata
     c*    'Ø':X'77'     xlate     nsdata        nsdata
     c*    'ø':X'90'     xlate     nsdata        nsdata
     c*    'Å':X'2A'     xlate     nsdata        nsdata
     c*    'å':X'EF'     xlate     nsdata        nsdata
     c                   movel     *blanks       w_iban
     c                   movel     *blanks       w_swift
     c                   write     rm11pfr
      *
     c                   if        w_nyf <> ' '
     c*                  goto      les2
     c                   endif
     c     les1          tag
      *
      * Blanker felt
     c                   exsr      blank
      *
8.03 c*                  read      fovupf
8.03 c                   read      fovul1
     c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   eval      *inlr = *on
     c     slutt         tag
8.01  *
8.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.01  *  Kostpris ?
8.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.01  *
8.01 c     kostp         begsr
8.01  * Identification
8.01 c                   eval      w_ident = 'GBAT10'
8.01  *
8.01  * Journal date
8.01 c                   movel     ffbdat        b_jdati
8.01 c                   movel     b_fa          w_jdat8
8.01 c                   movel     b_fn          w_jdat4
8.01 c                   move      b_fd          w_jdat4
8.01 c                   move      w_jdat4       w_jdat8
8.01  *
8.01  * Journal type   / konstant 6
8.01  ***************
8.01 c*                  eval      w_bilk = 6
8.01  *
8.01  * Period
8.01 c                   movel     ffperi        w_period
8.01  *
8.01  * Accounting year
8.01 c                   movel     w_jdat8       w_aar
8.01  *
8.01  *
8.01  * Accounting number
     c                   if        ffdkto <> *zeros
     c                   eval      w_numb = ffdkto
     c                   else
     c                   eval      w_numb = ffckto
     c                   endif
8.01  *
8.01  * Vat Code
8.01  *
8.01 c                   if        ffdmom <> *blank
8.01 c                   move      ffdmom        w_vkod
8.01 c                   else
8.01 c                   move      ffcmom        w_vkod
8.01 c                   endif
8.01  * Sjekker om momskode  skal konverteres
8.01 c                   eval      w_type      = 'MVAKODE'
8.01 c                   move      w_vkod        rb00l1_gkod
8.01 c     rb00l1_key    chain     rb00l1
8.01 c                   if        %found
8.01 c*                  movel     r00nko        w_vkod
8.01 c                   move      r00nko        w_vkod
8.01 c                   endif
8.01  *
8.01  * Balance
8.01 c                   if        ffdkto <> 0
8.01 c                   eval      w_belp = ffbelp
8.01 c                   eval      w_gross = ffbelp
8.01 c                   else
8.01 c     ffbelp        mult      -1            ffbelp
8.01 c                   eval      w_belp = ffbelp
8.01 c                   eval      w_gross = ffbelp
8.01 c                   endif
8.01  *
8.01  * Customer number
8.01 c                   eval      w_kundn = ffkund
8.01  * Address
8.01 c                   eval      rkunl1_kund = w_kundn
8.01 c     rkunl1_key    chain     rkunl1                             90
8.01 c                   if        *in90 = '0'
8.01 c                   movel     rkgate        w_adres
8.01  * Postcode
8.01 c                   movel     rkponr        w_ponr
8.01  * Postcode
8.01 c                   movel     rknavn        w_navn
8.01 c                   endif
8.01  * Due date
8.01 c                   movel     fffdat        b_fdati
8.01 c                   movel     b_fa          w_fdat8
8.01 c                   movel     b_fn          w_fdat4
8.01 c                   move      b_fd          w_fdat4
8.01 c                   move      w_jdat4       w_fdat8
8.01  * Invoice number
8.01 c                   movel     ffbiln        w_invtxt
8.01  *
8.01  * Gross
8.01 c                   eval      w_blank1 = 'T'
8.01  *
8.01  * Sjekk hovedboks konto Bank account
8.01 c                   if        ffdkto <> 0
8.01 c                   move      ffdkto        rhovl1_kont
8.01 c                   eval      rhovl1_spes = *zero
8.01 c                   eval      rhovl1_avde = *zero
8.01 c     rhovl1_key    chain     rhovl1                             62
8.01  *
8.01 c                   if        *in62 = *off
8.01 c                   movel     ffdkto        w_account
8.01 c                   movel     rhtext        w_ledger
8.01 c                   movel     rhtext        w_navn
8.01 c                   move      *blanks       w_adres
8.01 c                   move      *blanks       w_ponr
8.01 c                   move      *blanks       w_city
8.01 c                   end
8.01 c                   end
8.01  *
8.01 c                   if        ffckto <> 0
8.01 c                   move      ffckto        rhovl1_kont
8.01 c                   eval      rhovl1_spes = *zero
8.01 c                   eval      rhovl1_avde = *zero
8.01 c     rhovl1_key    chain     rhovl1                             62
8.01  *
8.01 c                   if        *in62 = *off
8.01 c                   movel     ffckto        w_account
8.01 c                   movel     rhtext        w_ledger
8.01 c                   movel     rhtext        w_navn
8.01 c                   move      *blanks       w_adres
8.01 c                   move      *blanks       w_ponr
8.01 c                   move      *blanks       w_city
8.01 c                   endif
8.01 c                   endif
8.01  *
8.01  * Project
8.01 c                   movel     ffproj        w_proj
8.01  **********************************************************************
8.01 c*
8.01 c**********
8.01 c                   eval      rmdata = *blank
8.01 c                   eval      rmdata = %trim('"') +
8.01  *
8.01  * Identification
8.01 c                                     %trim(w_ident) + '"' + ';' +
8.01  * Journalnr.
8.01 c                                     %char(ffbiln) + ';' +
8.01  * Journal date
8.01 c                                     %trim(w_jdat8) + ';' +
8.01  * Journal type
8.01 c                                     %char(x_bilk)  + ';' +
8.01  * Period
8.01 c                                     %char(w_period)  + ';' +
8.01  * Account Year ?????
8.01 c                                     %char(w_aar)  + ';' +
8.01  * Account Numb ?????
8.01 c                                     %char(w_numb)  + ';' +
8.01  * VAT code
8.01 c                                     %char(w_vkod)  + ';' +
8.01  * Balance
8.01 c                                     %char(w_belp)  + ';' +
8.01  * Customer numb
8.01 c                                     %char(w_kundn)  + ';' +
8.01  * Supplier number
8.01 c                                     %char(0)       + ';' +
8.01  * Contact name
8.01 c                               '"'+  %trim(w_navn) + '"' + ';' +
8.01  * Adress
8.01 c                               '"'+  %trim(w_adres) + '"' + ';' +
8.01  * Postcode
8.01 c                               '"'+  %trim(w_ponr) + '"' + ';' +
8.01  * City
8.01 c                               '"'+  %trim(w_city) + '"' + ';' +
8.01  * Invoice number (TXT)
8.01 c                               '"'+  %trim(w_invtxt) + '"' + ';' +
8.01  * Not used
8.01 c                               '"'+  %trim(w_notuse) + '"' + ';' +
8.01  * Due date
8.01 c                                     %trim(w_fdat8) + ';' +
8.01  * Not used
8.01 c                                     %trim(w_blank) + ';' +
8.01  * Bank Account
8.01 c                               '"'+  %trim(w_account) + '"' + ';' +
8.01  * Ledger description
8.01 c                               '"'+  %trim(w_ledger) + '"' + ';' +
8.01  * Customer description
8.01 c                               '"'+  %trim(w_custdes) + '"' + ';' +
8.01  * Factoring rateiption
8.01 c                                     %char(1)          + ';' +
8.01  * Project
8.01 c                                     %trim(w_proj)     + ';' +
8.01  * Department
8.01 c                                     %trim(w_depart)     + ';' +
8.01  * Payment terms
8.01 c                                     %trim(w_payment)     + ';' +
8.01  * Gross
8.01 c                                     %trim(w_blank1)     + ';' +
8.01  * Gross sum
8.01 c                                     %char(w_gross)     + ';' +
8.01  * IBAN
8.01 c                               '"'+  %trim(w_iban) + '"' + ';' +
8.01  * SWIFT
8.01 c                               '"'+  %trim(w_swift) + '"'
8.01  **********************************************************************
8.01 c************************************************************************
8.01 c*    'Æ':X'46'     xlate     nsdata        nsdata
8.01 c*    'æ':X'A0'     xlate     nsdata        nsdata
8.01 c*    'Ø':X'77'     xlate     nsdata        nsdata
8.01 c*    'ø':X'90'     xlate     nsdata        nsdata
8.01 c*    'Å':X'2A'     xlate     nsdata        nsdata
8.01 c*    'å':X'EF'     xlate     nsdata        nsdata
8.01 c                   movel     *blanks       w_iban
8.01 c                   movel     *blanks       w_swift
8.01 c                   write     rm1xpfr
8.01 c     kostx         endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Blanker felter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     blank         begsr
      *
     c                   eval      w_ponr = *blanks
     c                   eval      w_binr = *zeros
     c                   eval      w_aarr = *zeros
     c                   eval      w_ident = *blanks
     c                   eval      w_jdat8 = *blanks
     c                   eval      w_jdat4 = *blanks
     c                   eval      w_bilk  = *zeros
     c                   eval      w_period  = *zeros
     c                   eval      w_aar  = *zeros
     c                   eval      w_numb  = *zeros
     c                   eval      w_vkod  = *zeros
     c                   eval      x_vkod  = *blanks
     c                   eval      w_belp  = *zeros
     c                   eval      w_kundn = *zeros
     c                   eval      w_suppn = *zeros
     c                   eval      w_cont  = *blanks
     c                   eval      w_adres = *blanks
     c                   eval      w_city  = *blanks
     c                   eval      w_invtxt  = *blanks
     c                   eval      w_t1kkid  = *blanks
     c                   eval      w_fdat8  = *blanks
     c                   eval      w_blank  = *blanks
     c                   eval      w_account = *blanks
     c                   eval      w_ledger = *blanks
     c                   eval      w_proj = *blanks
     c                   eval      w_depart = *blanks
     c                   eval      w_payment = *blanks
     c                   eval      w_blank1 = *blank
     c                   eval      w_gross = *zeros
     c                   eval      w_iban  = *blanks
     c                   eval      w_swift  = *blanks
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Henter ordre
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     ordre         begsr
      *
     c*                  eval      sodtl1_aarr = w_aar
     c*                  eval      sodtl1_binr = ffbiln
     c*                  clear                   sodtl1_numm
     c*                  clear                   sodtl1_suff
      *
     c*    sodtl1_key    setll     sodtl1
     c*    sodtl2_key    reade     sodtl1
     c                   read      sodtl1
      *
      * Legg ut post
      *
     c                   if        sdbinr =  ffbiln
     c                   movel     'O'           w_nyf
     C                   z-add     1             W_count
     c                   endif
      *
     c                   if        %eof(sodtl1)
     c                   movel     ' '           w_nyf
     c                   endif
      *
     c                   endsr
      **********************************************************************
     c     control_init  begsr
      **********************************************************************
      *
     c                   eval      w_firm = fffirm
     c                   eval      w_binr = ffbiln
     c                   move      b_fa          w_aarr
      * Finner siste faktura-hode for faktura
      *
     c     sohel1_key    setll     sohel1
     c     sohel1_key    reade     sohel1                                 90
     c                   if        *in90 = *on
     c                   goto      avslutt
     c                   endif
      *
     c                   dow       *in90 = *off
     c     sohel1_key    reade     sohel1                                 90
     c                   enddo
      *
     c     avslutt       tag
      *
      * Henter rutine fra ordretype
      *
     c                   eval      b_kkid = *off
     c                   eval      votyl1_otyp = sootyp
     c     votyl1_key    chain     votyl1
     c                   if        %found(votyl1)   and
     c                             vaorut <> *blank
     c                   eval      aforl1_ruti = vaorut
     c     aforl1_key    chain     aforl1
     c                   if        %found(aforl1) and
     c                             afkidk = 1
     c                   movel     sokidd        t1kkid
     c                   else
     c                   if        afkidk = 2
     c                   movel     sokidr        t1kkid
     c                   else
     c                   if        afkidk = 3
     c                   movel     sokidr        w_kidr
     c                   movel     sokidr        w_kidr
     c                   call      'AK710R'
     c                   parm                    w_firm
     c                   parm                    w_kidr
     c                   parm                    w_kidd
     c                   parm                    w_kid2
     c                   movel     w_kid2        t1kkid
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      *
      * Key for les av ordretype
      *
      * Key for oppslag på faktura-hode-register
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_aarr
     c                   kfld                    w_binr
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for les av rutine-register
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for hovedbok
      *
     c     rhovl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhovl1_kont
     c                   kfld                    rhovl1_spes
     c                   kfld                    rhovl1_avde
      *
      * Key for oppslag på kunde
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
      *
      * Key for posisjonering på posteringsfil
      *
     c     fovfl1_key    klist
     c                   kfld                    w_firm
8.03 c*                  kfld                    fovfl1_peri
8.03 c                   kfld                    fovfl1_biln
      *
      * Key for posisjonering på faste konti
      *
     c     ra04l1_key    klist
     c                   kfld                    w_firm
      * Key for posisjonering på koder (moms)
      *
     c     rb00l1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_type
     c                   kfld                    rb00l1_gkod
      *
     c     sodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
     c                   kfld                    sodtl1_numm
     c                   kfld                    sodtl1_suff
      *
     c     vgkkir_key    klist
     c                   kfld                    w_firm
      *
     c     sodtl2_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtl1_aarr
     c                   kfld                    sodtl1_binr
      *
     c                   eval      w_firm = l_firm
      *
     c     ra04l1_key    chain     ra04l1
      *
      *
      * Hent kostkonto salg og bilagskode
      *
     c                   eval      w_firm = l_firm
     c     vgkkir_key    chain     vgkkir
      *
      * Variant av Mamut format
      *  *in40=*on betyr at det skal legges ut " før og etter noen felter
     c                   eval      *in40 = *on
       CallP CO402R(l_filg:w_firm:0:'MAMUT':
                        co402_verdi1:co402_verdi2);
       if co402_verdi1 = '1';
        if %subst(co402_verdi2:1:1) = '1';
         *in40 = *off;
        endif;
       endif;
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
