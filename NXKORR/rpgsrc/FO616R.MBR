     h option(*nodebugio)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : FO616R
      * Beskrivelse . . : Oppdatering av fakt.reg, økonomi og stat.
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
3.01  * R3.01 021199 AMD  Lagt inn logikk for behandling av internfaktura
3.01  *                   med tilhørende posteringer. Kunden som skal beny-
3.01  *                   ttes som internfakturakunde, må ha kode 1 i feltet
3.01  *                   Spes. fakt og kode 1 på avgiftsfri.
      *       051299 HKO  Initierer omregningsfaktorer for volum før
      *                   kalkulasjon av antall mot statistikkenhet
      * R3.10 010200 AMD  Justeringer for varer hentet fra LVR
      * R3.11 220200 AMD  Leveringstype er lagt inn i statistikkfilen og
      *                   blir nå oppdatert.
      * R3.11 250300 HKO  Volum, nettovekt og bruttovekt har endret lengde
      *                   i vareregisteret. Tilpasset oppdatering av
      *                   gammel statistikkfil
3.12  * R3.12 240700 KOB  Lagt ut antall i hovedboksposteringen
3.13  * R3.13 191000 AMD  Tatt med oppdatering av planlagt leveringsdato
3.14  * R3.14 311000 AMD  Kontohenvisning er tatt med i parameterliste
3.31  * R3.31 040101 AMD  Dato for mva er endret fra ordre- til fakturadato.
3.32  * R3.32 280301 AMD  Lagt inn mulighet for å styre om rabatter skal
      *                   vises med prosent, eller som bare et nettobeløp.
3.33  * R3.33 220601 AMD  Tekstlinjer som er registrert etter en vare hvor
3.33  *                   det er gitt rabatt, fikk med seg rabatten.
3.34  * R3.34 080601 AMD  Differensiert moms, 24 og 12 %
3.35  * R3.35 170801 AMD  Momskode legges nå inn også på øreavrunding,
3.35  *                   nei, endrer tilbake til momskode 0 her
3.36  * R3.36 120302 AMD  Ny statistikk ble ikke oppdatert med poster
3.36  *                   som ble automatisk generert under gebyrer
4.01  * R4.01 080202 AMD  Oppdatering av S/36 statistikk er nå kuttet ut.
4.01  *                   Oppdatering av S/36 regnskap   er nå kuttet ut.
4.01  *                   Overføring til regnskap går nå via databasefil
4.01  *                   Programmet er delvis lagt om til ILE-std.
4.02  * R4.02 190302 AMD  Endring fra spes til kostnadsbærer
5.01  * R5.01 041002 AMD  Tatt med oppdatering av nettbutikkens ordrenr
5.02  * R5.02 041002 AMD  Tatt med oppdatering av kryssref ordre/best.
5.03  * R5.03 071002 AMD  Tatt med oppdatering av leveringsmåte i stat.
5.04  * R5.04 111002 AMD  Ny løsning for å kunne benytte kortere KID
5.04  *                   + oppdatering av kiddnr i hist fakt reg
5.05  * R5.05 220503 AMD  Lagt inn igjen oppdatering av SFLINE.
5.20  * R5.20 171003 AMD  Utvidet med mulighet for å kunne kontere på
      *                   leveringstype
5.21  * R5.21 031103 AMD  Oppdatering av kode for eksternt system
      *       161103 HKO  Fjernet behandling av rabattgruppe
5.22  * R5.22 241103 AMD  Lagt inn linjereferanse som skal over i
5.22  *                   økonomisystemet for krysskobling
5.23  * R5.23 261103 AMD  Forfallsdato på kreditnota lik fakturadato
5.24  * R5.24 051203 AMD  Lagt inn oppdatering av alternativ varegrp.
5.25  * R5.25 121203 AMD  Konto for øreavrunding skal også legges ut
5.25  *                   med avdeling.
5.30  * R5.30 181203 ASK  Lagt ut nytt felt for MVA-grunnlag før alm.rab
5.30  *                   trekkes fra totalbeløp i posteringsreg.
5.31  * R5.31 181203 ASK  Lagt ut nye felter i hist.fakt.,post.fil og stat.
5.31  *                   i forbindelse med almenningsrabatt.
5.32  * R5.32 080104 ASK  Lagt inn håndtering av lager på ordrelinjenivå.
5.32  *                   Lagt inn averstyring av avd. ved overstyrt lager.
5.33  * R5.33 200104 AMD  Lagt inn kostnadsføring ved internordre på
5.33  *                   avdeling hentet fra kunderegister dersom oppgitt.
5.34  * R5.34 100204 ASK  Korreksjon lagt inn for å ungå at negativt
5.34  *                   MVA-grunnlag blir lagt ut ved kreditnota.
5.35  * R5.35 240304 ASK  Korreksjon lagt inn for å få med mva på
5.35  *                   automatiske gebyrer i fakturatotal.
5.36  * R5.36 250304 ASK  Korreksjon lagt inn for å få legge riktig
5.36  *                   avdling ved overstyring av lager på linje.
5.37  * R5.37 060504 AMD  Lagt inn oppdatering av Nobb-nummer
5.38  * R5.38 080904 AMD  Lagt inn ordretype for nummerserie (se dok)
5.39  * R5.39 160904 AMD  Bongnummer er nå et alfafelt
5.39  * R5.39 211004 AMD  Lagt inn oppdatering av produktansvarlig
5.39  *                   fra varegruppeplan vha. nytt program
5.40  * R5.40 260804 ASK  Lagt inn korreksjon for å få riktig MVA-
5.40  *                   beregning ved rabattspesifikasjon.
5.41  * R5.41 231104 GRO  Oppdaterer utg.fakt.logg (FNUFPF)
5.42  * R5.42 261104 ASK  Korrigert feil mva. behandling ved spesifikasjon
5.42  *                   av ordrerabatt til hovedbok.
5.43  * R5.43 140105 ASK  Lagt inn oppdatering av pakkseddel dato
5.43  *                   og uke i statistikk.
5.44  * R5.44 090305 ASK  Lagt inn ekstra kontroll på 0 blir lagt ut i mva
5.44  *                   grunlag ved mva-kode = 4
5.45  * R5.45 300605 AMD  Lagt inn dummy-parameter for å hindre
5.45  *                   forurensning av parameter-lister
      *       080805 HKO  Fjernet oppdatering av nettovekt, bruttovekt og
      *                   volum fra salgsstatistikken
      *                   Fjernet nettovekt og bruttovekt fra ordre-
      *                   hode og faktura-hode
      *       110805 HKO  Lagt inn varetype i salgsstatistikken
5.46  * R5.46 080905 ASK  Lagt inn korreksjon som sikrer riktig mva
5.46  *                   på fakturagebyr.
      *       231005 HKO  Fjernet bonuskode fra salgsstatistikken
5.47  * R5.47 170206 BOF  Lagt på uke på statistikk
5.48  * R5.48 270206 AMD  Lagt inn oppdatering av kundeprosjekt og
      *                   kundens bestillingsnummer i historisk faktura
      *                   register
5.49  * R5.49 130206 AMD  Løsning for Eker/Ikas som skal inn i standard
      *                   etter hvert da det betinger database-endring
5.50  * R5.50 060307 BOF  Tester på overstyring FOFATY ist.f RKFATY
5.51  * R5.50 150807 BOF  Oppdaterer SOFATY fra FOFATY
5.50  * R5.50 270807 KOB  Endret tester vedr mva-behandling av rabatter til egen konto
5.50  * R5.50 270807 KOB  Fjernet tabell for bilagstekst - ikke i bruk
5.60  * R5.60 061107 AMD  Lagt inn løsning for kontroll av grense for
5.60  *                   almenningsrabatter
5.61  * R5.61 301107 AMD  Leveringstype ble ikke overført til SOHEPF
5.62  * R5.62 230508 AMD  Lagt inn løsning for depositum
5.63  * R5.63 240308 KOB  Lagt inn omregning til aktuell og nominell m3
5.64  * R5.64 070708 AMD  Legger ut kontohenvisningskode i stat+hist
5.65  * R5.65 060808 ASK  Legger ut ean-nummer fra ordrelinje til stat.
5.66  * R5.66 160908 AMD  Kredit-referanse ble ikke lagt ut på FOVFPF
5.67  * R5.67 161109 bof  EFAKTURA og kreditnota går ikke, setter faty = 21
5.69  * R5.69 261109 AMD  Korrigering for år 2010
5.70  * PRGR  231008 sst  Prisgruppe
5.70  *       131108 bof  Prisgruppe på SSTAPF, SODTPF
5.77  *  5.77 071010 AMD  Bruksrettsrabatter skal ikke ha momskode
5.77  *                   og skal ikke inngå i momsgrunnlaget.
6.10  * R6.10 250609 BSA  Oppdatert med sporingsinformasjon
6.11  * R6.11 041209 AMD  Fra V6.10 blir det avrunding til hel krone
6.12  * R6.12 091209 AMD  Justeringer av kode som var ufullstendig
6.13  * R6.13 101209 AMD  Endringer pga. mer fleksibel mva. behandling
6.14  * R6.14 101209 AMD  Fjernet kode for %-andel ved mva. behandling
6.15  * R6.15 290310 AMD  Endret slik at grunnlag mva blir satt til 0
6.15  *                   også ved mva.kode '0' og ' ' (se ref. 5.44)
6.16  * R6.10 070510 BSA  Endret logging av sporing
6.17  * R6.17 071010 AMD  Gebyrpost i SODTPF fikk ikke mva.kode
6.17  *                   (Se også ref 5.46)
6.18  * R6.10 261010 bof  Legger ut kundes eanfaktura på FNUFPF
6.19  * R6.10 011210 BSA  Hvis kortfakturering, genererer vi både ekstra
6.19  *                   reskontro og hovedbokspost.
6.1a  * R6.10 070513 bof  EHF krever avrudning av SDSALG
6.20  * R6.10 011210 BSA  Hvis kortfakturering, lages transaksjon i BOKK
6.21  * R6.10 030111 BSA  Setter post for oppgjort i reskontro. (saldert)
6.22  * R6.10 050111 BSA  Feil konto/avdeling legges ut på statistikk
6.22  *                   og historisk fakturaregister.
6.23  * R6.10 270111 bsa  Kontohenvisninger på vare skal følge økonomi.
6.23  *                   Gebyrlinjer legger ikke ut avd/kto info.
6.24  * R6.10 070211 bsa  behandler BM Kort og Maxbo kort på samme måte
6.24  *                   med tanke på automatiske posteringer.
6.25  * 6.20  151110 NHO  proj er nå alfa, underprosjekt på legges ut
6.26  * 6.20  220211 BSA  Legger ut kortkode på statistikk.
6.27  * R6.10 110411 AMD  Teksten almenningsrabatt skal ikke legges ut
6.28  * 6.20  190511 bof  Utvidet VL710R med utg.dato og l.dor
6.29  * 6.20  201211 bof  Utvidet med pakkseddel dato og lev.dato på linjen
6.30  * R6.20 030112 AMD  Dersom mva hadde endring som trådte i kraft
6.30  *                   01.01.xx og det ble fakturert på foregående
6.30  *                   år, ble det feil pga dato v/innhenting mva.
6.2A  * R6.10 171011 bsa  To mulige varianter for oppgjørsform på kortfaktura.
6.2A  *                   H=hovedbok, R=Reskontro m/egen bilagkode
6.2B  * R6.10 271011 bsa  Egen bilagskode for kreditordre
6.2c  * R6.10 300312 bsa  Innfører GE kort, behandles på samme måte som BM og Maxbo kort
6.2d  * R6.20 151013 bkv  Legg inn Lokalt vreg info i Statistikk
6.2e  * R6.20 211013 sst  Rettet feil utlegg av prosjekt (6.25)
6.2f  * R6.20 090414 bof  Legger ut best.linjenr i statistikk og hist.stat
6.2g  * R6.20 111114 bsa  Sjekk om feltet sprekker før vi oppdaterer
6.2h  * R6.20 191114 bkv  Gjør clear av vvarl1r. Kun skaffevare hvis ikke i vvar
6.2i  * R6.20 261114 bsa  Mangler utlegging av bestillingsreferanser.
6.nu  * R6.30 040614 bsa  Programmet gjennomgått mtp nummerutvidelser.
6.nu  * R6.30 250614 bof  Ny kid pga. nummerutvidelse
6.30  * R6.30 140814 bsa  Bilagskode fra kortreg løegges også på reskontroposten.
6.31  * R6.30 050914 bof  Oppdatere statistikk med prosjekt
6.32  * R6.30 110914 Bsa  Fjernet saldofelt alm fra kunde til eget
6.32  *                   register.
6.33  * 6.30  120914 BKV  Henter overstyrt info fra kundeprosjekt
6.34  *       210115 NHO  Feil på w_kki2 før call til AK700R
      *                   må flyttes 2 til venstre
6.34  * R6.30 101014 bof  Utvidet BM statistikk
6.35  * 6.30  221015 BOF  Justert vp900r parm, pga. nummer.utv.
6.35a * R6.30 189815 bof  Bruk av inlr mot VP905R, pga. treghet (6.35 i org)
6.36  * R6.30 130416 bsa  Bilagskode fra kortreg legges også på reskontroposten.
6.36  *                   NB Kun hvis reskontrooppfølging. Utvidet test av 6.30.
6.37  * R6.30 210616 bof  La inn SFCARD, hadde falt ut fra BMpakke til 630
6.38  * R6.30 100317 bof  mva.kode på fakt.gebyr
6.39  * 6.30  170317 bof  Hvis gavekort, ikke oppdat stat.
6.3a  * 6.30  040417 bof  Hvis LVR, så sett vvkmva = 0 (dvs. moms på varen)
6.3b  * 6.30  280817 nho  SFTEK2 ble ikke oppdatert
6.nu  * R6.30 180218 bsa  Endringer pga nummerutvidelse
6.3c  * 6.30  050418 bkv  Håndter at FDANTA er 11.3 og t_mngd er 9.2
6.3d  * 6.30  260418 bsa  Bruk avdeling fra linjenivå, IKKE hode.
6.3e  * 6.30  170918 bkv  Utvidet med trelast sortiment
6.3f0 * 6.30  290319 bof  Endret test for å finne leverandør (sst, 131020)
6.3f  * 6.30  230819 bof  sfkpri tas alltid fra fdkpri (ordrelinja)
6.3g  * 6.30  300919 bkv  Snu fortegn på sum rabatt og legg inn moms beløp
      *K00 - 200420 START FOR VERSJON K00
7.01  * 7.00  151119 bkv  Legge inn statistikk sidetabell
6.3h  * 6.30  200420 sst  Rettet feil utlegg av prosjekt (6.25)
7.02  *K00 131020 sst NXS-5513  Fakturagebyr pr fakturatype m/følgende oppslag:
7.02  *                            Ordretype   kundekategori   fakturatype
7.02  *                      1.         xx          xxxx           xx
7.02  *                      2.         xx          0000           xx
7.02  *                      3.         xx          xxxx           00
7.02  *                      4.         xx          0000           00
7.02  *                      5.         00          xxxx           xx
7.02  *                      6.         00          0000           xx
7.02  *                      7.         00          xxxx           00
7.02  *                      8.         00          0000           00
7.03  * K00   150720 ask  Lagt inn timestamp for loggoppfølging og skriv til loggfiler
7.04  *       121020 bof  Test på pristype før MAN settes
7.05  * K00   040321 ask  Utvidet linjeteller for loggfile
7.06  * K00   050321 bsa  Kan ikke beregne fakturagebyr to ganger
      *
7.07  *K000   110321 bsa  Paramaterstyrer kostnadsfordeling.
7.07  *       010715 bsa  NB! Ikke godt nok at avvik på lager mellom
7.07  *                   ordrehode og ordrelinje er det som utløser
7.07  *                   ekstra posteringer. Det må sjekkes på avd.
7.07  *                   + gebyr må holdes utenom denne generering.
7.07  *                   Hentet fra Holmestrand
7.07  *       010715 bsa  Løsning for kostnadsfordeling når varer blir
7.07  *                   levert fra en annen avdeling enn salgsstedet
7.07  *                   Hentet fra Holmestrand
7.07  *       010715 bsa  Ønsker ingen kostnadsfordeling dersom
7.07  *                   det er direktelevert ordre
7.07  *       090610 amd  I statistikken skal avdeling fra ordrehode
7.07  *                   legges ut uansett hva som står på linje
7.07  *                   Samtidig legges også avdeling på gebyrer
7.07  *                   + suffix i statistikk
7.07  *       040815 bsa  Varer med varegruppe 0101999 (utkjøring)
7.07  *                   skal ikke være med i kostføring.
7.08  * K00   030321 sst NXS-7994  Egen kidd mot SAP
7.09  * K00   220321 ask  Lagt inn logging på bilagsnummer nivå - One Fico
      *
7.fb  * K000  151216 bof  Hvis forskuddsbetaling, ikke avrund
7.fb  * K000              Føring av endringer på forhåndsbetalt ordre
7.fb  * K000              Fratrekk av riktig depositum ved delfakt.
      *
8.01  * 800   280521 ask  Lagt firma i SQL der det manglet
8.02  * 800   030821 bsa  Hvis kostnadsfordeling, legg ut avdeling
8.02  * 800               fra ordrehodet på historisk fakturalinje.
8.03  * 800   230222 ask  Switchstyrt - factoring via iizy,
8.03  *                   bygger kid avhengig av factoringselskap.
8.04  * 800   200422 bsa  Sørger for at ikke verdien fra forrige varelinje
8.04  * 800               legges ut på gebyrlinjer, da det ikke er relevant.
8.05  * 800   070722 ask  Legger timestamp fro logging ut i LDA for bruk i senere program (FO617R)
8.06  * 800   271222 bsa  Det skrives tomme poster til SDEP fra NGN, og det
8.06  * 800               skaper problemer videre ved beregning av depositum/
8.06  * 800               gjenstående depositum.
8.07  * 800   030223 ask  Lagt inn løsning for NORDEANY på factoring via iizy
8.08  * 800   170123 ask  Henter gjsn. glidende kostpris på utleveringsdato, nytt felt på SSTAPF
8.09  * 800   150323 ask  Lagt inn nye felter i utvidet logregister for regnskapstranser
8.11  * 800   310523 bsa  Kombinasjon med ordrerabett og gebyr gir feil faktura.
8.12  * 800   240723 ask  Endringer på gj.kost fra Mestergruppen lagt inn.
8.13  * 800   171023 ask  Lagt inn parameterfil for VISMA_KOSTPRIS føring
8.14  * 800   141113 ask  Lagt inn ny summeringsfunksjonalitet på bunt
8.16  *800    230124 bsa  Blir feil ved generering av gebyrlinjer. Kan ta med
8.16  *800                seg verdier fra tidligere linjer.
8.17  *800    300124 bsa  Rettet feil ved forskuddsbetaling
8.18  *K000   190723 bsa  Tar høyde for at faktura og kreditnota kjøres sammen.
8.19  *K000   180324 bsa  Utvider prisgruppe fra 1 til 2 posisjoner
8.20  *K000   080424 bsa  Ved samlefaktura av flere typer ordretyper, er det
8.20  *K000               summen av faktura som bestemmer gebyr.
8.21  *K000   280524 bsa  Enkelte kunder skal ikke samkjøres. Testen på dette er
8.21  *K000               om det finnes sumpost (FFAKST)
8.22  *K000   170624 bsa  Endret håndtering av fortegn og håndtering av gebyr.
8.23  *800    200224 bsa  Rettelse fortsetter ved gebyrlinjer.
8.24  *K000   171024 bsa  Legg samme forfallsdato på alle ordrehoder.
8.25  * 800   041024 ask  Endret funksjonalitet for kostførings transaksjoner til regnskap
8.26  * 800   280322 bsa  Fjerne øresavrunding på faktura. "Alle" fakturaer
8.26  * 800               betales elektronisk, og da skal det ikke være
8.26  * 800               avrunding.
8.27  * 800   200422 bsa  Justerer mva beløp
8.28  * 800   280322 bsa  Øreavrunding styres av switch
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     ffpsol1    ipe  e           k disk    rename(fpsopfr:fpsol1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
6.32 f*rkunlu    uf   e           k disk    rename(rkunpfr:rkunlur)
6.32 frkmelu    uf   e           k disk    rename(rkmepfr:rkmelur)
     fvvarl1    if   e           k disk    rename(vvarpfr:vvarl1r)
     fvugrl1    if   e           k disk    rename(vugrpfr:vugrl1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     fvltyl1    if   e           k disk    rename(vltypfr:vltyl1r)
     ffstsl1    if   e           k disk    rename(fstspfr:fstsl1r)
     fvkhvl1    if   e           k disk    rename(vkhvpfr:vkhvl1r)
     ffgebl1    if   e           k disk    rename(fgebpfr:fgebl1r)
7.02 ffgebl2    if   e           k disk    rename(fgebpfr:fgebl2r)
     ffohel1    if   e           k disk    rename(fohepfr:fohel1r)
     ffodtl1    if   e           k disk    rename(fodtpfr:fodtl1r)
     ffotxl1    if   e           k disk    rename(fotxpfr:fotxl1r)
     fvvenl1    if   e           k disk    rename(vvenpfr:vvenl1r)
5.24 fvvgkl1    if   e           k disk    rename(vvgkpfr:vvgkl1r)
8.18 fffaki1    if   e           k disk    rename(ffakst:ffaki1r)
      *
     fsohelu    uf a e           k disk    rename(sohepfr:sohelur)
     fsodtlu    uf a e           k disk    rename(sodtpfr:sodtlur)
5.41 ffnuflu    uf a e           k disk    rename(fnufpfr:fnuflur)
     fsstapf    o  a e             disk
4.01 ffovfpf    o  a e             disk
5.31 frmbtlr    if   e           k disk    rename(rmbtpfr:rmbtlrr)
5.62 fsdepl1    if   e           k disk    rename(sdeppfr:sdepl1r)
5.62 fsdeplu    uf a e           k disk    rename(sdeppfr:sdeplur)
6.19 fruksl1    if   e           k disk    rename(rukspfr:ruksl1r)
6.20 fbokkl4    uf a e           k disk    rename(bokkpfr:bokkl4r)
6.20 frukrlr    if   e           k disk    rename(rukrpfr:rukrlrr)
6.2A frukrl5    if   e           k disk    rename(rukrpfr:rukrl5r)
6.33 ffkprl1    if   e           k disk    rename(fkprpfr:fkprl1r)
6.34 famodl1    if   e           k disk    rename(amodpfr:amodl1r)
6.38 fvmval1    if   e           k disk    rename(vmvapfr:vmval1r)
6.39 fbstsl1    if   e           k disk    rename(bstspfr:bstsl1r)
6.3e fvvlel1    if   e           k disk    rename(vvlepfr:vvlel1r)
7.01 fsst3pf    o  a e             disk
7.01 ffod2lu    uf a e           k disk    rename(fod2pfr:fod2lur)
8.08 fvvenlr    if   e           k disk    rename(vvenpfr:vvenlrr)
      *
      * Definering av parametere
      *
6.nu d p_parm          s             34
5.70 d p_vtyp          s                   like(vvvtyp)
      *
      * Definering av lda
      *
     d                uds
     d l_peri                561    566  0
     d l_fkda                        10d   datfmt(*iso)
8.05 d l_tmst                751    776
5.41 d l_wsid                901    910
6.10 d l_user                911    920
7.07 d l_filg                931    933
      *
      * Datastruktur for parameter inn
      *
     d                 ds
6.nu d d_parm                        34
     d  d_aarr                        4  0 overlay(d_parm)
     d  d_otyp                        2    overlay(d_parm:5)
6.nu d  d_ffnr                        8  0 overlay(d_parm:7)
6.nu d  d_tfnr                        8  0 overlay(d_parm:15)
6.nu d  d_prog                       10    overlay(d_parm:23)
6.nu d  d_kopi                        1    overlay(d_parm:33)
6.nu d  d_dumy                        1    overlay(d_parm:34)
      *
      * Datastruktur for oppdeling av fritekst
      *
     d                 ds
     d d_frix                        70
     d  d_fri1                       35    overlay(d_frix)
     d  d_fri2                       35    overlay(d_frix:36)
      *
      * Datastruktur for kontoinformasjon
      *
     d                 ds
5.20 d d_hele                       128
     d  d_kav1                        4  0 overlay(d_hele)
     d  d_kko1                        6  0 overlay(d_hele:5)
4.02 d  d_ksp1                        4  0 overlay(d_hele:11)
4.02 d  d_kav2                        4  0 overlay(d_hele:15)
4.02 d  d_kko2                        6  0 overlay(d_hele:19)
4.02 d  d_ksp2                        4  0 overlay(d_hele:25)
4.02 d  d_kav3                        4  0 overlay(d_hele:29)
4.02 d  d_kko3                        6  0 overlay(d_hele:33)
4.02 d  d_ksp3                        4  0 overlay(d_hele:39)
4.02 d  d_kav4                        4  0 overlay(d_hele:43)
4.02 d  d_kko4                        6  0 overlay(d_hele:47)
4.02 d  d_ksp4                        4  0 overlay(d_hele:53)
4.02 d  d_kav5                        4  0 overlay(d_hele:57)
4.02 d  d_kko5                        6  0 overlay(d_hele:61)
4.02 d  d_ksp5                        4  0 overlay(d_hele:67)
4.02 d  d_kav6                        4  0 overlay(d_hele:71)
4.02 d  d_kko6                        6  0 overlay(d_hele:75)
4.02 d  d_ksp6                        4  0 overlay(d_hele:81)
4.02 d  d_kav7                        4  0 overlay(d_hele:85)
4.02 d  d_kko7                        6  0 overlay(d_hele:89)
4.02 d  d_ksp7                        4  0 overlay(d_hele:95)
4.02 d  d_khnv                        4    overlay(d_hele:99)
5.20 d  d_nivo                        1    overlay(d_hele:103)
5.04  *
5.04  * Datastruktur for kid-feltet
5.04  *
5.04 d                 ds
5.04 d d_kkid                        21
5.04 d  d_kkus                       20    overlay(d_kkid)
5.04 d   d_kfir                       3  0 overlay(d_kkus)
5.04 d   d_kkod                       1  0 overlay(d_kkus:4)
6.nu d   d_ktyp                       1  0 overlay(d_kkus:5)
6.nu d   d_kled                       1  0 overlay(d_kkus:6)
6.nu d   d_kkto                       6  0 overlay(d_kkus:7)
6.nu d   d_kbil                       8  0 overlay(d_kkus:13)
6.nu d  d_kmod                        1  0 overlay(d_kkid:21)
5.49  *
5.49  * Datastruktur for egendefinert kidd
5.49  *
5.49 d                 ds
6.nu d d_kkid_2                      23
6.nu d  d_kkus_2                     22    overlay(d_kkid_2)
5.49 d   d_kdum_2                    14    overlay(d_kkus_2)
6.nu d   d_kfak_2                     8  0 overlay(d_kkus_2:15)
6.nu d  d_kmod_2                      1  0 overlay(d_kkid_2:23)
7.08  *
7.08  * Datastruktur for kidd mot SAP
7.08  *
7.08 d                 ds
7.08 d d_kkid_3                      13
7.08 d  d_kkus_3                     12    overlay(d_kkid_3:1)
7.08 d   d_kfir_3                     4    overlay(d_kkus_3:1)
7.08 d   d_kfak_3                     8  0 overlay(d_kkus_3:5)
7.08 d  d_kmod_3                      1  0 overlay(d_kkid_3:13)
8.03  *
8.03  * Datastruktur for Sparebank1 kid
8.03  *
8.03 d                 ds
8.03 d d_kkid_s                      16
8.03 d  d_kkus_s                     15    overlay(d_kkid_s)
8.03 d   d_fas1_s                     1  0 overlay(d_kkus_s)
8.03 d   d_klin_s                     4  0 overlay(d_kkus_s:2)
8.03 d   d_kbil_s                     8  0 overlay(d_kkus_s:6)
8.03 d   d_fas2_s                     2  0 overlay(d_kkus_s:14)
8.03 d  d_kmod_s                      1  0 overlay(d_kkid_s:16)
8.03  *
8.03  * Datastruktur for DNB kid
8.03  *
8.03 d                 ds
8.03 d d_kkid_d                      15
8.03 d  d_kkus_d                     14    overlay(d_kkid_d)
8.03 d   d_fast_d                     1  0 overlay(d_kkus_d)
8.03 d   d_kund_d                     5  0 overlay(d_kkus_d:2)
8.03 d   d_kbil_d                     8  0 overlay(d_kkus_d:7)
8.03 d  d_kmod_d                      1  0 overlay(d_kkid_d:15)
8.03  *
8.03  * Datastruktur for NORDEA kid
8.03  *
8.03 d                 ds
8.03 d d_kkid_n                      20
8.03 d  d_kkus_n                     19    overlay(d_kkid_n)
8.03 d   d_kund_n                     7  0 overlay(d_kkus_n)
8.03 d   d_klin_n                     4  0 overlay(d_kkus_n:8)
8.03 d   d_kbil_n                     7  0 overlay(d_kkus_n:12)
8.03 d   d_fast_n                     1  0 overlay(d_kkus_n:19)
8.03 d  d_kmod_n                      1  0 overlay(d_kkid_n:20)
8.07  *
8.07  * Datastruktur for NORDEANY kid
8.07  *
8.07 d                 ds
8.07 d d_kkid_y                      15
8.07 d  d_kkus_y                     14    overlay(d_kkid_y)
8.07 d   d_klin_y                     5  0 overlay(d_kkus_y)
8.07 d   d_fast_y                     1  0 overlay(d_kkus_y:6)
8.07 d   d_kbil_y                     8  0 overlay(d_kkus_y:7)
8.07 d  d_kmod_y                      1  0 overlay(d_kkid_y:15)
8.03  *
8.03  * Datastruktur for Svea kid
8.03  *
8.03 d                 ds
8.03 d d_kkid_v                      16
8.03 d  d_kkus_v                     15    overlay(d_kkid_v)
8.03 d   d_klin_v                     5  0 overlay(d_kkus_v)
8.03 d   d_fast_v                     2  0 overlay(d_kkus_v:6)
8.03 d   d_kbil_v                     8  0 overlay(d_kkus_v:8)
8.03 d  d_kmod_v                      1  0 overlay(d_kkid_v:16)
      *
      * Definering av variabler i nøkler
      *
     d rkunl1_kund     s                   like(rkkund)
5.60 d rkunlu_kund     s                   like(rkkund)
     d vvarl1_vare     s                   like(vvvare)
     d vugrl1_uogr     s                   like(vguogr)
     d vugrl1_uhgr     s                   like(vguhgr)
     d vugrl1_uugr     s                   like(vguugr)
     d vkhvl1_kkod     s                   like(vakkod)
     d votyl1_otyp     s                   like(vaotyp)
     d vltyl1_ltyp     s                   like(valtyp)
     d fgebl1_otyp     s                   like(fgotyp)
     d fgebl1_kkat     s                   like(fgkkat)
7.02 d fgebl1_ftyp     s                   like(fgftyp)
     d fgebl1_line     s                   like(fgline)
7.02 d fgebl2_otyp     s                   like(fgotyp)
7.02 d fgebl2_kkat     s                   like(fgkkat)
7.02 d fgebl2_ftyp     s                   like(fgftyp)
7.02 d fgebl2_type     s                   like(fgtype)
     d fohel1_numm     s                   like(fonumm)
     d fohel1_suff     s                   like(fosuff)
     d fodtl1_numm     s                   like(fdnumm)
     d fodtl1_suff     s                   like(fdsuff)
     d fodtl1_line     s                   like(fdline)
     d fotxl1_numm     s                   like(ftnumm)
     d fotxl1_suff     s                   like(ftsuff)
     d fotxl1_line     s                   like(ftline)
     d vvenl1_vare     s                   like(vevare)
5.24 d vvgkl1_ogrp     s                   like(vkogrp)
5.24 d vvgkl1_hgrp     s                   like(vkhgrp)
5.24 d vvgkl1_ugrp     s                   like(vkugrp)
5.24 d vvgkl1_ldor     s                   like(vkldor)
     d sohelu_aarr     s                   like(soaarr)
     d sohelu_binr     s                   like(sobinr)
     d sohelu_numm     s                   like(sonumm)
     d sohelu_suff     s                   like(sosuff)
     d sodtlu_aarr     s                   like(sdaarr)
     d sodtlu_binr     s                   like(sdbinr)
     d sodtlu_numm     s                   like(sdnumm)
     d sodtlu_suff     s                   like(sdsuff)
     d sodtlu_ktxt     s                   like(sdktxt)
     d sodtlu_line     s                   like(sdline)
5.31 d rmbtlr_tbrt     s                   like(rmtbrt)
5.31 d rmbtlr_talm     s                   like(rmtalm)
5.41 d fnuflu_aarr     s                   like(fnuaar)
5.41 d fnuflu_binr     s                   like(fnubin)
5.62 d sdepl1_numm     s                   like(sknumm)
5.62 d sdepl1_kund     s                   like(skkund)
7.fb d sdepl1_tell     s                   like(sktell)
5.62 d sdeplu_numm     s                   like(sknumm)
5.62 d sdeplu_kund     s                   like(skkund)
7.fb d sdeplu_tell     s                   like(sktell)
6.19 d ruksl1_skty     s                   like(ruskty)
6.19 d ruksl1_slag     s                   like(ruslag)
6.20 d bokkl4_ktyp     s                   like(brktyp)
6.20 d bokkl4_kund     s                   like(brkund)
6.20 d bokkl4_binr     s                   like(brbinr)
6.20 d rukrlr_kkun     s                   like(rukkun)
6.2A d rukrl5_ktyp     s                   like(ruktyp)
6.2A d rukrl5_kkun     s                   like(rukkun)
6.2A d rukrl5_kpro     s                   like(rukpro)
6.33 d fkprl1_kund     s                   like(flkund)
6.33 d fkprl1_kpro     s                   like(flkpro)
6.34 d amodl1_modu     s                   like(axmodu)
6.38 d vmval1_mkod     s                   like(vamkod)
8.08 d vvenlr_vare     s                   like(vevare)
8.08 d vvenlr_enhe     s                   like(veenhe)
8.18 d ffaki1_ksrt     s                   like(faksrt)
8.18 d ffaki1_knum     s                   like(faknum)
8.18 d ffaki1_ksuf     s                   like(faksuf)
      *
      * Definering av variable
6.34 d w_kki27         s             27
6.34 d w_kki21         s             21
      *
     d w_btim          s               t   timfmt(*iso)
     d w_bsts          s              1
     d w_btxt          s             20
3.10 d w_vlin          s              1
      *
     d w_firm          s                   like(fksfir)
     d w_omrs          s                   like(veomre)
     d w_omrl          s                   like(veomre)
5.63 d w_omrm          s                   like(veomre)
5.20 d w_lety          s                   like(fdlety)
5.38 d w_onum          s                   like(vaonum)
5.39 d w_pran          s                   like(sfpran)
5.62 d w_trek          s                   like(sofsum)
5.63 d w_akm3          s                   like(sfakm3)
5.63 d w_nom3          s                   like(sfnom3)
      *
     d w_eaar          s              2  0
     d w_emnd          s              2  0
5.20 d w_hele          s            128
     d w_hgrp          s              2  0
     d w_ogrp          s              2  0
     d w_otyp          s              2
     d w_qmem          s              1
     d w_sald          s             11  2
     d w_retk          s              1
     d w_ugrp          s              3  0
     d w_vare          s             15
     d w_atxt          s             20
6.nu d*w_kidr          s              6  0
6.nu d w_kidr          s              8  0
5.04 d w_ksif          s              1  0
5.04 d w_kkus          s             24
5.04 d w_kkid          s             25
5.05 d w_line          s              4  0
5.49 d w_kki2          s             25
      *
5.31 d w_stat          s              1
5.31 d w_mvak          s              1
5.31 d w_mvtx          s             30
5.31 d w_bpro          s              5  2
5.31 d w_dato          s               d   datfmt(*iso)
5.31 d w_mvap          s              6  2
5.31 d w_mvat          s              5  4
5.31 d w_mvaf          s             10  9
      *
5.32 d w_latx          s             20
5.32 d w_adrs          s             30
5.32 d w_ponr          s              4  0
5.32 d w_pste          s             30
5.32 d w_avde          s              4  0
5.32 d w_saar          s              4  0
5.32 d w_suke          s              2  0
7.07 d w_avd1          s              4  0
7.07 d w_avd2          s              4  0
      *
6.nu d w_biln          s              8  0
6.nu d w_frst          s              8  0
     d w_aaar          s              4  0
     d w_anta          s                   like(fdanta)
6.19 d xtanta          s                   like(fdanta)
     d w_belb          s             11  2
     d w_beln          s             12  3
     d w_belo          s             11  2
6.2g d w_oppr          s             15  2
     d w_belw          s             11  2
5.30 d w_belx          s             11  2
5.30 d w_bely          s             11  2
6.34 d w_bels          s             11  2
6.34 d w_belk          s             11  2
     d w_kost          s             11  2
     d w_rkro          s             11  2
     d w_rkr1          s             11  2
     d w_rkr2          s             11  2
5.31 d w_brk1          s             11  2
5.31 d w_brk2          s             11  2
6.13 d w_mgrl          s             11  2
6.13 d w_moms          s             11  2
     d w_fkda          s              6  0
     d w_peri          s              4  0
     d w_fast          s             10
     d w_fell          s              6
     d w_kode          s              1
6.nu d w_numm          s              8  0
     d w_type          s              2
5.40 d w_mvag          s             11  2
     d w_dbkr          s              1
     d w_valg          s              1  0
     d w_gebm          s             13  4
     d w_geby          s             11  2
     d w_geb0          s             11  2
     d w_geb1          s             11  2
     d w_geb2          s             11  2
     d w_geb3          s             11  2
6.28 d w_udat          s               d   datfmt(*iso)
8.08 d w_gjdat         s              8  0
8.08 d w_gjko          s              9  2
8.08 d w_gjkp          s             11  2
6.28 d w_ldor          s                   like(vvldor)
6.3f0d w_ldorb         s                   like(vvldor)
6.3e d w_lv_nobb       s                   like(vvlnob)
6.3e d w_lv_modn       s                   like(vvlmod)
6.3e d w_lv_lldo       s                   like(vvlnle)
6.3e d w_lv_llva       s                   like(vvllva)
6.33 d w_mkod          s                   like(rkmkod)
7.08 d w_sap_kid       s              1    inz(' ')
      *
6.34 d w_pkon          s              3
6.34 d w_sumn          s             11  2
6.34 d w_suno          s             11  2
6.34 d w_ntpr          s             11  2
6.34 d w_sumi          s             11  2
6.34 d w_sumo          s             11  2
6.34 d w_suoi          s             11  2
6.34 d w_sumk          s             11  2
6.34 d w_suok          s             11  2
6.34 d w_diff          s             11  2
6.34 d w_pkns          s              3
6.34 d w_pkko          s              3
6.34 d w_pkok          s              3
6.34 d w_pkin          s              3
6.34 d w_pkoi          s              3
6.34 d w_kofa          s              1
6.34 d w_card          s              2
6.34 d w_fcar          s              2
6.34 d w_kild          s              3
6.34 d w_soda          s                   like(sfsoda)
6.34 d w_soti          s                   like(sfsoti)
6.34 d w_rkro_stk      s             11  2
6.3f0d w_aarr          s              4  0
7.03 d w_logg          s               z
7.05 d w_lintel        s              8  0
7.03 d w_sumbel        s             11  2
8.14 d w_dsum          s             12  2
8.14 d w_ksum          s             12  2
7.03 d w_dumtim        s               z
7.03 d w_dumsum        s             11  2
7.03 d w_dumusr        s             10
7.03 d w_dumerr        s              2
7.09 d w_dumant        s              5  0
8.09 d w_dumd20        s              2  0
7.fb d w_sumif         s             11  2
7.fb d w_sumuf         s             11  2
7.fb d w_sumim         s             11  2
7.fb d w_sums          s             11  2
7.fb d w_fosa          s             11  2
7.fb d w_fosw          s             11  2
7.fb d w_fosi          s             11  2
8.18 d w_obil          s              2  0
8.18 d w_koty          s              2
8.22 d w_fgeb          s              1
8.22 d w_gebl          s              1
6.34  *
6.34  * Datastruktur parameterliste -inn
6.34  *
6.34 d                 ds
6.34 d hirec                        120
6.34 d  hifirm                        3  0 overlay(hirec)
6.34 d  hirkat                        3  0 overlay(hirec:4)
6.34 d  hikund                        6  0 overlay(hirec:7)
6.34 d  hikpro                        6  0 overlay(hirec:13)
6.34 d  hivare                       15    overlay(hirec:19)
6.34 d  hilety                        1  0 overlay(hirec:34)
6.34 d  hienhe                        3    overlay(hirec:35)
6.34 d  hidato                         d   overlay(hirec:38) datfmt(*iso)
6.34 d  hitime                         t   overlay(hirec:48) timfmt(*iso)
6.nu d  hinumm                        8  0 overlay(hirec:56)
6.nu d  hikode                        1    overlay(hirec:64)
6.nu d  hidekn                        5  2 overlay(hirec:65)
6.nu d  hiavgf                        1  0 overlay(hirec:70)
6.nu d  hipriv                        1  0 overlay(hirec:71)
6.nu d  hitilb                        1    overlay(hirec:72)
6.nu d  hiskaf                        1    overlay(hirec:73)
6.nu d  hildor                        6  0 overlay(hirec:74)
6.35 d  hisapr                        9  2 overlay(hirec:80)
6.35 d  hikopr                        9  2 overlay(hirec:89)
8.19 d  hiprgr                        2    overlay(hirec:98)
8.19 d  hiinpr                        9  2 overlay(hirec:100)
6.34 d  hiinlr                        1    overlay(hirec:120)
6.34  *
6.34  * Datastruktur parameterliste -ut
6.34  *
6.34 d                 ds
6.34 d horec                        100
6.34 d  holety                        1  0 overlay(horec)
6.34 d  hokpri                        1    overlay(horec:2)
6.34 d  hooppr                        9  2 overlay(horec:3)
6.34 d  hosapr                        9  2 overlay(horec:12)
6.34 d  hokopr                        9  2 overlay(horec:21)
6.34 d  horab1                        5  2 overlay(horec:30)
6.34 d  horab2                        5  2 overlay(horec:35)
6.34 d  hodekn                        5  2 overlay(horec:40)
6.34 d  hopros                        5  2 overlay(horec:45)
6.34 d  hokamp                        5    overlay(horec:50)
6.34 d  hoalme                        4  0 overlay(horec:55)
6.34 d  hobrty                        1  0 overlay(horec:59)
6.34 d  hobrr1                        5  2 overlay(horec:60)
6.34 d  hobrr2                        5  2 overlay(horec:65)
6.34 d  hoomva                        1    overlay(horec:70)
8.19 d  hoprgr                        2    overlay(horec:71)
8.19 d  hoinpr                        9  2 overlay(horec:73)
8.19 d  hopkon                        3    overlay(horec:82)
8.19 d  hopkns                        3    overlay(horec:85)
8.19 d  hopkko                        3    overlay(horec:88)
8.19 d  hopkok                        3    overlay(horec:91)
8.19 d  hopkoi                        3    overlay(horec:94)
      *
      * Definering av brytere
      *
5.24 d b_xeof          s              1    inz(*off)
5.32 d b_feil          s              1    inz(*off)
6.19 d b_kort          s              1    inz(*off)
6.28 d b_inlr          s              1    inz(*off)
6.2A d b_kunde         s              1    inz(*off)
6.2A d b_opflg         s              1    inz(*off)
6.2h d b_lvrva         s              1    inz(*off)
6.2h d b_bmmo          s              1    inz(*off)
7.07 d b_type          s              1    inz(*off)
8.24 d b_samf          s              1    inz(*off)
8.24 d b_forf          s              1    inz(*off)
8.28 d b_round         s              1    inz(*off)
      *
      * Definering av save-variable
      *
5.33 d s_avde          s              4  0
      *
      * Definering av variable for
      * overføring til regnskap (FOVFPF)
      *
     d t_peri          s              4  0
     d t_bunt          s              5  0
6.nu d t_biln          s              8  0
5.22 d t_bill          s              4  0
     d t_bdat          s              6  0
     d t_fdat          s              6  0
     d t_bilk          s              2  0
6.2A d xtbilk          s              2  0
     d t_text          s             20
     d t_avde          s              4  0
     d t_kont          s              6  0
4.02 d t_spes          s              4  0
     d t_mkod          s              1
     d t_belp          s             11  2
5.31 d t_mvag          s             11  2
6.19 d xtmvag          s             11  2
6.25 d*t_proj          s              6  0
6.25 d t_proj          s              6
6.25 d t_upro          s              6
6.25 d*xtproj          s              6  0
6.25 d xtproj          s              6
     d t_akti          s              3
6.19 d xtakti          s              3
6.nu d t_kref          s              8  0
6.nu d xtkref          s              8  0
     d t_mngd          s              9  2
     d t_autx          s              1
6.19 d xtkkod          s              1
      *
      * Definering av variable for
      * akkumulering til brudd ordre (L2)
      *
     d w2kstp          s             11  2
     d w2rbgp          s             11  2
     d w2rkop          s             11  2
     d w2rk1p          s             11  2
     d w2rk2p          s             11  2
5.31 d w2rb1p          s             11  2
5.31 d w2rb2p          s             11  2
5.31 d w2gr1p          s             11  2
5.31 d w2gr2p          s             11  2
5.31 d w2mvgp          s             11  2
     d w2salp          s             11  2
      *
      * Definering av variable for
      * akkumulering til brudd fakt. (L6)
      *
     d w6fsum          s                   like(fotots)
     d w6geby          s             11  2
     d w6hlp1          s                   like(fotots)
     d w6hlp2          s                   like(fotots)
     d w6hsum          s             11  2
     d w6pasl          s             11  2
     d w6rkop          s             11  2
     d w6rk1p          s             11  2
     d w6rk2p          s             11  2
5.31 d w6rb1p          s             11  2
5.31 d w6rb2p          s             11  2
5.31 d w6mvgp          s             11  2
     d w6salp          s             11  2
6.13 d w6moms          s             11  2
      *
6.19 d w_akod          s              2  0
6.19 d w_kont          s              5  0
      * Definering av hjelpevariabler
      *
     d whlp20          s              2  2
     d vvspny          s              9  2 inz(0)
     d vvspga          s              9  2
8.03 d w_fsel          s             10
8.03 d w_fkli          s              8  0
8.03 d w_ffa1          s              1  0
8.03 d w_ffa2          s              2  0
      *
7.07 d u_kost          s              1    inz(*off)
8.03 d u_803           s              1    inz(*off)
8.13 d u_813           s              1    inz(*off)
      *
7.07   dcl-s co402_verdi1  char(1);
7.07   dcl-s co402_verdi2  char(2048);
7.07   dcl-pr co402r extpgm('CO402R');
7.07     p_filgrp            char(3)     const;
7.07     p_firm              packed(3:0) const;
7.07     p_lager             packed(2:0) const;
7.07     p_nokkel            char(50)    const;
7.07     p_verdi1            char(1);
7.07     p_verdi2            char(2048);
7.07   end-pr;
      *
     ifpsol1r       01
     i                                          fkssrt        l6
     i                                          fksonr        l3
     i                                          fkssuf        l2
      *
      * Notater / tips til programmet
      * -------------------------------
      * Det er her notert ned en del tips, som dokumentasjon til
      * hvordan dette programmet fungerer.  Det er en del forut-
      * setninger som det er viktig å være klar over:
      *
      * 01) Alle beløp som oppdateres i fakturaregister er eks. mva.
      *     (Fakturaregister = SOHEPF og SODTPF)
      *
      * 02) En faktura kan bestå ev flere ordre, dersom det er åpnet
      *     for dette.
      *     L2 - brudd = Slutt på ordre
      *     L6 - brudd = Slutt på faktura
      *     Det genereres automatiske posteringer på L6 brudd. Dette
      *     kan være frakt / gebyr / påslag.  Ordrehode inneholder
      *     akkumulatorer for ordresummer.  Flere ordre kan derfor
      *     måtte summeres opp til fakturatotaler.
      *     Frakt / gebyr / påslag legges til ordrehode på siste
      *     ordre på faktura.
      *
      * 03) Alle beløp i ordreregister er lagret med positive fortegn
      *     Ordretyper og linjetyper styrer om det er negative ordre
      *     eller negative linjer.  Men i oppdatering av faktura-
      *     register, legges alle poster ut med ferdig fortegn. (+/-)
      *
      * 04) Det er foreløpig noe problemer med beregning av vare-
      *     linjen's andel av ordrerabatt i ordresystemet.  Det er
      *     derfor lagt inn beregning i dette programmet, for å få
      *     riktig oppdatering av fakturaregisteret.
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av valg
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * Subrutine som kjøres første gang
      * programmet kjøres (Kun en gang)
7.03  *
7.03 C/Exec SQL
7.03 C+  Set Option DatFmt=*ISO, DlyPrp=*YES, SRTSEQ=*LANGIDUNQ, LANGID=NOR,
7.03 C+             commit=*none
7.03 C/End-Exec
      *
     c   01              if        *in99 = *off
     c                   exsr      x_fcycle
     c                   endif
      *
     c                   if        *inl6 = *on
     c                   exsr      x_l6det
     c                   endif
      *
     c                   if        *inl2 = *on
     c                   exsr      x_l2det
     c                   endif
      *
      * Hopp til rett behandling   (Hode, Linje, Tekst)
      *
     c     fkskod        cabeq     'H'           tag_hode
     c     fkskod        cabeq     'V'           tag_linje
     c     fkskod        cabeq     'K'           tag_tekst
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ORDRE-HODE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag_hode      tag
     c                   exsr      x_hode
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ORDRE-LINJE-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag_linje     tag
      *
      * Hent opplysninger fra ORDRE-LINJE-REGISTER
      *
     c                   eval      fodtl1_numm = fksonr
     c                   eval      fodtl1_suff = fkssuf
     c                   eval      fodtl1_line = fkslin
     c     fodtl1_key    chain     fodtl1r                            90
5.22  *
5.22  * Tar vare på linjenummer
5.22  *
5.22 c                   eval      t_bill = fdline
      *
      * Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = fdltyp
     c     vltyl1_key    chain     vltyl1r                            90
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * NB!  Utgangspunktet er at alle beløp i ordreregisteret er
      *      lagret med positive fortegn.  Derfor blir disse snudd
      *      her i henhold til koder på ordretype og linjetype. Det
      *      viser seg imidlertid at negative varelinjer på en ordre
      *      ligger med positivt antall, men negative beløp på
      *      sum salg og sum kost.  For ikke å skape problemer
      *      for resten av systemet, blir disse snudd her med det
      *      samme de hentes inn, for så å følge samme prinsipper
      *      videre i programmet.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   if        valkre = '-'
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   endif
      *
      * Behandling av tekstlinje
      *
     c                   if        valktx = 1
     c                   exsr      x_lintxt
     c                   goto      x_slutt
     c                   endif
      *
      * Skal denne linjetypen oppdatere Økonomi og/eller statistikk
      *
     c                   if        valoko = 0
     c                   if        valsta = 0
     c                   goto      tag_01
     c                   endif
     c                   endif
      *
      * Behandling økonomi / statistikk
      *
     c                   exsr      x_linoko
      *
      * Oppdaterer FAKTURA-LINJE-REGISTER med nye linjer
      *
     c     tag_01        tag
     c                   exsr      x_linfak
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ORDRE-TEKST-OPPLYSNINGER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     tag_tekst     tag
     c                   exsr      x_tekst
     c                   goto      x_slutt
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Avslutt
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     x_slutt       tag
      *
     cl2                 exsr      x_l2tot
     cl6                 exsr      x_l6tot
7.09 clr                 exsr      logg_bilag
7.03 clr                 exsr      logg_hode
     clr                 exsr      x_lrtot
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L6 det. (Ny faktura)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l6det       begsr
8.18  *
8.18  * Hent opplysninger fra sum faktura
8.18  *
8.24 c                   eval      b_samf = *on
8.24 c                   eval      b_forf = *off
8.22 c                   eval      w_fgeb = *blanks
8.18 c                   eval      w_koty = *blanks
8.18 c                   eval      ffaki1_ksrt = fkssrt
8.18 c                   eval      ffaki1_knum = 0
8.18 c                   eval      ffaki1_ksuf = 0
8.18 c     ffaki1_key    chain     ffaki1
8.18 c                   if        not %found
8.24 c                   eval      b_samf = *off
8.18 c                   eval      w_koty = *blanks
8.18 c                   eval      faksum = 0
8.18 c                   eval      w_obil = 0
8.18 c                   else
8.18 c                   if        faksum > 0
8.18 c                   eval      votyl1_otyp = fakdot
8.18 c                   eval      w_koty = fakdot
8.22 c                   eval      w_fgeb = 'D'
8.22 c                   eval      w_dbkr = 'D'
8.18 c                   else
8.18 c                   eval      votyl1_otyp = fakkot
8.18 c                   eval      w_koty = fakkot
8.22 c                   eval      w_fgeb = 'K'
8.22 c                   eval      w_dbkr = 'K'
8.24 c                   eval      b_forf = *on
8.18 c                   endif
8.18 c     votyl1_key    chain     votyl1r
8.18 c                   if        %found
8.18 c                   eval      w_obil = vaobil
8.18 c                   endif
8.18 c                   endif
      *
      * Henter inn bilagsnummer  (faktura/kreditnota-nummer)
      *
     c                   eval      w_fell = faafak
     c                   eval      w_type = fksoty
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      w_type = w_koty
8.18 c                   endif
     c                   eval      w_kode = '0'
     c                   exsr      x_hntnum
     c                   eval      sohelu_binr = w_numm
     c                   eval      sodtlu_binr = w_numm
      *
     c                   if        w_frst = 0
     c                   eval      w_frst = w_numm
     c                   endif
      *
      * Nullstiller hjelpfelter   (for beregning av gebyr/påslag)
      *
     c                   eval      w_geb0 = 0
     c                   eval      w_geb1 = 0
     c                   eval      w_geb2 = 0
     c                   eval      w_geb3 = 0
     c                   eval      w6geby = 0
     c                   eval      w6pasl = 0
      *
     c                   eval      t_bdat = 0
     c                   eval      t_fdat = 0
     c                   eval      w_fkda = 0
     c                   eval      t_bunt = 0
      *
     c                   eval      w6hsum = 0
     c                   eval      w6salp = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk2p = 0
5.31 c                   eval      w6rb1p = 0
5.31 c                   eval      w6rb2p = 0
5.31 c                   eval      w6mvgp = 0
     c                   eval      w6rkop = 0
6.13 c                   eval      w6moms = 0
      *
     c                   eval      t_bilk = 0
     c                   eval      t_biln = w_biln
      *
8.18 c*                  eval      w_dbkr = 'D'
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L2 det. (Ny ordre)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l2det       begsr
8.18  *
8.18 c                   eval      votyl1_otyp = fksoty
8.18 c     votyl1_key    chain     votyl1r
      *
      * Legger inn ordrenummer og suffix i nøkklene
      *
     c                   eval      sohelu_numm = fksonr
     c                   eval      sodtlu_numm = fksonr
     c                   eval      sohelu_suff = fkssuf
     c                   eval      sodtlu_suff = fkssuf
      *
      * Nullstilling
      *
     c                   eval      w2salp = 0
     c                   eval      w2kstp = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk2p = 0
5.31 c                   eval      w2rb1p = 0
5.31 c                   eval      w2rb2p = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rkop = 0
5.31 c                   eval      w2gr1p = 0
5.31 c                   eval      w2gr2p = 0
5.31 c                   eval      w2mvgp = 0
      *
8.18 c                   eval      w_dbkr = 'D'
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L2 tot  (Ordre slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l2tot       begsr
5.67  *
5.67  * Hvis Efaktura og det er en kreditnota skal fakt.type = 21
5.67  *
5.67 c                   if        vaokre = '-' and
5.67 c                             fofaty = 20
5.67 c                   eval      fofaty = 21
5.67 c                   endif
      *
     c                   clear                   sohelur
      *
     c     sohelu_key    chain     sohelur
      *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      sootyp = w_koty
8.18 c                   else
     c                   eval      sootyp = footyp
8.12 c                   endif
5.61 c                   eval      solety = folety
     c                   eval      solage = folage
     c                   eval      sokref = fokref
     c                   eval      sobdat = fobdat
     c                   eval      soldat = foldat
6.29 c                   eval      sopada = fopada
3.13 c                   eval      sopdat = fopdat
     c                   eval      sobetb = fobetb
     c                   eval      soselg = foselg
     c                   eval      sodist = fodist
     c                   eval      solmat = folmat
     c                   eval      solbet = folbet
     c                   eval      sovalk = fovalk
     c                   eval      sorkat = forkat
     c                   eval      sosped = fosped
     c                   eval      sokjor = fokjor
     c                   eval      somkod = fomkod
3.32 c                   eval      soneto = foneto
     c                   eval      solkun = folkun
     c                   eval      sobkun = fobkun
     c                   eval      sokkun = fokkun
     c                   eval      sokund = fokund
     c                   eval      sokuna = fokuna
     c                   eval      sonavn = fonavn
     c                   eval      soadr1 = foadr1
     c                   eval      soadr2 = foadr2
     c                   eval      sosted = fosted
     c                   eval      soavde = foavde
     c                   eval      sokont = fokont
     c                   eval      sospes = fospes
     c                   eval      soproj = foproj
6.25 c                   eval      soupro = foupro
     c                   eval      soakti = foakti
     c                   eval      sovref = fovref
     c                   eval      sodref = fodref
     c                   movel     forekv        sorekv
     c                   eval      solmtx = folmtx
     c                   eval      solbtx = folbtx
     c                   eval      sorabp = forabp
     c                   eval      sopasl = fopasl
     c                   eval      sopask = fopask
     c                   eval      sokoli = fokoli
5.01 c                   eval      sonref = fonref
5.21 c                   eval      sofsys = fofsys
     c                   eval      sowsid = fowsid
     c                   eval      souser = fouser
     c                   eval      sodate = fodate
     c                   eval      sotime = fotime
     c                   eval      soedih = foedih
5.48 c                   eval      sokpro = fokpro
5.48 c                   eval      sokbnr = fokbnr
5.48 c                   eval      sofaty = fofaty
5.62 c                   eval      sodepo = 0
5.62 c                   eval      sodepb = 0
5.62 c                   eval      sodept = 0
6.26 c                   eval      sopsuf = fopsuf
6.2i c                   eval      sobenr = fobenr
6.2i c                   eval      sobsuf = fobsuf
      *
     c                   eval      sofkda = fofkda
     c                   eval      soffda = foffda
      *
      * NB !  Her er det viktig å være klar over følgende :
      *       Feltene for salg / rabatt / og kost blir ikke
      *       hentet fra ordrehode som tidligere, da det er
      *       behov for å splitte opp på avg fritt/pliktig
      *       både på salg, alle rabatter og på kost.
      *
     c                   eval      sosalp = w2salp
     c                   eval      sork1p = w2rk1p
     c                   eval      sork2p = w2rk2p
5.31 c                   eval      sorb1p = w2rb1p
5.31 c                   eval      sorb2p = w2rb2p
     c                   eval      sorkop = w2rkop
     c                   eval      sokstp = w2kstp
     c                   eval      sorbgp = w2rbgp
5.31 c                   eval      sogr1p = w2gr1p
5.31 c                   eval      sogr2p = w2gr2p
5.31 c                   eval      somvgp = w2mvgp
7.fb c                   eval      sofosa = w_fosa
7.fb c                   eval      sofosi = w_fosi
      *
      * NB !  Ordrerabatten er også summert opp pr varelinje, men
      *       den blir beregnet på nytt for å unngå øredifferanser
      *       da det på linjenivå foretas avrundinger.
      *
     c                   eval(h)   sorkop = (w2rbgp * forabp) / 100
      *
      * Oppdater
      *
     c                   if        %found(sohelu)
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
     c                   update    sohelur
     c                   else
     c                   eval      sofirm = w_firm
     c                   eval      soaarr = sohelu_aarr
     c                   eval      sobinr = sohelu_binr
     c                   eval      sonumm = sohelu_numm
     c                   eval      sosuff = sohelu_suff
6.10 c                   time                    sodate
6.10 c                   time                    sotime
6.10 c                   eval      soousr = l_user
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
     c                   write     sohelur
     c                   endif
5.41  *
5.41  * Oppdaterer utg. fakt.logg
5.41  *
5.49 c                   if        fofaty <> *zero
5.41 c                   exsr      x_faklog
5.41 c                   endif
      *
      * Sum Faktura (L6)
      *
     c                   eval      w6salp = w6salp + w2salp
     c                   eval      w6rk1p = w6rk1p + w2rk1p
     c                   eval      w6rk2p = w6rk2p + w2rk2p
5.31 c                   eval      w6rb1p = w6rb1p + w2rb1p
5.31 c                   eval      w6rb2p = w6rb2p + w2rb2p
5.31 c                   eval      w6mvgp = w6mvgp + w2mvgp
     c                   eval      w6rkop = w6rkop + w2rkop
6.20  *
6.20  * Sjekk om det finnes fordel/kredit kort på denne kunde. Poster legges ut på
6.20  * BOKKPF for alle korttyper. Legges på ordrenivå, i tilfelle ordrene er merket med
6.20  * forskjellige kreditkortkoder.
6.20 c                   exsr      opd_kort
6.20  *
     c                   endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på L6 tot  (Faktura slutt)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_l6tot       begsr
      *
      * Henter opp subrutine for gebyr
      *
     c                   exsr      x_gebyr
      *
      * Oppdater siste ordrehode
      * med akkumulerte gebyrer
      *
     c     sohelu_key    chain     sohelur
      *
     c                   eval      sosalp = sosalp + w6geby
     c                   eval      sokstp = sokstp + w6geby
      *
     c                   if        %found(sohelu)
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
     c                   update    sohelur
     c                   endif
      *
      * Oppdater fakturatotal
      * med akkumulerte gebyrer
      *
     c                   eval      w6salp = w6salp + w6geby
      *
      * Oppdater siste ordrehode
      * med akkumulerte påslag
      *
     c     sohelu_key    chain     sohelur
      *
     c                   eval      sosalp = sosalp + w6pasl
     c                   eval      sokstp = sokstp + w6pasl
      *
     c                   if        %found(sohelu)
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
     c                   update    sohelur
     c                   endif
      *
      * Oppdater fakturatotal
      * med akkumulerte påslag
      *
     c                   eval      w6salp = w6salp + w6pasl
      *
      * Legger til mva på totalen
      *
     c                   eval      w6fsum = w6salp
     c                   eval      w6fsum = w6fsum - w6rk1p
     c                   eval      w6fsum = w6fsum - w6rk2p
     c                   eval      w6fsum = w6fsum - w6rkop
5.31 c                   eval      w6fsum = w6fsum - w6rb1p
5.31 c                   eval      w6fsum = w6fsum - w6rb2p
      *
5.35 c                   if        fomkod = 0
5.35 c                   eval      w6mvgp = w6mvgp + w6geby
5.35 c                   endif
6.13  *
6.13  * Legg på akkumulert moms
6.13  *
6.13 c                   eval      w6fsum = w6fsum + w6moms
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Legger ut transaksjon  (Kundereskontro)       (SALG)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 00
7.fb c     sdepl1_key    chain     sdepl1r
7.fb c                   if        %found(sdepl1)
7.fb  * hvis depositum, så ikke avrund
7.fb c                   goto      xtag83
7.fb c                   endif
      *
      * Avrunde fakturasum til nærmeste
      * hele 50-øre
6.10  * NB ! Fra og med V6.10 blir avrunding
6.10  *      foretatt til nærmeste hele krone
8.26  * NB ! Øresavrunding fjernes helt, siden "alle" fakturaer
8.26  *      betales elektronisk, og der skal det ikke være
8.26  *      avrunding.
      *
     c                   move      w6fsum        whlp20
     c     whlp20        cabgt     0             xtag81
     c     whlp20        cablt     0             xtag82
     c     whlp20        cabeq     0             xtag83
      *
     c     xtag81        tag
8.28 c                   if        b_round = *off
8.26 c                   if        whlp20 < 0.50
6.11 c*>                 if        whlp20 < 0.25
8.26 c                   eval      w6fsum = w6fsum - whlp20
6.11 c*>                 else
6.11 c*>                 eval      w6fsum = w6fsum - whlp20
6.11 c*>                 eval      w6fsum = w6fsum + 0.50
6.11 c*>                 endif
8.26 c                   endif
8.28 c                   endif
      *
8.28 c                   if        b_round = *off
8.26 c                   if        whlp20 > 0.49
6.11 c*>                 if        whlp20 < 0.75
6.11 c*>                 eval      w6fsum = w6fsum - whlp20
6.11 c*>                 eval      w6fsum = w6fsum + 0.50
6.11 c*>                 else
8.26 c                   eval      w6fsum = w6fsum - whlp20
8.26 c                   eval      w6fsum = w6fsum + 1.00
6.11 c*>                 endif
8.26 c                   endif
8.28 c                   endif
     c                   goto      xtag83
      *
     c     xtag82        tag
8.28 c                   if        b_round = *off
8.26 c                   if        whlp20 > -0.50
6.11 c*>                 if        whlp20 > -0.25
8.26 c                   eval      w6fsum = w6fsum - whlp20
6.11 c*>                 else
6.11 c*>                 eval      w6fsum = w6fsum - whlp20
6.11 c*>                 eval      w6fsum = w6fsum + -0.50
6.11 c*>                 endif
8.26 c                   endif
8.28 c                   endif
      *
8.28 c                   if        b_round = *off
8.26 c                   if        whlp20 < -0.49
6.11 c*>                 if        whlp20 > -0.75
6.11 c*>                 eval      w6fsum = w6fsum - whlp20
6.11 c*>                 eval      w6fsum = w6fsum + -0.50
6.11 c*>                 else
8.26 c                   eval      w6fsum = w6fsum - whlp20
8.26 c                   eval      w6fsum = w6fsum + -1.00
6.11 c*>                 endif
8.26 c                   endif
8.28 c                   endif
     c     xtag83        tag
      *
      * Oppdater siste ordrehode
      * med eksakt fakturasum
      *
     c     sohelu_key    chain     sohelur
     c                   eval      sofsum = w6fsum
     c                   if        %found(sohelu)
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
     c                   update    sohelur
     c                   eval      sofsum = 0
     c                   endif
5.62  *
5.62  * Sjekk om denne ordre har depositum
5.62  *
7.fb c*                  eval      sdepl1_numm = fonumm
7.fb c*                  eval      sdepl1_kund = fokund
7.fb c*    sdepl1_key    chain     sdepl1r
7.fb c                   if        not %found(sdepl1)
5.62 c                   goto      xforbi
5.62 c                   endif
5.62  *
5.62 c                   if        skdepo = 0 and
5.62 c                             skdepb = 0 and
5.62 c                             skdept = 0
5.62 c                   goto      xforbi
5.62 c                   endif
5.62  *
5.62  * Sjekk hva som skal trekkes på faktura
5.62  *
7.fb c**                 eval      w_trek = skdepb - skdept
7.fb c                   eval      w_trek = skdepb - skdept
7.fb c                                      - w_sumim
5.62  *
5.62 c                   if        w_trek = 0
5.62 c                   goto      xforbi
5.62 c                   endif
5.62  *
5.62 c                   if        w_trek > w6fsum
5.62 c                   eval      w_trek = w6fsum
5.62 c                   endif
5.62  *
5.62  * Oppdater depositum-fil med nytt trekkbeløp
5.62  *
5.62 c                   eval      sdeplu_numm = fonumm
5.62 c                   eval      sdeplu_kund = fokund
7.fb c                   eval      sdeplu_tell = 0
5.62 c     sdeplu_key    chain     sdeplur
5.62 c                   if        %found
5.62 c                   eval      skdept = skdept + w_trek
7.fb c                   eval      skfosa = w_fosa
7.fb c                   eval      skfosi = w_fosi
6.10 c                   time                    skedat
6.10 c                   time                    sketim
6.10 c                   eval      skeusr = l_user
7.fb c                   eval      skwsid = l_wsid
5.62 c                   update    sdeplur
5.62 c                   endif
5.62  *
5.62  * Oppdater siste ordrehode
5.62  * med depositum informasjon
5.62  *
5.62 c     sohelu_key    chain     sohelur
5.62 c                   eval      sodepo = skdepo
5.62 c                   eval      sodepb = skdepb
5.62 c                   eval      sodept = w_trek
5.62 c                   if        %found
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
5.62 c                   update    sohelur
5.62 c                   endif
5.62  *
5.62 c     xforbi        tag
8.03  *
8.03  * Sjekker om factoring via iizy
8.03  *
8.03 c                   if        u_803 = *on
8.03         exec sql
8.03           select rkfsel, rkfkli, rkffa1, rkffa2
8.03             into :w_fsel, :w_fkli, :w_ffa1, :w_ffa2
8.03           from ra34st
8.03              where rkffir = :w_firm;
8.03  *
8.03  * Bygger opp kiddfelt DNB versjon?
8.03  *
8.03 c                   if        w_fsel = 'DNB'
8.03 c                   eval      d_fast_d = w_ffa1
8.03 c                   eval      d_kund_d = w_fkli
8.03 c                   eval      d_kbil_d = sobinr
8.03 c                   eval      w_kkus = d_kkus_d
8.03 c                   eval      w_ksif = 0
8.03  *
8.03 c                   call      'AK720R'
8.03 c                   parm                    w_kkus
8.03 c                   parm                    w_ksif
8.03  *
8.03 c                   eval      d_kmod_d = w_ksif
8.03 c                   endif
8.03  *
8.03  * Bygger opp kiddfelt SB1 versjon?
8.03  *
8.03 c                   if        w_fsel = 'SB1'
8.03 c                   eval      d_fas1_s = w_ffa1
8.03 c                   eval      d_klin_s = w_fkli
8.03 c                   eval      d_kbil_s = sobinr
8.03 c                   eval      d_fas2_s = w_ffa2
8.03 c                   eval      w_kkus = d_kkus_s
8.03 c                   eval      w_ksif = 0
8.03  *
8.03 c                   call      'AK720R'
8.03 c                   parm                    w_kkus
8.03 c                   parm                    w_ksif
8.03  *
8.03 c                   eval      d_kmod_s = w_ksif
8.03 c                   endif
8.03  *
8.03  * Bygger opp kiddfelt Nordea versjon?
8.03  *
8.03 c                   if        w_fsel = 'NORDEA'
8.03 c                   eval      d_kund_n = sokund
8.03 c                   eval      d_klin_n = w_fkli
8.03 c                   eval      d_kbil_n = sobinr
8.03 c                   eval      d_fast_n = w_ffa1
8.03 c                   eval      w_kkus = d_kkus_n
8.03 c                   eval      w_ksif = 0
8.03  *
8.03 c                   call      'AK720R'
8.03 c                   parm                    w_kkus
8.03 c                   parm                    w_ksif
8.03  *
8.03 c                   eval      d_kmod_n = w_ksif
8.03 c                   endif
8.07  *
8.07  * Bygger opp kiddfelt Nordeany versjon?
8.07  *
8.07 c                   if        w_fsel = 'NORDEANY'
8.07 c                   eval      d_klin_y = w_fkli
8.07 c                   eval      d_fast_y = w_ffa1
8.07 c                   eval      d_kbil_y = sobinr
8.07 c                   eval      w_kkus = d_kkus_y
8.07 c                   eval      w_ksif = 0
8.07  *
8.07 c                   call      'AK720R'
8.07 c                   parm                    w_kkus
8.07 c                   parm                    w_ksif
8.07  *
8.07 c                   eval      d_kmod_y = w_ksif
8.07 c                   endif
8.03  *
8.03  * Bygger opp kiddfelt Svea versjon?
8.03  *
8.03 c                   if        w_fsel = 'SVEA'
8.03 c                   eval      d_klin_v = w_fkli
8.03 c                   eval      d_fast_v = w_ffa2
8.03 c                   eval      d_kbil_v = sobinr
8.03 c                   eval      w_kkus = d_kkus_v
8.03 c                   eval      w_ksif = 0
8.03  *
8.03 c                   call      'AK720R'
8.03 c                   parm                    w_kkus
8.03 c                   parm                    w_ksif
8.03  *
8.03 c                   eval      d_kmod_v = w_ksif
8.03 c                   endif
8.03 c                   endif
5.04  *
5.04  * Løsning for å kunne benytte kortere kidd-nummer,
5.04  * samt oppdatering av kiddnummer og kiddreferanse
5.04  * i historisk faktura register.
5.04  *
5.04  * Bygger opp kiddfelt (lang versjon)
5.04  *
5.04 c                   eval      d_kfir = w_firm
5.04 c                   eval      d_kkod = 0
5.04 c                   eval      d_kled = 0
6.nu c                   eval      d_ktyp = 0
5.04 c                   eval      d_kkto = sokund
5.04 c                   eval      d_kbil = sobinr
5.04 c                   eval      w_kkus = d_kkus
5.04 c                   eval      w_ksif = 0
5.04  *
5.04  * Beregning av sjekksiffer på kiddfelt (lang versjon)
5.04  *
5.04 c                   call      'AK720R'
5.04 c                   parm                    w_kkus
5.04 c                   parm                    w_ksif
5.04  *
5.04 c                   eval      d_kmod = w_ksif
5.49  *
5.49  * Beregning av sjekksiffer på fakturanr (egendef. kidd)
5.49  *
5.49 c                   eval      d_kfak_2 = sobinr
5.49 c                   eval      w_kkus   = d_kkus_2
5.49  *
5.49 c                   call      'AK720R'
5.49 c                   parm                    w_kkus
5.49 c                   parm                    w_ksif
5.49  *
5.49 c                   eval      d_kmod_2 = w_ksif
5.49 c                   eval      w_kki2   = d_kkid_2
7.08  *
7.08  * Beregning av sjekksiffer på fakturanr SAP_13
7.08  *
7.08 c                   if        w_sap_kid = 'J'
7.08 c                   eval      d_kfak_3 = sobinr
7.08 c                   eval      w_kkus   = d_kkus_3
7.08  *
7.08 c                   call      'AK720R'
7.08 c                   parm                    w_kkus
7.08 c                   parm                    w_ksif
7.08  *
7.08 c                   eval      d_kmod_3 = w_ksif
7.08 c                   eval      w_kkid   = d_kkid_3
7.08 c                   eval      w_kidr   = *zero
7.08 c                   eval      w_ksif   = *zero
7.08 c                   endif
5.04  *
5.04  * Oppdatering av kidd-referanse-fil
5.04  *
7.08 c                   if        w_sap_kid <> 'J'
5.04 c                   eval      w_kkid = d_kkid
5.04  *
6.34 c                   movel     w_kki2        w_kki27
6.34 c                   move      w_kki27       w_kki21
6.34 c                   move      *blanks       w_kki2
6.34 c                   move      w_kki21       w_kki2
      *
5.04 c                   call      'AK700R'
5.04 c                   parm                    w_firm
5.04 c                   parm                    w_kkid
5.04 c                   parm                    w_kidr
5.04 c                   parm                    w_ksif
5.49 c                   parm                    w_kki2
7.08 c                   endif
8.03  *
8.03  * Legge inn kid fra factoring selskap om det er valgt
8.03  *
8.03 c                   if        u_803 = *on
8.03 c                   if        w_fsel = 'DNB'
8.03 c                   eval      w_kkid = d_kkid_d
8.03 c                   endif
8.03 c                   if        w_fsel = 'SB1'
8.03 c                   eval      w_kkid = d_kkid_s
8.03 c                   endif
8.03 c                   endif
8.03 c                   if        w_fsel = 'NORDEA'
8.03 c                   eval      w_kkid = d_kkid_n
8.03 c                   endif
8.07 c                   if        w_fsel = 'NORDEANY'
8.07 c                   eval      w_kkid = d_kkid_y
8.07 c                   endif
8.03 c                   if        w_fsel = 'SVEA'
8.03 c                   eval      w_kkid = d_kkid_v
8.03 c                   endif
5.04  *
5.04  * Oppdatering av kidd-informasjon i hist fakt hode register
5.04  *
5.04 c     sohelu_key    chain     sohelur
5.04  *
5.04 c                   if        %found
5.04 c                   movel     w_kidr        sokidr
5.04 c                   move      w_ksif        sokidr
5.04 c                   move      w_kkid        sokidd
6.10 c                   time                    soedat
6.10 c                   time                    soetim
6.10 c                   eval      soeusr = l_user
5.04 c                   update    sohelur
5.04 c                   endif
5.04  *
5.04 c                   eval      w_kidr = 0
5.04 c                   eval      w_ksif = 0
5.04 c                   eval      w_kkid = *blank
5.04 c                   eval      sokidr = 0
5.04 c                   eval      sokidd = *blank
5.04 c                   eval      sofsum = 0
5.05  *
5.05  * Nullstiller linjeteller
5.05  * i statistikk-filen
5.05  *
5.05 c                   eval      w_line = 0
      *
      * Klargjør for oppdatering
      * av kundetransaksjon
      *
     c                   eval      t_belp = w6fsum * -1
8.18 c                   if        w_obil <> 0
8.18 c                   eval      t_bilk = w_obil
8.18 c                   else
     c                   eval      t_bilk = vaobil
8.18 c                   endif
      *
     c                   eval      t_mkod = '0'
     c                   eval      t_kont = fokund
     c                   eval      t_avde = 0
     c                   eval      t_spes = 0
      *
     c                   if        vaooko = 1
6.24  * Hvis korttbelastning, ta vare på verdier (BM og Maxbo kort)
6.24 c                   if        fopsuf = 5 or
6.2c c                             fopsuf = 4 or
6.24 c                             fopsuf = 3
6.2A  * Lag ekstra sjekk mot at kunden reelt sett har kort. Vært noe problemer
6.2A  * med feilnmerking.
6.2A  * b_kunde = *off = ordren er feilmerket
6.2A  * b_opflg = *off = oppfølging på hovedbok
6.2A c                   eval      b_kunde = *off
6.2A c                   eval      b_opflg = *off
6.2A c                   exsr      sjk_kunde
6.19 c                   eval      xtkref = t_kref
6.19 c                   eval      xtproj = t_proj
6.19 c                   eval      xtakti = t_akti
6.19 c                   eval      xtkkod = t_autx
6.19 c                   eval      t_autx = 'K'
6.19 c                   eval      xtanta = w_anta
6.19 c                   eval      xtmvag = t_mvag
6.19 c**                 eval      xtmvap = wtmvap
6.2A c                   eval      b_kort = *off
6.2A c                   exsr      sjk_kort
6.30 c**6.36             eval      t_bilk = w_akod
6.2A c                   if        b_opflg = *on
6.2A c                   eval      xtbilk = t_bilk
6.30 c**Reversert under  eval      t_bilk = w_akod
6.36 c                   eval      t_bilk = w_akod
6.2A c                   eval      t_autx = xtkkod
6.2A c                   endif
6.19 c                   endif
6.19  *
     c                   exsr      x_okon
6.24  * Hvis kortføring, skal vi motpostere samme transaksjon. (BM og Maxbo kort)
6.2A  * NB Kun hvis det er hovedboksoppfølging.
6.2A c                   if        b_kunde = *on and
6.2A c                             b_opflg = *off
6.24 c                   if        fopsuf = 5 or
6.2c c                             fopsuf = 4 or
6.24 c                             fopsuf = 3
6.19  * Sjekk at kontoinfo finnes for at vi skal legge ut ekstra posteringer
6.19 c**6.2A             eval      b_kort = *off
6.19 c**6.2A             exsr      sjk_kort
6.19 c                   if        b_kort = *on
6.19 c                   eval      t_kref = xtkref
6.19 c                   eval      t_proj = xtproj
6.19 c                   eval      t_akti = xtakti
6.19 c**                 eval      t_autx = xtkkod
6.21 c                   eval      t_autx = 'K'
6.19 c                   eval      w_anta = xtanta
6.19 c                   eval      t_mvag = xtmvag
6.19 c**                 eval      wtmvap = xtmvap
6.19 c                   eval      t_belp = w6fsum
6.19 c                   eval      t_bilk = w_akod
6.19 c                   eval      t_kont = fokund
6.19  * Lag motpost til konto
6.19 c                   exsr      x_okon
6.19  * Lag innbetaling på bank
6.19 c                   eval      t_autx = xtkkod
6.19 c                   eval      t_kref = xtkref
6.19 c                   eval      t_proj = xtproj
6.19 c                   eval      t_akti = xtakti
6.19 c                   eval      w_anta = xtanta
6.19 c                   eval      t_mvag = xtmvag
6.19 c**                 eval      wtmvap = xtmvap
6.19 c                   eval      t_belp = w6fsum * -1
6.19 c                   eval      t_bilk = w_akod
6.19 c                   eval      t_kont = w_kont
6.19  * Lag motpost til konto
6.19 c                   exsr      x_okon
6.19 c                   endif
6.19 c                   endif
6.2A c                   endif
6.19  *
     c                   endif
3.01  *
3.01  * Ved internfaktura skal det skapes en postering til,
3.01  * mot vareforbruk m/prosjekt og motpost til kundekonto
3.01  * for å nullstille denne igjen.
3.01  *
3.01  * Klargjøring av postering til kundekonto
3.01  *
3.01 c                   if        rkspfa = 1
6.33 c                   if        w_mkod = 1
3.01 c                   eval      t_belp = w6fsum
8.18 c                   if        w_obil <> 0
8.18 c                   eval      t_bilk = w_obil
8.18 c                   else
3.01 c                   eval      t_bilk = vaobil
8.18 c                   endif
3.01  *
3.01 c                   eval      t_mkod = '0'
3.01 c                   eval      t_kont = fokund
3.01 c                   eval      t_avde = 0
3.01 c                   eval      t_spes = 0
3.01  *
3.01 c                   if        vaooko = 1
3.01 c                   exsr      x_okon
3.01 c                   endif
3.01  *
3.01 c                   endif
3.01 c                   endif
      *
      * Ø R E A V R U N D I N G
      *
     c                   eval      t_belp = w6fsum - w6hsum
      *
     c                   if        w6hsum <> 0
     c                   if        t_belp <> 0
     c                   eval      t_bilk = faabil
      *
      * Hent opplysninger fra VARE-REGISTER
      *
6.2h c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = faavnr
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found(vvarl1)
     c                   exsr      x_bvare
     c                   endif
      *
      * Finner den kontoen som skal benyttes
      *
     c                   exsr      x_konto
      *
3.35 c                   eval      t_mkod = '0'
5.25 c                   eval      t_avde = d_kav1
     c                   eval      t_kont = d_kko1
     c                   eval      t_spes = d_ksp1
      *
     c                   if        vaooko = 1
     c                   exsr      x_okon
     c                   endif
     c                   endif
     c                   endif
3.01  *
3.01  * Ved internfaktura må også øreavrunding legges ut
3.01  * en gang til med motsatt fortegn
3.01  *
3.01  * Klargjøring av postering for øreavrunding
3.01  *
3.01 c                   if        rkspfa = 1
6.33 c                   if        w_mkod = 1
3.01  *
3.01 c                   eval      t_belp = w6hsum - w6fsum
3.01  *
3.01 c                   if        w6hsum <> 0
3.01 c                   if        t_belp <> 0
3.01 c                   eval      t_bilk = faabil
3.01  *
3.01 c                   eval      t_mkod = '0'
3.01 c                   eval      t_avde = d_kav1
3.01 c                   eval      t_kont = d_kko1
3.01 c                   eval      t_spes = d_ksp1
3.01  *
3.01 c                   if        vaooko = 1
3.01 c                   exsr      x_okon
3.01 c                   endif
3.01 c                   endif
3.01 c                   endif
3.01  *
3.01 c                   endif
3.01 c                   endif
      *
     c                   eval      w6hsum = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av brudd på LR tot
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_lrtot       begsr
      *
     c                   eval      d_aarr = sohelu_aarr
     c                   eval      d_otyp = sootyp
     c                   eval      d_ffnr = w_frst
     c                   eval      d_tfnr = sobinr
5.45 c                   eval      d_kopi = ' '
5.45 c                   eval      d_dumy = '*'
      *
     c                   eval      p_parm = d_parm
6.35a *
6.35ac                   eval      hiinlr = *off
6.35ac                   eval      hifirm = w_firm
6.35ac                   eval      hirkat = 0
6.35ac                   eval      hikund = 0
6.35ac                   eval      hikpro = 0
6.35ac                   eval      hivare = *blank
6.35ac                   eval      hienhe = *blank
6.35ac                   eval      hilety = 0
6.35ac                   eval      hiavgf = 0
6.35ac                   eval      hipriv = 0
6.35ac                   eval      hiskaf = *off
6.35ac                   eval      hidato = *loval
6.35ac                   eval      hitime = *loval
6.35a *
6.35ac                   call      'VP905R'
6.35ac                   parm                    hirec
6.35ac                   parm                    horec
6.35a *
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ordrehode
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_hode        begsr
      *
      * Hent opplysninger fra ORDRE-HODE-REGISTER
      *
     c                   eval      fohel1_numm = fksonr
     c                   eval      fohel1_suff = fkssuf
     c     fohel1_key    chain     fohel1r
      *
      * Hent opplysninger fra KUNDE-REGISTER
      *
     c                   eval      rkunl1_kund = fokund
     c     rkunl1_key    chain     rkunl1r
6.33 c                   eval      w_mkod = rkmkod
      *
6.33  * Hent opplysninger fra KUNDE-PROSJEKT
6.33  *
6.33 c                   if        fokpro > 0
6.33 c                   eval      fkprl1_kund = fokund
6.33 c                   eval      fkprl1_kpro = fokpro
6.33 c     fkprl1_key    chain     fkprl1
6.33 c                   if        %found(fkprl1)
6.33 c                   eval      w_mkod = flmkod
6.33 c                   endif
6.33 c                   endif
6.33  *
      *
      * Legger inn faktura-dato dersom ikke overstyrt
      *
     c                   if        fofkda = *loval
     c                   eval      fofkda = l_fkda
     c                   endif
      *
      * Beregner forfalls-dato dersom ikke overstyrt
      *
     c                   if        foffda = *loval
     c                   call      'FÅ703R'
     c                   parm                    fksfir
     c                   parm                    fobetb
     c                   parm                    fofkda
     c                   parm                    w_bsts
     c                   parm                    foffda
     c                   parm                    w_btxt
     c                   parm                    w_btxt
     c                   endif
5.23  *
5.23  * Sett forfallsdato = fakturadato
5.23  * dersom dette er en kreditnota
8.24  * NB Hvis samlefakturering, skal det kun gjøres om
8.24  * totalen er negativ.
5.24  *
8.24 c                   if        b_samf = *off
5.24 c                   if        vaokre = '-'
5.23 c                   eval      foffda = fofkda
5.23 c                   endif
8.24 c                   else
8.24 c                   if        b_forf = *on
8.24 c                   eval      foffda = fofkda
8.24 c                   endif
8.24 c                   endif
      *
      * Beregner justeringsbeløp
      *
6.13 c                   eval(h)   w_sald = (fotots - fototr) * w_mvat
7.fb  *
7.fb  * Beregne fordeling forhåndsbetalt
7.fb c                   exsr      finn_forh
5.60  *
5.60  * Oppdaterer KUNDE-REGISTER med
5.60  * akkumulerte bruksretts-rabatter
5.60  *
5.60 c                   if        vaokre = '-'
5.60 c                   eval      fobrra = fobrra * -1
5.60 c                   endif
5.60 c                   eval      rkunlu_kund = fokund
6.32 c*    rkunlu_key    chain     rkunlur
6.32 c     rkunlu_key    chain     rkmelur
5.60 c                   eval      rkkjal = rkkjal + fobrra
5.60 c                   if        %found
6.32 c**                 time                    rk2DPT
6.32 c**                 eval      rkePGM = 'FO616R    '
6.32 c**                 update    rkunlur
6.32 c                   time                    rkmeda
6.32 c                   time                    rkmeti
6.32 c                   eval      rkmeus = l_user
6.32 c                   update    rkmelur
5.60 c                   endif
      *
      * Adderer inn sum for beregning av gebyr
      *
8.20 c                   if        faksum <> 0
8.20 c                   eval      w_geb0 = faksum
8.20 c                   else
     c                   eval      w_geb0 = (w_geb0 + fotots) - fototr
8.20 c                   endif
      *
     c                   if        fokgfa = 0
8.20 c                   if        faksum <> 0
8.20 c                   eval      w_geb1 = faksum
8.20 c                   else
     c                   eval      w_geb1 = (w_geb1 + fotots) - fototr
8.20 c                   endif
     c                   endif
      *
     c                   if        fokgfr = 0
8.20 c                   if        faksum <> 0
8.20 c                   eval      w_geb2 = faksum
8.20 c                   else
     c                   eval      w_geb2 = (w_geb2 + fotots) - fototr
8.20 c                   endif
     c                   endif
      *
     c                   if        fokgek = 0
8.20 c                   if        faksum <> 0
8.20 c                   eval      w_geb3 = faksum
8.20 c                   else
     c                   eval      w_geb3 = (w_geb3 + fotots) - fototr
8.20 c                   endif
     c                   endif
      *
      * Legger inn bilagskode fra ordretype i hjelpevariabel
      *
8.18 c                   if        w_obil <> 0
8.18 c                   eval      t_bilk = w_obil
8.18 c                   else
     c                   eval      t_bilk = vaobil
8.18 c                   endif
      *
      * Dersom faktura/kreditnota bilagsnummer=fakturanummer
      *
     c                   if        vaoakk = 3
     c                   eval      t_biln = sohelu_binr
     c                   endif
      *
      * Snur fakturadato og forfallsdato før utlegging til regnskap
      *
     c                   eval      t_bdat = 0
     c                   eval      t_fdat = 0
      *
     c                   if        fofkda <> *loval
     c     *dmy          move      fofkda        t_bdat
     c                   endif
      *
     c                   if        foffda <> *loval
     c     *dmy          move      foffda        t_fdat
     c                   endif
      *
      * Legger over opplysninger i utfeltene
      *
     c                   eval      w_fkda = 0
      *
     c                   if        fofkda <> *loval
     c     *ymd          move      fofkda        w_fkda
     c                   endif
      *
5.69 c                   move      w_fkda        t_bunt
      *
      * Sjekker om dette er en negativ ordre
      *
     c                   if        vaokre = '-'
     c                   eval      w_dbkr = 'K'
     c                   endif
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av tekstlinjer (varelinjenivå)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_lintxt      begsr
      *
      * Oppdaterer FAKTURA-LINJE-REGISTER med nye linjer
      *
     c                   clear                   sodtlur
      *
     c                   eval      sodtlu_ktxt = 3
     c                   eval      sodtlu_line = fdline
     c     sodtlu_key    chain     sodtlur
      *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      sdotyp = w_koty
8.18 c                   else
     c                   eval      sdotyp = footyp
8.18 c                   endif
     c                   eval      sdltyp = fdltyp
     c                   eval      sdlety = fdlety
     c                   eval      sdvare = *blank
     c                   eval      sdlage = fdlage
     c                   eval      sdtek1 = fdtek1
     c                   eval      sdtek2 = fdtek2
      *
5.02 c                   eval      sdbenr = fdbenr
5.02 c                   eval      sdbsuf = fdbsuf
6.2f c                   eval      sdblin = fdblin
      *
     c                   if        %found
     c                   update    sodtlur
     c                   else
     c                   eval      sdfirm = w_firm
     c                   eval      sdaarr = sodtlu_aarr
     c                   eval      sdbinr = sodtlu_binr
     c                   eval      sdnumm = sodtlu_numm
     c                   eval      sdsuff = sodtlu_suff
     c                   eval      sdktxt = sodtlu_ktxt
     c                   eval      sdline = sodtlu_line
     c                   write     sodtlur
     c                   endif
      *
3.10  * Nullstiller kode for varelinje
3.10  *
3.10 c                   eval      w_vlin = *blank
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ordrelinje mot økonomi
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_linoko      begsr
      *
      * Nullstiller totaler for utskrift
      *
     c                   eval      w_beln = 0
     c                   eval      w_belo = 0
     c                   eval      w_belb = 0
     c                   eval      w_belw = 0
     c                   eval      w_rkr1 = 0
     c                   eval      w_rkr2 = 0
     c                   eval      w_rkro = 0
5.31 c                   eval      w_brk1 = 0
5.31 c                   eval      w_brk2 = 0
     c                   eval      w_kost = 0
      *
      * Hent opplysninger fra VARE-REGISTER
      *
6.2h c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = fdvare
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found
     c                   exsr      x_bvare
     c                   endif
      *
      * Finner den kontoen som skal benyttes
      *
3.10 c                   eval      w_vlin = 'J'
      *
     c                   exsr      x_konto
      *
      * Beregne beløp og oppdatere
      * Økonomi og statistikk
      *
7.07 c                   eval      b_type = *on
     c                   exsr      x_bereg
5.22  *
5.22 c                   eval      t_bill = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av ordrelinje mot hist.fakt.reg.
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_linfak      begsr
      *
     c                   clear                   sodtlur
      *
     c                   eval      sodtlu_ktxt = 3
     c                   eval      sodtlu_line = fdline
     c     sodtlu_key    chain     sodtlur
      *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      sdotyp = w_koty
8.18 c                   else
     c                   eval      sdotyp = footyp
8.18 c                   endif
     c                   eval      sdltyp = fdltyp
     c                   eval      sdlety = fdlety
     c                   eval      sdvare = fdvare
     c                   eval      sdenh1 = fdenh1
5.32 c                   eval      sdlage = fdlage
     c                   eval      sdtek1 = fdtek1
     c                   eval      sdtek2 = fdtek2
6.29 c                   eval      sdldat = fdldat
      *
     c                   eval      sdkpri = fdkpri
     c                   eval      sdkmva = vvkmva
     c                   eval      sdkord = vvkord
     c                   eval      sdlvre = fdlvre
     c                   eval      sdogrp = fdogrp
     c                   eval      sdhgrp = fdhgrp
     c                   eval      sdugrp = fdugrp
     c                   eval      sdedih = fdedih
     c                   eval      sdedil = fdedil
3.10 c                   eval      sdlvre = fdlvre
5.02 c                   eval      sdbenr = fdbenr
5.02 c                   eval      sdbsuf = fdbsuf
6.2f c                   eval      sdblin = fdblin
5.31 c                   eval      sdalme = fdalme
5.31 c                   eval      sdbrty = fdbrty
5.31 c                   eval      sdpriv = fdpriv
5.31 c                   eval      sdomva = fdomva
6.13 c                   eval      sdmpro = w_mvap
      *
     c                   eval      sdanta = fdanta
     c                   eval      sdoppr = fdoppr
     c                   eval      sdsapr = fdsapr
     c                   eval      sdkopr = fdkopr
     c                   eval      sdrab1 = fdrab1
     c                   eval      sdrab2 = fdrab2
5.31 c                   eval      sdbrr1 = fdbrr1
5.31 c                   eval      sdbrr2 = fdbrr2
     c                   eval      sdpasl = fdpasl
5.48 c                   eval      sdkbnr = fdkbnr
5.70 c                   eval      sdprgr = fdprgr
5.70 c                   eval      sdoprg = fdoprg
      *
     c                   eval      sdsalg = fdsums
     c                   eval      sdkost = fdsumk
      *
     c                   eval      sdrkr1 = w_rkr1
     c                   eval      sdrkr2 = w_rkr2
5.31 c                   eval      sdbrk1 = w_brk1
5.31 c                   eval      sdbrk2 = w_brk2
     c                   eval      sdrkro = w_rkro
7.fb  *
7.fb  * legger på fordelt redusert salg
7.fb  *
7.fb c                   if        w_fosa <> 0 and
7.fb c                             fdsums <> 0 and
7.fb c                             w_sums <> 0
7.fb c                   eval(h)   sdfosa = w_fosa * fdsums/w_sums
7.fb c                   eval      sdrkro = w_rkro + sdfosa
7.fb c                   endif
      *
      * Legge ut prosjektnummer på varelinjenivå,
3.01  * forutsatt at dette ikke er en internfaktura...
      *
6.3h c                   eval      sdproj = foproj
6.3h c                   eval      sdakti = foakti
      *
      * Legge ut avd og konto på varelinjenivå
      *
3.34 c     fomkod        cabeq     1             xtag22
3.34 c     vvkmva        cabeq     1             xtag22
6.23 c                   if        w_avde <> 0
5.36 c                   eval      sdavde = w_avde
6.23 c                   else
6.23 c                   eval      sdavde = d_kav1
6.23 c                   endif
     c                   eval      sdkont = d_kko1
     c                   eval      sdspes = d_ksp1
6.22 c                   goto      xtag23
      *
     c     xtag22        tag
6.23 c                   if        w_avde <> 0
5.36 c                   eval      sdavde = w_avde
6.23 c                   else
6.23 c                   eval      sdavde = d_kav2
6.23 c                   endif
     c                   eval      sdkont = d_kko2
     c                   eval      sdspes = d_ksp2
      *
6.22 c     xtag23        tag
5.64  *
5.64  * Legger ut kontohenvisningskode
5.64  *
5.64 c                   eval      sdkhev = d_khnv
8.02  *
8.02  * Hvis kostnadsfordeling, legg ut avdeling fra ordrehodet.
8.02  *
8.02 c                   if        u_kost = *on
8.02 c                   eval      sdavde = foavde
8.02 c                   endif
8.02  *
     c                   if        %found
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   update    sodtlur
     c                   else
     c                   eval      sdfirm = w_firm
     c                   eval      sdaarr = sodtlu_aarr
     c                   eval      sdbinr = sodtlu_binr
     c                   eval      sdnumm = sodtlu_numm
     c                   eval      sdsuff = sodtlu_suff
     c                   eval      sdktxt = sodtlu_ktxt
     c                   eval      sdline = sodtlu_line
6.10 c                   time                    sdodat
6.10 c                   time                    sdotim
6.10 c                   eval      sdousr = l_user
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   write     sodtlur
     c                   endif
      *
      * Oppdatering av statistikk native (ASSTAT)
      *
     c                   if        vaosta = 1
     c                   if        valsta = 1
     c                   exsr      x_stat
     c                   endif
     c                   endif
      *
3.10  * Nullstiller kode for varelinje
3.10  *
3.10 c                   eval      w_vlin = *blank
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Behandling av tekstlinjer (F11)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_tekst       begsr
      *
      * Hent opplysninger fra ORDRE-TEKST-REGISTER
      *
     c                   eval      fotxl1_numm = fksonr
     c                   eval      fotxl1_suff = fkssuf
     c                   eval      fotxl1_line = fkslin
     c     fotxl1_key    chain     fotxl1r
      *
      * Beregner linjekode  0-4999 = 1 (Foran) , 5000-5999 = 5 (Etter)
      *
     c                   clear                   sodtlur
      *
     c                   eval      sodtlu_ktxt = 1
     c                   if        fkslin >= 5000
     c                   eval      sodtlu_ktxt = 5
     c                   endif
      *
      * Oppdaterer FAKTURA-LINJE-REGISTER med nye linjer
      *
     c                   eval      sodtlu_line = fkslin
     c     sodtlu_key    chain     sodtlur
      *
     c                   eval      d_frix = fttext
     c                   eval      sdtek1 = d_fri1
     c                   eval      sdtek2 = d_fri2
      *
     c                   if        %found(sodtlu)
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   update    sodtlur
     c                   else
     c                   eval      sdfirm = w_firm
     c                   eval      sdaarr = sodtlu_aarr
     c                   eval      sdbinr = sodtlu_binr
     c                   eval      sdnumm = sodtlu_numm
     c                   eval      sdsuff = sodtlu_suff
     c                   eval      sdktxt = sodtlu_ktxt
     c                   eval      sdline = sodtlu_line
6.10 c                   time                    sdodat
6.10 c                   time                    sdotim
6.10 c                   eval      sdousr = l_user
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   write     sodtlur
     c                   endif
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Beregning av beløp + oppdatering av økonomi / statistikk
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_bereg       begsr
      *
6.34 c                   eval      w_bels = 0
7.fb c                   eval      w_fosw = 0
6.34  *
6.34 c                   if        fdlvre = 1
6.34  *
6.34  * tar utg.punkt i nobb-pris, mult med innkjøpsfaktor
6.34  * eller det er nettopris fra betingelse
6.34 c                   if        fdbifa = 1 and
6.34 c                             fdbntp <> 0
6.34 c                   eval      w_bels = fdbntp
6.34 c                   else
6.34 c                   eval      w_bels = fdnopr * fdbifa
6.34 c                   endif
6.34  * mult med kostprisfaktor eller kostprisbeløp
6.34 c                   if        fdpkfa = 1
6.34 c                   eval(h)   w_bels = (w_bels * fdpkfa) + fdpkbe
6.34 c                   else
6.34 c                   eval      w_bels = w_bels * fdpkfa
6.34 c                   endif
6.34  * kostpris
6.34 c                   eval      w_belk = w_bels
6.34  * mult med salgprisfaktor eller salgsprisbeløp
6.34 c                   eval      w_bels = w_bels * fdpsfa
6.34  *
6.34 c                   if        w_bels <> 0
6.34 c                   eval      w_belo = w_bels * fdanta
6.34 c                   eval      w_pkon = 'VEI'
6.34 c                   eval      w_pkns = 'VEI'
6.34 c                   endif
6.34 c                   if        w_belk <> 0
6.34 c                   eval      hokopr = w_belk
6.34 c                   eval      w_pkko = 'VEI'
6.34 c                   eval      w_pkok = 'VEI'
6.34 c                   endif
6.34  * slutt lvr
6.34 c                   else
      * Opprinnelig beløp fra vareregister
      *
6.1a c*                  eval      w_belo = fdoppr * fdanta
6.2g c                   eval      w_oppr = fdoppr * fdanta
6.2g c                   if        w_oppr > 999999999
6.2g c                   eval(h)   w_belo = 999999999
6.2g c                   else
6.1a c                   eval(h)   w_belo = fdoppr * fdanta
6.2g c                   endif
6.34  *
6.34 c                   endif
      *
      * Bruttobeløp og kostpris
      *
6.1a c*                  eval      w_belb = fdsapr * fdanta
6.1a c                   eval(h)   w_belb = fdsapr * fdanta
     c                   eval      w_kost = fdkopr * fdanta
      *
      * Linjerabatter
      *
     c                   eval(h)   w_rkr1 = (w_belb * fdrab1) / 100
     c                   eval      w_belw =  w_belb - w_rkr1
     c                   eval(h)   w_rkr2 = (w_belw * fdrab2) / 100
      *
      * Trekker ut linje rabatter
      *
     c                   eval      w_beln = fdsums - w_rkr1 - w_rkr2
7.fb  *
7.fb  * legger på fordelt redusert salg
7.fb  *
7.fb c                   if        w_fosa <> 0 and
7.fb c                             fdsums <> 0 and
7.fb c                             w_sums <> 0
7.fb c                   eval(h)   w_fosw = w_fosa * fdsums/w_sums
7.fb c                   endif
      *
      * Varelinjens andel av ordrerabatt
      *
8.11 c                   eval      w_rkro = 0
     c                   if        vvkord = 0
     c                   eval(h)   w_rkro = (w_beln * forabp) / 100
     c                   endif
5.31  *
5.31  * Almenningsrabatter
5.31  *
5.31 c                   eval      w_belx =  w_belw - w_rkr2 - w_rkro
5.31 c                   eval(h)   w_brk1 = (w_belx * fdbrr1) / 100
5.31  *
5.31 c                   eval      w_bely =  w_belx - w_brk1
5.31 c                   eval(h)   w_brk2 = (w_bely * fdbrr2) / 100
5.40  *
5.40  * Beregner riktig MVA-grunlag
5.40  *
5.40 c                   if        faasa1 = 0 and
5.40 c                             faasao = 0
5.40 c                   eval      t_mvag = w_belx
5.40 c                   endif
5.40  *
5.40 c                   if        faasa1 = 1 and
5.40 c                             faasao = 0
5.40 c                   eval      t_mvag = w_belb - w_rkro
5.40 c                   endif
5.40  *
5.40 c                   if        faasa1 = 0 and
5.40 c                             faasao = 1
5.40 c                   eval      t_mvag = w_beln
5.40 c                   endif
5.40  *
5.40 c                   if        faasa1 = 1 and
5.40 c                             faasao = 1
5.40 c                   eval      t_mvag = w_belb
5.40 c                   endif
5.40  *
5.40 c                   eval      w_mvag = w_belx
5.31  *
5.31  * Henter inn prosentsats på mva kode
5.31  *
5.31 c                   eval      w_mvap = 0
5.31 c                   eval      w_mvat = 0
5.31 c                   eval      w_mvaf = 0
5.31  *
5.31 c                   if        fdomva <> *blank
5.31 c                   eval      w_stat =  *blank
5.31 c                   eval      w_mvak =  fdomva
6.30 c                   eval      w_dato =  l_fkda
5.31  *
5.31 c                   call      'RS205R'
5.31 c                   parm                    w_stat
5.31 c                   parm                    w_mvak
5.31 c                   parm                    w_mvtx
5.31 c                   parm                    w_dato
5.31 c                   parm                    w_mvap
5.31 c                   parm                    w_mvat
5.31 c                   parm                    w_mvaf
5.31 c                   parm                    w_bpro
5.31 c                   endif
      *
      * Sjekker om dette er en negativ ordre
      *
8.22 c                   if        w_koty = *blanks or
8.22 c                             w_gebl = *blanks
     c                   if        w_dbkr = 'K'
     c                   eval      fdanta = fdanta * -1
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   eval      w_beln = w_beln * -1
     c                   eval      w_belb = w_belb * -1
     c                   eval      w_belo = w_belo * -1
     c                   eval      w_kost = w_kost * -1
     c                   eval      w_rkro = w_rkro * -1
8.xx c                   eval      w_fosw = w_fosw * -1
     c                   eval      w_rkr1 = w_rkr1 * -1
     c                   eval      w_rkr2 = w_rkr2 * -1
5.31 c                   eval      w_brk1 = w_brk1 * -1
5.31 c                   eval      w_brk2 = w_brk2 * -1
5.31 c                   eval      w_mvag = w_mvag * -1
6.12 c                   eval      t_mvag = t_mvag * -1
     c                   endif
8.22 c                   else
8.22 c                   if        w_gebl = '1' and
8.22 c                             w_fgeb = 'K'
8.22 c                   eval      fdanta = fdanta * -1
8.22 c                   eval      fdsums = fdsums * -1
8.22 c                   eval      fdsumk = fdsumk * -1
8.22 c                   eval      w_beln = w_beln * -1
8.22 c                   eval      w_belb = w_belb * -1
8.22 c                   eval      w_belo = w_belo * -1
8.22 c                   eval      w_kost = w_kost * -1
8.22 c                   eval      w_rkro = w_rkro * -1
8.22 c                   eval      w_fosw = w_fosw * -1
8.22 c                   eval      w_rkr1 = w_rkr1 * -1
8.22 c                   eval      w_rkr2 = w_rkr2 * -1
8.22 c                   eval      w_brk1 = w_brk1 * -1
8.22 c                   eval      w_brk2 = w_brk2 * -1
8.22 c                   eval      w_mvag = w_mvag * -1
8.22 c                   eval      t_mvag = t_mvag * -1
8.22 c                   endif
8.22 c                   endif
      *
      * Sjekker om dette er en negativ linje
      *
     c                   if        valkre = '-'
     c                   eval      fdanta = fdanta * -1
     c                   eval      fdsums = fdsums * -1
     c                   eval      fdsumk = fdsumk * -1
     c                   eval      w_beln = w_beln * -1
     c                   eval      w_belb = w_belb * -1
     c                   eval      w_belo = w_belo * -1
     c                   eval      w_kost = w_kost * -1
     c                   eval      w_rkro = w_rkro * -1
8.xx c                   eval      w_fosw = w_fosw * -1
     c                   eval      w_rkr1 = w_rkr1 * -1
     c                   eval      w_rkr2 = w_rkr2 * -1
5.31 c                   eval      w_brk1 = w_brk1 * -1
5.31 c                   eval      w_brk2 = w_brk2 * -1
5.31 c                   eval      w_mvag = w_mvag * -1
6.12 c                   eval      t_mvag = t_mvag * -1
     c                   endif
      *
      * Summer opp til brudd ordre
      *
     c                   eval      w2salp = w2salp + fdsums
     c                   eval      w2kstp = w2kstp + fdsumk
     c                   eval      w2rk1p = w2rk1p + w_rkr1
     c                   eval      w2rk2p = w2rk2p + w_rkr2
8.xx c                   eval      w2rkop = w2rkop + w_rkro + w_fosw
5.31 c                   eval      w2rb1p = w2rb1p + w_brk1
5.31 c                   eval      w2rb2p = w2rb2p + w_brk2
      *
5.31 c                   if        fdbrr1 > 0
5.31 c                   eval      w2gr1p = w2gr1p + w_belx
5.31 c                   endif
5.31 c                   if        fdbrr2 > 0
5.31 c                   eval      w2gr2p = w2gr2p + w_bely
5.31 c                   endif
5.40 c                   eval      w2mvgp = w2mvgp + w_mvag
      *
     c                   if        forabp <> 0
     c                   if        vvkord = 0
     c                   eval      w2rbgp = w2rbgp + w_beln
     c                   endif
     c                   endif
      *
      * Kundeprosjekt oppdateres i feltet
      * for prisordre, dersom kundeprosjekt
      * er oppgitt
      *
     c                   if        fokpro <> 0
     c                   eval      fopord = fokpro
6.20 c**                 eval      fopsuf = 0
     c                   endif
5.66  *
5.66  * Legge ut kreditreferanse
5.66  *
5.66 c                   eval      t_kref = fokref
      *
      * Legge ut prosjektnummer på varelinjenivå,
      * dersom dette ikke er en internfaktura
      *
     c                   if        rkspfa = 0
     c                   eval      t_proj = foproj
     c                   eval      t_akti = foakti
6.25 c                   eval      t_upro = foupro
6.25 c**                 if        fdproj <> 0
6.25 c                   if        fdproj <> *blanks
     c                   eval      t_proj = fdproj
     c                   eval      t_akti = fdakti
     c                   endif
     c                   endif
5.63  *
5.63  * Omregning av enhet til statistikk.........
5.63  *
5.63  * Dersom stat.enhet ikke finnes på vare, hentes stat.enhet fra
5.63  * undergruppe. Dersom stat.enhet ikke finnes på undergruppe, settes
5.63  * stat.enhet lik solgt enhet
5.63  *
5.63 c                   if        vvenhs = *blank
5.63 c                   eval      vvenhs = vguens
5.63 c                   endif
5.63  *
5.63 c                   if        vvenhs = *blank
5.63 c                   eval      vvenhs = fdenh1
5.63 c                   endif
5.63  *
5.63  * Kaller opp subrutine for omregning av antall til statistikkenhet
5.63  *
5.63 c                   eval      w_anta = fdanta
5.63  *
5.63 c                   exsr      x_omrant
5.32  *
5.32  * Sjekker om lager er overstyrt på linjenivå - henter avdeling
5.32  *
5.32 c                   eval      w_avde = foavde
6.3d  *
6.3d  * Må bruke avdeling fra varelinja
6.3d  *
6.3d c                   if        fdavde <> 0
6.3d c                   eval      d_kav1 = fdavde
6.3d c                   eval      d_kav2 = fdavde
6.3d c                   eval      d_kav3 = fdavde
6.3d c                   eval      d_kav4 = fdavde
6.3d c                   eval      d_kav5 = fdavde
6.3d c                   eval      d_kav6 = fdavde
6.3d c                   eval      d_kav7 = fdavde
6.3d c                   eval      w_avde = fdavde
6.3d c                   endif
5.32  *
5.32 c                   if        fdlage <> folage
5.32  *
5.32 c                   eval      b_feil = *off
5.32 c                   call      'FÅ720R'
5.32 c                   parm                    w_firm
5.32 c                   parm                    fdlage
5.32 c                   parm                    w_latx
5.32 c                   parm                    w_adrs
5.32 c                   parm                    w_ponr
5.32 c                   parm                    w_pste
5.32 c                   parm                    w_avde
5.32 c                   parm                    b_feil
5.32  *
5.32 c                   if        b_feil = *off
5.32 c                   eval      t_avde = w_avde
5.32 c                   endif
5.32  *
5.32 c                   endif
      *
      * Klargjøring av salg
      *
     c                   eval      t_belp = w_belb
5.50 c                   eval      w_valg = 0
5.50 c                   eval      t_text = ' '
      *
      * Linjerabatt 1/2 skal ikke spesifiseres i regnskap
      *
     c                   if        faasa1 = 0
     c                   eval      t_belp = t_belp - w_rkr1
5.31 c                   eval      t_belp = t_belp - w_rkr2
     c                   endif
      *
      * Almenningsrabatt skal ikke spesifiseres i regnskap
      *
     c                   if        faasa2 = 0
5.31 c                   eval      t_belp = t_belp - w_brk1
5.31 c                   eval      t_belp = t_belp - w_brk2
     c                   endif
      *
      * Ordrerabatt skal ikke spesifiseres i regnskap
      *
     c                   if        faasao = 0
     c                   eval      t_belp = t_belp - w_rkro
     c                   endif
      *
      *  Sjekk om ordre eller vare avgiftsfritt
      *
3.34 c     fomkod        cabeq     1             xtag20
3.34 c     vvkmva        cabeq     1             xtag20
6.13 c     w_mvap        cabeq     0             xtag20
6.13  *
6.13  *  Beregning av mva
6.13  *
6.13 c                   eval(h)   t_belp = t_belp +
6.13 c                                      ((t_mvag * w_mvap) / 100)
6.13 c                   eval      t_mkod = fdomva
6.13 c                   eval      t_avde = d_kav1
6.13 c                   eval      t_kont = d_kko1
6.13 c                   eval      t_spes = d_ksp1
6.13  *
     c                   goto      xtag21
      *
     c     xtag20        tag
6.13 c                   eval      t_mkod = fdomva
     c                   eval      t_avde = d_kav2
     c                   eval      t_kont = d_kko2
     c                   eval      t_spes = d_ksp2
      *
     c     xtag21        tag
     c                   eval      w6hsum = w6hsum + t_belp
6.13  *
6.13  * Akkumuler opp momsen
6.13  *
6.13 c                   eval      w_mgrl = w_belb - w_rkr1 - w_rkr2
6.13 c                   eval      w_mgrl = w_mgrl - w_rkro
8.xx c                   eval      w_mgrl = w_mgrl - w_fosw
6.13 c*                  eval      w_mgrl = w_mgrl - w_brk1 - w_brk2
8.27 c*                  eval      w_moms = (w_mgrl * w_mvap) / 100
8.27 c                   eval(h)   w_moms = (w_mgrl * w_mvap) / 100
6.13 c                   eval      w6moms = w6moms + w_moms
      *
      * Oppdatering av økonomi
      *
     c                   if        vaooko = 1 and
     c                             valoko = 1 and
     c                             t_belp <> 0
     c                   exsr      x_okon
     c                   endif
      *
      * Klargjøring av rabatt 1 + 2
      *
      * Sjekk om rabatt skal spesifiseres på egen konto
      *
     c                   if        faasa1 = 1
5.32 c                   eval      t_avde = w_avde
5.31 c                   eval      t_kont = d_kko6
5.31 c                   eval      t_spes = d_ksp6
5.31  *
5.31  * Oppdatering av økonomi
5.31  *
5.40 c                   eval      t_mvag = 0 - w_rkr1 - w_rkr2
5.31 c                   eval      t_belp = 0 - w_rkr1 - w_rkr2
5.31 c                   eval(h)   t_belp = t_belp + ((t_mvag * w_mvap) / 100)
5.31 c                   eval      w6hsum = w6hsum + t_belp
5.40  *
5.31 c                   if        vaooko = 1 and
5.31 c                             valoko = 1 and
5.31 c                             t_belp <> 0
5.31 c                   exsr      x_okon
5.31 c                   endif
5.40  *
5.31 c                   endif
      *
      * Klargjøring av almenningsrabatt 1 og 2
5.31  *
5.31  * Henter kontoinformasjon for føring av rabatt
5.31  *
     c                   if        faasa2 = 1 and
5.50 c                             fdalme <> 0
5.31 c                   eval      rmbtlr_talm = fdalme
5.31 c                   eval      rmbtlr_tbrt = fdbrty
5.31 c     rmbtlr_key    chain     rmbtlr
5.31 c                   if        %found
5.32 c                   eval      t_avde = w_avde
5.31 c                   eval      t_kont = rmtkto
5.31 c                   eval      t_spes = rmtsps
5.77 c                   eval      t_mkod = '0'
5.31 c                   else
5.32 c                   eval      t_avde = w_avde
5.31 c                   eval      t_kont = d_kko6
5.31 c                   eval      t_spes = d_ksp6
5.77 c                   eval      t_mkod = '0'
5.31 c                   endif
5.31  *
5.31  * Oppdatering av økonomi
5.31  *
5.31 c                   eval      t_belp = 0 - w_brk1 - w_brk2
5.31 c                   eval      w6hsum = w6hsum + t_belp
5.31 c                   eval      w_valg = 5
5.31  *
5.31 c                   if        vaooko = 1 and
5.31 c                             valoko = 1 and
5.31 c                             t_belp <> 0
5.31 c                   exsr      x_okon
5.31 c                   endif
5.31 c                   endif
      *
      * Klargjøring av ordrerabatt
      *
     c                   if        faasao = 1
     c                   eval      t_avde = w_avde
     c                   eval      t_kont = d_kko6
     c                   eval      t_spes = d_ksp6
5.31  *
5.31  * Oppdatering av økonomi
5.31  *
8.xx c                   eval      t_mvag = 0 - w_rkro - w_fosw
8.xx c                   eval      t_belp = 0 - w_rkro - w_fosw
5.42  *
5.42 c                   eval(h)   t_belp = t_belp + ((t_mvag * w_mvap) / 100)
5.42  *
5.31 c                   eval      w6hsum = w6hsum + t_belp
5.42  *
5.31 c                   if        vaooko = 1 and
5.31 c                             valoko = 1 and
5.31 c                             t_belp <> 0
5.31 c                   exsr      x_okon
5.31 c                   endif
      *
5.31 c                   endif
      *
      * Klargjøring av kostpris
      *
     c                   if        faasak = 1
     c                   eval      t_belp = 0 - w_kost
     c                   eval      t_avde = d_kav3
     c                   eval      t_kont = d_kko3
     c                   eval      t_spes = d_ksp3
     c                   eval      t_mkod = '0'
      *
      * Oppdatering av økonomi
      *
     c                   if        vaooko = 1
     c                   if        valoko = 1
     c                   if        t_belp <> 0
     c                   exsr      x_okon
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
      * Klargjøring av kostpris (motpost)
      *
     c                   if        faasak = 1
     c                   eval      t_belp = w_kost
     c                   eval      t_avde = d_kav5
     c                   eval      t_kont = d_kko5
     c                   eval      t_spes = d_ksp5
     c                   eval      t_mkod = '0'
      *
      * Oppdatering av økonomi
      *
     c                   if        vaooko = 1
     c                   if        valoko = 1
     c                   if        t_belp <> 0
     c                   exsr      x_okon
     c                   endif
     c                   endif
     c                   endif
     c                   endif
3.01  *
3.01  * Ved internfaktura skal det skapes en postering til,
3.01  * mot vareforbruk m/prosjekt og motpost til kundekonto
3.01  * for å nullstille denne igjen.
3.01  *
3.01  * Klargjøring av postering til vareforbruk
3.01  *
3.01 c                   if        rkspfa = 1
6.33 c                   if        w_mkod = 1
3.01 c                   eval      t_proj = foproj
6.2e c                   eval      t_upro = foupro
3.01 c                   eval      t_akti = foakti
6.25 c**                 if        fdproj <> 0
6.25 c                   if        fdproj <> *blanks
3.01 c                   eval      t_proj = fdproj
3.01 c                   eval      t_akti = fdakti
3.01 c                   endif
3.01 c                   eval      t_belp = 0 - w_belb
3.01 c                   eval      t_belp = t_belp + w_rkr1 + w_rkr2
3.01 c                   eval      t_belp = t_belp + w_rkro
8.xx c                   eval      t_belp = t_belp + w_fosw
3.01 c                   eval      t_avde = d_kav7
3.01 c                   eval      t_kont = d_kko7
3.01 c                   eval      t_spes = d_ksp7
3.01 c                   eval      t_mkod = '0'
5.33  *
5.33  * Legg inn avdeling fra kunderegister
5.33  * dersom avdeling er oppgitt her
5.33  *
5.33 c                   eval      s_avde =  t_avde
5.33  *
5.33 c                   if        rkavde <> 0
5.33 c                   eval      t_avde =  rkavde
5.33 c                   endif
3.01  *
3.01  * Oppdatering av økonomi
3.01  *
3.01 c                   if        vaooko = 1
3.01 c                   if        valoko = 1
3.01 c                   if        t_belp <> 0
3.01 c                   exsr      x_okon
3.01 c                   endif
3.01 c                   endif
3.01 c                   endif
5.33  *
5.33 c                   eval      t_avde =  s_avde
3.01  *
3.01 c                   endif
3.01 c                   endif
7.07  *
7.07  * Omfordeling av kostnader når varer blir levert
7.07  * fra et annet lager enn salgsavdelingen
7.07  *
7.07  * NB! Utløsende faktor for ekstra posteringer må være avvik
7.07  *     mellom avdeling på ordrehode og avdeling på ordrelinje
7.07  *     Hent først inn avdeling fra lager på linjenivå.
7.07  *
7.07 c                   eval      w_avd1 = 0
7.07 c                   eval      w_avd2 = 0
7.07  *
7.07  * Kun hvis tilpasning med kostnadsfordeling skal kjøres ?
7.07  *
7.07 c                   if        u_kost = *on
7.07  *
7.07  * Poster skal ikke genereres dersom det er direkteleverte
7.07  * ordre.
7.07  *
7.07 c                   if        folety = 1
7.07 c                   goto      end_kost
7.07 c                   endif
7.07  *
7.07  * Skal ikke kostpostere frakt etc.
7.07  *
7.07 c                   if        vvogrp = 1   and
7.07 c                             vvhgrp = 1   and
7.07 c                             vvugrp = 999
7.07 c                   goto      end_kost
7.07 c                   endif
7.07  *
7.07  * Poster skal bare genereres dersom ordinære varelinjer
7.07  * (d.v.s. ikke på gebyrer etc.)
7.07  *
7.07 c                   if        b_type = *off
7.07 c                   goto      end_kost
7.07 c                   endif
7.07  *
7.07 c                   eval      b_feil = *off
7.07 c                   call      'FÅ720R'
7.07 c                   parm                    w_firm
7.07 c                   parm                    fdlage
7.07 c                   parm                    w_latx
7.07 c                   parm                    w_adrs
7.07 c                   parm                    w_ponr
7.07 c                   parm                    w_pste
7.07 c                   parm                    w_avde
7.07 c                   parm                    b_feil
7.07  *
7.07 c                   if        b_feil = *off
7.07 c                   eval      w_avd2 = w_avde
7.07 c                   endif
7.07  *
7.07 c                   eval      w_avd1 = foavde
7.07  *
7.07  * Avslutt dersom ingen avvik på avdeling
7.07  *
7.07 c                   if        w_avd1 = w_avd2
7.07 c                   goto      end_kost
7.07 c                   endif
7.07  *
7.07  * Kostpris avdeling for salg
7.07  *
7.07 c                   eval      t_belp = 0 - w_kost
7.07 c                   eval      t_avde = w_avd1
7.07 c                   eval      w_avde = w_avd1
7.07 c                   eval      t_kont = d_kko3
7.07 c                   eval      t_spes = d_ksp3
7.07 c                   eval      t_mkod = '0'
7.07  *
7.07  * Oppdatering av økonomi
7.07  *
7.07 c                   if        vaooko = 1
7.07 c                   if        valoko = 1
7.07 c                   if        t_belp <> 0
7.07 c                   exsr      x_okon
7.07 c                   endif
7.07 c                   endif
7.07 c                   endif
7.07  *
7.07  * Kostpris avdeling for vareutlevering
7.07  *
7.07 c                   eval      t_belp = w_kost
7.07 c                   eval      t_avde = w_avd2
7.07 c                   eval      w_avde = w_avd2
7.07 c                   eval      t_kont = d_kko3
7.07 c                   eval      t_spes = d_ksp3
7.07 c                   eval      t_mkod = '0'
7.07  *
7.07  * Oppdatering av økonomi
7.07  *
7.07 c                   if        vaooko = 1
7.07 c                   if        valoko = 1
7.07 c                   if        t_belp <> 0
7.07 c                   exsr      x_okon
7.07 c                   endif
7.07 c                   endif
7.07 c                   endif
7.07  *
7.07 c                   endif
7.07  *
7.07 c     end_kost      tag
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Generering av gebyrer
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_gebyr       begsr
      *
      * Innlegging av spesialkoder for gebyrer
      *
     c                   eval      sodtlu_numm = fksonr
     c                   eval      sodtlu_suff = fkssuf
     c                   eval      sodtlu_ktxt = 9
7.02  *
7.02  *   Hvis kunde/kundeprosjekt har korttype = 4 skal det ikke legges til fakturagebyr
7.02  *
7.02 c                   eval      rukrl5_kkun = fokund
7.02 c                   eval      rukrl5_kpro = fokpro
7.02 c                   eval      rukrl5_ktyp = 4
7.02 c     rukrl5_key    chain     rukrl5
7.02 c                   if        not %found(rukrl5)
7.02 c                   eval      rukrl5_kpro = *zero
7.02 c     rukrl5_key    chain     rukrl5
7.02 c                   endif
7.02 c                   if        %found(rukrl5)
7.02 c                   goto      nofgeb
7.02 c                   endif
7.02  *
7.02  * Sjekk om fakturagebyr
7.02  *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      fgebl2_otyp = w_koty
8.18 c                   else
7.02 c                   eval      fgebl2_otyp = fksoty
8.18 c                   endif
7.02 c                   eval      fgebl2_kkat = rkkatg
7.02 c                   eval      fgebl2_ftyp = fofaty
7.02 c                   eval      fgebl2_type = 1
7.02  *    1.                                             OT  -  KK  -  FT
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_kkat = 00
7.02  *    2.                                             OT  -  00  -  FT
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_ftyp = 00
7.02 c                   eval      fgebl2_kkat = rkkatg
7.02  *    3.                                             OT  -  KK  -  00
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_kkat = 00
7.02  *    4.                                             OT  -  00  -  00
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_otyp = *blank
7.02 c                   eval      fgebl2_kkat = rkkatg
7.02 c                   eval      fgebl2_ftyp = fofaty
7.02  *    5.                                             bl  -  kk  -  FT
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_kkat = 00
7.02  *    6.                                             bl  -  00  -  FT
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_ftyp = 00
7.02 c                   eval      fgebl2_kkat = rkkatg
7.02  *    7.                                             bl  -  kk  -  00
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   eval      fgebl2_kkat = 00
7.02  *    8.                                             bl  -  00  -  00
7.02 c     fgebl2_key    chain     fgebl2
7.02 c                   if        not %found(fgebl2)
7.02 c                   goto      nofgeb
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02  *
7.02  * Hent opplysninger fra VARE-REGISTER
7.02  *
7.02 c                   eval      b_lvrva = *off
7.02 c                   eval      vvarl1_vare = fgvare
7.02 c     vvarl1_key    chain     vvarl1r
7.02 c                   if        not %found
7.02 c                   exsr      x_bvare
7.02 c                   endif
7.02  *
7.02  * Henter opplysninger fra LINJE-TYPE-REGISTER
7.02  *
7.02 c                   eval      vltyl1_ltyp = fgltyp
7.02 c     vltyl1_key    chain     vltyl1r
7.02  *
7.02  *
7.02  * Behandle gebyr legg ut linjer
7.02  *
7.02 c                   if        fgtype = 1
7.02 c                   if        w_geb1 <> 0
7.02 c                   if        w_geb1 <= fggren
7.02 c                   eval      w_geby = w_geb1
7.02 c                   exsr      x_laggeb
7.02 c                   endif
7.02 c                   endif
7.02 c                   endif
7.02 c     nofgeb        tag
7.02  *
7.02  *    ===============================================================================
      *
      * Setter inn verdier for les av gebyr-records
      *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      fgebl1_otyp = w_koty
8.18 c                   else
     c                   eval      fgebl1_otyp = fksoty
8.18 c                   endif
     c                   eval      fgebl1_kkat = rkkatg
     c                   eval      fgebl1_line = 0
     c     fgebl1_key    setll     fgebl1
      *
      * Leser gebyrer
      *
     c     gebyr1        tag
     c                   read      fgebl1                                 90
     c     *in90         cabeq     *on           gebyr9
     c     fgfirm        cabne     w_firm        gebyr9
     c     fgotyp        cabne     fgebl1_otyp   gebyr9
     c     fgkkat        cabne     fgebl1_kkat   gebyr9
      *
      * Hent opplysninger fra VARE-REGISTER
      *
6.2h c                   eval      b_lvrva = *off
     c                   eval      vvarl1_vare = fgvare
     c     vvarl1_key    chain     vvarl1r
     c                   if        not %found
     c                   exsr      x_bvare
     c                   endif
      *
      * Henter opplysninger fra LINJE-TYPE-REGISTER
      *
     c                   eval      vltyl1_ltyp = fgltyp
     c     vltyl1_key    chain     vltyl1r
      *
      * Behandle gebyr legg ut linjer
      *
     c                   if        fgtype = 0
     c                   if        w_geb0 <> 0
     c                   if        w_geb0 <= fggren
     c                   eval      w_geby = w_geb0
     c                   exsr      x_laggeb
     c                   endif
     c                   endif
     c                   endif
      *
      * Behandle gebyr legg ut linjer
7.06  * Erstattes av fakturagebyr beregning ref 7.02
7.06 c*                  if        fgtype = 1
7.06 c*                  if        w_geb1 <> 0
7.06 c*                  if        w_geb1 <= fggren
7.06 c*                  eval      w_geby = w_geb1
7.06 c*                  exsr      x_laggeb
7.06 c*                  endif
7.06 c*                  endif
7.06 c*                  endif
      *
      * Behandle gebyr legg ut linjer
      *
     c                   if        fgtype = 2
     c                   if        w_geb2 <> 0
     c                   if        w_geb2 <= fggren
     c                   eval      w_geby = w_geb2
     c                   exsr      x_laggeb
     c                   endif
     c                   endif
     c                   endif
      *
      * Behandle gebyr legg ut linjer
      *
     c                   if        fgtype = 3
     c                   if        w_geb3 <> 0
     c                   if        w_geb3 <= fggren
     c                   eval      w_geby = w_geb3
     c                   exsr      x_laggeb
     c                   endif
     c                   endif
     c                   endif
      *
      * Behandle gebyr legg ut linjer
      *
     c                   goto      gebyr1
      *
     csr   gebyr9        endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for å legge ut gebyr record
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_laggeb      begsr
      *
      * Oppdaterer FAKTURA-LINJE-REGISTER med nye linjer
      *
     c                   clear                   sodtlur
      *
     c                   eval      sodtlu_line = fgline
     c     sodtlu_key    chain     sodtlur
      *
      * Dersom gebyr er en prosentsats
      * regnes denne ut og legges inn
      * i feltet for gebyr som kroner
      *
     c                   if        fgsats <> 0
     c                   eval(h)   fgbelp = (w_geby * fgsats) / 100
     c                   endif
      *
8.22 c                   eval      w_gebl = *blanks
      *
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      sdotyp = w_koty
8.18 c                   else
     c                   eval      sdotyp = footyp
8.18 c                   endif
     c                   eval      sdtek1 = fgtext
     c                   eval      sdltyp = fgltyp
     c                   eval      sdvare = fgvare
      *
     c                   eval      sdsapr = fgbelp
     c                   eval      sdkopr = fgbelp
8.23 c                   eval      sdoppr = fgbelp
      *
      * Sjekker om dette er en negativ ordre
      *
8.22 c                   if        w_koty = *blanks
     c                   if        w_dbkr = 'K'
     c                   eval      sdanta = 0 - 1
     c                   eval      sdsalg = 0 - fgbelp
     c                   eval      sdkost = 0 - fgbelp
     c                   eval      w6geby = w6geby - fgbelp
     c                   else
     c                   eval      sdanta = 1
     c                   eval      sdsalg = fgbelp
     c                   eval      sdkost = fgbelp
     c                   eval      w6geby = w6geby + fgbelp
     c                   endif
8.22 c                   else
8.22 c                   eval      w_gebl = '1'
8.22 c                   if        w_fgeb = 'K'
8.22 c                   eval      sdanta = 0 - 1
8.22 c                   eval      sdsalg = 0 - fgbelp
8.22 c                   eval      sdkost = 0 - fgbelp
8.22 c                   eval      w6geby = w6geby - fgbelp
8.22 c                   else
8.22 c                   eval      sdanta = 1
8.22 c                   eval      sdsalg = fgbelp
8.22 c                   eval      sdkost = fgbelp
8.22 c                   eval      w6geby = w6geby + fgbelp
8.22 c                   endif
8.22 c                   endif
6.17  *
6.17  * Tester om ordre eller varenummer for fakturagebyr er mvafri
6.17  *
6.38 c*                  if        fomkod = 1 or
6.38 c*                            vvkmva = 1
6.38 c*                  eval      sdomva = '4'
6.38 c*                  else
6.38 c*                  eval      sdomva = '3'
6.38 c*                  endif
6.38  *
6.38  * Ny test på mva
6.38  *
6.38 c                   eval      vmval1_mkod = vvkmva
6.38 c     vmval1_key    chain     vmval1
6.38 c                   if        %found
6.38 c                   eval      sdomva = vamkof
6.38 c                   if        fomkod = 2 and
6.38 c                             vamkuo <> *blank
6.38 c                   eval      sdomva = vamkuo
6.38 c                   endif
6.38 c                   else
6.38 c                   select
6.38 c                   when      vvkmva = 1
6.38 c                   eval      sdomva = '4'
6.38 c                   when      vvkmva = 2
6.38 c                   eval      sdomva = 'H'
6.38 c                   endsl
6.38 c                   endif
6.23  *
6.23  * Finner den kontoen som skal benyttes
6.23  *
6.23 c                   exsr      x_konto
6.38 c                   eval      t_mkod = sdomva
6.23 c                   eval      t_avde = d_kav1
6.23 c                   eval      t_kont = d_kko1
6.23 c                   eval      t_spes = d_ksp1
6.23  *
6.23 c                   if        fomkod <> 0
6.38 c                   eval      t_mkod = sdomva
6.23 c                   eval      t_avde = d_kav2
6.23 c                   eval      t_kont = d_kko2
6.23 c                   eval      t_spes = d_ksp2
6.23 c                   endif
6.23  *
6.23 c                   eval      sdavde = t_avde
6.23 c                   eval      sdkont = t_kont
6.23 c                   eval      sdspes = t_spes
      *
     c                   if        %found(sodtlu)
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   update    sodtlur
     c                   else
     c                   eval      sdfirm = w_firm
     c                   eval      sdaarr = sodtlu_aarr
     c                   eval      sdbinr = sodtlu_binr
     c                   eval      sdnumm = sodtlu_numm
     c                   eval      sdsuff = sodtlu_suff
     c                   eval      sdktxt = sodtlu_ktxt
     c                   eval      sdline = sodtlu_line
6.10 c                   time                    sdodat
6.10 c                   time                    sdotim
6.10 c                   eval      sdousr = l_user
6.10 c                   time                    sdedat
6.10 c                   time                    sdetim
6.10 c                   eval      sdeusr = l_user
     c                   write     sodtlur
     c                   endif
6.23  *
6.23  * Finner den kontoen som skal benyttes
6.23  *
6.23 c*                  exsr      x_konto
6.23 c*                  eval      t_mkod = '3'
6.23 c*                  eval      t_avde = d_kav1
6.23 c*                  eval      t_kont = d_kko1
6.23 c*                  eval      t_spes = d_ksp1
6.23  *
6.23 c*                  if        fomkod <> 0
6.23 c*                  eval      t_mkod = '4'
6.23 c*                  eval      t_avde = d_kav2
6.23 c*                  eval      t_kont = d_kko2
6.23 c*                  eval      t_spes = d_ksp2
6.23 c*                  endif
      *
      * Legger på plass beløps-felter
      *
     c                   eval      fdsums = fgbelp
     c                   eval      fdanta = 1
     c                   eval      vvspny = fgbelp
     c                   eval      vvspga = fgbelp
     c                   eval      fdsapr = fgbelp
     c                   eval      fdkopr = fgbelp
8.04 c                   eval      fdoppr = fgbelp
     c                   eval      fdrab1 = 0
     c                   eval      fdrab2 = 0
     c                   eval      forabp = 0
8.04 c                   eval      fdeann = 0
8.04 c                   eval      fdalme = 0
8.04 c                   eval      fdbrty = 0
8.04 c                   eval      fdbrr1 = 0
8.04 c                   eval      fdbrr2 = 0
8.16 c                   eval      fdinpr = 0
8.16 c                   eval      fdsumr = 0
3.36  *
3.36  * Legger på plass øvrige felter
3.36  *
3.36 c                   eval      fdlety = folety
3.36 c                   eval      fdvare = fgvare
3.36 c                   eval      fdtek1 = fgtext
3.36 c                   eval      fdkamp = *blank
3.36 c                   eval      fdenh1 = vvenhs
5.46  *
5.46  * Tester om ordre eller varenummer for fakturagebyr er mvafri
5.46  *
6.38 c*                  if        fomkod = 1 or
6.38 c*                            vvkmva = 1
6.38 c*                  eval      fdomva = '4'
6.38 c*                  else
6.38 c*                  eval      fdomva = '3'
6.38 c*                  endif
6.38 c                   eval      fdomva = sdomva
      *
      * Subrutine for oppdatering
      * av økonomi og statistikk
      *
7.07 c                   eval      b_type = *off
     c                   exsr      x_bereg
3.36  *
3.36  *  Oppdatering av statistikk native (ASSTAT)
3.36  *
3.36 c                   if        vaosta = 1
3.36 c                   if        valsta = 1
3.36 c                   exsr      x_stat
3.36 c                   endif
3.36 c                   endif
      *
8.22 c                   eval      w_gebl = *blanks
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for blanking felter i vareregister
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_bvare       begsr
      *
6.2h c                   eval      b_lvrva = *on
6.2h c                   clear                   vvarl1r
5.70 c                   eval      p_vtyp = *blank
     c                   eval      vvspny = 0
     c                   eval      vvspga = 0
6.3a c                   eval      vvkmva = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Utlegging av informasjon til konto
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_okon        begsr
      *
      * Hent bilagstekst
      *
     c                   call      'RS701R'
     c                   parm                    w_retk
     c                   parm                    t_bilk
     c                   parm                    w_atxt
     c                   eval      t_text = w_atxt
      *
6.27 c*->                if        w_valg = 5
6.27 c*-> Sperret        eval      t_text = 'ALMENNINGSRABATT'
6.27 c*->                endif
      *
6.3c c                   if        fdanta > 9999999
6.3c c                   eval(h)   t_mngd = 9999999
6.3c c                   else
3.12 c                   eval(h)   t_mngd = fdanta
6.3c c                   endif
      *
      * Legger ut transaksjon til ØKONOMI-SYSTEMET
      *
4.01 c                   eval      fffirm = fksfir
4.01 c                   eval      ffperi = t_peri
4.01 c                   eval      ffbunt = t_bunt
4.01 c                   eval      ffbiln = t_biln
5.22 c                   eval      ffbill = t_bill
4.01 c                   eval      ffbdat = *loval
4.01 c                   eval      fffdat = *loval
4.01 c                   eval      ffbilk = t_bilk
4.01 c                   eval      fftext = t_text
4.01 c                   eval      ffdavd = 0
4.01 c                   eval      ffdkto = 0
4.01 c                   eval      ffdsps = 0
4.01 c                   eval      ffdmom = ' '
4.01 c                   eval      ffbelp = t_belp
4.01 c                   eval      ffcavd = 0
4.01 c                   eval      ffckto = 0
4.01 c                   eval      ffcsps = 0
4.01 c                   eval      ffcmom = ' '
4.01 c                   eval      ffproj = t_proj
6.20 c                   eval      ffupro = t_upro
4.01 c                   eval      ffakti = t_akti
4.01 c                   eval      ffkref = t_kref
4.01 c                   eval      ffkund = fokund
4.01 c                   eval      ffvalk = *blank
4.01 c                   eval      ffvalb = 0
4.01 c                   eval      ffmngk = 0
4.01 c                   eval      ffautx = t_autx
4.01  *
4.01  * Legger inn riktig
4.01  * kontobegrep
4.01  *
4.01 c                   if        t_belp > 0
4.01 c                   eval      ffcavd = t_avde
4.01 c                   eval      ffckto = t_kont
4.01 c                   eval      ffcsps = t_spes
4.01 c                   eval      ffcmom = t_mkod
5.34 c                   eval      ffmvag = t_mvag
6.15 c                   if        ffcmom = '4' or
6.15 c                             ffcmom = '0' or
6.15 c                             ffcmom = ' '
5.44 c                   eval      ffmvag = 0
5.44 c                   endif
5.34 c                   eval      ffmngd = t_mngd
4.01 c                   else
4.01 c                   eval      ffdavd = t_avde
4.01 c                   eval      ffdkto = t_kont
4.01 c                   eval      ffdsps = t_spes
4.01 c                   eval      ffdmom = t_mkod
4.01 c                   eval      t_belp = t_belp * -1
4.01 c                   eval      ffbelp = ffbelp * -1
5.34 c                   eval      ffmvag = t_mvag * -1
6.15 c                   if        ffdmom = '4' or
6.15 c                             ffdmom = '0' or
6.15 c                             ffdmom = ' '
5.44 c                   eval      ffmvag = 0
5.44 c                   endif
5.34 c                   eval      ffmngd = t_mngd * -1
4.01 c                   endif
4.01  *
4.01  * Legger inn dato
4.01  * og forfallsdato
4.01  *
4.01 c                   if        t_bdat <> 0
4.01 c     *dmy          move      t_bdat        ffbdat
4.01 c                   endif
4.01  *
4.01 c                   if        t_fdat <> 0
4.01 c     *dmy          move      t_fdat        fffdat
4.01 c                   endif
4.01  *
7.03  *
7.03  * Timestamp for logging
7.03  *
7.03 c                   eval      fflogg = w_logg
4.01 c                   write     fovfpfr
7.03  *
7.03  *  Skriv til loggfil
7.03  *
7.03 c                   exsr      logg_linjer
      *
      * Nullstiller totaler etter oppdatering
      *
     c                   eval      t_avde = 0
     c                   eval      t_kont = 0
     c                   eval      t_spes = 0
3.34 c***                eval      t_mkod = '0'
     c                   eval      t_belp = 0
     c                   eval      t_kref = 0
6.25 c**                 eval      t_proj = 0
6.25 c                   eval      t_proj = *blank
6.25 c                   eval      t_upro = *blank
     c                   eval      t_akti = *blank
     c                   eval      t_autx = *blank
3.12 c                   eval      t_mngd = 0
5.30 c                   eval      t_mvag = 0
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter avdeling/konto/spesifikasjon
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_konto       begsr
      *
      * Legger ut parametere for konto-henvisnings-program
      *
     c                   eval      w_retk = *blank
     c                   eval      w_ogrp = vvogrp
     c                   eval      w_hgrp = vvhgrp
     c                   eval      w_ugrp = vvugrp
     c                   eval      w_vare = vvvare
     c                   move      '0'           w_hele
3.10  *
3.10  * Dersom grunnlag for konto er varelinje,
3.10  * skal varegruppe hentes fra linjenivå
3.10  *
3.10 c                   if        w_vlin = 'J' and
6.2h c                             fdlvre = 1 and b_lvrva = *on
3.10 c                   eval      w_ogrp = fdogrp
3.10 c                   eval      w_hgrp = fdhgrp
3.10 c                   eval      w_ugrp = fdugrp
3.10 c                   eval      w_vare = fdvare
     c                   move      '0'           w_hele
3.10 c                   endif
5.20  *
5.20  * Legger inn leveringstype fra varelinje,
5.20  *
5.20 c                   eval      w_lety = fdlety
      *
      * Kaller program for å finne konto
      *
     c                   call      'VA720R'
     c                   parm                    w_retk
5.20 c                   parm                    w_lety
     c                   parm                    w_otyp
     c                   parm                    w_ogrp
     c                   parm                    w_hgrp
     c                   parm                    w_ugrp
     c                   parm                    w_vare
     c                   parm                    w_hele
     c                   eval      d_hele = w_hele
      *
      * Overstyrer avdeling dersom denne
      * finnes på ordrehode
      *
     c                   if        foavde > 0
     c                   eval      d_kav1 = foavde
     c                   eval      d_kav2 = foavde
     c                   eval      d_kav3 = foavde
     c                   eval      d_kav4 = foavde
     c                   eval      d_kav5 = foavde
     c                   eval      d_kav6 = foavde
     c                   eval      d_kav7 = foavde
     c                   endif
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Oppdatere ny native statistikk (ASSTAT)
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_stat        begsr
6.39  *
6.39  * ikke oppdater varenr for gavekort i statistikk
6.39  *
6.39 c                   if        baagva <> *blank and
6.39 c                             fdvare <> *blank and
6.39 c                             fdvare = baagva
6.39 c                   leavesr
6.39 c                   endif
      *
5.05  * Oppdater linjenummer
5.05  *
5.05 c                   eval      w_line = w_line + 1
6.34  *
6.34  * Henter utvidet statistikk-data
6.34  *
6.34 c                   if        b_bmmo = *on
6.34 c                   exsr      utvid_stat
6.34 c                   endif
8.08  *
8.08  * Henter gj.sn. kostpris på utleveringstidspunkt
8.08  *
8.08 c                   exsr      hent_gjkost
      *
      * Flytt over felter
      *
     c                   clear                   sstapfr
     c                   eval      sffirm = w_firm
     c                   eval      sfpaar = sodtlu_aarr
     c                   move      l_peri        sfpmnd
      *
     c                   eval      sfvkun = folkun
     c                   eval      sffkun = fokund
     c                   if        folkun = 0
     c                   eval      sfvkun = fokund
     c                   endif
      *
     c                   eval      sfkpro = fokpro
     c                   eval      sfkkat = rkkatg
     c                   eval      sfrkat = forkat
     c                   eval      sfselg = foselg
     c                   eval      sfland = 0
     c                   eval      sfdist = fodist
     c                   eval      sffrik = rkfrie
3.11 c                   eval      sflety = fdlety
6.2d c                   eval      sflvre = fdlvre
     c                   eval      sfvare = fdvare
     c                   movel     fdtek1        sftek1
      *
6.3b c                   if        fdvare = fgvare
6.3b c                   move      *blanks       sftek2
6.3b c                   else
6.3b c                   movel     fdtek2        sftek2
6.3b c                   endif
      *
     c                   eval      sfogrp = vvogrp
     c                   eval      sfhgrp = vvhgrp
     c                   eval      sfugrp = vvugrp
     c                   eval      sfrgrp = 0
6.3f c*                  eval      sfkpri = vvkpri
6.3f c                   eval      sfkpri = fdkpri
5.70  *
5.70  * Kaller program for henting av prisgruppe
5.70  *
5.70 c                   call      'VL710R'
5.70 c                   parm                    w_firm
5.70 c                   parm                    vvvare
5.70 c                   parm                    folage
5.70 c                   parm                    p_vtyp
6.28 c                   parm                    w_udat
6.28 c                   parm                    w_ldor
6.28 c                   parm                    b_inlr
6.3e c                   parm                    w_lv_nobb
6.3e c                   parm                    w_lv_modn
6.3e c                   parm                    w_lv_lldo
6.3e c                   parm                    w_lv_llva
5.70  *
5.70 c                   eval      sfvtyp = p_vtyp
6.3f0c                   eval      sfldor = 0
6.3f0c                   eval      w_ldorb = 0
6.3f0c                   if        fdbenr <> 0
6.3f0c                   exsr      sjekk_best
6.3f0c                   endif
6.3f0c                   if        w_ldorb <> 0
6.3f0c                   eval      sfldor = w_ldorb
6.3f0c                   else
6.3f0c                   if        vvldor <> 0
6.3f0c                   eval      sfldor = vvldor
6.3f0c                   endif
6.3f0c                   endif
6.3f0 *
6.3e c                   if        w_lv_nobb > 0
6.3e c                   eval      sflvar = w_lv_llva
6.3e c                   eval      sfnobb = w_lv_nobb
6.3e c                   eval      sfmodn = w_lv_modn
6.3e c                   else
     c                   eval      sflvar = vvlvar
     c                   eval      sfnobb = vvnobb
     c                   eval      sfmodn = vvnmod
6.3e c                   endif
     c                   eval      sfahgr = vvahgr
     c                   eval      sfaugr = vvaugr
     c                   eval      sfkamp = fdkamp
5.32 c                   eval      sflage = fdlage
     c                   eval      sfbinr = sodtlu_binr
5.05 c                   eval      sfline = w_line
     c                   eval      sfbida = fofkda
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      sfotyp = w_koty
8.18 c                   else
     c                   eval      sfotyp = footyp
8.18 c                   endif
     c                   eval      sfornr = fonumm
7.07 c                   eval      sforsu = fosuff
     c                   eval      sforli = fdline
     c                   eval      sforda = fobdat
5.39 c                   eval      sfbong = *blank
7.07 c**                 eval      sfsavd = sdavde
7.07 c                   eval      sfsavd = foavde
     c                   eval      sfskon = sdkont
     c                   eval      sfssps = sdspes
     c                   eval      sfanto = fdanta
     c                   eval      sfanta = w_anta
5.63 c                   eval      sfakm3 = w_akm3
5.63 c                   eval      sfnom3 = w_nom3
     c                   eval      sffakr = *blank
     c                   eval      sfsumo = w_belo
     c                   eval      sfsumb = w_belb
     c                   eval      sfsumk = w_kost
     c                   eval      sfrab1 = w_rkr1
     c                   eval      sfrab2 = w_rkr2
     c                   eval      sfrabo = w_rkro
     c                   eval      sfkmva = fomkod
     c                   eval      sfkres = 0
     c                   eval      sfenhe = vvenhs
     c                   eval      sfenho = fdenh1
5.01 c                   eval      sfnref = fonref
5.21 c                   eval      sffsys = fofsys
5.02 c                   eval      sfbenr = fdbenr
5.02 c                   eval      sfbsuf = fdbsuf
6.2f c                   eval      sfblin = fdblin
5.03 c                   eval      sflmat = folmat
5.31 c                   eval      sfalme = fdalme
5.31 c                   eval      sfbrty = fdbrty
5.31 c                   eval      sfpriv = fdpriv
5.31 c                   eval      sfomva = fdomva
5.31 c                   eval      sfbrk1 = w_brk1
5.31 c                   eval      sfbrk2 = w_brk2
5.31 c                   eval      sfuser = fouser
     c                   eval      sfwsid = fowsid
5.64 c                   eval      sfkhev = d_khnv
5.65 c                   eval      sfeann = fdeann
5.70 c                   eval      sfprgr = fdprgr
5.70 c                   eval      sfoprg = fdoprg
6.31 c                   eval      sfproj = foproj
6.31 c                   eval      sfakti = foakti
7.fb  *
7.fb  * legger på fordelt redusert salg
7.fb  *
7.fb c                   if        w_fosa <> 0 and
7.fb c                             fdsums <> 0 and
7.fb c                             w_sums <> 0
7.fb c                   eval(h)   sffosa = w_fosa * fdsums/w_sums
7.fb c                   eval(h)   sffosi = w_fosi * fdsums/w_sums
7.fb c                   endif
6.34  *
6.34  * utvidet statistikk
6.34  *
6.34 c                   if        b_bmmo = *on
6.34 c                   eval      sfpkon = w_pkon
6.34 c                   eval      sfpkns = w_pkns
6.34 c                   eval      sfpkko = w_pkko
6.34 c                   eval      sfpkok = w_pkok
6.34 c                   eval      sfpkoi = w_pkoi
6.34 c                   eval      sfpkoi = w_pkoi
6.34 c                   eval      sfkofa = w_kofa
6.34 c                   eval      sfcard = w_card
6.34 c                   eval      sffcar = w_fcar
6.34 c                   eval      sfkild = w_kild
6.34 c                   eval      sfsuno = w_suno
6.34 c                   eval      sfsuok = w_suok
6.34 c                   eval      sfsumn = w_sumn
6.3g c                   eval      sfsumm = w_moms
6.34 c                   eval      sfsumi = w_sumi
6.34 c                   eval      sfsuoi = w_suoi
6.34 c                   eval      sfsoda = w_soda
6.34 c                   eval      sfsoti = w_soti
6.34 c                   endif
3.10  *
3.10  * Overstyring av felter, dersom varelinjen
3.10  * er en vare hentet fra LVR
3.10  *
3.10 c                   if        w_vlin = 'J' and
6.2h c                             fdlvre = 1 and b_lvrva = *on
3.10 c                   eval      sfogrp = fdogrp
3.10 c                   eval      sfhgrp = fdhgrp
3.10 c                   eval      sfugrp = fdugrp
3.10 c                   eval      sflvar = fdlvar
3.10 c                   eval      sfkpri = fdkpri
3.10 c                   eval      sfvtyp = 'S'
6.3f0c***                eval      sfldor = fdldor
5.37 c                   eval      sfnobb = fdnobb
3.10 c***                eval      sfmodn = 0
3.10 c                   eval      sfenhe = fdenh1
3.10 c                   eval      sfenho = fdenh1
3.10 c                   endif
5.24  *
5.24  * Finner alternativ varegruppe
5.24  *
5.24 c                   if        b_xeof = *on and
5.24 c                             sfahgr = 0
5.24 c                   exsr      x_altvgr
5.24 c                   endif
5.39  *
5.39  * Henter inn produktansvarlig
5.39  *
5.39 c                   call      'VG710R'
5.39 c                   parm                    w_firm
5.39 c                   parm                    sfogrp
5.39 c                   parm                    sfhgrp
5.39 c                   parm                    sfugrp
5.39 c                   parm                    w_pran
5.39  *
5.39 c                   eval      sfpran = w_pran
5.43  *
6.29  * Oppdaterer leveringsdato, pakkseddelsdato  og uke
5.43  *
6.29 c                   if        fdldat <> *loval
6.29 c                   eval      sfldat =fdldat
6.29 c                   else
5.43 c                   eval      sfldat =foldat
6.29 c                   endif
6.29 c                   eval      sfpada =fopada
5.43  *
5.43 c                   if        sfldat <> *loval
5.43 c                   eval      w_dato = sfldat
5.43 c                   else
5.43 c                   eval      w_dato = sfbida
5.43 c                   endif
5.43  *
5.43 c                   call      'AX711R'
5.43 c                   parm                    w_dato
5.43 c                   parm                    w_saar
5.43 c                   parm                    w_suke
5.43 c                   parm                    w_stat
5.43  *
5.43 c                   if        w_suke > 52
5.43 c                   eval      w_suke = 52
5.43 c                   endif
5.47 c                   eval      sfpuke = w_suke
      *
     c                   time                    sfdate
     c                   time                    sftime
6.10 c                   eval      sfuser = l_user
8.08 c                   eval      sfgjkp = w_gjkp
      *
     c                   write     sstapfr
8.13  *
8.13 c                   if        u_813 = *on
8.13        exec sql
8.13        insert into sovkst
8.13          (sovfir,sovtyp,sovaar,sovbil,
8.13           sovbli,sovopd)
8.13        values(:sffirm,'FAKT',:sfpaar,:sfbinr,
8.13               :sfline,' ');
8.13 c                   endif
     c
7.01 c*                   exsr      x_stat_side
      *
     csr                 endsr
7.01  *
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.01  * Oppdatere ny native statistikk side (ASSTAT)
7.01  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.01  *
7.01 csr   x_stat_side   begsr
7.01 c
7.01 c
7.01 c                   clear                   sst3pfr
7.01 c
7.01 c     fod2lu_key    chain     fod2lur
7.01 c                   if        %found(fod2lu)
7.01 c
7.01 c                   eval      s3firm = sffirm
7.01 c                   eval      s3paar = sfpaar
7.01 c                   eval      s3binr = sfbinr
7.01 c                   eval      s3ornr = sfornr
7.01 c                   eval      s3orsu = sforsu
7.01 c                   eval      s3orli = sforli
7.01 c                   eval      s3bong = sfbong
7.01 c                   eval      s3vare = sfvare
7.01 c                   eval      s3enhe = sfenhe
7.01 c                   eval      s3anta = sfanta
7.01 c                   eval      s3date = sfdate
7.01 c                   eval      s3time = sftime
7.01 c                   eval      s32sat = fd2sat
7.01 c                   eval      s32kod = fd2kod
7.01 c                   eval      s32rtx = fd2rtx
7.01 c                   eval      s32ors = fd2ors
7.01 c                   eval      s32ber = fd2ber
7.01 c                   eval      s3edat = sfdate
7.01 c                   eval      s3etim = sftime
7.01 c                   eval      s3eusr = sfuser
7.01 c                   eval      s3odat = sfdate
7.01 c                   eval      s3otim = sftime
7.01 c                   eval      s3ousr = sfuser
7.01 c
7.01 c                   write     sst3pfr
7.01 c                   endif
7.01 c
7.01 csr                 endsr
5.24  *
5.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.24  * Subrutine som finner alternativ varegruppe
5.24  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.24  *
5.24 csr   x_altvgr      begsr
5.24  *
5.24  * Leser på varegruppeknytning
5.24  * Leter først etter knytninger mot leverandør
5.24  *
5.24 c                   eval      vvgkl1_ogrp = sfogrp
5.24 c                   eval      vvgkl1_hgrp = sfhgrp
5.24 c                   eval      vvgkl1_ugrp = sfugrp
5.24 c                   eval      vvgkl1_ldor = sfldor
5.24  *
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   if        not %found
5.24 c                   eval      vvgkl1_ldor = 0
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   if        not %found
5.24 c                   eval      vvgkl1_ldor = sfldor
5.24 c                   eval      vvgkl1_ugrp = 0
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   if        not %found
5.24 c                   eval      vvgkl1_ldor = 0
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   if        not %found
5.24 c                   eval      vvgkl1_ldor = sfldor
5.24 c                   eval      vvgkl1_hgrp = 0
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   if        not %found
5.24 c                   eval      vvgkl1_ldor = 0
5.24 c     vvgkl1_key    chain     vvgkl1
5.24 c                   endif
5.24 c                   endif
5.24 c                   endif
5.24 c                   endif
5.24 c                   endif
5.24  *
5.24 c                   if        %found
5.24 c                   eval      sfahgr = vkahgr
5.24 c                   eval      sfaugr = vkaugr
5.24 c                   endif
5.24  *
5.24 csr                 endsr
cc 4  *
6.34  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.34  * Henter utvidet statstikk-data
6.34  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.34  *
6.34 csr   utvid_stat    begsr
6.34  *
6.34 c                   eval      w_pkon = *blank
6.34 c                   eval      w_pkns = *blank
6.34 c                   eval      w_pkko = *blank
6.34 c                   eval      w_pkok = *blank
6.34 c                   eval      w_pkin = *blank
6.34 c                   eval      w_pkoi = *blank
6.34 c                   eval      w_kofa = *blank
6.34 c                   eval      w_card = *blank
6.34 c                   eval      w_fcar = *blank
6.34 c                   eval      w_kild = *blank
6.34 c                   eval      w_sumn = 0
6.34 c                   eval      w_sumi = 0
6.34 c                   eval      w_suoi = 0
6.34 c                   eval      w_sumo = 0
6.34 c                   eval      w_suno = 0
6.34 c                   eval      w_suok = 0
6.34 c                   eval      w_suoi = 0
6.34 c                   eval      w_ntpr = 0
6.34 c                   eval      w_rkro_stk = 0
6.34  *
6.34 c                   eval      hifirm = w_firm
6.34 c                   eval      hirkat = 0
6.34  *
6.34 c                   eval      hikund = fokund
6.34 c                   if        folkun <> 0
6.34 c                   eval      hikund = folkun
6.34 c                   endif
6.34  *
6.34 c                   eval      hikpro = fokpro
6.34 c                   eval      hivare = fdvare
6.34 c                   eval      hienhe = fdenh1
6.34 c                   eval      hilety = fdlety
6.34 c                   eval      hidekn = fdpasl
6.34 c                   eval      hiavgf = fomkod
6.34 c                   eval      hipriv = 0
6.34 c                   eval      hidato = fobdat
6.34 c                   if        fobdat = fodate
6.34 c                   eval      hitime = fotime
6.34 c                   else
6.34 c                   eval      hitime = *loval
6.34 c                   endif
6.34 c                   eval      w_soda = fodate
6.34 c                   eval      w_soti = fotime
6.34 c                   eval      hinumm = 0
6.34 c                   eval      hikode = fopask
6.34 c                   if        fdlvre = 1
6.34 c                   eval      hiskaf = *on
6.34 c                   else
6.34 c                   eval      hiskaf = *off
6.34 c                   endif
6.34 c                   eval      hildor = fdldor
6.34 c                   eval      hisapr = 0
6.34 c                   eval      hikopr = 0
6.34 c                   eval      hiinpr = fdinpr
6.34 c                   eval      hidekn = fdpasl
6.35ac                   eval      hiinlr = *on
6.34  *
6.34 c                   call      'VP905R'
6.34 c                   parm                    hirec
6.34 c                   parm                    horec
6.34  *
6.34  * Koder fra VP905
6.34  *
6.34 c                   eval      w_pkon = hopkon
6.34 c                   eval      w_pkns = hopkns
6.34 c                   eval      w_pkko = hopkko
6.34 c                   eval      w_pkok = hopkok
6.34 c                   eval      w_pkoi = hopkoi
6.34  *
6.34  * Sum opprinnelig netto salgspris (SFSUNO)
6.34  *
6.34 c                   if        fdlvre = 1
6.34 c                   eval      w_ntpr = w_bels
6.34 c                   else
6.34 c                   eval      w_ntpr = hosapr
6.34 c                   endif
6.34  *
6.34 c                   if        horab1 > 0
6.34 c                   eval(h)   w_ntpr = w_ntpr - (w_ntpr * horab1 / 100)
6.34 c                   endif
6.34 c                   if        horab2 > 0
6.34 c                   eval(h)   w_ntpr = w_ntpr - (w_ntpr * horab2 / 100)
6.34 c                   endif
6.34  *
6.34  * Varelinjens andel av ordrerabatt (pr. stk)
6.34  *
6.34 c                   if        vvkord = 0 and
6.34 c                             forabp <> 0
6.34 c                   eval(h)   w_rkro_stk = (w_ntpr * forabp) / 100
6.34 c                   endif
6.34  * trekker fra ordrerabatt
6.34 c                   eval      w_ntpr = w_ntpr - w_rkro_stk
6.34  * sjekker at oppr.pris ikke blir for høy
6.34 c                   eval      w_oppr = w_ntpr * fdanta
6.34 c                   if        w_oppr > 999999999
6.34 c                   eval(h)   w_suno = 999999999
6.34 c                   else
6.34 c                   eval(h)   w_suno = w_ntpr * fdanta
6.34 c                   endif
6.34  *
6.34  * Sum netto salg salgspris (SFSUMN)
6.34  *
6.3g c                   if        w_dbkr = 'K'
6.3g c                   eval(h)   w_sumn = fdsums + fdsumr
6.3g c                   elseif    valkre = '-'
6.3g c                   eval(h)   w_sumn = fdsums + fdsumr
6.3g c                   else
6.34 c                   eval(h)   w_sumn = fdsums - fdsumr
6.3g c                   endif
6.34  *
6.34  * Priskode netto salgspris  (SFPKNS)
6.34  *
7.04 c                   if        fdkpri <> 'A' and
7.04 c                             fdkpri <> 'T'
6.34 c                   if        w_sumn <> 0
6.34 c                   eval      w_diff  = %abs(w_suno - w_sumn)
6.34 c                   if        w_diff > 1
6.34 c                   eval      w_pkns  = 'MAN'
6.34 c                   endif
6.34 c                   endif
7.04 c                   endif
6.34  *
6.34  * Sum  kostpris (SFSUMK)
6.34  *
6.3c  * sjekker at beløp ikke blir for høyt
6.3c c                   eval      w_oppr = fdkopr * fdanta
6.3c c                   if        w_oppr > 999999999
6.3c c                   eval(h)   w_sumk = 999999999
6.3c c                   else
6.3c c                   eval      w_sumk = fdkopr * fdanta
6.3c c                   endif
6.3c c*                  eval      w_sumk = fdkopr * fdanta
6.34  *
6.34  * Sum opprinnelig kostpris (SFSUOK)
6.34  *
6.3c c                   eval      w_oppr = hokopr * fdanta
6.3c c                   if        w_oppr > 999999999
6.3c c                   eval(h)   w_suok = 999999999
6.3c c                   else
6.3c c                   eval      w_suok = hokopr * fdanta
6.3c c                   endif
6.3c c*                  eval      w_suok = hokopr * fdanta
6.34  *
6.34  * Priskode netto kostpris  (SFPKKO)
6.34  *
7.04 c                   if        fdkpri <> 'A' and
7.04 c                             fdkpri <> 'T'
6.34 c                   if        w_suok <> 0
6.34 c                   eval      w_diff  = %abs(w_sumk - w_suok)
6.34 c                   if        w_diff > 1
6.34 c                   eval      w_pkko  = 'MAN'
6.34 c                   endif
6.34 c                   endif
7.04 c                   endif
6.34  *
6.34  * Sum  innkjøps (SFSUMI)
6.34  *
6.3c  * sjekker at beløp ikke blir for høyt
6.3c c                   eval      w_oppr = fdinpr * fdanta
6.3c c                   if        w_oppr > 999999999
6.3c c                   eval(h)   w_sumi = 999999999
6.3c c                   else
6.3c c                   eval      w_sumi = fdinpr * fdanta
6.3c c                   endif
6.3c c*                  eval      w_sumi = fdinpr * fdanta
6.34  *
6.34  * Sum  opprinnelig innkjøps (SFSUOI)
6.34  *
6.3c  * sjekker at beløp ikke blir for høyt
6.3c c                   eval      w_oppr = hoinpr * fdanta
6.3c c                   if        w_oppr > 999999999
6.3c c                   eval(h)   w_suoi = 999999999
6.3c c                   else
6.3c c                   eval      w_suoi = hoinpr * fdanta
6.3c c                   endif
6.3c c*                  eval      w_suoi = hoinpr * fdanta
6.34  *
6.34  * Priskode netto kostpris  (SFPKIN)
6.34  *
6.34 c                   if        fdinpr <> 0  and
6.34 c                             hoinpr <> 0
6.34 c                   eval      w_diff  = %abs(w_sumi - w_suoi)
6.34 c                   if        w_diff > 1
6.34 c                   eval      w_pkin  = 'XXX'
6.34 c                   endif
6.34 c                   endif
6.34  *
6.34  *
6.34  * Kilde  (SFKILD)
6.34  *
6.34 c                   if        fofsys <> *blank
6.34 c                   eval      w_kild = fofsys
6.34 c                   else
6.34 c                   eval      w_kild = 'ORD'
6.34 c                   endif
6.37  *
6.37  * CARD   (SFCARD)
6.37  *
6.37  *
6.37 c                   if        fopsuf =  5
6.37 c                   eval      w_card = '05'
6.37 c                   endif
6.37 c                   if        fopsuf =  6
6.37 c                   eval      w_card = '06'
6.37 c                   endif
6.34  *
6.34  * Kontakt/fakturert (SFKOFA)
6.34  *
6.34 c                   if        footyp = 'CD' or
6.34 c                             footyp = 'CK'
6.34 c                   eval      w_kofa = 'K'
6.34 c                   else
6.34 c                   eval      w_kofa = 'F'
6.34 c                   endif
6.34  *
6.34  * Behandle diverse vare
6.34  *
6.34 c                   if        %found(vvarl1) and
6.34 c                             vvvtyp = 'D'
6.34 c                   eval      w_suno = 0
6.34 c                   eval      w_pkon = *blank
6.34 c                   eval      w_pkns = 'DIV'
6.34 c                   eval      w_suok = 0
6.34 c                   eval      w_pkok = *blank
6.34 c                   eval      w_pkko = 'DIV'
6.34 c                   endif
6.34  *
6.34 csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine som eksekveres når første record leses
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_fcycle      begsr
      *
     c                   eval      *in99 = *on
      *
      * Legger inn firmanummer i nøkklene
      *
     c                   eval      w_firm = fksfir
      *
      * Legger inn ordretype i nøkklene
      *
     c                   eval      votyl1_otyp = fksoty
8.18 c                   if        w_koty <> *blanks
8.18 c                   eval      fgebl1_otyp = w_koty
8.18 c                   eval      w_otyp = w_koty
8.18 c                   else
     c                   eval      fgebl1_otyp = fksoty
     c                   eval      w_otyp = fksoty
8.18 c                   endif
      *
      * Legger inn årstall i nøkklene
      *
     c                   movel     l_peri        w_aaar
      *
      * Beregner riktig Hundreår
      *
     c                   eval      sohelu_aarr = w_aaar
     c                   eval      sodtlu_aarr = w_aaar
      *
      * Hent opplysninger fra OFAK-STATUS-REGISTER
      *
     c     fstsl1_key    chain     fstsl1r
      *
6.39 c     bstsl1_key    chain     bstsl1r                            90
      *
      * Hent opplysninger fra KONTOHENVISNINGS-REGISTER
      *
     c                   eval      vkhvl1_kkod = faakhv
     c     vkhvl1_key    chain     vkhvl1
      *
      * Hent opplysninger fra ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    chain     votyl1r
      *
      * Snur periode før oppdatering av regnskap
      *
     c                   move      l_peri        w_peri
      *
     c                   movel     w_peri        w_eaar
     c                   move      w_peri        w_emnd
     c                   move      w_eaar        t_peri
     c                   movel     w_emnd        t_peri
5.24  *
5.24  * Sjekker om det finnes poster i
5.24  * knytningsregister for alternativ varegruppe
5.24  *
5.24 c                   eval      vvgkl1_ogrp = 0
5.24 c                   eval      vvgkl1_hgrp = 0
5.24 c                   eval      vvgkl1_ugrp = 0
5.24 c                   eval      vvgkl1_ldor = 0
5.24  *
5.24 c     vvgkl1_key    setll     vvgkl1
5.24 c                   read      vvgkl1
5.24  *
5.24 c                   if        %eof
5.24 c                   eval      b_xeof = *off
5.24 c                   else
5.24 c                   eval      b_xeof = *on
5.24 c                   endif
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Henter/Oppdatering av NUMMER-REGISTER
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_hntnum      begsr
      *
     c                   eval      w_fast = *blank
5.38  *
5.38  * Hente inn eventuell overstyrt
5.38  * ordretype for nummerserie
5.38  *
5.38 c                   call      'VA752R'
5.38 c                   parm                    w_firm
5.38 c                   parm                    w_type
5.38 c                   parm                    w_onum
5.38  *
5.38 c                   if        w_onum <> *blank
5.38 c                   eval      w_type = w_onum
5.38 c                   endif
      *
      * Kaller opp subprogram for henting av nummer fra NUMMER-REGISTER
      *
     c                   call      'AS100R'
     c                   parm                    w_kode
     c                   parm                    w_firm
     c                   parm                    w_fell
     c                   parm                    w_type
     c                   parm                    w_fast
6.nu c                   parm                    w_numm
      *
     csr                 endsr
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for omregning av antall i forhold til statestikkenhet
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   x_omrant      begsr
      *
      * Dersom solgt enhet er lik stat.enhet beholdes antall
      *
     c                   if        fdenh1 = vvenhs
     c                   goto      end_omr
     c                   endif
      *
      * Initierer arbeidsvariable
      *
     c                   eval      w_omrs = 0
     c                   eval      w_omrl = 0
5.63 c                   eval      w_omrm = 0
5.63 c                   eval      w_akm3 = 0
5.63 c                   eval      w_nom3 = 0
      *
      * Finner omregningsfaktor volum for stat.enhet og for solgt enhet
      * Antall regnes om etter forholdet mellom disse
      *
     c                   eval      vvenl1_vare = fdvare
     c     vvenl1_key    setll     vvenl1
     c     vvenl1_key    reade     vvenl1                                 90
     c                   dow       *in90 = *off
      *
     c                   if        fdenh1 = veenhe
     c                   eval      w_omrs = veomre
     c                   endif
      *
     c                   if        vvenhs = veenhe
     c                   eval      w_omrl = veomre
     c                   endif
5.63  *
5.63 c                   if        veenhe = 'M3 '
5.63 c                   eval      w_omrm = veomre
5.63 c                   endif
5.63  *
     c     vvenl1_key    reade     vvenl1                                 90
     c                   enddo
      *
     c                   if        w_omrs = 0
     c                   eval      w_omrs = 1
     c                   endif
      *
     c                   if        w_omrl = 0
     c                   eval      w_omrl = 1
     c                   endif
5.63  *
5.63 c                   if        w_omrm = 0
5.63 c                   eval      w_omrm = 1
5.63 c                   endif
      *
     c                   eval(h)   w_anta = w_anta * w_omrs / w_omrl
5.63  *
5.63  * Omregn antall til aktuell m3
5.63  *
5.63 c                   eval(h)   w_akm3 = w_anta * w_omrl / w_omrm
5.63  *
5.63  * Omregner antall til nominell m3
5.63  *
5.63 c                   eval(h)   w_nom3 = w_akm3 * vvomrn
      *
     csr   end_omr       endsr
      *
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  * Subrutine for oppdat. av utg.fakt. logg
5.41  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
5.41  *
5.41 csr   x_faklog      begsr
5.41  *
5.41 c                   eval      fnuflu_aarr = sohelu_aarr
5.41 c                   eval      fnuflu_binr = sohelu_binr
5.41 c     fnuflu_key    chain     fnuflu
5.41 c                   if        not %found
5.41 c                   eval      fnufir = w_firm
5.41 c                   eval      fnuaar = sohelu_aarr
5.41 c                   eval      fnubin = sohelu_binr
5.49 c                   eval      fnufat = fofaty
5.41 c                   eval      fnukun = sokund
6.18 c                   eval      fnueaf = rkeanf
5.41 c                   time                    fnuoda
5.41 c                   time                    fnuoti
5.41 c                   eval      fnuwsi = l_wsid
5.41 c                   write     fnuflur
5.41 c                   endif
5.41  *
5.41 csr   end_flog      endsr
      *
6.19  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.19  * Sjekker at kortinformasjon finnes
6.19  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.19 c     sjk_kort      begsr
6.19  *
6.19 c                   eval      w_kont = *zero
6.19 c                   eval      w_akod = *zero
6.19  *
6.19 c                   eval      ruksl1_skty = fopsuf
6.19 c                   eval      ruksl1_slag = folage
6.19 c     ruksl1_key    chain     ruksl1
6.19 c                   if        %found
6.19 c                   eval      w_kont = ruskto
6.19 c                   eval      w_akod = rusbkd
6.2B c                   if        vaokre = '-'
6.2B c                   eval      w_akod = ruskkd
6.2B c                   endif
6.19  * Hvis ikke kortinformasjon finnes på kortnivå, sjekk på lager 00
6.19 c                   else
6.19 c                   eval      ruksl1_slag = *zero
6.19 c     ruksl1_key    chain     ruksl1
6.19 c                   if        %found
6.19 c                   eval      w_kont= ruskto
6.19 c                   eval      w_akod= rusbkd
6.2B c                   if        vaokre = '-'
6.2B c                   eval      w_akod = ruskkd
6.2B c                   endif
6.19 c                   endif
6.19 c                   endif
6.19  *
6.19 c                   if        w_kont > 0
6.19 c                   eval      b_kort = *on
6.19 c                   endif
6.19  *
6.19 c                   endsr
6.19  *
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20  * Sjekker at kortinformasjon finnes på kunde. Legger ut info på BOKK
6.20  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.20 c     opd_kort      begsr
6.20  *
6.20  * Les kortregister for kunde, og sjekk om det skal legges ut info.
6.20  *
6.20 c                   eval      rukrlr_kkun = sokund
6.20 c     rukrlr_key    setll     rukrlr
6.20 c     rukrlr_key    reade     rukrlr                                 90
6.20 c                   dow       *in90 = *off
6.20  * Kortet kan ikke være sperres
6.20 c                   if        rukspr <> 'J'
6.20  * Hent infomasjon om kortet, må sjekke om det er fordelskort eller kredit
6.20  *
6.20 c                   eval      rustyp = *blank
6.20 c                   eval      rushld = *blank
6.20 c                   eval      ruksl1_skty = ruktyp
6.20 c                   eval      ruksl1_slag = folage
6.20 c     ruksl1_key    chain     ruksl1
6.20 c                   if        not %found
6.20 c                   eval      ruksl1_slag = 0
6.20 c     ruksl1_key    chain     ruksl1
6.20 c                   if        not %found
6.20 c                   eval      rustyp = *blank
6.20 c                   eval      rushld = *blank
6.20 c                   endif
6.20 c                   endif
6.20  *
6.20  * Les på kortregister, og sjekk om kort skal legges ut.
6.20  *
6.20 c                   if        rustyp = 'F' or
6.20 c                             ruskty = fopsuf
6.20 c                   eval      bokkl4_ktyp = ruktyp
6.20 c                   eval      bokkl4_kund = sokund
6.20 c                   eval      bokkl4_binr = sobinr
6.20 c     bokkl4_key    chain     bokkl4r
6.20 c                   if        not %found
6.20 c                   clear                   bokkl4r
6.20 c                   eval      brfirm = w_firm
6.20 c                   eval      brktyp = ruktyp
6.20 c                   eval      brkund = sokund
6.20 c                   eval      brbinr = sobinr
6.20 c                   eval      brkort = rukknr
6.20 c                   eval      brstrk = rukstr
6.20 c                   time                    brodat
6.20 c                   time                    brotim
6.20 c                   time                    bredat
6.20 c                   time                    bretim
6.20 c                   eval      breusr = l_user
6.20 c                   write     bokkl4r
6.20 c                   endif
6.20 c                   endif
6.20  *
6.20 c                   endif
6.20 c     rukrlr_key    reade     rukrlr                                 90
6.20 c                   enddo
6.20  *
6.20 c                   endsr
6.2A  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2A  * Sjekker at kortinformasjon finnes på kunde.
6.2A  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.2A c     sjk_kunde     begsr
6.2A  *
6.2A  * Les kortregister for kunde, og sjekk om det skal legges ut info.
6.2A  *
6.2A c                   eval      rukrl5_kkun = sokund
6.2A c                   eval      rukrl5_kpro = 0
6.2A c                   eval      rukrl5_ktyp = fopsuf
6.2A c     rukrl5_key    chain     rukrl5
6.2A c                   if        %found
6.2A  * NB Må være fullmakt
6.2A c                   if        rukobl = 1
6.2A  * Hent infomasjon om kortet, sjekk oppfølgingmetode
6.2A c                   eval      b_kunde = *on
6.2A c                   eval      rustyp = *blank
6.2A c                   eval      rushld = *blank
6.2A c                   eval      ruksl1_skty = ruktyp
6.2A c                   eval      ruksl1_slag = folage
6.2A c     ruksl1_key    chain     ruksl1
6.2A c                   if        not %found
6.2A c                   eval      ruksl1_slag = 0
6.2A c     ruksl1_key    chain     ruksl1
6.2A c                   if        not %found
6.2A c                   eval      rusome = *blank
6.2A c                   endif
6.2A c                   endif
6.2A  *
6.2A c                   if        rusome = 'R'
6.2A c                   eval      b_opflg = *on
6.2A c                   endif
6.2A  *
6.2A c                   else
6.2A c                   eval      fopsuf = 0
6.2A c                   endif
6.2A c                   else
6.2A c                   eval      fopsuf = 0
6.2A c                   endif
6.2A  *
6.2A c                   endsr
6.2A  *
6.3f0 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3f0 * Subrutine for å finne leverandør på bestilling.
6.3f0 * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.3f0 *
6.3f0c     sjekk_best    begsr
6.3f0c                   eval      w_ldorb = 0
6.3f0c                   if        fdbenr <> 0
6.3f0 * sjekker først hist.fakt.
6.3f0c                   eval      w_aarr = %subdt(fobdat:*years)
6.3f0c/exec sql
6.3f0c+ select shldor  into :w_ldorb
6.3f0c+          from sihepf  where
6.3f0c+               shfirm = :fdfirm and
6.3f0c+               shnumm = :fdbenr and
6.3f0c+               shaarr = :w_aarr
6.3f0c+ fetch first 1 rows only
6.3f0c/end-exec
6.3f0c                   if        w_ldorb <> 0
6.3f0c                   leavesr
6.3f0c                   endif
6.3f0 *hvis ikke funnet  sjekk bestilling
6.3f0c/exec sql
6.3f0c+ select loldor  into :w_ldorb
6.3f0c+          from lohepf  where
6.3f0c+               lofirm = :fdfirm and
6.3f0c+               lonumm = :fdbenr
6.3f0c+ fetch first 1 rows only
6.3f0c/end-exec
6.3f0c                   endif
6.3f0c                   endsr
7.03  *
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Legger ut posteringstrans til loggfil linjer
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03  /Free
7.03   begsr logg_linjer;
7.03
7.03     w_lintel = w_lintel + 1;
8.09     w_dumd20 = 0;
7.03
7.03        exec sql
7.03        insert into rlodst
7.03          (rldfir,rldtyp,rldts1,rldlin,rldper,
7.03           rldbun,rldbin,rldbli,rldbda,rldfda,
7.03           rldbko,rldbtx,rlddav,rlddko,rlddsp,
7.03           rlddmv,rldbel,rldmvg,rldkav,rldkko,
7.03           rldksp,rldkmv,rldpro,rldpra,rldpru,
7.03           rldpao,rldkrf,rldres,rldlki,rldkki,
7.03           rldkkk,rldaki,rldvko,rldvbe,rldmko,
8.09           rldmen,rldsal,rldsfa,rldtty,rldbet,rldrem)
7.03        values(:fffirm,'FAKT',:w_logg,:w_lintel,
7.03               :ffperi,:ffbunt,:ffbiln,:ffbill,
7.03               :ffbdat,:fffdat,:ffbilk,:fftext,
7.03               :ffdavd,:ffdkto,:ffdsps,:ffdmom,
7.03               :ffbelp,:ffmvag,:ffcavd,:ffckto,
7.03               :ffcsps,:ffcmom,:ffproj,:ffakti,
7.03               :ffupro,:ffarbo,:ffkref,:ffkund,
7.03               :ffkidi,:ffkidr,:ffksif,:ffkid2,
7.03               :ffvalk,:ffvalb,:ffmngk,:ffmngd,
8.09               :ffautx,' ',' ',:w_dumd20,' ');
7.03
7.03   endsr;
7.03  /END-FREE
7.09  *
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.09  * Legger ut post til loggfil bilag
7.09  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.09  *
7.09  /FREE
7.09   begsr logg_bilag;
7.09
7.09     w_sumbel = 0;
7.09     w_dumtim = *loval;
7.09     w_dumsum = 0;
7.09     w_dumant = 0;
7.09     w_dumusr = '  ';
7.09     w_dumerr = '  ';
7.09
7.09        exec sql
7.09         insert into rlobst
7.09          (RLBFIR, RLBBIL, RLBTS1,RLBAN1,RLBSD1,RLBSK1,RLBBR1,
7.09           RLBTS2,RLBAN2,RLBSD2,RLBSK2,RLBBR2,RLBFF2,RLBFT2,
7.09           RLBTS3,RLBAN3,RLBSD3,RLBSK3,RLBBR3,RLBFF3,RLBFT3,
7.09           RLBTS4,RLBAN4,RLBSD4,RLBSK4,RLBBR4,RLBFF4,RLBFT4,
7.09           RLBTS5, RLBBR5, RLBTS6, RLBBR6)
7.09           select
7.09            fffirm, ffbiln, :w_logg, count(*) ,
7.09            sum(ffbelp)/2 ,sum(ffbelp)/2, :l_user,
7.09            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.09            :w_dumusr, ' ', ' ',
7.09            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.09            :w_dumusr, ' ', ' ',
7.09            :w_dumtim, :w_dumant, :w_dumsum, :w_dumsum,
7.09            :w_dumusr, ' ', ' ',
7.09            :w_dumtim, :w_dumusr, :w_dumtim, :w_dumusr
7.09          from FOVFPF
8.01          where fffirm = :w_firm and fflogg = :w_logg
7.09          group by fffirm,ffbiln
7.09          order by FFBILN ;
7.09   endsr;
7.03  *
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  * Legger ut post til loggfil hode
7.03  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.03  *
7.03  /FREE
7.03   begsr logg_hode;
7.03
7.03     w_sumbel = 0;
7.03     w_dumtim = *loval;
7.03     w_dumsum = 0;
7.03     w_dumusr = '  ';
7.03     w_dumerr = '  ';
7.03
8.14        exec sql
8.14          select sum(rlbsd1), sum(rlbsk1)
8.14            into :w_dsum, :w_ksum
8.14             from rlobst
8.14             where rlbts1 = :w_logg;
8.14
8.14        w_sumbel = (w_dsum + w_ksum) / 2;
8.14
7.03        if w_sumbel > 0;
7.03        exec sql
7.03        insert into rlohst
7.03          (rlhfir,rlhtyp,rlhts1,rlhbs1,rlhbr1,
7.03           rlhts2,rlhbs2,rlhbr2,rlhfl2,
7.03           rlhts3,rlhbs3,rlhbr3,rlhfl3,
7.03           rlhts4,rlhbs4,rlhbr4,rlhfl4,
7.03           rlhts5,rlhbr5,
7.03           rlhts6,rlhbr6)
7.03        values(:w_firm,'FAKT',:w_logg,:w_sumbel,:l_user,
7.03               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.03               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.03               :w_dumtim,:w_dumsum,:w_dumusr,:w_dumerr,
7.03               :w_dumtim,:w_dumusr,
7.03               :w_dumtim,:w_dumusr);
7.03
7.03        endif;
7.03   endsr;
7.03  /END-FREE
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb  * Beregner evt. endring av forhåndsbetalt
7.fb  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
7.fb c     finn_forh     begsr
7.fb  *
7.fb c                   eval      w_fosa = 0
7.fb c                   eval      w_fosi = 0
7.fb  * finner beløp forhåndsbetalt
7.fb c                   eval      sdepl1_numm = fonumm
7.fb c                   eval      sdepl1_kund = fokund
7.fb c                   eval      sdepl1_tell = 0
7.fb c     sdepl1_key    chain     sdepl1
7.fb c                   if        not %found(sdepl1)
7.fb c                   leavesr
7.fb c                   endif
8.06  *
8.06  * Kan være post fra NGN
8.06  *
8.06 c                   if        skdepo = 0 and
8.06 c                             skdepb = 0 and
8.06 c                             skdepp = 0 and
8.06 c                             skfosa = 0 and
8.06 c                             skfosi = 0
8.06 c                   leavesr
8.06 c                   endif
7.fb  *
7.fb  * Beregn ordretotal
7.fb c                   eval      w_sumif = 0
7.fb c                   eval      w_sumuf = 0
7.fb c                   eval      w_sumim = 0
7.fb c                   call      'FO704R '
7.fb c                   parm                    w_firm
7.fb c                   parm                    fonumm
7.fb c                   parm                    fosuff
7.fb c                   parm                    w_sumif
7.fb c                   parm                    w_sumuf
7.fb  *
8.17 c                   if        w_sumuf <> sktotu and
8.17 c                             sk100p = 1
7.fb c                   eval      w_fosa = w_sumuf - sktotu
7.fb c                   eval      w_fosi = w_sumif - skdepb
7.fb  *
7.fb c                   eval      w_sums = 0
7.fb c                   eval      fodtl1_numm = fonumm
7.fb c                   eval      fodtl1_suff = fosuff
7.fb c     fodtl1_key2   setll     fodtl1
7.fb c     fodtl1_key2   reade     fodtl1
7.fb c                   dow       not %eof(fodtl1)
7.fb c                   eval      w_sums = w_sums + fdsums
7 fb  * henter mvasats
7.fb c                   if        fdomva <> *blank
7.fb c                   eval      w_stat =  *blank
7.fb c                   eval      w_mvak =  fdomva
7.fb c                   eval      w_dato =  l_fkda
7.fb  *
7.fb c                   call      'RS205R'
7.fb c                   parm                    w_stat
7.fb c                   parm                    w_mvak
7.fb c                   parm                    w_mvtx
7.fb c                   parm                    w_dato
7.fb c                   parm                    w_mvap
7.fb c                   parm                    w_mvat
7.fb c                   parm                    w_mvaf
7.fb c                   parm                    w_bpro
7.fb c                   eval(h)   w_sumim = w_sumim + (fdsums * w_mvat)
7.fb c                   else
7.fb c                   eval      w_sumim = w_sumim + fdsums
7.fb c                   endif
7.fb c     fodtl1_key2   reade     fodtl1
7.fb c                   enddo
7.fb c                   endif
7.fb  *
7.fb c                   endsr
8.08  *
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  * Henter gj.sn. kostpris på utleverings tidspunkt
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  *
8.08 c     hent_gjkost   begsr
8.08  *
8.08  * Bruk kalk kost på noen leveringstyper og vare typer
8.08  *
8.08 c                   if        sflety = 1 or
8.08 c                             sflety = 5 or
8.08 c                             sflety = 8
8.12 c                   eval      w_gjkp = w_kost
8.08 c                   goto      end_gjkost
8.08 c                   endif
8.08  *
8.08 c                   if        sfvtyp = 'S' or
8.08 c                             sfvtyp = 'T' or
8.08 c                             sfvtyp = 'D'
8.12 c                   eval      w_gjkp = w_kost
8.08 c                   goto      end_gjkost
8.08 c                   endif
8.08
8.08 c                   if        fobdat <> *loval
8.08 c                   eval      w_gjdat = %dec(fobdat:*iso)
8.08 c                   endif
8.08 c                   if        foldat <> *loval
8.08 c                   eval      w_gjdat = %dec(foldat:*iso)
8.08 c                   endif
8.08 c                   if        fopada <> *loval
8.08 c                   eval      w_gjdat = %dec(fopada:*iso)
8.08 c                   endif
8.08 c                   if        fdldat <> *loval
8.08 c                   eval      w_gjdat = %dec(fdldat:*iso)
8.08 c                   endif
8.08
8.08 c                   eval      w_gjko = 0
8.08 c                   if        w_gjdat > 0
8.08 c                   call      'VG701R'
8.08 c                   parm                    fdvare
8.08 c                   parm                    fdlage
8.08 c                   parm                    w_gjdat
8.08 c                   parm                    w_gjko
8.08 c                   else
8.12 c                   eval      w_gjkp = w_kost
8.08 c                   goto      end_gjkost
8.08 c                   endif
8.08  *
8.12  * Sjekker om salgsenhet avviker fra lagerenhet, regn om til lagerenhet
8.08  *
8.12 c                   if        fdenh1 <> vvenhl
8.08 c                   exsr      beregn_pris
8.08 c                   endif
8.08
8.12 c                   if        w_gjko > 0
8.12 c                   eval      w_gjkp = w_gjko * fdanta
8.12 c                   else
8.12 c                   eval      w_gjkp = w_kost
8.12 c                   goto      end_gjkost
8.12 c                   endif
8.08
8.12 c                   if        w_gjkp > 999999999
8.12 c                   eval      w_gjkp = w_kost
8.12 c                   endif
8.08
8.08 c     end_gjkost    endsr
8.08  *
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  * Subrutine for beregning av gjennomsnitlig kostpris i statistikk enhet
8.08  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.08  *
8.08 c     beregn_pris   begsr
8.08  *
8.12  * Finn omregningsfaktor på lager enhet og beregn priser i forhold til basisenhet
8.08  *
8.08 c                   eval      vvenlr_vare = fdvare
8.12 c                   eval      vvenlr_enhe = fdenh1
8.08 c     vvenlr_key    chain     vvenlr
8.08 c                   if        %found(vvenlr)
8.08 c                   eval(h)   w_gjko = w_gjko * veomre
8.08 c                   endif
8.08  *
8.08  * Finn omregningsfaktor på lagerenhet og beregn priser dersom lagerenhet er ulik basisenhet
8.08  *
8.08 c                   if        vvenhe <> vvenhl
8.08 c                   eval      vvenlr_enhe = vvenhl
8.08 c     vvenlr_key    chain     vvenlr
8.08 c                   if        %found(vvenlr)
8.08 c                   eval(h)   w_gjko = w_gjko / veomre
8.08 c                   endif
8.08 c                   endif
8.08  *
8.08 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     csr   *inzsr        begsr
      *
      * Nullstilling av felter som ikke kan redefineres
      *
     c                   eval      w_eaar = 0
     c                   eval      w_emnd = 0
      *
     c                   eval      w_biln = 0
     c                   eval      w_frst = 0
      *
     c                   eval      w_qmem = *blank
     c                   eval      w_sald = 0
      *
     c                   eval      t_text = *blank
      *
     c                   eval      w_valg = 0
     c                   eval      t_avde = 0
     c                   eval      t_kont = 0
     c                   eval      t_spes = 0
3.34 c                   eval      t_mkod = '0'
     c                   eval      t_belp = 0
      *
      * -----------------------------------------------------------
      *
     c                   eval      w_aaar = 0
      *
     c                   eval      w_kode = *blank
     c                   eval      w_fell = *blank
     c                   eval      w_type = *blank
     c                   eval      w_fast = *blank
     c                   eval      w_numm = 0
      *
     c                   eval      w_gebm = 0
     c                   eval      w_geby = 0
     c                   eval      w_geb0 = 0
     c                   eval      w_geb1 = 0
     c                   eval      w_geb2 = 0
     c                   eval      w_geb3 = 0
      *
     c                   eval      w2salp = 0
     c                   eval      w2kstp = 0
     c                   eval      w2rk1p = 0
     c                   eval      w2rk2p = 0
5.31 c                   eval      w2rb1p = 0
5.31 c                   eval      w2rb2p = 0
     c                   eval      w2rbgp = 0
     c                   eval      w2rkop = 0
5.31 c                   eval      w2gr1p = 0
5.31 c                   eval      w2gr2p = 0
5.31 c                   eval      w2mvgp = 0
      *
     c                   eval      w6hsum = 0
     c                   eval      w6geby = 0
     c                   eval      w6pasl = 0
     c                   eval      w6salp = 0
     c                   eval      w6rk1p = 0
     c                   eval      w6rk2p = 0
     c                   eval      w6rkop = 0
6.13 c                   eval      w6moms = 0
      *
3.14 c                   move      '0'           w_hele
     c                   eval      w_ogrp = 0
     c                   eval      w_hgrp = 0
     c                   eval      w_ugrp = 0
     c                   eval      whlp20 = 0
     c                   eval      w_vare = *blank
     c                   eval      w_retk = *blank
     c                   eval      w_otyp = *blank
      *
      * Key for file : KUNDE-REGISTER
      *
     c     rkunl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunl1_kund
5.60  *
5.60  * Key for file : KUNDE-REGISTER update
5.60  *
5.60 c     rkunlu_key    klist
5.60 c                   kfld                    w_firm
5.60 c                   kfld                    rkunlu_kund
      *
      * Key for file : VARE-REGISTER
      *
     c     vvarl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvarl1_vare
      *
      * Key for file : UNDER-GRUPPE-REGISTER
      *
     c     vugrl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vugrl1_uogr
     c                   kfld                    vugrl1_uhgr
     c                   kfld                    vugrl1_uugr
      *
      * Key for file : STATUS-KODER
      *
     c     fstsl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for file : KONTOHENVISNINGS-REGISTER
      *
     c     vkhvl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vkhvl1_kkod
      *
      * Key for file : ORDRE-TYPE-REGISTER
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for file : LINJE-TYPE-REGISTER
      *
     c     vltyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vltyl1_ltyp
      *
      * Key for file : GEBYR-REGISTER
      *
     c     fgebl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fgebl1_otyp
     c                   kfld                    fgebl1_kkat
7.02 c                   kfld                    fgebl1_ftyp
     c                   kfld                    fgebl1_line
7.02  *
7.02  * Key for file : GEBYR-REGISTER
7.02  *
7.02 c     fgebl2_key    klist
7.02 c                   kfld                    w_firm
7.02 c                   kfld                    fgebl2_otyp
7.02 c                   kfld                    fgebl2_kkat
7.02 c                   kfld                    fgebl2_ftyp
7.02 c                   kfld                    fgebl2_type
      *
      * Key for file : ORDRE-HODE-REGISTER
      *
     c     fohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fohel1_numm
     c                   kfld                    fohel1_suff
      *
      * Key for file : ORDRE-LINJE-REGISTER
      *
     c     fodtl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fodtl1_numm
     c                   kfld                    fodtl1_suff
     c                   kfld                    fodtl1_line
7.fb  *
7.fb  * Key for file : ORDRE-LINJE-REGISTER
7.fb  *
7.fb c     fodtl1_key2   klist
7.fb c                   kfld                    w_firm
7.fb c                   kfld                    fodtl1_numm
7.fb c                   kfld                    fodtl1_suff
7.01  *
7.01  * Key for oppslag på ordrelinje SIDETABELL
7.01  *
7.01 c     fod2lu_key    klist
7.01 c                   kfld                    w_firm
7.01 c                   kfld                    fodtl1_numm
7.01 c                   kfld                    fodtl1_suff
7.01 c                   kfld                    fodtl1_line
      *
      * Key for file : ORDRE-TEKST-REGISTER
      *
     c     fotxl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fotxl1_numm
     c                   kfld                    fotxl1_suff
     c                   kfld                    fotxl1_line
5.24  *
5.24  * Key for les på varegruppeknytning
5.24  *
5.24 c     vvgkl1_key    klist
5.24 c                   kfld                    w_firm
5.24 c                   kfld                    vvgkl1_ogrp
5.24 c                   kfld                    vvgkl1_hgrp
5.24 c                   kfld                    vvgkl1_ugrp
5.24 c                   kfld                    vvgkl1_ldor
      *
      * Key for oppslag/les på vare-enhet
      *
     c     vvenl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    vvenl1_vare
      *
      * Key for file : FAKTURA-HODE-REGISTER
      *
     c     sohelu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sohelu_aarr
     c                   kfld                    sohelu_binr
     c                   kfld                    sohelu_numm
     c                   kfld                    sohelu_suff
      *
      * Key for file : FAKTURA-LINJE-REGISTER
      *
     c     sodtlu_key    klist
     c                   kfld                    w_firm
     c                   kfld                    sodtlu_aarr
     c                   kfld                    sodtlu_binr
     c                   kfld                    sodtlu_numm
     c                   kfld                    sodtlu_suff
     c                   kfld                    sodtlu_ktxt
     c                   kfld                    sodtlu_line
5.32  *
5.32  * Key for lesing av bruksrett-type
5.32  *
5.32 c     rmbtlr_key    klist
5.32 c                   kfld                    w_firm
5.32 c                   kfld                    rmbtlr_talm
5.32 c                   kfld                    rmbtlr_tbrt
5.41  *
5.41  * Key for oppdat. av fakturalogg
5.41  *
5.41 c     fnuflu_key    klist
5.41 c                   kfld                    w_firm
5.41 c                   kfld                    fnuflu_aarr
5.41 c                   kfld                    fnuflu_binr
5.62  *
5.62  * Key for oppslag på depositum-fil
5.62  *
5.62 c     sdepl1_key    klist
5.62 c                   kfld                    w_firm
5.62 c                   kfld                    sdepl1_numm
5.62 c                   kfld                    sdepl1_kund
7.fb c                   kfld                    sdepl1_tell
5.62  *
5.62  * Key for oppdatering av depositum-fil
5.62  *
5.62 c     sdeplu_key    klist
5.62 c                   kfld                    w_firm
5.62 c                   kfld                    sdeplu_numm
5.62 c                   kfld                    sdeplu_kund
7.fb c                   kfld                    sdeplu_tell
6.19  *
6.19  * Key for oppslag på kortfil
6.19  *
6.19 c     ruksl1_key    klist
6.19 c                   kfld                    w_firm
6.19 c                   kfld                    ruksl1_skty
6.19 c                   kfld                    ruksl1_slag
6.20  *
6.20  * Key for oppslag på kortregister
6.20  *
6.20 c     bokkl4_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    bokkl4_ktyp
6.20 c                   kfld                    bokkl4_kund
6.20 c                   kfld                    bokkl4_binr
6.20  *
6.20  * Key for file : Kortregister
6.20  *
6.20 c     rukrlr_key    klist
6.20 c                   kfld                    w_firm
6.20 c                   kfld                    rukrlr_kkun
6.2A  *
6.2A  * Key for oppslag på kortregister
6.2A  *
6.2A c     rukrl5_key    klist
6.2A c                   kfld                    w_firm
6.2A c                   kfld                    rukrl5_ktyp
6.2A c                   kfld                    rukrl5_kkun
6.2A c                   kfld                    rukrl5_kpro
6.33  *
6.33  * Key for oppslag på kundeprosjekt
6.33  *
6.33 c     fkprl1_key    klist
6.33 c                   kfld                    w_firm
6.33 c                   kfld                    fkprl1_kund
6.33 c                   kfld                    fkprl1_kpro
6.34  *
6.34  * Key for les av moduler Nexstep
6.34  *
6.34 c     amodl1_key    klist
6.34 c                   kfld                    amodl1_modu
6.38  *
6.38  * Key for oppslag på mva.-kode
6.38  *
6.38 c     vmval1_key    klist
6.38 c                   kfld                    w_firm
6.38 c                   kfld                    vmval1_mkod
6.39  *
6.39  * Key for file : BUTIKK-KODE-REGISTER
6.39  *
6.39 c     bstsl1_key    klist
6.39 c                   kfld                    w_firm
8.08  *
8.08  *  Key for oppdslag på vare/enhet
8.08  *
8.08 c     vvenlr_key    klist
8.08 c                   kfld                    w_firm
8.08 c                   kfld                    vvenlr_vare
8.08 c                   kfld                    vvenlr_enhe
8.18  *
8.18  *  Key for oppdslag på sum faktura
8.18  *
8.18 c     ffaki1_key    klist
8.18 c                   kfld                    w_firm
8.18 c                   kfld                    ffaki1_ksrt
8.18 c                   kfld                    ffaki1_knum
8.18 c                   kfld                    ffaki1_ksuf
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Tar inn parameter fra forrige program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *entry        plist
     c                   parm                    p_parm
      *
     c                   eval      d_aarr = 0
     c                   eval      d_otyp = *blank
     c                   eval      d_ffnr = 0
     c                   eval      d_tfnr = 0
      *
     c                   eval      w_btim = *loval
6.34  *
6.34  * Sjekker om BM Modul
6.34  *
6.34 c                   eval      b_bmmo = *off
6.34 c                   eval      amodl1_modu = 'BM_MODUL'
6.24 c     amodl1_key    chain     amodl1
6.34 c                   if        %found(amodl1)
6.34 c                   eval      b_bmmo = *on
6.34 c                   endif
7.03  *
7.03  * Legger inn timestamp for logging
7.03  *
7.03 c                   time                    w_logg
8.05 c                   eval      l_tmst = %char(w_logg)
7.07  *
7.07  * Sjekk om det skal kjøres med kostnadsfordeling
7.07  *
7.07   CallP CO402R(l_filg:w_firm:0:'FO616_KOSTNADSFORDELING':
7.07                    co402_verdi1:co402_verdi2);
7.07   if co402_verdi1 = '1';
7.07     u_kost = *on;
7.07   endif;
7.08  *
7.08  * Kjører vi regnskap mot SAP m/egen KID
7.08  *
7.08   CallP CO402R(l_filg:w_firm:0:'KIDD_SAP_13':
7.08                    co402_verdi1:co402_verdi2);
7.08   if co402_verdi1 = '1';
7.08     w_sap_kid = 'J';
7.08     if co402_verdi2 <> *blank;
7.08       d_kfir_3  = co402_verdi2;
7.08     else;
7.08       d_kfir_3  = '0000';
7.08     endif;
7.08   endif;
8.03  *
8.03  * Sjekk om det skal kjøres factoring via iizy
8.03  *
8.03   CallP CO402R(l_filg:w_firm:0:'FACTORING_VIA_IIZY':
8.03                    co402_verdi1:co402_verdi2);
8.03   if co402_verdi1 = '1';
8.03     u_803 = *on;
8.03   endif;
8.13  *
8.25  * Sjekk om det skal kjøres kostføring mot regnskap
8.13  *
8.25   CallP CO402R(l_filg:w_firm:0:'POST_KOST':
8.13                    co402_verdi1:co402_verdi2);
8.13   if co402_verdi1 = '1';
8.13     u_813 = *on;
8.13   endif;
8.28  *
8.28  * Sjekk om det skal kjøres øreavrudning av faktura
8.28  *
8.28   CallP CO402R(l_filg:w_firm:0:'OREAVRUNDING':
8.28                    co402_verdi1:co402_verdi2);
8.28   if co402_verdi1 = '1';
8.28     b_round = *on;
8.28   endif;
      *
     c                   endsr
      *
