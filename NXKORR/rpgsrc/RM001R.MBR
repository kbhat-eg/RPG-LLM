     h option(*nodebugio) datedit(*dmy)
     h decedit('0.')
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System  . . . . : ASOFAK
      * Program . . . . : RM001R
      * Beskrivelse . . : Leser linjer fra FOVF til semikolon separert fil
      *
9.01  * Spesialversjon. : Utlegg av poster til Mamut
      * Tilpasset for . :
7.00  *K00  220321 sst    Fjernet hardkodeing av kundekonto og salgskonto
7.01  *K00  240321 sst    Nyanseforskjeller på Mamut-format avh av motaker
7.01  *                   Se NX verid 2:  1=Tripletex
7.01  *                                   2=Aspect4
      *      NB!!!        Venter på testresultat fra Trond Arne
7.03  *       120521 mst  Henter avvikende momskode, hvis den finnes
7.04  *       210322 mst  Legger ut prosjekt
7.05  *       120522 mst  Rettelse til 7.03
8.01  *       240124 mst  Les på sortert fil
      * ----- ------ ---- -------------------------------------------------
      *       270319 nho  Mamut
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
8.01 f*ovupf    if   e             disk
8.01 ffovul1    if   e           k disk
     frhovl1    if   e           k disk    rename(rhovpfr:rhovl1r)
     frkunl1    if   e           k disk    rename(rkunpfr:rkunl1r)
     fsohel1    if   e           k disk    rename(sohepfr:sohel1r)
     fvotyl1    if   e           k disk    rename(votypfr:votyl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
7.00 fra04l1    if   e           k disk    rename(ra04pfr:ra04l1r)
7.03 frb00l1    if   e           k disk    rename(rb00pfr:rb00l1r)
      *
      *
     frm01pf    o    e           k disk
      *
      * Definering av Local data area
      *
     d                uds
7.01 d l_filg                931    933
     d l_firm                944    946  0
      *
      * Definering av variabler i nøkler
     d votyl1_otyp     s                   like(vaotyp)
     d aforl1_ruti     s                   like(afruti)
     d w_kidr          s              8  0
     d w_kidd          s                   like(sokidd)
     d w_kid2          s                   like(sokidd)
     d t1kkid          s             23
      *
6.21 d b_kkid          s              1    inz(*off)
      *
     d fovfl1_peri     s                   like(ffperi)
      *
     d rkunl1_kund     s                   like(rkkund)
      *
     d rhovl1_kont     s                   like(rhkont)
     d rhovl1_spes     s                   like(rhspes)
     d rhovl1_avde     s                   like(rhavde)
7.00 d ra04l1_firm     s                   like(radfir)
      *
      * Datastruktur for bilagsdato
     d                 ds
     d b_jdati                 1     10
     d  b_fa                   1      4
     d  b_f1                   5      5
     d  b_fn                   6      7
     d  b_f2                   8      8
     d  b_fd                   9     10
      *
      * Datastruktur for forfallsdato
     d                 ds
     d b_xdati                 1     10
     d  x_fa                   1      4
     d  x_f1                   5      5
     d  x_fn                   6      7
     d  x_f2                   8      8
     d  x_fd                   9     10
      *
      *
     d fØrste          s              1  0
     d w_ponr          s              4
     d w_ident         s              6
     d w_jdat8         s              8
     d w_xdat8         s              8
     d w_jdat4         s              4
     d w_xdat4         s              4
     d w_bilk          s              3  0
     d x_bilk          s              3  0
     d w_period        s              2  0
     d w_aar           s              4  0
     d w_numb          s              7  0
     d w_vkod          s              5  0
     d x_vkod          s              1
     d w_belp          s             15  2
     d w_firm          s              3  0
     d w_binr          s                   like(sobinr)
     d w_aarr          s                   like(soaarr)
     d w_kundn         s              9  0
     d w_suppn         s             10  0
     d w_cont          s             30
     d w_adres         s            200
     d w_city          s             30
     d w_invtxt        s             25
     d w_t1kkid        s             30
     d w_fdat8         s              8
     d w_fdat4         s              4
     d w_blank         s              1
     d w_account       s             19
     d w_ledger        s            100
     d w_custdes       s            100
     d w_proj          s              6
     d w_depart        s              4
     d w_payment       s              4
     d w_blank1        s              1
     d w_gross         s             20  2
     d w_iban          s             50
     d w_swift         s             50
7.03 d rb00l1_gkod     s                   like(r00kod)
7.03 d w_type          s             10
7.01  *
7.01  * Eksternt program
7.01   dcl-s co402_verdi1  char(1);
7.01   dcl-s co402_verdi2  char(2048);
7.01   DCL-PR CO402R EXTPGM('CO402R');
7.01     p_filgrp            char(3)     const;
7.01     p_firm              packed(3:0) const;
7.01     p_lager             packed(2:0) const;
7.01     p_nokkel            char(50)    const;
7.01     p_verdi1            char(1);
7.01     p_verdi2            char(2048);
7.01   END-PR;
      *
     c*                  eval      fovfl1_peri = 0
8.01 c*    fovfl1_key    setll     fovfl1
8.01 c*                  read      fovupf
8.01 c                   read      fovul1
     c                   dow       not %eof
      *
     c                   if        l_firm <> fffirm
     c                   goto      slutt
     c                   endif
      * Identification
     c                   eval      w_ident = 'GBAT10'
      *
      * Journal date
     c                   movel     ffbdat        b_jdati
     c                   movel     b_fa          w_jdat8
     c                   movel     b_fn          w_jdat4
     c                   move      b_fd          w_jdat4
     c                   move      w_jdat4       w_jdat8
      *
      *
      * Due date
     c                   movel     fffdat        b_xdati
     c                   movel     x_fa          w_xdat8
     c                   movel     x_fn          w_xdat4
     c                   move      x_fd          w_xdat4
     c                   move      w_xdat4       w_xdat8
      *
      * Journal type
      *
      * Øreavrunding på faktura
     c                   if        ffbilk = 17
     c                   if        x_bilk = 1
     c                   eval      w_bilk = x_bilk
     c                   eval      x_bilk = ffbilk
     c                   eval      fØrste = 0
     c                   goto      ettes
     c                   endif
     c                   endif
      *
      *
     c                   if        ffbilk = 3
     c                   eval      x_bilk = 3
     c                   endif
      *
     c                   if        ffbilk = 17
     c                   eval      x_bilk = 3
     c                   endif
      * Øreavrunding på kreditnota
      *
     c                   if        ffbilk = 17
     c                   if        x_bilk = 3
     c                   eval      w_bilk = x_bilk
     c                   eval      x_bilk = ffbilk
     c                   eval      fØrste = 0
     c                   goto      ettes
     c                   endif
     c                   endif
      *
     c                   eval      w_bilk = ffbilk
      *
     c                   if        ffbilk = 40
     c                   eval      w_bilk = 5
     c                   endif
      *
      * Ta vare på bilagskode første gang
     c                   if        fØrste = 0
     c                   add       1             fØrste
     c                   eval      x_bilk = w_bilk
     c                   endif
      *
     c     ettes         tag
      *
      * Period
     c                   movel     ffperi        w_period
      *
      * Accounting year
     c                   movel     w_jdat8       w_aar
      *
      * Accounting number
     c                   if        ffdkto > 9999
7.00 c                   eval      ffdkto = radk05
     c                   else
     c                   if        ffckto > 9999
7.00 c                   eval      ffckto = radk05
     c                   endif
     c                   endif
      *
      * Accounting number
     c                   if        ffdkto <> *zeros
7.00 c*                  if        ffdkto = 3000
7.00 c*                  eval      ffdkto = 3010
7.00 c*                  eval      w_numb = ffdkto
7.00 c*                  endif
     c                   eval      w_numb = ffdkto
     c                   else
7.00 c*                  if        ffckto = 3000
7.00 c*                  eval      ffckto = 3010
7.00 c*                  eval      w_numb = ffckto
7.00 c*                  else
     c                   eval      w_numb = ffckto
7.00 c*                  endif
     c                   endif
      *
      * Vat Code
     c                   if        ffdmom <> *blank
     c                   move      ffdmom        w_vkod
     c                   else
     c                   move      ffcmom        w_vkod
     c                   endif
7.03  * Sjekker om momskode  skal konverteres
7.03 c                   eval      w_type      = 'MVAKODE'
7.04 c                   clear                   rb00l1_gkod
7.03 c*                  move      w_vkod        rb00l1_gkod
7.04 c                   if        ffdmom <> *blank
7.04 c                   move      ffdmom        rb00l1_gkod
7.04 c                   else
7.04 c                   move      ffcmom        rb00l1_gkod
7.04 c                   endif
7.03 c     rb00l1_key    chain     rb00l1
7.03 c                   if        %found
7.03 c*                  movel     r00nko        w_vkod
7.03 c                   move      r00nko        w_vkod
7.03 c                   endif
      *
      *
7.00 c                   if        ffckto = radk05
     c                   eval      w_vkod = 0
     c                   endif
      *
7.00 c                   if        ffdkto = radk05
     c                   eval      w_vkod = 0
     c                   endif
      * Balance
     c                   if        ffdkto <> 0
     c                   eval      w_belp = ffbelp
     c                   eval      w_gross = ffbelp
     c                   else
     c     ffbelp        mult      -1            ffbelp
     c                   eval      w_belp = ffbelp
     c                   eval      w_gross = ffbelp
     c                   endif
      * Customer number
     c                   eval      w_kundn = ffkund
      * Address
     c                   eval      rkunl1_kund = ffkund
     c     rkunl1_key    chain     rkunl1                             90
     c                   movel     rkgate        w_adres
      *
      * Postcode
     c                   movel     rkponr        w_ponr
      * Finner kid
     c                   exsr      control_init
     c                   movel     t1kkid        w_t1kkid
      * Due date
     c                   movel     fffdat        b_xdati
     c                   movel     x_fa          w_xdat8
     c                   movel     x_fn          w_xdat4
     c                   move      x_fd          w_xdat4
     c                   move      w_xdat4       w_xdat8
      *
      * Invoice number
     c                   movel     ffbiln        w_invtxt
      * Gross
     c                   eval      w_blank1 = 'T'
      *
      * Sjekk hovedboks konto Bank account
     c                   if        ffdkto <> 0
     c                   move      ffdkto        rhovl1_kont
     c                   eval      rhovl1_spes = *zero
     c                   eval      rhovl1_avde = *zero
     c     rhovl1_key    chain     rhovl1                             62
      *
     c                   if        *in62 = *off
     c                   movel     ffdkto        w_account
     c                   movel     rhtext        w_ledger
     c                   else
     c                   if        ffckto <> 0
     c                   move      ffckto        rhovl1_kont
     c                   eval      rhovl1_spes = *zero
     c                   eval      rhovl1_avde = *zero
     c     rhovl1_key    chain     rhovl1                             62
      *
     c                   if        *in62 = *off
     c                   movel     ffckto        w_account
     c                   movel     rhtext        w_ledger
     c                   endif
     c                   endif
     c                   endif
     c                   endif
      *
      * Project
7.04 c                   movel     ffproj        w_proj
      **********************************************************************
     c*
     c**********
     c                   eval      rmdata = *blank
7.01 c   40              eval      rmdata = %trim('"')
      *
      * Identification
7.01 c                   eval      rmdata = %trim(rmdata) + %trim(w_ident)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  ';'
      * Journalnr.
7.01 c                   eval      rmdata = %trim(rmdata) + %char(ffbiln) +
7.01 c                                                      ';' +
      * Journal date
     c                                     %trim(w_jdat8) + ';' +
      * Journal type
     c                                     %char(w_bilk)  + ';' +
      * Period
     c                                     %char(w_period)  + ';' +
      * Account Year ?????
     c                                     %char(w_aar)  + ';' +
      * Account Numb ?????
     c                                     %char(w_numb)  + ';' +
      * VAT code
     c                                     %char(w_vkod)  + ';' +
      * Balance
     c                                     %char(w_belp)  + ';' +
      * Customer numb
     c                                     %char(w_kundn)  + ';' +
      * Supplier number
7.01 c                                     %char(0)       + ';'
      * Contact name
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(rknavn)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Adress
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_adres)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Postcode
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_ponr)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * City
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_city)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Invoice number (TXT)
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_invtxt)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Kid
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_t1kkid)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Due date
7.01 c                   eval      rmdata = %trim(rmdata) + %trim(w_xdat8) +
7.01 c                                                      ';' +
      * Not used
7.01 c                                     %trim(w_blank) + ';'
      * Bank Account
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_account)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Ledger description
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_ledger)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Customer description
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_custdes)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * Factoring rateiption
7.01 c                   eval      rmdata = %trim(rmdata) +  %char(1)  + ';' +
      * Project
     c                                     %trim(w_proj)     + ';' +
      * Department
     c                                     %trim(w_depart)     + ';' +
      * Payment terms
     c                                     %trim(w_payment)     + ';' +
      * Gross
     c                                     %trim(w_blank1)     + ';' +
      * Gross sum
7.01 c                                     %char(w_gross)     + ';'
      * IBAN
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_iban)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      * SWIFT
7.01 c   40              eval      rmdata = %trim(rmdata) +  '"'
7.01 c                   eval      rmdata = %trim(rmdata) +  %trim(w_swift)
7.01 c   40              eval      rmdata = %trim(rmdata) + '"'
7.01 c                   eval      rmdata = %trim(rmdata) + ';'
      **********************************************************************
     c************************************************************************
     c*    'Æ':X'46'     xlate     nsdata        nsdata
     c*    'æ':X'A0'     xlate     nsdata        nsdata
     c*    'Ø':X'77'     xlate     nsdata        nsdata
     c*    'ø':X'90'     xlate     nsdata        nsdata
     c*    'Å':X'2A'     xlate     nsdata        nsdata
     c*    'å':X'EF'     xlate     nsdata        nsdata
     c                   movel     *blanks       w_iban
     c                   movel     *blanks       w_swift
     c                   write     rm01pfr
6.24  *
      * Blanker felt
     c                   exsr      blank
      *
8.01 c*                  read      fovupf
8.01 c                   read      fovul1
     c                   enddo
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Avslutt program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   eval      *inlr = *on
6.23 c     slutt         tag
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *  Blanker felter
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     c     blank         begsr
      *
     c                   eval      w_ponr = *blanks
     c                   eval      w_binr = *zeros
     c                   eval      w_aarr = *zeros
     c                   eval      w_ident = *blanks
     c                   eval      w_jdat8 = *blanks
     c                   eval      w_jdat4 = *blanks
     c                   eval      w_bilk  = *zeros
     c                   eval      w_period  = *zeros
     c                   eval      w_aar  = *zeros
     c                   eval      w_numb  = *zeros
     c                   eval      w_vkod  = *zeros
     c                   eval      x_vkod  = *blanks
     c                   eval      w_belp  = *zeros
     c                   eval      w_kundn = *zeros
     c                   eval      w_suppn = *zeros
     c                   eval      w_cont  = *blanks
     c                   eval      w_adres = *blanks
     c                   eval      w_city  = *blanks
     c                   eval      w_invtxt  = *blanks
     c                   eval      w_t1kkid  = *blanks
     c                   eval      w_fdat8  = *blanks
     c                   eval      w_blank  = *blanks
     c                   eval      w_account = *blanks
     c                   eval      w_ledger = *blanks
     c                   eval      w_proj = *blanks
     c                   eval      w_depart = *blanks
     c                   eval      w_payment = *blanks
     c                   eval      w_blank1 = *blank
     c                   eval      w_gross = *zeros
     c                   eval      w_iban  = *blanks
     c                   eval      w_swift  = *blanks
6.21  *
6.21 c                   endsr
      **********************************************************************
     c     control_init  begsr
      **********************************************************************
      *
     c                   eval      w_firm = fffirm
     c                   eval      w_binr = ffbiln
     c                   move      b_fa          w_aarr
      * Finner siste faktura-hode for faktura
      *
     c     sohel1_key    setll     sohel1
     c     sohel1_key    reade     sohel1                                 90
     c                   if        *in90 = *on
     c                   goto      avslutt
     c                   endif
      *
     c                   dow       *in90 = *off
     c     sohel1_key    reade     sohel1                                 90
     c                   enddo
      *
     c     avslutt       tag
6.20  *
6.20  * Henter rutine fra ordretype
6.20  *
6.20 c                   eval      b_kkid = *off
6.20 c                   eval      votyl1_otyp = sootyp
6.20 c     votyl1_key    chain     votyl1
6.20 c                   if        %found(votyl1)   and
6.20 c                             vaorut <> *blank
6.20 c                   eval      aforl1_ruti = vaorut
6.20 c     aforl1_key    chain     aforl1
6.20 c                   if        %found(aforl1) and
6.20 c                             afkidk = 1
6.20 c                   movel     sokidd        t1kkid
6.20 c                   else
6.20 c                   if        afkidk = 2
6.20 c                   movel     sokidr        t1kkid
6.20 c                   else
6.20 c                   if        afkidk = 3
6.20 c                   movel     sokidr        w_kidr
6.20 c                   movel     sokidr        w_kidr
6.20 c                   call      'AK710R'
6.20 c                   parm                    w_firm
6.20 c                   parm                    w_kidr
6.20 c                   parm                    w_kidd
6.20 c                   parm                    w_kid2
6.20 c                   movel     w_kid2        t1kkid
6.20 c                   endif
6.20 c                   endif
6.20 c                   endif
6.20 c                   endif
6.20  *
     c                   endsr
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  * Subrutine for initiering av program
6.21  * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
6.21  *
6.21 c     *inzsr        begsr
6.21  *
      *
      * Key for les av ordretype
      *
      * Key for oppslag på faktura-hode-register
     c     sohel1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    w_aarr
     c                   kfld                    w_binr
      *
     c     votyl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    votyl1_otyp
      *
      * Key for les av rutine-register
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for hovedbok
      *
     c     rhovl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rhovl1_kont
     c                   kfld                    rhovl1_spes
     c                   kfld                    rhovl1_avde
      *
6.21  * Key for oppslag på kunde
6.21  *
6.21 c     rkunl1_key    klist
6.21 c                   kfld                    w_firm
6.21 c                   kfld                    rkunl1_kund
6.21  *
      * Key for posisjonering på posteringsfil
      *
     c     fovfl1_key    klist
     c                   kfld                    w_firm
     c                   kfld                    fovfl1_peri
7.00  *
7.00  * Key for posisjonering på faste konti
7.00  *
7.00 c     ra04l1_key    klist
7.00 c                   kfld                    w_firm
7.03  * Key for posisjonering på koder (moms)
7.03  *
7.03 c     rb00l1_key    klist
7.03 c                   kfld                    w_firm
7.03 c                   kfld                    w_type
7.03 c                   kfld                    rb00l1_gkod
6.21  *
     c                   eval      w_firm = l_firm
7.00  *
7.00 c     ra04l1_key    chain     ra04l1
6.21  *
7.01  *
7.01  * Variant av Mamut format
7.01  *  *in40=*on betyr at det skal legges ut " før og etter noen felter
7.01 c                   eval      *in40 = *on
7.01   CallP CO402R(l_filg:w_firm:0:'MAMUT':
7.01                    co402_verdi1:co402_verdi2);
7.01   if co402_verdi1 = '1';
7.01    if %subst(co402_verdi2:1:1) = '1';
7.01     *in40 = *off;
7.01    endif;
7.01   endif;
6.21  *
6.21 c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
