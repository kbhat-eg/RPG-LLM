     h option(*nodebugio) datedit(*dmy-) decedit('0.')
     h DftActgrp(*No) BndDir('CGIDEV2/CGIDEV2')
      /copy hspecsbnd
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
      * System. . . . . : ASOFAK
      * Program . . . . : RX602R
      * Beskrivelse . . : Legger ut kunder på excel
      *
      *
      * Spesialversjon. :
      * Tilpasset for . :
      *
      * Ref.   Dato  Sign Endringsbeskrivelse
      * ----- ------ ---- -------------------------------------------------
      *       150925 bsa  Nytt program
      *
      *
      *
      *
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     frkunlr    if   e           k disk    rename(rkunpfr:rkunlrr)
     frkbpl1    if   e           k disk    rename(rkbppfr:rkbpl1r)
     frku2l1    if   e           k disk    rename(rku2pfr:rku2l1r)
     fafpslr    if   e           k disk    rename(afpspfr:afpslrr)
     fafirl1    if   e           k disk    rename(afirpfr:afirl1r)
     faforl1    if   e           k disk    rename(aforpfr:aforl1r)
      *
      * Definering av array
      *
      *
      * Definering av Local data area
      *
     d                uds
     d l_poff                584    584
     d l_bach                595    635
     d l_arch                636    636  0
     d l_skje                637    637  0
     d l_exlp                639    639  0
     d l_mail                640    640  0
     d l_firm                944    946  0
     d l_filg                931    933
     d l_user                911    920
     d l_avde                947    950  0
      *
      * Definering av datastrukturer
      *
      *
      * Datastruktur for parameterliste -ut
      *
     d                 ds
     d d_list                       512
     d  d_firm                        3  0 overlay(d_list)
     d  d_kund                        6  0 overlay(d_list:4)
     d  d_txt1                       60    overlay(d_list:36)
     d  d_txt2                       60    overlay(d_list:96)
     d  d_txt3                       60    overlay(d_list:156)
     d  d_emal                       60    overlay(d_list:216)
     d  d_subj                       60    overlay(d_list:276)
     d  d_avse                       60    overlay(d_list:336)
     d  d_dumm                        1    overlay(d_list:512) inz('*')
      *
      * Definering av datastrukturer
      *
     d                 ds
     d d_jkey                        41
     d  d_jnav                       13    overlay(d_jkey:1)
     d  d_tstp                       26    overlay(d_jkey:14)
      *
      * Definering av parametre
      *
     d p_parm          s            384
      *
      * Definering av variabler i nøkler
      *
     d rkunlr_kund     s                   like(rkkund)
     d afpslr_ufil     s                   like(l_filg)
     d afpslr_uide     s                   like(afuide)
     d aforl1_ruti     s                   like(afruti)
      *
      * Definering av variable
      *
     d b_excl          s              1    inz(*off)
      *
     d w_firm          s                   like(aaffir)
     d w_lnavn         s             50
     d w_tek1          s            100
     d w_tek2          s            100
     d w_ant           s              9  0
     d w_dato          s                   like(aaodat)
     d w_aarr          s              4  0
     d w_gtin          s             14  0
     d w_kode          s              1
     d w_fell          s              6
     d w_type          s              2
     d w_fast          s             10
     d w_ruti          s             10
     d w_numm          s              8  0
     d w_1fnav         s             50
     d w_1fad1         s             50
     d w_1fad2         s             50
     d w_prfi          s              1  0
     d w_ffir          s              3  0
     d w_fnav          s             30
     d w_fad1          s             30
     d w_fad2          s             30
     d w_fste          s             30
     d w_fftx          s             30
     d w_tfax          s              8
     d w_ftlf          s             11
     d w_ffax          s             11
     d w_mail          s             50
     d w_weba          s             50
     d w_avde          s              4  0
     d w_text          s             50
     d w_dspl          s            100
     d w_jkey          s             41
     d w_jnav          s             15
     d w_jtxt          s             35
     d w_jstat         s              2  0
     d w_jtext         s            200
     d w_pdf           s              1  0
     d w_pdf_ds        s            512
     d w_rtyp          s             50
     d w_ddmy          s              6  0
     d w_tids          s              6  0
     d w_txt1          s             75
     d w_pemne         s             75
     d w_ptxt1         s             75
     d w_ptxt2         s             75
     d w_ptxt3         s             75
     d w_ptxt4         s             75
     d w_avse          s             75
     d w_emal          s             50
     d w_ema1          s             50
     d w_ema2          s             50
     d w_ema3          s             50
     d w_besk          s             75
     d w_lnav          s             75
     d w_ppers         s             75
     d w_mtxt          s            300
     d h_valu          s             15
     d d_valu          s            100
     d d_type          s             10
     d w_mime          s             24
     d w_tstp          s               z
     d w_kopi          s             50
     d w_date          s               d   datfmt(*iso)
      *
     d p_stat          s              1
     d p_serv          s             35
     d p_btyp          s            100
     d p_ok            s              1
     d p_lr            s              1
     d p_str_in        s            512
     d p_str_out       s            512
     d p_filg          s             10
     d p_xmlf          s            256
      *
      *
     d XML_Output      s            256a   Varying
     d XML_path        s            256a   Varying
     d                                     Inz('/home/asp/print/adb')
     d jasper_mal      s            256a
     d jasper_logo     s            256a   varying
     d tmpdate         s               D
     d tmptime         s               T
     d crlf            c                   const(X'0d25')
      *
     d d_pdf_ds        ds
     d  d_xmlm                       75
     d  d_jasm                       75
     d  d_logo                       75
     d  d_path                      100
     d  d_mail                       50
     d  d_fifo                       75
     d  d_fkop                        1
     d  d_dtaq                        1
     d  d_sign                        1
      /copy prototypeb
      /copy usec
      *
     C/Exec SQL
     C+  Set Option DatFmt=*ISO
     C/End-Exec
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Hovedprogram
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c                   eval      sco2i2_kund = d_kund
     c                   eval      sco2i2_kpro = d_kpro
     c                   eval      sco2i2_numm = 0
     c                   eval      sco2i2_suff = 0
     c                   eval      sco2i2_line = 0
     c     sco2i2_key    setll     sco2i2
     c     sco2i2_key2   reade     sco2i2
      *
     c                   dow       not  %eof(rkunlr)
      *
     c                   exsr      xml_detal
      *
     c                   endif
     c                   endif
      *
     c     sco2i2_key2   reade     sco2i2
     c                   enddo
      *
     c                   exsr      xml_end
      *
      * Avslutt program
      *
     c     avslutt       tag
      *
     c                   eval      *inlr = *on
      *
     c                   return
      *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML/jasper integrasjon - Miljø variabler         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_envm      begsr
      *
     c                   eval      w_rtyp = 'XsltCommand'
     c                   eval      w_mime = 'application/vnd.ms-excel'
     c                   eval      d_jasm = *blank
     c                   eval      d_jnav = %char(d_kund)
     c                   eval      w_jkey = %trim(d_jkey)
      *
      /Free
           // Finne nytt batch nummer
               UpdHTMLVar('BatchNo':               w_jkey);
               UpdHTMLVar('Batchtype':            'EXCEL');
               UpdHTMLVar('Username':              l_user);
               WrtSection('Topp');
           // Finn report command variabler
               UpdHTMLVar('User':                l_user);
               UpdHTMLVar('PW':                     ' ');
               UpdHTMLVar('IPAdr':                  ' ');
               UpdHTMLVar('Schema':        'ADB'+l_filg);
               UpdHTMLVar('Companyno':    %char(l_firm));
               WrtSection('Credential');
           // Finn report command variabler
               UpdHTMLVar('Reportcommandtype':   w_rtyp);
               UpdHTMLVar('Jaspertemplate':      d_jasm);
               UpdHTMLVar('Logo':                   ' ');
               UpdHTMLVar('Keepspool':           'true');
               UpdHTMLVar('Xsltschemapath':         ' ');
               UpdHTMLVar('Mimetype':            w_mime);
               WrtSection('ReportCommand');
      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML integrasjon - Heading                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_head      begsr
      *
     c                   eval      aforl1_ruti = w_ruti
     c     aforl1_key    chain     aforl1r
      *
      * Henter ut mailserver
      *
     c                   eval      p_serv = *blank
     c                   eval      p_stat = *blank
     c                   call      'AM705C'
     c                   parm                    p_serv
     c                   parm                    p_stat
      *
      * Scann av strenger
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     d_subj        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_pemne
      * Scann av strenger
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     d_txt1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     d_txt2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt2
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     d_txt3        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_ptxt3
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     d_avse        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_avse
      *
     c                   eval      w_mtxt = %trim(w_ptxt1) + crlf +
     c                                      %trim(w_ptxt2) + crlf +
     c                                      %trim(w_ptxt3) + crlf +
     c                                      %trim(w_avse)
      *
      /Free
           // Skriv mailinformasjon
               WrtSection('MailCommandStart');
          //   UpdHTMLVar('Receivers':           p_emal);
               if %Trim(d_emal)<> *blanks;
               UpdHTMLVar('Receivers':           d_emal);
               WrtSection('MailReceiver');
               endif;
          //   if %Trim(p_ema2)<> *blanks;
          //   UpdHTMLVar('Receivers':           p_ema2);
          //   WrtSection('MailReceiver');
          //   endif;
          //   if %Trim(p_ema3)<> *blanks;
          //   UpdHTMLVar('Receivers':           p_ema3);
          //   WrtSection('MailReceiver');
          //   endif;

               UpdHTMLVar('CC':                     ' ');
               UpdHTMLVar('BCC':                 w_kopi);
               UpdHTMLVar('Sender':              w_kopi);
               UpdHTMLVar('Subject':             w_pemne);
               UpdHTMLVar('Message':             w_mtxt);
               UpdHTMLVar('SMTPServer':          p_serv);
               UPDHTMLVar('SMTPUser':               ' ');
               UPDHTMLVar('SMTPPw':                 ' ');
               WrtSection('MailCommandEnd');
      /End-free
      *
      * Scann av strenger
      *
     c                   eval      w_txt1 = 'Kundeeksport'
      *
      * Vi må oversette aktuelle tekster til "xml" tegn - Firma
     c                   eval      w_1fnav = *blank
     c                   eval      w_1fad1 = *blank
     c                   eval      w_1fad2 = *blank
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fnav        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fnav
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fad1        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fad1
      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_fad2        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_1fad2
      *
      /Free

           // Skriv firmavariabler
               UpdHTMLVar('Reporttext':            w_txt1);
               UpdHTMLVar('Subheader':                ' ');
               UpdHTMLVar('CompanyName':          w_1fnav);
               UpdHTMLVar('Companyadress1':       w_1fad1);
               UpdHTMLVar('Companyadress2':       w_1fad2);
               UpdHTMLVar('Companypostalcode':        ' ');
               UpdHTMLVar('Companypostoffice':     w_fste);
               UpdHTMLVar('Companyphone':          w_ftlf);
               UpdHTMLVar('Companyfax':            w_ffax);
               UpdHTMLVar('Companyorgno':   %char(aafftn));
               UpdHTMLVar('Companygiro':    %char(aafbgi));
               UpdHTMLVar('Companyemail':          aamail);
               UpdHTMLVar('Companywebpage': %trim(aaweba));

               test(de) *dmy w_ddmy;
               if %error;
               tmpdate = *loval;
               else;
               tmpdate = %date(w_ddmy : *dmy);
               endif;
               UpdHTMLVar('Creationdate':   %char(tmpdate : *iso));

               test(te) *hms w_tids;
               if %error;
               tmptime = *loval;
               else;
               tmptime = %time(w_tids : *hms);
               endif;
               UpdHTMLVar('Creationtime': %char(tmptime : *hms));
               WrtSection('DocumentInformation');

               WrtSection('FreedefHeader');

      /End-free
      *
     c                   eval      h_valu='Ar'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Fakturanummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Ordrenummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Suffiks'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Linjenr'
     c                   exsr      xml_head_val
     c                   eval      h_valu='EPDNummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Kilde'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Varenummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GTIN nummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Pris enhet'
     c                   exsr      xml_head_val
     c                   eval      h_valu='CO2 enhet'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Lager'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Kundeprosjekt'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Kundenummer'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Fakturakunde'
     c                   exsr      xml_head_val
     c                   eval      h_valu='CO2 verdi'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Antall'
     c                   exsr      xml_head_val
     c                   eval      h_valu='Fakturadato'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A1'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A1'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A1'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A1'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A1'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A2'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A2'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A2'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A2'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A2'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A3'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A3'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A3'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A3'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A3'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A13'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A13'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A13'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A13'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A13'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A4'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A4'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A4'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A4'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A4'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP TOT A5'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP IOB GHG A5'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP BIO A5'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP FOS A5'
     c                   exsr      xml_head_val
     c                   eval      h_valu='GWP LUL A5'
     c                   exsr      xml_head_val
      *
      /Free

           // Avslutt headervalues
               WrtSection('HeaderLineEnd');

      /End-free
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML integrasjon - Heading                        *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_head_val  begsr
      *
      /Free

           // Skriv headervalue
               UpdHTMLVar('Headervalue':  %trim(h_valu));
               WrtSection('HeaderLineValue');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML integrasjon - detaljlinjer                   *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_detal     begsr
      *
      /Free

           // Skriv detaljer
               WrtSection('DetailLineStart');

               WrtSection('FreedefLine');

      /End-free
      *
      * Så skriver vi de forskjellige linjene
      *
      * Årstall
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spyear)
     c                   exsr      xml_line_val
      * Fakturanummer
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spbinr)
     c                   exsr      xml_line_val
      * Ordrenummer
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spnumm)
     c                   exsr      xml_line_val
      * Sufiks
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spsuff)
     c                   exsr      xml_line_val
      * Linje
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spline)
     c                   exsr      xml_line_val
      * EPD nummer
     c                   eval      d_type='Char'
     c                   eval      d_valu=%char(spenbr)
     c                   exsr      xml_line_val
      * Kilde
     c                   eval      d_type='Char'
     c                   eval      d_valu=%trim(spsour)
     c                   exsr      xml_line_val
      * Varenummer
     c                   eval      d_type='Char'
     c                   eval      d_valu=%trim(spitem)
     c                   exsr      xml_line_val
      * GTIN nummer
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgtin)
     c                   exsr      xml_line_val
      * Prisenhet
     c                   eval      d_type='Char'
     c                   eval      d_valu=%trim(sppenh)
     c                   exsr      xml_line_val
      * CO2 enhet
     c                   eval      d_type='Char'
     c                   eval      d_valu=%trim(spcenh)
     c                   exsr      xml_line_val
      * Lager
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(splage)
     c                   exsr      xml_line_val
      * Kundeprosjekt
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spkpro)
     c                   exsr      xml_line_val
      * Kundenummer
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spkund)
     c                   exsr      xml_line_val
      * Fakturakunde
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spivcu)
     c                   exsr      xml_line_val
      * CO2 verdi
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spsco2)
     c                   exsr      xml_line_val
      * Antall
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(sptqty)
     c                   exsr      xml_line_val
      * Fakturadato
     c                   eval      d_type='Date'
      /Free

               UpdHTMLVar('type':         %trim(d_type));
               UpdHTMLVar('Linevalue':   %char(spidat : *iso));

               WrtSection('DetailLineValue');

      /End-free
      *
      * GWP TOT A1
      *
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgta1)
     c                   exsr      xml_line_val
      * GWP IOB GHG A1
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgga1)
     c                   exsr      xml_line_val
      * GWP BIO A1
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgba1)
     c                   exsr      xml_line_val
      * GWP FOS A1
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgfa1)
     c                   exsr      xml_line_val
      * GWP LUL A1
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgla1)
     c                   exsr      xml_line_val
      * GWP TOT A2
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgta2)
     c                   exsr      xml_line_val
      * GWP IOB GHG A2
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgga2)
     c                   exsr      xml_line_val
      * GWP BIO A2
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgba2)
     c                   exsr      xml_line_val
      * GWP FOS A2
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgfa2)
     c                   exsr      xml_line_val
      * GWP LUL A2
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgla2)
     c                   exsr      xml_line_val
      * GWP TOT A3
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgta3)
     c                   exsr      xml_line_val
      * GWP IOB GHG A3
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgga3)
     c                   exsr      xml_line_val
      * GWP BIO A3
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgba3)
     c                   exsr      xml_line_val
      * GWP FOS A3
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgfa3)
     c                   exsr      xml_line_val
      * GWP LUL A3
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgla3)
     c                   exsr      xml_line_val
      * GWP TOT A13
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgt13)
     c                   exsr      xml_line_val
      * GWP IOB GHG A13
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgg13)
     c                   exsr      xml_line_val
      * GWP BIO A13
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgb13)
     c                   exsr      xml_line_val
      * GWP FOS A13
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgf13)
     c                   exsr      xml_line_val
      * GWP LUL A13
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgl13)
     c                   exsr      xml_line_val
      * GWP TOT A4
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgta4)
     c                   exsr      xml_line_val
      * GWP IOB GHG A4
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgga4)
     c                   exsr      xml_line_val
      * GWP BIO A4
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgba4)
     c                   exsr      xml_line_val
      * GWP FOS A4
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgfa4)
     c                   exsr      xml_line_val
      * GWP LUL A4
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgla4)
     c                   exsr      xml_line_val
      * GWP TOT A5
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgta5)
     c                   exsr      xml_line_val
      * GWP IOB GHG A5
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgga5)
     c                   exsr      xml_line_val
      * GWP BIO A5
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgba5)
     c                   exsr      xml_line_val
      * GWP FOS A5
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgfa5)
     c                   exsr      xml_line_val
      * GWP LUL A5
     c                   eval      d_type='Numeric'
     c                   eval      d_valu=%char(spgla5)
     c                   exsr      xml_line_val
      *
      /Free
           // Skriv avslutning

               WrtSection('DetailLineEnd');

      /End-free
      *
     c                   endsr

      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML integrasjon - Linjer                         *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_line_val  begsr
      *
      /Free

           // Skriv linevalue
               UpdHTMLVar('type':         %trim(d_type));
               UpdHTMLVar('Linevalue':    %trim(d_valu));
               WrtSection('DetailLineValue');

      /End-free
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
      * Subrutiner for XML integrasjon - Slutt                          *
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - *
     c     xml_end       begsr
      *
      /Free
               WrtSection('EndExcelLines');
      /End-free
      *
      * Hvis denne ikke skal arkiveres, lages ikke archive tagg.
      *
     c                   if        l_arch = 1
      * Lag tag for vising i arkivklienten
     c                   eval      w_dspl = *blank

      *
     c                   eval      p_str_in = *blank
     c                   eval      p_lr = '0'
     c                   movel     w_dspl        p_str_in
     c                   call      'AP613R'
     c                   parm                    p_str_in
     c                   parm                    p_str_out
     c                   parm                    p_lr
     c                   movel     p_str_out     w_dspl
      /Free
           // Skriv metattags

               UpdHTMLVar('Displaytag':     %trim(w_dspl));
               WrtSection('ArchiveCommandStart');

               UpdHTMLVar('Metavalue':             l_user);
               UpdHTMLVar('Metakey':             'BRUKER');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue': %char(w_date:*iso));
               UpdHTMLVar('Metakey':               'DATO');
               WrtSection('MetaTag');

               UpdHTMLVar('Metavalue':             w_txt1);
               UpdHTMLVar('Metakey':         'RUTINETEKST');
               WrtSection('MetaTag');

               WrtSection('ArchiveCommandEnd');
      /End-free
      *
     c                   endif
      *
      /Free
               WrtSection('Footer');
      /End-free
      *
     c                   eval      XML_Output = XML_path + l_filg +'/'+
     c                             'Kundeeksport_'+ %trim(w_jkey) + '.xml'
      *
     c                   callp     WrtHtmlToStmf(XML_Output: 819)
      * Skriver til datakø for å aktivere sniffer, hvis dataq er aktiv
     c                   if        d_dtaq = '1'
     c                   eval      p_xmlf = xml_output
     c                   eval      p_filg = 'ADB'+l_filg
     c                   call      'AP629C'
     c                   parm                    p_filg
     c                   parm                    p_xmlf
     c                   endif
      *
     c                   endsr
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      * Subrutine for initiering av program
      * - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      *
     c     *inzsr        begsr
      *
      * Parametre
      *
     c     *entry        plist
     c                   parm                    p_parm
      *
      * Key for oppslag på firmaregister
      *
     c     afirl1_key    klist
     c                   kfld                    w_firm
      *
      * Key for oppslag CO2 avtrykk
      *
     c     rkunlr_key    klist
     c                   kfld                    w_firm
     c                   kfld                    rkunlr_kund
      *
      * Key for oppslag på rutineregister
      *
     c     aforl1_key    klist
     c                   kfld                    aforl1_ruti
      *
      * Key for properties
      *
     c     afpslr_key    klist
     c                   kfld                    afpslr_ufil
     c                   kfld                    afpslr_uide
     c
      *
      * Sjekk om vi skal bruke XML generering av dokumenter
      * NB KUN hvis EXCEL rapport.
      *
     c                   eval      d_list = p_parm
     c                   time                    w_dato
      *
     c                   eval      w_firm = l_firm
     c                   eval      l_mail = 1
     c                   eval      l_arch = 0
     c                   eval      b_excl = *on
     c                   eval      w_pdf = 0
     c                   eval      w_pdf_ds = *blanks
     c                   eval      w_ruti = 'SX903'
      *
      * henter mailadresse fra
      *
     c                   eval      afudss = *blank
     c                   eval      afpslr_ufil = l_filg
     c                   eval      afpslr_uide = 'NOMAIL   '
     c     afpslr_key    chain     afpslr
     c                   if        not %found
     c                   eval      w_kopi = *blanks
     c                   else
     c                   eval      w_kopi = %trim(afudss)
     c                   endif
      *
     c                   call      'AP609R'
     c                   parm                    w_ruti
     c                   parm                    w_pdf
     c                   parm                    w_pdf_ds
     c                   eval      d_pdf_ds = w_pdf_ds
      *
      * PROA er aktivert
      *
     c                   eval      b_excl = *on
      *
      * Hent inn xml templaten
      *
     c                   callp     GetHTMLIFS(d_xmlm :'<AS400>')
     c                   callp     ClrHtmlBuffer
      *
      * Finn hvor xml'en skal legges
      *
     c                   eval      XML_path = *blanks
     c                   eval      XML_path = %trim(d_path)
      *
      *  Hent inn firma/avd. opplysninger dersom
      *  kode for det er satt i rutineregister
      *
     c                   eval      w_prfi = 1
     c                   eval      w_ffir = w_firm
     c                   eval      w_avde = l_avde
      *
     c                   call      'FÅ707R'
     c                   parm                    w_prfi
     c                   parm                    w_ffir
     c                   parm                    w_avde
     c                   parm                    w_fnav
     c                   parm                    w_fad1
     c                   parm                    w_fad2
     c                   parm                    w_fste
     c                   parm                    w_fftx
     c                   parm                    w_tfax
     c                   parm                    w_ftlf
     c                   parm                    w_ffax
     c                   parm                    w_mail
     c                   parm                    w_weba
      *
     c                   time                    w_tstp
     c                   eval      d_tstp = %char(w_tstp)
     c                   time                    w_date
      *
      * Vi skriver xml for miljø formater
     c                   exsr      xml_envm
     c                   exsr      xml_head
      *
      * Henter firmaopplysninger
      *
     c     afirl1_key    chain     afirl1r
      *
     c                   endsr
