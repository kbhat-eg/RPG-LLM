# RPG Program FD120R - Order Line Maintenance for Item Lines (Supplier Registration)
---

## Overview

This RPG program (`FD120R`) is designed for maintaining order lines specifically related to items with supplier registration (possibly "procurement items" or "special order lines"). It is a mature, business-critical program with a long history of maintenance as shown in the extensive change log.

It is part of a sales/order/warehouse management solution (possibly for the Norwegian market, as many comments and variable names are in Norwegian), and is responsible for both registering new order lines and editing existing ones, with comprehensive price, discount, tax, and logistics handling.

---

## Structure Breakdown

### 1. File Declarations (`F-specs`)

The program uses multiple physical and logical files, typically using `CHAIN`, `SETLL`, `READE`, `UPDATE`, and `WRITE` operations for lookups, updating, and adding entries. Examples:

- Inventory master files (e.g., `JVARPF: jvarl1r`, `JLEV: jlevl1r, jlevl3r`)
- Price/discount tables (`JVPRPF`, `JVPKPF`, `JBETPF`)
- Order header and line files (`FOHEPF`, `FODTPF`)
- Customer and project files (`RKUNPF`, `FKPRPF`)
- Modular product/add-ons (`AMODPF`, `JVOMPF`)
- Logistic-related files, NOBB (Standard Norwegian construction product database), package/GTIN info, etc.

A display file (`FD120D`) is declared for workstation I/O.

---

### 2. Data Definitions (`D-Specs`/Variables)

- **Parameters**: Variables beginning with `p_` are for passing to/from the program.
- **Working Variables**: Central working variables (`w_`) are used for firm, order, price, and more.
- **Data Structures**: Used to align with called program parameter lists, e.g.:
  - `hirec`/`horec`: For passing price/condition info to/from pricing routines.
- **Flags/Booleans**: Single-character flags to control logic flow, e.g., `b_endr` (edit mode), `b_forn` (refresh required).
- **Constants**: Lower/upper alphabet for uppercase conversion, etc.
- **External procedures (from Free Format)**: Some external program calls (e.g., `CO402R`) are defined for runtime config checks.

---

### 3. Main Program Logic

#### a) Initialization (`*inzsr`)

- Reads key parameters from the parameter list (firm, order number, etc.).
- Initializes key fields for various lookups.
- Calls other applications to fetch exchange rates, tax info, price group from warehouse/department, etc.
- Checks if "BM-modul" or NOBB freight calculator is enabled (via config).

#### b) Mainline

**Order Item Maintenance**:
- If an order line exists, go to "edit" mode (`exsr endr_linje`).
- Otherwise, go to "new line" mode (`exsr ny_linje`).
- Various flags, conditions, and decisions dictate the rest of the flow.

**Screen Handling / User Interaction**:
- The program loops in a "work with" screen (`exsr xc1win`), which handles:
    - Input validation
    - Calls to manual cost price calculation
    - Changing supplier (pricegiver)
    - Changing sales conditions (discounts, groups, etc.)
    - Viewing product info, NOBB data
    - Unit conversion (calculator)
    - Error handling, warning messages (e.g., "product expired", cost price = 0, etc.)

#### c) Order Line Update

- When all validations pass, the program fills the order line record with all calculated and input values, updates or writes as necessary.
- Calls subroutines (and other programs) to enrich records with correct VAT codes, price structures, and more.

#### d) Subroutines

**Key subroutines include:**

- **`endr_linje`**: Initializes fields from an existing order line for editing.
- **`ny_linje`**: Sets up a new order line, including pricing, supplier determination, condition selection.
- **`mva_kode`**: Determines the correct VAT (sales tax) code for the line, based on customer, project, and overrides.
- **`xc1win`**: The main screen handling subroutine, with all validation, recalculation, and re-display logic.
- **`kalkulator`**: For unit and quantity conversion between different sales units.
- **`dekning`**: Margin and price calculation given a desired profit margin (`dekningsgrad`).
- **`prisgiver`**: Allows selection of a pricegiving supplier for the item.
- **`hent_grunnlag`**, **`hent_pris`**: Fetches base data and price from other programs/files.
- **`sjekk_pgiv`, `sjekk_pgiv_2`**: Checks whether products have multiple pricegivers.
- **`sjekk_bet`**: Checks whether there are alternative sales conditions (discounts, packages, etc.) at various hierarchy levels (item, module, group, supplier, etc.).
- **`betingelse`**: Handles condition (betingelse) selection and its effect on pricing.
- **`sjekk_kamp`**: Checks whether the item is on a campaign and attaches campaign pricing if appropriate.
- **`vis_nobb`**: Displays NOBB information for the product.

#### e) Error Handling

- The `*pssr` subroutine ensures user is returned to the main screen after an error, and displays a flag/indicator on the screen.

---

## Business Concepts & Logic

- **Varelinje**: Item line on an order, including product, quantity, unit, pricing, discounts, etc.
- **Price Provider (Prisgiver)**: In some cases, products may have several potential suppliers—user can select which to use for this line.
- **Conditions (Betingelser)**: Discounts, packages, or special pricing/rules that may apply on several hierarchical levels (item, module, supplier group, etc.).
- **Campaign (Kampanje)**: Temporary special pricing—campaign detection and price overriding logic is included.
- **Multiple Units**: Items may be handled in up to three sales units; all price, cost, and discount handling supports each unit with conversion logic.
- **Validation**: The program enforces strong business rules—ensuring, for instance, that DG (margin) and cost price are compatible, proper dates are used, and that lines comply with the expected order/item types.

---

## Integration with Other Systems

This module is highly integrated:
- Calls out to several other RPG programs for:
    - Pricing and discount calculation (`VP900R`)
    - Condition selection (`JP505R`, `JP506R`)
    - Price group fetching (`VL712R`)
    - GTIN retrieval (`VE713R`)
    - Activity and project validation
    - NOBB info display (`AP633R`)
    - Freight calculator config etc.
- Embedded SQL is used to fetch special attributes for items (campaigns, NOBB, logistics, etc.)

---

## Comments & Change Log

- The top of the source contains a very detailed revision history, indicating active maintenance and customization.
- Many comments reference Norwegian terms and business rules specific to the user base (e.g., NOBB, SANO, Betingelse, Leverandør, etc.).
- Several "feature flags" are controlled via external configuration (e.g., whether campaign pricing is active, whether the NOBB freight calculator is used, whether a given product is considered a logistics item).

---

## Summary for Developers

- **Central Purpose**: Maintain order lines, including both manual editing and automated price/condition logic, for complex multi-supplier, multi-condition, multi-unit products.
- **Highly Configurable**: Behavior can change based on system config or customer/project data.
- **Careful Validation**: Many layers of error checking and business rule enforcement.
- **Screen Loops**: User is kept in a loop until all required/valid data is provided (mainly via the `xc1win` subroutine).
- **Extensible**: Easily supports future expansions (as seen by the history and modularity).
- **Integration Points**: Relies on other programs for price, group, and condition logic.

### **If onboarding:**
- Learn the data model around items, orders, suppliers, and pricing structure.
- Study how price, cost, and discount logic is layered and recursive, especially the "betingelse" (conditions) hierarchy.
- Understand the use of flags and indicators for user control and error handling.
- Become familiar with the key external programs and files referenced.
- Be aware that configuration and feature toggles are handled via both parameters and calls to configuration programs (CO402R).

---

## Further Reading/Reference

- **NOBB Database**: [nobb.no](https://www.nobb.no/) (if not familiar)
- **Betingelse**: Typically means "condition", referring to discounts, price agreements, etc.
- **VA/VA System**: Likely refers to "Vareadministrasjon", i.e., Item Administration sub-system.

---

*The quality and structure of this code is quite high, and careful adherence to the business rules is evident. The program is long and complex but generally readable if familiar with RPG and the particular business domain.*