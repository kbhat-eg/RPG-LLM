# Overview

This ILE RPG program (AP624R) manages "properties" (egenskaper) for a domain called PROA, using subfile-based screen handling for user interaction on IBM i. It includes features to display, add, update, copy, and delete records via interactive screens (workstation file).

The code uses traditional fixed-format RPG IV (with cycle, indicators, and subroutines). Comments use Norwegian, but variable and screen names are mostly English, easing reading.

---

## High-level Structure

- **File Declarations:**
  - Two database files: `AFPSLR` (primary, for reading and update), `AFPSLU` (update only).
  - One workstation file: `AP624D`, associated with subfiles for screen display.

- **Data Structures:**
  - Local Data Area (LDA) fields for user/firm info.
  - Display feedback info data structure for cursor position.

- **Variables and Constants:**
  - Key fields, page/subfile control variables, and logical flags (e.g., `b_oppr`, `b_forn`).

- **Indicator Usage:**
  - Standard RPG indicators (e.g., 10 for Rollup, 12 for subfile display, 30 for protect-fields).

- **Subroutines:**
  - Main program loop and screen navigation.
  - Subfile management: load, clear, scroll, update after changes.
  - Screen handlers for "create", "edit", "view", "copy", "delete".
  - Record locking and feedback.

---

## Main Logic Flow

### 1. **Initialization**

- **\*INZSR** sets up initial key values from the LDA and positions the cursor at the start of the data.
- Subfile is populated with the first page of data.

### 2. **Main Screen Display Loop**

- Displays control screen (`B2CTL` or subfile).
- Handles function keys: exit, refresh, add new, rollup/rolldown, positioning, etc.
- Calls subroutines as necessary based on user action.

### 3. **Subfile Handling**

- **Subfile (B1SFL):** The heart of the UI - a page of records the user can scroll, select for actions (edit, copy, view, delete).
- **Subfile Routines:**
  - **CRT_SUBFILE:** Load records into the subfile for display.
  - **CLR_SUBFILE:** Clear subfile.
  - **BACK_SUBFILE:** Roll "back" a page (page up logic).
  - **DSF_SUBFILE:** Display subfile and handle cursor positioning/scroll.

### 4. **Record Action Routines**

- **XC1BLD:** Screen handler for adding new record rows.
  - Loops, allowing multiple additions.
  - Calls edit screen (`XC2BLD`) after entering a new key.
- **XC2BLD:** Unified handler for add, edit, and view screens.
  - Loads record data.
  - Conditionally protects fields for "view" mode.
  - Handles update/insert logic for database.
- **XC1MSG:** Display message if trying to add a duplicate.

- **XD1WIN:** Delete window handler. Prompts user; if confirmed, deletes record.
- **XK1WIN:** Copy window logic (partially commented out; seems not in current use).

### 5. **Paging and Positioning**

- **FORNY:** Refresh subfile, useful after operations that change the subfile's contents.
- **POSISJONER:** Position subfile to a requested record.

---

## Subfile Paging Variables

- **w_fcrn:** First record number on the page.
- **w_srrn:** Relative record number in subfile (used as subfile record number).
- **w_spge:** Page size (number of lines per page).
- **w_sfrn:** First record number on the last page.
- **w_ssrn:** Last record number on the last page.

---

## RPG Indicators

- **LR**: Last record, exit program.
- **10**: Rollup (Page Down).
- **11**: Rolldown (Page Up).
- **12**: Signal that subfile is displayed.
- **13**: Subfile control indicator.
- **14**: Clear subfile.
- **15**: Subfile end indicator.
- **21**: Home key pressed.
- **22**: Cursor positioning.
- **30**: Protect fields indicator (e.g. for view-only mode).
- **31-79, 80-99**: Error, warning, or work indicators.

---

## Key Patterns

- **CHAIN/SETLL/READ:** Used for record positioning and locking.
- **WRITE/UPDATE/DELETE:** Standard RPG I/O operations for data and subfile records.
- **EXSR:** Call named subroutine.
- **SELECT/WHEN:** Branch based on indicator or field value.

---

## Notable Business Logic

- **Adding New Records:** Ensures duplicate keys aren't created; shows an error message if an attempt is made.
- **Editing/Viewing:** Reuses the same logic as add, but can set fields to protect mode when viewing only.
- **Copy Feature:** Reads a record, populates the input screen with its data, and allows it to be saved under a new key after validation (logic is partially commented out in this version).
- **Page Up/Page Down:** Keeps track of where in the dataset you are (`w_fcrn`, `w_srrn`, etc.), so you can scroll through data pages.

---

## Screen Format Names

- **B1SFL:** Main subfile, each line is a record.
- **B2CTL:** Subfile control area (top of screen).
- **B2CMD:** Command window for function keys.
- **C1BLD:** Key input when creating new records.
- **C1MSG:** Message window for errors/feedback.
- **C2BLD:** Edit/view screen for records.
- **D1WIN:** Delete confirmation window.
- **K1WIN:** Copy record window.

---

## Example Workflow

1. **User enters the program.**  
   Subfile is populated with current records.

2. **User presses F6 (add new):**  
   C1BLD screen is shown, user enters a key.
   - If duplicate, message (C1MSG) is shown.
   - If unique, C2BLD is shown for full input, record is written.

3. **User selects a line and chooses to edit/view/delete:**  
   C2BLD, D1WIN, or similar is used to process, after which the subfile is refreshed as needed.

4. **User pages up/down:**  
   BACK_SUBFILE/CRT_SUBFILE routines re-populate the subfile with correct records.

---

## Extensibility & Maintenance

- **Key routines** (subfile management, add/edit/delete logic) are separated into named subroutines for clarity and potential re-use.
- **Screen indicator handling** makes it easier to adjust which fields are editable/protected.
- **LDA usage** facilitates easy extension for session/user customizations.

---

## Conclusion

This is a robust, traditional subfile-driven IBM i RPG program for record maintenance, with full CRUD capability and careful subfile page management. The structure is modular, with clear entry/exit to each part of the user interaction cycle. The Norwegian comments provide extra business context but do not hinder technical understanding.

**Potential improvements** (not present but to consider):  
- Refactor to /FREE format for readability.
- Error handling/message subroutine consolidation.
- Data validation routines could be made more explicit.

---

**If you need a focused explanation of a specific subroutine or piece of logic, let me know!**