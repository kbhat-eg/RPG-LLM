# FO619R RPG Program - Explanation

## Overview

The `FO619R` program is an ILE RPG application used for handling **order processing**, specifically "resting" (*restnotering*, i.e., splitting/resting lines) and **removing pick instructions from the radio terminal** (often used for warehouse picking in logistics). The solution is highly integrated with the rest of the order management system.

It works by:
- Handling requests to "rest" (split) orders and create new suffixes for partially picked orders.
- Managing order lines, order headers, and associated warehouse/pick/transport records.
- Updating stock, order statuses, and associated logs.
- Supporting a flexible set of parameters and numerous business rules, including integration with external systems (e.g., transport management, B2C logic).

**The code is old-style RPG/400 with modernization and a rich history of changes, actively maintained and versioned.**

---

## 1. File Declarations

The program uses many externally described files, each renamed for record format clarity. The most important:
- `votyl1`: Order type registry
- `fohel1/fohelur`: Order header tables (for read/write)
- `fodtl1/fodtlur`: Order lines (for read/write)
- `lwpllu/lwpllur`: Pick line working register
- `fpsolu`: Picking summary register

There are also files for item master, customer, transport, deposit, and logging.

---

## 2. Data Structures

The program defines many data structures (DS). Some key ones:
- **Warehouse Update Structure (`hlrec`)**: Used for warehouse (stock) updates.
- **Sorting DS**: For managing multiple sort keys.
- **Member Name DS**: To handle multi-member files.
- **Local Data Area (`lda`)**: Holds job-contextual/session data used across subroutines.

Many DS are overlays (multiple fields at specific positions within a record buffer).

---

## 3. Key Variables

Variables are grouped and named for mapping to file fields and for use as temporary working variables between subroutines. Examples include:
- `w_firm`, `fohel1_numm`, `fohel1_suff`, etc.: Key variables for the files.
- `w_otyp`, `w_lage`: For tracking order type and warehouse, saved and restored as needed.
- `w_test`: Flag indicating if order lines remain after resting (0 = no lines left; heading can be deleted).
- Variables for call parameters to external programs, status codes, temporary values, etc.

---

## 4. Main Program Flow

### a. Entry & Initialization

- `*inzsr` (Initialization Subroutine): Sets up the program, assigns parameters, initializes all keys and local fields, pulls user info, sets dates, and configures environment.
- Loads the current order context into working variables from parameters (`p_firm`, `p_numm`, `p_suff`).
- Reads and sets up environmental/user info (from LDA and user reg).

### b. Pre-checks

- Checks if there's any pick entry to process for the specified order/suffix in `lwplpf` (pick register). If not, goes to `avslutt` (exit).
- Chains the order header (fohel1) record to memory, reads in current status.

### c. Main Processing

#### 1. **Resting Orders**
- Calls `resting` subroutine if picks exist.
- This subroutine:
  - Finds the next available suffix for resting (calls `hntsuf`).
  - Handles all lines for the order, splitting/resting as needed (calls `olrest`).
  - Re-reads the header and updates or deletes it as required.
  - Handles transport integration if active.
  - Inserts a new order header for the rest order (with new suffix).
  - Handles status refresh, logs status, and calls external programs as needed.
  - Handles memo balance adjustment (`FO763R`).

#### 2. **After-Processing**
- Updates both the "old" and the "new" order's header and totals.
- For the original order: recalculates totals, possibly marks as completed/deleted, and updates header/status fields.
- For the new order: copies keys, updates warehouse and transport info, recalculates totals.
- Writes status, dates/user to LDA and calls printing or other external programs if needed.

#### 3. **Packing Note Output**
- Assembles packing note lines (`dann_pakks`), picking summary, text (before and after), and persists them to the register.

#### 4. **Warehouse/Stock Updates**
- Calls subroutine (`opplag`) for each order line to adjust stock accordingly.
- If required, also updates associated purchase order lines.

#### 5. **Pick Register Maintenance**
- Runs subroutine to delete all pick lines for the order from the pick register.

---

## 5. Important Subroutines

### - **resting:** Main logic for order resting (split/rest). Handles both "old" and "new" order, including order header, line updates, and relevant integrations.
### - **olrest:** Iterates through each order line, determines if it should be split/rested, copies or updates records, and handles all logic for both product and text lines. Also manages inventory updates and order line deletion as required.
### - **opplag:** Handles stock movement for products using a mapped DS and calls external program `VL001R` to update the warehouse. Logic differs slightly for outgoing vs. incoming stock.
### - **dann_pakks:** Produces packing slip output post-resting; collates lines and associated text.
### - **slett_plukk:** Deletes pick lines for the order from the working register (radio terminal).

**Special handling** exists for:
- Transport management integration.
- Project accounting orders.
- Logging (Job start, per-action, debug).
- Service articles with special line numbers.
- B2C "over-picking" recalculation logic.

---

## 6. External Program Calls

The RPG program is deeply integrated, calling other programs for:
- **Memo/balance update** (`FO763R`, `FA922R`).
- **Stock updates** (`VL001R`).
- **Order status refresh** (`FO190R`, `FO730R`).
- **Printing** (`AP600R`).
- **Deposit/service lines** (`FD109R`).
- **Logging** (`AB700R`, `AB705R`)
- **Transport info** (`AP058R`)
- **User and property fetch/config** (`CO402R`).

---

## 7. Handling Comments and Versions

The source is full of comments (in Norwegian), version labels, and history about changes over time. This means the codebase has evolved to handle *many* edge cases and business rules, often by toggling on/off sections with comments.

---

## 8. Logging and Debug

Since version 8.xx, there is extensive logging of key actions, both for job start and for significant processing events (order splitting, line updates, stock adjustments, etc).

---

## 9. Key Business Logic Flows

- **Resting an order:**  
  - When not all items are picked, the remainder is "rested"â€“moved to a new suffix and left open for later picking.
- **If an order is emptied:**  
  - The header and lines are deleted, other records (pick, transport) are cleaned up.
- **Transport integration:**  
  - If enabled, transport info is updated for both old and new orders.
- **Stock/warehouse updating:**  
  - For each line, negative and positive stock movements are posted per the resting logic.
- **Text and service lines:**  
  - Copied/moved along with their order lines, with handling for special cases (e.g. new service lines with negative line numbers).

---

## 10. Onboarding Tips

- **Read the comments:** They are vital for understanding historical changes and why some code paths exist.
- **Look for version markers (e.g., `8.01`, `5.51`):** They explain business rule changes and enable/disable sections.
- **Understand the business process:** The program is a workflow kernel for order-picking, resting, and warehouse updating with lots of business-specific rules.
- **Test each change's impact:** Many external programs are called; ensure test data is consistent.

---

## 11. Key Takeaways

- **FO619R** automates a complex order resting/splitting process needed in logistics/warehouse management.
- Multi-step, multi-integration, and highly parameterized with legacy and modern logic intertwined.
- It balances mainline business logic (handling orders and stock) with integration, logging, exception handling, and legacy code maintenance.
- The heavy use of comments and strict change control (version comments) indicate a mission-critical, evolving application.

---

**If you are onboarding: Familiarize yourself with the order structure & status, the pick/warehouse tables, and the general RPG subroutine/calling conventions. Also, review external program interfaces and test with known (safe) data where possible.**