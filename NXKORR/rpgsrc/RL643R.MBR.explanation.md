# Explanation of RPG Source Code: RL643R  
**Title:** Printing of Account Statements/Mail - Parameter Input  
**Language:** RPG/400 (ILE RPG)  
**System:** ASOKON  
**Program:** RL643R  
**Description:**  
This program functions as a parameter entry (input) routine, supporting selection criteria for printing account statements—either to paper or e-mail. It interacts with users via a display file (`rL643d`) and validates input parameters for period/year selection, then populates parameter structures for further processing.

---

## 1. **Header and Documentation**
- **Comments and History:**  
  The top section (starting with `/TITLE`) defines the program's name and purpose. There’s also a detailed change history, listing enhancements (e.g., e-mail print option, open-item printing, etc.), Norwegian descriptions (e.g., "Utskrift av kontoutdrag/mail - parameter"), and reference to system versions.

- **Indicator Usage:**  
  A table describes indicator conventions (KA, KC, LR, 30–99) for keyboard functions, field protection, error warnings, file access, etc.

---

## 2. **File Declarations**
```rpg
frL643d    cf   e             workstn
```
- **`rL643d`** – Display file for user interaction (work station).

---

## 3. **Variable Definitions**
```rpg
d n               s              2  0
d s               s              1  0
d waar            s              4  0
d wmnd            s              2  0
...
d p_in03          s              1
d p_levr          s              6  0
d p_valg          s              1
d p_mail          s              1
```
- **Work variables:** General purpose numerics and fields.
- **Input/Output variables:**  
  - `p_in03`, `p_levr`, `p_valg`, `p_mail` - Parameters passed to/from the program for controlling subsequent processing.

---

## 4. **Parameter Data Structure**
```rpg
d/COPY QCPYLESRC,RPARRKDS
```
- Copies a structure or definitions for parameter data, likely layout for passing values to the next processing step.

---

## 5. **Main Routine**

### a. **Program Initialization**
```rpg
c     *inzsr        begsr
...
c                   endsr
```
- **Entry parameter list:**  
  Loads input parameters (`p_in03`, `p_levr`, etc.)
- **User and company context:**  
  Sets local variables based on session/user context (`l_user`, `l_firm`).
- **Initial period calculation:**  
  Sets starting period/year based on current date, adjusting for December/January boundaries.

### b. **User Interaction Loop**
**Display Panel:**
```rpg
c                   exfmt     a2bld
```
- Displays the screen (`A2BLD`) for entering parameter values.

**Indicator Reset:**
```rpg
c                   eval      *in31 = *off
c                   eval      *in32 = *off
```
- Resets screen indicators for error handling.

### c. **Main Input Validation**
**Exit Check:**
```rpg
c                   if        *inkc = *on
c                   move      '1'           p_in03
c                   goto      xslutt
c                   endif
```
- If Exit (F3) pressed, signals program termination.

**Special Logic for 'Open Posts':**
```rpg
c                   if        a2valg = '2'
c                   eval      a2pårf = 2000
c                   eval      a2ppef = 1
c                   endif
```
- If user selects open-item mode, period/year start is set to (2000, 1).

**Year/Period Validations:**
- Several checks ensure valid input (start year not after the current year, no zero periods, period-from not after to, etc.).
- If invalid, sets error indicators, redisplays the screen, and shows error messages.

**Examples:**
```rpg
c                   if        a2pårf > *year
c                   move      *on           *in32
c                   goto      a2taga
c                   endif
```
- If starting year is after the current year, signals an error.

**Period Consistency Checks:**
- Ensures that period-from is not zero, period-to is not zero, and that 'from' is not after 'to'.
- When validation fails, indicators are set to display appropriate error messages, and user is returned to the data entry screen.

---

## 6. **Parameter Assignment**
```rpg
c                   move      udate         pdato
c                   move      a2pårf        paarf
c                   move      a2pårt        paart
c                   move      a2ppef        pperf
c                   move      a2ppet        ppert
...
c                   eval      p_valg = a2valg
c                   if        a2mail = '1'
c                   eval      p_mail = a2mail
c                   endif
```
- Assigns validated screen values to the parameter data structure (`pdato`, `paarf`, etc.) for onward processing.
- Sets email flag if email (e.g., a2mail = '1') is chosen.

---

## 7. **Program Termination**
```rpg
c     xslutt        tag
c                   eval      *inlr = *on
c                   return
```
- Standard RPG program exit: sets LR (last record) to signal end of job, then returns.

---

## 8. **Subroutine: Initialization**
- Handles initialization of variables, parameter list input, context setup, and initial default values for user/company and period.

---

## 9. **Special Notes**
- **Norwegian Language:**  
  Comments and variable names use Norwegian ("utskrift", "periode", "år", "kunde", etc.), so adjust for translation/cultural context.
- **Indicators:**  
  RPG traditional indicators (`*inxx`) are heavily used for flow, screen control, display, messaging, and error handling.
- **Display File:**  
  All user driving is done via workstation display screens.

---

## 10. **Summary**
RL643R is a well-structured program for entering account statement selection parameters, performing validation, and returning parameters for a subsequent processing/printing program. It ensures correct period/year selection, supports output-to-email, and maintains robust error handling and user guidance. The code is modular, with clear separation between initialization, user interaction, validation, and termination, and is heavily documented for maintainability.