# RPG Program Explanation: LD105R (Bestilling-linje, vedlikehold av varelinje)

This documentation aims to help developers understand the structure, flow, and key logic of the ILE RPG program `LD105R` (based on the provided source code). The program is used for maintenance of order lines (order line details) in a purchasing application, where "varelinje" means "item line" or "order line" in Norwegian.

---

## 1. **File Specifications (F-specs)**

- A number of physical and logical files are defined for input (I), output (O), or update (U), mostly with external descriptions (`E`) and keys (`K`). Many are renamed for local record formats.
- Example:
  - `flstsl1 if e k disk rename(lstspfr:lstsl1r)`
    - File `lstspfr` as `lstsl1r` record format, input, externally described, keyed, disk file.
- Workstation file (`ld105d cf e workstn`) is used for display interaction.

---

## 2. **Data Definitions**

### 2.1 Parameters

- Parameters passed to the program (via `*ENTRY PLIST`) define the operation: company, order number, line number, item code, quantity, unit, cost, campaign, etc.
- Example: `d p_firm s like(ldfirm)` assigns the variable the same attributes as field `ldfirm`.

### 2.2 Local Data Area

- Section reads user info, file group, etc., often used for security or audit purposes.

### 2.3 Data Structures

- Used for transferring item/order line information, e.g., structure `hlrec` overlays subfields like item, warehouse, date, time, etc., for inventory updates.

### 2.4 Working Variables

- Many working variables are defined for prices, VAT, status, text fields, units, etc.

---

## 3. **Constants**

- Lowercase (`lo`) and uppercase (`up`) mapping strings, used for e.g., converting text to uppercase.

---

## 4. **SQL Options**

- Section sets SQL options for date format and Norwegian language id.

---

## 5. **Main Program Flow**

### 5.1 Retrieve Item Information

- Uses passed-in item code to fetch item information (`chain vvarl1`).
- If not found, jumps to "endring" label for new line handling.

### 5.2 Retrieve Supplier/Linguistic Info

- If supplier information exists for the item, checks for country code, and potentially retrieves language-specific item texts.

### 5.3 Currency Handling

- Checks for special exchange rate; if unavailable, defaults to 1 (no conversion).

### 5.4 Price Information

- Calls programs such as `VP755R` to get item price info for up to three units (unit prices, purchase prices, conversion ratios, campaign pricing, etc.).
- Optionally adjusts price based on currency conversion rate.

### 5.5 Item Type & NOBB/Logistics

- Calls `VL710R` for item type and (from v6.3b) retrieves additional logistics information (NOBB is a Norwegian building goods database).

### 5.6 Initialize or Fetch Order Line

- `chain lodtl1` attempts to retrieve existing order line; if not found, initializes a new one via `ny_linje` subroutine.

### 5.7 Display Entry Screen

- Enters subroutine `xc1win` for user interaction.
- Handles user display and editing of line details, including quantities for various units, prices, discounts, and project/activity links.

### 5.8 Update Order Line

- Updates file `lodtlur` (order line) with information from screen.
- If an existing line was found, updates timestamps and user info; else sets creation timestamps and user, and writes the new record.

### 5.9 Optionally Updates Related Orders

- (Commented/conditional) Optionally updates purchase order details if purchase price or delivery date has changed.

### 5.10 Update Inventory

- Calls subroutine `oppdat_lager` to update inventory (unless the line is not an inventory item, or the change does not affect inventory).

### 5.11 Return Control Codes

- Indicates at least one line registered, and returns cost price view flag.

---

## 6. **Subroutines**

### 6.1 `ny_linje`

- Initializes a new order line with default and parameter values.
- Loads any available language-specific texts.
- Calls `hent_pris` to assign prices and purchase costs based on chosen unit.
- Sets VAT codes according to a combination of product, supplier, or control settings.

### 6.2 `xc1win`

- Main user interface for editing an order line.
- Initializes screen fields.
- Handles user function keys for: manual cost price calculation, product info, inventory info, NOBB info (F18), etc.
- Validates input: unit, quantities, item texts, dates, and project/activity references.
- Calculates and displays totals with discounts and taxes.
- Loop continues until successful entry or user cancels.

### 6.3 `hent_pris`

- Assigns price and cost for the selected unit from up to three possible units.

### 6.4 `kalkulator`

- Converts quantities between the three units, helping the user see equivalent quantities in other units.

### 6.5 `lagerbeholdn`

- If the item is an inventory item, calls the relevant program to fetch current stock balances and displays them.

### 6.6 `oppdat_lager`

- If the item is an inventory item and it has changed, generates and sends a record structure (`hlrec`) to the inventory update program (`VL001R`).

### 6.7 `oppdat_ordre`

- (Conditionally active) Updates corresponding purchase order details if price or delivery date changes.

### 6.8 `xc2msg`

- Handles user confirmation for overriding an expired ("utg√•ende") product date on the line.

### 6.9 `just_enhe`

- Adjusts campaign price (`w_vkai`) to match the selected unit and fills in correct price fields.

### 6.10 `vis_nobb`

- Calls program to show NOBB information for the item (building product info).

---

## 7. **Initialization Subroutine (`*inzsr`)**

- Executes at program start, sets up internal keys, flags, and loads codes/registers as needed.
- Calls external programs for various control flags and features, and configures default values.
- Loads item type, VAT settings, price groups, and prepares the main screen for interaction.
- Scans for existing lines to suggest delivery type on new lines.

---

## 8. **Entry Point**

- Program is parameter-driven and designed to function both as new order line creation and as record maintenance.
- Extensively annotated and versioned, with continuous functional and regulatory enhancements.

---

## 9. **Special Notes**

- Many lines and fields have version-specific handling (e.g., comments like `6.13`, `8.06`). These link to enhancements reflected in change log at the top.
- Heavy use of conditional flags and user-function keys for control and branching.
- Comments and variable names are mostly in Norwegian; field names often start with `ld` (line detail), `vv` (item master), `lo` (order header), etc.
- Uses external programs extensively for key business logic (e.g., pricing, stock evaluation, VAT, NOBB info, project validation).

---

## 10. **Key Business Logic Highlights**

- **Item lookup and initialization:** Ensures only valid items proceed, supports both standard and language-adapted item descriptions.
- **Flexible pricing:** Supports three units (main, alternative, packaging), campaign pricing, and currency conversion.
- **Dynamic discounts:** Allows for two sequential discounts (rabatt), as well as campaign and customer-based discounts.
- **Project/activity validation:** Validates against external project and activity registries.
- **Inventory management:** Maintains consistency and integrity between order lines and real-time inventory records.

---

## 11. **How to Onboard Quickly**

- **Understand the master/detail structure:** Most RPG applications are built around HEAD/LINE logic (order header/order lines).
- **Familiarize with the file structure:** Many lookups and updates are via external files; it's crucial to know record layouts.
- **Note business rules in called programs:** Key calculations (e.g., price, VAT, project validation) are offloaded to other RPG programs.
- **Follow the comments and version tags:** Inline comments mark functional changes and help trace the evolution of complex conditional logic.
- **Screen handling is manual:** All field-to-field assignments between display fields and working fields require care.
- **Validate before update:** Most checks are performed before any update is written to DB; always check the chain of validations.
- **Be aware of Norwegian terms:** Variable and field names, as well as comments, are in Norwegian; have a field list or glossary handy.

---

## 12. **Conclusion**

This is a robust, heavily-customized RPG/400 order line maintenance module, designed for integration with a Norwegian business system that relies on real-time inventory, multi-price, multi-unit, campaign, project/activity, and NOBB database integration. It extensively validates user input, supports complex business rules, and is highly configurable based on version, flags, and organizational parameters.

---

**For a new developer:**  
Start by acquainting yourself with the `*inzsr` (initialization) and main program entry, follow the path through display logic (`xc1win`), trace how updates are processed, and note how external programs supply core business functions (pricing, stock, validation). Always review comments, as many features are version-controlled and may be activated or deactivated in production based on settings or customer requirements.